# çŸ¿å±±çŽ¯å¢ƒæ—¥å¿—é‡‡é›†ç³»ç»Ÿå®žçŽ°æ€»ç»“

## ðŸŽ¯ ç³»ç»Ÿæ¦‚è¿°

åŸºäºŽçŽ°æœ‰ä»£ç å¢žé‡å¼€å‘çš„æ—¥å¿—é‡‡é›†ä¸Šä¼ æ˜¾ç¤ºç³»ç»Ÿï¼Œé€‚åº”çŸ¿å±±å¤æ‚ç½‘ç»œçŽ¯å¢ƒï¼Œå®žçŽ°ljwx-watch â†’ ljwx-phone â†’ ljwx-bigscreençš„å®Œæ•´æ—¥å¿—é“¾è·¯ã€‚

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

```
ljwx-watch (HiLogé‡‡é›†) 
    â†“ è“ç‰™TLVä¼ è¾“ (5ç§’é—´éš”)
ljwx-phone (è§£æž+ä¸Šä¼ )
    â†“ HTTP API
ljwx-bigscreen (å­˜å‚¨+æ˜¾ç¤º)
```

## ðŸ“± ljwx-watchç«¯å®žçŽ°

### 1. æ—¥å¿—é‡‡é›†å™¨ (LogCollector.java)
- **ä½ç½®**: `ljwx-watch/entry/src/main/java/com/ljwx/watch/utils/LogCollector.java`
- **åŠŸèƒ½**: ç»Ÿä¸€æ”¶é›†HiLogè¾“å‡ºï¼Œ5ç§’å®šæ—¶å‘é€
- **ç‰¹æ€§**: 
  - å•ä¾‹æ¨¡å¼ï¼Œçº¿ç¨‹å®‰å…¨
  - ç¼“å­˜500æ¡æ—¥å¿—ï¼Œè¶…å‡ºè‡ªåŠ¨æ¸…ç†
  - è“ç‰™æ–­å¼€è‡ªåŠ¨åœæ­¢å‘é€

### 2. è“ç‰™åè®®æ‰©å±• (BleProtocolEncoder.java)
- **æ–°å¢žç±»åž‹**: `TYPE_LOG_DATA = 0x07`
- **TLVå­—æ®µ**:
  - `LOG_DEVICE_SN = 0x01` (è®¾å¤‡åºåˆ—å·)
  - `LOG_TIMESTAMP = 0x02` (æ—¶é—´æˆ³)
  - `LOG_LEVEL = 0x03` (æ—¥å¿—çº§åˆ«)
  - `LOG_CONTENT = 0x04` (æ—¥å¿—å†…å®¹ï¼Œé™åˆ¶200å­—ç¬¦)

### 3. ä¸»ç¨‹åºé›†æˆ (MainAbilitySlice.java)
- **åˆå§‹åŒ–**: `initLogCollector()` æ–¹æ³•
- **è§¦å‘æ¡ä»¶**: upload_methodä¸ºwifiæ—¶ï¼ŒbluetoothServiceä»å¯åŠ¨æ—¥å¿—æ”¶é›†
- **å‘é€æœºåˆ¶**: é€šè¿‡Intentè°ƒç”¨BluetoothService

### 4. è“ç‰™æœåŠ¡å¤„ç† (BluetoothService.java)
- **æ–°å¢žæ–¹æ³•**: `sendLogPacket()` ç›´æŽ¥å‘é€æ—¥å¿—æ•°æ®åŒ…
- **Intentå¤„ç†**: onCommandæ–¹æ³•å¤„ç†æ—¥å¿—æ•°æ®Intent

## ðŸ“² ljwx-phoneç«¯å®žçŽ°

### 1. åè®®è§£æž (ble_binary_protocol.dart)
- **æ–°å¢žå­—æ®µ**: LOG_DEVICE_SN, LOG_TIMESTAMP, LOG_LEVEL, LOG_CONTENT
- **è§£æžæ–¹æ³•**: `decodeLogDataTLV()` è§£æžæ—¥å¿—TLVæ•°æ®
- **æ—¶é—´æˆ³è½¬æ¢**: uint32ç§’çº§æ—¶é—´æˆ³è½¬æ¢ä¸ºå¯è¯»æ ¼å¼

### 2. è“ç‰™æœåŠ¡å¤„ç† (bluetooth_service.dart)
- **æ•°æ®ç±»åž‹**: `TYPE_LOG_DATA` caseå¤„ç†
- **ä¸Šä¼ æ–¹æ³•**: `_uploadWatchLogDirectly()` ç›´æŽ¥ä¸Šä¼ æ—¥å¿—
- **è°ƒè¯•æ˜¾ç¤º**: `_addLogToDebugPage()` åœ¨è“ç‰™è°ƒè¯•é¡µé¢æ˜¾ç¤º

### 3. APIæœåŠ¡ (api_service.dart)
- **ä¸Šä¼ æŽ¥å£**: `uploadWatchLog()` æ–¹æ³•
- **ç«¯ç‚¹**: `POST /upload_watch_log`
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸æ•èŽ·å’Œé‡è¯•æœºåˆ¶

## ðŸ–¥ï¸ ljwx-bigscreenç«¯å®žçŽ°

### 1. æŽ¥æ”¶æŽ¥å£ (hm_server.py)
- **è·¯ç”±**: `@app.route("/upload_watch_log", methods=['POST'])`
- **æ•°æ®éªŒè¯**: æ£€æŸ¥dataå­—æ®µå’Œå¿…è¦å‚æ•°
- **å­˜å‚¨**: è°ƒç”¨`save_watch_log()`å‡½æ•°

### 2. æ•°æ®åº“å­˜å‚¨
- **è¡¨ç»“æž„**: `t_watch_logs`
  ```sql
  CREATE TABLE t_watch_logs (
      id INT AUTO_INCREMENT PRIMARY KEY,
      device_sn VARCHAR(100) NOT NULL,
      timestamp DATETIME NOT NULL,
      log_level VARCHAR(20) NOT NULL,
      log_content TEXT,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      INDEX idx_device_timestamp (device_sn, timestamp),
      INDEX idx_level (log_level)
  )
  ```

### 3. æŸ¥è¯¢æŽ¥å£
- **API**: `GET /api/watch_logs` æ”¯æŒåˆ†é¡µå’Œç­›é€‰
- **å‚æ•°**: deviceSn, level, startTime, endTime, page, pageSize
- **è¿”å›ž**: JSONæ ¼å¼çš„æ—¥å¿—åˆ—è¡¨å’Œåˆ†é¡µä¿¡æ¯

### 4. æ˜¾ç¤ºé¡µé¢
- **è·¯ç”±**: `/watch_logs`
- **æ¨¡æ¿**: `templates/watch_logs.html`
- **åŠŸèƒ½**: 
  - æŒ‰è®¾å¤‡åºåˆ—å·+æ—¶é—´æˆ³ç­›é€‰
  - ä¸“ä¸šæ—¥å¿—çº§åˆ«æ˜¾ç¤º
  - åˆ†é¡µæµè§ˆ
  - è‡ªåŠ¨åˆ·æ–°

## ðŸ”§ æ ¸å¿ƒç‰¹æ€§

### 1. çŸ¿å±±çŽ¯å¢ƒé€‚é…
- **ç½‘ç»œä¸­æ–­å®¹å¿**: è“ç‰™æ–­å¼€è‡ªåŠ¨åœæ­¢ï¼Œé‡è¿žè‡ªåŠ¨æ¢å¤
- **æ•°æ®ç¼“å­˜**: æ‰‹è¡¨ç«¯500æ¡ç¼“å­˜ï¼Œé¿å…å†…å­˜æº¢å‡º
- **åˆ†åŒ…ä¼ è¾“**: æ”¯æŒå¤§æ—¥å¿—å†…å®¹çš„TLVåˆ†åŒ…
- **é”™è¯¯æ¢å¤**: å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 2. æ€§èƒ½ä¼˜åŒ–
- **ç é«˜å°”å¤«é£Žæ ¼**: æ‰€æœ‰ä»£ç æŽ§åˆ¶åœ¨æœ€å°‘è¡Œæ•°
- **ç»Ÿä¸€é…ç½®**: æ‰€æœ‰å‚æ•°é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†
- **å¢žé‡å¼€å‘**: åŸºäºŽçŽ°æœ‰ä»£ç æœ€å°åŒ–ä¿®æ”¹
- **æ•°æ®åº“ç´¢å¼•**: é’ˆå¯¹æŸ¥è¯¢ä¼˜åŒ–çš„å¤åˆç´¢å¼•

### 3. ç”¨æˆ·ä½“éªŒ
- **å®žæ—¶æ˜¾ç¤º**: 5ç§’é—´éš”çš„æ—¥å¿—ä¼ è¾“
- **ä¸“ä¸šç•Œé¢**: ç±»ä¼¼IDEçš„æ—¥å¿—æ˜¾ç¤ºç•Œé¢
- **ç­›é€‰åŠŸèƒ½**: å¤šç»´åº¦æ—¥å¿—ç­›é€‰
- **ä¸­æ–‡å‹å¥½**: å…¨ä¸­æ–‡ç•Œé¢å’Œæç¤º

## ðŸ“Š æ•°æ®æµç¤ºä¾‹

### æ‰‹è¡¨ç«¯æ—¥å¿—ç”Ÿæˆ
```java
// MainAbilitySlice.java
HiLog.info(LABEL_LOG, "è®¾å¤‡è¿žæŽ¥æˆåŠŸ");
// â†“ LogCollectorè‡ªåŠ¨æ”¶é›†
// â†“ 5ç§’åŽé€šè¿‡è“ç‰™å‘é€
```

### æ‰‹æœºç«¯æŽ¥æ”¶å¤„ç†
```dart
// bluetooth_service.dart
case BleBinaryProtocol.TYPE_LOG_DATA:
  var logData = BleBinaryProtocol.i.decodeLogDataTLV(payload);
  _uploadWatchLogDirectly({'type': 'watch_log', 'data': logData});
```

### å¤§å±ç«¯å­˜å‚¨æ˜¾ç¤º
```python
# hm_server.py
@app.route("/upload_watch_log", methods=['POST'])
def upload_watch_log():
    save_watch_log(device_sn, timestamp, log_level, log_content)
    return jsonify({"status": "success"})
```

## ðŸš€ éƒ¨ç½²è¯´æ˜Ž

### 1. æ‰‹è¡¨ç«¯
- ç¼–è¯‘å¹¶éƒ¨ç½²LogCollector.java
- ç¡®ä¿è“ç‰™æœåŠ¡æ­£å¸¸è¿è¡Œ
- éªŒè¯æ—¥å¿—æ”¶é›†åŠŸèƒ½

### 2. æ‰‹æœºç«¯  
- æ›´æ–°ble_binary_protocol.dart
- é‡å¯è“ç‰™æœåŠ¡
- æµ‹è¯•æ—¥å¿—æŽ¥æ”¶å’Œä¸Šä¼ 

### 3. å¤§å±ç«¯
- éƒ¨ç½²hm_server.pyæ›´æ–°
- åˆ›å»ºæ•°æ®åº“è¡¨
- è®¿é—® http://localhost:5001/watch_logs

## ðŸ“ˆ ç›‘æŽ§æŒ‡æ ‡

- **æ—¥å¿—ä¼ è¾“æˆåŠŸçŽ‡**: ç›®æ ‡ >95%
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**: ç›®æ ‡ <10ç§’
- **å­˜å‚¨æ€§èƒ½**: æ”¯æŒ1000æ¡/åˆ†é’Ÿ
- **æŸ¥è¯¢å“åº”**: <2ç§’è¿”å›žç»“æžœ

## ðŸ” æ•…éšœæŽ’æŸ¥

### å¸¸è§é—®é¢˜
1. **æ—¥å¿—ä¸æ˜¾ç¤º**: æ£€æŸ¥è“ç‰™è¿žæŽ¥çŠ¶æ€
2. **ä¸Šä¼ å¤±è´¥**: éªŒè¯ç½‘ç»œè¿žæŽ¥å’ŒAPIç«¯ç‚¹
3. **æ•°æ®åº“é”™è¯¯**: æ£€æŸ¥è¡¨ç»“æž„å’Œæƒé™
4. **é¡µé¢ç©ºç™½**: ç¡®è®¤æ¨¡æ¿æ–‡ä»¶å­˜åœ¨

### è°ƒè¯•æ–¹æ³•
- æ‰‹è¡¨ç«¯: æŸ¥çœ‹HiLogè¾“å‡º
- æ‰‹æœºç«¯: æ£€æŸ¥è“ç‰™è°ƒè¯•é¡µé¢
- å¤§å±ç«¯: æŸ¥çœ‹FlaskæŽ§åˆ¶å°æ—¥å¿—

## âœ… å®žçŽ°å®Œæˆåº¦

- [x] æ‰‹è¡¨ç«¯æ—¥å¿—é‡‡é›† (100%)
- [x] è“ç‰™TLVä¼ è¾“ (100%)  
- [x] æ‰‹æœºç«¯è§£æžä¸Šä¼  (100%)
- [x] å¤§å±ç«¯æŽ¥æ”¶å­˜å‚¨ (100%)
- [x] ä¸“ä¸šæ˜¾ç¤ºç•Œé¢ (90%)
- [x] ç­›é€‰å’Œåˆ†é¡µ (100%)

## ðŸŽ‰ æ€»ç»“

æˆåŠŸå®žçŽ°äº†å®Œæ•´çš„çŸ¿å±±çŽ¯å¢ƒæ—¥å¿—é‡‡é›†ç³»ç»Ÿï¼Œé€šè¿‡å¢žé‡å¼€å‘æ–¹å¼æœ€å°åŒ–å¯¹çŽ°æœ‰ä»£ç çš„å½±å“ï¼ŒåŒæ—¶æä¾›äº†ä¸“ä¸šçº§çš„æ—¥å¿—ç›‘æŽ§èƒ½åŠ›ã€‚ç³»ç»Ÿå…·å¤‡è‰¯å¥½çš„å®¹é”™æ€§å’Œæ‰©å±•æ€§ï¼Œæ»¡è¶³çŸ¿å±±å¤æ‚çŽ¯å¢ƒçš„ä½¿ç”¨éœ€æ±‚ã€‚ 