<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·åŸºçº¿å›¾è¡¨æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        body { margin: 20px; background: #002B4A; color: #fff; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #0094FF; border-radius: 8px; }
        #trendChart { width: 100%; height: 400px; background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); }
        .info { margin: 10px 0; padding: 10px; background: rgba(0,100,200,0.1); }
        .debug { font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; background: #0094FF; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0078CC; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å¥åº·åŸºçº¿å›¾è¡¨æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š APIæµ‹è¯•</h2>
            <button onclick="testBaselineAPI()">æµ‹è¯•Baseline API</button>
            <button onclick="renderTestChart()">æ¸²æŸ“æµ‹è¯•å›¾è¡¨</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
            
            <div class="info">
                <strong>APIçŠ¶æ€:</strong> <span id="apiStatus">æœªæµ‹è¯•</span><br>
                <strong>æ•°æ®ç»“æ„:</strong> <span id="dataStructure">æ— </span><br>
                <strong>æŒ‡æ ‡æ•°é‡:</strong> <span id="metricsCount">0</span><br>
                <strong>æ—¥æœŸèŒƒå›´:</strong> <span id="dateRange">æ— </span>
            </div>
            
            <div class="debug">
                <h4>è°ƒè¯•ä¿¡æ¯:</h4>
                <pre id="debugInfo">ç­‰å¾…æµ‹è¯•...</pre>
            </div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ˆ å›¾è¡¨æµ‹è¯•</h2>
            <div id="trendChart"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        async function testBaselineAPI() {
            const debugEl = document.getElementById('debugInfo');
            const statusEl = document.getElementById('apiStatus');
            
            try {
                debugEl.textContent = 'æ­£åœ¨è¯·æ±‚API...';
                statusEl.textContent = 'è¯·æ±‚ä¸­...';
                statusEl.style.color = '#FFB800';
                
                const endDate = getPastDateStr(0);
                const startDate = getPastDateStr(6);
                const url = `/health_data/chart/baseline?orgId=1&startDate=${startDate}&endDate=${endDate}`;
                
                debugEl.textContent += `\n\nğŸ“¡ è¯·æ±‚URL: ${url}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                currentData = result;
                
                debugEl.textContent += `\n\nâœ… å“åº”çŠ¶æ€: ${response.status}`;
                debugEl.textContent += `\nğŸ“¦ å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`;
                
                // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                if (result.success) {
                    statusEl.textContent = 'æˆåŠŸ';
                    statusEl.style.color = '#00FF9D';
                    
                    document.getElementById('dataStructure').textContent = result.dates ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ';
                    document.getElementById('metricsCount').textContent = result.metrics ? result.metrics.length : 0;
                    document.getElementById('dateRange').textContent = result.dates ? `${result.dates[0]} ~ ${result.dates[result.dates.length-1]}` : 'æ— ';
                } else {
                    statusEl.textContent = 'å¤±è´¥';
                    statusEl.style.color = '#FF6B6B';
                }
                
            } catch (error) {
                debugEl.textContent += `\n\nâŒ é”™è¯¯: ${error.message}`;
                statusEl.textContent = 'é”™è¯¯';
                statusEl.style.color = '#FF6B6B';
            }
        }
        
        function renderTestChart() {
            const debugEl = document.getElementById('debugInfo');
            
            if (!currentData) {
                alert('è¯·å…ˆæµ‹è¯•APIè·å–æ•°æ®');
                return;
            }
            
            try {
                debugEl.textContent += '\n\nğŸ¨ å¼€å§‹æ¸²æŸ“å›¾è¡¨...';
                
                const {dates, metrics, health_summary} = currentData;
                
                debugEl.textContent += `\nğŸ“Š è§£æ„æ•°æ®: dates=${dates?.length}, metrics=${metrics?.length}`;
                
                // æ£€æŸ¥å›¾è¡¨å®¹å™¨
                const container = document.getElementById('trendChart');
                if (!container) {
                    throw new Error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');
                }
                
                // é”€æ¯æ—§å›¾è¡¨
                const oldChart = echarts.getInstanceByDom(container);
                if (oldChart) {
                    oldChart.dispose();
                }
                
                // åˆå§‹åŒ–å›¾è¡¨
                const chart = echarts.init(container);
                
                // å¤„ç†æ•°æ®
                const mainMetrics = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'å‹åŠ›', 'ç¡çœ '];
                const metricColors = {
                    'å¿ƒç‡': '#ff6b6b',
                    'è¡€æ°§': '#00ff9d', 
                    'ä½“æ¸©': '#ffbb00',
                    'å‹åŠ›': '#ff9500',
                    'ç¡çœ ': '#7ecfff'
                };
                
                const series = [];
                
                if (metrics && metrics.length > 0) {
                    mainMetrics.forEach(metricName => {
                        const metric = metrics.find(m => m.name === metricName);
                        if (metric && metric.values) {
                            debugEl.textContent += `\nâœ… æ·»åŠ æŒ‡æ ‡ ${metricName}: [${metric.values.join(', ')}]`;
                            series.push({
                                name: metric.name,
                                type: 'line',
                                data: metric.values,
                                smooth: true,
                                symbol: 'circle',
                                symbolSize: 6,
                                lineStyle: { 
                                    width: 3, 
                                    color: metricColors[metric.name] || '#00e4ff'
                                },
                                itemStyle: { 
                                    color: metricColors[metric.name] || '#00e4ff'
                                }
                            });
                        } else {
                            debugEl.textContent += `\nâš ï¸ æŒ‡æ ‡ ${metricName} æ— æ•°æ®`;
                        }
                    });
                }
                
                // é…ç½®é€‰é¡¹
                const option = {
                    backgroundColor: 'transparent',
                    title: {
                        text: 'å¥åº·åŸºçº¿è¶‹åŠ¿å›¾æµ‹è¯•',
                        textStyle: { color: '#fff', fontSize: 16 },
                        top: 10
                    },
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(10,24,48,0.98)',
                        borderColor: '#00e4ff',
                        borderWidth: 1,
                        textStyle: { color: '#fff', fontSize: 12 }
                    },
                    legend: {
                        show: true,
                        top: 40,
                        textStyle: { color: '#fff', fontSize: 11 }
                    },
                    grid: { 
                        top: 80, 
                        left: 40, 
                        right: 30, 
                        bottom: 40, 
                        containLabel: true 
                    },
                    xAxis: {
                        type: 'category',
                        data: dates || ['05-28', '05-29', '05-30', '05-31', '06-01', '06-02', '06-03'],
                        axisLabel: { color: '#7ecfff', fontSize: 10 },
                        axisLine: { lineStyle: { color: 'rgba(0,228,255,0.3)' } }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#7ecfff', fontSize: 10 },
                        splitLine: { 
                            lineStyle: { 
                                color: 'rgba(0,228,255,0.15)', 
                                type: 'dashed' 
                            } 
                        }
                    },
                    series: series.length > 0 ? series : [
                        {
                            name: 'æš‚æ— æ•°æ®',
                            type: 'line',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            lineStyle: { color: '#666' }
                        }
                    ]
                };
                
                chart.setOption(option);
                
                debugEl.textContent += `\nğŸ‰ å›¾è¡¨æ¸²æŸ“å®Œæˆï¼å…± ${series.length} ä¸ªæ•°æ®ç³»åˆ—`;
                
                // è‡ªé€‚åº”
                setTimeout(() => {
                    chart.resize();
                }, 100);
                
            } catch (error) {
                debugEl.textContent += `\nâŒ æ¸²æŸ“é”™è¯¯: ${error.message}`;
            }
        }
        
        function clearResults() {
            document.getElementById('debugInfo').textContent = 'è°ƒè¯•ä¿¡æ¯å·²æ¸…ç©º';
            document.getElementById('apiStatus').textContent = 'æœªæµ‹è¯•';
            document.getElementById('dataStructure').textContent = 'æ— ';
            document.getElementById('metricsCount').textContent = '0';
            document.getElementById('dateRange').textContent = 'æ— ';
            currentData = null;
        }
        
        function getPastDateStr(daysAgo) {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }
        
        // é¡µé¢åŠ è½½åè‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(testBaselineAPI, 1000);
        });
    </script>
</body>
</html> 