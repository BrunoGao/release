<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>健康趋势图</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    body { margin:0; background: #181c2f; color:#eee; font-family: 'Segoe UI',sans-serif; }
    .legend-bar {padding:10px 20px;}
    .chart-container { display: grid; grid-template-columns: repeat(3,1fr); gap:10px; padding:10px; }
    .chart { width:100%; height:300px; background:#232946; border-radius:8px; box-shadow:0 2px 12px #0008; transition:height .3s;}
    .selector-bar {padding:16px 20px;display:flex;align-items:center;gap:12px;}
    .selector-bar label {font-size:18px;}
    .metric-dropdown{position:relative;}
    .metric-btn{min-width:180px;height:2.4em;border-radius:6px;border:1px solid #444;background:#232946;color:#fff;font-size:16px;padding:4px 8px;cursor:pointer;}
    .metric-list{display:none;position:absolute;top:110%;left:0;z-index:10;background:#232946;border:1px solid #444;border-radius:6px;box-shadow:0 2px 8px #0006;padding:8px 0;}
    .metric-list label{display:block;padding:6px 18px;cursor:pointer;font-size:16px;}
    .metric-list label:hover{background:#2a2f4a;}
    .metric-list input[type=checkbox]{margin-right:8px;}
    .metric-list .all{font-weight:bold;}


    .date-picker-container {
        padding: 16px 20px 0 20px;
        display: flex; align-items: center; gap: 8px;
        font-size: 16px; font-weight: 500;
      }
      .date-picker-container input[type="date"] {
        border: 1.5px solid #3a6ea5; border-radius: 6px;
        background: #232946; color: #fff; font-size: 16px; padding: 4px 8px;
        margin-right: 4px; outline: none; transition: .2s;
      }
      .date-picker-container input[type="date"]:focus { border-color: #00eaff; }
      #dateSearchBtn {
        border: none; border-radius: 6px; background: #00eaff; color: #181c2f;
        font-size: 16px; font-weight: 700; padding: 6px 18px; cursor: pointer;
        box-shadow: 0 2px 8px #00eaff44; transition: .2s;
      }
      #dateSearchBtn:hover { background: #38f9d7; color: #232946; }

  </style>
</head>
<body>
  <div class="selector-bar">
    <label>选择体征：</label>
    <div class="metric-dropdown">
      <button id="metricBtn" class="metric-btn">全部体征</button>
      <div id="metricList" class="metric-list"></div>
    </div>
  </div>
  <div class="date-picker-container">
    <label>起始日期：</label>
    <input type="date" id="startDate" />
    <label style="margin-left:12px;">结束日期：</label>
    <input type="date" id="endDate" />
    <button id="dateSearchBtn" style="margin-left:16px;">查询</button>
  </div>
  <div class="legend-bar" id="legendBar"></div>
  <div id="loading" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;z-index:99;background:#181c2fcc;display:flex;align-items:center;justify-content:center;font-size:32px;color:#00eaff;font-weight:bold;">加载中...</div>
  <div id="nodata" style="display:none;text-align:center;font-size:28px;color:#b0c4de;margin-top:80px;">暂无数据</div>
  <div class="chart-container"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const customerId = params.get('customerId') || '1';
    const deptId = params.get('deptId') || customerId;
    const userId = params.get('userId') || '';
    const deptName = params.get('deptName') || '';
    const userName = params.get('userName') || '';
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    window.onload = ()=>{
      // 设置默认日期
      const today = new Date();
      const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
      document.getElementById('startDate').value = `${y}-${m}-01`;
      document.getElementById('endDate').value = `${y}-${m}-${d}`;
      loadTrendData();
      document.getElementById('dateSearchBtn').onclick = loadTrendData;
    };

    function loadTrendData() {
      loading.style.display='flex';nodata.style.display='none';
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      let url = `/health_data/trends?orgId=${deptId||''}&userId=${userId||''}&startDate=${startDate}&endDate=${endDate}`;
      fetch(url).then(r=>r.json()).then(initCharts).catch(e=>{loading.style.display='none';console.error('数据加载失败',e)});
    }

    function initCharts(resp) {
      loading.style.display='none';
      if(!resp||!resp.timestamps||!resp.timestamps.length){
        nodata.style.display='block';
        document.querySelector('.chart-container').innerHTML='';
        return;
      }else{nodata.style.display='none';}
      const ts = resp.timestamps, dept = resp.dept, users = resp.users;
      const metrics = [
        { code:'heart_rate',    name:'心率(bpm)', color:'#3a6ea5' },
        { code:'blood_oxygen',  name:'血氧(%)', color:'#6c757d' },
        { code:'pressure_high', name:'收缩压(mmHg)', color:'#bfa180' },
        { code:'pressure_low',  name:'舒张压(mmHg)', color:'#5c8374' },
        { code:'temperature',   name:'体温(℃)', color:'#bdbdbd' },
        { code:'stress',        name:'压力指数', color:'#e0a96d' },
        { code:'step',          name:'步数(steps)', color:'#7b8fa1' },
        { code:'distance',      name:'距离(m)', color:'#a3a3a3' },
        { code:'calorie',       name:'卡路里(kcal)', color:'#c9b29b' }
      ];
      const userColors = [
        '#3a6ea5','#6c757d','#bfa180','#5c8374','#bdbdbd','#e0a96d','#7b8fa1','#a3a3a3','#c9b29b','#8d6748','#4e5d6c','#b0a990','#7c8c8d'
      ];
      const allUsers = Object.keys(users);
      const shownUsers = allUsers.slice(0, 5);
      let legendHtml = `<span style='color:#00eaff;font-weight:bold;text-shadow:0 2px 8px #0008;'>■ 部门平均</span>`;
      allUsers.forEach((u,i)=>legendHtml+=` <span style='color:${userColors[i%userColors.length]};font-weight:bold;text-shadow:0 2px 8px #0008;'>●</span> ${u}`);
      document.getElementById('legendBar').innerHTML = legendHtml;

      const metricBtn = document.getElementById('metricBtn');
      const metricList = document.getElementById('metricList');
      let selectedMetrics = ['heart_rate']; // 默认只显示心率

      function renderMetricList() {
        let html = `<label class="all"><input type="checkbox" id="allMetric" ${selectedMetrics.length===metrics.length?'checked':''}/>全选</label>`;
        metrics.forEach(m=>{
          html += `<label><input type="checkbox" value="${m.code}" ${selectedMetrics.includes(m.code)?'checked':''}/> ${m.name}</label>`;
        });
        metricList.innerHTML = html;
      }
      renderMetricList();

      metricBtn.onclick = ()=>{metricList.style.display=metricList.style.display==='block'?'none':'block';};
      document.body.onclick = e=>{
        if(!e.target.closest('.metric-dropdown')) metricList.style.display='none';
      };
      metricList.onclick = e=>{
        if(e.target.tagName==='INPUT'){
          if(e.target.id==='allMetric'){
            selectedMetrics = e.target.checked ? metrics.map(m=>m.code) : [];
            renderMetricList();
          }else{
            const v = e.target.value;
            if(e.target.checked) selectedMetrics.push(v);
            else selectedMetrics = selectedMetrics.filter(x=>x!==v);
            document.getElementById('allMetric').checked = selectedMetrics.length===metrics.length;
          }
          metricBtn.innerText = selectedMetrics.length===metrics.length?'全部体征':selectedMetrics.length===1?metrics.find(m=>m.code===selectedMetrics[0]).name:metrics.filter(m=>selectedMetrics.includes(m.code)).map(m=>m.name).join('、')||'请选择';
          renderCharts();
          setTimeout(() => { metricList.style.display = 'none'; }, 200);
        }
      };
      // 确保首次加载自动渲染
      renderCharts();

      // 体征选择器美化，支持搜索
      let searchInput=document.createElement('input');
      searchInput.type='text';searchInput.placeholder='搜索体征...';searchInput.style='width:120px;margin:0 8px 8px 8px;padding:2px 8px;border-radius:4px;border:1px solid #444;background:#232946;color:#fff;';
      metricList.prepend(searchInput);
      searchInput.oninput=()=>{
        let v=searchInput.value.trim();
        Array.from(metricList.querySelectorAll('label')).forEach(l=>{
          if(l.className==='all')return;
          l.style.display=l.innerText.includes(v)?'block':'none';
        });
      };

      function renderCharts() {
        const container = document.querySelector('.chart-container');
        container.innerHTML = '';
        let n = selectedMetrics.length, cols = n==1?1:n<=3?2:n<=6?3:3;
        container.style.gridTemplateColumns = `repeat(${cols},1fr)`;
        selectedMetrics.forEach(code=>{
          const m = metrics.find(x=>x.code===code);
          const div = document.createElement('div');
          div.className = 'chart';
          div.id = 'chart-'+code;
          div.style.height = n==1 ? '500px' : '300px';
          // 导出/全屏按钮
          let btnBar=document.createElement('div');
          btnBar.style='position:absolute;right:12px;top:8px;z-index:2;';
          let btnExport=document.createElement('button');
          btnExport.innerText='导出';btnExport.style='margin-right:8px;padding:2px 10px;border-radius:4px;border:none;background:#00eaff;color:#232946;cursor:pointer;font-weight:bold;';
          let btnFull=document.createElement('button');
          btnFull.innerText='全屏';btnFull.style='padding:2px 10px;border-radius:4px;border:none;background:#00eaff;color:#232946;cursor:pointer;font-weight:bold;';
          btnExport.onclick=()=>{
            let chart=echarts.getInstanceByDom(div)||echarts.init(div);
            let url=chart.getDataURL({type:'png',backgroundColor:'#232946'});
            let a=document.createElement('a');a.href=url;a.download=m.name+'.png';a.click();
          };
          btnFull.onclick=()=>{
            if(div.requestFullscreen)div.requestFullscreen();
            setTimeout(()=>{let chart=echarts.getInstanceByDom(div)||echarts.init(div);chart.resize();},300);
          };
          btnBar.appendChild(btnExport);btnBar.appendChild(btnFull);
          div.style.position='relative';div.appendChild(btnBar);
          container.appendChild(div);
        });
        drawCharts(selectedMetrics);
      }

      function drawCharts(selectedMetrics) {
        selectedMetrics.forEach(code=>{
          const m = metrics.find(x=>x.code===code);
          const dom = document.getElementById('chart-'+code);
          const chart = echarts.init(dom);
          const series = [{
            name:'部门平均',type:'line',smooth:true,data:dept[m.code],
            lineStyle:{width:4,color:m.color,shadowColor:m.color,shadowBlur:16},
            itemStyle:{opacity:1},sampling:'lttb',z:10
          }];
          allUsers.forEach((u,i)=>{
            const data = ts.map(t=>users[u][t]&&users[u][t][m.code]!=null?users[u][t][m.code]:null);
            series.push({
              name:u,type:'line',smooth:true,data,
              showSymbol:false,
              lineStyle:{
                width:2,
                color:userColors[i%userColors.length],
                opacity:shownUsers.includes(u)?0.85:0.18,
                shadowColor:userColors[i%userColors.length],
                shadowBlur:shownUsers.includes(u)?8:0
              },
              itemStyle:{opacity:shownUsers.includes(u)?0.85:0.18},
              sampling:'lttb',emphasis:{focus:'series'}
            });
          });
          const legendSelected = { '部门平均': true };
          allUsers.forEach((u,i)=>{ legendSelected[u] = shownUsers.includes(u); });
          chart.setOption({
            color: [m.color,...userColors],
            backgroundColor:'#232946',
            title:{
              text:m.name,
              textStyle:{
                color:'#fff',
                fontWeight:'bold',
                fontSize:22,
                textShadowColor:'#000a',
                textShadowBlur:8,
                textShadowOffsetY:2
              },
              left:'center'
            },
            tooltip:{trigger:'axis',axisPointer:{type:'cross'},backgroundColor:'#232946cc',borderColor:'#00eaff',textStyle:{color:'#fff'}},
            legend:{
              show:false,
              textStyle:{
                color:'#b0c4de',
                fontWeight:'bold',
                fontSize:18,
                textShadowColor:'#000a',
                textShadowBlur:6
              }
            },
            grid:{left:40,right:20,bottom:40,top:60},
            xAxis:{type:'category',data:ts,axisLabel:{color:'#b0c4de',rotate:45,fontSize:11}},
            yAxis:{type:'value',name:m.name,nameTextStyle:{color:'#b0c4de'},axisLabel:{color:'#b0c4de'}},
            dataZoom:[{
              type:'slider',
              start:80,
              end:100,
              backgroundColor:'#1a1e35',
              fillerColor:'#00eaff66',
              borderColor:'#00eaff',
              dataBackground: {
                lineStyle: { color: '#00eaff88', width: 2 },
                areaStyle: { color: '#00eaff22' }
              },
              selectedDataBackground: {
                lineStyle: { color: '#ffffff', width: 2 },
                areaStyle: { color: '#00eaff44' }
              },
              handleStyle: {
                color: '#00eaff',
                borderColor: '#ffffff',
                borderWidth: 2
              },
              textStyle: { color: '#ffffff' }
            }],
            series
          });
        });
      }
    }
  </script>
</body>
</html>