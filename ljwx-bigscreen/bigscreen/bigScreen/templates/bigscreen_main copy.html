<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½å¥åº·æ•°æ®åˆ†æå¹³å°</title>


<style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #001529;
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        overflow: hidden;
      }

      .container {
        display: grid;
        grid-template-columns: 22% 1fr 22%; /* è°ƒæ•´ä¸ºæ¯”ä¾‹åˆ†é…ï¼šå·¦22% ä¸­é—´è‡ªé€‚åº” å³22% */
        grid-gap: 16px; /* å‡å°‘é—´è·ï¼šä»20pxå‡å°‘åˆ°16px */
        padding: 0 16px 16px 16px; /* å‡å°‘å†…è¾¹è·ï¼šä»20pxå‡å°‘åˆ°16px */
        height: calc(100vh - 76px); /* ä¼˜åŒ–é«˜åº¦è®¡ç®—ï¼š60pxæ ‡é¢˜+16pxåº•è¾¹è· */
        max-height: calc(100vh - 76px); /* é™åˆ¶æœ€å¤§é«˜åº¦ */
        overflow: hidden;
      }

      .panel {
        background: rgba(0, 21, 41, 0.7);
        border: 1px solid rgba(0, 228, 255, 0.2);
        border-radius: 4px;
        padding: 10px; /* å‡å°‘å†…è¾¹è·ï¼šä»12pxå‡å°‘åˆ°10px */
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .side-container {
        display: flex;
        flex-direction: column;
        gap: 12px; /* å‡å°‘é—´è·ï¼šä»15pxå‡å°‘åˆ°12px */
        height: 100%;
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      .panel:nth-child(1) {
        height: 30%; /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿ï¼šä»20%å¢åŠ åˆ°30% */
        min-height: 150px; /* å¢åŠ æœ€å°é«˜åº¦ */
        max-height: 250px; /* å¢åŠ æœ€å¤§é«˜åº¦ */
      }

      .panel:nth-child(2) {
        height: 30%; /* äººå‘˜ç®¡ç†é¢æ¿ï¼šä»35%å‡å°‘åˆ°30% */
        min-height: 220px; /* è°ƒæ•´æœ€å°é«˜åº¦ */
        max-height: none; /* è°ƒæ•´æœ€å¤§é«˜åº¦ */
      }

      .panel:nth-child(3) {
        flex: 1; /* ä½¿ç”¨flex: 1å¡«å……å‰©ä½™ç©ºé—´è€Œä¸æ˜¯å›ºå®šé«˜åº¦ */
        min-height: 220px; /* è°ƒæ•´æœ€å°é«˜åº¦ */
        max-height: none; /* å…è®¸è‡ªé€‚åº”ä½†ä¸è¶…è¿‡å®¹å™¨ */
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      /* å³ä¾§é¢æ¿é«˜åº¦åˆ†é… */
      .side-container:last-child .panel:nth-child(1) {
        height: 30%; /* æ‰‹è¡¨ç®¡ç†é¢æ¿ï¼šä¿æŒ30% */
        min-height: 220px; /* ä¿æŒæœ€å°é«˜åº¦ */
        max-height: 280px; /* ä¿æŒæœ€å¤§é«˜åº¦ */
      }

      .side-container:last-child .panel:nth-child(2) {
        height: 34%; /* å¥åº·æ•°æ®åˆ†æé¢æ¿ï¼šä»32%å¢åŠ åˆ°34% */
        min-height: 200px; /* ä¿æŒæœ€å°é«˜åº¦ */
        max-height: 320px; /* ä¿æŒæœ€å¤§é«˜åº¦ */
      }

      .side-container:last-child .panel:nth-child(3) {
        flex: 1; /* ä½¿ç”¨flex: 1å¡«å……å‰©ä½™ç©ºé—´ç¡®ä¿åº•éƒ¨å¯¹é½ */
        min-height: 200px; /* è°ƒæ•´æœ€å°é«˜åº¦ */
        max-height: none; /* ä¿æŒæ— æœ€å¤§é«˜åº¦é™åˆ¶ */
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      .panel-header {
        color: #00e4ff;
        font-size: 16px;
        margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
      }

      .panel-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .map-container {
        flex: 1; /* ä½¿ç”¨flex: 1è‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´ */
        background: rgba(0, 21, 41, 0.7);
        border: 1px solid rgba(0, 228, 255, 0.2);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        min-height: 300px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿åœ°å›¾æœ‰è¶³å¤Ÿæ˜¾ç¤ºç©ºé—´ */
      }

      /* æ•°æ®å¡ç‰‡æ ·å¼ */
      .data-card {
        background: rgba(0, 228, 255, 0.1);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
      }

      .data-card-value {
        font-size: 24px;
        color: #00e4ff;
        margin: 5px 0;
      }

      /* æ»šåŠ¨æ¡ç¾åŒ– */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 228, 255, 0.1);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(0, 228, 255, 0.3);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 228, 255, 0.5);
      }

      /* å›¾è¡¨å®¹å™¨æ ·å¼ */
      .chart-container {
        position: relative;
        flex: 1;
        width: 100%;
        height: calc(100% - 40px); /* å‡å°‘é«˜åº¦åç§»ï¼Œç»™å›¾è¡¨æ›´å¤šç©ºé—´ */
        min-height: 120px; /* å¢åŠ æœ€å°é«˜åº¦ç¡®ä¿å†…å®¹æ˜¾ç¤º */
      }

      /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿çš„å›¾è¡¨å®¹å™¨ç‰¹æ®Šæ ·å¼ */
      .panel:nth-child(1) .chart-container {
        min-height: 100px; /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿çš„å›¾è¡¨æœ€å°é«˜åº¦ï¼šä»80pxå¢åŠ åˆ°100px */
        height: calc(100% - 60px); /* ä¸ºç»Ÿè®¡æ•°æ®ç•™å‡ºæ›´å¤šç©ºé—´ */
      }

      /* å‘Šè­¦é¢æ¿çš„å›¾è¡¨å®¹å™¨ç‰¹æ®Šæ ·å¼ */
      .panel:nth-child(3) .chart-container {
        min-height: 140px; /* å¢åŠ å‘Šè­¦é¢æ¿çš„å›¾è¡¨æœ€å°é«˜åº¦ï¼šä»120pxå¢åŠ åˆ°140px */
        height: calc(100% - 20px);
      }

      /* å³ä¾§é¢æ¿å›¾è¡¨å®¹å™¨ä¼˜åŒ– */
      .side-container:last-child .panel:nth-child(1) .chart-container {
        min-height: 120px; /* æ‰‹è¡¨ç®¡ç†é¢æ¿å›¾è¡¨æœ€å°é«˜åº¦ */
        height: calc(100% - 40px);
      }

      .side-container:last-child .panel:nth-child(2) .chart-container {
        min-height: 140px; /* å¥åº·æ•°æ®åˆ†æé¢æ¿å›¾è¡¨æœ€å°é«˜åº¦ */
        height: calc(100% - 40px);
      }

      .side-container:last-child .panel:nth-child(3) .chart-container {
        min-height: 150px; /* å¥åº·è¯„åˆ†é¢æ¿æœ€å°é«˜åº¦ï¼šä»120pxå¢åŠ åˆ°150px */
        height: calc(100% - 40px);
        max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
      }

      /* å‘Šè­¦å›¾è¡¨ä¸“ç”¨æ ·å¼ */
      #alertTypeChart, #alertLevelChart, #alertStatusChart, #alertTrendChart {
        width: 100% !important;
        height: 100% !important;
        min-height: 80px !important;
        max-height: 150px !important; /* é™åˆ¶å•ä¸ªå›¾è¡¨æœ€å¤§é«˜åº¦ */
        overflow: hidden !important;
      }

      /* ç‰¹åˆ«é™åˆ¶å‘Šè­¦ç±»å‹å›¾è¡¨é«˜åº¦ */
      #alertTypeChart {
        max-height: 120px !important; /* æ›´ä¸¥æ ¼çš„é«˜åº¦é™åˆ¶ */
      }

      /* å‘Šè­¦é¢æ¿ç½‘æ ¼å¸ƒå±€ä¼˜åŒ– */
      .alert-charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 8px; /* å‡å°‘é—´è·é€‚åº”æ›´çª„çš„å®½åº¦ */
        height: calc(100% - 60px); /* ä¸ºé¡¶éƒ¨ç»Ÿè®¡ç•™å‡ºæ›´å¤šç©ºé—´ */
        min-height: 220px; /* å‡å°‘æœ€å°é«˜åº¦é€‚åº”é¢æ¿ */
        max-height: none; /* é™åˆ¶æœ€å¤§é«˜åº¦é˜²æ­¢å˜å½¢ */
        overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media screen and (min-width: 1920px) {
        .container {
          grid-template-columns: 20% 1fr 20%; /* è¶…å®½å±ï¼šå‡å°‘ä¾§è¾¹æ å®½åº¦ï¼Œç»™ä¸­é—´æ›´å¤šç©ºé—´ */
        }
      }

      @media screen and (max-width: 1600px) {
        .container {
          grid-template-columns: 24% 1fr 24%; /* ä¸­ç­‰å±å¹•ï¼šç¨å¾®å¢åŠ ä¾§è¾¹æ å®½åº¦ */
        }
      }

      @media screen and (max-width: 1200px) {
        .container {
          grid-template-columns: 26% 1fr 26%; /* å°å±å¹•ï¼šè¿›ä¸€æ­¥å¢åŠ ä¾§è¾¹æ å®½åº¦ç¡®ä¿å†…å®¹æ˜¾ç¤º */
        }
      }

      @media screen and (max-width: 1024px) {
        .container {
          grid-template-columns: 28% 1fr 28%; /* æ›´å°å±å¹•ï¼šæœ€å¤§åŒ–ä¾§è¾¹æ å®½åº¦ */
          grid-gap: 12px; /* å‡å°‘é—´è· */
        }
        
        /* ä¼˜åŒ–å°å±å¹•ä¸‹çš„é¢æ¿å†…å®¹ */
        .panel-header {
          font-size: 14px;
          margin-bottom: 8px;
        }
        
        .alert-charts-grid {
          gap: 4px; /* è¿›ä¸€æ­¥å‡å°‘é—´è· */
          min-height: 220px;
        }
        
        .chart-container {
          min-height: 100px;
        }
        
        .side-container:last-child .panel:nth-child(3) .chart-container {
          min-height: 100px;
        }
      }

      /* åœ¨å·²æœ‰çš„ style æ ‡ç­¾ä¸­æ·»åŠ  */
      .header-title {
    position: relative;
    width: 100%;
        height: 60px;
        background: linear-gradient(90deg, rgba(0,21,41,0.8) 0%, rgba(0,91,171,0.8) 50%, rgba(0,21,41,0.8) 100%);
    display: flex;
        justify-content: center;
    align-items: center;
        border-bottom: 1px solid rgba(0,228,255,0.3);
    margin-bottom: 20px;
}

      .header-title h1 {
        color: #00e4ff;
        font-size: 28px;
        font-weight: normal;
        text-shadow: 0 0 10px rgba(0,228,255,0.5);
        letter-spacing: 2px;
      }

      .header-title::before,
      .header-title::after {
        content: '';
        position: absolute;
        width: 200px;
        height: 1px;
        background: linear-gradient(90deg, transparent, #00e4ff, transparent);
        bottom: -1px;
      }

      .header-title::before {
        left: 0;
      }

      .header-title::after {
        right: 0;
      }

      /* æ·»åŠ è£…é¥°å…ƒç´  */
      .header-decoration {
    position: absolute;
        width: 120px;
        height: 30px;
    top: 50%;
        transform: translateY(-50%);
      }

      .header-decoration.left {
        left: 50px;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMzAiPjxwYXRoIGQ9Ik0wIDE1aDEyME0zMCAwdjMwTTYwIDB2MzBNOTAgMHYzMCIgc3Ryb2tlPSIjMDBlNGZmIiBzdHJva2Utd2lkdGg9IjEiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==');
      }

      .header-decoration.right {
        right: 50px;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMzAiPjxwYXRoIGQ9Ik0wIDE1aDEyME0zMCAwdjMwTTYwIDB2MzBNOTAgMHYzMCIgc3Ryb2tlPSIjMDBlNGZmIiBzdHJva2Utd2lkdGg9IjEiIG9wYWNpdHk9IjAuMyIvPjwvc3ZnPg==');
        transform: translateY(-50%) scaleX(-1);
      }

      /* æ·»åŠ äººå‘˜ç®¡ç†é¢æ¿ç‰¹æ®Šè°ƒæ•´ */
      .personnel-management {
        background: rgba(1, 19, 38, 0.8);
        border: 1px solid rgba(0, 228, 255, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
      }

      .personnel-management:hover {
        border-color: rgba(0, 228, 255, 0.4);
        box-shadow: 0 0 15px rgba(0, 228, 255, 0.2);
      }

      .personnel-management .panel-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .personnel-management .data-overview {
        display: flex;
        justify-content: space-between;
        padding: 8px 20px;
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(0, 228, 255, 0.1);
      }

      .personnel-management .overview-item {
        text-align: center;
    display: flex;
    align-items: center;
        gap: 8px;
      }

      .personnel-management .overview-item .label {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 0;
      }

      .personnel-management .overview-item .number {
        font-size: 18px;
        color: #00e4ff;
        font-weight: 600;
      }

      .personnel-management .department-chart {
    flex: 1;
        height: calc(100% - 50px); /* ç»™å›¾è¡¨æ›´å¤šç©ºé—´ */
        min-height: 0;
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media screen and (max-height: 800px) {
        .personnel-management .overview-item .number {
          font-size: 18px;
        }
        
        .personnel-management .overview-item .label {
          font-size: 11px;
        }
}

/* åœ¨å·²æœ‰çš„styleæ ‡ç­¾ä¸­æ·»åŠ  */
.message-count {
    font-size: 14px;
    color: #00e4ff;
    background: rgba(0, 228, 255, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 10px;
}

.message-list {
    height: calc(100% - 30px);
    overflow-y: auto;
    padding: 5px;
}

.message-item {
    background: rgba(0,228,255,0.1);
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 6px;
    border-left: 3px solid #00e4ff;
    font-size: 12px;
    line-height: 1.4;
}

.message-time {
    color: rgba(255,255,255,0.6);
    font-size: 10px;
    float: right;
}

.message-content {
    color: #fff;
    margin-top: 2px;
}

.device-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px; /* å‡å°‘é—´è· */
    margin-bottom: 8px; /* å‡å°‘åº•éƒ¨è¾¹è· */
    height: 50px; /* å‡å°‘å›ºå®šé«˜åº¦ */
}

.device-stat-item {
    background: rgba(0, 228, 255, 0.1);
    border-radius: 4px;
    padding: 4px; /* å‡å°‘å†…è¾¹è· */
    text-align: center;
    border-left: 3px solid #00e4ff;
    transition: all 0.3s ease;
    position: relative;
}

.device-stat-item:hover {
    background: rgba(0, 228, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 228, 255, 0.2);
}

.stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 9px; /* å‡å°‘å­—ä½“å¤§å° */
    display: block;
    margin-bottom: 1px; /* å‡å°‘è¾¹è· */
}

.stat-value {
    color: #00e4ff;
    font-size: 14px; /* å‡å°‘å­—ä½“å¤§å° */
    font-weight: bold;
    display: inline-block;
}

.stat-unit {
    color: rgba(255, 255, 255, 0.6);
    font-size: 8px;
    margin-left: 2px;
}

.stats-date {
    color: rgba(255, 255, 255, 0.6);
    font-size: 12px;
    font-weight: normal;
}

.total-score {
    font-size: 16px;
    color: #00e4ff;
    background: rgba(0, 228, 255, 0.1);
    padding: 4px 12px;
    border-radius: 12px;
}

/* åœ¨ <style> æ ‡ç­¾ä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼ */
.modal-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-content {
    position: relative;
    width: 90%;
    height: 90%;
    background: rgba(0, 21, 41, 0.95);
    border: 1px solid rgba(0, 228, 255, 0.3);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 228, 255, 0.2);
}

.modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: transparent;
    border: none;
    color: #00e4ff;
    font-size: 18px;
    cursor: pointer;
    z-index: 9999;
    padding: 5px 10px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    transform: scale(1.1);
    color: #ff4444;
}

.user-view-iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 4px;
    background: rgba(1, 19, 38, 0.8);
}

/* æ·»åŠ åŠ¨ç”»æ•ˆæœ */
.modal-container {
    animation: fadeIn 0.3s ease;
}

.modal-content {
    animation: slideIn 0.3s ease;
}

@keyframes fadeIn {
    from {
    opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.filter-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    background: rgba(0, 21, 41, 0.9);
    backdrop-filter: blur(8px);
    padding: 15px;
    border-radius: 8px;
    width: 280px;
    border: 1px solid rgba(0, 228, 255, 0.2);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
}

.filter-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0, 228, 255, 0.2);
}

.filter-header span {
    color: #00e4ff;
    font-size: 14px;
    font-weight: bold;
}

.filter-select {
    font-family: monospace;
    white-space: pre;
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    transition: all 0.3s ease;
}

.filter-select:hover {
    border-color: rgba(0, 228, 255, 0.4);
}

.filter-select:focus {
    border-color: rgba(0, 228, 255, 0.6);
    outline: none;
    box-shadow: 0 0 5px rgba(0, 228, 255, 0.2);
}

.filter-select option {
    font-family: monospace;
    white-space: pre;
    background: #1a1a1a;
    color: #fff;
    padding: 8px;
}

/* æ·»åŠ ç¾åŒ–çš„å¼¹å‡ºæ¡†æ ·å¼ */
.custom-alert {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 21, 41, 0.95);
    border: 1px solid rgba(0, 228, 255, 0.3);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    z-index: 10000;
    min-width: 300px;
    text-align: center;
    animation: alertFadeIn 0.3s ease;
}

.custom-alert-content {
    color: #fff;
    font-size: 16px;
    margin-bottom: 20px;
}

.custom-alert-button {
    background: rgba(0, 228, 255, 0.2);
    border: 1px solid rgba(0, 228, 255, 0.4);
    color: #00e4ff;
    padding: 8px 20px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.custom-alert-button:hover {
    background: rgba(0, 228, 255, 0.3);
    border-color: rgba(0, 228, 255, 0.6);
}

@keyframes alertFadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

/* æ·»åŠ é®ç½©å±‚æ ·å¼ */
.custom-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
    z-index: 9999;
    animation: overlayFadeIn 0.3s ease;
}

@keyframes overlayFadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* ç°ä»£ç§‘æŠ€é£æ ¼ä¿¡æ¯é¢æ¿ */
.info-panel {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 360px;
  background: rgba(13, 17, 38, 0.95);
  border: 1px solid rgba(0, 234, 255, 0.3);
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
  backdrop-filter: blur(10px);
  z-index: 1000;
  transition: all 0.3s ease;
  overflow: hidden;
}

.info-panel-header {
  padding: 15px 20px;
  background: linear-gradient(90deg, rgba(0, 234, 255, 0.1), rgba(0, 234, 255, 0.05));
  border-bottom: 1px solid rgba(0, 234, 255, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.info-panel-title {
  color: #00eaff;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-panel-close {
  background: none;
  border: none;
  color: #00eaff;
  font-size: 18px;
  cursor: pointer;
  padding: 5px;
  transition: all 0.2s ease;
}

.info-panel-close:hover {
  color: #fff;
  transform: rotate(90deg);
}

.info-panel-content {
  padding: 20px;
  max-height: 70vh;
  overflow-y: auto;
}

.info-item {
  background: rgba(0, 234, 255, 0.05);
  border: 1px solid rgba(0, 234, 255, 0.1);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 12px;
  transition: all 0.2s ease;
}

.info-item:hover {
  background: rgba(0, 234, 255, 0.1);
  transform: translateX(-5px);
}

.info-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.info-item-title {
  color: #00eaff;
  font-size: 16px;
  font-weight: 500;
}

.info-item-time {
  color: rgba(255, 255, 255, 0.6);
  font-size: 14px;
}

.info-item-content {
  color: #fff;
  font-size: 14px;
  line-height: 1.6;
}

.info-item-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(0, 234, 255, 0.1);
}

.info-item-location {
  color: rgba(255, 255, 255, 0.6);
  font-size: 13px;
}

.info-item-action {
  background: #00eaff;
  color: #0d1126;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.info-item-action:hover {
  background: #38f9d7;
}

/* å¥åº·ä¿¡æ¯æ ·å¼ */
.health-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.health-item {
  background: rgba(0, 234, 255, 0.05);
  padding: 8px;
  border-radius: 6px;
  text-align: center;
}

.health-label {
  color: rgba(255, 255, 255, 0.6);
  font-size: 12px;
  margin-bottom: 4px;
}

.health-value {
  color: #00eaff;
  font-size: 16px;
  font-weight: 500;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
.info-panel-content::-webkit-scrollbar {
  width: 6px;
}

.info-panel-content::-webkit-scrollbar-track {
  background: rgba(0, 234, 255, 0.05);
}

.info-panel-content::-webkit-scrollbar-thumb {
  background: rgba(0, 234, 255, 0.3);
  border-radius: 3px;
}

.info-panel-content::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 234, 255, 0.5);
}

.info-item-highlight { border:2px solid #ffbb00; box-shadow:0 0 12px #ffbb0088; }

      /* äººå‘˜ç®¡ç†é¢æ¿ä¸“ç”¨æ ·å¼ */
      .personnel-management .panel-header h3 {
        color: #00e4ff;
        font-size: 16px;
        margin: 0;
        font-weight: 600;
      }

      /* ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡æ ·å¼ */
      .personnel-management .panel-content > div:first-child {
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .personnel-management .panel-content > div:first-child:hover {
        background: rgba(0, 228, 255, 0.15) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 228, 255, 0.2);
      }

      /* å›¾è¡¨å®¹å™¨ä¼˜åŒ– */
      #departmentDistribution, #userStatusChart {
        transition: all 0.3s ease;
      }

      #departmentDistribution:hover, #userStatusChart:hover {
        border-color: rgba(0, 228, 255, 0.6) !important;
        box-shadow: 0 4px 15px rgba(0, 228, 255, 0.2) !important;
      }


      /* ç»Ÿè®¡ä¿¡æ¯é¢æ¿æ ·å¼ä¼˜åŒ– */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 10px;
        height: auto;
      }

      .stat-card {
        background: linear-gradient(135deg, rgba(0, 228, 255, 0.1), rgba(0, 228, 255, 0.05));
        border-radius: 6px;
        padding: 8px;
        border-left: 3px solid #00e4ff;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }

      .stat-card:hover::before {
        transform: translateX(100%);
      }

      .stat-card:hover {
        background: linear-gradient(135deg, rgba(0, 228, 255, 0.15), rgba(0, 228, 255, 0.08));
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 228, 255, 0.3);
        border-left-color: #38f9d7;
      }

      .stat-card.health-data { border-left-color: #00e4ff; }
      .stat-card.alert-data { border-left-color: #ff6b6b; }
      .stat-card.device-data { border-left-color: #00ff9d; }
      .stat-card.message-data { border-left-color: #ffbb00; }

      .stat-icon {
        font-size: 16px;
        position: absolute;
        top: 6px;
        right: 8px;
        opacity: 0.7;
      }

      .stat-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .stat-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 9px;
        font-weight: 500;
      }

      .stat-value-container {
        display: flex;
        align-items: baseline;
        gap: 2px;
      }

      .stat-value {
        color: #00e4ff;
        font-size: 16px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
      }

      .stat-unit {
        color: rgba(255, 255, 255, 0.6);
        font-size: 8px;
        margin-left: 2px;
      }

      .stat-trend {
        color: #00ff9d;
        font-size: 8px;
        font-weight: 500;
      }

      .stat-trend.negative {
        color: #ff6b6b;
      }

      .system-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        background: rgba(0, 21, 41, 0.6);
        border-radius: 4px;
        border: 1px solid rgba(0, 228, 255, 0.2);
        margin-top: 8px;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-indicator.normal { background: #00ff9d; }
      .status-indicator.warning { background: #ffbb00; }
      .status-indicator.critical { background: #ff6b6b; }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }

      .status-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 10px;
        flex: 1;
      }

      .health-score {
        color: #00e4ff;
        font-size: 12px;
        font-weight: bold;
      }

      .stats-date {
        color: rgba(255, 255, 255, 0.6);
        font-size: 10px;
        font-weight: normal;
      }

      /* å‘Šè­¦ç±»å‹å›¾è¡¨ç‰¹æ®Šä¼˜åŒ– - é˜²æ­¢ç±»å‹è¿‡å¤šæ—¶å˜å½¢ */
      .alert-type-container {
        max-height: 120px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* å½“å‘Šè­¦ç±»å‹è¶…è¿‡5ä¸ªæ—¶çš„ç‰¹æ®Šå¤„ç† */
      .alert-type-scroll {
        max-height: 100px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 228, 255, 0.3) transparent;
      }

      .alert-type-scroll::-webkit-scrollbar {
        width: 4px;
      }

      .alert-type-scroll::-webkit-scrollbar-track {
        background: rgba(0, 228, 255, 0.1);
      }

      .alert-type-scroll::-webkit-scrollbar-thumb {
        background: rgba(0, 228, 255, 0.3);
        border-radius: 2px;
      }

      /* æ¶ˆæ¯é¢æ¿ä¼˜åŒ–æ ·å¼ - ç»Ÿä¸€å®šä¹‰ */
      .message-panel {
          height: 240px; /* ä½¿ç”¨å›ºå®šé«˜åº¦240pxç¡®ä¿åº•éƒ¨å¯¹é½ */
          background: rgba(0, 21, 41, 0.7);
          border: 1px solid rgba(0, 228, 255, 0.2);
          border-radius: 4px;
          padding: 8px; /* å‡å°‘å†…è¾¹è·ï¼šä»10pxå‡å°‘åˆ°8px */
          margin-bottom: 0; /* ç§»é™¤åº•éƒ¨é—´è·ç¡®ä¿å¯¹é½ */
          min-height: 220px; /* ä¿æŒæœ€å°é«˜åº¦ */
          max-height: 280px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
          overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
          display: flex;
          flex-direction: column;
          flex-shrink: 0; /* é˜²æ­¢ç¼©æ”¾ */
      }

      /* æ¶ˆæ¯é¢æ¿æ ‡é¢˜ */
      .message-panel .panel-header {
          flex-shrink: 0; /* æ ‡é¢˜ä¸ç¼©æ”¾ */
          margin-bottom: 8px;
          height: 24px; /* å›ºå®šæ ‡é¢˜é«˜åº¦ */
      }

      /* æ¶ˆæ¯é¢æ¿å†…å®¹åŒºåŸŸ */
      .message-panel-content {
          flex: 1; /* å ç”¨å‰©ä½™ç©ºé—´ */
          display: flex;
          gap: 10px;
          min-height: 0; /* å…è®¸å†…å®¹ç¼©æ”¾ */
          width: 100%;
          box-sizing: border-box;
      }

      /* æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ */
      .message-list-container {
          flex: 0 0 60%; /* å›ºå®š60%å®½åº¦ */
          display: flex;
          flex-direction: column;
          min-height: 0;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡åŒºåŸŸ */
      .message-stats-container {
          flex: 0 0 38%; /* å›ºå®š38%å®½åº¦ï¼Œç•™2%é—´è· */
          display: flex;
          flex-direction: column;
          min-height: 0;
      }

      /* æ¶ˆæ¯åˆ—è¡¨æ ·å¼ */
      .message-list {
          flex: 1;
          overflow-y: auto;
          padding: 5px;
          background: rgba(0,21,41,0.3);
          border-radius: 4px;
          border: 1px solid rgba(0,228,255,0.1);
          min-height: 60px; /* ç¡®ä¿æœ€å°æ˜¾ç¤ºé«˜åº¦ */
      }

      /* æ¶ˆæ¯é¡¹æ ·å¼ */
      .message-item {
          padding: 4px 6px;
          margin-bottom: 3px;
          background: rgba(0,228,255,0.05);
          border-radius: 3px;
          border-left: 2px solid #00e4ff;
          font-size: 10px;
          line-height: 1.3;
          color: rgba(255,255,255,0.9);
          cursor: pointer;
          transition: all 0.2s ease;
      }

      .message-item:hover {
          background: rgba(0,228,255,0.1);
          border-left-color: #38f9d7;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨å®¹å™¨ */
      .message-stats-chart {
          flex: 1;
          background: rgba(0,21,41,0.3);
          border-radius: 4px;
          border: 1px solid rgba(0,228,255,0.1);
          position: relative;
          min-height: 60px;
      }


      /* æ¶ˆæ¯é¢æ¿é¢å¤–ä¼˜åŒ– - é˜²æ­¢å˜å½¢ */
      .message-panel-content {
          width: 100%;
          box-sizing: border-box;
      }

      .message-list-container,
      .message-stats-container {
          box-sizing: border-box;
          overflow: hidden;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡æ¦‚è§ˆæ ·å¼ä¼˜åŒ– */
      .message-stats-overview {
          display: flex;
          justify-content: space-around;
          padding: 6px 3px;
          border-bottom: 1px solid rgba(0,228,255,0.1);
          flex-shrink: 0;
          height: 36px;
          box-sizing: border-box;
      }

      .message-stats-overview > div {
          text-align: center;
          flex: 1;
      }

      /* æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨åŒºåŸŸ */
      #messageStatsChart {
          height: calc(100% - 36px) !important;
          width: 100% !important;
          min-height: 40px !important;
      }

      /* æ‰‹è¡¨ç®¡ç†é¢æ¿æ ·å¼ */
      .watch-management {
          background: linear-gradient(135deg, rgba(0, 21, 41, 0.9), rgba(0, 91, 171, 0.1));
      }

      .watch-stats {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
          margin-bottom: 12px;
      }

      .watch-stat-card {
          background: rgba(0, 228, 255, 0.1);
          border-radius: 4px;
          padding: 8px;
          text-align: center;
          border-left: 3px solid #00e4ff;
          transition: all 0.3s ease;
          cursor: pointer;
      }

      .watch-stat-card:hover {
          background: rgba(0, 228, 255, 0.2);
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0, 228, 255, 0.3);
      }

      .watch-stat-value {
          color: #00e4ff;
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 2px;
      }

      .watch-stat-label {
          color: rgba(255, 255, 255, 0.8);
          font-size: 10px;
      }

      /* å¥åº·æ•°æ®åˆ†æé¢æ¿æ ·å¼ */
      .health-analysis {
          background: linear-gradient(135deg, rgba(0, 21, 41, 0.9), rgba(0, 255, 157, 0.05));
      }

      .health-overview-card {
          background: linear-gradient(135deg, rgba(0, 228, 255, 0.15), rgba(0, 255, 157, 0.1));
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 12px;
          border: 1px solid rgba(0, 228, 255, 0.3);
          position: relative;
          overflow: hidden;
      }

      .health-overview-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
          transform: translateX(-100%);
          transition: transform 0.6s;
      }

      .health-overview-card:hover::before {
          transform: translateX(100%);
      }

      .health-metrics {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .health-metric {
          text-align: center;
          flex: 1;
      }

      .health-metric-value {
          color: #00e4ff;
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 4px;
      }

      .health-metric-label {
          color: rgba(255, 255, 255, 0.9);
          font-size: 11px;
      }

      /* å¥åº·è¯„åˆ†é¢æ¿æ ·å¼ */
      .health-score-panel {
          background: linear-gradient(135deg, rgba(0, 21, 41, 0.9), rgba(255, 187, 0, 0.05));
      }

      .score-display {
          display: flex;
          align-items: center;
          justify-content: space-between;
          background: rgba(0, 228, 255, 0.1);
          border-radius: 6px;
          padding: 10px;
          margin-bottom: 10px;
          border-left: 4px solid #ffbb00;
      }

      .score-main {
          display: flex;
          align-items: center;
          gap: 12px;
      }

      .score-circle {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: conic-gradient(#00e4ff 0deg, #00e4ff 320deg, rgba(255,255,255,0.2) 320deg);
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
      }

      .score-circle::before {
          content: '';
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: rgba(0, 21, 41, 0.9);
          position: absolute;
      }

      .score-number {
          color: #00e4ff;
          font-size: 16px;
          font-weight: bold;
          z-index: 1;
      }

      .score-info {
          flex: 1;
      }

      .score-title {
          color: #fff;
          font-size: 14px;
          margin-bottom: 4px;
      }

      .score-status {
          color: #00ff9d;
          font-size: 12px;
      }

      /* æ¶ˆæ¯é¢æ¿é¢å¤–ä¼˜åŒ– - é˜²æ­¢å˜å½¢ */
  </style>
  </head>
  <body>
    <!-- æ·»åŠ æ ‡é¢˜æ  -->
    <div class="header-title">
        <div class="header-decoration left"></div>
        <h1>{{ BIGSCREEN_TITLE }}</h1>
      
        <div class="header-decoration right"></div>
          </div>

    <div class="container">
      <!-- å·¦ä¾§é¢æ¿ -->
      <div class="side-container">
        <div class="panel">
          <div class="panel-header">
            <span>å®æ—¶ç»Ÿè®¡</span>
            <span class="stats-date" id="statsDate"></span>
          </div>
          <div class="panel-content">
            <div class="stats-grid">
              <div class="stat-card health-data">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-info">
                  <span class="stat-label">å¥åº·æ•°æ®</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="healthDataCount">0</span>
                    <span class="stat-unit">æ¡</span>
                  </div>
                  <div class="stat-trend" id="healthTrend">+0%</div>
                </div>
              </div>
              
              <div class="stat-card alert-data">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-info">
                  <span class="stat-label">å¾…å¤„ç†å‘Šè­¦</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="pendingAlerts">0</span>
                    <span class="stat-unit">æ¡</span>
                  </div>
                  <div class="stat-trend" id="alertTrend">+0%</div>
                </div>
              </div>
              
              <div class="stat-card device-data">
                <div class="stat-icon">ğŸ“±</div>
                <div class="stat-info">
                  <span class="stat-label">æ´»è·ƒè®¾å¤‡</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="activeDevices">0</span>
                    <span class="stat-unit">å°</span>
                  </div>
                  <div class="stat-trend" id="deviceTrend">+0%</div>
                </div>
              </div>
              
              <div class="stat-card message-data">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-info">
                  <span class="stat-label">æœªè¯»æ¶ˆæ¯</span>
                  <div class="stat-value-container">
                    <span class="stat-value" id="unreadMessages">0</span>
                    <span class="stat-unit">æ¡</span>
                  </div>
                  <div class="stat-trend" id="messageTrend">+0%</div>
                </div>
              </div>
            </div>
            
            <div class="system-status" id="systemStatus">
              <div class="status-indicator normal" id="statusIndicator"></div>
              <span class="status-text" id="statusText">ç³»ç»Ÿæ­£å¸¸</span>
              <span class="health-score" id="systemHealthScore">100</span>
            </div>
          </div>
        </div>
        
        <div class="panel personnel-management">
          <div class="panel-header">
              <h3>äººå‘˜ç®¡ç†</h3>
              </div>
          <div class="panel-content">
              <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 12px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 4px solid #00e4ff;">
                  <div style="display: flex; align-items: center; gap: 20px;">
                      <div style="text-align: center;">
                          <div style="color: #00e4ff; font-size: 18px; font-weight: bold;" id="totalUsers">0</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 11px;">æ€»äººæ•°</div>
                      </div>
                      <div style="text-align: center;">
                          <div style="color: #00ff9d; font-size: 18px; font-weight: bold;" id="totalBindDevices">0</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 11px;">å·²ç»‘å®šè®¾å¤‡</div>
                      </div>
                      <div style="text-align: center;">
                          <div style="color: #ffbb00; font-size: 18px; font-weight: bold;" id="onlineRate">0%</div>
                          <div style="color: rgba(255,255,255,0.8); font-size: 11px;">åœ¨çº¿ç‡</div>
                      </div>
                  </div>
                  <div style="color: rgba(255,255,255,0.6); font-size: 12px; cursor: pointer;" onclick="showPersonnelDetails()">
                      è¯¦æƒ… â†’
                  </div>
              </div>
              
              <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; height: 45px;">
                  <div style="background: rgba(0,228,255,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #00e4ff; cursor: pointer; transition: all 0.3s ease;" onclick="filterByDepartment()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,228,255,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #00e4ff; font-size: 14px; font-weight: bold;" id="activeDeptCount">0</div>
                      <div style="color: #fff; font-size: 9px;">æ´»è·ƒéƒ¨é—¨</div>
                  </div>
                  <div style="background: rgba(0,255,157,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #00ff9d; cursor: pointer; transition: all 0.3s ease;" onclick="filterByOnlineStatus()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,255,157,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #00ff9d; font-size: 14px; font-weight: bold;" id="onlineUsers">0</div>
                      <div style="color: #fff; font-size: 9px;">åœ¨çº¿äººå‘˜</div>
                  </div>
                  <div style="background: rgba(255,187,0,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #ffbb00; cursor: pointer; transition: all 0.3s ease;" onclick="filterByDeviceStatus()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,187,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #ffbb00; font-size: 14px; font-weight: bold;" id="boundDevices">0</div>
                      <div style="color: #fff; font-size: 9px;">ç»‘å®šè®¾å¤‡</div>
                  </div>
                  <div style="background: rgba(255,68,68,0.1); border-radius: 4px; padding: 4px; text-align: center; border-left: 3px solid #ff4444; cursor: pointer; transition: all 0.3s ease;" onclick="filterByAlertStatus()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,68,68,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                      <div style="color: #ff4444; font-size: 14px; font-weight: bold;" id="alertUsers">0</div>
                      <div style="color: #fff; font-size: 9px;">å‘Šè­¦äººå‘˜</div>
                  </div>
              </div>
              
              <!-- å›¾è¡¨åŒºåŸŸ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: calc(100% - 120px);">
                  <div id="departmentDistribution" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='rgba(0,228,255,0.6)'; this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)'" onmouseout="this.style.borderColor='rgba(0,228,255,0.3)'; this.style.boxShadow='none'">
                      <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">éƒ¨é—¨åˆ†å¸ƒ</div>
              </div>
                  <div id="userStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='rgba(0,228,255,0.6)'; this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)'" onmouseout="this.style.borderColor='rgba(0,228,255,0.3)'; this.style.boxShadow='none'">
                      <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">åœ¨çº¿çŠ¶æ€</div>
                  </div>
              </div>
            </div>
          </div>
        <div class="panel">
          <div class="panel-header">
            <span>å‘Šè­¦ä¿¡æ¯</span>
              </div>
          <div class="panel-content">
            <div id="alertList" class="chart-container"></div>
            </div>
              </div>
            </div>

      <!-- ä¸­é—´åœ°å›¾åŒºåŸŸ -->
      <div style="display: flex; flex-direction: column; height: 100%; width: 100%;">
        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container" id="map-container">
            <!-- ç­›é€‰é¢æ¿ -->
            <div class="filter-panel">
                <div class="filter-header">
                    <span>äººå‘˜ç­›é€‰</span>
                </div>
                <div class="filter-container">
                    <select id="deptSelect" class="filter-select">
                        <option value="">é€‰æ‹©éƒ¨é—¨</option>
                    </select>
                    <select id="userSelect" class="filter-select">
                        <option value="">é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
            </div>
        <!-- ä¿ç•™åŸæœ‰åœ°å›¾ä»£ç  -->
        </div>
        
        <!-- æ¶ˆæ¯é¢æ¿ -->
        <div class="message-panel">
          <div class="panel-header">
            <span>æ¶ˆæ¯ä¿¡æ¯</span>
            <span class="message-count" id="messageCount">0</span>
          </div>
          <!-- æ¶ˆæ¯é¢æ¿å†…å®¹ -->
          <div class="message-panel-content">
            <!-- å·¦ä¾§æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="message-list-container">
              <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-bottom: 5px; padding-left: 5px;">æœ€æ–°æ¶ˆæ¯</div>
              <div class="message-list" id="messageList"></div>
            </div>
            
            <!-- å³ä¾§ç»Ÿè®¡å›¾è¡¨ -->
            <div class="message-stats-container">
              <div style="color: rgba(255,255,255,0.8); font-size: 11px; margin-bottom: 5px; padding-left: 5px;">æ¶ˆæ¯ç»Ÿè®¡</div>
              <div class="message-stats-chart">
                <!-- æ¶ˆæ¯ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="message-stats-overview">
                  <div>
                    <div style="color: #00e4ff; font-size: 12px; font-weight: bold;" id="todayMessages">0</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 8px;">ä»Šæ—¥</div>
                  </div>
                  <div>
                    <div style="color: #ffbb00; font-size: 12px; font-weight: bold;" id="unreadMessages">0</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 8px;">æœªè¯»</div>
                  </div>
                  <div>
                    <div style="color: #00ff9d; font-size: 12px; font-weight: bold;" id="urgentMessages">0</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 8px;">ç´§æ€¥</div>
                  </div>
                </div>
                <!-- æ¶ˆæ¯ç±»å‹åˆ†å¸ƒå›¾ -->
                <div id="messageStatsChart"></div>
              </div>
            </div>
          </div>
        </div>
        </div>

      <!-- å³ä¾§é¢æ¿ -->
      <div class="side-container">
        <div class="panel watch-management">
          <div class="panel-header">
            <span>ğŸ“± æ‰‹è¡¨ç®¡ç†</span>
            <span class="label">æ€»æ•°: <span class="number" id="totalWatchDevices">35</span></span>
          </div>
          <div class="panel-content">
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div id="statsChart" class="chart-container"></div>
          </div>
        </div>
        
        <div class="panel health-analysis">
          <div class="panel-header">
            <span>ğŸ’— å¥åº·æ•°æ®åˆ†æ</span>
            <span style="color: rgba(255,255,255,0.6); font-size: 12px;">æœ€è¿‘7å¤©</span>
          </div>
          <div class="panel-content">
            <!-- å¥åº·è¶‹åŠ¿å›¾ -->
            <div id="trendChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative; height: 100%; transition: all 0.3s ease;" onmouseover="this.style.borderColor='rgba(0,228,255,0.6)'; this.style.boxShadow='0 4px 15px rgba(0,228,255,0.2)'" onmouseout="this.style.borderColor='rgba(0,228,255,0.3)'; this.style.boxShadow='none'">
              <div style="position: absolute; top: 8px; left: 12px; color: #00e4ff; font-size: 13px; font-weight: bold; z-index: 10;">ğŸ“Š å¥åº·è¶‹åŠ¿åˆ†æ</div>
            </div>
          </div>
        </div>
        
        <div class="panel health-score-panel">
          <div class="panel-header">
            <span>ğŸ† å¥åº·è¯„åˆ†</span>
            <span class="total-score">æ€»åˆ†ï¼š88.9</span>
          </div>
          <div class="panel-content">
            <!-- è¯„åˆ†æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="score-display">
              <div class="score-main">
                <div class="score-circle">
                  <div class="score-number">89</div>
                </div>
                <div class="score-info">
                  <div class="score-title">ç»¼åˆå¥åº·è¯„åˆ†</div>
                  <div class="score-status">è‰¯å¥½çŠ¶æ€</div>
                </div>
              </div>
              <div style="color: rgba(255,255,255,0.6); font-size: 12px; cursor: pointer;" onclick="showScoreDetails()">
                è¯¦æƒ… â†’
              </div>
            </div>
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div id="healthScoreChart" class="chart-container"></div>
          </div>
        </div>
      </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        window.difyChatbotConfig = {
         token: 'CdVhQIms3fZkQuTW',
         baseUrl: 'http://192.168.1.83',
         systemVariables: {
           // user_id: 'YOU CAN DEFINE USER ID HERE',
           // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
         },
        }
       </script>
       <script
        src="http://192.168.1.83/embed.min.js"
        id="CdVhQIms3fZkQuTW"
        defer>
       </script>
       <style>
         #dify-chatbot-bubble-button {
           background-color: #1C64F2 !important;
         }
         #dify-chatbot-bubble-window {
           width: 24rem !important;
           height: 40rem !important;
         }
       </style>
    <script>
      // åœ¨å…¨å±€ä½œç”¨åŸŸå£°æ˜å›¾è¡¨å˜é‡
      let globalCharts = null;
      let currentDept = '', currentUser = '';
      const ALERT_TYPE_MAP = {
        heart_rate: 'å¿ƒç‡',
        blood_pressure: 'è¡€å‹',
        stress: 'å‹åŠ›',
        blood_oxygen: 'è¡€æ°§',
        temperature: 'ä½“æ¸©',
        one_key_alarm: 'ä¸€é”®æŠ¥è­¦',
        fall_down: 'è·Œå€’',
        sleep: 'ç¡çœ '
      };
      const ALERT_SEVERITY_MAP = {
        critical: 'ä¸¥é‡',
        high: 'é«˜',
        medium: 'ä¸­',
        low: 'ä½'
      };
      const ALERT_STATUS_MAP = {
        pending: 'å¾…å¤„ç†',
        responded: 'å·²å“åº”',
        resolved: 'å·²è§£å†³'
      };
      function translateAlertType(type) {
        return ALERT_TYPE_MAP[type] || type;
      }
      function translateAlertSeverity(severity) {
        return ALERT_SEVERITY_MAP[severity] || severity;
      }
      function translateAlertStatus(status) {
        return ALERT_STATUS_MAP[status] || status;
      }
      const ALERT_TYPE_COLOR = {
        heart_rate: '#ff6b6b',
        blood_pressure: '#ffb347',
        stress: '#f7b731',
        blood_oxygen: '#00e4ff',
        temperature: '#ffd700',
        one_key_alarm: '#ffe066',
        fall_down: '#00cfff',
        sleep: '#7ecfff'
      };
      const ALERT_SEVERITY_COLOR = {    
        critical: '#ff6b6b',
        high: '#ffb347',
        medium: '#f7b731',
        low: '#00e4ff'
      };
      const ALERT_STATUS_COLOR = {
        pending: '#ff6b6b',
        responded: '#ffb347',
        resolved: '#00e4ff'
      };
      function getAlertTypeColor(type) {
        return ALERT_TYPE_COLOR[type] || '#7ecfff';
      }
      function getAlertSeverityColor(severity) {
        return ALERT_SEVERITY_COLOR[severity] || '#7ecfff';
      }
      function getAlertStatusColor(status) {
        return ALERT_STATUS_COLOR[status] || '#7ecfff';
      }

      // æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
      function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }

      // ä¿®æ”¹initChartså‡½æ•°
      function initCharts() {
        try {
            let charts = {
                healthScore: null,
                stats: null,
                trend: null,
                alert: null,
                messageStats: null // æ·»åŠ æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
            };

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–å¥åº·è¯„åˆ†å›¾è¡¨
            const healthScoreContainer = document.getElementById('healthScoreChart');
            if (healthScoreContainer) {
                charts.healthScore = echarts.init(healthScoreContainer);
                
                // ä»URLè·å–customerIdå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                
                // è·å–æ—¥æœŸèŒƒå›´
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 7);
                
                const startDate = formatDate(yesterday);
                const endDate = formatDate(today);
                
                // è°ƒç”¨æ¥å£è·å–å¥åº·è¯„åˆ†æ•°æ®
                fetch(`/health_data/score?orgId=${customerId}&startDate=${startDate}&endDate=${endDate}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data && result.data.healthScores) {
                            const factors = result.data.healthScores.factors;
                            
                            // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
                            const totalScoreElement = document.querySelector('.total-score');
                            if (totalScoreElement) {
                                totalScoreElement.textContent = `æ€»åˆ†ï¼š${result.data.summary.overallScore}`;
                            }
                            
                            const healthScoreOption = {
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: function(params) {
                                        return params[0].name + '<br/>' +
                                               params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                    }
                                },
                                radar: {
                                    radius: '65%',
                                    center: ['50%', '55%'],
                                    indicator: [
                                        { name: `å¿ƒç‡ ${factors.heartRate?.score || 0}åˆ†`, max: 100 },
                                        { name: `è¡€æ°§ ${factors.bloodOxygen?.score || 0}åˆ†`, max: 100 },
                                        { name: `ä½“æ¸© ${factors.temperature?.score || 0}åˆ†`, max: 100 },
                                        { name: `æ­¥æ•° ${factors.step?.score || 0}åˆ†`, max: 100 },
                                        { name: `å¡è·¯é‡Œ ${factors.calorie?.score || 0}åˆ†`, max: 100 },
                                        { name: `æ”¶ç¼©å‹ ${factors.pressureHigh?.score || 0}åˆ†`, max: 100 },
                                        { name: `èˆ’å¼ å‹ ${factors.pressureLow?.score || 0}åˆ†`, max: 100 },
                                        { name: `å‹åŠ› ${factors.stress?.score || 0}åˆ†`, max: 100 }
                                    ],
                                    name: {
                                        textStyle: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            padding: [3, 5]
                                        },
                                        rich: {
                                            value: {
                                                color: '#00e4ff',
                                                fontSize: 12,
                                                fontWeight: 'normal'
                                            }
                                        }
                                    },
                                    splitArea: {
                                        show: true,
                                        areaStyle: {
                                            color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.5)'
                                        }
                                    },
                                    splitLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.3)'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'å¥åº·æŒ‡æ ‡',
                                    type: 'radar',
                                    data: [{
                                        value: [
                                            factors.heartRate?.score || 0,
                                            factors.bloodOxygen?.score || 0,
                                            factors.temperature?.score || 0,
                                            factors.step?.score || 0,
                                            factors.calorie?.score || 0,
                                            factors.pressureHigh?.score || 0,
                                            factors.pressureLow?.score || 0,
                                            factors.stress?.score || 0
                                        ],
                                        name: 'å½“å‰çŠ¶æ€',
                                        itemStyle: {
                                            color: '#00e4ff'
                                        },
                                        areaStyle: {
                                            color: 'rgba(0,228,255,0.4)'
                                        }
                                    }]
                                }]
                            };
                            charts.healthScore.setOption(healthScoreOption);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0åˆ†
                            const totalScoreElement = document.querySelector('.total-score');
                            if (totalScoreElement) {
                                totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                            }
                            
                            const healthScoreOption = {
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: function(params) {
                                        return params[0].name + '<br/>' +
                                               params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                    }
                                },
                                radar: {
                                    radius: '65%',
                                    center: ['50%', '55%'],
                                    indicator: [
                                        { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                        { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                        { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                        { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                        { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                        { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                        { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                        { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                    ],
                                    name: {
                                        textStyle: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            padding: [3, 5]
                                        },
                                        rich: {
                                            value: {
                                                color: '#00e4ff',
                                                fontSize: 12,
                                                fontWeight: 'normal'
                                            }
                                        }
                                    },
                                    splitArea: {
                                        show: true,
                                        areaStyle: {
                                            color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.5)'
                                        }
                                    },
                                    splitLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.3)'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'å¥åº·æŒ‡æ ‡',
                                    type: 'radar',
                                    data: [{
                                        value: [0, 0, 0, 0, 0, 0, 0, 0],
                                        name: 'å½“å‰çŠ¶æ€',
                                        itemStyle: {
                                            color: '#00e4ff'
                                        },
                                        areaStyle: {
                                            color: 'rgba(0,228,255,0.4)'
                                        }
                                    }]
                                }]
                            };
                            charts.healthScore.setOption(healthScoreOption);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching health data:', error);
                        // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤º0åˆ†
                        const totalScoreElement = document.querySelector('.total-score');
                        if (totalScoreElement) {
                            totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                        }
                        // è®¾ç½®é»˜è®¤çš„0åˆ†å›¾è¡¨
                        const healthScoreOption = {
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    return params[0].name + '<br/>' +
                                           params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                }
                            },
                            radar: {
                                radius: '65%',
                                center: ['50%', '55%'],
                                indicator: [
                                    { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                    { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                    { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                    { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                    { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                    { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                    { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                    { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                ],
                                name: {
                                    textStyle: {
                                        color: '#00e4ff',
                                        fontSize: 12,
                                        padding: [3, 5]
                                    },
                                    rich: {
                                        value: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            fontWeight: 'normal'
                                        }
                                    }
                                },
                                splitArea: {
                                    show: true,
                                    areaStyle: {
                                        color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                    }
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: 'rgba(0,228,255,0.5)'
                                    }
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: 'rgba(0,228,255,0.3)'
                                    }
                                }
                            },
                            series: [{
                                name: 'å¥åº·æŒ‡æ ‡',
                                type: 'radar',
                                data: [{
                                    value: [0, 0, 0, 0, 0, 0, 0, 0],
                                    name: 'å½“å‰çŠ¶æ€',
                                    itemStyle: {
                                        color: '#00e4ff'
                                    },
                                    areaStyle: {
                                        color: 'rgba(0,228,255,0.4)'
                                    }
                                }]
                            }]
                        };
                        charts.healthScore.setOption(healthScoreOption);
                    });
            }

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡å›¾è¡¨
            const statsContainer = document.getElementById('statsChart');
            if (statsContainer) {
                charts.stats = echarts.init(statsContainer);
                const statsOption = {
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        orient: 'vertical',
                        right: 10,
                        top: 'center',
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    series: [{
                        name: 'è®¾å¤‡çŠ¶æ€',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['40%', '50%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        label: {
                            show: true,
                            color: '#fff'
                        },
                        data: [
                            { value: 35, name: 'åœ¨çº¿' },
                            { value: 10, name: 'ç¦»çº¿' },
                            { value: 15, name: 'å……ç”µä¸­' },
                            { value: 20, name: 'ä½©æˆ´ä¸­' }
                        ],
                        color: ['#00e4ff', '#ff4444', '#ffbb00', '#00ff9d']
                    }]
                };
                charts.stats.setOption(statsOption);
            }

           

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–è¶‹åŠ¿åˆ†æå›¾è¡¨
            

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–é¢„è­¦ä¿¡æ¯å›¾è¡¨
            const alertContainer = document.getElementById('alertList');
            if (alertContainer) {
                charts.alert = echarts.init(alertContainer);
                const alertOption = {
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(0,21,41,0.9)',
                        borderColor: 'rgba(0,228,255,0.2)',
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        show: false
                    },
                    yAxis: {
                        type: 'category',
                        data: ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'æ­¥æ•°', 'å¡è·¯é‡Œ', 'è·ç¦»'],
                        axisLabel: {
                            color: '#fff',
                            fontSize: 12
                        },
                        axisLine: {
                            show: false
                        },
                        axisTick: {
                            show: false
                        }
                    },
                    series: [{
                        type: 'bar',
                        data: [
                            {value: 8.02, itemStyle: {color: '#00e4ff'}},
                            {value: 8.09, itemStyle: {color: '#00e4ff'}},
                            {value: 2.87, itemStyle: {color: '#3498db'}},
                            {value: 0.85, itemStyle: {color: '#f39c12'}},
                            {value: 80.44, itemStyle: {color: '#00e4ff'}},
                            {value: 2.56, itemStyle: {color: '#e74c3c'}}
                        ],
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'right',
                            color: '#fff',
                            formatter: '{c}%'
                        }
                    }]
                };
                charts.alert.setOption(alertOption);
            }

            // æ·»åŠ çª—å£resizeäº‹ä»¶ç›‘å¬
            window.addEventListener('resize', () => {
                Object.values(charts).forEach(chart => {
                    if (chart) {
                        chart.resize();
                    }
                });
            });

            // åˆå§‹åŒ–æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
            const messageStatsContainer = document.getElementById('messageStatsChart');
            if (messageStatsContainer) {
                charts.messageStats = echarts.init(messageStatsContainer);
                
                // æ¶ˆæ¯ç±»å‹é¢œè‰²å®šä¹‰ï¼ˆä¸message_view.htmlä¿æŒä¸€è‡´ï¼‰
                const messageTypeColors = {
                    'announcement': '#1890ff',  // è“è‰² - å…¬å‘Š
                    'notification': '#52c41a',  // ç»¿è‰² - é€šçŸ¥
                    'job': '#722ed1',          // ç´«è‰² - ä½œä¸šæŒ‡å¯¼
                    'task': '#fa8c16',         // æ©™è‰² - ä»»åŠ¡ç®¡ç†
                    'warning': '#f5222d'       // çº¢è‰² - å‘Šè­¦
                };
                
                // åˆå§‹åŒ–æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
                const messageStatsOption = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        show: false
                    },
                    series: [{
                        name: 'æ¶ˆæ¯ç±»å‹',
                        type: 'pie',
                        radius: ['30%', '70%'],
                        center: ['50%', '60%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: false
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '10',
                                fontWeight: 'bold',
                                color: '#fff'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            {value: 0, name: 'å…¬å‘Š', itemStyle: {color: messageTypeColors.announcement}},
                            {value: 0, name: 'å·¥ä½œæŒ‡å¼•', itemStyle: {color: messageTypeColors.job}},
                            {value: 0, name: 'é€šçŸ¥', itemStyle: {color: messageTypeColors.notification}},
                            {value: 0, name: 'ä»»åŠ¡ç®¡ç†', itemStyle: {color: messageTypeColors.task}},
                            {value: 0, name: 'å‘Šè­¦', itemStyle: {color: messageTypeColors.warning}}
                        ]
                    }]
                };
                charts.messageStats.setOption(messageStatsOption);
            }

            // è¿”å›å›¾è¡¨å®ä¾‹å¯¹è±¡ï¼Œä»¥ä¾¿å…¶ä»–åœ°æ–¹å¯èƒ½éœ€è¦ä½¿ç”¨
            return charts;

        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // ä¿®æ”¹åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            globalCharts = initCharts(); // å­˜å‚¨å›¾è¡¨å®ä¾‹
            refreshData(); // åˆå§‹åŠ è½½æ•°æ®

            // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(refreshData, 60000);
        }, 100);
    });

    // ä¿®æ”¹æ¶ˆæ¯åˆ—è¡¨åˆå§‹åŒ–
    function initMessageList(data) {
        const messageList = document.getElementById('messageList');
        const messageCount = document.getElementById('messageCount');
        
        if (!messageList || !messageCount) return;
    
        // æ¶ˆæ¯ç±»å‹é¢œè‰²å®šä¹‰ï¼ˆå‚è€ƒmessage_view.htmlï¼‰
        const messageTypeColors = {
            'announcement': '#1890ff',  // è“è‰² - å…¬å‘Š
            'notification': '#52c41a',  // ç»¿è‰² - é€šçŸ¥
            'job': '#722ed1',          // ç´«è‰² - ä½œä¸šæŒ‡å¯¼
            'task': '#fa8c16',         // æ©™è‰² - ä»»åŠ¡ç®¡ç†
            'warning': '#f5222d'       // çº¢è‰² - å‘Šè­¦
        };

        const typeMap = {
            'announcement': 'å…¬å‘Š',
            'job': 'å·¥ä½œæŒ‡å¼•',
            'notification': 'é€šçŸ¥',
            'task': 'ä»»åŠ¡ç®¡ç†',
            'warning': 'å‘Šè­¦'
        };
    
        // ä»message_infoä¸­è·å–æ•°æ®
        //console.log('initMessageList.data', data);
        const messages = data.message_info.messages || [];
        // è¿‡æ»¤å‡ºçŠ¶æ€ä¸ºpendingçš„æ¶ˆæ¯
        const pendingMessages = messages.filter(msg => msg.message_status === 'pending' || msg.message_status === '1');
        
        // æ›´æ–°æ¶ˆæ¯è®¡æ•°
        messageCount.textContent = pendingMessages.length;

        // ç»Ÿè®¡æ¶ˆæ¯æ•°æ®
        const today = new Date().toDateString();
        const todayMessages = messages.filter(msg => new Date(msg.received_time).toDateString() === today).length;
        const unreadMessages = messages.filter(msg => msg.message_status === 'pending' || msg.message_status === '1').length;
        const urgentMessages = messages.filter(msg => msg.priority === 'high' || msg.priority === 'urgent').length;

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        document.getElementById('todayMessages').textContent = todayMessages;
        document.getElementById('unreadMessages').textContent = unreadMessages;
        document.getElementById('urgentMessages').textContent = urgentMessages;

        // ç»Ÿè®¡æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ - ä½¿ç”¨æ­£ç¡®çš„ç±»å‹æ˜ å°„
        const messageTypes = {
            'å…¬å‘Š': 0,
            'å·¥ä½œæŒ‡å¼•': 0,
            'é€šçŸ¥': 0,
            'ä»»åŠ¡ç®¡ç†': 0,
            'å‘Šè­¦': 0
        };

        messages.forEach(msg => {
            const type = msg.message_type || 'notification';
            const typeName = typeMap[type] || 'é€šçŸ¥';
            if (messageTypes.hasOwnProperty(typeName)) {
                messageTypes[typeName]++;
            }
        });

        // æ›´æ–°æ¶ˆæ¯ç»Ÿè®¡å›¾è¡¨
        if (globalCharts && globalCharts.messageStats) {
            const chartData = [
                {value: messageTypes['å…¬å‘Š'], name: 'å…¬å‘Š', itemStyle: {color: messageTypeColors.announcement}},
                {value: messageTypes['å·¥ä½œæŒ‡å¼•'], name: 'å·¥ä½œæŒ‡å¼•', itemStyle: {color: messageTypeColors.job}},
                {value: messageTypes['é€šçŸ¥'], name: 'é€šçŸ¥', itemStyle: {color: messageTypeColors.notification}},
                {value: messageTypes['ä»»åŠ¡ç®¡ç†'], name: 'ä»»åŠ¡ç®¡ç†', itemStyle: {color: messageTypeColors.task}},
                {value: messageTypes['å‘Šè­¦'], name: 'å‘Šè­¦', itemStyle: {color: messageTypeColors.warning}}
            ];
            
            globalCharts.messageStats.setOption({
                series: [{
                    data: chartData
                }]
            });
        }
    
        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
        messageList.innerHTML = '';
    
        // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
    
        // æ·»åŠ æ‰€æœ‰æ¶ˆæ¯
        pendingMessages.forEach(message => {
            const msgType = message.message_type || 'notification';
            const msgColor = messageTypeColors[msgType] || messageTypeColors.notification;
            const msgTypeName = typeMap[msgType] || 'é€šçŸ¥';
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            messageElement.innerHTML = `
                <div class="message-header">
                    <span style="color: ${msgColor}; font-weight: bold;">[${msgTypeName}] ${message.department_name || 'æœªçŸ¥éƒ¨é—¨'}-${message.user_name || 'ç³»ç»Ÿ'}</span>
                    <span class="message-time">${message.received_time || new Date().toLocaleString()}</span>
                </div>
                <div class="message-content" style="border-left: 3px solid ${msgColor}; padding-left: 6px;">${message.message || 'æ— æ¶ˆæ¯å†…å®¹'}</div>
            `;
            messageContainer.appendChild(messageElement);
        });
    
        // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        if (pendingMessages.length === 0) {
            messageList.innerHTML = '<div class="no-messages">æš‚æ— å¾…å¤„ç†æ¶ˆæ¯</div>';
            return;
        }
    
        // å°†æ¶ˆæ¯å®¹å™¨æ·»åŠ åˆ°åˆ—è¡¨ä¸­
        messageList.appendChild(messageContainer);
    
        // æ·»åŠ æ ·å¼ - ç§»é™¤é‡å¤æ ·å¼é˜²æ­¢å†²çª
        const existingStyle = document.getElementById('message-scroll-styles');
        if (existingStyle) {
            existingStyle.remove();
        }
        
        const style = document.createElement('style');
        style.id = 'message-scroll-styles';
        style.textContent = `
            #messageList {
                height: calc(100% - 5px);
                overflow: hidden;
                position: relative;
                background: linear-gradient(135deg, rgba(0, 42, 74, 0.8), rgba(0, 74, 114, 0.6));
                border-radius: 8px;
                border: 1px solid rgba(0, 228, 255, 0.25);
                box-shadow: inset 0 1px 3px rgba(0, 228, 255, 0.1);
            }
    
            .message-container {
                display: flex;
                flex-direction: column;
                width: 100%;
                padding: 8px;
            }
    
            .message-item {
                background: linear-gradient(135deg, rgba(0, 62, 94, 0.8), rgba(0, 94, 134, 0.6));
                border: 1px solid rgba(0, 228, 255, 0.2);
                border-radius: 6px;
                padding: 8px 12px;
                margin-bottom: 6px;
                position: relative;
                transition: all 0.3s ease;
                backdrop-filter: blur(10px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 15px rgba(0, 228, 255, 0.05);
            }
    
            .message-item::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                border-radius: 2px 0 0 2px;
                transition: all 0.3s ease;
            }
    
            .message-item.type-announcement::before { background: linear-gradient(135deg, #4A90E2, #357ABD); }
            .message-item.type-notification::before { background: linear-gradient(135deg, #7ED321, #5BA317); }
            .message-item.type-job::before { background: linear-gradient(135deg, #9013FE, #6A1B9A); }
            .message-item.type-task::before { background: linear-gradient(135deg, #FF9500, #E6830F); }
            .message-item.type-warning::before { background: linear-gradient(135deg, #F5A623, #E8940F); }
    
            .message-item:hover {
                transform: translateX(2px);
                border-color: rgba(64, 169, 255, 0.4);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 20px rgba(64, 169, 255, 0.1);
            }
    
            .message-item:last-child {
                margin-bottom: 0;
            }
    
            .message-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
            }
    
            .message-type-badge {
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                letter-spacing: 0.5px;
                text-transform: uppercase;
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
    
            .message-type-badge.announcement {
                background: linear-gradient(135deg, rgba(74, 144, 226, 0.2), rgba(53, 122, 189, 0.3));
                color: #87CEEB;
                border-color: rgba(74, 144, 226, 0.3);
            }
    
            .message-type-badge.notification {
                background: linear-gradient(135deg, rgba(126, 211, 33, 0.2), rgba(91, 163, 23, 0.3));
                color: #98FB98;
                border-color: rgba(126, 211, 33, 0.3);
            }
    
            .message-type-badge.job {
                background: linear-gradient(135deg, rgba(144, 19, 254, 0.2), rgba(106, 27, 154, 0.3));
                color: #DDA0DD;
                border-color: rgba(144, 19, 254, 0.3);
            }
    
            .message-type-badge.task {
                background: linear-gradient(135deg, rgba(255, 149, 0, 0.2), rgba(230, 131, 15, 0.3));
                color: #FFB84D;
                border-color: rgba(255, 149, 0, 0.3);
            }
    
            .message-type-badge.warning {
                background: linear-gradient(135deg, rgba(245, 166, 35, 0.2), rgba(232, 148, 15, 0.3));
                color: #FFC04D;
                border-color: rgba(245, 166, 35, 0.3);
            }
    
            .message-sender {
                color: rgba(255, 255, 255, 0.9);
                font-size: 11px;
                font-weight: 500;
                margin-left: 8px;
            }
    
            .message-time {
                color: rgba(64, 169, 255, 0.8);
                font-size: 9px;
                font-weight: 400;
                font-family: 'Consolas', 'Monaco', monospace;
                background: rgba(64, 169, 255, 0.1);
                padding: 2px 6px;
                border-radius: 4px;
                border: 1px solid rgba(64, 169, 255, 0.2);
            }
    
            .message-content {
                color: rgba(255, 255, 255, 0.95);
                font-size: 12px;
                line-height: 1.4;
                font-weight: 400;
                margin-top: 2px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                max-height: 32px;
            }
    
            .no-messages {
                text-align: center;
                padding: 30px 20px;
                color: rgba(255, 255, 255, 0.4);
                font-size: 14px;
                background: linear-gradient(135deg, rgba(20, 45, 85, 0.3), rgba(30, 55, 95, 0.2));
                border-radius: 8px;
                border: 1px dashed rgba(64, 169, 255, 0.3);
                margin: 20px;
            }
    
            /* æ»šåŠ¨åŠ¨ç”» */
            .message-container.scrolling {
                animation: verticalScroll linear infinite;
            }
    
            @keyframes verticalScroll {
                0% {
                    transform: translateY(0);
                }
                100% {
                    transform: translateY(-50%);
                }
            }
    
            /* æ·»åŠ å‘¼å¸å…‰æ•ˆ */
            .message-item::after {
                content: '';
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                bottom: -1px;
                background: linear-gradient(45deg, transparent, rgba(64, 169, 255, 0.1), transparent);
                border-radius: 6px;
                opacity: 0;
                animation: breathe 3s ease-in-out infinite;
                pointer-events: none;
                z-index: -1;
            }
    
            @keyframes breathe {
                0%, 100% { opacity: 0; }
                50% { opacity: 0.3; }
            }
        `;
        document.head.appendChild(style);
    
        // å®ç°æ»šåŠ¨é€»è¾‘
        setTimeout(() => {
            const containerHeight = messageList.clientHeight;
            const contentHeight = messageContainer.scrollHeight;
            
            console.log('Container height:', containerHeight, 'Content height:', contentHeight);
            
            if (contentHeight > containerHeight && pendingMessages.length > 3) {
                // å¤åˆ¶å†…å®¹å®ç°æ— ç¼æ»šåŠ¨
                messageContainer.innerHTML += messageContainer.innerHTML;
                
                // è®¡ç®—æ»šåŠ¨æ—¶é—´ï¼šæ¯ä¸ªæ¶ˆæ¯æ˜¾ç¤º3ç§’
                const scrollDuration = pendingMessages.length * 3;
                
                // æ·»åŠ æ»šåŠ¨ç±»å’Œè®¾ç½®åŠ¨ç”»æ—¶é—´
                messageContainer.classList.add('scrolling');
                messageContainer.style.animationDuration = `${scrollDuration}s`;
                
                console.log('å¯åŠ¨æ»šåŠ¨åŠ¨ç”»ï¼ŒæŒç»­æ—¶é—´:', scrollDuration + 's');
                
                // é¼ æ ‡æ‚¬åœæ§åˆ¶
                messageList.addEventListener('mouseenter', () => {
                    messageContainer.style.animationPlayState = 'paused';
                });
                
                messageList.addEventListener('mouseleave', () => {
                    messageContainer.style.animationPlayState = 'running';
                });
            } else {
                console.log('æ¶ˆæ¯æ•°é‡å°‘ï¼Œä¸å¯åŠ¨æ»šåŠ¨');
            }
            
            // æ·»åŠ æ¶ˆæ¯ç‚¹å‡»äº‹ä»¶
            addMessageClickEvents();
        }, 500); // å»¶è¿Ÿ500msç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
    }

    // æ·»åŠ æ¶ˆæ¯é¢æ¿ç‚¹å‡»å¤„ç†å‡½æ•°
    function openMessagePanel() {
        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('customerId') || '1';
        createModalWindow('/message_view?customerId=' + customerId, 'æ¶ˆæ¯ç®¡ç†', '90%', '90%');
    }

    // æ·»åŠ æ¶ˆæ¯é¡¹ç‚¹å‡»äº‹ä»¶
    function addMessageClickEvents() {
        const messageItems = document.querySelectorAll('.message-item');
        messageItems.forEach(item => {
            item.addEventListener('click', openMessagePanel);
            item.style.cursor = 'pointer';
        });
    }
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=7de0c6b90cb13571ce931ca75a66c6e7"></script> 
    <script src="https://webapi.amap.com/loca?v=2.0.0&key=7de0c6b90cb13571ce931ca75a66c6e7"></script>
    <script src="/static/js/map-optimizer.js"></script> <!-- åœ°å›¾ä¼˜åŒ–æ¨¡å— -->
    <script>
      // Declare infoWindow globally
      // let infoWindow; // ç§»é™¤
      let geoLevelF,geoLevelE,geo,map,loca,breathGreen,breathRed,breathYellow;//å˜é‡åˆå¹¶

      async function getFirstCoordinates(map, deptId, userId) {
        try {
          console.log('getFirstCoordinates.deptId',deptId);
          console.log('getFirstCoordinates.userId',userId);
          const response = await fetch(`./generateAlertJson?customerId=${deptId}&userId=${userId}`);
          console.log('getFirstCoordinates.response',response);
          const result = await response.json();
          if (result.features && result.features.length > 0) {
            const coordinates = result.features[0].geometry.coordinates;
            map.setCenter(coordinates);
            console.log('getFirstCoordinates.coordinates',coordinates);
            return coordinates;
          } else {
            const response1 = await fetch(`./generateHealthJson?customerId=${deptId}&userId=${userId}`);
            const result1 = await response1.json();
            if (result1.features && result1.features.length > 0) {
              const coordinates = result1.features[0].geometry.coordinates;
              map.setCenter(coordinates);
              console.log('getFirstCoordinates.coordinates',coordinates);
              return coordinates;
            } else {
              return [114.01508952, 22.54036796, 0];
            }
          }
        } catch (error) {
            console.error('Error accessing coordinates:', error);
            return [114.01508952, 22.54036796, 0]; // é»˜è®¤åæ ‡
        }
      }

      async function updateGeoJSONSources(deptId, userId) {
        try {
            console.log('Updating GeoJSON sources...', { deptId, userId });
    
            // æ„å»ºURLå‚æ•°
            const params = new URLSearchParams({
                customerId: deptId || '1',
                userId: userId || '-1'
            }).toString();
    
            // è·å–æ•°æ®
            console.log('updateGeoJSONSources.params',`./generateHealthJson?${params}`);
            const [criticalData, highData, healthData] = await Promise.all([
                fetch(`./generateAlertJson?${params}&severityLevel=critical`).then(res => res.json()),
                fetch(`./generateAlertJson?${params}&severityLevel=high`).then(res => res.json()),
                fetch(`./generateHealthJson?${params}`).then(res => res.json())
            ]);
    
            // åˆ›å»ºæ–°çš„æ•°æ®æº
            const newGeoLevelF = new Loca.GeoJSONSource({
                data: criticalData
            });
    
            const newGeoLevelE = new Loca.GeoJSONSource({
                data: highData
            });
    
            const newGeo = new Loca.GeoJSONSource({
                data: healthData
            });
    
            // æ›´æ–°å›¾å±‚æ•°æ®æº
            breathRed.setSource(newGeoLevelF);
            breathYellow.setSource(newGeoLevelE);
            breathGreen.setSource(newGeo);
    
            // æ›´æ–°åœ°å›¾ä¸­å¿ƒç‚¹
            if (healthData.features && healthData.features.length > 0) {
                const coordinates = healthData.features[0].geometry.coordinates;
                console.log('updateGeoJSONSources.coordinates',coordinates);
                map.setCenter(coordinates);
            }
    
            // é‡æ–°å¯åŠ¨åŠ¨ç”»
            loca.animate.start();
    
            console.log('GeoJSON sources updated successfully');
    
        } catch (error) {
            console.error('Error updating GeoJSON sources:', error);
        }
    }


      function initializeMap(deptId, userId) {
        //console.log(AMap); // å¦‚æœæ‰“å° `undefined`ï¼Œè¯´æ˜ AMap æ²¡æœ‰æ­£ç¡®åŠ è½½
        //console.log(Loca); // å¦‚æœæ‰“å° `undefined`ï¼Œè¯´æ˜ Loca æ²¡æœ‰æ­£ç¡®åŠ è½½
        //console.log('initializeMap.deptId',deptId);
        //console.log('initializeMap.userId',userId);
        //console.log('initializeMap.severityLevel',`./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=critical`);

        geoLevelF = new Loca.GeoJSONSource({
          url: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=critical`
        });
    
    
        // é»„è‰²å‘Šè­¦ç‚¹
        geoLevelE = new Loca.GeoJSONSource({
            url: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=high`
        });

        // ç»¿è‰²å¥åº·ç‚¹
        geo = new Loca.GeoJSONSource({
            url: `./generateHealthJson?customerId=${deptId}&userId=${userId}`
        });

        console.log('geo',geo);
      
      
        let current_coordinates = {
          
          'longitude': 114.01508952,
          'latitude': 22.58036796,
          'altitude': 0
        }
    
        //console.log('current_coordinates',current_coordinates);
  
          map = window.map = new AMap.Map('map-container', {
              zoom: 17,
              center: [current_coordinates['longitude'],current_coordinates['latitude']],
              pitch: 45,
              showLabel: false,
              mapStyle: 'amap://styles/blue',
              viewMode: '3D',
          });

        //const api_coordinates = getFirstCoordinates(map,deptId,userId);
          

          loca = new Loca.Container({
            map,
          });
        
          breathGreen = new Loca.ScatterLayer({
            loca,
            zIndex: 113,
            opacity: 1,
            visible: true,
            zooms: [2, 22],
          });
  
        breathGreen.setSource(geo);
        //console.log("BreathGreen GeoJSON data:", breathGreen);
        breathGreen.setStyle({
            unit: 'meter',
            color: 'rgb(39, 207, 14)',
            size: [10, 10],
            borderWidth: 0,
            exture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_green.png',
            //texture: 'http://localhost:5001/static/images/avarta.png',
            duration: 500,
            animate: true,
        });
        
        // æ·»åŠ åˆ°åœ°å›¾ä¸­
        loca.add(breathGreen);
      
        // åˆ›å»ºçº¢è‰²å‘¼å¸ç‚¹å›¾å±‚
        breathRed = new Loca.ScatterLayer({
            loca,
            zIndex: 113,
            opacity: 1,
            visible: true,
            zooms: [2, 22],
        });
        //console.log('Health data:',geoLevelF);
        
        breathRed.setSource(geoLevelF);
        //console.log("BreathRed GeoJSON data:", breathRed);
        breathRed.setStyle({
            unit: 'meter',
            size: [60, 60],
            borderWidth: 0,
            texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_red.png',
            duration: 500,
            animate: true,
        });
        
        // æ·»åŠ åˆ°åœ°å›¾ä¸­
        loca.add(breathRed);
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¼¹å‡ºä¿¡æ¯æ¡†
        map.on('click',e=>{const p=e.pixel.toArray();let f=breathRed.queryFeature(p)||breathYellow.queryFeature(p)||breathGreen.queryFeature(p);if(f&&f.coordinates){showCustomMapInfo(f)}else{removeCustomMapInfo()}});//ä¼˜å…ˆçº§ä¿®æ­£
         
         
          
          breathYellow = new Loca.ScatterLayer({
              loca,
              zIndex: 112,
              opacity: 1,
              visible: true,
              zooms: [2, 22],
          });
          breathYellow.setSource(geoLevelE);
          //console.log("BreathYellow GeoJSON data:", breathYellow);
          breathYellow.setStyle({
              unit: 'meter',
              size: [50, 50],
              borderWidth: 0,
              texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_yellow.png',
              duration: 1000,
              animate: true,
          });
          loca.add(breathYellow);
      
          
          

          
          //console.log("GeoJSON data for BreathRed:", geoLevelF);
     
          //console.log("Map center:", map.getCenter());
      
      
          // å¯åŠ¨æ¸²æŸ“åŠ¨ç”»
          loca.animate.start();
      
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºä¿¡æ¯æ¡†
          // var infoWindow = new AMap.InfoWindow({
          //     offset: new AMap.Pixel(0, -30),
          // });
      
      
      
          // var dat = new Loca.Dat();
          // dat.addLayer(breathGreen, 'ç»¿è‰²');
          // dat.addLayer(breathRed, 'çº¢è‰²');
          // dat.addLayer(breathYellow, 'é»„è‰²');

  
    // Function to fetch weather data
  
  
   
  
  }
  
  initializeMap('{{ customerId }}','-1');


  
  async function reverseGeocode(lng, lat) {
    try {
        const response = await fetch(`https://restapi.amap.com/v3/geocode/regeo?key=d45f28e481665db5b1145a5aa989e68a&location=${lng},${lat}`);
        const data = await response.json();
        
        if (data.status === '1') {
            const address = data.regeocode.formatted_address;
            console.log('Address:', address);
            return address;
        } else {
            console.error('Failed to reverse geocode:', data.info);
            return null;
        }
    } catch (error) {
        console.error('Error during reverse geocoding:', error);
        return null;
    }
  }


  function handleAlert(alertId) {
    fetch(`./dealAlert?alertId=${alertId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Alert processed:', data);
                showCustomAlert(data.message, () => {
                    location.reload();
                });
            } else {
                console.error('Failed to process alert:', data.message);
                showCustomAlert('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', null);
            }
        })
        .catch(error => {
            console.error('Error processing alert:', error);
            showCustomAlert('å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', null);
        });
}

// æ·»åŠ è‡ªå®šä¹‰å¼¹å‡ºæ¡†å‡½æ•°
function showCustomAlert(message, callback) {
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.className = 'custom-alert-overlay';
    document.body.appendChild(overlay);

    // åˆ›å»ºå¼¹å‡ºæ¡†
    const alertBox = document.createElement('div');
    alertBox.className = 'custom-alert';
    alertBox.innerHTML = `
        <div class="custom-alert-content">${message}</div>
        <button class="custom-alert-button">ç¡®å®š</button>
    `;
    document.body.appendChild(alertBox);

    // æ·»åŠ ç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const confirmButton = alertBox.querySelector('.custom-alert-button');
    confirmButton.onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(alertBox);
        if (callback) callback();
    };
}

  
  function mapAlertStatus(alertStatus) {
    switch (alertStatus) {
        case 'responded':
            return 'å·²å¤„ç†';
        case 'pending':
            return 'æœªå¤„ç†';
        case 'closed':
            return 'å·²å…³é—­';
        default:
            return 'æœªçŸ¥';
    }
}

// æ·»åŠ åœ¨å…¶ä»– JavaScript ä»£ç ä¹‹å‰
function toggleFilter() {
    const filterPanel = document.querySelector('.filter-panel');
    const filterContainer = document.querySelector('.filter-container');
    const toggleButton = document.querySelector('.filter-toggle i');

    console.log('toggleFilter', toggleButton);
    
    if (filterPanel.classList.contains('collapsed')) {
        // å±•å¼€é¢æ¿
        filterPanel.classList.remove('collapsed');
        toggleButton.classList.remove('fa-search');
        toggleButton.classList.add('fa-times');
        filterContainer.style.display = 'flex';
    } else {
        // æ”¶èµ·é¢æ¿
        filterPanel.classList.add('collapsed');
        toggleButton.classList.remove('fa-times');
        toggleButton.classList.add('fa-search');
        filterContainer.style.display = 'none';
    }
}

// æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­ç­›é€‰é¢æ¿çš„åŠŸèƒ½
document.addEventListener('click', function(event) {
    const filterPanel = document.querySelector('.filter-panel');
    const filterToggle = document.querySelector('.filter-toggle');
    
    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç­›é€‰é¢æ¿å†…çš„å…ƒç´ ä¸”é¢æ¿æ˜¯å±•å¼€çš„
    if (!filterPanel.contains(event.target) && 
        !filterToggle.contains(event.target) && 
        !filterPanel.classList.contains('collapsed')) {
        toggleFilter();
    }
});

// é˜»æ­¢ç­›é€‰é¢æ¿å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
document.querySelector('.filter-panel').addEventListener('click', function(event) {
    event.stopPropagation();
});

// åˆå§‹åŒ–äººå‘˜ç®¡ç†é¢æ¿
function initPersonnelManagementPanel(data) {
    // æ›´æ–°æ€»è§ˆæ•°æ®
    document.getElementById('totalUsers').innerText = data.user_info.totalUsers;
    document.getElementById('totalBindDevices').innerText = data.user_info.totalDevices;

    // åˆå§‹åŒ–éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨
    initDepartmentDistribution(data);
}

// ä¿®æ”¹åˆå§‹åŒ–éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨å‡½æ•° - ä¸“ä¸šç‰ˆ
function initDepartmentDistribution(data) {
    console.log('initDepartmentDistribution å¼€å§‹æ‰§è¡Œï¼Œæ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
    
    const userInfo = data.user_info || {};
    
    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡æ•°æ®
    const totalUsers = userInfo.totalUsers || 0;
    const totalDevices = userInfo.totalDevices || 0;
    const departmentCount = userInfo.departmentCount || {};
    const activeDeptCount = Object.keys(departmentCount).length;
    
    // æ¨¡æ‹Ÿåœ¨çº¿ç”¨æˆ·æ•°æ®ï¼ˆå®é™…åº”ä»åç«¯è·å–ï¼‰
    const onlineUsers = Math.floor(totalUsers * 0.75); // å‡è®¾75%åœ¨çº¿
    const onlineRate = totalUsers > 0 ? ((onlineUsers / totalUsers) * 100).toFixed(1) : 0;
    const alertUsers = Math.floor(totalUsers * 0.1); // å‡è®¾10%æœ‰å‘Šè­¦
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('totalBindDevices').textContent = totalDevices;
    document.getElementById('onlineRate').textContent = onlineRate + '%';
    document.getElementById('activeDeptCount').textContent = activeDeptCount;
    document.getElementById('onlineUsers').textContent = onlineUsers;
    document.getElementById('boundDevices').textContent = totalDevices;
    document.getElementById('alertUsers').textContent = alertUsers;

    // 1. éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨ - ç¯å½¢å›¾
    const departmentChart = echarts.init(document.getElementById('departmentDistribution'));
    
    // å¤„ç†éƒ¨é—¨æ•°æ®
    const departmentData = Object.entries(departmentCount)
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value);

    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
    const hasDeptData = departmentData.length > 0 && departmentData.some(d => d.value > 0);
    const displayDeptData = hasDeptData ? departmentData : [
        { name: 'æš‚æ— éƒ¨é—¨', value: 1 }
    ];

    const deptColors = ['#00e4ff', '#00a8ff', '#0080ff', '#48cae4', '#90e0ef', '#a8dadc', '#457b9d'];

    const departmentOption = {
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            borderWidth: 1,
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                if (!hasDeptData) return 'æš‚æ— æ•°æ®';
                return `${params.name}<br/>äººæ•°: ${params.value}äºº<br/>å æ¯”: ${params.percent}%`;
            }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '75%'],
            center: ['50%', '60%'],
            avoidLabelOverlap: true,
            itemStyle: {
                borderColor: 'rgba(0,21,41,0.8)',
                borderWidth: 2,
                shadowBlur: 8,
                shadowColor: 'rgba(0,228,255,0.3)'
            },
            label: {
                show: true,
                position: 'outside',
                color: '#fff',
                fontSize: 9,
                formatter: function(params) {
                    if (!hasDeptData) return '';
                    return params.value > 0 ? `${params.name}\n${params.value}äºº` : '';
                },
                lineHeight: 10
            },
            labelLine: {
                show: true,
                length: 6,
                length2: 4,
                lineStyle: { color: 'rgba(255,255,255,0.5)', width: 1 }
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 15,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0,228,255,0.6)',
                    scale: 1.05
                }
            },
            data: displayDeptData.map((item, index) => ({
                ...item,
                itemStyle: { color: deptColors[index % deptColors.length] }
            }))
        }]
    };
    departmentChart.setOption(departmentOption);
    
    // 2. ç”¨æˆ·çŠ¶æ€å›¾è¡¨ - æŸ±çŠ¶å›¾
    const statusChart = echarts.init(document.getElementById('userStatusChart'));

    // æ¨¡æ‹ŸçŠ¶æ€æ•°æ®
    const statusData = {
        online: onlineUsers,
        offline: totalUsers - onlineUsers,
        bound: totalDevices,
        unbound: totalUsers - totalDevices,
        alert: alertUsers,
        normal: totalUsers - alertUsers
    };

    const statusOption = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                if (!params || !params[0]) return '';
                const data = params[0];
                return `${data.name}: ${data.value}äºº`;
            }
        },
        grid: {
            top: 25,
            left: 25,
            right: 15,
            bottom: 20,
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: ['åœ¨çº¿', 'ç¦»çº¿', 'ç»‘å®š', 'æœªç»‘å®š', 'å‘Šè­¦', 'æ­£å¸¸'],
            axisLabel: { 
                color: '#7ecfff', 
                fontSize: 9,
                interval: 0,
                rotate: 0
            },
            axisLine: { lineStyle: { color: 'rgba(126,207,255,0.3)' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            axisLabel: { color: '#7ecfff', fontSize: 9 },
            splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)', type: 'dashed' } },
            axisLine: { show: false }
        },
        series: [{
            type: 'bar',
            data: [
                { value: statusData.online, itemStyle: { color: '#00ff9d' } },
                { value: statusData.offline, itemStyle: { color: '#666' } },
                { value: statusData.bound, itemStyle: { color: '#ffbb00' } },
                { value: statusData.unbound, itemStyle: { color: '#ff8800' } },
                { value: statusData.alert, itemStyle: { color: '#ff4444' } },
                { value: statusData.normal, itemStyle: { color: '#00e4ff' } }
            ],
            barWidth: '60%',
            label: {
                show: true,
                position: 'top',
                color: '#fff',
                fontSize: 9,
                formatter: '{c}'
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowColor: 'rgba(0,228,255,0.5)'
                }
            }
        }]
    };
    statusChart.setOption(statusOption);

    // è‡ªé€‚åº”å¤§å°
    const resizeCharts = () => {
        try {
            departmentChart && departmentChart.resize();
            statusChart && statusChart.resize();
        } catch (e) {
            console.warn('äººå‘˜ç®¡ç†å›¾è¡¨resizeå¤±è´¥:', e);
        }
    };
    
    window.addEventListener('resize', resizeCharts);

    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
    setTimeout(() => {
        resizeCharts();
        console.log('äººå‘˜ç®¡ç†å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    }, 200);

    // å›¾è¡¨ç‚¹å‡»äº¤äº’
    departmentChart.on('click', function(params) {
        if (hasDeptData && params.data && params.data.value > 0) {
            showDepartmentDetails(params.data.name, params.data.value);
        }
    });

    statusChart.on('click', function(params) {
        const statusName = params.name;
        const statusValue = params.value;
        showStatusDetails(statusName, statusValue);
        });

    return { departmentChart, statusChart };
}

function getPastDateStr(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return d.toISOString().slice(0,10);
  }
  
  function loadBaselineTrendChart(orgId) {
    console.log('loadBaselineTrendChart å¼€å§‹æ‰§è¡Œï¼ŒorgId:', orgId);
    
    const endDate = getPastDateStr(0), startDate = getPastDateStr(6);
    
    fetch(`/health_data/chart/baseline?orgId=${orgId}&startDate=${startDate}&endDate=${endDate}`)
      .then(r=>r.json())
      .then(result=>{
        console.log('å¥åº·æ•°æ®æ¥å£è¿”å›:', result);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™ç”Ÿæˆbaseline
        if (!result || !result.dates || result.dates.length === 0) {
          console.warn('baselineæ•°æ®ç¼ºå¤±ï¼Œå¼€å§‹ç”Ÿæˆbaseline');
          return generateBaselineAndRetry(orgId, startDate, endDate);
        }
        
        renderHealthChart(result);
      })
      .catch(error => {
        console.error('å¥åº·æ•°æ®åŠ è½½å¤±è´¥:', error);
        // å°è¯•ç”Ÿæˆbaselineåé‡è¯•
        generateBaselineAndRetry(orgId, startDate, endDate);
      });
  }

  // ç”Ÿæˆbaselineå¹¶é‡è¯•è·å–æ•°æ®
  function generateBaselineAndRetry(orgId, startDate, endDate) {
    console.log('æ­£åœ¨ç”Ÿæˆbaselineæ•°æ®...');
    
    fetch('/api/baseline/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target_date: endDate })
    })
    .then(r => r.json())
    .then(generateResult => {
      console.log('baselineç”Ÿæˆç»“æœ:', generateResult);
      
      if (generateResult.success) {
        // ç”ŸæˆæˆåŠŸåé‡æ–°è·å–æ•°æ®
        return fetch(`/health_data/chart/baseline?orgId=${orgId}&startDate=${startDate}&endDate=${endDate}`);
      } else {
        throw new Error('baselineç”Ÿæˆå¤±è´¥: ' + generateResult.error);
      }
    })
    .then(r => r.json())
    .then(result => {
      console.log('é‡æ–°è·å–çš„å¥åº·æ•°æ®:', result);
      renderHealthChart(result);
    })
    .catch(error => {
      console.error('ç”Ÿæˆbaselineæˆ–é‡æ–°è·å–æ•°æ®å¤±è´¥:', error);
      showDefaultHealthData();
    });
  }

  // æ¸²æŸ“å¥åº·å›¾è¡¨
  function renderHealthChart(result) {
    const {dates, metrics, health_summary} = result;
    
    // æ›´æ–°å¥åº·ç»Ÿè®¡æ•°æ®
    if (health_summary) {
      document.getElementById('healthScore').textContent = health_summary.overall_score || 0;
      document.getElementById('normalCount').textContent = health_summary.normal_indicators || 0;
      document.getElementById('riskCount').textContent = health_summary.risk_indicators || 0;
    }
    
    // å¥åº·è¶‹åŠ¿å›¾
    const trendChart = echarts.init(document.getElementById('trendChart'));
    
    // æ ¸å¿ƒå¥åº·æŒ‡æ ‡
    const mainMetrics = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'å‹åŠ›', 'ç¡çœ '];
    const metricColors = {
      'å¿ƒç‡': '#ff6b6b',
      'è¡€æ°§': '#00ff9d', 
      'ä½“æ¸©': '#ffbb00',
      'å‹åŠ›': '#ff9500',
      'ç¡çœ ': '#7ecfff'
    };
    const series = [];
    
    if (metrics && metrics.length > 0) {
      mainMetrics.forEach(metricName => {
        const metric = metrics.find(m => m.name === metricName);
        if (metric && metric.values) {
          series.push({
            name: metric.name,
            type: 'line',
            data: metric.values,
            smooth: true,
            symbol: 'circle',
            symbolSize: 4,
            lineStyle: { 
              width: 2, 
              color: metricColors[metric.name] || '#00e4ff'
            },
            itemStyle: { 
              color: metricColors[metric.name] || '#00e4ff'
            }
          });
        }
      });
    }
    
    const trendOption = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(10,24,48,0.98)',
        borderColor: '#00e4ff',
        borderWidth: 1,
        textStyle: { color: '#fff', fontSize: 10 },
        formatter: function(params) {
          let result = params[0].axisValue + '<br/>';
          params.forEach(param => {
            const unit = getMetricUnit(param.seriesName);
            result += `${param.seriesName}: ${param.value}${unit}<br/>`;
          });
          return result;
        }
      },
      legend: {
        show: true,
        top: 5,
        textStyle: { color: '#fff', fontSize: 10 }
      },
      grid: { 
        top: 35, 
        left: 30, 
        right: 20, 
        bottom: 25, 
        containLabel: true 
      },
      xAxis: {
        type: 'category',
        data: dates,
        axisLabel: { 
          color: '#7ecfff', 
          fontSize: 9
        },
        axisLine: { lineStyle: { color: 'rgba(0,228,255,0.2)' } }
      },
      yAxis: {
        type: 'value',
        axisLabel: { 
          color: '#7ecfff', 
          fontSize: 10
        },
        splitLine: { 
          lineStyle: { 
            color: 'rgba(0,228,255,0.1)', 
            type: 'dashed' 
          } 
        }
      },
      series
    };
    
    trendChart.setOption(trendOption);
    
    // å›¾è¡¨ç‚¹å‡»äº‹ä»¶
    trendChart.on('click', function(params) {
      console.log('ç‚¹å‡»äº†å¥åº·è¶‹åŠ¿å›¾:', params);
    });
    
    // è‡ªé€‚åº”å¤§å°
    window.addEventListener('resize', () => {
      trendChart.resize();
    });
  }

  // è·å–æŒ‡æ ‡å•ä½
  function getMetricUnit(metricName) {
    const units = {
      'å¿ƒç‡': 'bpm',
      'è¡€æ°§': '%',
      'ä½“æ¸©': 'Â°C',
      'å‹åŠ›': '',
      'ç¡çœ ': 'h'
    };
    return units[metricName] || '';
  }

// æ˜¾ç¤ºé»˜è®¤å¥åº·æ•°æ® - å¢å¼ºç‰ˆ
function showDefaultHealthData() {
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    document.getElementById('healthScore').textContent = '85';
    document.getElementById('normalCount').textContent = '6';
    document.getElementById('riskCount').textContent = '2';
    
    // æ˜¾ç¤ºé»˜è®¤è¶‹åŠ¿å›¾ - 7å¤©æ•°æ®ï¼Œ5ä¸ªæŒ‡æ ‡
    const trendChart = echarts.init(document.getElementById('trendChart'));
    
    // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ—¥æœŸ
    const defaultDates = [];
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        defaultDates.push((date.getMonth() + 1).toString().padStart(2, '0') + '-' + date.getDate().toString().padStart(2, '0'));
    }
    
    const defaultOption = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(10,24,48,0.98)',
        borderColor: '#00e4ff',
        borderWidth: 1,
        textStyle: { color: '#fff', fontSize: 10 },
        formatter: function(params) {
          let result = params[0].name + '<br/>';
          params.forEach(param => {
            result += param.marker + param.seriesName + ': ' + param.value;
            if (param.seriesName === 'ä½“æ¸©') result += 'Â°C';
            else if (param.seriesName === 'è¡€æ°§') result += '%';
            else if (param.seriesName === 'å¿ƒç‡') result += 'bpm';
            else if (param.seriesName === 'ç¡çœ ') result += 'h';
            result += '<br/>';
          });
          return result;
        }
      },
      legend: {
        show: true,
        top: 5,
        textStyle: { color: '#fff', fontSize: 10 },
        itemWidth: 12,
        itemHeight: 8
      },
      grid: { 
        top: 35, 
        left: 35, 
        right: 20, 
        bottom: 25, 
        containLabel: true 
      },
      xAxis: {
        type: 'category',
        data: defaultDates,
        axisLabel: { color: '#7ecfff', fontSize: 9 },
        axisLine: { lineStyle: { color: 'rgba(0,228,255,0.2)' } }
      },
      yAxis: {
        type: 'value',
        axisLabel: { color: '#7ecfff', fontSize: 10 },
        splitLine: { 
          lineStyle: { 
            color: 'rgba(0,228,255,0.1)', 
            type: 'dashed' 
          } 
        }
      },
      series: [
        {
          name: 'å¿ƒç‡',
          type: 'line',
          data: [72, 75, 78, 74, 76, 73, 77],
          smooth: true,
          lineStyle: { color: '#ff6b6b', width: 2 },
          itemStyle: { color: '#ff6b6b' },
          symbolSize: 4
        },
        {
          name: 'è¡€æ°§',
          type: 'line',
          data: [98, 97, 99, 98, 97, 98, 99],
          smooth: true,
          lineStyle: { color: '#00ff9d', width: 2 },
          itemStyle: { color: '#00ff9d' },
          symbolSize: 4
        },
        {
          name: 'ä½“æ¸©',
          type: 'line',
          data: [36.5, 36.7, 36.4, 36.6, 36.8, 36.5, 36.6],
          smooth: true,
          lineStyle: { color: '#ffbb00', width: 2 },
          itemStyle: { color: '#ffbb00' },
          symbolSize: 4
        },
        {
          name: 'å‹åŠ›',
          type: 'line',
          data: [45, 52, 38, 48, 55, 42, 47],
          smooth: true,
          lineStyle: { color: '#ff9500', width: 2 },
          itemStyle: { color: '#ff9500' },
          symbolSize: 4
        },
        {
          name: 'ç¡çœ ',
          type: 'line',
          data: [7.5, 8.2, 6.8, 7.8, 8.0, 7.2, 7.6],
          smooth: true,
          lineStyle: { color: '#7ecfff', width: 2 },
          itemStyle: { color: '#7ecfff' },
          symbolSize: 4
        }
      ]
    };
    
    trendChart.setOption(defaultOption);
    
    // è‡ªé€‚åº”å¤§å°
    window.addEventListener('resize', () => {
      trendChart.resize();
    });
}

// ä¿®æ”¹æ•°æ®åˆ·æ–°å‡½æ•°
function refreshData() {
    // ä» URL è·å– customerId å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    console.log('urlParams', urlParams.get('customerId'));
    const customerId = urlParams.get('customerId') || '1';
    loadBaselineTrendChart(customerId);
    loadStatisticsData();
    //loadMessages(); // åŠ è½½æ¶ˆæ¯æ•°æ®

    fetch(`/get_total_info?customer_id=${customerId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                console.log('Refreshing data:', data);

                lastTotalInfo = data;
                updateMapData(lastTotalInfo);

                // åˆ·æ–°æ‰€æœ‰å›¾è¡¨
                if (globalCharts) {
                    // æ›´æ–°å¥åº·è¯„åˆ†å›¾è¡¨
                    if (globalCharts.healthScore) {
                        // è·å–æ—¥æœŸèŒƒå›´
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 7);
                        
                        const startDate = formatDate(yesterday);
                        const endDate = formatDate(today);
                        
                        fetch(`/health_data/score?orgId=${customerId}&startDate=${startDate}&endDate=${endDate}`)
                            .then(response => response.json())
                            .then(result => {
                                if (result.success && result.data && result.data.healthScores) {
                                    const factors = result.data.healthScores.factors;
                                    console.log('factors',factors);
                                    
                                    // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
                                    const totalScoreElement = document.querySelector('.total-score');
                                    if (totalScoreElement) {
                                        totalScoreElement.textContent = `æ€»åˆ†ï¼š${result.data.summary.overallScore}`;
                                    }
                                    
                                    const healthScoreOption = {
                                        tooltip: {
                                            trigger: 'axis',
                                            formatter: function(params) {
                                                return params[0].name + '<br/>' +
                                                       params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                            }
                                        },
                                        radar: {
                                            radius: '65%',
                                            center: ['50%', '55%'],
                                            indicator: [
                                                { name: `å¿ƒç‡ ${factors.heartRate?.score || 0}åˆ†`, max: 100 },
                                                { name: `è¡€æ°§ ${factors.bloodOxygen?.score || 0}åˆ†`, max: 100 },
                                                { name: `ä½“æ¸© ${factors.temperature?.score || 0}åˆ†`, max: 100 },
                                                { name: `æ­¥æ•° ${factors.step?.score || 0}åˆ†`, max: 100 },
                                                { name: `å¡è·¯é‡Œ ${factors.calorie?.score || 0}åˆ†`, max: 100 },
                                                { name: `æ”¶ç¼©å‹ ${factors.pressureHigh?.score || 0}åˆ†`, max: 100 },
                                                { name: `èˆ’å¼ å‹ ${factors.pressureLow?.score || 0}åˆ†`, max: 100 },
                                                { name: `å‹åŠ› ${factors.stress?.score || 0}åˆ†`, max: 100 }
                                            ],
                                            name: {
                                                textStyle: {
                                                    color: '#00e4ff',
                                                    fontSize: 12,
                                                    padding: [3, 5]
                                                },
                                                rich: {
                                                    value: {
                                                        color: '#00e4ff',
                                                        fontSize: 12,
                                                        fontWeight: 'normal'
                                                    }
                                                }
                                            },
                                            splitArea: {
                                                show: true,
                                                areaStyle: {
                                                    color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                                }
                                            },
                                            axisLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.5)'
                                                }
                                            },
                                            splitLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.3)'
                                                }
                                            }
                                        },
                                        series: [{
                                            name: 'å¥åº·æŒ‡æ ‡',
                                            type: 'radar',
                                            data: [{
                                                value: [
                                                    factors.heartRate?.score || 0,
                                                    factors.bloodOxygen?.score || 0,
                                                    factors.temperature?.score || 0,
                                                    factors.step?.score || 0,
                                                    factors.calorie?.score || 0,
                                                    factors.pressureHigh?.score || 0,
                                                    factors.pressureLow?.score || 0,
                                                    factors.stress?.score || 0
                                                ],
                                                name: 'å½“å‰çŠ¶æ€',
                                                itemStyle: {
                                                    color: '#00e4ff'
                                                },
                                                areaStyle: {
                                                    color: 'rgba(0,228,255,0.4)'
                                                }
                                            }]
                                        }]
                                    };
                                    globalCharts.healthScore.setOption(healthScoreOption);
                                } else {
                                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0åˆ†
                                    const totalScoreElement = document.querySelector('.total-score');
                                    if (totalScoreElement) {
                                        totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                                    }
                                    
                                    const healthScoreOption = {
                                        tooltip: {
                                            trigger: 'axis',
                                            formatter: function(params) {
                                                return params[0].name + '<br/>' +
                                                       params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                            }
                                        },
                                        radar: {
                                            radius: '65%',
                                            center: ['50%', '55%'],
                                            indicator: [
                                                { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                                { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                                { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                                { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                                { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                                { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                                { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                                { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                            ],
                                            name: {
                                                textStyle: {
                                                    color: '#00e4ff',
                                                    fontSize: 12,
                                                    padding: [3, 5]
                                                },
                                                rich: {
                                                    value: {
                                                        color: '#00e4ff',
                                                        fontSize: 12,
                                                        fontWeight: 'normal'
                                                    }
                                                }
                                            },
                                            splitArea: {
                                                show: true,
                                                areaStyle: {
                                                    color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                                }
                                            },
                                            axisLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.5)'
                                                }
                                            },
                                            splitLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.3)'
                                                }
                                            }
                                        },
                                        series: [{
                                            name: 'å¥åº·æŒ‡æ ‡',
                                            type: 'radar',
                                            data: [{
                                                value: [0, 0, 0, 0, 0, 0, 0, 0],
                                                name: 'å½“å‰çŠ¶æ€',
                                                itemStyle: {
                                                    color: '#00e4ff'
                                                },
                                                areaStyle: {
                                                    color: 'rgba(0,228,255,0.4)'
                                                }
                                            }]
                                        }]
                                    };
                                    globalCharts.healthScore.setOption(healthScoreOption);
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching health data:', error);
                                // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤º0åˆ†
                                const totalScoreElement = document.querySelector('.total-score');
                                if (totalScoreElement) {
                                    totalScoreElement.textContent = 'æ€»åˆ†ï¼š0';
                                }
                                // è®¾ç½®é»˜è®¤çš„0åˆ†å›¾è¡¨
                                const healthScoreOption = {
                                    tooltip: {
                                        trigger: 'axis',
                                        formatter: function(params) {
                                            return params[0].name + '<br/>' +
                                                   params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                        }
                                    },
                                    radar: {
                                        radius: '65%',
                                        center: ['50%', '55%'],
                                        indicator: [
                                            { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                            { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                            { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                            { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                            { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                            { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                            { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                            { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                        ],
                                        name: {
                                            textStyle: {
                                                color: '#00e4ff',
                                                fontSize: 12,
                                                padding: [3, 5]
                                            },
                                            rich: {
                                                value: {
                                                    color: '#00e4ff',
                                                    fontSize: 12,
                                                    fontWeight: 'normal'
                                                }
                                            }
                                        },
                                        splitArea: {
                                            show: true,
                                            areaStyle: {
                                                color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                            }
                                        },
                                        axisLine: {
                                            lineStyle: {
                                                color: 'rgba(0,228,255,0.5)'
                                            }
                                        },
                                        splitLine: {
                                            lineStyle: {
                                                color: 'rgba(0,228,255,0.3)'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: 'å¥åº·æŒ‡æ ‡',
                                        type: 'radar',
                                        data: [{
                                            value: [0, 0, 0, 0, 0, 0, 0, 0],
                                            name: 'å½“å‰çŠ¶æ€',
                                            itemStyle: {
                                                color: '#00e4ff'
                                            },
                                            areaStyle: {
                                                color: 'rgba(0,228,255,0.4)'
                                            }
                                        }]
                                    }]
                                };
                                globalCharts.healthScore.setOption(healthScoreOption);
                            });
                    }
                }

                // æ›´æ–°äººå‘˜ç®¡ç†é¢æ¿
                initPersonnelManagementPanel(data);

                // æ›´æ–°å‘Šè­¦ä¿¡æ¯å›¾è¡¨
                initAlertChart(data);

                // æ›´æ–°è®¾å¤‡ç®¡ç†å›¾è¡¨
                initDeviceChart(data);

                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                initMessageList(data);

                // ä¸ºå„ä¸ªé¢æ¿æ·»åŠ ç‚¹å‡»äº‹ä»¶
                setupPanelClickEvents(customerId);
            }
        })
        .catch(error => console.error('Error fetching data:', error));
}

// å°†é¢æ¿ç‚¹å‡»äº‹ä»¶è®¾ç½®æŠ½å–ä¸ºå•ç‹¬çš„å‡½æ•°
function setupPanelClickEvents(customerId) {
    // 1. å‘Šè­¦ä¿¡æ¯é¢æ¿
    const alertPanel = document.querySelector('.panel:has(#alertList)');
    if (alertPanel) {
        alertPanel.style.cursor = 'pointer';
        alertPanel.onclick = function() {
            createModalWindow(`/alert_view.html?customerId=${customerId}`);
        };
    }

    // 2. è®¾å¤‡ç®¡ç†é¢æ¿
    const devicePanel = document.querySelector('.panel:has(#statsChart)');
    if (devicePanel) {
        devicePanel.style.cursor = 'pointer';
        devicePanel.onclick = function() {
            createModalWindow(`/device_view.html?customerId=${customerId}`);
        };
    }

    // 3. æ¶ˆæ¯ä¿¡æ¯é¢æ¿
    const messagePanel = document.querySelector('.panel:has(#messageList)');
    if (messagePanel) {
        messagePanel.style.cursor = 'pointer';
        messagePanel.onclick = function() {
            createModalWindow(`/message_view.html?customerId=${customerId}`);
        };
    }

    // 4. è¶‹åŠ¿åˆ†æé¢æ¿
    const trendPanel = document.querySelector('.panel:has(#trendChart)');
    if (trendPanel) {
        trendPanel.style.cursor = 'pointer';
        trendPanel.onclick = function() {
            createModalWindow(`/health_main?customerId=${customerId}`);
        };
    }

    // 5. äººå‘˜ç®¡ç†é¢æ¿
    const personnelPanel = document.querySelector('.panel:has(#departmentDistribution)');
    if (personnelPanel) {
        personnelPanel.style.cursor = 'pointer';
        personnelPanel.onclick = function() {
            createModalWindow(`/user_view.html?customerId=${customerId}`);
        };
    }

    // 6. å¥åº·è¯„åˆ†é¢æ¿
    const scorePanel = document.querySelector('.panel:has(#healthScoreChart)');
    if (scorePanel) {
        scorePanel.style.cursor = 'pointer';
        scorePanel.onclick = function() {
            createModalWindow(`/user_health_data_analysis.html?customerId=${customerId}`);
        };
    }
}

// ä¿®æ”¹åˆå§‹åŒ–è°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        globalCharts = initCharts(); // å­˜å‚¨å›¾è¡¨å®ä¾‹
        refreshData(); // åˆå§‹åŠ è½½æ•°æ®
        // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®
        setInterval(refreshData, 60000);
    }, 100);
});

// æ·»åŠ é€šç”¨çš„åˆ›å»ºæ¨¡æ€çª—å£å‡½æ•°
function createModalWindow(url) {
    const modalContainer = document.createElement('div');
    modalContainer.className = 'modal-container';
    modalContainer.innerHTML = `
        <div class="modal-content">
            <button class="modal-close">âœ–</button>
            <div class="modal-header">
                <div class="filter-controls">
                    <div class="select-group">
                        <select id="modalDeptSelect" class="modal-select">
                            <option value="">é€‰æ‹©éƒ¨é—¨</option>
                        </select>
                        <select id="modalUserSelect" class="modal-select">
                            <option value="">é€‰æ‹©ç”¨æˆ·</option>
                        </select>
                    </div>
                    <div class="date-picker" style="display: none;">
                        <!-- é¢„ç•™æ—¶é—´é€‰æ‹©å™¨ä½ç½® -->
                    </div>
                </div>
            </div>
            <iframe src="${url}" class="user-view-iframe"></iframe>
        </div>
    `;
    
    document.body.appendChild(modalContainer);
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .modal-header {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .select-group {
            display: flex;
            gap: 10px;
        }
        
        .modal-select {
            background: rgba(0, 21, 41, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            padding: 5px 10px;
            font-size: 14px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-select:hover {
            border-color: rgba(0, 228, 255, 0.6);
        }
        
        .modal-select option {
            background: rgba(0, 21, 41, 0.9);
            color: #fff;
        }
        
        .user-view-iframe {
            margin-top: 10px;
        }
    `;
    document.head.appendChild(style);
    
    // å­˜å‚¨éƒ¨é—¨æ•°æ®çš„æ˜ å°„å…³ç³»
    const departmentMap = new Map();
    
    // è·å–éƒ¨é—¨æ•°æ®å¹¶å¡«å……é€‰æ‹©æ¡†
    fetch(`/get_departments?orgId={{ customerId }}`)
        .then(response => response.json())
        .then(response => {
            if (response.success && response.data) {
                const deptSelect = document.getElementById('modalDeptSelect');
                
                // é€’å½’æ·»åŠ éƒ¨é—¨é€‰é¡¹å¹¶ä¿å­˜æ˜ å°„å…³ç³»
                function addDepartmentOptions(departments, level = 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        const indent = 'ã€€'.repeat(level);
                        option.textContent = indent + dept.name;
                        deptSelect.appendChild(option);
                        
                        // ä¿å­˜éƒ¨é—¨IDå’Œåç§°çš„æ˜ å°„
                        departmentMap.set(dept.id.toString(), dept.name); // ç¡®ä¿keyä¸ºå­—ç¬¦ä¸²ç±»å‹
                        
                        if (dept.children && dept.children.length > 0) {
                            addDepartmentOptions(dept.children, level + 1);
                        }
                    });
                }
                
                addDepartmentOptions(response.data);
            }
        })
        .catch(error => console.error('Error fetching departments:', error));
    
    // éƒ¨é—¨é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    const deptSelect = document.getElementById('modalDeptSelect');
    const userSelect = document.getElementById('modalUserSelect');
    
    deptSelect.addEventListener('change', function() {
        const selectedDeptId = this.value;
        const selectedDeptName = selectedDeptId ? departmentMap.get(selectedDeptId.toString()) : ''; // ç¡®ä¿IDä¸ºå­—ç¬¦ä¸²ç±»å‹è¿›è¡ŒæŸ¥æ‰¾
        userSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';
        
        if (selectedDeptId) {
            fetch(`/fetch_users?orgId=${selectedDeptId}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.user_name;
                            // å°†ç”¨æˆ·åå­˜å‚¨åœ¨dataå±æ€§ä¸­
                            option.dataset.userName = user.user_name;
                            userSelect.appendChild(option);
                        });
                        // æ·»åŠ "å…¨éƒ¨ç”¨æˆ·"é€‰é¡¹
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'å…¨éƒ¨ç”¨æˆ·';
                        userSelect.appendChild(allOption);
                    }
                })
                .catch(error => console.error('Error fetching users:', error));
        }
        
        // æ›´æ–° iframe URLï¼ŒåŒ…å«éƒ¨é—¨ä¿¡æ¯
        updateIframeUrl(selectedDeptId, selectedDeptName);
    });
    
    // ç”¨æˆ·é€‰æ‹©å˜åŒ–æ—¶è§¦å‘äº‹ä»¶
    userSelect.addEventListener('change', function() {
        const selectedDeptId = deptSelect.value;
        const selectedDeptName = selectedDeptId ? departmentMap.get(selectedDeptId.toString()) : ''; // ç¡®ä¿IDä¸ºå­—ç¬¦ä¸²ç±»å‹è¿›è¡ŒæŸ¥æ‰¾
        const selectedUserId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const selectedUserName = selectedOption.dataset.userName || '';
        
        // æ›´æ–° iframe URLï¼ŒåŒ…å«éƒ¨é—¨å’Œç”¨æˆ·ä¿¡æ¯
        updateIframeUrl(selectedDeptId, selectedDeptName, selectedUserId, selectedUserName);
    });
    
    // æ›´æ–° iframe URL çš„è¾…åŠ©å‡½æ•°
    function updateIframeUrl(deptId, deptName, userId, userName) {
        const iframe = modalContainer.querySelector('iframe');
        let newUrl = new URL(iframe.src);
        
        // ä¿æŒåŸæœ‰çš„ customerId å‚æ•°
        const customerId = newUrl.searchParams.get('customerId');
        
        // é‡ç½® URL å‚æ•°
        newUrl.search = '';
        
        // é‡æ–°æ·»åŠ æ‰€æœ‰å¿…è¦çš„å‚æ•°
        if (customerId) {
            newUrl.searchParams.set('customerId', customerId);
        }
        if (deptId) {
            newUrl.searchParams.set('deptId', deptId);
            newUrl.searchParams.set('deptName', encodeURIComponent(deptName || ''));
        }
        if (userId && userId !== 'all') {
            newUrl.searchParams.set('userId', userId);
            newUrl.searchParams.set('userName', encodeURIComponent(userName || ''));
        }
        
        // æ›´æ–° iframe çš„ src
        iframe.src = newUrl.toString();
        
        // å¦‚æœé¡µé¢æœ‰åˆ·æ–°æ•°æ®çš„å‡½æ•°ï¼Œå°è¯•è°ƒç”¨å®ƒ
        try {
            iframe.contentWindow.fetchData && iframe.contentWindow.fetchData();
        } catch (e) {
            console.log('No fetchData function found in iframe or cross-origin restrictions apply');
        }
    }
    
    // æ·»åŠ å…³é—­äº‹ä»¶
    const closeBtn = modalContainer.querySelector('.modal-close');
    closeBtn.onclick = () => {
        modalContainer.remove();
        style.remove();
    };
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­
    modalContainer.onclick = (e) => {
        if (e.target === modalContainer) {
            modalContainer.remove();
            style.remove();
        }
    };
}

// æ·»åŠ é¢æ¿æ ·å¼
const panelStyle = document.createElement('style');
panelStyle.textContent = `
    .panel {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .panel:hover {
        border-color: rgba(0, 228, 255, 0.4);
        box-shadow: 0 0 15px rgba(0, 228, 255, 0.2);
    }

    .modal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        position: relative;
        width: 90%;
        height: 90%;
        background: rgba(0, 21, 41, 0.95);
        border: 1px solid rgba(0, 228, 255, 0.3);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 228, 255, 0.2);
        animation: slideIn 0.3s ease;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #00e4ff;
        font-size: 18px;
        cursor: pointer;
        z-index: 1;
        padding: 5px 10px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        transform: scale(1.1);
        color: #ff4444;
    }

    .user-view-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 4px;
        background: rgba(1, 19, 38, 0.8);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(panelStyle);

// åˆå§‹åŒ–å‘Šè­¦ä¿¡æ¯å›¾è¡¨ - ä¸“ä¸šç‰ˆ
function initAlertChart(data) {
    console.log('initAlertChart å¼€å§‹æ‰§è¡Œï¼Œæ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
    
    const alertContainer = document.getElementById('alertList');
    if (!alertContainer) {
        console.warn('å‘Šè­¦å®¹å™¨ #alertList æœªæ‰¾åˆ°');
        return;
    }

    // æ¸…ç©ºå®¹å™¨å¹¶åˆ›å»ºä¸“ä¸šå¸ƒå±€
    alertContainer.innerHTML = `
        <div style="position: relative; height: 100%; padding: 8px;">
            <!-- å‘Šè­¦çŠ¶æ€æ€»è§ˆ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 6px 10px; background: rgba(0,228,255,0.1); border-radius: 6px; border-left: 4px solid #00e4ff;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="alert-stat-item">
                        <span style="color: #ff4444; font-size: 18px; font-weight: bold;" id="criticalCount">0</span>
                        <span style="color: #fff; font-size: 12px; margin-left: 4px;">ä¸¥é‡</span>
                    </div>
                    <div class="alert-stat-item">
                        <span style="color: #ffbb00; font-size: 16px; font-weight: bold;" id="mediumCount">0</span>
                        <span style="color: #fff; font-size: 12px; margin-left: 4px;">ä¸­ç­‰</span>
                    </div>
                    <div class="alert-stat-item">
                        <span style="color: #ff6666; font-size: 14px; font-weight: bold;" id="pendingCount">0</span>
                        <span style="color: #fff; font-size: 12px; margin-left: 4px;">å¾…å¤„ç†</span>
                    </div>
                </div>
                <div style="background: rgba(255,68,68,0.2); padding: 4px 8px; border-radius: 12px; animation: pulse 2s infinite;" id="alertBadge">
                    <span style="color: #ff4444; font-size: 11px; font-weight: bold;">ğŸš¨ å®æ—¶ç›‘æ§</span>
                </div>
            </div>
            
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="alert-charts-grid">
                <div id="alertTypeChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">å‘Šè­¦ç±»å‹åˆ†å¸ƒ</div>
                </div>
                <div id="alertLevelChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">ä¸¥é‡ç¨‹åº¦åˆ†æ</div>
                </div>
                <div id="alertStatusChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">å¤„ç†çŠ¶æ€</div>
                </div>
                <div id="alertTrendChart" style="background: rgba(0,21,41,0.4); border: 1px solid rgba(0,228,255,0.3); border-radius: 6px; position: relative;">
                    <div style="position: absolute; top: 5px; left: 8px; color: #00e4ff; font-size: 12px; font-weight: bold; z-index: 10;">24å°æ—¶è¶‹åŠ¿</div>
                </div>
            </div>
        </div>
    `;

    const alertInfo = data.alert_info || {};
    const alerts = alertInfo.alerts || [];
    
    console.log('å‘Šè­¦ä¿¡æ¯:', alertInfo); // è°ƒè¯•ä¿¡æ¯
    console.log('å‘Šè­¦åˆ—è¡¨:', alerts); // è°ƒè¯•ä¿¡æ¯
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    const criticalCount = alertInfo.alertLevelCount?.critical || 0;
    const mediumCount = alertInfo.alertLevelCount?.medium || 0;
    const pendingCount = alertInfo.alertStatusCount?.pending || 0;
    
    document.getElementById('criticalCount').textContent = criticalCount;
    document.getElementById('mediumCount').textContent = mediumCount;
    document.getElementById('pendingCount').textContent = pendingCount;
    
    // æ›´æ–°å‘Šè­¦å¾½ç« 
    const badge = document.getElementById('alertBadge');
    if (criticalCount > 0) {
        badge.innerHTML = '<span style="color: #ff4444; font-size: 11px; font-weight: bold;">ğŸ”´ ä¸¥é‡å‘Šè­¦</span>';
        badge.style.background = 'rgba(255,68,68,0.3)';
    } else if (pendingCount > 0) {
        badge.innerHTML = '<span style="color: #ffbb00; font-size: 11px; font-weight: bold;">âš ï¸ å¾…å¤„ç†</span>';
        badge.style.background = 'rgba(255,187,0,0.3)';
    } else {
        badge.innerHTML = '<span style="color: #00ff9d; font-size: 11px; font-weight: bold;">âœ… æ­£å¸¸</span>';
        badge.style.background = 'rgba(0,255,157,0.3)';
    }

    // 1. å‘Šè­¦ç±»å‹åˆ†å¸ƒå›¾ - æ°´å¹³æ¡å½¢å›¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    const typeChart = echarts.init(document.getElementById('alertTypeChart'));
    const alertTypes = Object.keys(alertInfo.alertTypeCount || {});
    const alertValues = Object.values(alertInfo.alertTypeCount || {});

    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤æ•°æ®
    const hasTypeData = alertTypes.length > 0 && alertValues.some(v => v > 0);
    let displayTypes = hasTypeData ? alertTypes : ['heart_rate', 'blood_pressure', 'temperature'];
    let displayValues = hasTypeData ? alertValues : [0, 0, 0];

    // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé˜²æ­¢å›¾è¡¨å˜å½¢
    const MAX_DISPLAY_TYPES = 6; // æœ€å¤šæ˜¾ç¤º6ç§ç±»å‹
    if (displayTypes.length > MAX_DISPLAY_TYPES) {
        // æŒ‰æ•°å€¼æ’åºï¼Œå–å‰6ä¸ª
        const sortedData = displayTypes.map((type, index) => ({
            type: type,
            value: displayValues[index]
        })).sort((a, b) => b.value - a.value);
        
        displayTypes = sortedData.slice(0, MAX_DISPLAY_TYPES).map(item => item.type);
        displayValues = sortedData.slice(0, MAX_DISPLAY_TYPES).map(item => item.value);
        
        // å¦‚æœæœ‰æ›´å¤šç±»å‹ï¼Œå°†å‰©ä½™çš„åˆå¹¶ä¸º"å…¶ä»–"
        if (sortedData.length > MAX_DISPLAY_TYPES) {
            const otherValue = sortedData.slice(MAX_DISPLAY_TYPES).reduce((sum, item) => sum + item.value, 0);
            displayTypes.push('others');
            displayValues.push(otherValue);
        }
    }

    const typeColors = {
        'temperature': '#ffd700',
        'stress': '#ff8800', 
        'heart_rate': '#00e4ff',
        'blood_pressure': '#ffbb00',
        'blood_oxygen': '#ff6666',
        'others': '#888888'
    };

    const typeOption = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            borderWidth: 1,
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                if (!params || !params[0]) return '';
                const data = params[0];
                const total = displayValues.reduce((a, b) => a + b, 0);
                const percent = total > 0 ? (data.value / total * 100).toFixed(1) : 0;
                const typeName = data.name === 'others' ? 'å…¶ä»–ç±»å‹' : translateAlertType(data.name);
                return `${typeName}<br/>å‘Šè­¦: ${data.value}æ¬¡ (${percent}%)`;
            }
        },
        grid: { 
            top: 25, 
            left: 50, 
            right: 15, 
            bottom: 15,
            containLabel: true
        },
        xAxis: {
            type: 'value',
            axisLabel: { color: '#7ecfff', fontSize: 9 },
            splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)' } },
            axisLine: { show: false },
            max: Math.max(...displayValues, 1)
        },
        yAxis: {
            type: 'category',
            data: displayTypes.map(t => t === 'others' ? 'å…¶ä»–' : translateAlertType(t)),
            axisLabel: { 
                color: '#fff', 
                fontSize: 9,
                interval: 0, // å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                formatter: function(value) {
                    return value.length > 4 ? value.substring(0, 4) + '...' : value;
                }
            },
            axisLine: { show: false },
            axisTick: { show: false }
        },
        series: [{
            type: 'bar',
            data: displayTypes.map((type, index) => ({
                value: displayValues[index],
                itemStyle: { 
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: typeColors[type] || '#00e4ff' },
                        { offset: 1, color: (typeColors[type] || '#00e4ff') + '88' }
                    ])
                }
            })),
            barWidth: displayTypes.length > 4 ? '50%' : '65%', // åŠ¨æ€è°ƒæ•´æ¡å½¢å®½åº¦
            label: { 
                show: true, 
                position: 'right', 
                color: '#fff', 
                fontSize: 9,
                formatter: '{c}'
            }
        }]
    };
    typeChart.setOption(typeOption);

    // 2. å‘Šè­¦çº§åˆ«åˆ†å¸ƒå›¾ - ç¯å½¢å›¾
    const levelChart = echarts.init(document.getElementById('alertLevelChart'));
    const levelEntries = Object.entries(alertInfo.alertLevelCount || {});
    const hasLevelData = levelEntries.length > 0 && levelEntries.some(([_, count]) => count > 0);
    
    const levelData = hasLevelData ? 
        levelEntries.map(([level, count]) => ({
            name: level === 'critical' ? 'ä¸¥é‡' : level === 'medium' ? 'ä¸­ç­‰' : 'è½»å¾®',
            value: count,
            itemStyle: { 
                color: level === 'critical' ? '#ff4444' : level === 'medium' ? '#ffbb00' : '#00e4ff'
            }
        })) :
        [
            { name: 'ä¸¥é‡', value: 0, itemStyle: { color: '#ff4444' } },
            { name: 'ä¸­ç­‰', value: 0, itemStyle: { color: '#ffbb00' } },
            { name: 'æ­£å¸¸', value: 1, itemStyle: { color: '#00e4ff' } }
        ];

    const levelOption = {
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 },
            formatter: function(params) {
                return `${params.name}<br/>æ•°é‡: ${params.value}æ¬¡<br/>å æ¯”: ${params.percent}%`;
            }
        },
        series: [{
            type: 'pie',
            radius: ['35%', '65%'],
            center: ['50%', '55%'],
            data: levelData,
            label: {
                show: true,
                position: 'outside',
                color: '#fff',
                fontSize: 10,
                formatter: function(params) {
                    return hasLevelData ? `${params.name}\n${params.value}æ¬¡` : `${params.name}`;
                },
                lineHeight: 12
            },
            labelLine: {
                show: true,
                length: 8,
                length2: 5,
                lineStyle: { color: 'rgba(255,255,255,0.5)' }
            },
            emphasis: {
                itemStyle: { 
                    shadowBlur: 15, 
                    shadowOffsetX: 0, 
                    shadowColor: 'rgba(0, 0, 0, 0.8)',
                    scale: 1.05
                }
            }
        }]
    };
    levelChart.setOption(levelOption);

    // 3. å‘Šè­¦çŠ¶æ€åˆ†å¸ƒå›¾ - ä»ªè¡¨ç›˜æ ·å¼
    const statusChart = echarts.init(document.getElementById('alertStatusChart'));
    const totalAlerts = (alertInfo.alertStatusCount?.pending || 0) + (alertInfo.alertStatusCount?.responded || 0);
    const pendingPercent = totalAlerts > 0 ? ((alertInfo.alertStatusCount?.pending || 0) / totalAlerts * 100).toFixed(1) : 0;

    const statusOption = {
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 }
        },
        series: [{
            type: 'gauge',
            radius: '75%',
            center: ['50%', '55%'],
            startAngle: 180,
            endAngle: 0,
            min: 0,
            max: 100,
            splitNumber: 4,
            axisLine: {
                lineStyle: {
                    width: 8,
                    color: [
                        [0.3, '#00e4ff'],
                        [0.7, '#ffbb00'],
                        [1, '#ff4444']
                    ]
                }
            },
            pointer: {
                icon: 'circle',
                length: '60%',
                width: 4,
                offsetCenter: [0, '5%'],
                itemStyle: { color: '#fff' }
            },
            axisTick: { show: false },
            splitLine: { show: false },
            axisLabel: {
                show: true,
                distance: -25,
                color: '#7ecfff',
                fontSize: 9,
                formatter: function(value) {
                    if (value === 0) return 'æ­£å¸¸';
                    if (value === 50) return 'ä¸­ç­‰';
                    if (value === 100) return 'ä¸¥é‡';
                    return '';
                }
            },
            detail: {
                valueAnimation: true,
                formatter: function(value) {
                    return `{value|${value}%}\n{name|å¾…å¤„ç†ç‡}`;
                },
                rich: {
                    value: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: pendingPercent > 70 ? '#ff4444' : pendingPercent > 30 ? '#ffbb00' : '#00e4ff'
                    },
                    name: {
                        fontSize: 10,
                        color: '#7ecfff',
                        padding: [5, 0, 0, 0]
                    }
                },
                offsetCenter: [0, '20%']
            },
            data: [{ value: pendingPercent }]
        }]
    };
    statusChart.setOption(statusOption);

    // 4. 24å°æ—¶å‘Šè­¦è¶‹åŠ¿å›¾ - ä¿®å¤æ•°æ®å¤„ç†
    const trendChart = echarts.init(document.getElementById('alertTrendChart'));
    
    // å¤„ç†æ—¶é—´æ•°æ®ï¼ŒæŒ‰å°æ—¶ç»Ÿè®¡
    const hourlyData = {};
    const now = new Date();
    
    // åˆå§‹åŒ–24å°æ—¶æ•°æ®
    for (let i = 0; i < 24; i++) {
        hourlyData[i] = 0;
    }
    
    // ç»Ÿè®¡å‘Šè­¦æ•°æ®
    if (alerts && alerts.length > 0) {
        alerts.forEach(alert => {
            try {
                let alertTime;
                if (alert.alert_timestamp) {
                    // å°è¯•è§£ææ—¶é—´æˆ³
                    alertTime = new Date(alert.alert_timestamp);
                    if (isNaN(alertTime.getTime())) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                        alertTime = new Date(alert.alert_timestamp.replace(/-/g, '/'));
                    }
                } else if (alert.timestamp) {
                    alertTime = new Date(alert.timestamp);
                } else {
                    alertTime = now; // é»˜è®¤å½“å‰æ—¶é—´
                }
                
                if (!isNaN(alertTime.getTime())) {
                    const hour = alertTime.getHours();
                    hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                }
            } catch (e) {
                console.warn('è§£æå‘Šè­¦æ—¶é—´å¤±è´¥:', alert, e);
            }
        });
    }
    
    const hours = Array.from({length: 24}, (_, i) => i);
    const hourlyValues = hours.map(h => hourlyData[h] || 0);
    const maxValue = Math.max(...hourlyValues, 1);

    const trendOption = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.95)',
            borderColor: '#00e4ff',
            textStyle: { color: '#fff', fontSize: 11 },
                formatter: function(params) {
                if (!params || !params[0]) return '';
                const data = params[0];
                return `${data.name}:00<br/>å‘Šè­¦æ•°é‡: ${data.value}æ¬¡`;
            }
        },
        grid: { top: 25, left: 25, right: 15, bottom: 20 },
        xAxis: {
            type: 'category',
            data: hours.map(h => h.toString().padStart(2, '0')),
            axisLabel: { 
                color: '#7ecfff', 
                fontSize: 9,
                interval: 3
            },
            axisLine: { lineStyle: { color: 'rgba(126,207,255,0.3)' } },
            axisTick: { show: false }
        },
        yAxis: {
            type: 'value',
            max: Math.max(maxValue + 1, 3),
            axisLabel: { color: '#7ecfff', fontSize: 9 },
            splitLine: { lineStyle: { color: 'rgba(126,207,255,0.1)', type: 'dashed' } },
            axisLine: { show: false }
        },
        series: [{
            type: 'line',
            data: hourlyValues,
            smooth: true,
            lineStyle: { 
                color: '#00e4ff', 
                width: 2,
                shadowColor: 'rgba(0,228,255,0.3)',
                shadowBlur: 5
            },
            itemStyle: { 
                color: '#00e4ff',
                borderColor: '#fff',
                borderWidth: 1
            },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(0,228,255,0.4)' },
                    { offset: 1, color: 'rgba(0,228,255,0.05)' }
                ])
            },
            symbol: 'circle',
            symbolSize: function(value) {
                return value > 0 ? 4 : 2;
            },
            emphasis: {
                itemStyle: {
                    color: '#fff', 
                    borderColor: '#00e4ff', 
                    borderWidth: 2,
                    shadowColor: 'rgba(0,228,255,0.6)',
                    shadowBlur: 8
                },
                scale: 1.2
            }
        }]
    };
    trendChart.setOption(trendOption);

    // æ·»åŠ åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .alert-stat-item {
            display: flex;
            align-items: baseline;
            transition: all 0.3s ease;
        }
        
        .alert-stat-item:hover {
            transform: translateY(-2px);
        }
        
        #alertBadge {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #alertBadge:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0,228,255,0.5);
        }
    `;
    document.head.appendChild(style);

    // è‡ªé€‚åº”å¤§å° - å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²æ¸²æŸ“
    setTimeout(() => {
        const resizeCharts = () => {
            try {
                typeChart && typeChart.resize();
                levelChart && levelChart.resize();
                statusChart && statusChart.resize();
                trendChart && trendChart.resize();
            } catch (e) {
                console.warn('å›¾è¡¨resizeå¤±è´¥:', e);
            }
        };
        
        resizeCharts(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        window.addEventListener('resize', resizeCharts);
    }, 100);

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºè¯¦ç»†å‘Šè­¦åˆ—è¡¨
    badge.onclick = () => showAlertDetails(alerts);
    
    // å›¾è¡¨ç‚¹å‡»äº¤äº’
    typeChart.on('click', function(params) {
        if (hasTypeData && params.dataIndex < alertTypes.length) {
            const alertType = alertTypes[params.dataIndex];
            const filteredAlerts = alerts.filter(alert => alert.alert_type === alertType);
            showAlertDetails(filteredAlerts, `${translateAlertType(alertType)}å‘Šè­¦è¯¦æƒ…`);
        }
    });

    // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“ - å»¶è¿Ÿæ‰§è¡Œ
    setTimeout(() => {
        try {
            typeChart.resize();
            levelChart.resize();
            statusChart.resize();
            trendChart.resize();
            console.log('å‘Šè­¦å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
        } catch (e) {
            console.warn('å‘Šè­¦å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', e);
        }
    }, 200);

    return { typeChart, levelChart, statusChart, trendChart };
}

// æ˜¾ç¤ºè¯¦ç»†å‘Šè­¦åˆ—è¡¨
function showAlertDetails(alerts, title = 'ğŸ“‹ è¯¦ç»†å‘Šè­¦åˆ—è¡¨') {
    const modal = document.createElement('div');
    modal.className = 'modal-container';
    modal.innerHTML = `
        <div class="modal-content" style="width: 85%; height: 85%;">
            <button class="modal-close">âœ•</button>
            <h3 style="color: #00e4ff; margin-bottom: 20px; text-align: center; font-size: 18px;">${title}</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,228,255,0.1); border-radius: 6px;">
                <div style="color: #fff; font-size: 14px;">
                    å…± <span style="color: #00e4ff; font-weight: bold;">${alerts.length}</span> æ¡å‘Šè­¦è®°å½•
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportAlerts()" style="background: rgba(0,228,255,0.2); border: 1px solid #00e4ff; color: #00e4ff; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ“Š å¯¼å‡º</button>
                    <button onclick="refreshAlerts()" style="background: rgba(0,228,255,0.2); border: 1px solid #00e4ff; color: #00e4ff; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
            <div style="height: calc(100% - 100px); overflow-y: auto; border: 1px solid rgba(0,228,255,0.2); border-radius: 6px;">
                <table style="width: 100%; border-collapse: collapse; color: #fff; font-size: 13px;">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr style="background: rgba(0,228,255,0.3); border-bottom: 2px solid #00e4ff;">
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">æ—¶é—´</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">ç±»å‹</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">çº§åˆ«</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">çŠ¶æ€</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">ç”¨æˆ·</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">éƒ¨é—¨</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold; border-right: 1px solid rgba(0,228,255,0.2);">è®¾å¤‡</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: bold;">æè¿°</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${alerts.map((alert, index) => `
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); transition: all 0.2s ease; ${alert.severity_level === 'critical' ? 'background: rgba(255,68,68,0.15);' : index % 2 === 0 ? 'background: rgba(0,21,41,0.3);' : 'background: rgba(0,21,41,0.1);'}" 
                                onmouseover="this.style.background='rgba(0,228,255,0.1)'" 
                                onmouseout="this.style.background='${alert.severity_level === 'critical' ? 'rgba(255,68,68,0.15)' : index % 2 === 0 ? 'rgba(0,21,41,0.3)' : 'rgba(0,21,41,0.1)'}'">
                                <td style="padding: 10px 8px; font-size: 11px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #7ecfff;">${alert.alert_timestamp.split(' ')[0]}</div>
                                    <div style="color: #fff; font-size: 10px;">${alert.alert_timestamp.split(' ')[1]}</div>
                                </td>
                                <td style="padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <span style="background: ${getAlertTypeColor(alert.alert_type)}; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: #000;">
                                        ${translateAlertType(alert.alert_type)}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <span style="background: ${alert.severity_level === 'critical' ? '#ff4444' : '#ffbb00'}; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: #000;">
                                        ${alert.severity_level === 'critical' ? 'ğŸ”´ ä¸¥é‡' : 'ğŸŸ¡ ä¸­ç­‰'}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <span style="background: ${alert.alert_status === 'pending' ? '#ff4444' : '#00e4ff'}; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; color: ${alert.alert_status === 'pending' ? '#fff' : '#000'};">
                                        ${alert.alert_status === 'pending' ? 'â³ å¾…å¤„ç†' : 'âœ… å·²å¤„ç†'}
                                    </span>
                                </td>
                                <td style="padding: 10px 8px; font-size: 12px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #00e4ff; font-weight: bold;">${alert.user_name}</div>
                                    <div style="color: #7ecfff; font-size: 10px;">ID: ${alert.user_id}</div>
                                </td>
                                <td style="padding: 10px 8px; font-size: 12px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #fff;">${alert.dept_name}</div>
                                    <div style="color: #7ecfff; font-size: 10px;">éƒ¨é—¨ID: ${alert.dept_id}</div>
                                </td>
                                <td style="padding: 10px 8px; font-size: 11px; border-right: 1px solid rgba(255,255,255,0.05);">
                                    <div style="color: #ffbb00; font-family: monospace;">${alert.device_sn}</div>
                                    ${alert.health_id ? `<div style="color: #7ecfff; font-size: 10px;">å¥åº·ID: ${alert.health_id}</div>` : ''}
                                </td>
                                <td style="padding: 10px 8px; font-size: 11px; max-width: 200px; word-wrap: break-word; line-height: 1.4;">
                                    <div style="color: #fff;">${alert.alert_desc || 'æ— è¯¦ç»†æè¿°'}</div>
                                    ${alert.alert_status === 'pending' ? `
                                        <button onclick="handleAlert('${alert.alert_id}')" 
                                                style="margin-top: 5px; background: #ff4444; color: #fff; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; transition: all 0.2s ease;"
                                                onmouseover="this.style.background='#ff6666'" 
                                                onmouseout="this.style.background='#ff4444'">
                                            ğŸš¨ ç«‹å³å¤„ç†
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${alerts.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: #7ecfff;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“­</div>
                        <div style="font-size: 16px;">æš‚æ— å‘Šè­¦è®°å½•</div>
                        <div style="font-size: 12px; margin-top: 5px; color: rgba(255,255,255,0.5);">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­äº‹ä»¶
    modal.querySelector('.modal-close').onclick = () => modal.remove();
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    
    // æ·»åŠ é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
        }
    });
}

// å¯¼å‡ºå‘Šè­¦æ•°æ®
function exportAlerts() {
    // è¿™é‡Œå¯ä»¥å®ç°å¯¼å‡ºåŠŸèƒ½
    showCustomAlert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', null);
}

// åˆ·æ–°å‘Šè­¦æ•°æ®
function refreshAlerts() {
    refreshData();
    showCustomAlert('å‘Šè­¦æ•°æ®å·²åˆ·æ–°', null);
}

// è·å–å‘Šè­¦ç±»å‹é¢œè‰²
function getAlertTypeColor(type) {
    const colors = {
        'temperature': '#ff4444',
        'stress': '#ff8800',
        'heart_rate': '#00e4ff', 
        'blood_pressure': '#ffbb00',
        'blood_oxygen': '#ff6666'
    };
    return colors[type] || '#00e4ff';
}

// ä¿®æ”¹è®¾å¤‡ç®¡ç†å›¾è¡¨åˆå§‹åŒ–å‡½æ•°
function initDeviceChart(data) {
    const statsContainer = document.getElementById('statsChart');
    if (!statsContainer) return;

    const statsChart = echarts.init(statsContainer);
    
    const deviceInfo = data.device_info || {};
    const totalDevices = deviceInfo.totalDevices || 0;
    document.getElementById('totalWatchDevices').textContent = totalDevices;
    


    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    statsContainer.onclick = () => {
        const legendData = {
            'éƒ¨é—¨åˆ†å¸ƒ': deviceInfo.departmentDeviceCount || {},
            'å……ç”µçŠ¶æ€': deviceInfo.deviceChargingCount || {},
            'è®¾å¤‡çŠ¶æ€': deviceInfo.deviceStatusCount || {},
            'ç³»ç»Ÿç‰ˆæœ¬': deviceInfo.deviceSystemVersionCount || {},
            'ä½©æˆ´çŠ¶æ€': deviceInfo.deviceWearableCount || {}
        };
        showFullLegend(legendData);
    };

    // å¤„ç†æ•°æ®ä¸ºå †å æ ¼å¼
    const categories = ['éƒ¨é—¨åˆ†å¸ƒ', 'å……ç”µçŠ¶æ€', 'è®¾å¤‡çŠ¶æ€', 'ç³»ç»Ÿç‰ˆæœ¬', 'ä½©æˆ´çŠ¶æ€'];
    
    // å¤„ç†éƒ¨é—¨è®¾å¤‡æ•°æ®
    const departmentData = Object.entries(deviceInfo.departmentDeviceCount || {}).map(([name, value]) => ({
        name,
        value
    }));

    // å¤„ç†å……ç”µçŠ¶æ€æ•°æ®
    const chargingData = Object.entries(deviceInfo.deviceChargingCount || {}).map(([status, value]) => ({
        name: status === 'NOT_CHARGING' ? 'æœªå……ç”µ' : 'å……ç”µä¸­',
        value
    }));

    // å¤„ç†è®¾å¤‡çŠ¶æ€æ•°æ®
    const statusData = Object.entries(deviceInfo.deviceStatusCount || {}).map(([status, value]) => ({
        name: status === 'ACTIVE' ? 'æ´»è·ƒ' : 'éæ´»è·ƒ',
        value
    }));

    // å¤„ç†ç³»ç»Ÿç‰ˆæœ¬æ•°æ®
    const versionData = Object.entries(deviceInfo.deviceSystemVersionCount || {}).map(([version, value]) => ({
        name: version,
        value
    }));

    // å¤„ç†ä½©æˆ´çŠ¶æ€æ•°æ®
    const wearableData = Object.entries(deviceInfo.deviceWearableCount || {}).map(([status, value]) => ({
        name: status === 'WORN' ? 'å·²ä½©æˆ´' : 'æœªä½©æˆ´',
        value
    }));

    // åˆ›å»ºç³»åˆ—æ•°æ®
    const series = [];
    
    // éƒ¨é—¨åˆ†å¸ƒç³»åˆ—
    departmentData.forEach((item, index) => {
        series.push({
            name: item.name,
            type: 'bar',
            stack: 'éƒ¨é—¨åˆ†å¸ƒ',
            emphasis: {
                focus: 'series'
            },
            data: [item.value, 0, 0, 0, 0]
        });
    });

    // å……ç”µçŠ¶æ€ç³»åˆ—
    chargingData.forEach((item, index) => {
        series.push({
            name: item.name,
            type: 'bar',
            stack: 'å……ç”µçŠ¶æ€',
            emphasis: {
                focus: 'series'
            },
            data: [0, item.value, 0, 0, 0]
        });
    });

    // è®¾å¤‡çŠ¶æ€ç³»åˆ—
    statusData.forEach((item, index) => {
        series.push({
            name: item.name,
            type: 'bar',
            stack: 'è®¾å¤‡çŠ¶æ€',
            emphasis: {
                focus: 'series'
            },
            data: [0, 0, item.value, 0, 0]
        });
    });

    // ç³»ç»Ÿç‰ˆæœ¬ç³»åˆ—
    versionData.forEach((item, index) => {
        series.push({
            name: item.name,
            type: 'bar',
            stack: 'ç³»ç»Ÿç‰ˆæœ¬',
            emphasis: {
                focus: 'series'
            },
            data: [0, 0, 0, item.value, 0]
        });
    });

    // ä½©æˆ´çŠ¶æ€ç³»åˆ—
    wearableData.forEach((item, index) => {
        series.push({
            name: item.name,
            type: 'bar',
            stack: 'ä½©æˆ´çŠ¶æ€',
            emphasis: {
                focus: 'series'
            },
            data: [0, 0, 0, 0, item.value]
        });
    });

    const statsOption = {
        title: {
            text: 'è®¾å¤‡çŠ¶æ€ç»Ÿè®¡',
            textStyle: {
                color: '#fff',
                fontSize: 14
            },
            left: 'center',
            top: 10
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function(params) {
                const stackName = params[0].axisValue;
                let result = `${stackName}<br/>`;
                params.forEach(param => {
                    if (param.value > 0) {
                        result += `${param.seriesName}: ${param.value}<br/>`;
                    }
                });
                return result;
            }
        },
        legend: {
            textStyle: {
                color: '#fff'
            },
            top: 35,
            type: 'scroll',
            orient: 'horizontal'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            top: '25%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: {
                color: '#fff',
                interval: 0,
                rotate: 30
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                color: '#fff'
            },
            splitLine: {
                lineStyle: {
                    color: 'rgba(255,255,255,0.1)'
                }
            }
        },
        series: series
    };
    
    statsChart.setOption(statsOption);
    return statsChart;
}

// ä¿®æ”¹è¶‹åŠ¿åˆ†æå›¾è¡¨ï¼Œå¢åŠ é¢„æµ‹æ•°æ®
function updateTrendChart(data) {
    const trendContainer = document.getElementById('trendChart');
    if (!trendContainer) return;

    const trendChart = echarts.init(trendContainer);
    
    const trendOption = {
        title: {
            text: 'å¥åº·æŒ‡æ ‡è¶‹åŠ¿åŠé¢„æµ‹',
            textStyle: {
                color: '#fff',
                fontSize: 16
            }
        },
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.9)',
            borderColor: 'rgba(0,228,255,0.2)',
            textStyle: { color: '#fff' }
        },
        legend: {
            data: ['å¿ƒç‡', 'è¡€å‹', 'å‹åŠ›æŒ‡æ•°', 'è·ç¦»', 'å¡è·¯é‡Œ', 'æ­¥æ•°', 'é¢„æµ‹å€¼'],
            textStyle: { color: '#fff' },
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
            xAxis: {
                type: 'category',
            boundaryGap: false,
            data: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'é¢„æµ‹'],
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
            },
            yAxis: {
                type: 'value',
            axisLabel: { color: '#fff' },
            splitLine: {
                lineStyle: {
                    color: 'rgba(255,255,255,0.1)',
                    type: 'dashed'
                }
            }
        },
        series: [
            {
                name: 'å¿ƒç‡',
                type: 'line',
                smooth: true,
                data: [75, 72, 78, 85, 80, 75, 77],
                itemStyle: { color: '#ff4444' }
            },
            {
                name: 'è¡€å‹',
                type: 'line',
                smooth: true,
                data: [120, 118, 122, 125, 121, 119, 120],
                itemStyle: { color: '#00e4ff' }
            },
            {
                name: 'å‹åŠ›æŒ‡æ•°',
                type: 'line',
                smooth: true,
                data: [45, 48, 52, 55, 50, 47, 49],
                itemStyle: { color: '#ffbb00' }
            },
            {
                name: 'è·ç¦»',
                type: 'line',
                smooth: true,
                data: [2.1, 2.3, 2.8, 3.2, 3.5, 3.8, 4.0],
                itemStyle: { color: '#00ff9d' }
            },
            {
                name: 'å¡è·¯é‡Œ',
                type: 'line',
                smooth: true,
                data: [150, 180, 220, 280, 320, 350, 380],
                itemStyle: { color: '#ff7777' }
            },
            {
                name: 'æ­¥æ•°',
                type: 'line',
                smooth: true,
                data: [2000, 2500, 3000, 3800, 4200, 4500, 4800],
                itemStyle: { color: '#7777ff' }
            }
        ]
    };

    // ä¸ºæ¯ä¸ªç³»åˆ—æ·»åŠ é¢„æµ‹åŒºåŸŸ
    trendOption.series.forEach(series => {
        const lastIndex = series.data.length - 1;
        series.markArea = {
                itemStyle: {
                color: 'rgba(0, 228, 255, 0.1)'
            },
            data: [[{
                xAxis: trendOption.xAxis.data[lastIndex - 1]
            }, {
                xAxis: trendOption.xAxis.data[lastIndex]
            }]]
        };
    });

    trendChart.setOption(trendOption);
    return trendChart;
}

// äººå‘˜ç®¡ç†é¢æ¿äº¤äº’å‡½æ•°
function showPersonnelDetails() {
    showCustomAlert('äººå‘˜è¯¦æƒ…åŠŸèƒ½ï¼šæ˜¾ç¤ºå®Œæ•´çš„äººå‘˜ç®¡ç†ç»Ÿè®¡ä¿¡æ¯');
}

function filterByDepartment() {
    showCustomAlert('éƒ¨é—¨ç­›é€‰åŠŸèƒ½ï¼šæŒ‰éƒ¨é—¨æŸ¥çœ‹äººå‘˜åˆ†å¸ƒè¯¦æƒ…');
}

function filterByOnlineStatus() {
    showCustomAlert('åœ¨çº¿çŠ¶æ€ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿äººå‘˜åˆ—è¡¨');
}

function filterByDeviceStatus() {
    showCustomAlert('è®¾å¤‡çŠ¶æ€ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºå·²ç»‘å®š/æœªç»‘å®šè®¾å¤‡äººå‘˜');
}

function filterByAlertStatus() {
    showCustomAlert('å‘Šè­¦çŠ¶æ€ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºæœ‰å‘Šè­¦çš„äººå‘˜åˆ—è¡¨');
}

// æ˜¾ç¤ºéƒ¨é—¨è¯¦æƒ…
function showDepartmentDetails(deptName, userCount) {
    const modal = document.createElement('div');
    modal.className = 'modal-container';
    modal.innerHTML = `
        <div class="modal-content" style="width: 60%; height: 70%;">
            <button class="modal-close">âœ•</button>
            <h3 style="color: #00e4ff; margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“Š ${deptName} éƒ¨é—¨è¯¦æƒ…</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px;">
                <div style="background: rgba(0,228,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: #00e4ff; font-size: 24px; font-weight: bold;">${userCount}</div>
                    <div style="color: #fff; margin-top: 5px;">æ€»äººæ•°</div>
                </div>
                <div style="background: rgba(0,255,157,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: #00ff9d; font-size: 24px; font-weight: bold;">${Math.floor(userCount * 0.8)}</div>
                    <div style="color: #fff; margin-top: 5px;">åœ¨çº¿äººæ•°</div>
                </div>
                <div style="background: rgba(255,187,0,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="color: #ffbb00; font-size: 24px; font-weight: bold;">${Math.floor(userCount * 0.9)}</div>
                    <div style="color: #fff; margin-top: 5px;">è®¾å¤‡ç»‘å®š</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px; color: #7ecfff;">
                ç‚¹å‡»å¯æŸ¥çœ‹è¯¥éƒ¨é—¨çš„è¯¦ç»†äººå‘˜åˆ—è¡¨å’Œè®¾å¤‡çŠ¶æ€
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­äº‹ä»¶
    modal.querySelector('.modal-close').onclick = () => modal.remove();
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

// æ˜¾ç¤ºçŠ¶æ€è¯¦æƒ…
function showStatusDetails(statusName, statusValue) {
    const statusMap = {
        'åœ¨çº¿': 'å½“å‰åœ¨çº¿çš„ç”¨æˆ·åˆ—è¡¨',
        'ç¦»çº¿': 'å½“å‰ç¦»çº¿çš„ç”¨æˆ·åˆ—è¡¨',
        'ç»‘å®š': 'å·²ç»‘å®šè®¾å¤‡çš„ç”¨æˆ·',
        'æœªç»‘å®š': 'æœªç»‘å®šè®¾å¤‡çš„ç”¨æˆ·',
        'å‘Šè­¦': 'å½“å‰æœ‰å‘Šè­¦çš„ç”¨æˆ·',
        'æ­£å¸¸': 'çŠ¶æ€æ­£å¸¸çš„ç”¨æˆ·'
    };
    
    const modal = document.createElement('div');
    modal.className = 'modal-container';
    modal.innerHTML = `
        <div class="modal-content" style="width: 70%; height: 80%;">
            <button class="modal-close">âœ•</button>
            <h3 style="color: #00e4ff; margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“‹ ${statusName}ç”¨æˆ·è¯¦æƒ…</h3>
            <div style="background: rgba(0,228,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <div style="color: #00e4ff; font-size: 28px; font-weight: bold;">${statusValue}</div>
                <div style="color: #fff; margin-top: 5px;">${statusMap[statusName] || 'ç”¨æˆ·ç»Ÿè®¡'}</div>
            </div>
            <div style="color: #7ecfff; text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘¥</div>
                <div style="font-size: 16px;">è¯¦ç»†ç”¨æˆ·åˆ—è¡¨åŠŸèƒ½å¼€å‘ä¸­...</div>
                <div style="font-size: 12px; margin-top: 10px; color: rgba(255,255,255,0.5);">å°†æ˜¾ç¤ºå…·ä½“çš„ç”¨æˆ·ä¿¡æ¯ã€è®¾å¤‡çŠ¶æ€å’Œå¥åº·æ•°æ®</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å…³é—­äº‹ä»¶
    modal.querySelector('.modal-close').onclick = () => modal.remove();
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

  </script>


   
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    // è·å–éƒ¨é—¨æ•°æ®
    $.ajax({
        url: `/get_departments?orgId={{ customerId }}`,
        method: 'GET',
        success: function(response) {
            console.log('response', response);
            if (response.success && response.data) {
                updateDepartmentSelect(response.data);
            } else {
                console.error('Invalid response format:', response);
            }
        },
        error: function(error) {
            console.error('Failed to fetch departments:', error);
        }
    });

    // éƒ¨é—¨é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    $('#deptSelect').change(function() {
        const selectedDeptId = $(this).val();
        currentDept=selectedDeptId
        console.log('currentDept',currentDept);
        updateUsers(selectedDeptId);
    });

    // ç”¨æˆ·é€‰æ‹©å˜åŒ–æ—¶åˆ·æ–°åœ°å›¾
    $('#userSelect').change(function() {
        currentUser=$(this).val()
       //console.log('currentUser',currentUser);
        // è°ƒç”¨ initializeMap åˆ·æ–°æ•°æ®
        //initializeMap(selectedDeptId, selectedUserId);
        updateMapData(lastTotalInfo);
    });



    // æ›´æ–°éƒ¨é—¨é€‰æ‹©æ¡†
    function updateDepartmentSelect(departments) {
        const deptSelect = document.getElementById('deptSelect');
        if (!deptSelect) return;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        deptSelect.innerHTML = '<option value="">é€‰æ‹©éƒ¨é—¨</option>';

        // é€’å½’æ·»åŠ éƒ¨é—¨é€‰é¡¹
        function addDepartmentOptions(departments, level = 0) {
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                const indent = 'ã€€'.repeat(level);
                option.textContent = indent + dept.name;
                deptSelect.appendChild(option);

                if (dept.children && dept.children.length > 0) {
                    addDepartmentOptions(dept.children, level + 1);
                }
            });
        }

        addDepartmentOptions(departments);
        deptSelect.style.fontFamily = 'monospace';
    }

    // æ›´æ–°ç”¨æˆ·é€‰æ‹©æ¡†
    async function updateUsers(deptId) {
        try {
            const userSelect = document.getElementById('userSelect');
            if (!userSelect) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            userSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';

            if (!deptId) return;

            const response = await fetch(`/fetch_users?orgId=${deptId}`);
            const data = await response.json();
            console.log('updateUsers.data', data);

            if (data) {
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    let displayText = user.user_name;
                    // å¦‚æœæœ‰èŒä½ä¿¡æ¯ï¼Œæ·»åŠ åˆ°æ˜¾ç¤ºæ–‡æœ¬ä¸­
                    if (user.position) {
                        displayText += ` (${user.position})`;
                    }
                    option.textContent = displayText;
                    userSelect.appendChild(option);
                });
                const option = document.createElement('option');
                option.value = 'all';
                option.textContent = 'å…¨éƒ¨ç”¨æˆ·';
                userSelect.appendChild(option);
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .filter-select {
            font-family: monospace;
            white-space: pre;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .filter-select option {
            font-family: monospace;
            white-space: pre;
            background: #1a1a1a;
            color: #fff;
        }

        .filter-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 21, 41, 0.9);
            backdrop-filter: blur(8px);
            padding: 15px;
            border-radius: 8px;
            width: 280px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.2);
        }

        .filter-header span {
            color: #00e4ff;
            font-size: 14px;
        }

        .filter-toggle {
            background: transparent;
            border: none;
            color: #00e4ff;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
        }

        .filter-toggle:hover {
            transform: scale(1.1);
        }
    `;
    document.head.appendChild(style);
  });
</script>

<div id="infoPanel" class="info-panel" style="display: none;">
  <div class="info-panel-header">
    <div class="info-panel-title">
      <i class="fas fa-info-circle"></i>
      <span>å®æ—¶ä¿¡æ¯</span>
    </div>
    <button class="info-panel-close" onclick="toggleInfoPanel()">Ã—</button>
  </div>
  <div class="info-panel-content" id="infoPanelContent">
    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let infoPanelVisible = false;
let lastTotalInfo = null;

// åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤ºçŠ¶æ€
function toggleInfoPanel() {
  const panel = document.getElementById('infoPanel');
  infoPanelVisible = !infoPanelVisible;
  panel.style.display = infoPanelVisible ? 'block' : 'none';
}

// æ·»åŠ é”®ç›˜å¿«æ·é”®åˆ‡æ¢ä¿¡æ¯é¢æ¿
document.addEventListener('keydown', (e) => {
  if (e.key === 'i' && e.ctrlKey) {
    toggleInfoPanel();
  }
});

function openInfoPanelWithAlertId(alertId) {
  infoPanelVisible = true;
  document.getElementById('infoPanel').style.display = 'block';
  updateInfoPanel(lastTotalInfo, alertId);
}
function showCustomMapInfo(f){
  removeCustomMapInfo();
  const d=f.properties,toStr=x=>x===undefined||x===null?'':String(x);
  const get=(...k)=>k.map(x=>d[x]).find(x=>x!==undefined&&x!==null&&x!=='')||'-';
  // åˆ¤æ–­æ˜¯å¦ä¸ºå‘Šè­¦ç‚¹ï¼šæœ‰alert_id/alertIdä¸”æœ‰alert_type/alertTypeï¼Œä¸”typeä¸æ˜¯health
  const isAlert=!!(get('alert_id','alertId')&&get('alert_type','alertType')&&d.type!=='health');
  console.log('showCustomMapInfo.d',d);
  console.log('showCustomMapInfo.isAlert',isAlert);
  const level=get('severity_level','severityLevel');
  const levelColor=level==='critical'?'#ff4d4f':level==='high'?'#ffbb00':'#ffe066';
  const avatarUrl=d.avatar||'/static/images/avatar-tech.svg';
  const div=document.createElement('div');
  div.className='custom-map-info';
  div.style.cssText='position:absolute;z-index:9999;min-width:360px;max-width:420px;background:rgba(10,24,48,0.98);border:1.5px solid #00e4ff;border-radius:16px;box-shadow:0 0 24px #00e4ff44;padding:22px 28px 18px 28px;color:#fff;top:120px;left:50%;transform:translateX(-50%);font-size:15px;font-family:Roboto,Arial,sans-serif;backdrop-filter:blur(6px);';
  // è·å–ä½ç½®ä¿¡æ¯
      const longitude = get('longitude');
      const latitude = get('latitude');
      if(longitude && latitude){
        reverseGeocode(longitude, latitude)
          .then(address => {
            const locationInfo = document.getElementById('locationInfo');
            if(locationInfo){
              locationInfo.textContent = address || 'æœªçŸ¥ä½ç½®';
            }
          })
          .catch(error => {
            console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
            const locationInfo = document.getElementById('locationInfo');
            if(locationInfo){
              locationInfo.textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
            }
          });
      }
  if(isAlert){
    
    // å‘Šè­¦ç‚¹å†…å®¹
    div.innerHTML=`
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
        <img src="${avatarUrl}" style="width:56px;height:56px;border-radius:50%;border:2px solid #00e4ff;box-shadow:0 0 8px #00e4ff44;object-fit:cover;background:#001529;">
        <div>
          <div style="font-size:18px;font-weight:700;letter-spacing:1px;">${get('dept_name','deptName')}</div>
          <div style="font-size:16px;color:#00e4ff;font-weight:500;margin-top:2px;">${get('user_name','userName')}</div>
        </div>
      </div>
    
      <div style="display:flex;gap:18px;flex-wrap:wrap;margin-bottom:8px;">
        <div><span style="color:#7ecfff;">å‘Šè­¦ç±»åˆ«ï¼š</span><span style="color:${getAlertTypeColor(get('alert_type','alertType','-'))};font-weight:700;">${translateAlertType(get('alert_type','alertType','-'))}</span></div>
        <div><span style="color:#7ecfff;">çº§åˆ«ï¼š</span><span style="color:${getAlertSeverityColor(level||'-')};font-weight:700;">${translateAlertSeverity(level||'-')}</span></div>
        <div><span style="color:#7ecfff;">çŠ¶æ€ï¼š</span><span style="color:${getAlertStatusColor(get('alert_status','status','-'))};font-weight:700;">${translateAlertStatus(get('alert_status','status','-'))}</span></div>
      </div>
      <div style="margin-bottom:12px;">
        <span style="color:#7ecfff;">å¥åº·ä¿¡æ¯ï¼š</span>
        <a href="javascript:void(0)" onclick="showHealthProfile('${get('health_id','healthId')}')" style="color:#00e4ff;text-decoration:underline;font-family:monospace;font-size:15px;">${get('health_id','healthId')}</a>
      </div>
    <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">ä½ç½®ä¿¡æ¯ï¼š</span><span id="locationInfo">æ­£åœ¨è·å–...</span>
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">å‘Šè­¦æ—¶é—´ï¼š</span>${get('alert_timestamp','timestamp','-')}
      </div>

      <div style="display:flex;gap:18px;align-items:center;">
        <button onclick="handleAlert('${get('alert_id','alertId')}')" style="padding:7px 22px;background:${levelColor};color:#001529;border:none;border-radius:6px;cursor:pointer;font-weight:700;box-shadow:0 2px 8px ${levelColor}44;transition:.2s;">ä¸€é”®å¤„ç†</button>
        <span style="flex:1"></span>
        <span style="color:#00e4ff;cursor:pointer;font-size:22px;font-weight:700;" onclick="removeCustomMapInfo()">Ã—</span>
      </div>
    `;
    document.body.appendChild(div);
    

  } else {
    // å¥åº·ç‚¹å†…å®¹
    div.innerHTML=`
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
        <img src="${avatarUrl}" style="width:56px;height:56px;border-radius:50%;border:2px solid #00e4ff;box-shadow:0 0 8px #00e4ff44;object-fit:cover;background:#001529;">
        <div>
          <div style="font-size:18px;font-weight:700;letter-spacing:1px;">${get('dept_name','deptName')}</div>
          <div style="font-size:16px;color:#00e4ff;font-weight:500;margin-top:2px;">${get('user_name','userName')}</div>
        </div>
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">å¿ƒç‡ï¼š</span>${get('heartRate','heart_rate')}
        <span style="color:#7ecfff;margin-left:18px;">è¡€å‹ï¼š</span>${get('pressureHigh','pressure_high')}/${get('pressureLow','pressure_low')} mmHg
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">è¡€æ°§ï¼š</span>${get('bloodOxygen','blood_oxygen')}
        <span style="color:#7ecfff;margin-left:18px;">ä½“æ¸©ï¼š</span>${get('temperature','temp')} â„ƒ
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">æ­¥æ•°ï¼š</span>${get('step','steps')} æ­¥
        <span style="color:#7ecfff;margin-left:18px;">å¡è·¯é‡Œï¼š</span>${get('calorie','calories')} kcal
        <span style="color:#7ecfff;margin-left:18px;">è·ç¦»ï¼š</span>${get('distance','distance')} ç±³
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">å‹åŠ›ï¼š</span>${get('stress','pressure')}
        <span style="color:#7ecfff;margin-left:18px;">ç¡çœ ï¼š</span>${get('sleepData','scientificSleepData')}
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">ä½ç½®ä¿¡æ¯ï¼š</span><span id="locationInfo">æ­£åœ¨è·å–...</span>
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">é‡‡é›†æ—¶é—´ï¼š</span>${get('timestamp')}
      </div>
      <div style="display:flex;gap:18px;align-items:center;">
        <span style="flex:1"></span>
        <span style="color:#00e4ff;cursor:pointer;font-size:22px;font-weight:700;" onclick="removeCustomMapInfo()">Ã—</span>
      </div>
    `;
    document.body.appendChild(div);
    
    // è·å–ä½ç½®ä¿¡æ¯
    const longitude = get('longitude');
    const latitude = get('latitude');
    if(longitude && latitude){
      reverseGeocode(longitude, latitude)
        .then(address => {
          const locationInfo = document.getElementById('locationInfo');
          if(locationInfo){
            locationInfo.textContent = address || 'æœªçŸ¥ä½ç½®';
          }
        })
        .catch(error => {
          console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
          const locationInfo = document.getElementById('locationInfo');
          if(locationInfo){
            locationInfo.textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
          }
        });
    }
  }
}
function showHealthProfile(healthId){
  fetch(`/fetchHealthDataById?id=${healthId}`).then(r=>r.json()).then(j=>{
    if(!j.success||!j.data)return showCustomAlert('æ— å¥åº·æ•°æ®');
    const d=j.data,g=(...k)=>k.map(x=>d[x]).find(x=>x!==undefined&&x!==null&&x!=='')||'-';
    let sleepStr=g('sleepData','scientificSleepData'),sleep='-';
    try{
      if(typeof sleepStr==='string'&&sleepStr.startsWith('{')){
        const o=JSON.parse(sleepStr),arr=o.data||[];
        if(arr.length){
          const s=arr[0],fmt=m=>m?`${Math.floor(m/60)}h${m%60}m`:'-';
          sleep=`æ€»:${fmt(s.total)} æ·±:${fmt(s.deep)} æµ…:${fmt(s.light)} é†’:${fmt(s.awake)}`;
        }
      }
    }catch(e){sleep='-';}
    const html=`
      <div style="font-size:20px;font-weight:700;color:#00e4ff;margin-bottom:12px;text-align:center;">å¥åº·æ•°æ®</div>
      <div style="display:grid;grid-template-columns:100px 1fr;row-gap:8px;column-gap:10px;">
        <span>å¿ƒç‡</span><span style="text-align:right;font-weight:600;color:#7ecfff;">${g('heartRate','heart_rate')||'-'} <span style="color:#888;font-weight:400;">bpm</span></span>
        <span>è¡€å‹</span><span style="text-align:right;">${(g('pressureHigh','pressure_high')||'-')+'/'+(g('pressureLow','pressure_low')||'-')} <span style="color:#888;font-weight:400;">mmHg</span></span>
        <span>è¡€æ°§</span><span style="text-align:right;">${g('bloodOxygen','blood_oxygen')||'-'} <span style="color:#888;font-weight:400;">%</span></span>
        <span>ä½“æ¸©</span><span style="text-align:right;">${g('temperature','temp')||'-'} <span style="color:#888;font-weight:400;">â„ƒ</span></span>
        <span>æ­¥æ•°</span><span style="text-align:right;">${g('step','steps')||'-'} <span style="color:#888;font-weight:400;">æ­¥</span></span>
        <span>è·ç¦»</span><span style="text-align:right;">${g('distance','distance')||'-'} <span style="color:#888;font-weight:400;">ç±³</span></span>
        <span>å¡è·¯é‡Œ</span><span style="text-align:right;">${g('calorie','calories')||'-'} <span style="color:#888;font-weight:400;">kcal</span></span>
        <span>å‹åŠ›</span><span style="text-align:right;">${g('stress','pressure')||'-'} <span style="color:#888;font-weight:400;">åˆ†</span></span>
        <span>ç¡çœ </span><span style="text-align:right;">${sleep}</span>
        <span>é‡‡é›†æ—¶é—´</span><span style="text-align:right;">${g('timestamp')||'-'}</span>
      </div>
    `;
    const m=document.createElement('div');
    m.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,21,41,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    m.innerHTML=`<div style="background:rgba(10,24,48,0.98);border-radius:14px;box-shadow:0 0 24px #00e4ff44;padding:32px 38px;min-width:320px;max-width:420px;color:#fff;position:relative;">
      <span style="position:absolute;right:18px;top:12px;cursor:pointer;font-size:22px;color:#00e4ff;" onclick="this.parentNode.parentNode.remove()">Ã—</span>
      ${html}
    </div>`;
    document.body.appendChild(m);
  }).catch(()=>showCustomAlert('è·å–å¥åº·æ•°æ®å¤±è´¥'));
}

function removeCustomMapInfo(){const old=document.querySelector('.custom-map-info');if(old)old.remove();}

function filterData(data){
    //console.log('filterData.data',currentDept,currentUser);

    //console.log('filterData.data.healthData',data.healthData);
  const toStr=x=>x===undefined||x===null?'':String(x);
  const dept=toStr(currentDept),user=toStr(currentUser);
  const alerts=(data.alert_info?.alerts||[]).filter(a=>
    (!dept||[a.dept_id,a.deptId].some(v=>toStr(v)===dept))&&
    (!user||[a.user_id,a.userId].some(v=>toStr(v)===user))&&
    (['pending','1'].includes(toStr(a.alert_status||a.status)))
  );
  const healths=(data.health_data?.healthData||[]).filter(h=>
    (!dept||[h.dept_id,h.deptId].some(v=>toStr(v)===dept))&&
    (!user||[h.user_id,h.userId].some(v=>toStr(v)===user))
  );
  //console.log('filterData.alerts',alerts);
  //console.log('filterData.healths',healths);
  return {alerts,healths};
}

window.updateMapData = function(data){
    //console.log('updateMapData.data',data);
  if(!data||!map||!loca)return;
  const {alerts,healths}=filterData(data);
  const f=[];
  // å¤„ç†å‘Šè­¦æ•°æ®
  alerts.forEach(a=>{
    if((a.longitude||a.longitude===0)&&(a.latitude||a.latitude===0)){
      f.push({
        type:'Feature',
        geometry:{type:'Point',coordinates:[+a.longitude,+a.latitude]},
        properties:{
          ...a,
          alert_id: a.alert_id,
          alert_type: a.alert_type,
          alert_status: a.alert_status,
          severity_level: a.severity_level,
          dept_name: a.dept_name,
          user_name: a.user_name,
          health_id: a.health_id,
          device_sn: a.device_sn,
          alert_timestamp: a.alert_timestamp,
          type: 'alert'
        }
      });
    }
  });
  // å¤„ç†å¥åº·æ•°æ®
  healths.forEach(h=>{
    if((h.longitude||h.longitude===0)&&(h.latitude||h.latitude===0)){
      f.push({
        type:'Feature',
        geometry:{type:'Point',coordinates:[+h.longitude,+h.latitude]},
        properties:{
          ...h,
          dept_name: h.deptName,
          user_name: h.userName,
          heart_rate: h.heartRate,
          blood_oxygen: h.bloodOxygen,
          temperature: h.temperature,
          pressure_high: h.pressureHigh,
          pressure_low: h.pressureLow,
          step: h.step,
          stress: h.stress,
          device_sn: h.deviceSn,
          timestamp: h.timestamp,
          avatar: h.avatar,
          sleepData: h.sleepData,
          timestamp: h.timestamp,
          type: 'health'
        }
      });
    }
  });
  
  const geoJSON={type:'FeatureCollection',features:f};
  const criticalAlerts={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.severity_level==='critical')};
  const highAlerts={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.severity_level==='high'||f.properties.severity_level==='medium')};
  const healthData={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.type==='health')};
  
  breathRed.setSource(new Loca.GeoJSONSource({data:criticalAlerts}));
  breathYellow.setSource(new Loca.GeoJSONSource({data:highAlerts}));
  breathGreen.setSource(new Loca.GeoJSONSource({data:healthData}));
  
  // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
  let center=null;
  const getCoord=f=>f&&f.geometry&&f.geometry.coordinates;
  const findFirst=(arr,cond)=>{for(let i=0;i<arr.length;i++)if(cond(arr[i]))return arr[i];return null;};
  const cAlert=findFirst(geoJSON.features,f=>f.properties.type==='alert'&&['critical','high','medium'].includes(f.properties.severity_level));
  const cHealth=findFirst(geoJSON.features,f=>f.properties.type==='health');
  if(cAlert)center=getCoord(cAlert);
  else if(cHealth)center=getCoord(cHealth);
  if(center&&center.length>=2)map.setCenter([center[0],center[1]]);
  else if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setCenter([pos.coords.longitude,pos.coords.latitude]);
    });
  }
}

// å¥åº·æ•°æ®ç»Ÿè®¡è®¡ç®—å‡½æ•°
function calculateHealthStats(metrics) {
  const stats = {
    healthScore: 0,
    normalCount: 0,
    riskCount: 0,
    avgHeartRate: 0,
    avgBloodOxygen: 0,
    avgTemperature: 0,
    avgSteps: 0
  };
  
  if (!metrics || metrics.length === 0) return stats;
  
  let totalScore = 0, validMetrics = 0;
  
  metrics.forEach(metric => {
    const values = metric.values.filter(v => v !== null && v !== undefined);
    if (values.length === 0) return;
    
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    
    switch(metric.name) {
      case 'å¿ƒç‡':
        stats.avgHeartRate = Math.round(avg);
        const heartScore = avg >= 60 && avg <= 100 ? 85 : (avg < 60 ? 70 : 60); // æ­£å¸¸èŒƒå›´è¯„åˆ†
        totalScore += heartScore;
        if (heartScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
      case 'è¡€æ°§':
        stats.avgBloodOxygen = Math.round(avg);
        const oxygenScore = avg >= 95 ? 90 : (avg >= 90 ? 75 : 50);
        totalScore += oxygenScore;
        if (oxygenScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
      case 'ä½“æ¸©':
        stats.avgTemperature = avg.toFixed(1);
        const tempScore = avg >= 36.1 && avg <= 37.2 ? 88 : 65;
        totalScore += tempScore;
        if (tempScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
      case 'æ­¥æ•°':
        stats.avgSteps = Math.round(avg);
        const stepScore = avg >= 8000 ? 85 : (avg >= 5000 ? 70 : 55);
        totalScore += stepScore;
        if (stepScore >= 80) stats.normalCount++; else stats.riskCount++;
        validMetrics++;
        break;
    }
  });
  
  stats.healthScore = validMetrics > 0 ? Math.round(totalScore / validMetrics) : 0;
  return stats;
}

// æ›´æ–°å¥åº·ç»Ÿè®¡UI
function updateHealthStats(stats) {
  try {
    document.getElementById('healthScore').textContent = stats.healthScore;
    document.getElementById('normalCount').textContent = stats.normalCount;
    document.getElementById('riskCount').textContent = stats.riskCount;
    document.getElementById('avgHeartRate').textContent = stats.avgHeartRate;
    document.getElementById('avgBloodOxygen').textContent = stats.avgBloodOxygen + '%';
    document.getElementById('avgTemperature').textContent = stats.avgTemperature + 'Â°C';
    document.getElementById('avgSteps').textContent = stats.avgSteps;
  } catch (e) {
    console.warn('æ›´æ–°å¥åº·ç»Ÿè®¡UIå¤±è´¥:', e);
  }
}

// è®¡ç®—é›·è¾¾å›¾æ•°æ®
function calculateRadarData(metrics) {
  const indicators = [];
  const values = [];
  
  const metricMap = {
    'å¿ƒç‡': { max: 100, unit: 'bpm' },
    'è¡€æ°§': { max: 100, unit: '%' },
    'ä½“æ¸©': { max: 100, unit: 'Â°C' },
    'æ­¥æ•°': { max: 100, unit: 'æ­¥' },
    'å‹åŠ›': { max: 100, unit: 'çº§' },
    'ç¡çœ ': { max: 100, unit: 'å°æ—¶' },
    'å¡è·¯é‡Œ': { max: 100, unit: 'kcal' },
    'è¡€å‹': { max: 100, unit: 'mmHg' }
  };
  
  metrics.forEach(metric => {
    const config = metricMap[metric.name];
    if (!config) return;
    
    const validValues = metric.values.filter(v => v !== null && v !== undefined);
    if (validValues.length === 0) return;
    
    const avg = validValues.reduce((a, b) => a + b, 0) / validValues.length;
    
    // æ ¹æ®æŒ‡æ ‡ç±»å‹è®¡ç®—å¥åº·è¯„åˆ†
    let score = 0;
    switch(metric.name) {
      case 'å¿ƒç‡':
        score = avg >= 60 && avg <= 100 ? 85 : (avg < 60 ? 70 : 60);
        break;
      case 'è¡€æ°§':
        score = avg >= 95 ? 90 : (avg >= 90 ? 75 : 50);
        break;
      case 'ä½“æ¸©':
        score = avg >= 36.1 && avg <= 37.2 ? 88 : 65;
        break;
      case 'æ­¥æ•°':
        score = avg >= 8000 ? 85 : (avg >= 5000 ? 70 : 55);
        break;
      case 'å‹åŠ›':
        score = avg <= 3 ? 85 : (avg <= 5 ? 70 : 50);
        break;
      case 'ç¡çœ ':
        score = avg >= 7 ? 85 : (avg >= 6 ? 70 : 55);
        break;
      default:
        score = Math.min(90, Math.max(50, 100 - (avg * 0.5))); // é»˜è®¤è®¡ç®—
    }
    
    indicators.push({
      name: metric.name,
      max: 100,
      min: 0
    });
    
    values.push(Math.round(score));
  });
  
  return { indicators, values };
}

// æ˜¾ç¤ºé»˜è®¤å¥åº·æ•°æ®
function showDefaultHealthData() {
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    document.getElementById('healthScore').textContent = '85';
    document.getElementById('normalCount').textContent = '6';
    document.getElementById('riskCount').textContent = '2';
    
    // æ˜¾ç¤ºé»˜è®¤è¶‹åŠ¿å›¾
    const trendChart = echarts.init(document.getElementById('trendChart'));
    
    const defaultDates = ['05-20', '05-21', '05-22', '05-23', '05-24', '05-25', '05-26'];
    const defaultOption = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(10,24,48,0.98)',
        borderColor: '#00e4ff',
        textStyle: { color: '#fff', fontSize: 10 }
      },
      legend: {
        show: true,
        top: 5,
        textStyle: { color: '#fff', fontSize: 10 }
      },
      grid: { 
        top: 35, 
        left: 30, 
        right: 20, 
        bottom: 25, 
        containLabel: true 
      },
            xAxis: {
                type: 'category',
        data: defaultDates,
        axisLabel: { color: '#7ecfff', fontSize: 9 },
        axisLine: { lineStyle: { color: 'rgba(0,228,255,0.2)' } }
            },
            yAxis: {
                type: 'value',
        axisLabel: { color: '#7ecfff', fontSize: 10 },
        splitLine: { 
          lineStyle: { 
            color: 'rgba(0,228,255,0.1)', 
            type: 'dashed' 
          } 
        }
            },
            series: [
                {
          name: 'å¿ƒç‡',
                    type: 'line',
          data: [72, 75, 78, 74, 76, 73, 77],
          smooth: true,
          lineStyle: { color: '#ff4444' },
          itemStyle: { color: '#ff4444' }
        },
        {
          name: 'è¡€æ°§',
                    type: 'line',
          data: [98, 97, 99, 98, 97, 98, 99],
          smooth: true,
          lineStyle: { color: '#00ff9d' },
          itemStyle: { color: '#00ff9d' }
        },
        {
          name: 'ä½“æ¸©',
          type: 'line',
          data: [36.5, 36.7, 36.4, 36.6, 36.8, 36.5, 36.6],
          smooth: true,
          lineStyle: { color: '#ffbb00' },
          itemStyle: { color: '#ffbb00' }
        }
      ]
    };
    
    trendChart.setOption(defaultOption);
}

// äº¤äº’åŠŸèƒ½å‡½æ•°
function showHealthDetails() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¥åº·è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...\n\nå½“å‰æ˜¾ç¤ºçš„æ˜¯7å¤©å¥åº·æ•°æ®æ±‡æ€»');
    return;
  }
  
  const { health_summary, risk_alerts } = data;
  let message = `å¥åº·æ•°æ®è¯¦æƒ…æŠ¥å‘Š\n\n`;
  message += `ğŸ“Š ç»¼åˆè¯„åˆ†: ${health_summary.overall_score}åˆ†\n`;
  message += `âœ… æ­£å¸¸æŒ‡æ ‡: ${health_summary.normal_indicators}é¡¹\n`;
  message += `âš ï¸ é£é™©æŒ‡æ ‡: ${health_summary.risk_indicators}é¡¹\n`;
  message += `ğŸ‘¥ æ´»è·ƒç”¨æˆ·: ${health_summary.active_users}/${health_summary.total_users}äºº\n\n`;
  
  if (risk_alerts && risk_alerts.length > 0) {
    message += `ğŸš¨ é£é™©é¢„è­¦:\n`;
    risk_alerts.slice(0, 3).forEach(alert => {
      message += `â€¢ ${alert.message}\n`;
    });
  } else {
    message += `âœ¨ æš‚æ— é£é™©é¢„è­¦ï¼Œæ•´ä½“å¥åº·çŠ¶å†µè‰¯å¥½`;
  }
  
  alert(message);
}

function filterByHeartRate() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¿ƒç‡ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºå¿ƒç‡å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const heartRateMetric = data.metrics.find(m => m.name === 'å¿ƒç‡');
  if (heartRateMetric) {
    const abnormalDays = heartRateMetric.daily_stats ? 
      heartRateMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`å¿ƒç‡åˆ†æç»“æœ\n\nå¹³å‡å¿ƒç‡: ${heartRateMetric.avg_value}bpm\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${heartRateMetric.normal_range[0]}-${heartRateMetric.normal_range[1]}bpm`);
  } else {
    alert('æš‚æ— å¿ƒç‡æ•°æ®');
  }
}

function filterByBloodOxygen() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('è¡€æ°§ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¡€æ°§åä½çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const oxygenMetric = data.metrics.find(m => m.name === 'è¡€æ°§');
  if (oxygenMetric) {
    const abnormalDays = oxygenMetric.daily_stats ? 
      oxygenMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`è¡€æ°§åˆ†æç»“æœ\n\nå¹³å‡è¡€æ°§: ${oxygenMetric.avg_value}%\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${oxygenMetric.normal_range[0]}-${oxygenMetric.normal_range[1]}%`);
  } else {
    alert('æš‚æ— è¡€æ°§æ•°æ®');
  }
}

function filterByTemperature() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('ä½“æ¸©ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºä½“æ¸©å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const tempMetric = data.metrics.find(m => m.name === 'ä½“æ¸©');
  if (tempMetric) {
    const abnormalDays = tempMetric.daily_stats ? 
      tempMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`ä½“æ¸©åˆ†æç»“æœ\n\nå¹³å‡ä½“æ¸©: ${tempMetric.avg_value}Â°C\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${tempMetric.normal_range[0]}-${tempMetric.normal_range[1]}Â°C`);
  } else {
    alert('æš‚æ— ä½“æ¸©æ•°æ®');
  }
}

function filterBySteps() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('æ­¥æ•°ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¿åŠ¨é‡ä¸è¶³çš„ç”¨æˆ·');
    return;
  }
  
  const stepsMetric = data.metrics.find(m => m.name === 'æ­¥æ•°');
  if (stepsMetric) {
    const lowActivityDays = stepsMetric.daily_stats ? 
      stepsMetric.daily_stats.filter(d => d.value && d.value < 5000).length : 0;
    alert(`æ­¥æ•°åˆ†æç»“æœ\n\nå¹³å‡æ­¥æ•°: ${stepsMetric.avg_value}æ­¥\nè¿åŠ¨ä¸è¶³å¤©æ•°: ${lowActivityDays}å¤©\nå»ºè®®ç›®æ ‡: ${stepsMetric.normal_range[0]}æ­¥ä»¥ä¸Š`);
  } else {
    alert('æš‚æ— æ­¥æ•°æ•°æ®');
  }
}

function showMetricDetails(metricName, value, date) {
  const data = window.healthAnalysisData;
  if (!data) {
    alert(`æŒ‡æ ‡è¯¦æƒ…\n\næŒ‡æ ‡: ${metricName}\næ•°å€¼: ${value}\næ—¥æœŸ: ${date}\n\nç‚¹å‡»å¯æŸ¥çœ‹è¯¥æŒ‡æ ‡çš„è¯¦ç»†åˆ†æå’Œå»ºè®®`);
    return;
  }
  
  const metric = data.metrics.find(m => m.name === metricName);
  if (metric) {
    const dayData = metric.daily_stats ? metric.daily_stats.find(d => d.date === date) : null;
    let message = `${metricName}è¯¦ç»†ä¿¡æ¯\n\n`;
    message += `ğŸ“… æ—¥æœŸ: ${date}\n`;
    message += `ğŸ“Š æ•°å€¼: ${value}${metric.unit}\n`;
    message += `ğŸ“ˆ 7å¤©å¹³å‡: ${metric.avg_value}${metric.unit}\n`;
    message += `ğŸ“ æ­£å¸¸èŒƒå›´: ${metric.normal_range[0]}-${metric.normal_range[1]}${metric.unit}\n`;
    
    if (dayData) {
      message += `â­ å¥åº·è¯„åˆ†: ${dayData.score}åˆ†\n`;
      message += `ğŸ” çŠ¶æ€: ${dayData.status === 'normal' ? 'æ­£å¸¸' : 'éœ€å…³æ³¨'}\n`;
    }
    
    message += `\nğŸ’¡ å»ºè®®: ä¿æŒè§„å¾‹ç›‘æµ‹ï¼Œå¦‚æœ‰å¼‚å¸¸è¯·åŠæ—¶å°±åŒ»`;
    alert(message);
  }
}

function showHealthRadarDetails(radarData) {
  const data = window.healthAnalysisData;
  const avgScore = radarData.values.reduce((a,b)=>a+b,0) / radarData.values.length;
  
  let message = `å¥åº·é›·è¾¾è¯¦æƒ…\n\n`;
  message += `ğŸ¯ ç»¼åˆè¯„åˆ†: ${avgScore.toFixed(1)}åˆ†\n\n`;
  message += `ğŸ“‹ å„é¡¹æŒ‡æ ‡è¯„åˆ†:\n`;
  radarData.indicators.forEach((ind,i) => {
    const score = radarData.values[i];
    const status = score >= 80 ? 'âœ…' : score >= 60 ? 'âš ï¸' : 'âŒ';
    message += `${status} ${ind.name}: ${score}åˆ†\n`;
  });
  
  if (data && data.risk_alerts && data.risk_alerts.length > 0) {
    message += `\nğŸš¨ éœ€è¦å…³æ³¨:\n`;
    data.risk_alerts.slice(0, 2).forEach(alert => {
      message += `â€¢ ${alert.metric}: ${alert.current_value}\n`;
    });
  }
  
  alert(message);
}

// è·å–æŒ‡æ ‡å¹³å‡å€¼çš„è¾…åŠ©å‡½æ•°
function getMetricAvg(metrics, metricName) {
  const metric = metrics.find(m => m.name === metricName);
  if (!metric || !metric.values) return 0;
  
  const validValues = metric.values.filter(v => v !== null && v !== undefined);
  return validValues.length > 0 ? Math.round(validValues.reduce((a,b) => a+b, 0) / validValues.length) : 0;
}

// ä»åç«¯metricsæ•°æ®è®¡ç®—é›·è¾¾å›¾æ•°æ®
function calculateRadarDataFromMetrics(metrics) {
  const indicators = [];
  const values = [];
  
  // é€‰æ‹©ä¸»è¦å¥åº·æŒ‡æ ‡
  const mainMetrics = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'æ­¥æ•°', 'å‹åŠ›', 'æ”¶ç¼©å‹'];
  
  metrics.forEach(metric => {
    if (mainMetrics.includes(metric.name) && metric.avg_value > 0) {
      // æ ¹æ®æŒ‡æ ‡ç±»å‹è®¡ç®—å¥åº·è¯„åˆ†
      let score = 0;
      const avg = metric.avg_value;
      const [min, max] = metric.normal_range;
      
      if (avg >= min && avg <= max) {
        score = 85 + (15 * (1 - Math.abs(avg - (min + max)/2) / ((max - min)/2)));
      } else {
        if (avg < min) {
          score = Math.max(50, 85 - (min - avg) / min * 35);
        } else {
          score = Math.max(50, 85 - (avg - max) / max * 35);
        }
      }
      
      indicators.push({
        name: metric.name,
        max: 100,
        min: 0
      });
      
      values.push(Math.round(Math.min(100, Math.max(0, score))));
    }
  });
  
  // å¦‚æœæŒ‡æ ‡ä¸è¶³ï¼Œæ·»åŠ é»˜è®¤æŒ‡æ ‡
  if (indicators.length < 4) {
    const defaultIndicators = [
      { name: 'å¿ƒç‡', max: 100, min: 0 },
      { name: 'è¡€æ°§', max: 100, min: 0 },
      { name: 'ä½“æ¸©', max: 100, min: 0 },
      { name: 'æ­¥æ•°', max: 100, min: 0 }
    ];
    const defaultValues = [75, 85, 80, 65];
    
    for (let i = indicators.length; i < 4; i++) {
      indicators.push(defaultIndicators[i]);
      values.push(defaultValues[i]);
    }
  }
  
  return { indicators, values };
}

// æ›´æ–°äº¤äº’åŠŸèƒ½å‡½æ•°
function showHealthDetails() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¥åº·è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...\n\nå½“å‰æ˜¾ç¤ºçš„æ˜¯7å¤©å¥åº·æ•°æ®æ±‡æ€»');
    return;
  }
  
  const { health_summary, risk_alerts } = data;
  let message = `å¥åº·æ•°æ®è¯¦æƒ…æŠ¥å‘Š\n\n`;
  message += `ğŸ“Š ç»¼åˆè¯„åˆ†: ${health_summary.overall_score}åˆ†\n`;
  message += `âœ… æ­£å¸¸æŒ‡æ ‡: ${health_summary.normal_indicators}é¡¹\n`;
  message += `âš ï¸ é£é™©æŒ‡æ ‡: ${health_summary.risk_indicators}é¡¹\n`;
  message += `ğŸ‘¥ æ´»è·ƒç”¨æˆ·: ${health_summary.active_users}/${health_summary.total_users}äºº\n\n`;
  
  if (risk_alerts && risk_alerts.length > 0) {
    message += `ğŸš¨ é£é™©é¢„è­¦:\n`;
    risk_alerts.slice(0, 3).forEach(alert => {
      message += `â€¢ ${alert.message}\n`;
    });
  } else {
    message += `âœ¨ æš‚æ— é£é™©é¢„è­¦ï¼Œæ•´ä½“å¥åº·çŠ¶å†µè‰¯å¥½`;
  }
  
  alert(message);
}

function filterByHeartRate() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('å¿ƒç‡ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºå¿ƒç‡å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const heartRateMetric = data.metrics.find(m => m.name === 'å¿ƒç‡');
  if (heartRateMetric) {
    const abnormalDays = heartRateMetric.daily_stats ? 
      heartRateMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`å¿ƒç‡åˆ†æç»“æœ\n\nå¹³å‡å¿ƒç‡: ${heartRateMetric.avg_value}bpm\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${heartRateMetric.normal_range[0]}-${heartRateMetric.normal_range[1]}bpm`);
  } else {
    alert('æš‚æ— å¿ƒç‡æ•°æ®');
  }
}

function filterByBloodOxygen() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('è¡€æ°§ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¡€æ°§åä½çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const oxygenMetric = data.metrics.find(m => m.name === 'è¡€æ°§');
  if (oxygenMetric) {
    const abnormalDays = oxygenMetric.daily_stats ? 
      oxygenMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`è¡€æ°§åˆ†æç»“æœ\n\nå¹³å‡è¡€æ°§: ${oxygenMetric.avg_value}%\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${oxygenMetric.normal_range[0]}-${oxygenMetric.normal_range[1]}%`);
  } else {
    alert('æš‚æ— è¡€æ°§æ•°æ®');
  }
}

function filterByTemperature() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('ä½“æ¸©ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºä½“æ¸©å¼‚å¸¸çš„æ—¶é—´æ®µå’Œç”¨æˆ·');
    return;
  }
  
  const tempMetric = data.metrics.find(m => m.name === 'ä½“æ¸©');
  if (tempMetric) {
    const abnormalDays = tempMetric.daily_stats ? 
      tempMetric.daily_stats.filter(d => d.status === 'risk').length : 0;
    alert(`ä½“æ¸©åˆ†æç»“æœ\n\nå¹³å‡ä½“æ¸©: ${tempMetric.avg_value}Â°C\nå¼‚å¸¸å¤©æ•°: ${abnormalDays}å¤©\næ­£å¸¸èŒƒå›´: ${tempMetric.normal_range[0]}-${tempMetric.normal_range[1]}Â°C`);
  } else {
    alert('æš‚æ— ä½“æ¸©æ•°æ®');
  }
}

function filterBySteps() {
  const data = window.healthAnalysisData;
  if (!data) {
    alert('æ­¥æ•°ç­›é€‰åŠŸèƒ½ï¼šæ˜¾ç¤ºè¿åŠ¨é‡ä¸è¶³çš„ç”¨æˆ·');
    return;
  }
  
  const stepsMetric = data.metrics.find(m => m.name === 'æ­¥æ•°');
  if (stepsMetric) {
    const lowActivityDays = stepsMetric.daily_stats ? 
      stepsMetric.daily_stats.filter(d => d.value && d.value < 5000).length : 0;
    alert(`æ­¥æ•°åˆ†æç»“æœ\n\nå¹³å‡æ­¥æ•°: ${stepsMetric.avg_value}æ­¥\nè¿åŠ¨ä¸è¶³å¤©æ•°: ${lowActivityDays}å¤©\nå»ºè®®ç›®æ ‡: ${stepsMetric.normal_range[0]}æ­¥ä»¥ä¸Š`);
  } else {
    alert('æš‚æ— æ­¥æ•°æ•°æ®');
  }
}

function showMetricDetails(metricName, value, date) {
  const data = window.healthAnalysisData;
  if (!data) {
    alert(`æŒ‡æ ‡è¯¦æƒ…\n\næŒ‡æ ‡: ${metricName}\næ•°å€¼: ${value}\næ—¥æœŸ: ${date}\n\nç‚¹å‡»å¯æŸ¥çœ‹è¯¥æŒ‡æ ‡çš„è¯¦ç»†åˆ†æå’Œå»ºè®®`);
    return;
  }
  
  const metric = data.metrics.find(m => m.name === metricName);
  if (metric) {
    const dayData = metric.daily_stats ? metric.daily_stats.find(d => d.date === date) : null;
    let message = `${metricName}è¯¦ç»†ä¿¡æ¯\n\n`;
    message += `ğŸ“… æ—¥æœŸ: ${date}\n`;
    message += `ğŸ“Š æ•°å€¼: ${value}${metric.unit}\n`;
    message += `ğŸ“ˆ 7å¤©å¹³å‡: ${metric.avg_value}${metric.unit}\n`;
    message += `ğŸ“ æ­£å¸¸èŒƒå›´: ${metric.normal_range[0]}-${metric.normal_range[1]}${metric.unit}\n`;
    
    if (dayData) {
      message += `â­ å¥åº·è¯„åˆ†: ${dayData.score}åˆ†\n`;
      message += `ğŸ” çŠ¶æ€: ${dayData.status === 'normal' ? 'æ­£å¸¸' : 'éœ€å…³æ³¨'}\n`;
    }
    
    message += `\nğŸ’¡ å»ºè®®: ä¿æŒè§„å¾‹ç›‘æµ‹ï¼Œå¦‚æœ‰å¼‚å¸¸è¯·åŠæ—¶å°±åŒ»`;
    alert(message);
  }
}

function showHealthRadarDetails(radarData) {
  const data = window.healthAnalysisData;
  const avgScore = radarData.values.reduce((a,b)=>a+b,0) / radarData.values.length;
  
  let message = `å¥åº·é›·è¾¾è¯¦æƒ…\n\n`;
  message += `ğŸ¯ ç»¼åˆè¯„åˆ†: ${avgScore.toFixed(1)}åˆ†\n\n`;
  message += `ğŸ“‹ å„é¡¹æŒ‡æ ‡è¯„åˆ†:\n`;
  radarData.indicators.forEach((ind,i) => {
    const score = radarData.values[i];
    const status = score >= 80 ? 'âœ…' : score >= 60 ? 'âš ï¸' : 'âŒ';
    message += `${status} ${ind.name}: ${score}åˆ†\n`;
  });
  
  if (data && data.risk_alerts && data.risk_alerts.length > 0) {
    message += `\nğŸš¨ éœ€è¦å…³æ³¨:\n`;
    data.risk_alerts.slice(0, 2).forEach(alert => {
      message += `â€¢ ${alert.metric}: ${alert.current_value}\n`;
    });
  }
  
  alert(message);
}



function openMessagePanel() {
  // è·å–customerIdå‚æ•°
  const urlParams = new URLSearchParams(window.location.search);
  const customerId = urlParams.get('customerId') || '1';
  
  // æ‰“å¼€æ¶ˆæ¯è¯¦æƒ…é¡µé¢
  createModalWindow(`/message_view.html?customerId=${customerId}`);
}

// è·å–ç»Ÿè®¡æ•°æ®
function loadStatisticsData() {
  const urlParams = new URLSearchParams(window.location.search);
  const customerId = urlParams.get('customerId') || '1';
  const today = new Date().toISOString().split('T')[0];
  
  // è®¾ç½®å½“å‰æ—¥æœŸ
  document.getElementById('statsDate').textContent = today;
  
  // è·å–ç»Ÿè®¡æ¦‚è§ˆæ•°æ®
  fetch(`/api/statistics/overview?orgId=${customerId}&date=${today}`)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const data = result.data;
        console.log("statistics", data);
        
        // æ›´æ–°æ•°æ®æ˜¾ç¤º
        document.getElementById('healthDataCount').textContent = formatNumber(data.healthData);
        document.getElementById('pendingAlerts').textContent = formatNumber(data.pendingAlerts);
        document.getElementById('activeDevices').textContent = formatNumber(data.activeDevices);
        document.getElementById('unreadMessages').textContent = formatNumber(data.unreadMessages);
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        updateSystemStatus(data.summary);
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºè¶‹åŠ¿ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»å†å²æ•°æ®è®¡ç®—ï¼‰
        updateTrends(data);
        
        // æ·»åŠ æ•°æ®æ›´æ–°åŠ¨ç”»
        animateStatCards();
      }
    })
    .catch(error => {
      console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
      showErrorState();
    });
}

// æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

// æ›´æ–°ç³»ç»ŸçŠ¶æ€
function updateSystemStatus(summary) {
  const indicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const healthScore = document.getElementById('systemHealthScore');
  
  // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
  indicator.className = 'status-indicator';
  
  // æ ¹æ®ç³»ç»ŸçŠ¶æ€è®¾ç½®æ ·å¼å’Œæ–‡æœ¬
  switch (summary.systemStatus) {
    case 'normal':
      indicator.classList.add('normal');
      statusText.textContent = 'ç³»ç»Ÿæ­£å¸¸';
      break;
    case 'warning':
      indicator.classList.add('warning');
      statusText.textContent = 'ç³»ç»Ÿè­¦å‘Š';
      break;
    case 'critical':
      indicator.classList.add('critical');
      statusText.textContent = 'ç³»ç»Ÿå¼‚å¸¸';
      break;
  }
  
  // æ›´æ–°å¥åº·è¯„åˆ†
  healthScore.textContent = summary.healthScore;
  
  // æ ¹æ®è¯„åˆ†è®¾ç½®é¢œè‰²
  if (summary.healthScore >= 80) {
    healthScore.style.color = '#00ff9d';
  } else if (summary.healthScore >= 60) {
    healthScore.style.color = '#ffbb00';
  } else {
    healthScore.style.color = '#ff6b6b';
  }
}

// æ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
function updateTrends(data) {
  // æ¨¡æ‹Ÿè¶‹åŠ¿æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»å†å²æ•°æ®è®¡ç®—ï¼‰
  const trends = {
    health: Math.random() > 0.5 ? '+' + (Math.random() * 20).toFixed(1) + '%' : '-' + (Math.random() * 10).toFixed(1) + '%',
    alert: Math.random() > 0.3 ? '+' + (Math.random() * 15).toFixed(1) + '%' : '-' + (Math.random() * 25).toFixed(1) + '%',
    device: Math.random() > 0.7 ? '+' + (Math.random() * 10).toFixed(1) + '%' : '-' + (Math.random() * 5).toFixed(1) + '%',
    message: Math.random() > 0.4 ? '+' + (Math.random() * 30).toFixed(1) + '%' : '-' + (Math.random() * 20).toFixed(1) + '%'
  };
  
  // æ›´æ–°è¶‹åŠ¿æ˜¾ç¤º
  updateTrendElement('healthTrend', trends.health);
  updateTrendElement('alertTrend', trends.alert);
  updateTrendElement('deviceTrend', trends.device);
  updateTrendElement('messageTrend', trends.message);
}

// æ›´æ–°å•ä¸ªè¶‹åŠ¿å…ƒç´ 
function updateTrendElement(elementId, trend) {
  const element = document.getElementById(elementId);
  element.textContent = trend;
  element.className = 'stat-trend';
  
  if (trend.startsWith('-')) {
    element.classList.add('negative');
  }
}

// ç»Ÿè®¡å¡ç‰‡åŠ¨ç”»
function animateStatCards() {
  const cards = document.querySelectorAll('.stat-card');
  cards.forEach((card, index) => {
    setTimeout(() => {
      card.style.transform = 'scale(1.05)';
      setTimeout(() => {
        card.style.transform = 'scale(1)';
      }, 200);
    }, index * 100);
  });
}

// æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
function showErrorState() {
  const statusText = document.getElementById('statusText');
  const indicator = document.getElementById('statusIndicator');
  
  statusText.textContent = 'æ•°æ®è·å–å¤±è´¥';
  indicator.className = 'status-indicator critical';
  
  // æ˜¾ç¤ºé»˜è®¤å€¼
  document.getElementById('healthDataCount').textContent = '--';
  document.getElementById('pendingAlerts').textContent = '--';
  document.getElementById('activeDevices').textContent = '--';
  document.getElementById('unreadMessages').textContent = '--';
}


// åˆå§‹åŒ–ç»Ÿè®¡æ¦‚è§ˆå›¾è¡¨
function initOverviewChart() {
  const overviewContainer = document.getElementById('overviewChart');
  if (overviewContainer) {
    const overviewChart = echarts.init(overviewContainer);
    
    const overviewOption = {
      tooltip: {
        trigger: 'item',
        formatter: '{a} <br/>{b}: {c} ({d}%)'
      },
      legend: {
        show: false
      },
      series: [{
        name: 'æ•°æ®æ¦‚è§ˆ',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['50%', '50%'],
        data: [
          {value: 0, name: 'å¥åº·æ•°æ®', itemStyle: {color: '#00e4ff'}},
          {value: 0, name: 'å‘Šè­¦æ•°æ®', itemStyle: {color: '#ff6b6b'}},
          {value: 0, name: 'è®¾å¤‡æ•°æ®', itemStyle: {color: '#00ff9d'}},
          {value: 0, name: 'æ¶ˆæ¯æ•°æ®', itemStyle: {color: '#ffbb00'}}
        ],
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        },
        label: {
          show: false
        },
        labelLine: {
          show: false
        }
      }]
    };
    
    overviewChart.setOption(overviewOption);
    
    // ä¿å­˜å›¾è¡¨å®ä¾‹ä»¥ä¾¿åç»­æ›´æ–°
    window.overviewChart = overviewChart;
  }
}
</script>
  </body>
</html>

