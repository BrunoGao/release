<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ–¥ï¸ ç³»ç»Ÿå®æ—¶ç›‘æ§ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Microsoft YaHei',sans-serif;background:linear-gradient(135deg,#0c1445,#1e3c72,#2a5298);color:#fff;min-height:100vh;overflow-x:hidden;}
        
        .container{max-width:1600px;margin:0 auto;padding:20px;}
        
        /*å¤´éƒ¨*/
        .header{text-align:center;margin-bottom:30px;padding:20px;background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border-radius:15px;border:1px solid rgba(100,255,218,0.3);}
        .header h1{font-size:2.5em;color:#64ffda;text-shadow:0 0 20px rgba(100,255,218,0.8);margin-bottom:10px;}
        .header p{color:#a0c4ff;font-size:1.1em;}
        .last-update{color:#64ffda;font-size:0.9em;margin-top:10px;}
        
        /*ç›‘æ§ç½‘æ ¼*/
        .monitor-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}
        .monitor-card{background:rgba(255,255,255,0.08);backdrop-filter:blur(15px);border-radius:15px;padding:20px;border:1px solid rgba(100,255,218,0.2);transition:all 0.3s ease;}
        .monitor-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(100,255,218,0.2);}
        .monitor-title{color:#64ffda;font-size:1.3em;margin-bottom:15px;display:flex;align-items:center;gap:10px;}
        .monitor-icon{font-size:1.5em;animation:pulse 2s infinite;}
        @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
        
        /*æŒ‡æ ‡ç½‘æ ¼*/
        .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;}
        .metric-item{background:rgba(255,255,255,0.05);padding:12px;border-radius:10px;text-align:center;transition:all 0.3s ease;}
        .metric-item:hover{background:rgba(100,255,218,0.1);transform:scale(1.05);}
        .metric-label{color:#a0c4ff;font-size:0.85em;margin-bottom:5px;}
        .metric-value{font-size:1.6em;font-weight:bold;color:#fff;}
        .metric-good{color:#4caf50;}
        .metric-warning{color:#ff9800;}
        .metric-danger{color:#f44336;}
        .metric-unit{font-size:0.7em;color:#a0c4ff;margin-left:2px;}
        
        /*æ…¢æŸ¥è¯¢é¢æ¿*/
        .slow-queries-panel{background:rgba(255,255,255,0.08);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,152,0,0.3);}
        .slow-queries-title{color:#ff9800;font-size:1.3em;margin-bottom:15px;display:flex;align-items:center;gap:10px;}
        .query-list{max-height:400px;overflow-y:auto;}
        .query-item{background:rgba(255,255,255,0.05);margin:10px 0;padding:15px;border-radius:10px;border-left:4px solid #ff9800;transition:all 0.3s ease;}
        .query-item:hover{background:rgba(255,152,0,0.1);transform:translateX(5px);}
        .query-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        .query-time{color:#ff9800;font-weight:bold;}
        .query-duration{color:#f44336;font-size:0.9em;}
        .query-sql{background:rgba(0,0,0,0.3);padding:10px;border-radius:5px;font-family:monospace;font-size:0.85em;color:#e0e0e0;margin:8px 0;word-break:break-all;}
        .query-details{display:none;margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:5px;}
        .query-suggestion{background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);padding:10px;border-radius:5px;margin-top:8px;}
        .suggestion-title{color:#4caf50;font-weight:bold;margin-bottom:5px;}
        .suggestion-text{color:#e0e0e0;font-size:0.9em;}
        
        /*æŒ‰é’®*/
        .btn{padding:8px 15px;border:none;border-radius:6px;cursor:pointer;font-size:0.9em;transition:all 0.3s ease;margin:5px;}
        .btn-info{background:linear-gradient(45deg,#2196f3,#03a9f4);color:#fff;}
        .btn-warning{background:linear-gradient(45deg,#ff9800,#ffc107);color:#fff;}
        .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
        
        /*å›¾è¡¨åŒºåŸŸ*/
        .charts-section{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;}
        .chart-card{background:rgba(255,255,255,0.08);border-radius:15px;padding:20px;height:350px;}
        .chart-title{color:#64ffda;text-align:center;margin-bottom:15px;font-size:1.2em;}
        .chart-container{height:280px;position:relative;}
        
        /*çŠ¶æ€æŒ‡ç¤ºå™¨*/
        .status-indicator{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:15px;font-size:0.8em;font-weight:bold;}
        .status-healthy{background:rgba(76,175,80,0.2);color:#4caf50;border:1px solid rgba(76,175,80,0.5);}
        .status-warning{background:rgba(255,152,0,0.2);color:#ff9800;border:1px solid rgba(255,152,0,0.5);}
        .status-critical{background:rgba(244,67,54,0.2);color:#f44336;border:1px solid rgba(244,67,54,0.5);}
        
        /*å“åº”å¼*/
        @media(max-width:768px){
            .monitor-grid,.charts-section{grid-template-columns:1fr;}
            .metrics-grid{grid-template-columns:repeat(2,1fr);}
            .container{padding:15px;}
        }
        
        /*åŠ è½½åŠ¨ç”»*/
        .loading-spinner{width:40px;height:40px;border:3px solid rgba(100,255,218,0.2);border-top:3px solid #64ffda;border-radius:50%;animation:spin 1s linear infinite;margin:20px auto;}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    </style>
</head>
<body>
    <div class="container">
        <!--å¤´éƒ¨-->
        <div class="header">
            <h1>ğŸ–¥ï¸ ç³»ç»Ÿå®æ—¶ç›‘æ§ä¸­å¿ƒ</h1>
            <p>å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ Â· æ…¢æŸ¥è¯¢åˆ†æ Â· æ™ºèƒ½ä¼˜åŒ–å»ºè®®</p>
            <div class="last-update" id="lastUpdate">æœ€åæ›´æ–°: --</div>
        </div>
        
        <!--ç›‘æ§é¢æ¿-->
        <div class="monitor-grid">
            <!--æœåŠ¡å™¨æ€§èƒ½-->
            <div class="monitor-card">
                <div class="monitor-title">
                    <span class="monitor-icon">ğŸ–¥ï¸</span>
                    æœåŠ¡å™¨æ€§èƒ½
                    <span class="status-indicator status-healthy" id="serverStatus">
                        <span>â—</span> æ­£å¸¸
                    </span>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">CPUä½¿ç”¨ç‡</div>
                        <div class="metric-value" id="cpuUsage">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">å†…å­˜ä½¿ç”¨ç‡</div>
                        <div class="metric-value" id="memoryUsage">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">ç½‘ç»œè¿æ¥</div>
                        <div class="metric-value" id="connections">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">ç£ç›˜I/O</div>
                        <div class="metric-value" id="diskIO">--<span class="metric-unit">MB/s</span></div>
                    </div>
                </div>
            </div>
            
            <!--æ•°æ®åº“æ€§èƒ½-->
            <div class="monitor-card">
                <div class="monitor-title">
                    <span class="monitor-icon">ğŸ—„ï¸</span>
                    æ•°æ®åº“æ€§èƒ½
                    <span class="status-indicator status-healthy" id="dbStatus">
                        <span>â—</span> æ­£å¸¸
                    </span>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">è¿æ¥æ•°</div>
                        <div class="metric-value" id="dbConnections">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">QPS</div>
                        <div class="metric-value" id="dbQPS">--</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                        <div class="metric-value" id="cacheHitRate">--<span class="metric-unit">%</span></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">æ…¢æŸ¥è¯¢</div>
                        <div class="metric-value" id="slowQueries">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!--å›¾è¡¨åŒºåŸŸ-->
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">ğŸ“ˆ ç³»ç»Ÿè´Ÿè½½è¶‹åŠ¿</div>
                <div class="chart-container">
                    <canvas id="systemChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">ğŸ—„ï¸ æ•°æ®åº“æ€§èƒ½è¶‹åŠ¿</div>
                <div class="chart-container">
                    <canvas id="databaseChart"></canvas>
                </div>
            </div>
        </div>
        
        <!--æ…¢æŸ¥è¯¢åˆ†æ-->
        <div class="slow-queries-panel">
            <div class="slow-queries-title">
                <span class="monitor-icon">ğŸŒ</span>
                æ…¢æŸ¥è¯¢åˆ†æä¸ä¼˜åŒ–å»ºè®®
                <span class="status-indicator status-warning" id="slowQueryStatus">
                    <span>â—</span> <span id="slowQueryCount">0</span> æ¡æ…¢æŸ¥è¯¢
                </span>
            </div>
            <div class="query-list" id="queryList">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>
    
    <script>
        //å…¨å±€å˜é‡
        let systemChart=null;
        let databaseChart=null;
        let monitorInterval=null;
        let chartData={
            system:{labels:[],cpu:[],memory:[],connections:[]},
            database:{labels:[],qps:[],connections:[],hitRate:[]}
        };
        
        //åˆå§‹åŒ–å›¾è¡¨
        function initCharts(){
            //ç³»ç»Ÿè´Ÿè½½å›¾è¡¨
            const systemCtx=document.getElementById('systemChart');
            systemChart=new Chart(systemCtx,{
                type:'line',
                data:{
                    labels:[],
                    datasets:[
                        {label:'CPUä½¿ç”¨ç‡(%)',data:[],borderColor:'#f44336',backgroundColor:'rgba(244,67,54,0.1)',tension:0.4},
                        {label:'å†…å­˜ä½¿ç”¨ç‡(%)',data:[],borderColor:'#ff9800',backgroundColor:'rgba(255,152,0,0.1)',tension:0.4},
                        {label:'ç½‘ç»œè¿æ¥æ•°',data:[],borderColor:'#2196f3',backgroundColor:'rgba(33,150,243,0.1)',tension:0.4,yAxisID:'y1'}
                    ]
                },
                options:{
                    responsive:true,maintainAspectRatio:false,
                    plugins:{legend:{labels:{color:'#fff',fontSize:10}}},
                    scales:{
                        x:{ticks:{color:'#a0c4ff',fontSize:9},grid:{color:'rgba(160,196,255,0.1)'}},
                        y:{ticks:{color:'#a0c4ff',fontSize:9},grid:{color:'rgba(160,196,255,0.1)'},max:100},
                        y1:{type:'linear',display:true,position:'right',ticks:{color:'#a0c4ff',fontSize:9},grid:{drawOnChartArea:false}}
                    }
                }
            });
            
            //æ•°æ®åº“æ€§èƒ½å›¾è¡¨
            const dbCtx=document.getElementById('databaseChart');
            databaseChart=new Chart(dbCtx,{
                type:'line',
                data:{
                    labels:[],
                    datasets:[
                        {label:'QPS',data:[],borderColor:'#4caf50',backgroundColor:'rgba(76,175,80,0.1)',tension:0.4},
                        {label:'è¿æ¥æ•°',data:[],borderColor:'#9c27b0',backgroundColor:'rgba(156,39,176,0.1)',tension:0.4,yAxisID:'y1'},
                        {label:'ç¼“å­˜å‘½ä¸­ç‡(%)',data:[],borderColor:'#64ffda',backgroundColor:'rgba(100,255,218,0.1)',tension:0.4,yAxisID:'y2'}
                    ]
                },
                options:{
                    responsive:true,maintainAspectRatio:false,
                    plugins:{legend:{labels:{color:'#fff',fontSize:10}}},
                    scales:{
                        x:{ticks:{color:'#a0c4ff',fontSize:9},grid:{color:'rgba(160,196,255,0.1)'}},
                        y:{ticks:{color:'#a0c4ff',fontSize:9},grid:{color:'rgba(160,196,255,0.1)'}},
                        y1:{type:'linear',display:true,position:'right',ticks:{color:'#a0c4ff',fontSize:9},grid:{drawOnChartArea:false}},
                        y2:{type:'linear',display:false,max:100}
                    }
                }
            });
        }
        
        //æ›´æ–°å›¾è¡¨æ•°æ®
        function updateCharts(time,serverData,dbData){
            const maxPoints=20;
            
            //ç³»ç»Ÿå›¾è¡¨
            chartData.system.labels.push(time);
            chartData.system.cpu.push(serverData.cpu);
            chartData.system.memory.push(serverData.memory);
            chartData.system.connections.push(Math.round(serverData.connections/10));//ç¼©æ”¾æ˜¾ç¤º
            
            if(chartData.system.labels.length>maxPoints){
                chartData.system.labels.shift();
                chartData.system.cpu.shift();
                chartData.system.memory.shift();
                chartData.system.connections.shift();
            }
            
            systemChart.data.labels=chartData.system.labels;
            systemChart.data.datasets[0].data=chartData.system.cpu;
            systemChart.data.datasets[1].data=chartData.system.memory;
            systemChart.data.datasets[2].data=chartData.system.connections;
            systemChart.update('none');
            
            //æ•°æ®åº“å›¾è¡¨
            chartData.database.labels.push(time);
            chartData.database.qps.push(Math.round(dbData.qps/10));//ç¼©æ”¾æ˜¾ç¤º
            chartData.database.connections.push(dbData.connections);
            chartData.database.hitRate.push(dbData.cache_hit_rate);
            
            if(chartData.database.labels.length>maxPoints){
                chartData.database.labels.shift();
                chartData.database.qps.shift();
                chartData.database.connections.shift();
                chartData.database.hitRate.shift();
            }
            
            databaseChart.data.labels=chartData.database.labels;
            databaseChart.data.datasets[0].data=chartData.database.qps;
            databaseChart.data.datasets[1].data=chartData.database.connections;
            databaseChart.data.datasets[2].data=chartData.database.hitRate;
            databaseChart.update('none');
        }
        
        //æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetric(id,value,numValue,unit=''){
            const element=document.getElementById(id);
            if(element){
                element.innerHTML=`${value}<span class="metric-unit">${unit}</span>`;
                element.className='metric-value';
                
                //æ ¹æ®æŒ‡æ ‡ç±»å‹è®¾ç½®é¢œè‰²
                if(id.includes('Usage')||id==='slowQueries'){
                    if(numValue>80)element.classList.add('metric-danger');
                    else if(numValue>60)element.classList.add('metric-warning');
                    else element.classList.add('metric-good');
                }else if(id==='cacheHitRate'){
                    if(numValue>95)element.classList.add('metric-good');
                    else if(numValue>85)element.classList.add('metric-warning');
                    else element.classList.add('metric-danger');
                }else{
                    element.classList.add('metric-good');
                }
            }
        }
        
        //æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(id,status,text){
            const element=document.getElementById(id);
            if(element){
                element.className=`status-indicator status-${status}`;
                element.innerHTML=`<span>â—</span> ${text}`;
            }
        }
        
        //è·å–ç³»ç»ŸæŒ‡æ ‡
        async function getSystemMetrics(){
            try{
                const response=await fetch('/api/system_monitor/metrics');
                if(response.ok){
                    const result=await response.json();
                    if(result.success){
                        return result;
                    }
                }
            }catch(error){
                console.error('è·å–ç³»ç»ŸæŒ‡æ ‡å¤±è´¥:',error);
            }
            
            //é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ®
            return{
                success:true,
                server:{
                    cpu:Math.round(Math.random()*80+10),
                    memory:Math.round(Math.random()*70+20),
                    connections:Math.floor(Math.random()*500)+100,
                    disk_io:Math.round(Math.random()*50+5)
                },
                database:{
                    connections:Math.floor(Math.random()*150)+50,
                    qps:Math.floor(Math.random()*1500)+500,
                    cache_hit_rate:Math.round(Math.random()*15+85),
                    slow_queries:Math.floor(Math.random()*8)
                },
                slow_queries:generateMockSlowQueries()
            };
        }
        
        //ç”Ÿæˆæ¨¡æ‹Ÿæ…¢æŸ¥è¯¢æ•°æ®
        function generateMockSlowQueries(){
            const queries=[
                {sql:'SELECT * FROM user_health_data WHERE created_at > "2025-01-01" ORDER BY id DESC',duration:2.5,connection:'conn_123',table:'user_health_data'},
                {sql:'SELECT COUNT(*) FROM device_info d JOIN user_info u ON d.user_id = u.id WHERE d.status = "active"',duration:1.8,connection:'conn_456',table:'device_info'},
                {sql:'UPDATE alert_info SET status = "processed" WHERE severity = "high" AND created_at < NOW() - INTERVAL 1 DAY',duration:3.2,connection:'conn_789',table:'alert_info'}
            ];
            return queries.slice(0,Math.floor(Math.random()*4));
        }
        
                 //ç”Ÿæˆä¼˜åŒ–å»ºè®®
         function generateOptimizationSuggestion(query){
             let suggestions=[];
             const sql=query.sql.toLowerCase();
             const efficiency=query.rows_examined&&query.rows_sent?(query.rows_sent/query.rows_examined)*100:0;
             
             //åŸºäºSQLç±»å‹çš„å»ºè®®
             if(sql.includes('select * from')){
                 suggestions.push('ğŸ” é¿å…ä½¿ç”¨SELECT *ï¼ŒæŒ‡å®šå…·ä½“éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“é‡');
             }
             
             if(sql.includes('order by')&&!sql.includes('limit')){
                 suggestions.push('ğŸ“„ ORDER BYæŸ¥è¯¢å»ºè®®æ·»åŠ LIMITé™åˆ¶ç»“æœé›†å¤§å°');
             }
             
             if(sql.includes('join')&&!sql.includes('index')){
                 suggestions.push('ğŸ”— JOINæŸ¥è¯¢å»ºè®®åœ¨å…³è”å­—æ®µä¸Šåˆ›å»ºç´¢å¼•æå‡æ€§èƒ½');
             }
             
             if(sql.includes('where')&&sql.includes('created_at')){
                 suggestions.push('ğŸ“… æ—¶é—´å­—æ®µæŸ¥è¯¢å»ºè®®åˆ›å»ºç´¢å¼•: CREATE INDEX idx_created_at ON '+query.table+'(created_at)');
             }
             
             if(sql.includes('count(*)')&&sql.includes('join')){
                 suggestions.push('ğŸ”¢ COUNTæŸ¥è¯¢å»ºè®®ä½¿ç”¨è¦†ç›–ç´¢å¼•æˆ–è€ƒè™‘ç¼“å­˜ç»“æœ');
             }
             
             if(sql.includes('update')&&sql.includes('where')){
                 suggestions.push('âœï¸ UPDATEè¯­å¥å»ºè®®åˆ†æ‰¹æ‰§è¡Œï¼Œé¿å…é•¿æ—¶é—´é”è¡¨å½±å“å…¶ä»–æŸ¥è¯¢');
             }
             
             //åŸºäºæ‰«ææ•ˆç‡çš„å»ºè®®
             if(efficiency<1){
                 suggestions.push('âš¡ æ‰«ææ•ˆç‡è¿‡ä½('+efficiency.toFixed(2)+'%)ï¼Œå¼ºçƒˆå»ºè®®æ·»åŠ åˆé€‚çš„ç´¢å¼•');
             }else if(efficiency<10){
                 suggestions.push('ğŸ“ˆ æ‰«ææ•ˆç‡è¾ƒä½('+efficiency.toFixed(2)+'%)ï¼Œè€ƒè™‘ä¼˜åŒ–WHEREæ¡ä»¶æˆ–æ·»åŠ ç´¢å¼•');
             }
             
             //åŸºäºæ‰§è¡Œæ—¶é—´çš„å»ºè®®
             if(query.duration>3){
                 suggestions.push('ğŸš¨ æ‰§è¡Œæ—¶é—´è¿‡é•¿('+query.duration+'s)ï¼Œå»ºè®®ç«‹å³ä¼˜åŒ–æ­¤æŸ¥è¯¢');
             }else if(query.duration>2){
                 suggestions.push('â° æ‰§è¡Œæ—¶é—´è¾ƒé•¿('+query.duration+'s)ï¼Œå»ºè®®ä¼˜åŒ–æŸ¥è¯¢é€»è¾‘');
             }
             
             //åŸºäºè¡¨åçš„å…·ä½“å»ºè®®
             if(query.table==='user_health_data'){
                 suggestions.push('ğŸ’Š å¥åº·æ•°æ®è¡¨å»ºè®®: æŒ‰æ—¶é—´åˆ†åŒºï¼Œåˆ›å»ºå¤åˆç´¢å¼•(user_id,created_at)');
             }else if(query.table==='device_info'){
                 suggestions.push('ğŸ“± è®¾å¤‡ä¿¡æ¯è¡¨å»ºè®®: åœ¨statuså­—æ®µåˆ›å»ºç´¢å¼•ï¼Œè€ƒè™‘è½¯åˆ é™¤ç­–ç•¥');
             }else if(query.table==='alert_info'){
                 suggestions.push('ğŸš¨ å‘Šè­¦è¡¨å»ºè®®: åˆ›å»ºå¤åˆç´¢å¼•(severity,created_at,status)');
             }
             
             //é»˜è®¤å»ºè®®
             if(suggestions.length===0){
                 suggestions.push('ğŸ” å»ºè®®ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ');
                 suggestions.push('ğŸ“Š è€ƒè™‘æ·»åŠ é€‚å½“ç´¢å¼•ï¼Œä¼˜åŒ–WHEREæ¡ä»¶ï¼Œé¿å…å…¨è¡¨æ‰«æ');
             }
             
             return suggestions.join('<br>');
         }
        
        //æ˜¾ç¤ºæ…¢æŸ¥è¯¢è¯¦æƒ…
        function showQueryDetails(index){
            const details=document.getElementById(`details_${index}`);
            if(details){
                details.style.display=details.style.display==='none'?'block':'none';
            }
        }
        
        //æ›´æ–°æ…¢æŸ¥è¯¢åˆ—è¡¨
        function updateSlowQueries(queries){
            const queryList=document.getElementById('queryList');
            const slowQueryCount=document.getElementById('slowQueryCount');
            
            slowQueryCount.textContent=queries.length;
            
            if(queries.length===0){
                queryList.innerHTML='<div style="text-align:center;color:#4caf50;padding:20px;">ğŸ‰ å½“å‰æ— æ…¢æŸ¥è¯¢</div>';
                updateStatus('slowQueryStatus','healthy','æ— æ…¢æŸ¥è¯¢');
                return;
            }
            
            updateStatus('slowQueryStatus',queries.length>5?'critical':'warning',`${queries.length} æ¡æ…¢æŸ¥è¯¢`);
            
            queryList.innerHTML=queries.map((query,index)=>`
                <div class="query-item">
                    <div class="query-header">
                        <span class="query-time">è¿æ¥: ${query.connection}</span>
                        <span class="query-duration">è€—æ—¶: ${query.duration}s</span>
                    </div>
                    <div class="query-sql">${query.sql}</div>
                    <button class="btn btn-info" onclick="showQueryDetails(${index})">æŸ¥çœ‹è¯¦æƒ…</button>
                    <button class="btn btn-warning" onclick="explainQuery('${query.sql}')">æ‰§è¡Œè®¡åˆ’</button>
                                         <div class="query-details" id="details_${index}">
                         <strong>è¡¨å:</strong> ${query.table}<br>
                         <strong>è¿æ¥ID:</strong> ${query.connection}<br>
                         <strong>æ‰§è¡Œæ—¶é—´:</strong> ${query.duration}ç§’<br>
                         <strong>æ‰«æè¡Œæ•°:</strong> ${query.rows_examined || 'æœªçŸ¥'}<br>
                         <strong>è¿”å›è¡Œæ•°:</strong> ${query.rows_sent || 'æœªçŸ¥'}<br>
                         <strong>æ‰«ææ•ˆç‡:</strong> ${query.rows_examined && query.rows_sent ? ((query.rows_sent/query.rows_examined)*100).toFixed(2)+'%' : 'æœªçŸ¥'}<br>
                         <strong>å½±å“:</strong> å¯èƒ½å¯¼è‡´æ•°æ®åº“å“åº”å˜æ…¢ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ<br>
                         <strong>å»ºè®®ä¼˜å…ˆçº§:</strong> <span style="color:${query.duration>3?'#f44336':(query.duration>2?'#ff9800':'#4caf50')}">${query.duration>3?'é«˜':'ä¸­'}</span>
                     </div>
                    <div class="query-suggestion">
                        <div class="suggestion-title">ğŸ’¡ ä¼˜åŒ–å»ºè®®:</div>
                        <div class="suggestion-text">${generateOptimizationSuggestion(query)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        //è§£é‡ŠæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
        function explainQuery(sql){
            alert(`æ‰§è¡Œè®¡åˆ’åˆ†æ:\n\nSQL: ${sql}\n\nå»ºè®®:\n1. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•\n2. é¿å…å…¨è¡¨æ‰«æ\n3. ä¼˜åŒ–JOINæ¡ä»¶\n4. è€ƒè™‘åˆ†é¡µæŸ¥è¯¢\n\nè¯¦ç»†åˆ†æè¯·åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œ: EXPLAIN ${sql}`);
        }
        
        //æ›´æ–°ç›‘æ§æ•°æ®
        async function updateMonitorData(){
            try{
                const metrics=await getSystemMetrics();
                if(metrics&&metrics.server&&metrics.database){
                    const serverData=metrics.server;
                    const dbData=metrics.database;
                    const time=new Date().toLocaleTimeString();
                    
                    //æ›´æ–°æœåŠ¡å™¨æŒ‡æ ‡
                    updateMetric('cpuUsage',serverData.cpu,serverData.cpu,'%');
                    updateMetric('memoryUsage',serverData.memory,serverData.memory,'%');
                    updateMetric('connections',serverData.connections,serverData.connections);
                    updateMetric('diskIO',serverData.disk_io,serverData.disk_io,'MB/s');
                    
                    //æ›´æ–°æ•°æ®åº“æŒ‡æ ‡
                    updateMetric('dbConnections',dbData.connections,dbData.connections);
                    updateMetric('dbQPS',dbData.qps,dbData.qps);
                    updateMetric('cacheHitRate',dbData.cache_hit_rate.toFixed(1),dbData.cache_hit_rate,'%');
                    updateMetric('slowQueries',dbData.slow_queries,dbData.slow_queries);
                    
                    //æ›´æ–°çŠ¶æ€
                    const serverHealth=serverData.cpu<80&&serverData.memory<80?'healthy':(serverData.cpu>90||serverData.memory>90?'critical':'warning');
                    const dbHealth=dbData.cache_hit_rate>90&&dbData.slow_queries<5?'healthy':(dbData.cache_hit_rate<80||dbData.slow_queries>10?'critical':'warning');
                    
                    updateStatus('serverStatus',serverHealth,serverHealth==='healthy'?'æ­£å¸¸':(serverHealth==='critical'?'ä¸¥é‡':'è­¦å‘Š'));
                    updateStatus('dbStatus',dbHealth,dbHealth==='healthy'?'æ­£å¸¸':(dbHealth==='critical'?'ä¸¥é‡':'è­¦å‘Š'));
                    
                    //æ›´æ–°å›¾è¡¨
                    updateCharts(time,serverData,dbData);
                    
                    //æ›´æ–°æ…¢æŸ¥è¯¢
                    if(metrics.slow_queries){
                        updateSlowQueries(metrics.slow_queries);
                    }
                    
                    //æ›´æ–°æ—¶é—´
                    document.getElementById('lastUpdate').textContent=`æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;
                }
            }catch(error){
                console.error('æ›´æ–°ç›‘æ§æ•°æ®å¤±è´¥:',error);
            }
        }
        
        //å¯åŠ¨ç›‘æ§
        function startMonitoring(){
            updateMonitorData();//ç«‹å³æ›´æ–°ä¸€æ¬¡
            monitorInterval=setInterval(updateMonitorData,3000);//æ¯3ç§’æ›´æ–°
        }
        
        //åœæ­¢ç›‘æ§
        function stopMonitoring(){
            if(monitorInterval){
                clearInterval(monitorInterval);
                monitorInterval=null;
            }
        }
        
        //é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded',()=>{
            initCharts();
            startMonitoring();
        });
        
        //é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload',()=>{
            stopMonitoring();
        });
    </script>
</body>
</html> 