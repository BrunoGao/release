<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥åº·æ•°æ®è¡¨æ ¼</title>

  <!-- å­—ä½“å›¾æ ‡ -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/font-awesome-6.0.0.min.css') }}"
  />

  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/health_table.css') }}"
  />

  <!-- jQueryï¼ˆå¦‚æœæœ‰æ›´å¤šäº¤äº’ï¼Œå¯è€ƒè™‘æ¢æˆåŸç”Ÿæˆ– Vueï¼‰ -->
  <script
    src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"
    defer
  ></script>

  <!-- XLSXåº“ -->
  <script src="{{ url_for('static', filename='js/xlsx-0.18.5.full.min.js') }}"></script>
  <!-- XLSXåº“å¤‡ç”¨CDN -->
  <script>
    // å¦‚æœæœ¬åœ°XLSXåº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨CDNå¤‡ç”¨
    if (typeof XLSX === 'undefined') {
      console.warn('æœ¬åœ°XLSXåº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨CDNå¤‡ç”¨');
      const xlsxScript = document.createElement('script');
      xlsxScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      xlsxScript.crossOrigin = 'anonymous';
      xlsxScript.onload = function() {
        console.log('âœ… CDN XLSXåº“åŠ è½½æˆåŠŸ');
      };
      xlsxScript.onerror = function() {
        console.error('âŒ CDN XLSXåº“ä¹ŸåŠ è½½å¤±è´¥');
      };
      document.head.appendChild(xlsxScript);
    }
  </script>

  <!-- è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶ -->
  <script src="{{ url_for('static', filename='js/custom-alert.js') }}"></script>

  <style>
    /* é¡µé¢åŸºç¡€æ ·å¼ */
    html,body{width:100vw;height:100vh;margin:0;padding:0;overflow-x:hidden;background:#181c2f;color:#fff;font-family:'Segoe UI','PingFang SC','Microsoft YaHei',Arial,sans-serif;}
    .health-table-container{width:100%;height:auto;margin:0;padding:16px;overflow-x:auto;}
    table.health-table{width:100%;table-layout:auto;border-collapse:collapse;background:#232946;border-radius:8px;overflow:hidden;border:2px solid #00eaff;}
    table.health-table th,table.health-table td{white-space:nowrap;padding:10px 12px;box-sizing:border-box;border-bottom:1px solid #2a2f4a;}
    table.health-table th{background:#181c2f;color:#00eaff;font-weight:700;border-bottom:2px solid #00eaff;}
    table.health-table td{color:#fff;}
    table.health-table tbody tr:nth-child(odd){background:#232946;}
    table.health-table tbody tr:nth-child(even){background:#1a2236;}
    table.health-table tbody tr:hover{background:#2a2f4a;}
    table.health-table td.num{text-align:right;}
    table.health-table td.warn{color:#ff4d4f;font-weight:bold;}
    
    .toolbar-row{display:flex;align-items:center;gap:16px;padding:8px 0 16px 0;flex-wrap:wrap;}
    .pagination-bar{display:flex;align-items:center;gap:8px;font-size:16px;}
    .pagination-btn{padding:6px 12px;border:1.5px solid #00eaff;background:#232946;color:#00eaff;border-radius:6px;font-size:15px;cursor:pointer;transition:.2s;box-shadow:0 2px 8px #00eaff22;}
    .pagination-btn:disabled{background:#555;color:#999;cursor:not-allowed;border-color:#555;}
    .pagination-btn:not(:disabled):hover{background:#00eaff;color:#181c2f;}
    .pagination-input,.pagination-select{height:32px;text-align:center;border:1.5px solid #00eaff;border-radius:6px;font-size:15px;background:#181c2f;color:#00eaff;padding:4px 8px;}
    .pagination-input{width:50px;}
    .pagination-select{width:80px;}
    .pagination-label{font-size:15px;color:#00eaff;font-weight:500;}
    
    .date-input{font-size:16px;width:140px;border:1.5px solid #3a6ea5;border-radius:6px;background:#232946;color:#fff;padding:6px 8px;outline:none;transition:.2s;}
    .date-input:focus{border-color:#00eaff;}
    .date-label{color:#00eaff;font-weight:bold;font-size:16px;}
    .btn-primary{font-size:16px;padding:6px 18px;background:#00eaff;color:#181c2f;border:none;border-radius:6px;font-weight:bold;cursor:pointer;transition:.2s;box-shadow:0 2px 8px #00eaff44;}
    .btn-primary:hover{background:#38f9d7;color:#232946;}
    
    .loading{text-align:center;padding:40px;color:#00eaff;font-size:18px;}
    .error{text-align:center;padding:40px;color:#ff4d4f;font-size:16px;}
    .empty{text-align:center;padding:40px;color:#999;font-size:16px;}
  </style>
</head>

<body>
  <div class="health-table-container">
    <div class="toolbar-row">
      <div class="pagination-bar">
        <button id="prevPageTop" class="pagination-btn">&lt;</button>
        <input id="currentPageTop" class="pagination-input" type="number" min="1" value="1"/>
        <span id="totalPagesTop" class="pagination-label">/ 1</span>
        <button id="nextPageTop" class="pagination-btn">&gt;</button>
        <select id="pageSizeSelectTop" class="pagination-select">
          <option value="20">20/é¡µ</option>
          <option value="50">50/é¡µ</option>
          <option value="100">100/é¡µ</option>
          <option value="200">200/é¡µ</option>
        </select>
        <span class="pagination-label">è·³è‡³</span>
        <input id="jumpPageTop" class="pagination-input" type="number" min="1"/>
        <button id="jumpBtnTop" class="pagination-btn">è·³è½¬</button>
      </div>
      <span class="date-label">èµ·å§‹æ—¥æœŸï¼š</span>
      <input type="date" id="startDate" class="date-input"/>
      <span class="date-label">ç»“æŸæ—¥æœŸï¼š</span>
      <input type="date" id="endDate" class="date-input"/>
      <button id="dateSearchBtn" class="btn-primary">æŸ¥è¯¢</button>
      <button id="exportExcelBtn" class="btn-primary" style="margin-left:auto;">å¯¼å‡ºExcel</button>
    </div>
    
    <div id="loadingMsg" class="loading" style="display:none;">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    <div id="errorMsg" class="error" style="display:none;"></div>
    <div id="emptyMsg" class="empty" style="display:none;">æš‚æ— æ•°æ®</div>
    
    <table class="health-table" id="healthTable" style="display:none;">
      <thead id="tableHead">
        <!-- åŠ¨æ€ç”Ÿæˆè¡¨å¤´ -->
      </thead>
      <tbody id="healthDataBody"></tbody>
    </table>
    
    <div class="pagination-bar" id="paginationBottom" style="margin-top:16px;justify-content:center;">
      <button id="prevPage" class="pagination-btn">&lt;</button>
      <input id="currentPage" class="pagination-input" type="number" min="1" value="1"/>
      <span id="totalPages" class="pagination-label">/ 1</span>
      <button id="nextPage" class="pagination-btn">&gt;</button>
      <select id="pageSizeSelect" class="pagination-select">
        <option value="20">20/é¡µ</option>
        <option value="50">50/é¡µ</option>
        <option value="100">100/é¡µ</option>
        <option value="200">200/é¡µ</option>
      </select>
      <span class="pagination-label">è·³è‡³</span>
      <input id="jumpPage" class="pagination-input" type="number" min="1"/>
      <button id="jumpBtn" class="pagination-btn">è·³è½¬</button>
    </div>
  </div>

  <script>
    let currentPage=1,totalPages=1,pageSize=100,allData=[],enabledMetrics=[],currentColumns=[];
    const params=new URLSearchParams(location.search);
    const customerId=params.get('customerId')||'1',deptId=params.get('deptId')||customerId,userId=params.get('userId')||'';
    
    // å­—æ®µæ˜ å°„ï¼šè‹±æ–‡å­—æ®µååˆ°ä¸­æ–‡è¡¨å¤´å’Œåˆ†ç»„
    const fieldMapping = {
      // åŸºæœ¬ä¿¡æ¯
      'deptName': {title: 'éƒ¨é—¨', group: 'åŸºæœ¬ä¿¡æ¯', isBasic: true},
      'userName': {title: 'ç”¨æˆ·', group: 'åŸºæœ¬ä¿¡æ¯', isBasic: true},
      'deviceSn': {title: 'è®¾å¤‡', group: 'åŸºæœ¬ä¿¡æ¯', isBasic: true},
      
      // å¥åº·æŒ‡æ ‡
      'heart_rate': {title: 'å¿ƒç‡<br><span style="font-weight:400;font-size:12px;">bpm</span>', group: 'åŸºç¡€ä½“å¾', isNum: true, warn: (v) => v < 60 || v > 100},
      'blood_oxygen': {title: 'è¡€æ°§<br><span style="font-weight:400;font-size:12px;">%</span>', group: 'åŸºç¡€ä½“å¾', isNum: true, warn: (v) => v < 95},
      'temperature': {title: 'ä½“æ¸©<br><span style="font-weight:400;font-size:12px;">â„ƒ</span>', group: 'åŸºç¡€ä½“å¾', isNum: true, warn: (v) => v > 37.5},
      'pressure_high': {title: 'æ”¶ç¼©å‹<br><span style="font-weight:400;font-size:12px;">mmHg</span>', group: 'è¡€å‹/å‹åŠ›', isNum: true, warn: (v) => v > 140 || v < 90},
      'pressure_low': {title: 'èˆ’å¼ å‹<br><span style="font-weight:400;font-size:12px;">mmHg</span>', group: 'è¡€å‹/å‹åŠ›', isNum: true, warn: (v) => v > 90 || v < 60},
      'stress': {title: 'å‹åŠ›', group: 'è¡€å‹/å‹åŠ›', isNum: true, warn: (v) => v > 80},
      
      // è¿åŠ¨æ•°æ®
      'step': {title: 'æ­¥æ•°<br><span style="font-weight:400;font-size:12px;">æ­¥</span>', group: 'è¿åŠ¨', isNum: true},
      'calorie': {title: 'å¡è·¯é‡Œ<br><span style="font-weight:400;font-size:12px;">kcal</span>', group: 'è¿åŠ¨', isNum: true},
      'distance': {title: 'è·ç¦»<br><span style="font-weight:400;font-size:12px;">m</span>', group: 'è¿åŠ¨', isNum: true},
      
      // æ‰©å±•æŒ‡æ ‡
      'sleep': {title: 'ç¡çœ <br><span style="font-weight:400;font-size:12px;">å°æ—¶</span>', group: 'å¥åº·çŠ¶æ€', isNum: true},
      'ecg': {title: 'ECG', group: 'å¥åº·çŠ¶æ€', isNum: true},
      'work_out': {title: 'è¿åŠ¨æ¨¡å¼', group: 'è¿åŠ¨', isNum: true},
      'wear': {title: 'ä½©æˆ´çŠ¶æ€', group: 'è®¾å¤‡çŠ¶æ€'},
      'exercise_daily': {title: 'æ—¥è¿åŠ¨é‡', group: 'è¿åŠ¨', isNum: true},
      
      // ä½ç½®ä¿¡æ¯
      'location': {title: 'ä½ç½®', group: 'ä½ç½®ä¿¡æ¯'}, // locationæŒ‡æ ‡å¯¹åº”ä½ç½®ç›¸å…³å­—æ®µ
      'altitude': {title: 'æµ·æ‹”', group: 'ä½ç½®ä¿¡æ¯', isNum: true},
      'longitude': {title: 'ç»åº¦', group: 'ä½ç½®ä¿¡æ¯'},
      'latitude': {title: 'çº¬åº¦', group: 'ä½ç½®ä¿¡æ¯'},
      
      // æ—¶é—´ä¿¡æ¯
      'timestamp': {title: 'æ—¶é—´', group: 'æ—¶é—´', isBasic: true}
    };
    
    // å­—æ®µåå…¼å®¹æ˜ å°„ï¼šenabledMetricsä¸­çš„å­—æ®µå -> å®é™…æ•°æ®å­—æ®µå
    const fieldAliasMapping = {
      'heart_rate': ['heart_rate', 'heartRate'],
      'blood_oxygen': ['blood_oxygen', 'bloodOxygen'],
      'temperature': ['temperature'],
      'pressure_high': ['pressure_high', 'pressureHigh'],
      'pressure_low': ['pressure_low', 'pressureLow'],
      'stress': ['stress'],
      'step': ['step'],
      'calorie': ['calorie'],
      'distance': ['distance'],
      'sleep': ['sleep'],
      'ecg': ['ecg'],
      'work_out': ['work_out', 'workOut'],
      'wear': ['wear'],
      'exercise_daily': ['exercise_daily', 'exerciseDaily'],
      'location': ['latitude', 'longitude', 'altitude'], // locationæŒ‡æ ‡å¯¹åº”å¤šä¸ªä½ç½®å­—æ®µ
      'altitude': ['altitude'],
      'longitude': ['longitude'],
      'latitude': ['latitude']
    };
    
    // è·å–å®é™…æ•°æ®ä¸­çš„å­—æ®µå€¼
    function getFieldValue(data, metricName) {
      const aliases = fieldAliasMapping[metricName] || [metricName];
      for (const alias of aliases) {
        if (data[alias] !== undefined && data[alias] !== null && data[alias] !== '') {
          return data[alias];
        }
      }
      return null;
    }
    
    function showLoading(){document.getElementById('loadingMsg').style.display='block';document.getElementById('healthTable').style.display='none';document.getElementById('errorMsg').style.display='none';document.getElementById('emptyMsg').style.display='none';}
    function showError(msg){document.getElementById('errorMsg').innerText=msg;document.getElementById('errorMsg').style.display='block';document.getElementById('loadingMsg').style.display='none';document.getElementById('healthTable').style.display='none';document.getElementById('emptyMsg').style.display='none';}
    function showEmpty(){document.getElementById('emptyMsg').style.display='block';document.getElementById('loadingMsg').style.display='none';document.getElementById('healthTable').style.display='none';document.getElementById('errorMsg').style.display='none';}
    function showTable(){document.getElementById('healthTable').style.display='table';document.getElementById('loadingMsg').style.display='none';document.getElementById('errorMsg').style.display='none';document.getElementById('emptyMsg').style.display='none';}
    
    function buildDynamicColumns(enabledMetrics) {
      // æ€»æ˜¯åŒ…å«åŸºæœ¬ä¿¡æ¯å­—æ®µ
      const basicFields = ['deptName', 'userName', 'deviceSn'];
      const columns = [...basicFields];
      
      // æ·»åŠ å¯ç”¨çš„æŒ‡æ ‡å­—æ®µ
      enabledMetrics.forEach(metric => {
        if (metric === 'location') {
          // locationæŒ‡æ ‡å±•å¼€ä¸ºå…·ä½“çš„ä½ç½®å­—æ®µ
          ['latitude', 'longitude', 'altitude'].forEach(locField => {
            if (fieldMapping[locField] && !columns.includes(locField)) {
              columns.push(locField);
            }
          });
        } else if (fieldMapping[metric] && !basicFields.includes(metric)) {
          columns.push(metric);
        }
      });
      
      // æ€»æ˜¯åŒ…å«æ—¶é—´å­—æ®µ
      if (!columns.includes('timestamp')) {
        columns.push('timestamp');
      }
      
      return columns;
    }
    
    function getOrderedColumns(columns) {
      // å®šä¹‰åˆ†ç»„é¡ºåºï¼Œç¡®ä¿è¡€å‹/å‹åŠ›åˆ†ç»„æ­£ç¡®æ’åº
      const groupOrder = ['åŸºæœ¬ä¿¡æ¯', 'åŸºç¡€ä½“å¾', 'è¡€å‹/å‹åŠ›', 'è¿åŠ¨', 'å¥åº·çŠ¶æ€', 'è®¾å¤‡çŠ¶æ€', 'ä½ç½®ä¿¡æ¯', 'æ—¶é—´', 'å…¶ä»–'];
      
      // æŒ‰åˆ†ç»„æ”¶é›†å­—æ®µ
      const groupedColumns = {};
      columns.forEach(col => {
        const field = fieldMapping[col];
        if (field) {
          const group = field.group || 'å…¶ä»–';
          if (!groupedColumns[group]) {
            groupedColumns[group] = [];
          }
          groupedColumns[group].push(col);
        }
      });
      
      // æŒ‰é¢„å®šä¹‰é¡ºåºé‡æ–°æ’åˆ—åˆ—
      const orderedColumns = [];
      groupOrder.forEach(group => {
        if (groupedColumns[group] && groupedColumns[group].length > 0) {
          orderedColumns.push(...groupedColumns[group]);
        }
      });
      
      return orderedColumns;
    }

    function generateTableHeader(columns) {
      const orderedColumns = getOrderedColumns(columns);
      
      // æŒ‰åˆ†ç»„ç»Ÿè®¡åˆ—æ•°
      const groupCounts = {};
      orderedColumns.forEach(col => {
        const field = fieldMapping[col];
        if (field) {
          const group = field.group || 'å…¶ä»–';
          groupCounts[group] = (groupCounts[group] || 0) + 1;
        }
      });
      
      // å®šä¹‰åˆ†ç»„é¡ºåº
      const groupOrder = ['åŸºæœ¬ä¿¡æ¯', 'åŸºç¡€ä½“å¾', 'è¡€å‹/å‹åŠ›', 'è¿åŠ¨', 'å¥åº·çŠ¶æ€', 'è®¾å¤‡çŠ¶æ€', 'ä½ç½®ä¿¡æ¯', 'æ—¶é—´', 'å…¶ä»–'];
      
      // ç”Ÿæˆåˆ†ç»„è¡¨å¤´
      const groupHeaderRow = groupOrder.filter(group => groupCounts[group]).map(group => 
        `<th colspan="${groupCounts[group]}">${group}</th>`
      ).join('');
      
      // ç”Ÿæˆå­—æ®µè¡¨å¤´
      const fieldHeaderRow = orderedColumns.map(col => {
        const field = fieldMapping[col];
        return field ? `<th>${field.title}</th>` : `<th>${col}</th>`;
      }).join('');
      
      return `
        <tr style="background:#181c2f;font-size:15px;">
          ${groupHeaderRow}
        </tr>
        <tr>
          ${fieldHeaderRow}
        </tr>
      `;
    }
    
    async function loadHealthData(page=1,size=100){
      try{
        showLoading();
        const startDate=document.getElementById('startDate').value||'',endDate=document.getElementById('endDate').value||'';
        const url=`/health_data/page?orgId=${deptId}&userId=${userId}&startDate=${startDate}&endDate=${endDate}&page=${page}&pageSize=${size}`;
        const res=await fetch(url);
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        const json=await res.json();
        console.log('APIå“åº”:',json);
        
        if(json.success&&json.data){
          // æ›´æ–°å¯ç”¨çš„æŒ‡æ ‡
          enabledMetrics = json.data.enabledMetrics || [];
          console.log('å¯ç”¨çš„æŒ‡æ ‡:', enabledMetrics);
          
          // æ„å»ºåŠ¨æ€åˆ—
          currentColumns = buildDynamicColumns(enabledMetrics);
          console.log('å½“å‰æ˜¾ç¤ºåˆ—:', currentColumns);
          
          // ç”ŸæˆåŠ¨æ€è¡¨å¤´å¹¶è·å–æ’åºåçš„åˆ—
          const headerHtml = generateTableHeader(currentColumns);
          document.getElementById('tableHead').innerHTML = headerHtml;
          
          // æ›´æ–°currentColumnsä¸ºæ’åºåçš„é¡ºåº
          currentColumns = getOrderedColumns(currentColumns);
          
          allData=json.data.healthData||[];
          if(allData.length===0){showEmpty();return;}
          renderHealthData(allData);
          const pg=json.data.pagination||{};
          currentPage=pg.currentPage||1;totalPages=pg.totalPages||1;pageSize=pg.pageSize||size;
          syncPaginationData();
          showTable();
        }else{
          console.error('æ¥å£é”™è¯¯:',json);
          showError(json.error||'æ•°æ®åŠ è½½å¤±è´¥');
        }
      }catch(err){
        console.error('è¯·æ±‚å¤±è´¥:',err);
        showError(`ç½‘ç»œé”™è¯¯: ${err.message}`);
      }
    }
    
    function renderHealthData(data){
      const tbody=document.getElementById('healthDataBody');
      tbody.innerHTML=data.map(d=>{
        return `<tr>
          ${currentColumns.map(col => {
            const field = fieldMapping[col];
            // ä½¿ç”¨å…¼å®¹æ˜ å°„è·å–å­—æ®µå€¼
            let value = getFieldValue(d, col);
            if (value === null || value === undefined) {
              value = d[col] || '-'; // å›é€€åˆ°ç›´æ¥å­—æ®µè®¿é—®
            }
            let cellClass = '';
            
            // å¤„ç†æ•°å€¼å­—æ®µ
            if (field && field.isNum && value !== '-' && value !== null) {
              const numValue = +value;
              cellClass = 'num';
              
              // æ£€æŸ¥è­¦å‘Šæ¡ä»¶
              if (field.warn && field.warn(numValue)) {
                cellClass += ' warn';
              }
              
              // æ ¼å¼åŒ–æ•°å€¼æ˜¾ç¤º
              if (numValue !== 0) {
                value = numValue;
              }
            } else if (field && field.isNum) {
              cellClass = 'num';
            }
            
            return `<td class="${cellClass}">${value}</td>`;
          }).join('')}
        </tr>`;
      }).join('');
    }
    
    function syncPagination(isTop){
      const suffix=isTop?'Top':'';
      document.getElementById(`prevPage${suffix}`).onclick=()=>{if(currentPage>1)loadHealthData(currentPage-1,pageSize);};
      document.getElementById(`nextPage${suffix}`).onclick=()=>{if(currentPage<totalPages)loadHealthData(currentPage+1,pageSize);};
      document.getElementById(`pageSizeSelect${suffix}`).onchange=e=>{pageSize=+e.target.value;loadHealthData(1,pageSize);};
      document.getElementById(`currentPage${suffix}`).onchange=e=>{const v=+e.target.value;if(v>=1&&v<=totalPages)loadHealthData(v,pageSize);};
      document.getElementById(`jumpBtn${suffix}`).onclick=()=>{const v=+document.getElementById(`jumpPage${suffix}`).value;if(v>=1&&v<=totalPages)loadHealthData(v,pageSize);};
      document.getElementById(`jumpPage${suffix}`).onkeydown=e=>{if(e.key==='Enter'){const v=+e.target.value;if(v>=1&&v<=totalPages)loadHealthData(v,pageSize);}};
    }
    syncPagination(true);syncPagination(false);
    
    function syncPaginationData(){
      ['','Top'].forEach(suffix=>{
        document.getElementById(`currentPage${suffix}`).value=currentPage;
        document.getElementById(`totalPages${suffix}`).innerText=`/ ${totalPages}`;
        document.getElementById(`pageSizeSelect${suffix}`).value=pageSize;
        document.getElementById(`prevPage${suffix}`).disabled=currentPage<=1;
        document.getElementById(`nextPage${suffix}`).disabled=currentPage>=totalPages;
      });
    }
    
    document.getElementById('dateSearchBtn').onclick=()=>loadHealthData(1,pageSize);
    
    document.getElementById('exportExcelBtn').onclick=function(){
      console.log('ğŸ”„ å¼€å§‹å¯¼å‡ºExcel...');
      console.log('ğŸ“Š å½“å‰æ•°æ®é‡:', allData.length);
      console.log('ğŸ“‹ å½“å‰åˆ—:', currentColumns);
      
      if(allData.length===0){
        console.log('âŒ æ— æ•°æ®å¯å¯¼å‡º');
        showCustomAlert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
        return;
      }
      
      // æ£€æŸ¥XLSXåº“æ˜¯å¦åŠ è½½
      if(typeof XLSX === 'undefined'){
        console.error('âŒ XLSXåº“æœªåŠ è½½');
        showCustomAlert('Excelå¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      console.log('âœ… XLSXåº“å·²åŠ è½½');
      
      try{
        console.log('ğŸ”§ å¼€å§‹æ„å»ºExcelæ•°æ®...');
        
        // ä½¿ç”¨åŠ¨æ€åˆ—æ„å»ºExcelè¡¨å¤´å’Œæ•°æ®
        const headers = currentColumns.map(col => {
          const field = fieldMapping[col];
          return field ? field.title.replace(/<[^>]*>/g, '') : col; // ç§»é™¤HTMLæ ‡ç­¾
        });
        console.log('ğŸ“‘ è¡¨å¤´:', headers);
        
        const rows = allData.map(d => 
          currentColumns.map(col => {
            // ä½¿ç”¨å…¼å®¹æ˜ å°„è·å–å­—æ®µå€¼
            let value = getFieldValue(d, col);
            if (value === null || value === undefined) {
              value = d[col] || ''; // å›é€€åˆ°ç›´æ¥å­—æ®µè®¿é—®
            }
            return value;
          })
        );
        console.log('ğŸ“Š æ•°æ®è¡Œæ•°:', rows.length);
        
        console.log('ğŸ”§ åˆ›å»ºå·¥ä½œè¡¨...');
        const ws=XLSX.utils.aoa_to_sheet([headers,...rows]);
        console.log('ğŸ“‹ å·¥ä½œè¡¨åˆ›å»ºæˆåŠŸ');
        
        console.log('ğŸ”§ åˆ›å»ºå·¥ä½œç°¿...');
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'å¥åº·æ•°æ®');
        console.log('ğŸ“š å·¥ä½œç°¿åˆ›å»ºæˆåŠŸ');
        
        const now=new Date();
        const fileName=`å¥åº·æ•°æ®_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.xlsx`;
        console.log('ğŸ’¾ å¼€å§‹å†™å…¥æ–‡ä»¶:', fileName);
        
        XLSX.writeFile(wb,fileName);
        console.log('âœ… å¯¼å‡ºæˆåŠŸ:', fileName);
        showCustomAlert('å¯¼å‡ºæˆåŠŸ!');
      }catch(err){
        console.error('âŒ å¯¼å‡ºå¤±è´¥:', err);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', err.message);
        console.error('âŒ é”™è¯¯å †æ ˆ:', err.stack);
        showCustomAlert(`å¯¼å‡ºå¤±è´¥: ${err.message}`);
      }
    };
    
    window.onload=function(){
      console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
      
      // æ£€æŸ¥XLSXåº“æ˜¯å¦åŠ è½½æˆåŠŸ
      if(typeof XLSX !== 'undefined'){
        console.log('âœ… XLSXåº“åŠ è½½æˆåŠŸ, ç‰ˆæœ¬:', XLSX.version || 'unknown');
      } else {
        console.error('âŒ XLSXåº“æœªåŠ è½½');
      }
      
      // æ£€æŸ¥jQueryæ˜¯å¦åŠ è½½
      if(typeof $ !== 'undefined'){
        console.log('âœ… jQueryåŠ è½½æˆåŠŸ');
      } else {
        console.error('âŒ jQueryæœªåŠ è½½');
      }
      
      const today=new Date(),y=today.getFullYear(),m=(today.getMonth()+1).toString().padStart(2,'0'),d=today.getDate().toString().padStart(2,'0');
      document.getElementById('startDate').value=`${y}-${m}-01`;
      document.getElementById('endDate').value=`${y}-${m}-${d}`;
      loadHealthData(1,pageSize);
    };
  </script>
</body>
</html>