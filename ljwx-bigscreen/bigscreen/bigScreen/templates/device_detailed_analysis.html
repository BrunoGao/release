<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æ·±åº¦åˆ†æä¸­å¿ƒ</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; 
            background: linear-gradient(135deg, #0c1426 0%, #1a2332 50%, #0f1419 100%);
            color: #fff; 
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* é¡µé¢å®¹å™¨ */
        .page-container {
            padding: 20px;
            max-width: 1920px;
            margin: 0 auto;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .nav-header {
            background: linear-gradient(135deg, rgba(0,228,255,0.1) 0%, rgba(0,168,255,0.05) 100%);
            border: 1px solid rgba(0,228,255,0.3);
            border-radius: 12px;
            padding: 15px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-title {
            color: #00e4ff;
            font-size: 24px;
            font-weight: 600;
        }
        
        .nav-controls {
            display: flex;
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-label {
            font-size: 12px;
            color: #7ecfff;
        }
        
        .control-select {
            background: rgba(0,228,255,0.1);
            border: 1px solid rgba(0,228,255,0.3);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* æ¦‚è§ˆå¡ç‰‡ */
        .overview-section {
            grid-column: span 2;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .overview-card {
            background: linear-gradient(135deg, rgba(1,19,38,0.9) 0%, rgba(0,33,64,0.7) 100%);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .overview-card:hover {
            border-color: rgba(0,228,255,0.4);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,228,255,0.2);
        }
        
        .overview-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .overview-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 0 15px currentColor;
        }
        
        .overview-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .overview-trend {
            font-size: 12px;
            opacity: 0.6;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: linear-gradient(135deg, rgba(1,19,38,0.9) 0%, rgba(0,33,64,0.7) 100%);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00e4ff, #0099ff);
            opacity: 0.8;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            color: #00e4ff;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-options {
            display: flex;
            gap: 10px;
        }
        
        .chart-btn {
            background: rgba(0,228,255,0.1);
            border: 1px solid rgba(0,228,255,0.3);
            color: #7ecfff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chart-btn.active {
            background: rgba(0,228,255,0.3);
            color: #00e4ff;
        }
        
        .chart-content {
            height: 300px;
            width: 100%;
        }
        
        /* è¯¦ç»†åˆ†æåŒºåŸŸ */
        .detailed-analysis {
            grid-column: span 2;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            background: rgba(1,19,38,0.9);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .table-header {
            background: linear-gradient(90deg, rgba(0,228,255,0.2), rgba(0,168,255,0.1));
            padding: 15px;
            border-bottom: 1px solid rgba(0,228,255,0.2);
        }
        
        .table-title {
            color: #00e4ff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0,228,255,0.1);
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: rgba(0,228,255,0.05);
        }
        
        .table-cell {
            font-size: 13px;
            color: #fff;
        }
        
        .table-cell.status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online { background: #52c41a; }
        .status-offline { background: #f5222d; }
        .status-charging { background: #1890ff; }
        .status-low-battery { background: #fa8c16; }
        
        /* ä¾§è¾¹æ ç»Ÿè®¡ */
        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .stat-panel {
            background: linear-gradient(135deg, rgba(1,19,38,0.9) 0%, rgba(0,33,64,0.7) 100%);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-panel-title {
            color: #00e4ff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,228,255,0.1);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 13px;
            color: #fff;
        }
        
        .stat-value {
            font-size: 13px;
            font-weight: bold;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0,228,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00e4ff, #0099ff);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .overview-section {
                grid-column: span 1;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .detailed-analysis {
                grid-column: span 1;
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="nav-header">
            <div class="nav-title">ğŸ” è®¾å¤‡æ·±åº¦åˆ†æä¸­å¿ƒ</div>
            <div class="nav-controls">
                <div class="control-group">
                    <div class="control-label">è®¾å¤‡ç­›é€‰</div>
                    <select class="control-select" id="deviceFilter">
                        <option value="all">å…¨éƒ¨è®¾å¤‡</option>
                        <option value="online">åœ¨çº¿è®¾å¤‡</option>
                        <option value="offline">ç¦»çº¿è®¾å¤‡</option>
                        <option value="low-battery">ä½ç”µé‡è®¾å¤‡</option>
                        <option value="charging">å……ç”µè®¾å¤‡</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label">æ—¶é—´èŒƒå›´</div>
                    <select class="control-select" id="timeRange">
                        <option value="1h">è¿‘1å°æ—¶</option>
                        <option value="6h">è¿‘6å°æ—¶</option>
                        <option value="24h" selected>è¿‘24å°æ—¶</option>
                        <option value="7d">è¿‘7å¤©</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label">åˆ†æç»´åº¦</div>
                    <select class="control-select" id="analysisType">
                        <option value="overview">æ€»è§ˆåˆ†æ</option>
                        <option value="battery">ç”µæ± åˆ†æ</option>
                        <option value="usage">ä½¿ç”¨åˆ†æ</option>
                        <option value="health">å¥åº·åˆ†æ</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-grid">
            <!-- æ¦‚è§ˆç»Ÿè®¡ -->
            <div class="overview-section">
                <div class="overview-card">
                    <div class="overview-icon">ğŸ“±</div>
                    <div class="overview-number stat-primary" id="totalDevices">0</div>
                    <div class="overview-label">è®¾å¤‡æ€»æ•°</div>
                    <div class="overview-trend" id="deviceTrend">è¾ƒæ˜¨æ—¥ --</div>
                </div>
                
                <div class="overview-card">
                    <div class="overview-icon">âš¡</div>
                    <div class="overview-number stat-info" id="avgBattery">0%</div>
                    <div class="overview-label">å¹³å‡ç”µé‡</div>
                    <div class="overview-trend" id="batteryTrend">è¾ƒæ˜¨æ—¥ --</div>
                </div>
                
                <div class="overview-card">
                    <div class="overview-icon">â±ï¸</div>
                    <div class="overview-number stat-warning" id="avgUsage">0h</div>
                    <div class="overview-label">æ—¥å‡ä½¿ç”¨</div>
                    <div class="overview-trend" id="usageTrend">è¾ƒæ˜¨æ—¥ --</div>
                </div>
                
                <div class="overview-card">
                    <div class="overview-icon">ğŸ’š</div>
                    <div class="overview-number stat-positive" id="healthScore">0</div>
                    <div class="overview-label">å¥åº·è¯„åˆ†</div>
                    <div class="overview-trend" id="healthTrend">è¾ƒæ˜¨æ—¥ --</div>
                </div>
            </div>
            
            <!-- ç”µæ± åˆ†æå›¾è¡¨ -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span>ğŸ”‹</span>
                        ç”µæ± çŠ¶æ€åˆ†æ
                    </div>
                    <div class="chart-options">
                        <button class="chart-btn active" onclick="switchBatteryView('level')">ç”µé‡åˆ†å¸ƒ</button>
                        <button class="chart-btn" onclick="switchBatteryView('health')">å¥åº·åº¦</button>
                        <button class="chart-btn" onclick="switchBatteryView('cycles')">å……ç”µå‘¨æœŸ</button>
                    </div>
                </div>
                <div class="chart-content" id="batteryAnalysisChart"></div>
            </div>
            
            <!-- ä½¿ç”¨è¡Œä¸ºåˆ†æ -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span>ğŸ“Š</span>
                        ä½¿ç”¨è¡Œä¸ºåˆ†æ
                    </div>
                    <div class="chart-options">
                        <button class="chart-btn active" onclick="switchUsageView('daily')">æ—¥ä½¿ç”¨</button>
                        <button class="chart-btn" onclick="switchUsageView('weekly')">å‘¨ä½¿ç”¨</button>
                        <button class="chart-btn" onclick="switchUsageView('pattern')">ä½¿ç”¨æ¨¡å¼</button>
                    </div>
                </div>
                <div class="chart-content" id="usageAnalysisChart"></div>
            </div>
            
            <!-- è¯¦ç»†è®¾å¤‡æ•°æ® -->
            <div class="detailed-analysis">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">ğŸ·ï¸ è®¾å¤‡è¯¦ç»†ä¿¡æ¯</div>
                    </div>
                    <div class="table-content">
                        <div class="table-row" style="font-weight: bold; background: rgba(0,228,255,0.1);">
                            <div class="table-cell">è®¾å¤‡ç¼–å·</div>
                            <div class="table-cell">çŠ¶æ€</div>
                            <div class="table-cell">ç”µé‡</div>
                            <div class="table-cell">æœ€åæ›´æ–°</div>
                        </div>
                        <div id="deviceTableBody">
                            <!-- è®¾å¤‡æ•°æ®å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
                
                <!-- ä¾§è¾¹æ ç»Ÿè®¡ -->
                <div class="sidebar-stats">
                    <!-- çŠ¶æ€ç»Ÿè®¡ -->
                    <div class="stat-panel">
                        <div class="stat-panel-title">
                            <span>ğŸ“ˆ</span>
                            çŠ¶æ€ç»Ÿè®¡
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">åœ¨çº¿ç‡</span>
                            <span class="stat-value stat-positive" id="onlineRate">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="onlineProgress" style="width: 0%"></div>
                        </div>
                        
                        <div class="stat-item">
                            <span class="stat-label">ä½©æˆ´ç‡</span>
                            <span class="stat-value stat-info" id="wearRate">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="wearProgress" style="width: 0%"></div>
                        </div>
                        
                        <div class="stat-item">
                            <span class="stat-label">å……ç”µç‡</span>
                            <span class="stat-value stat-warning" id="chargeRate">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="chargeProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- ç‰ˆæœ¬åˆ†å¸ƒ -->
                    <div class="stat-panel">
                        <div class="stat-panel-title">
                            <span>ğŸ’»</span>
                            ç‰ˆæœ¬åˆ†å¸ƒ
                        </div>
                        <div id="versionStats">
                            <!-- ç‰ˆæœ¬ç»Ÿè®¡å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                    
                    <!-- å‘Šè­¦ä¿¡æ¯ -->
                    <div class="stat-panel">
                        <div class="stat-panel-title">
                            <span>ğŸš¨</span>
                            è®¾å¤‡å‘Šè­¦
                        </div>
                        <div id="alertStats">
                            <!-- å‘Šè­¦ç»Ÿè®¡å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const charts = {};
        let currentData = null;
        let currentFilter = 'all';
        let currentTimeRange = '24h';
        let currentAnalysisType = 'overview';
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            charts.batteryAnalysis = echarts.init(document.getElementById('batteryAnalysisChart'));
            charts.usageAnalysis = echarts.init(document.getElementById('usageAnalysisChart'));
        }
        
        // è·å–è®¾å¤‡åˆ†ææ•°æ®
        async function fetchAnalysisData() {
            try {
                const response = await fetch(`/api/devices/analysis?orgId=1&timeRange=${currentTimeRange}&filter=${currentFilter}`);
                const result = await response.json();
                return result.success ? result.data : generateMockAnalysisData();
            } catch (error) {
                console.error('è·å–åˆ†ææ•°æ®å¤±è´¥:', error);
                return generateMockAnalysisData();
            }
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†ææ•°æ®
        function generateMockAnalysisData() {
            const deviceCount = 1076;
            return {
                overview: {
                    totalDevices: deviceCount,
                    avgBattery: 78,
                    avgUsage: 8.5,
                    healthScore: 87,
                    trends: {
                        device: '+12å°',
                        battery: '+3%',
                        usage: '+0.2h',
                        health: '+2åˆ†'
                    }
                },
                devices: Array.from({length: 50}, (_, i) => ({
                    sn: `WS${String(i + 1).padStart(4, '0')}`,
                    status: Math.random() > 0.15 ? 'online' : 'offline',
                    battery: Math.floor(Math.random() * 80) + 20,
                    lastUpdate: new Date(Date.now() - Math.random() * 3600000).toLocaleString()
                })),
                statistics: {
                    onlineRate: 89.5,
                    wearRate: 76.3,
                    chargeRate: 12.8
                },
                versions: {
                    'v2.1.0': 45,
                    'v2.0.8': 32,
                    'v2.0.6': 18,
                    'v1.9.2': 5
                },
                alerts: [
                    { type: 'ä½ç”µé‡', count: 24, level: 'warning' },
                    { type: 'ç¦»çº¿è®¾å¤‡', count: 8, level: 'error' },
                    { type: 'ä¼ æ„Ÿå™¨å¼‚å¸¸', count: 3, level: 'error' },
                    { type: 'å……ç”µå¼‚å¸¸', count: 12, level: 'warning' }
                ]
            };
        }
        
        // æ›´æ–°æ¦‚è§ˆç»Ÿè®¡
        function updateOverview(data) {
            const { overview } = data;
            
            document.getElementById('totalDevices').textContent = overview.totalDevices;
            document.getElementById('avgBattery').textContent = overview.avgBattery + '%';
            document.getElementById('avgUsage').textContent = overview.avgUsage + 'h';
            document.getElementById('healthScore').textContent = overview.healthScore;
            
            document.getElementById('deviceTrend').textContent = `è¾ƒæ˜¨æ—¥ ${overview.trends.device}`;
            document.getElementById('batteryTrend').textContent = `è¾ƒæ˜¨æ—¥ ${overview.trends.battery}`;
            document.getElementById('usageTrend').textContent = `è¾ƒæ˜¨æ—¥ ${overview.trends.usage}`;
            document.getElementById('healthTrend').textContent = `è¾ƒæ˜¨æ—¥ ${overview.trends.health}`;
        }
        
        // æ›´æ–°ç”µæ± åˆ†æå›¾è¡¨
        function updateBatteryChart(data, viewType = 'level') {
            const options = {
                level: {
                    title: 'ç”µé‡åˆ†å¸ƒ',
                    data: [
                        { name: '0-20%', value: 24, itemStyle: { color: '#f5222d' } },
                        { name: '21-50%', value: 156, itemStyle: { color: '#fa8c16' } },
                        { name: '51-80%', value: 432, itemStyle: { color: '#faad14' } },
                        { name: '81-100%', value: 464, itemStyle: { color: '#52c41a' } }
                    ]
                },
                health: {
                    title: 'ç”µæ± å¥åº·åº¦',
                    data: [
                        { name: 'ä¼˜ç§€', value: 650, itemStyle: { color: '#52c41a' } },
                        { name: 'è‰¯å¥½', value: 320, itemStyle: { color: '#faad14' } },
                        { name: 'ä¸€èˆ¬', value: 86, itemStyle: { color: '#fa8c16' } },
                        { name: 'è¾ƒå·®', value: 20, itemStyle: { color: '#f5222d' } }
                    ]
                },
                cycles: {
                    title: 'å……ç”µå‘¨æœŸåˆ†å¸ƒ',
                    data: [
                        { name: '0-100æ¬¡', value: 180, itemStyle: { color: '#52c41a' } },
                        { name: '101-300æ¬¡', value: 420, itemStyle: { color: '#faad14' } },
                        { name: '301-500æ¬¡', value: 356, itemStyle: { color: '#fa8c16' } },
                        { name: '500+æ¬¡', value: 120, itemStyle: { color: '#f5222d' } }
                    ]
                }
            };
            
            const config = options[viewType];
            
            charts.batteryAnalysis.setOption({
                title: {
                    text: config.title,
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#00e4ff',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '60%'],
                    data: config.data,
                    label: {
                        show: true,
                        color: '#fff'
                    }
                }]
            });
        }
        
        // æ›´æ–°ä½¿ç”¨è¡Œä¸ºå›¾è¡¨
        function updateUsageChart(data, viewType = 'daily') {
            const hourData = Array.from({length: 24}, (_, i) => ({
                hour: i,
                usage: Math.floor(Math.random() * 200) + 50 + (i >= 8 && i <= 18 ? 100 : 0)
            }));
            
            charts.usageAnalysis.setOption({
                title: {
                    text: viewType === 'daily' ? '24å°æ—¶ä½¿ç”¨åˆ†å¸ƒ' : 'ä½¿ç”¨æ¨¡å¼åˆ†æ',
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#00e4ff',
                    textStyle: { color: '#fff' }
                },
                grid: { left: '10%', right: '10%', bottom: '15%', top: '20%' },
                xAxis: {
                    type: 'category',
                    data: hourData.map(d => d.hour + ':00'),
                    axisLabel: { color: '#7ecfff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#7ecfff' },
                    splitLine: { lineStyle: { color: 'rgba(0,228,255,0.1)' } }
                },
                series: [{
                    type: 'bar',
                    data: hourData.map(d => d.usage),
                    itemStyle: { color: '#1890ff' },
                    emphasis: { itemStyle: { color: '#40a9ff' } }
                }]
            });
        }
        
        // æ›´æ–°è®¾å¤‡è¡¨æ ¼
        function updateDeviceTable(data) {
            const tbody = document.getElementById('deviceTableBody');
            const devices = data.devices.slice(0, 20); // æ˜¾ç¤ºå‰20å°è®¾å¤‡
            
            tbody.innerHTML = devices.map(device => `
                <div class="table-row">
                    <div class="table-cell">${device.sn}</div>
                    <div class="table-cell status">
                        <div class="status-dot status-${device.status}"></div>
                        ${device.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                    </div>
                    <div class="table-cell">${device.battery}%</div>
                    <div class="table-cell">${device.lastUpdate}</div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡
        function updateSidebarStats(data) {
            const { statistics, versions, alerts } = data;
            
            // çŠ¶æ€ç»Ÿè®¡
            document.getElementById('onlineRate').textContent = statistics.onlineRate + '%';
            document.getElementById('wearRate').textContent = statistics.wearRate + '%';
            document.getElementById('chargeRate').textContent = statistics.chargeRate + '%';
            
            document.getElementById('onlineProgress').style.width = statistics.onlineRate + '%';
            document.getElementById('wearProgress').style.width = statistics.wearRate + '%';
            document.getElementById('chargeProgress').style.width = statistics.chargeRate + '%';
            
            // ç‰ˆæœ¬åˆ†å¸ƒ
            const versionStats = document.getElementById('versionStats');
            versionStats.innerHTML = Object.entries(versions).map(([version, count]) => `
                <div class="stat-item">
                    <span class="stat-label">${version}</span>
                    <span class="stat-value stat-primary">${count}%</span>
                </div>
            `).join('');
            
            // å‘Šè­¦ç»Ÿè®¡
            const alertStats = document.getElementById('alertStats');
            alertStats.innerHTML = alerts.map(alert => `
                <div class="stat-item">
                    <span class="stat-label">${alert.type}</span>
                    <span class="stat-value ${alert.level === 'error' ? 'stat-negative' : 'stat-warning'}">${alert.count}</span>
                </div>
            `).join('');
        }
        
        // åˆ‡æ¢ç”µæ± è§†å›¾
        function switchBatteryView(viewType) {
            document.querySelectorAll('#batteryAnalysisChart').forEach(chart => {
                chart.parentNode.querySelectorAll('.chart-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            event.target.classList.add('active');
            
            if (currentData) {
                updateBatteryChart(currentData, viewType);
            }
        }
        
        // åˆ‡æ¢ä½¿ç”¨è§†å›¾
        function switchUsageView(viewType) {
            document.querySelectorAll('#usageAnalysisChart').forEach(chart => {
                chart.parentNode.querySelectorAll('.chart-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            event.target.classList.add('active');
            
            if (currentData) {
                updateUsageChart(currentData, viewType);
            }
        }
        
        // æ›´æ–°åˆ†ææ•°æ®
        async function updateAnalysis() {
            const data = await fetchAnalysisData();
            if (data) {
                currentData = data;
                updateOverview(data);
                updateBatteryChart(data);
                updateUsageChart(data);
                updateDeviceTable(data);
                updateSidebarStats(data);
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        document.getElementById('deviceFilter').addEventListener('change', (e) => {
            currentFilter = e.target.value;
            updateAnalysis();
        });
        
        document.getElementById('timeRange').addEventListener('change', (e) => {
            currentTimeRange = e.target.value;
            updateAnalysis();
        });
        
        document.getElementById('analysisType').addEventListener('change', (e) => {
            currentAnalysisType = e.target.value;
            updateAnalysis();
        });
        
        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            Object.values(charts).forEach(chart => chart.resize());
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateAnalysis();
            
            // æ¯30ç§’è‡ªåŠ¨æ›´æ–°
            setInterval(updateAnalysis, 30000);
        });
    </script>
</body>
</html> 