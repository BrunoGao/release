<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è®¾å¤‡ç®¡ç†</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* è®¾å¤‡å¡ç‰‡ç½‘æ ¼å®¹å™¨ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* å›¾è¡¨ç½‘æ ¼å®¹å™¨ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            height: 300px;
        }

        /* è®¾å¤‡å¡ç‰‡æ ·å¼ */
        .device-card {
            background: rgba(37, 39, 41, 0.95);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .device-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 228, 255, 0.5);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-inactive {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .device-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .info-label {
            color: rgba(0, 228, 255, 0.6);
            min-width: 90px;
        }

        .device-status {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .battery-low {
            color: red;
            font-weight: bold;
          }
          
          .battery-high {
            color: green;
            font-weight: bold;
          }
          
          .battery-normal {
            color: #666;
          }
          .battery-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .battery-visual {
            position: relative;
            width: 100px;
            height: 16px;
            border: 1px solid #999;
            border-radius: 4px;
            background-color: #f2f2f2;
            overflow: hidden;
            display: flex;
            align-items: center;
          }
          
          .battery-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
          }
          
          .battery-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #333;
          }
          
          /* çŠ¶æ€é¢œè‰² */
          .battery-low .battery-bar {
            background-color: red;
          }
          
          .battery-high .battery-bar {
            background-color: green;
          }
          
          .battery-normal .battery-bar {
            background-color: orange;
          }
          
          /* å‘¼å¸åŠ¨æ•ˆï¼ˆä»…å……ç”µä¸­ï¼‰ */
          .battery-visual.charging .battery-bar {
            animation: pulse 1.5s infinite;
          }
          
          @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
          }
          .filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-bar select {
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 228, 255, 0.4);
            color: #00e4ff;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-bar select:focus {
            outline: none;
            border-color: #00e4ff;
            box-shadow: 0 0 4px rgba(0, 228, 255, 0.8);
        }
        
        .filter-bar select:hover {
            border-color: #00e4ff;
            background: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body>
    <!-- ç­›é€‰å™¨ -->
    <div class="filter-bar">
        <select id="filterStatus" onchange="updateDashboard()">
        <option value="">è®¾å¤‡çŠ¶æ€(å…¨éƒ¨)</option>
        <option value="ACTIVE">åœ¨çº¿</option>
        <option value="INACTIVE">ç¦»çº¿</option>
        </select>
        <select id="filterCharging" onchange="updateDashboard()">
        <option value="">å……ç”µçŠ¶æ€(å…¨éƒ¨)</option>
        <option value="CHARGING">å……ç”µä¸­</option>
        <option value="NOT_CHARGING">æœªå……ç”µ</option>
        </select>
        <select id="filterWearable" onchange="updateDashboard()">
        <option value="">ä½©æˆ´çŠ¶æ€(å…¨éƒ¨)</option>
        <option value="WORN">å·²ä½©æˆ´</option>
        <option value="NOT_WORN">æœªä½©æˆ´</option>
        </select>
    </div>
    <div class="container">
        <!-- è®¾å¤‡å¡ç‰‡åˆ—è¡¨ -->
        <div class="cards-container" id="deviceCards"></div>

        <!-- ç»Ÿè®¡å›¾è¡¨ -->
        <div class="charts-grid">
            <div class="chart-container">
                <div id="deptDeviceChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="deviceStatusChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="chargingStatusChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="wearableStatusChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="systemVersionChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        const chartInstances = new Map();

        async function fetchDeviceInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1'; // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œé»˜è®¤ä½¿ç”¨ '1'
                const deptId = urlParams.get('deptId') || ''; // è·å–éƒ¨é—¨ID
                const userId = urlParams.get('userId') || ''; // è·å–ç”¨æˆ·ID

                // æ„å»ºURLï¼Œä½¿ç”¨ deptId ä½œä¸º orgIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ customerId
                const orgId = deptId || customerId;
                let url = `/get_devices_by_orgIdAndUserId?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    return result.data;
                }
                throw new Error('Failed to fetch device data');
            } catch (error) {
                console.error('Error fetching device data:', error);
                return null;
            }
        }

        function displayDevices(devices) {
            const container = document.getElementById('deviceCards');
            container.innerHTML = devices.map(device => {
              const battery = parseInt(device.battery_level);
              const charging = device.charging_status === 'CHARGING';
          
              let batteryClass = 'battery-normal';
              if (battery < 20) {
                batteryClass = 'battery-low';
              } else if (battery >= 80) {
                batteryClass = 'battery-high';
              }
          
              return `
                <div class="device-card">
                  <div class="device-status">
                    <span class="status-badge ${device.status === 'ACTIVE' ? 'status-active' : 'status-inactive'}">
                      ${device.status === 'ACTIVE' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                    </span>
                    <span class="status-badge ${device.wearable_status === 'WORN' ? 'status-active' : 'status-inactive'}">
                      ${device.wearable_status === 'WORN' ? 'å·²ä½©æˆ´' : 'æœªä½©æˆ´'}
                    </span>
                  </div>
                  <div class="device-info">
                    <div class="info-item">
                      <span class="info-label">è®¾å¤‡ç¼–å·:</span>
                      <span>${device.serial_number}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">æ‰€å±éƒ¨é—¨:</span>
                      <span>${device.department_name}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">ä½¿ç”¨äººå‘˜:</span>
                      <span>${device.user_name}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">å……ç”µçŠ¶æ€:</span>
                      <span>${charging ? 'ğŸ”Œ å……ç”µä¸­' : 'æœªå……ç”µ'}</span>
                    </div>
                    <div class="info-item battery-bar-container">
                      <span class="info-label">ç”µæ± ç”µé‡:</span>
                      <div class="battery-visual ${batteryClass} ${charging ? 'charging' : ''}">
                        <div class="battery-bar" style="width: ${battery}%;"></div>
                        <span class="battery-text">${battery}%</span>
                      </div>
                    </div>
                    <div class="info-item">
                      <span class="info-label">ç³»ç»Ÿç‰ˆæœ¬:</span>
                      <span>${device.system_software_version}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">æ›´æ–°æ—¶é—´:</span>
                      <span>${device.update_time}</span>
                    </div>
                  </div>
                </div>
              `;
            }).join('');
          }

        function updateCharts(data) {
            // éƒ¨é—¨è®¾å¤‡åˆ†å¸ƒå›¾
            const deptDeviceChart = chartInstances.get('deptDeviceChart');
            deptDeviceChart.setOption({
                title: { text: 'éƒ¨é—¨è®¾å¤‡åˆ†å¸ƒ', textStyle: { color: '#fff' } },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: Object.entries(data.departmentDeviceCount).map(([name, value]) => ({
                        name, value
                    })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            });

            // è®¾å¤‡çŠ¶æ€åˆ†å¸ƒå›¾
            const deviceStatusChart = chartInstances.get('deviceStatusChart');
            deviceStatusChart.setOption({
                title: { text: 'è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ', textStyle: { color: '#fff' } },
                tooltip: { 
                    trigger: 'axis',
                    formatter: '{b}: {c}å°'
                },
                xAxis: { 
                    type: 'category', 
                    data: ['åœ¨çº¿', 'ç¦»çº¿'],
                    axisLabel: { color: '#fff' }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'bar',
                    data: [
                        {
                            value: data.deviceStatusCount.ACTIVE || 0,
                            itemStyle: { color: '#00e4ff' }  // äº®è“è‰²è¡¨ç¤ºåœ¨çº¿
                        },
                        {
                            value: data.deviceStatusCount.INACTIVE || 0,
                            itemStyle: { color: '#ff4444' }  // çº¢è‰²è¡¨ç¤ºç¦»çº¿
                        }
                    ],
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å°',
                        color: '#fff'
                    },
                    barWidth: '40%'
                }]
            });

            // å……ç”µçŠ¶æ€åˆ†å¸ƒ
            updateChargingStatusChart(data.deviceChargingCount);
            // ä½©æˆ´çŠ¶æ€åˆ†å¸ƒ
            updateWearableStatusChart(data.deviceWearableCount);
            // ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒ
            updateSystemVersionChart(data.deviceSystemVersionCount);
        }

        function updateChargingStatusChart(data) {
            const chart = chartInstances.get('chargingStatusChart');
            chart.setOption({
                title: { text: 'å……ç”µçŠ¶æ€åˆ†å¸ƒ', textStyle: { color: '#fff' } },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: [
                        {
                            name: 'å……ç”µä¸­',
                            value: data.CHARGING || 0,
                            itemStyle: { color: '#00ff9d' }  // ç»¿è‰²è¡¨ç¤ºå……ç”µä¸­
                        },
                        {
                            name: 'æœªå……ç”µ',
                            value: data.NOT_CHARGING || 0,
                            itemStyle: { color: '#ffbb00' }  // é»„è‰²è¡¨ç¤ºæœªå……ç”µ
                        }
                    ],
                    label: {
                        show: true,
                        formatter: '{b}: {c}å°',
                        color: '#fff'
                    }
                }]
            });
        }

        // æ›´æ–°ä½©æˆ´çŠ¶æ€åˆ†å¸ƒå›¾
        function updateWearableStatusChart(data) {
            const chart = chartInstances.get('wearableStatusChart');
            chart.setOption({
                title: {
                    text: 'è®¾å¤‡ä½©æˆ´çŠ¶æ€åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}å°'
                    },
                    data: [
                        {
                            name: 'å·²ä½©æˆ´',
                            value: data.WORN || 0,
                            itemStyle: { color: '#00e4ff' }  // è“è‰²è¡¨ç¤ºå·²ä½©æˆ´
                        },
                        {
                            name: 'æœªä½©æˆ´',
                            value: data.NOT_WORN || 0,
                            itemStyle: { color: '#ff4444' }  // çº¢è‰²è¡¨ç¤ºæœªä½©æˆ´
                        }
                    ]
                }]
            });
        }

        // æ›´æ–°ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒå›¾
        function updateSystemVersionChart(data) {
            const chart = chartInstances.get('systemVersionChart');
            const versions = Object.entries(data).map(([version, count]) => ({
                name: version.split(' ')[0], // åªæ˜¾ç¤ºè®¾å¤‡å‹å·
                fullVersion: version,
                value: count
            }));

            // å®šä¹‰ä¸åŒç‰ˆæœ¬çš„é¢œè‰²
            const versionColors = {
                'ARC-AL00CN': '#00e4ff',  // äº®è“è‰²
                'GLL-AL30BCN': '#ff4444', // çº¢è‰²
                'default': '#ffbb00'      // é»„è‰²ï¼ˆé»˜è®¤é¢œè‰²ï¼‰
            };

            chart.setOption({
                title: {
                    text: 'ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒ',
                    textStyle: { color: '#fff' }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `${data.data.fullVersion}<br/>æ•°é‡ï¼š${data.data.value}å°`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: versions.map(v => v.name),
                    axisLabel: {
                        color: '#fff',
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' }
                },
                series: [{
                    type: 'bar',
                    data: versions.map(v => ({
                        value: v.value,
                        fullVersion: v.fullVersion,
                    itemStyle: {
                            color: versionColors[v.name] || versionColors.default
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å°',
                        color: '#fff'
                    },
                    barWidth: '40%'
                }]
            });
        }
        function aggregateDepartmentCount(devices) {
            return devices.reduce((acc, device) => {
              const dept = device.department_name || 'æœªçŸ¥éƒ¨é—¨';
              acc[dept] = (acc[dept] || 0) + 1;
              return acc;
            }, {});
          }
          
          function aggregateStatusCount(devices) {
            return devices.reduce((acc, device) => {
              acc[device.status] = (acc[device.status] || 0) + 1;
              return acc;
            }, {});
          }
          
          function aggregateChargingCount(devices) {
            return devices.reduce((acc, device) => {
              acc[device.charging_status] = (acc[device.charging_status] || 0) + 1;
              return acc;
            }, {});
          }
          
          function aggregateWearableCount(devices) {
            return devices.reduce((acc, device) => {
              acc[device.wearable_status] = (acc[device.wearable_status] || 0) + 1;
              return acc;
            }, {});
          }
          
          function aggregateSystemVersionCount(devices) {
            return devices.reduce((acc, device) => {
              const version = device.system_software_version || 'æœªçŸ¥ç‰ˆæœ¬';
              acc[version] = (acc[version] || 0) + 1;
              return acc;
            }, {});
          }

        function filterDevices(devices) {
            const statusFilter = document.getElementById('filterStatus')?.value;
            const chargingFilter = document.getElementById('filterCharging')?.value;
            const wearableFilter = document.getElementById('filterWearable')?.value;
          
            return devices.filter(device => {
              const matchStatus = !statusFilter || device.status === statusFilter;
              const matchCharging = !chargingFilter || device.charging_status === chargingFilter;
              const matchWearable = !wearableFilter || device.wearable_status === wearableFilter;
              return matchStatus && matchCharging && matchWearable;
            });
          }

        async function updateDashboard() {
            const data = await fetchDeviceInfo();
            if (data) {
                const filtered = filterDevices(data.devices);
                displayDevices(filtered);
                updateCharts({
                  departmentDeviceCount: aggregateDepartmentCount(filtered),
                  deviceStatusCount: aggregateStatusCount(filtered),
                  deviceChargingCount: aggregateChargingCount(filtered),
                  deviceWearableCount: aggregateWearableCount(filtered),
                  deviceSystemVersionCount: aggregateSystemVersionCount(filtered),
                });
            }
        }

        function initCharts() {
            const chartIds = [
                'deptDeviceChart', 'deviceStatusChart', 'chargingStatusChart',
                'wearableStatusChart', 'systemVersionChart'  // ç§»é™¤ deptDetailsChart
            ];
            
            chartIds.forEach(id => {
                chartInstances.set(id, echarts.init(document.getElementById(id)));
            });
        }

        async function initDashboard() {
            initCharts();
            await updateDashboard();
            setInterval(updateDashboard, 30000);

            window.addEventListener('resize', debounce(() => {
                chartInstances.forEach(chart => chart.resize());
            }, 250));
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html> 