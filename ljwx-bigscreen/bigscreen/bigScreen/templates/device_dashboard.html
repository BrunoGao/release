<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ‰‹è¡¨è®¾å¤‡ç›‘æ§åˆ†æä¸­å¿ƒ</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; 
            background: linear-gradient(135deg, #0c1426 0%, #1a2332 50%, #0f1419 100%);
            color: #fff; 
            overflow: hidden;
            height: 100vh;
        }
        
        /* å¤§å±å®¹å™¨ */
        .dashboard-container {
            display: grid;
            grid-template-rows: 80px 200px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header {
            background: linear-gradient(135deg, rgba(0,228,255,0.1) 0%, rgba(0,168,255,0.05) 100%);
            border: 1px solid rgba(0,228,255,0.3);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,228,255,0.1);
        }
        
        .header h1 {
            color: #00e4ff;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 0 20px rgba(0,228,255,0.5);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-time {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #00e4ff;
            text-shadow: 0 0 10px rgba(0,228,255,0.3);
        }
        
        /* ç»Ÿè®¡æ€»è§ˆåŒºåŸŸ */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            height: 100%;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(1,19,38,0.8) 0%, rgba(0,33,64,0.6) 100%);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .stat-card:hover {
            border-color: rgba(0,228,255,0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,228,255,0.15);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00e4ff, #0099ff);
            opacity: 0.8;
        }
        
        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 0 10px currentColor;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 3px;
        }
        
        .stat-change {
            font-size: 11px;
            opacity: 0.6;
        }
        
        .stat-positive { color: #52c41a; }
        .stat-negative { color: #ff4d4f; }
        .stat-neutral { color: #faad14; }
        .stat-info { color: #1890ff; }
        .stat-warning { color: #fa8c16; }
        .stat-primary { color: #00e4ff; }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            height: 100%;
        }
        
        /* å·¦ä¾§å›¾è¡¨åŒºåŸŸ */
        .charts-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
        }
        
        /* å³ä¾§è¯¦æƒ…åŒºåŸŸ */
        .details-area {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-panel {
            background: linear-gradient(135deg, rgba(1,19,38,0.8) 0%, rgba(0,33,64,0.6) 100%);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .chart-panel:hover {
            border-color: rgba(0,228,255,0.4);
            box-shadow: 0 8px 25px rgba(0,228,255,0.15);
        }
        
        .chart-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00e4ff, #0099ff);
            opacity: 0.8;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-title {
            color: #00e4ff;
            font-size: 16px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0,228,255,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-subtitle {
            font-size: 12px;
            color: #7ecfff;
            opacity: 0.8;
        }
        
        .chart-content {
            width: 100%;
            height: calc(100% - 60px);
        }
        
        /* åˆ—è¡¨é¢æ¿ */
        .list-panel {
            background: linear-gradient(135deg, rgba(1,19,38,0.8) 0%, rgba(0,33,64,0.6) 100%);
            border: 1px solid rgba(0,228,255,0.2);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .list-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00e4ff, #0099ff);
            opacity: 0.8;
        }
        
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0,228,255,0.1);
            padding-bottom: 10px;
        }
        
        .list-title {
            color: #00e4ff;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .list-content {
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        
        .list-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,228,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .list-item:hover {
            background: rgba(0,228,255,0.05);
            padding-left: 10px;
            margin-left: -10px;
            margin-right: -10px;
            padding-right: 10px;
        }
        
        .list-item-label {
            font-size: 13px;
            color: #fff;
        }
        
        .list-item-value {
            font-size: 13px;
            font-weight: bold;
        }
        
        .list-item-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .status-online { background: rgba(82, 196, 26, 0.2); color: #52c41a; }
        .status-offline { background: rgba(255, 77, 79, 0.2); color: #ff4d4f; }
        .status-charging { background: rgba(24, 144, 255, 0.2); color: #1890ff; }
        .status-low-battery { background: rgba(250, 140, 22, 0.2); color: #fa8c16; }
        .status-worn { background: rgba(250, 173, 20, 0.2); color: #faad14; }
        
        /* å®æ—¶æ•°æ®æµæ•ˆæœ */
        .data-stream {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,228,255,0.1), transparent);
            animation: dataFlow 3s linear infinite;
            pointer-events: none;
        }
        
        @keyframes dataFlow {
            0% { transform: translateX(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        
        /* å‘Šè­¦é—ªçƒæ•ˆæœ */
        .alert-blink {
            animation: alertBlink 1s ease-in-out infinite alternate;
        }
        
        @keyframes alertBlink {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .list-content::-webkit-scrollbar {
            width: 4px;
        }
        
        .list-content::-webkit-scrollbar-track {
            background: rgba(0,228,255,0.1);
        }
        
        .list-content::-webkit-scrollbar-thumb {
            background: rgba(0,228,255,0.3);
            border-radius: 2px;
        }
        
        .list-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0,228,255,0.5);
        }
        
        /* æ—¶é—´é€‰æ‹©å™¨ */
        .time-selector {
            display: flex;
            gap: 8px;
            background: rgba(0,228,255,0.1);
            border-radius: 8px;
            padding: 4px;
        }
        
        .time-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #7ecfff;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .time-btn.active {
            background: rgba(0,228,255,0.3);
            color: #00e4ff;
        }
        
        .time-btn:hover {
            background: rgba(0,228,255,0.2);
            color: #00e4ff;
        }
        
        /* è‡ªåŠ¨åˆ·æ–°æŒ‡ç¤ºå™¨ */
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #7ecfff;
        }
        
        .refresh-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #52c41a;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1920px) {
            .header h1 { font-size: 20px; }
            .stat-number { font-size: 24px; }
            .chart-title { font-size: 14px; }
        }
        
        @media (max-width: 1366px) {
            .main-content { grid-template-columns: 1fr; }
            .charts-area { grid-template-columns: 1fr 1fr; }
            .stats-overview { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="header">
            <h1>
                <span style="font-size: 28px;">âŒš</span>
                æ™ºèƒ½æ‰‹è¡¨è®¾å¤‡ç›‘æ§åˆ†æä¸­å¿ƒ
            </h1>
            <div class="header-controls">
                <div class="time-selector">
                    <button class="time-btn" onclick="changeTimeRange('1h')">1å°æ—¶</button>
                    <button class="time-btn" onclick="changeTimeRange('6h')">6å°æ—¶</button>
                    <button class="time-btn active" onclick="changeTimeRange('24h')">24å°æ—¶</button>
                    <button class="time-btn" onclick="changeTimeRange('7d')">7å¤©</button>
                </div>
                <div class="refresh-indicator">
                    <div class="refresh-dot"></div>
                    <span>è‡ªåŠ¨åˆ·æ–°</span>
                </div>
                <div class="header-time" id="currentTime"></div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡æ€»è§ˆåŒºåŸŸ -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“±</div>
                <div class="stat-number stat-primary" id="totalDevices">0</div>
                <div class="stat-label">è®¾å¤‡æ€»æ•°</div>
                <div class="stat-change" id="totalDevicesChange">è¾ƒæ˜¨æ—¥ --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸŸ¢</div>
                <div class="stat-number stat-positive" id="onlineDevices">0</div>
                <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
                <div class="stat-change" id="onlineRate">åœ¨çº¿ç‡ --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ”‹</div>
                <div class="stat-number stat-warning" id="lowBatteryDevices">0</div>
                <div class="stat-label">ä½ç”µé‡è®¾å¤‡</div>
                <div class="stat-change" id="batteryHealth">ç”µæ± å¥åº·åº¦ --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">âš¡</div>
                <div class="stat-number stat-info" id="chargingDevices">0</div>
                <div class="stat-label">å……ç”µè®¾å¤‡</div>
                <div class="stat-change" id="chargingRate">å……ç”µç‡ --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¤</div>
                <div class="stat-number stat-neutral" id="wornDevices">0</div>
                <div class="stat-label">ä½©æˆ´è®¾å¤‡</div>
                <div class="stat-change" id="wearRate">ä½©æˆ´ç‡ --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸš¨</div>
                <div class="stat-number stat-negative alert-blink" id="alertCount">0</div>
                <div class="stat-label">è®¾å¤‡å‘Šè­¦</div>
                <div class="stat-change" id="alertTrend">å‘Šè­¦è¶‹åŠ¿ --</div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å·¦ä¾§å›¾è¡¨åŒºåŸŸ -->
            <div class="charts-area">
                <!-- ç”µæ± çŠ¶æ€è¶‹åŠ¿å›¾ -->
                <div class="chart-panel">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">ğŸ”‹ ç”µæ± çŠ¶æ€è¶‹åŠ¿</div>
                            <div class="chart-subtitle">Battery Status Trends</div>
                        </div>
                    </div>
                    <div class="chart-content" id="batteryTrendChart"></div>
                </div>
                
                <!-- è®¾å¤‡åœ¨çº¿çŠ¶æ€å˜åŒ– -->
                <div class="chart-panel">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">ğŸ“Š è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ</div>
                            <div class="chart-subtitle">Device Status Distribution</div>
                        </div>
                    </div>
                    <div class="chart-content" id="deviceStatusChart"></div>
                </div>
                
                <!-- å……ç”µçŠ¶æ€åˆ†æ -->
                <div class="chart-panel">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">âš¡ å……ç”µè¡Œä¸ºåˆ†æ</div>
                            <div class="chart-subtitle">Charging Behavior Analysis</div>
                        </div>
                    </div>
                    <div class="chart-content" id="chargingAnalysisChart"></div>
                </div>
                
                <!-- ä½©æˆ´çŠ¶æ€ç»Ÿè®¡ -->
                <div class="chart-panel">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">ğŸ‘¥ ä½©æˆ´çŠ¶æ€ç»Ÿè®¡</div>
                            <div class="chart-subtitle">Wearing Status Statistics</div>
                        </div>
                    </div>
                    <div class="chart-content" id="wearingStatusChart"></div>
                </div>
            </div>
            
            <!-- å³ä¾§è¯¦æƒ…åŒºåŸŸ -->
            <div class="details-area">
                <!-- è®¾å¤‡è¯¦æƒ…åˆ—è¡¨ -->
                <div class="list-panel">
                    <div class="list-header">
                        <div class="list-title">
                            <span>ğŸ·ï¸</span>
                            è®¾å¤‡è¯¦æƒ…
                        </div>
                        <span style="font-size: 12px; color: #7ecfff;">å…± <span id="deviceListCount">0</span> å°è®¾å¤‡</span>
                    </div>
                    <div class="list-content" id="deviceList">
                        <!-- è®¾å¤‡åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒ -->
                <div class="list-panel">
                    <div class="list-header">
                        <div class="list-title">
                            <span>ğŸ’»</span>
                            ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒ
                        </div>
                        <span style="font-size: 12px; color: #7ecfff;">ç‰ˆæœ¬ç»Ÿè®¡</span>
                    </div>
                    <div class="list-content" id="versionList">
                        <!-- ç‰ˆæœ¬åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®æµæ•ˆæœ -->
        <div class="data-stream"></div>
    </div>

    <script>
        const charts = {};
        let currentData = null;
        let currentTimeRange = '24h';
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const chartConfigs = [
                { id: 'batteryTrendChart', title: 'ç”µæ± çŠ¶æ€è¶‹åŠ¿' },
                { id: 'deviceStatusChart', title: 'è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ' },
                { id: 'chargingAnalysisChart', title: 'å……ç”µè¡Œä¸ºåˆ†æ' },
                { id: 'wearingStatusChart', title: 'ä½©æˆ´çŠ¶æ€ç»Ÿè®¡' }
            ];
            
            chartConfigs.forEach(config => {
                charts[config.id] = echarts.init(document.getElementById(config.id));
            });
        }
        
        // è·å–è®¾å¤‡æ•°æ®
        async function fetchDeviceData() {
            try {
                const response = await fetch(`/api/devices/analysis?orgId=1&timeRange=${currentTimeRange}`);
                const result = await response.json();
                return result.success ? result.data : null;
            } catch (error) {
                console.error('è·å–è®¾å¤‡æ•°æ®å¤±è´¥:', error);
                // è¿”å›æ¨¡æ‹Ÿæ•°æ®ä»¥ç¡®ä¿é¡µé¢æ­£å¸¸æ˜¾ç¤º
                return generateMockData();
            }
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå½“APIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
        function generateMockData() {
            return {
                devices: Array.from({length: 50}, (_, i) => ({
                    deviceSn: `Device_${String(i + 1).padStart(3, '0')}`,
                    status: Math.random() > 0.2 ? 'ACTIVE' : 'OFFLINE',
                    batteryLevel: Math.floor(Math.random() * 80) + 20,
                    chargingStatus: Math.random() > 0.8 ? 'CHARGING' : 'NOT_CHARGING',
                    wearableStatus: Math.random() > 0.4 ? 'WORN' : 'NOT_WORN',
                    lastSeen: new Date().toISOString(),
                    version: `v2.${Math.floor(Math.random() * 5)}.${Math.floor(Math.random() * 10)}`
                })),
                statistics: {
                    totalDevices: 1076,
                    onlineDevices: 1076,
                    chargingDevices: 0,
                    wornDevices: 544,
                    lowBatteryDevices: 20,
                    alertCount: 20
                },
                trends: {
                    deviceChange: '+5å°',
                    onlineRate: '100.0%',
                    batteryHealth: '87%',
                    chargingRate: '0.0%',
                    wearRate: '50.6%',
                    alertTrend: 'ç¨³å®š'
                },
                statusDistribution: {
                    online: 1076,
                    offline: 0,
                    standby: 0,
                    error: 0
                },
                batteryTrends: generateTimeSeriesData('battery'),
                chargingAnalysis: generateChargingData(),
                wearingTrends: generateTimeSeriesData('wearing'),
                versionDistribution: {
                    'v2.1.0': 300,
                    'v2.0.8': 250,
                    'v2.0.6': 200,
                    'v1.9.2': 180,
                    'v1.8.5': 146
                }
            };
        }
        
        // ç”Ÿæˆæ—¶é—´åºåˆ—æ•°æ®
        function generateTimeSeriesData(type) {
            const points = [];
            const now = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const time = new Date(now - i * 2 * 60 * 60 * 1000);
                const timeStr = `${String(time.getMonth() + 1).padStart(2, '0')}-${String(time.getDate()).padStart(2, '0')} ${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                
                if (type === 'battery') {
                    points.push({
                        time: timeStr,
                        avgBattery: 75 + Math.floor(Math.random() * 20) - i,
                        lowBatteryCount: Math.floor(Math.random() * 25)
                    });
                } else if (type === 'wearing') {
                    const hour = time.getHours();
                    const baseRate = (8 <= hour && hour <= 18) ? 75 : 45;
                    points.push({
                        time: timeStr,
                        wornRate: baseRate + Math.floor(Math.random() * 20),
                        activeRate: (baseRate + Math.floor(Math.random() * 20)) * 0.8
                    });
                }
            }
            
            return points;
        }
        
        // ç”Ÿæˆå……ç”µæ•°æ®
        function generateChargingData() {
            const data = [];
            for (let hour = 0; hour < 24; hour++) {
                const peakFactor = (22 <= hour || hour <= 6) ? 1.5 : 1.0;
                data.push({
                    hour: `${String(hour).padStart(2, '0')}:00`,
                    chargingCount: Math.floor(50 * peakFactor * Math.random()),
                    completedCount: Math.floor(30 * peakFactor * Math.random())
                });
            }
            return data;
        }
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStatCards(data) {
            const { devices, statistics, trends } = data;
            
            document.getElementById('totalDevices').textContent = statistics.totalDevices || 0;
            document.getElementById('onlineDevices').textContent = statistics.onlineDevices || 0;
            document.getElementById('lowBatteryDevices').textContent = statistics.lowBatteryDevices || 0;
            document.getElementById('chargingDevices').textContent = statistics.chargingDevices || 0;
            document.getElementById('wornDevices').textContent = statistics.wornDevices || 0;
            document.getElementById('alertCount').textContent = statistics.alertCount || 0;
            
            // æ›´æ–°å˜åŒ–è¶‹åŠ¿
            document.getElementById('totalDevicesChange').textContent = `è¾ƒæ˜¨æ—¥ ${trends.deviceChange || '--'}`;
            document.getElementById('onlineRate').textContent = `åœ¨çº¿ç‡ ${trends.onlineRate || '--'}`;
            document.getElementById('batteryHealth').textContent = `ç”µæ± å¥åº·åº¦ ${trends.batteryHealth || '--'}`;
            document.getElementById('chargingRate').textContent = `å……ç”µç‡ ${trends.chargingRate || '--'}`;
            document.getElementById('wearRate').textContent = `ä½©æˆ´ç‡ ${trends.wearRate || '--'}`;
            document.getElementById('alertTrend').textContent = `å‘Šè­¦è¶‹åŠ¿ ${trends.alertTrend || '--'}`;
            
            // æ·»åŠ å‘Šè­¦é—ªçƒæ•ˆæœ
            const alertElement = document.getElementById('alertCount');
            if (statistics.alertCount > 0) {
                alertElement.classList.add('alert-blink');
            } else {
                alertElement.classList.remove('alert-blink');
            }
        }
        
        // æ›´æ–°ç”µæ± è¶‹åŠ¿å›¾
        function updateBatteryTrendChart(data) {
            const { batteryTrends } = data;
            const timeLabels = batteryTrends.map(item => item.time);
            const avgBattery = batteryTrends.map(item => item.avgBattery);
            const lowBatteryCount = batteryTrends.map(item => item.lowBatteryCount);
            
            charts.batteryTrendChart.setOption({
                tooltip: { 
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#00e4ff',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: ['å¹³å‡ç”µé‡', 'ä½ç”µé‡è®¾å¤‡æ•°'],
                    textStyle: { color: '#fff' }
                },
                grid: { left: '10%', right: '10%', bottom: '15%', top: '20%' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { color: '#7ecfff', fontSize: 10 },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ç”µé‡(%)',
                        position: 'left',
                        axisLabel: { color: '#7ecfff' },
                        splitLine: { lineStyle: { color: 'rgba(0,228,255,0.1)' } }
                    },
                    {
                        type: 'value',
                        name: 'è®¾å¤‡æ•°',
                        position: 'right',
                        axisLabel: { color: '#7ecfff' }
                    }
                ],
                series: [
                    {
                        name: 'å¹³å‡ç”µé‡',
                        type: 'line',
                        yAxisIndex: 0,
                        data: avgBattery,
                        itemStyle: { color: '#52c41a' },
                        areaStyle: { color: 'rgba(82,196,26,0.1)' },
                        smooth: true
                    },
                    {
                        name: 'ä½ç”µé‡è®¾å¤‡æ•°',
                        type: 'bar',
                        yAxisIndex: 1,
                        data: lowBatteryCount,
                        itemStyle: { color: '#fa8c16' }
                    }
                ]
            });
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€åˆ†å¸ƒå›¾
        function updateDeviceStatusChart(data) {
            const { statusDistribution } = data;
            
            charts.deviceStatusChart.setOption({
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#00e4ff',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    textStyle: { color: '#fff', fontSize: 11 }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['65%', '50%'],
                    data: [
                        { name: 'åœ¨çº¿', value: statusDistribution.online, itemStyle: { color: '#52c41a' } },
                        { name: 'ç¦»çº¿', value: statusDistribution.offline, itemStyle: { color: '#f5222d' } },
                        { name: 'å¾…æœº', value: statusDistribution.standby, itemStyle: { color: '#faad14' } },
                        { name: 'æ•…éšœ', value: statusDistribution.error, itemStyle: { color: '#ff4d4f' } }
                    ],
                    label: { show: false },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 20,
                            shadowColor: 'rgba(0,228,255,0.5)'
                        }
                    }
                }]
            });
        }
        
        // æ›´æ–°å……ç”µåˆ†æå›¾
        function updateChargingAnalysisChart(data) {
            const { chargingAnalysis } = data;
            const hours = chargingAnalysis.map(item => item.hour);
            const chargingCount = chargingAnalysis.map(item => item.chargingCount);
            const completedCount = chargingAnalysis.map(item => item.completedCount);
            
            charts.chargingAnalysisChart.setOption({
                tooltip: { 
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#00e4ff',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: ['å……ç”µä¸­', 'å……ç”µå®Œæˆ'],
                    textStyle: { color: '#fff' }
                },
                grid: { left: '10%', right: '10%', bottom: '15%', top: '20%' },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLabel: { color: '#7ecfff', fontSize: 10 },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#7ecfff' },
                    splitLine: { lineStyle: { color: 'rgba(0,228,255,0.1)' } }
                },
                series: [
                    {
                        name: 'å……ç”µä¸­',
                        type: 'bar',
                        stack: 'charging',
                        data: chargingCount,
                        itemStyle: { color: '#1890ff' }
                    },
                    {
                        name: 'å……ç”µå®Œæˆ',
                        type: 'bar',
                        stack: 'charging',
                        data: completedCount,
                        itemStyle: { color: '#52c41a' }
                    }
                ]
            });
        }
        
        // æ›´æ–°ä½©æˆ´çŠ¶æ€å›¾
        function updateWearingStatusChart(data) {
            const { wearingTrends } = data;
            const timeLabels = wearingTrends.map(item => item.time);
            const wornRate = wearingTrends.map(item => item.wornRate);
            const activeRate = wearingTrends.map(item => item.activeRate);
            
            charts.wearingStatusChart.setOption({
                tooltip: { 
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#00e4ff',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: ['ä½©æˆ´ç‡', 'æ´»è·ƒç‡'],
                    textStyle: { color: '#fff' }
                },
                grid: { left: '10%', right: '10%', bottom: '15%', top: '20%' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { color: '#7ecfff', fontSize: 10 },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: {
                    type: 'value',
                    max: 100,
                    axisLabel: { color: '#7ecfff', formatter: '{value}%' },
                    splitLine: { lineStyle: { color: 'rgba(0,228,255,0.1)' } }
                },
                series: [
                    {
                        name: 'ä½©æˆ´ç‡',
                        type: 'line',
                        data: wornRate,
                        itemStyle: { color: '#faad14' },
                        areaStyle: { color: 'rgba(250,173,20,0.1)' },
                        smooth: true
                    },
                    {
                        name: 'æ´»è·ƒç‡',
                        type: 'line',
                        data: activeRate,
                        itemStyle: { color: '#1890ff' },
                        areaStyle: { color: 'rgba(24,144,255,0.1)' },
                        smooth: true
                    }
                ]
            });
        }
        
        // æ›´æ–°è®¾å¤‡åˆ—è¡¨
        function updateDeviceList(data) {
            const { devices } = data;
            const deviceList = document.getElementById('deviceList');
            const deviceCount = document.getElementById('deviceListCount');
            
            deviceCount.textContent = devices.length;
            
            deviceList.innerHTML = devices.slice(0, 15).map(device => `
                <div class="list-item">
                    <div class="list-item-label">${device.deviceSn}</div>
                    <div>
                        <span class="list-item-status ${getStatusClass(device.status)}">${getStatusText(device.status)}</span>
                        <span class="list-item-value" style="margin-left: 8px;">${device.batteryLevel}%</span>
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°ç‰ˆæœ¬åˆ—è¡¨
        function updateVersionList(data) {
            const { versionDistribution } = data;
            const versionList = document.getElementById('versionList');
            
            versionList.innerHTML = Object.entries(versionDistribution)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([version, count]) => `
                    <div class="list-item">
                        <div class="list-item-label">${version}</div>
                        <div class="list-item-value stat-primary">${count}å°</div>
                    </div>
                `).join('');
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const statusMap = {
                'ACTIVE': 'status-online',
                'OFFLINE': 'status-offline',
                'CHARGING': 'status-charging',
                'LOW_BATTERY': 'status-low-battery',
                'WORN': 'status-worn'
            };
            return statusMap[status] || 'status-offline';
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'ACTIVE': 'åœ¨çº¿',
                'OFFLINE': 'ç¦»çº¿',
                'CHARGING': 'å……ç”µ',
                'LOW_BATTERY': 'ä½ç”µé‡',
                'WORN': 'ä½©æˆ´ä¸­'
            };
            return statusMap[status] || 'æœªçŸ¥';
        }
        
        // åˆ‡æ¢æ—¶é—´èŒƒå›´
        function changeTimeRange(range) {
            currentTimeRange = range;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°åŠ è½½æ•°æ®
            updateDashboard();
        }
        
        // æ›´æ–°å½“å‰æ—¶é—´
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // æ›´æ–°æ‰€æœ‰ç»„ä»¶
        async function updateDashboard() {
            const data = await fetchDeviceData();
            if (data) {
                currentData = data;
                updateStatCards(data);
                updateBatteryTrendChart(data);
                updateDeviceStatusChart(data);
                updateChargingAnalysisChart(data);
                updateWearingStatusChart(data);
                updateDeviceList(data);
                updateVersionList(data);
            }
        }
        
        // çª—å£å¤§å°è°ƒæ•´æ—¶é‡æ–°æ¸²æŸ“å›¾è¡¨
        window.addEventListener('resize', () => {
            Object.values(charts).forEach(chart => chart.resize());
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            initCharts();
            await updateDashboard();
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®
            setInterval(updateDashboard, 30000);
            
            // æ¯ç§’æ›´æ–°æ—¶é—´
            setInterval(updateTime, 1000);
            updateTime();
        });
    </script>
</body>
</html> 