<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康画像管理中心</title>
    <link href="{{ url_for('static', filename='css/bootstrap-5.1.3.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/font-awesome-6.0.0.min.css') }}" rel="stylesheet">
    <style>
        body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;}
        .card{box-shadow:0 4px 16px rgba(0,0,0,0.1);border:none;border-radius:12px;}
        .monitor-panel{background:linear-gradient(45deg,#4CAF50,#45a049);color:white;}
        .generate-panel{background:linear-gradient(45deg,#FF9800,#F57C00);color:white;}
        .stats-panel{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;}
        .health-score{font-size:2rem;font-weight:bold;}
        .level-excellent{background:#4CAF50;color:white;padding:4px 12px;border-radius:15px;}
        .level-good{background:#8BC34A;color:white;padding:4px 12px;border-radius:15px;}
        .level-fair{background:#FF9800;color:white;padding:4px 12px;border-radius:15px;}
        .level-poor{background:#F44336;color:white;padding:4px 12px;border-radius:15px;}
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-white text-center"><i class="fas fa-user-md me-3"></i>健康画像管理中心</h1>
                <p class="text-white-50 text-center">Health Profile Management System</p>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-lg-4">
                <div class="card monitor-panel">
                    <div class="card-body">
                        <h5><i class="fas fa-clock me-2"></i>定时任务监控</h5>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="h4" id="totalUsers">-</div>
                                <small>总用户数</small>
                            </div>
                            <div class="col-6">
                                <div class="h4" id="successCount">-</div>
                                <small>成功生成</small>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <small>失败数量: <span id="failedCount">-</span></small><br>
                            <small>最近执行: <span id="lastExecution">-</span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card generate-panel">
                    <div class="card-body">
                        <h5><i class="fas fa-cogs me-2"></i>手动生成画像</h5>
                        <div class="mt-3">
                            <button class="btn btn-light w-100" onclick="generateProfiles()">
                                <i class="fas fa-play me-2"></i>立即生成画像
                            </button>
                            <small class="text-white-50 d-block text-center mt-2">为所有用户生成健康画像</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card stats-panel">
                    <div class="card-body">
                        <h5><i class="fas fa-chart-bar me-2"></i>统计概览</h5>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="h4" id="avgScore">-</div>
                                <small>平均评分</small>
                            </div>
                            <div class="col-6">
                                <div class="h4" id="riskCount">-</div>
                                <small>风险用户</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-users me-2 text-primary"></i>用户健康画像</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshProfiles()">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                </div>
                
                <div class="row" id="profilesList">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="text-muted mt-2">正在加载健康画像数据...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap-5.1.3.bundle.min.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadMonitorData();
            loadProfileStatistics();
            loadProfiles();
            setInterval(loadMonitorData, 30000);
        });

        function loadMonitorData() {
            fetch('/api/health-profile/monitor?customerId=1')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        document.getElementById('totalUsers').textContent = data.data.total_users;
                        document.getElementById('successCount').textContent = data.data.success_count;
                        document.getElementById('failedCount').textContent = data.data.failed_count;
                        document.getElementById('lastExecution').textContent = data.data.last_execution_time;
                    }
                })
                .catch(error => console.error('加载监控数据失败:', error));
        }

        function loadProfileStatistics() {
            fetch('/api/health-profile/statistics?customerId=1')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        document.getElementById('avgScore').textContent = data.data.avg_score;
                        document.getElementById('riskCount').textContent = data.data.risk_count;
                    }
                })
                .catch(error => console.error('加载统计数据失败:', error));
        }

        function loadProfiles() {
            fetch('/api/health-profile/list?customerId=1&page=1&size=20')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderProfiles(data.data.profiles);
                    }
                })
                .catch(error => {
                    console.error('加载画像列表失败:', error);
                    document.getElementById('profilesList').innerHTML = 
                        '<div class="col-12 text-center py-5">加载失败，请稍后重试</div>';
                });
        }

        function renderProfiles(profiles) {
            const container = document.getElementById('profilesList');
            if (!profiles || profiles.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5">暂无健康画像数据</div>';
                return;
            }

            container.innerHTML = profiles.map(profile => `
                <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h6 class="mb-2">${profile.real_name || '未知用户'}</h6>
                            <small class="text-muted d-block mb-3">${profile.org_name || '未分配部门'}</small>
                            
                            <div class="health-score text-${getScoreColor(profile.health_score)} mb-2">${profile.health_score || 0}</div>
                            <div class="mb-3">
                                <span class="level-${getLevelClass(profile.health_level)}">${profile.health_level || '未评级'}</span>
                            </div>
                            
                            <div class="small text-muted">
                                <div>基线偏离: ${profile.baseline_deviation_count || 0}项</div>
                                <div>今日数据: ${profile.today_data_count || 0}条</div>
                                <div class="mt-2">更新: ${profile.generated_time || '未生成'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getLevelClass(level) {
            switch(level) {
                case '优秀': return 'excellent';
                case '良好': return 'good';
                case '一般': return 'fair';
                case '差': return 'poor';
                default: return 'fair';
            }
        }

        function getScoreColor(score) {
            if (score >= 90) return 'success';
            if (score >= 75) return 'info';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        function generateProfiles() {
            if (!confirm('确定要为所有用户生成健康画像吗？')) {
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>生成中...';

            fetch('/api/health-profile/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({customerId: 1, operatorId: 1})
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(`画像生成完成！总计: ${data.data.total_users}人, 成功: ${data.data.success_count}人`);
                    loadMonitorData();
                    loadProfiles();
                    loadProfileStatistics();
                } else {
                    alert('生成失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('生成画像失败:', error);
                alert('生成失败，请稍后重试');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play me-2"></i>立即生成画像';
            });
        }

        function refreshProfiles() {
            loadProfiles();
            loadProfileStatistics();
        }
    </script>
</body>
</html>