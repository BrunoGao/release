<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½å¥åº·æ•°æ®åˆ†æå¹³å° - HUBä¸“ä¸šç‰ˆ</title>
    <!-- HUBé£æ ¼ä¸“ä¸šä¼˜åŒ–ç‰ˆæœ¬ - æ”¯æŒåŠ¨æ€æ•ˆæœã€ä¸“ä¸šå›¾è¡¨ã€æ™ºèƒ½äº¤äº’ -->


<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(135deg,#0a1628 0%,#000814 25%,#0c1e35 50%,#000a14 75%,#081220 100%);color:#fff;font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,sans-serif;overflow:hidden;position:relative;animation:bgShift 20s ease-in-out infinite}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="g1"><stop offset="0%" stop-color="%2300e4ff" stop-opacity="0.06"/><stop offset="100%" stop-color="%2300e4ff" stop-opacity="0"/></radialGradient><radialGradient id="g2"><stop offset="0%" stop-color="%2300ffaa" stop-opacity="0.04"/><stop offset="100%" stop-color="%2300ffaa" stop-opacity="0"/></radialGradient><radialGradient id="g3"><stop offset="0%" stop-color="%23ff4757" stop-opacity="0.03"/><stop offset="100%" stop-color="%23ff4757" stop-opacity="0"/></radialGradient></defs><circle cx="200" cy="200" r="5" fill="url(%23g1)"><animate attributeName="r" values="3;8;3" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.6;1;0.6" dur="4s" repeatCount="indefinite"/></circle><circle cx="800" cy="300" r="3" fill="url(%23g2)"><animate attributeName="r" values="2;6;2" dur="6s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.4;0.8;0.4" dur="6s" repeatCount="indefinite"/></circle><circle cx="400" cy="700" r="6" fill="url(%23g1)"><animate attributeName="r" values="4;10;4" dur="5s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;1;0.5" dur="5s" repeatCount="indefinite"/></circle><circle cx="600" cy="100" r="4" fill="url(%23g3)"><animate attributeName="r" values="2;7;2" dur="7s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.3;0.7;0.3" dur="7s" repeatCount="indefinite"/></circle><circle cx="100" cy="600" r="5" fill="url(%23g2)"><animate attributeName="r" values="3;9;3" dur="8s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.4;0.9;0.4" dur="8s" repeatCount="indefinite"/></circle><circle cx="700" cy="500" r="2" fill="url(%23g1)"><animate attributeName="r" values="1;5;1" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.2;0.6;0.2" dur="3s" repeatCount="indefinite"/></circle></svg>');pointer-events:none;z-index:1;animation:particleFloat 15s linear infinite}
body::after{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(45deg,transparent 48%,rgba(0,228,255,0.02) 49%,rgba(0,228,255,0.02) 51%,transparent 52%);background-size:20px 20px;pointer-events:none;z-index:1;animation:gridMove 10s linear infinite}
.hub-container{padding:16px;height:100vh;position:relative;z-index:2;display:flex;flex-direction:column;gap:16px}
.status-bar{display:flex;justify-content:space-around;align-items:center;height:80px;background:linear-gradient(135deg,rgba(6,28,58,0.95),rgba(1,11,26,0.98));border:1px solid rgba(0,228,255,0.2);border-radius:16px;padding:16px;backdrop-filter:blur(20px);box-shadow:0 8px 40px rgba(0,228,255,0.1)}
.status-item{display:flex;align-items:center;gap:12px;padding:12px 20px;background:linear-gradient(135deg,rgba(0,228,255,0.05),rgba(0,200,255,0.08));border:1px solid rgba(0,228,255,0.15);border-radius:12px;transition:all 0.5s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
.status-item::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,228,255,0.1),transparent);transition:left 0.6s ease;z-index:1}
.status-item:hover{background:linear-gradient(135deg,rgba(0,228,255,0.12),rgba(0,200,255,0.18));transform:translateY(-3px) scale(1.02);border-color:rgba(0,228,255,0.4);box-shadow:0 12px 35px rgba(0,228,255,0.15)}
.status-item:hover::before{left:100%}
.status-icon{font-size:26px;filter:drop-shadow(0 0 12px rgba(0,228,255,0.6));animation:iconPulse 3s ease-in-out infinite;position:relative;z-index:2}
.status-label{font-size:11px;color:rgba(255,255,255,0.8);text-transform:uppercase;letter-spacing:1.2px;font-weight:500;position:relative;z-index:2}
.status-value{font-size:22px;color:#00e4ff;font-weight:700;text-shadow:0 0 15px rgba(0,228,255,0.4);animation:valueGlow 2s ease-in-out infinite alternate;position:relative;z-index:2}
.hub-main{flex:1;display:grid;grid-template-areas:'tl center tr''bl center br''bottom bottom bottom';grid-template-columns:320px 1fr 320px;grid-template-rows:1fr 1fr 340px;gap:16px;position:relative;height:calc(100vh - 140px)}
.hub-panel{background:linear-gradient(135deg,rgba(6,28,58,0.92),rgba(1,11,26,0.95),rgba(8,35,65,0.88));border:1px solid rgba(0,228,255,0.25);border-radius:18px;padding:22px;backdrop-filter:blur(25px);box-shadow:0 12px 45px rgba(0,228,255,0.12),inset 0 1px 0 rgba(255,255,255,0.08);position:relative;overflow:hidden;transition:all 0.6s cubic-bezier(0.4,0,0.2,1);cursor:pointer}
.hub-panel::before{content:'';position:absolute;top:-2px;left:-2px;right:-2px;bottom:-2px;background:linear-gradient(45deg,rgba(0,228,255,0.4),rgba(0,180,255,0.2),rgba(0,150,255,0.1),rgba(0,100,200,0.2),rgba(0,228,255,0.4));background-size:400% 400%;border-radius:18px;z-index:-1;opacity:0;transition:opacity 0.8s ease;animation:borderRotate 8s ease-in-out infinite}
.hub-panel::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(0,228,255,0.6),transparent);opacity:0;transition:opacity 0.4s ease;animation:scanLine 3s ease-in-out infinite}
.hub-panel:hover{transform:translateY(-8px) scale(1.02);border-color:rgba(0,228,255,0.5);box-shadow:0 20px 60px rgba(0,228,255,0.2),inset 0 1px 0 rgba(255,255,255,0.15)}
.hub-panel:hover::before{opacity:1}
.hub-panel:hover::after{opacity:1}
.hub-tl{grid-area:tl}.hub-tr{grid-area:tr}.hub-bl{grid-area:bl}.hub-br{grid-area:br}.hub-center{grid-area:center}.hub-bottom{grid-area:bottom;display:grid;grid-template-columns:1fr 1fr;gap:16px;min-height:320px}
.hub-bottom-left,.hub-bottom-right{background:linear-gradient(135deg,rgba(6,28,58,0.95),rgba(1,11,26,0.98));border:2px solid rgba(0,228,255,0.3);border-radius:16px;padding:20px;backdrop-filter:blur(20px);box-shadow:0 8px 32px rgba(0,228,255,0.15),inset 0 1px 0 rgba(255,255,255,0.05);transition:all 0.3s ease}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;position:relative;padding-bottom:12px;border-bottom:1px solid rgba(0,228,255,0.15)}
.panel-header::before{content:'';position:absolute;bottom:-1px;left:0;width:0;height:2px;background:linear-gradient(90deg,#00e4ff,#00a8ff);transition:width 0.8s ease}
.panel-header:hover::before{width:60px}
.panel-icon{font-size:22px;margin-right:10px;filter:drop-shadow(0 0 12px rgba(0,228,255,0.7));animation:iconFloat 4s ease-in-out infinite}
.panel-title{color:#00e4ff;font-size:17px;font-weight:700;letter-spacing:1.2px;text-shadow:0 0 8px rgba(0,228,255,0.3);animation:titleGlow 3s ease-in-out infinite alternate}
.panel-controls{display:flex;gap:8px}
.control-btn{background:rgba(0,228,255,0.1);border:1px solid rgba(0,228,255,0.3);color:#00e4ff;padding:6px 12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;font-size:12px}
.control-btn:hover,.control-btn.active{background:rgba(0,228,255,0.2);border-color:rgba(0,228,255,0.5);transform:scale(1.05)}
.alert-indicator{display:flex;align-items:center;gap:8px}
.alert-dot{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite}
.alert-dot.critical{background:#ff4757;box-shadow:0 0 10px #ff4757}
.alert-count{color:#ff4757;font-weight:600;font-size:14px}
.device-status{display:flex;align-items:center;gap:8px}
.status-dot{width:10px;height:10px;border-radius:50%}
.status-dot.online{background:#00ff9d;box-shadow:0 0 8px #00ff9d;animation:pulse 2s infinite}
.map-overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:10}
.map-title{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:8px;color:#00e4ff;font-size:18px;font-weight:600;text-shadow:0 0 10px rgba(0,228,255,0.5)}
.map-icon{font-size:20px;filter:drop-shadow(0 0 8px rgba(0,228,255,0.5))}
.filter-panel{position:absolute;top:20px;right:20px;pointer-events:auto}
.filter-icon{margin-right:8px;filter:drop-shadow(0 0 8px rgba(0,228,255,0.5))}
.trend-controls{display:flex;gap:4px}
.alert-color{color:#ff4757}
.connection-lines{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1}
.connections-svg{width:100%;height:100%}
.panel{background:linear-gradient(135deg,rgba(6,28,58,0.95) 0%,rgba(1,11,26,0.98) 100%);border:1px solid rgba(0,228,255,0.2);border-radius:12px;padding:20px;backdrop-filter:blur(20px);box-shadow:0 8px 40px rgba(0,228,255,0.1),inset 0 1px 0 rgba(255,255,255,0.1);position:relative;overflow:hidden;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#00e4ff,transparent);opacity:0;transition:opacity 0.3s ease}
.panel:hover{border-color:rgba(0,228,255,0.4);box-shadow:0 12px 50px rgba(0,228,255,0.2),inset 0 1px 0 rgba(255,255,255,0.2)}
.panel:hover::before{opacity:1}
.panel-tl{grid-area:tl}.panel-tm{grid-area:tm}.panel-tr{grid-area:tr}.panel-ml{grid-area:ml}.panel-mm{grid-area:mm}.panel-mr{grid-area:mr}.panel-bl{grid-area:bl}.panel-bm{grid-area:bm}.panel-br{grid-area:br}
.panel-header{color:#00e4ff;font-size:18px;font-weight:600;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;position:relative}
.panel-header::after{content:'';position:absolute;bottom:-10px;left:0;width:60px;height:2px;background:linear-gradient(90deg,#00e4ff,transparent)}
.panel-content{display:flex;flex-direction:column;height:calc(100% - 60px);position:relative}
.header-title{position:relative;height:100px;background:linear-gradient(135deg,rgba(0,40,80,0.95) 0%,rgba(0,100,200,0.6) 30%,rgba(0,60,120,0.8) 70%,rgba(0,30,60,0.95) 100%);display:flex;justify-content:center;align-items:center;border-bottom:2px solid rgba(0,228,255,0.4);margin-bottom:20px;overflow:hidden;box-shadow:0 0 30px rgba(0,228,255,0.2),inset 0 0 30px rgba(0,228,255,0.1)}
.header-title::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(0,228,255,0.3),rgba(255,255,255,0.2),rgba(0,228,255,0.3),transparent);animation:scan 4s infinite}
.header-title::after{content:'ğŸ’»ğŸ”‹ğŸ’¡âš¡ğŸ›°ï¸';position:absolute;top:10px;right:30px;font-size:16px;opacity:0.4;animation:headerIconFloat 4s ease-in-out infinite;filter:drop-shadow(0 0 8px rgba(0,228,255,0.3))}
.header-title h1{color:#ffffff;font-size:36px;font-weight:600;text-shadow:0 0 30px rgba(0,228,255,0.8),0 0 60px rgba(0,228,255,0.4);letter-spacing:4px;position:relative;z-index:2;animation:titleGlow 4s ease-in-out infinite alternate}
.map-container{height:100%;background:linear-gradient(135deg,rgba(6,28,58,0.95) 0%,rgba(1,11,26,0.98) 100%);border:1px solid rgba(0,228,255,0.2);border-radius:12px;position:relative;overflow:hidden;backdrop-filter:blur(20px);box-shadow:0 8px 40px rgba(0,228,255,0.1)}
.map-container::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;border:2px solid transparent;border-radius:12px;background:linear-gradient(45deg,rgba(0,228,255,0.1),transparent,rgba(0,228,255,0.1)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);mask:linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);-webkit-mask-composite:destination-out;mask-composite:exclude;pointer-events:none}
.chart-container{position:relative;flex:1;width:100%;min-height:200px;animation:chartGlow 4s ease-in-out infinite}
.data-card{background:rgba(0,228,255,0.05);border:1px solid rgba(0,228,255,0.2);border-radius:8px;padding:15px;margin-bottom:15px;transition:all 0.3s ease}
.data-card:hover{background:rgba(0,228,255,0.1);border-color:rgba(0,228,255,0.4);transform:translateY(-2px)}
.data-card-value{font-size:28px;color:#00e4ff;margin:8px 0;font-weight:600;text-shadow:0 0 10px rgba(0,228,255,0.3)}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.stat-item{background:rgba(0,228,255,0.05);border:1px solid rgba(0,228,255,0.1);border-radius:8px;padding:12px;text-align:center;transition:all 0.3s ease}
.stat-item:hover{background:rgba(0,228,255,0.1);transform:scale(1.02)}
.stat-label{font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:4px}
.stat-value{font-size:20px;color:#00e4ff;font-weight:600}
.message-list{height:100%;overflow-y:auto;padding-right:8px}
.message-item{background:rgba(0,228,255,0.05);border-left:3px solid #00e4ff;margin-bottom:12px;padding:12px;border-radius:0 8px 8px 0;transition:all 0.3s ease;position:relative}
.message-item::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,#00e4ff,#0099cc);transition:width 0.3s ease}
.message-item:hover{background:rgba(0,228,255,0.1);transform:translateX(5px)}
.message-item:hover::before{width:6px}
.filter-panel{position:absolute;top:20px;right:20px;z-index:1000;background:rgba(6,28,58,0.95);backdrop-filter:blur(20px);padding:20px;border-radius:12px;width:320px;border:1px solid rgba(0,228,255,0.2);box-shadow:0 8px 40px rgba(0,0,0,0.3)}
.filter-select{width:100%;padding:12px;margin-bottom:12px;background:rgba(0,0,0,0.3);color:#fff;border:1px solid rgba(0,228,255,0.2);border-radius:8px;transition:all 0.3s ease}
.filter-select:focus{border-color:rgba(0,228,255,0.6);outline:none;box-shadow:0 0 10px rgba(0,228,255,0.2)}
.total-score{font-size:18px;color:#00e4ff;background:rgba(0,228,255,0.1);padding:8px 16px;border-radius:20px;border:1px solid rgba(0,228,255,0.3)}
.personnel-management{cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
.personnel-management:hover{border-color:rgba(0,228,255,0.4);box-shadow:0 12px 50px rgba(0,228,255,0.2)}
.data-overview{display:flex;justify-content:space-around;padding:15px;margin-bottom:10px;border-bottom:1px solid rgba(0,228,255,0.1)}
.overview-item{text-align:center}
.overview-item .label{font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:4px}
.overview-item .number{font-size:22px;color:#00e4ff;font-weight:600}
.department-chart{flex:1;min-height:0}
.info-panel{background:rgba(6,28,58,0.95);border:1px solid rgba(0,228,255,0.3);border-radius:12px;backdrop-filter:blur(20px);box-shadow:0 8px 40px rgba(0,228,255,0.1)}
.info-panel-header{background:linear-gradient(90deg,rgba(0,228,255,0.1),rgba(0,228,255,0.05));border-bottom:1px solid rgba(0,228,255,0.2)}
.custom-alert{background:rgba(6,28,58,0.98);border:1px solid rgba(0,228,255,0.4);box-shadow:0 8px 40px rgba(0,228,255,0.2)}
.modal-content{background:rgba(6,28,58,0.98);border:1px solid rgba(0,228,255,0.3);box-shadow:0 8px 40px rgba(0,228,255,0.2)}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:rgba(0,228,255,0.05);border-radius:4px}
::-webkit-scrollbar-thumb{background:rgba(0,228,255,0.3);border-radius:4px;transition:background 0.3s ease}
::-webkit-scrollbar-thumb:hover{background:rgba(0,228,255,0.5)}
@keyframes bgShift{0%,100%{background:linear-gradient(135deg,#0a1628 0%,#000814 25%,#0c1e35 50%,#000a14 75%,#081220 100%)}50%{background:linear-gradient(135deg,#081220 0%,#0c1e35 25%,#0a1628 50%,#000814 75%,#000a14 100%)}}
@keyframes particleFloat{0%{transform:translateY(0px) rotate(0deg)}50%{transform:translateY(-10px) rotate(180deg)}100%{transform:translateY(0px) rotate(360deg)}}
@keyframes gridMove{0%{background-position:0 0}100%{background-position:20px 20px}}
@keyframes iconPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 0 12px rgba(0,228,255,0.7))}50%{transform:scale(1.1);filter:drop-shadow(0 0 18px rgba(0,228,255,0.9))}}
@keyframes valueGlow{0%{text-shadow:0 0 15px rgba(0,228,255,0.4)}100%{text-shadow:0 0 25px rgba(0,228,255,0.8),0 0 35px rgba(0,228,255,0.3)}}
@keyframes borderRotate{0%{background-position:0% 50%}25%{background-position:100% 0%}50%{background-position:100% 100%}75%{background-position:0% 100%}100%{background-position:0% 50%}}
@keyframes scanLine{0%{opacity:0;transform:translateX(-100%)}50%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(100%)}}
@keyframes iconFloat{0%,100%{transform:translateY(0px) rotate(0deg)}25%{transform:translateY(-3px) rotate(2deg)}50%{transform:translateY(-2px) rotate(0deg)}75%{transform:translateY(-4px) rotate(-2deg)}}
@keyframes titleGlow{0%{text-shadow:0 0 8px rgba(0,228,255,0.3)}100%{text-shadow:0 0 15px rgba(0,228,255,0.6),0 0 25px rgba(0,228,255,0.2)}}
@keyframes dataStream{0%{transform:translateX(-100px) scale(0.8);opacity:0}20%{opacity:1;transform:scale(1)}80%{opacity:1;transform:scale(1)}100%{transform:translateX(100px) scale(0.8);opacity:0}}
@keyframes chartGlow{0%,100%{filter:drop-shadow(0 0 5px rgba(0,228,255,0.3))}50%{filter:drop-shadow(0 0 15px rgba(0,228,255,0.6))}}
@keyframes dataStreamFlow{0%{transform:translate(-50px,-50px) scale(0);opacity:0}10%{opacity:1;transform:scale(1)}50%{opacity:0.8}90%{opacity:1}100%{transform:translate(150vw,150vh) scale(0);opacity:0}}
@keyframes loadingPulse{0%,100%{opacity:0.4;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
@keyframes loadingRotate{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes scan{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,228,255,0.4)}70%{box-shadow:0 0 0 10px rgba(0,228,255,0)}100%{box-shadow:0 0 0 0 rgba(0,228,255,0)}}
@keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-5px)}}
@keyframes headerIconFloat{0%{transform:translateY(0px) rotate(0deg)}25%{transform:translateY(-3px) rotate(5deg)}50%{transform:translateY(-1px) rotate(0deg)}75%{transform:translateY(-4px) rotate(-5deg)}100%{transform:translateY(0px) rotate(0deg)}}
@keyframes rotate{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes breathe{0%,100%{transform:scale(1);opacity:0.8}50%{transform:scale(1.1);opacity:1}}
@keyframes ripple{0%{transform:scale(0);opacity:1}100%{transform:scale(4);opacity:0}}
@keyframes glow{0%{text-shadow:0 0 20px rgba(0,228,255,0.5)}50%{text-shadow:0 0 30px rgba(0,228,255,0.8),0 0 40px rgba(0,228,255,0.3)}100%{text-shadow:0 0 20px rgba(0,228,255,0.5)}}
@keyframes alertContainerGlow{0%,100%{box-shadow:0 0 25px rgba(0,255,255,0.4),inset 0 0 15px rgba(0,255,255,0.1)}50%{box-shadow:0 0 35px rgba(0,255,255,0.6),inset 0 0 20px rgba(0,255,255,0.2)}}
@keyframes scoreGlow{0%,100%{transform:scale(1);text-shadow:0 0 15px currentColor}50%{transform:scale(1.05);text-shadow:0 0 25px currentColor,0 0 35px currentColor}}
@keyframes alertFlash{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.1)}}
@keyframes deviceOfflineAlert{0%,100%{box-shadow:0 0 15px rgba(255,51,51,0.5);transform:scale(1)}50%{box-shadow:0 0 30px rgba(255,51,51,0.8);transform:scale(1.02)}}
@keyframes healthRingPulse{0%,100%{filter:drop-shadow(0 0 8px rgba(0,255,102,0.4))}50%{filter:drop-shadow(0 0 20px rgba(0,255,102,0.8))}}
#alertList{background:linear-gradient(135deg,rgba(0,30,60,0.85),rgba(0,40,80,0.7))!important;border:2px solid rgba(0,255,255,0.4)!important;border-radius:15px!important;box-shadow:0 0 30px rgba(0,255,255,0.5),inset 0 0 20px rgba(0,255,255,0.1)!important;backdrop-filter:blur(10px)!important;animation:alertContainerGlow 4s ease-in-out infinite!important}
#alertList canvas{filter:contrast(1.2) saturate(1.3) brightness(1.1)!important}
.personnel-status{cursor:pointer!important;transition:all 0.3s ease!important}
.personnel-status:hover{transform:scale(1.02)!important;box-shadow:0 0 15px rgba(0,255,255,0.4)!important}
.management-hint{font-size:12px;margin-left:5px;opacity:0.7;transition:opacity 0.3s ease}
.personnel-status:hover .management-hint{opacity:1;animation:pulse 1s infinite}
.personnel-details{display:flex;gap:10px;margin-top:3px;font-size:10px;color:#99ddff}
.detail-item{background:rgba(0,40,80,0.5);padding:2px 6px;border-radius:4px;border:1px solid rgba(0,255,255,0.2)}
.hub-bottom-left:hover,.hub-bottom-right:hover{border-color:rgba(0,255,255,0.6);box-shadow:0 12px 40px rgba(0,228,255,0.25),inset 0 1px 0 rgba(255,255,255,0.1);transform:translateY(-2px)}
.hub-bottom .panel-header{border-bottom-color:rgba(0,255,255,0.25);margin-bottom:16px}
.hub-bottom .panel-title{font-size:16px;font-weight:600;color:#ffffff;text-shadow:0 0 8px rgba(0,255,255,0.3)}
.hub-bottom .panel-content{height:calc(100% - 60px);min-height:240px}
/* åœ°å›¾ç›¸å…³æ ·å¼ */
.map-background{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}
.map-grid{width:100%;height:100%;background:linear-gradient(rgba(0,100,200,0.1) 1px,transparent 1px),linear-gradient(90deg,rgba(0,100,200,0.1) 1px,transparent 1px);background-size:50px 50px;opacity:0.3}
.device-points{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3}
.device-point{position:absolute;width:20px;height:20px;border-radius:50%;cursor:pointer;transition:all 0.3s ease}
.device-point::before{content:'';position:absolute;top:-5px;left:-5px;width:30px;height:30px;border-radius:50%;border:2px solid;animation:devicePulse 2s ease-in-out infinite}
.device-point.online{background:rgba(0,255,100,0.8);box-shadow:0 0 15px rgba(0,255,100,0.6)}
.device-point.online::before{border-color:rgba(0,255,100,0.7)}
.device-point.offline{background:rgba(255,100,100,0.8);box-shadow:0 0 15px rgba(255,100,100,0.6)}
.device-point.offline::before{border-color:rgba(255,100,100,0.7)}
.device-point.alert{background:rgba(255,200,0,0.8);box-shadow:0 0 15px rgba(255,200,0,0.6);animation:alertBlink 1s ease-in-out infinite}
.device-point.alert::before{border-color:rgba(255,200,0,0.7)}
.device-point:hover{transform:scale(1.3);z-index:10}
/* ç­›é€‰é¢æ¿æ ·å¼ */
.filter-panel{background:rgba(0,30,60,0.9);border:2px solid rgba(0,255,255,0.3);border-radius:12px;padding:15px;backdrop-filter:blur(15px);transition:all 0.3s ease;overflow:hidden}
.filter-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;color:#ffffff;font-weight:600}
.filter-toggle{font-size:16px;transition:transform 0.3s ease;user-select:none}
.filter-panel.collapsed .filter-toggle{transform:rotate(180deg)}
.filter-container{margin-top:12px;transition:all 0.3s ease;overflow:hidden}
.filter-panel.collapsed .filter-container{max-height:0;margin-top:0;opacity:0}
.filter-select{width:100%;margin-bottom:10px;padding:8px 12px;background:rgba(0,40,80,0.8);border:1px solid rgba(0,255,255,0.4);border-radius:6px;color:#ffffff;font-size:12px}
.filter-select:focus{border-color:rgba(0,255,255,0.8);outline:none;box-shadow:0 0 8px rgba(0,255,255,0.3)}

@keyframes devicePulse{0%,100%{transform:scale(1);opacity:0.7}50%{transform:scale(1.3);opacity:0.3}}
@keyframes alertBlink{0%,100%{opacity:1}50%{opacity:0.4}}
/* è®¾å¤‡è¯¦æƒ…å¼¹çª—æ ·å¼ */
.device-detail-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px)}
.device-detail-content{background:linear-gradient(135deg,rgba(0,40,80,0.95),rgba(0,20,50,0.98));border:2px solid rgba(0,255,255,0.4);border-radius:20px;padding:25px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,255,255,0.2)}
.device-header{display:flex;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid rgba(0,255,255,0.3);position:relative}
.device-avatar{width:60px;height:60px;border-radius:50%;overflow:hidden;border:3px solid rgba(0,255,255,0.6);margin-right:15px}
.device-avatar img{width:100%;height:100%;object-fit:cover}
.device-info h3{color:#ffffff;font-size:18px;font-weight:bold;margin:0 0 5px 0;text-shadow:0 0 8px rgba(0,255,255,0.4)}
.device-id{color:#99ddff;font-size:14px;margin:0}
.modal-close{position:absolute;top:-5px;right:0;color:#ff6666;font-size:24px;cursor:pointer;font-weight:bold;transition:all 0.3s ease;padding:5px;border-radius:50%}
.modal-close:hover{background:rgba(255,100,100,0.2);transform:scale(1.1)}
.device-data{margin:20px 0}
.data-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:15px;margin-bottom:12px;padding:8px;background:rgba(0,60,120,0.3);border-radius:8px;border:1px solid rgba(0,255,255,0.2)}
.data-row span:nth-child(odd){color:#99ddff;font-size:13px}
.data-row span:nth-child(even){color:#ffffff;font-size:13px;font-weight:600}
.device-location,.device-timestamp{background:rgba(0,30,60,0.5);padding:12px;border-radius:8px;margin:15px 0;border:1px solid rgba(0,255,255,0.2)}
.device-location p,.device-timestamp p{color:#ffffff;margin:0;font-size:13px;line-height:1.4}
.device-location strong,.device-timestamp strong{color:#00e4ff}
.status-badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;margin-top:5px}
.status-badge.online{background:rgba(0,255,102,0.2);color:#00ff66;border:1px solid #00ff66}
.status-badge.alert{background:rgba(255,187,0,0.2);color:#ffbb00;border:1px solid #ffbb00}
.status-badge.offline{background:rgba(255,102,102,0.2);color:#ff6666;border:1px solid #ff6666}
.status-dot.running{background:#00ff66;animation:pulse 2s infinite}
.message-scroll{height:100%;overflow:hidden;position:relative;background:radial-gradient(circle at center,rgba(0,228,255,0.05),transparent)}
.message-content-scroll{animation:scrollUp 20s linear infinite;will-change:transform}
.message-item-scroll{background:linear-gradient(135deg,rgba(0,30,60,0.9),rgba(0,50,100,0.7));border:1px solid rgba(0,255,255,0.3);border-radius:12px;margin:10px 0;padding:12px;box-shadow:0 4px 15px rgba(0,228,255,0.2);backdrop-filter:blur(5px)}
.message-header-scroll{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;border-bottom:1px solid rgba(0,255,255,0.2);padding-bottom:6px}
.message-user{color:#00ffff;font-weight:600;font-size:13px;text-shadow:0 0 8px #00ffff}
.message-time{color:#88ccff;font-size:11px;opacity:0.8}
.message-text{color:#ffffff;font-size:12px;line-height:1.4;text-shadow:0 0 3px rgba(0,0,0,0.8)}
.message-priority{display:inline-block;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:600;margin-left:8px}
.priority-high{background:#ff4757;color:#fff;box-shadow:0 0 8px #ff4757}
.priority-medium{background:#ffa502;color:#fff;box-shadow:0 0 8px #ffa502}
.priority-low{background:#5f27cd;color:#fff;box-shadow:0 0 8px #5f27cd}
@keyframes scrollUp{0%{transform:translateY(100%)}100%{transform:translateY(-100%)}}
.alert-info{background:rgba(255,187,0,0.1);border:1px solid rgba(255,187,0,0.3);border-radius:8px;padding:15px;margin:15px 0}
.alert-type,.alert-severity,.alert-time{color:#ffffff;margin:5px 0;font-size:13px}
.device-sn{background:rgba(0,60,120,0.3);padding:12px;border-radius:8px;margin:15px 0;border:1px solid rgba(0,255,255,0.2)}
@keyframes borderFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes dataFlow{0%{transform:translateX(-100%) rotate(0deg);opacity:0}50%{opacity:1}100%{transform:translateX(100vw) rotate(360deg);opacity:0}}
.hub-panel::after{content:'';position:absolute;top:-2px;left:-2px;right:-2px;bottom:-2px;background:linear-gradient(45deg,rgba(0,228,255,0.3),transparent,rgba(0,228,255,0.3));background-size:400% 400%;border-radius:16px;z-index:-1;opacity:0;transition:opacity 0.3s ease;animation:borderFlow 3s ease infinite}
.hub-panel:hover::after{opacity:1}
.status-item::before{content:'';position:absolute;top:50%;left:50%;width:4px;height:4px;background:rgba(0,228,255,0.8);border-radius:50%;transform:translate(-50%,-50%);animation:ripple 2s infinite}
.data-flow{position:absolute;width:6px;height:6px;background:rgba(0,228,255,0.8);border-radius:50%;animation:dataFlow 8s linear infinite}
.pulse{animation:pulse 2s infinite}
.float{animation:float 3s ease-in-out infinite}
.breathe{animation:breathe 3s ease-in-out infinite}
.glow{animation:glow 2s ease-in-out infinite}
.border-glow{border:1px solid rgba(0,228,255,0.3);box-shadow:0 0 20px rgba(0,228,255,0.1),inset 0 0 20px rgba(0,228,255,0.05)}
.alert-type-detail-modal{animation:modalFadeIn 0.3s ease}
@keyframes modalFadeIn{0%{opacity:0;transform:scale(0.9)}100%{opacity:1;transform:scale(1)}}
.hub-bl .chart-container{background:radial-gradient(circle at center,rgba(255,71,87,0.05) 0%,transparent 70%);border-radius:12px;transition:all 0.5s ease}
.hub-bl:hover .chart-container{background:radial-gradient(circle at center,rgba(255,71,87,0.08) 0%,rgba(0,228,255,0.03) 70%);box-shadow:inset 0 0 30px rgba(255,71,87,0.1)}
.hub-bl .panel-header::after{background:linear-gradient(90deg,#ff4757,#ff6b6b,transparent)}
@keyframes alertPulse{0%,100%{box-shadow:0 0 5px rgba(255,71,87,0.3)}50%{box-shadow:0 0 20px rgba(255,71,87,0.6),inset 0 0 10px rgba(255,71,87,0.1)}}
.hub-bl{animation:alertPulse 4s ease-in-out infinite}
@media(max-width:1600px){.hub-main{grid-template-columns:280px 1fr 280px}}
@media(max-width:1200px){.hub-main{grid-template-columns:250px 1fr 250px}}
</style>
  </head>
  <body>
    <!-- æ·»åŠ æ ‡é¢˜æ  -->
    <div class="header-title">
        <div class="header-decoration left"></div>
        <h1>{{ BIGSCREEN_TITLE }}</h1>
      
        <div class="header-decoration right"></div>
          </div>

    <!-- HUBé£æ ¼ä¸­å¿ƒè¾å°„å¸ƒå±€ -->
    <div class="hub-container">
      <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
      <div class="status-bar">
        <div class="status-item personnel-status" onclick="expandPersonnelManagement()">
          <div class="status-icon">ğŸ‘¥</div>
          <div class="status-text">
            <div class="status-label">
              åœ¨çº¿äººå‘˜
              <span class="management-hint">ğŸ“‹</span>
            </div>
            <div class="status-value" id="onlineUsers">156</div>
            <div class="personnel-details">
              <span class="detail-item">æ€»è®¡: <span id="totalUsers">189</span></span>
              <span class="detail-item">å‘Šè­¦: <span id="alertUsers">12</span></span>
            </div>
          </div>
        </div>
        <div class="status-item">
          <div class="status-icon">âš ï¸</div>
          <div class="status-text">
            <div class="status-label">å‘Šè­¦æ•°é‡</div>
            <div class="status-value" id="alertCount">12</div>
          </div>
        </div>
        <div class="status-item">
          <div class="status-icon">ğŸ“±</div>
          <div class="status-text">
            <div class="status-label">è®¾å¤‡æ€»æ•°</div>
            <div class="status-value" id="deviceCount">289</div>
          </div>
        </div>
        <div class="status-item">
          <div class="status-icon">ğŸ’š</div>
          <div class="status-text">
            <div class="status-label">å¥åº·è¯„åˆ†</div>
            <div class="status-value total-score">88.9</div>
          </div>
        </div>
      </div>

      <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - HUBå¸ƒå±€ -->
      <div class="hub-main">
        <!-- å·¦ä¸Šè§’ï¼šå¥åº·é›·è¾¾å›¾ -->
        <div class="hub-panel hub-tl">
          <div class="panel-header">
            <span class="panel-icon">ğŸ“Š</span>
            <span class="panel-title">å¥åº·è¯„åˆ†é›·è¾¾</span>
            <div class="panel-controls">
              <button class="control-btn" onclick="toggleRadarView()">ğŸ“ˆ</button>
            </div>
          </div>
          <div class="panel-content">
            <div id="healthScoreChart" class="chart-container"></div>
          </div>
        </div>

        <!-- å³ä¸Šè§’ï¼šæ€»ä½“è¿è¡Œæƒ…å†µ -->
        <div class="hub-panel hub-tr">
          <div class="panel-header">
            <span class="panel-icon">ğŸ“Š</span>
            <span class="panel-title">æ€»ä½“è¿è¡Œæƒ…å†µ</span>
            <div class="status-indicator">
              <span class="status-dot running"></span>
              <span id="systemStatus">æ­£å¸¸</span>
            </div>
          </div>
          <div class="panel-content">
            <div id="overallChart" class="chart-container"></div>
          </div>
        </div>

        <!-- ä¸­å¿ƒåœ°å›¾åŒºåŸŸ -->
        <div class="hub-center">
          <div class="map-container" id="map-container">
            <!-- åœ°å›¾èƒŒæ™¯å’Œå»ºç­‘è½®å»“ -->
            <div class="map-background">
                            <!-- ç®€åŒ–çš„åœ°å›¾èƒŒæ™¯ -->
              <div class="map-grid"></div>
              <!-- è®¾å¤‡å‘¼å¸ç‚¹ -->
              <div class="device-points" id="devicePoints"></div>
            </div>
            <div class="map-overlay">
              <div class="map-title">
                <span class="map-icon">ğŸŒ</span>
                <span>å®æ—¶ä½ç½®ç›‘æ§</span>
              </div>
              <div class="filter-panel" id="filterPanel">
                <div class="filter-header" onclick="toggleFilterPanel()">
                  <span class="filter-icon">ğŸ”</span>
                  <span>æ™ºèƒ½ç­›é€‰</span>
                  <span class="filter-toggle" id="filterToggle">ğŸ“</span>
                </div>
                <div class="filter-container" id="filterContainer">
                  <select id="deptSelect" class="filter-select">
                    <option value="">ğŸ¢ é€‰æ‹©éƒ¨é—¨</option>
                  </select>
                  <select id="userSelect" class="filter-select">
                    <option value="">ğŸ‘¤ é€‰æ‹©ç”¨æˆ·</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å·¦ä¸‹è§’ï¼šå‘Šè­¦ä¿¡æ¯ -->
        <div class="hub-panel hub-bl">
          <div class="panel-header">
            <span class="panel-icon">ğŸš¨</span>
            <span class="panel-title">å‘Šè­¦ä¸­å¿ƒ</span>
            <div class="alert-indicator">
              <span class="alert-dot critical"></span>
              <span class="alert-count" id="criticalAlerts">3</span>
            </div>
          </div>
          <div class="panel-content">
            <div id="alertList" class="chart-container"></div>
          </div>
        </div>

        <!-- å³ä¸‹è§’ï¼šè¶‹åŠ¿åˆ†æ -->
        <div class="hub-panel hub-br">
          <div class="panel-header">
            <span class="panel-icon">ğŸ“ˆ</span>
            <span class="panel-title">è¶‹åŠ¿åˆ†æ</span>
            <div class="trend-controls">
              <button class="control-btn active" data-period="day">æ—¥</button>
              <button class="control-btn" data-period="week">å‘¨</button>
              <button class="control-btn" data-period="month">æœˆ</button>
            </div>
          </div>
          <div class="panel-content">
            <div id="trendChart" class="chart-container"></div>
          </div>
        </div>

        <!-- åº•éƒ¨æ‰©å±•åŒºåŸŸï¼šæ¶ˆæ¯å’Œè¶‹åŠ¿ -->
        <div class="hub-bottom">
          <div class="hub-panel hub-bottom-left">
            <div class="panel-header">
              <span class="panel-icon">ğŸ’¬</span>
              <span class="panel-title">æ¶ˆæ¯ä¸­å¿ƒ</span>
              <span class="message-count" id="messageCount">0</span>
            </div>
            <div class="panel-content">
              <div id="messageList" class="message-list"></div>
            </div>
          </div>
          
          <div class="hub-panel hub-bottom-right">
            <div class="panel-header">
              <span class="panel-icon">âŒš</span>
              <span class="panel-title">è®¾å¤‡çŠ¶æ€</span>
              <div class="device-status">
                <span class="status-dot online"></span>
                <span id="totalWatchDevices">289</span>
              </div>
            </div>
            <div class="panel-content">
              <div id="statsChart" class="chart-container"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¿æ¥çº¿åŠ¨ç”» -->
      <div class="connection-lines">
        <svg class="connections-svg">
          <defs>
            <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#00e4ff;stop-opacity:0.8"/>
              <stop offset="50%" style="stop-color:#00a8ff;stop-opacity:0.4"/>
              <stop offset="100%" style="stop-color:#0080ff;stop-opacity:0.1"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        window.difyChatbotConfig = {
         token: 'CdVhQIms3fZkQuTW',
         baseUrl: 'http://192.168.1.83',
         systemVariables: {
           // user_id: 'YOU CAN DEFINE USER ID HERE',
           // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
         },
        }
       </script>
       <script
        src="http://192.168.1.83/embed.min.js"
        id="CdVhQIms3fZkQuTW"
        defer>
       </script>
       <style>
         #dify-chatbot-bubble-button {
           background-color: #1C64F2 !important;
         }
         #dify-chatbot-bubble-window {
           width: 24rem !important;
           height: 40rem !important;
         }
       </style>
    <script>
      // HUBé£æ ¼å¢å¼ºåŠŸèƒ½
      function toggleRadarView(){console.log('åˆ‡æ¢é›·è¾¾å›¾è§†å›¾');showCustomAlert('é›·è¾¾å›¾è§†å›¾åˆ‡æ¢åŠŸèƒ½')}
      function expandPersonnelManagement(){console.log('å±•å¼€äººå‘˜ç®¡ç†');createModalWindow(`/user_view.html?customerId=${new URLSearchParams(window.location.search).get('customerId')||'1'}`)}
      function initConnectionLines(){const svg=document.querySelector('.connections-svg'),main=document.querySelector('.hub-main');if(!svg||!main)return;const createLine=(x1,y1,x2,y2)=>{const line=document.createElementNS('http://www.w3.org/2000/svg','line');line.setAttribute('x1',x1);line.setAttribute('y1',y1);line.setAttribute('x2',x2);line.setAttribute('y2',y2);line.setAttribute('stroke','url(#lineGradient)');line.setAttribute('stroke-width','2');line.setAttribute('opacity','0.3');return line};const centerX=main.offsetWidth*0.6,centerY=main.offsetHeight*0.5;const connections=[[100,100],[main.offsetWidth-100,100],[100,main.offsetHeight-100],[main.offsetWidth-100,main.offsetHeight-100]];connections.forEach(([x,y])=>svg.appendChild(createLine(x,y,centerX,centerY)))}
      function initHubInteractions(){document.querySelectorAll('.trend-controls .control-btn').forEach(btn=>btn.addEventListener('click',function(){document.querySelectorAll('.trend-controls .control-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');const period=this.dataset.period;console.log('åˆ‡æ¢è¶‹åŠ¿å‘¨æœŸ:',period);loadTrendData(period)}));setTimeout(initConnectionLines,1000)}
      function loadTrendData(period){console.log('åŠ è½½è¶‹åŠ¿æ•°æ®:',period)}
      // ç­›é€‰é¢æ¿æŠ˜å åŠŸèƒ½
      function toggleFilterPanel(){const panel=document.getElementById('filterPanel'),toggle=document.getElementById('filterToggle');panel.classList.toggle('collapsed');toggle.textContent=panel.classList.contains('collapsed')?'ğŸ“‚':'ğŸ“'}
      // è®¾å¤‡è¯¦æƒ…å¼¹çª—
      function showDeviceDetail(device){const modal=document.createElement('div');modal.className='device-detail-modal';const statusColor=device.status==='online'?'00ff66':device.status==='alert'?'ffbb00':'ff6666';const statusText=device.status==='online'?'åœ¨çº¿':device.status==='alert'?'å‘Šè­¦':'ç¦»çº¿';const avatar=device.avatar||`data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23${statusColor}'/%3E%3Ctext x='50' y='55' text-anchor='middle' fill='white' font-size='20'%3EğŸ‘¤%3C/text%3E%3C/svg%3E`;const locationText=device.longitude&&device.latitude?`ç»åº¦: ${device.longitude}, çº¬åº¦: ${device.latitude}`:'ä½ç½®ä¿¡æ¯è·å–ä¸­...';modal.innerHTML=`<div class="device-detail-content"><div class="device-header"><div class="device-avatar"><img src="${avatar}" alt="ç”¨æˆ·å¤´åƒ"/></div><div class="device-info"><h3>${device.dept||'æœªçŸ¥éƒ¨é—¨'}</h3><p class="device-id">${device.name||device.id||'æœªçŸ¥ç”¨æˆ·'}</p><div class="status-badge ${device.status}">${statusText}</div></div><span class="modal-close" onclick="closeDeviceDetail()">âœ–</span></div>${device.type==='alert'?`<div class="alert-info"><div class="alert-type">å‘Šè­¦ç±»å‹: ${ALERT_TYPE_MAP[device.alertType]||device.alertType||'æœªçŸ¥'}</div><div class="alert-severity">ä¸¥é‡ç­‰çº§: ${ALERT_SEVERITY_MAP[device.severity]||device.severity||'æœªçŸ¥'}</div><div class="alert-time">å‘Šè­¦æ—¶é—´: ${device.alertTime||'æœªçŸ¥'}</div></div>`:''}${device.type==='health'?`<div class="device-data"><div class="data-row"><span>å¿ƒç‡ï¼š</span><span>${device.heartRate||'-'} bpm</span><span>è¡€å‹ï¼š</span><span>${device.bloodPressure||'-'} mmHg</span></div><div class="data-row"><span>è¡€æ°§ï¼š</span><span>${device.bloodOxygen||'-'} %</span><span>ä½“æ¸©ï¼š</span><span>${device.temperature||'-'} â„ƒ</span></div><div class="data-row"><span>æ­¥æ•°ï¼š</span><span>${device.steps||'-'} æ­¥</span><span>å¡è·¯é‡Œï¼š</span><span>${device.calories||'-'} kcal</span></div><div class="data-row"><span>è·ç¦»ï¼š</span><span>${device.distance||'-'} ç±³</span><span>å‹åŠ›ï¼š</span><span>${device.stress||'-'}</span></div><div class="data-row"><span>ç¡çœ ï¼š</span><span colspan="3">${device.sleep||'-'}</span></div></div>`:''}${device.deviceSn?`<div class="device-sn"><p><strong>è®¾å¤‡ç¼–å·ï¼š</strong> ${device.deviceSn}</p></div>`:''}<div class="device-location"><p><strong>ä½ç½®ä¿¡æ¯ï¼š</strong> ${locationText}</p></div><div class="device-timestamp"><p><strong>é‡‡é›†æ—¶é—´ï¼š</strong> ${device.timestamp||new Date().toLocaleString('zh-CN')}</p></div></div>`;document.body.appendChild(modal);modal.addEventListener('click',e=>{if(e.target===modal)closeDeviceDetail()})}
      function closeDeviceDetail(){const modal=document.querySelector('.device-detail-modal');if(modal)modal.remove()}
      // åˆå§‹åŒ–åœ°å›¾è®¾å¤‡ç‚¹ - ä½¿ç”¨çœŸå®æ•°æ®
      function initMapDevices(){loadRealMapData()}
      // åŠ è½½çœŸå®åœ°å›¾æ•°æ®
      function loadRealMapData(){const urlParams=new URLSearchParams(window.location.search);const customerId=urlParams.get('customerId')||'1';fetch(`/get_total_info?customer_id=${customerId}`).then(r=>r.json()).then(result=>{if(result.success){updateMapDevices(result.data)}}).catch(e=>console.error('è·å–åœ°å›¾æ•°æ®å¤±è´¥:',e))}
      // æ›´æ–°åœ°å›¾è®¾å¤‡ç‚¹
      function updateMapDevices(data){const points=document.getElementById('devicePoints');if(!points)return;points.innerHTML='';const devices=[];if(data.health_data?.healthData){data.health_data.healthData.forEach(h=>{if(h.longitude&&h.latitude){devices.push({id:h.id||h.health_id,name:h.userName||h.user_name||'ç”¨æˆ·',dept:h.deptName||h.dept_name||'æœªçŸ¥éƒ¨é—¨',dept_id:h.dept_id||h.deptId,user_id:h.user_id||h.userId,status:'online',longitude:h.longitude,latitude:h.latitude,heartRate:h.heartRate,bloodPressure:`${h.pressureHigh||0}/${h.pressureLow||0}`,bloodOxygen:h.bloodOxygen,temperature:h.temperature,steps:h.step,calories:h.calorie,distance:h.distance,stress:h.stress,sleep:h.sleepData||'-',timestamp:h.timestamp,deviceSn:h.deviceSn,type:'health'})}})}if(data.alert_info?.alerts){data.alert_info.alerts.forEach(a=>{if(a.longitude&&a.latitude){const severity=a.severity_level||a.severityLevel;devices.push({id:a.alert_id||a.id,name:a.user_name||a.userName||'ç”¨æˆ·',dept:a.dept_name||a.deptName||'æœªçŸ¥éƒ¨é—¨',dept_id:a.dept_id||a.deptId,user_id:a.user_id||a.userId,status:severity==='critical'?'alert':'online',longitude:a.longitude,latitude:a.latitude,alertType:a.alert_type,severity:severity,alertTime:a.alert_timestamp,type:'alert'})}})}console.log('åœ°å›¾è®¾å¤‡æ•°æ®:',devices);devices.forEach((device,index)=>{const point=document.createElement('div');point.className=`device-point ${device.status}`;point.device=device;const centerLng=114.3,centerLat=30.6,scale=800;const x=(device.longitude-centerLng)*scale+400;const y=300-(device.latitude-centerLat)*scale;point.style.left=`${Math.max(5,Math.min(95,(x/800)*100))}%`;point.style.top=`${Math.max(5,Math.min(95,(y/600)*100))}%`;point.onclick=()=>showDeviceDetail(device);point.title=`${device.name} - ${device.dept}`;points.appendChild(point)});loadDepartmentData()}
      // åŠ è½½éƒ¨é—¨æ•°æ®åˆ°ç­›é€‰å™¨
      function loadDepartmentData(){const urlParams=new URLSearchParams(window.location.search);const customerId=urlParams.get('customerId')||'1';fetch(`/fetch_departments?orgId=${customerId}`).then(r=>r.json()).then(data=>{if(data){updateDepartmentSelect(data);setupFilterEvents()}}).catch(e=>console.error('è·å–éƒ¨é—¨æ•°æ®å¤±è´¥:',e))}
      // è®¾ç½®ç­›é€‰äº‹ä»¶
      function setupFilterEvents(){const deptSelect=document.getElementById('deptSelect');const userSelect=document.getElementById('userSelect');if(deptSelect){deptSelect.addEventListener('change',async function(){const deptId=this.value;userSelect.innerHTML='<option value="">ğŸ‘¤ é€‰æ‹©ç”¨æˆ·</option>';if(deptId){try{const response=await fetch(`/fetch_users?orgId=${deptId}`);const users=await response.json();if(users){users.forEach(user=>{const option=document.createElement('option');option.value=user.id||user.user_id;option.textContent=`ğŸ‘¤ ${user.user_name||user.name}`;userSelect.appendChild(option)})}}catch(e){console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:',e)}}filterMapDevices()})}if(userSelect){userSelect.addEventListener('change',filterMapDevices)}}
      // ç­›é€‰åœ°å›¾è®¾å¤‡
      function filterMapDevices(){const deptSelect=document.getElementById('deptSelect');const userSelect=document.getElementById('userSelect');const selectedDept=deptSelect?.value||'';const selectedUser=userSelect?.value||'';document.querySelectorAll('.device-point').forEach(point=>{const device=point.device||{};const showPoint=(!selectedDept||device.dept_id===selectedDept)&&(!selectedUser||device.user_id===selectedUser);point.style.display=showPoint?'block':'none'})}
      // åœ¨å…¨å±€ä½œç”¨åŸŸå£°æ˜å›¾è¡¨å˜é‡
      let globalCharts = null;
      let currentDept = '', currentUser = '';
      const ALERT_TYPE_MAP = {
        heart_rate: 'å¿ƒç‡',
        blood_pressure: 'è¡€å‹',
        stress: 'å‹åŠ›',
        blood_oxygen: 'è¡€æ°§',
        temperature: 'ä½“æ¸©',
        one_key_alarm: 'ä¸€é”®æŠ¥è­¦',
        fall_down: 'è·Œå€’',
        sleep: 'ç¡çœ '
      };
      const ALERT_SEVERITY_MAP = {
        critical: 'ä¸¥é‡',
        high: 'é«˜',
        medium: 'ä¸­',
        low: 'ä½'
      };
      const ALERT_STATUS_MAP = {
        pending: 'å¾…å¤„ç†',
        responded: 'å·²å“åº”',
        resolved: 'å·²è§£å†³'
      };
      function translateAlertType(type) {
        return ALERT_TYPE_MAP[type] || type;
      }
      function translateAlertSeverity(severity) {
        return ALERT_SEVERITY_MAP[severity] || severity;
      }
      function translateAlertStatus(status) {
        return ALERT_STATUS_MAP[status] || status;
      }
      const ALERT_TYPE_COLOR = {
        heart_rate: '#ff6b6b',
        blood_pressure: '#ffb347',
        stress: '#f7b731',
        blood_oxygen: '#00e4ff',
        temperature: '#ffd700',
        one_key_alarm: '#ffe066',
        fall_down: '#00cfff',
        sleep: '#7ecfff'
      };
      const ALERT_SEVERITY_COLOR = {    
        critical: '#ff6b6b',
        high: '#ffb347',
        medium: '#f7b731',
        low: '#00e4ff'
      };
      const ALERT_STATUS_COLOR = {
        pending: '#ff6b6b',
        responded: '#ffb347',
        resolved: '#00e4ff'
      };
      function getAlertTypeColor(type) {
        return ALERT_TYPE_COLOR[type] || '#7ecfff';
      }
      function getAlertSeverityColor(severity) {
        return ALERT_SEVERITY_COLOR[severity] || '#7ecfff';
      }
      function getAlertStatusColor(status) {
        return ALERT_STATUS_COLOR[status] || '#7ecfff';
      }

      // æ·»åŠ æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
      function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }

      // ä¿®æ”¹initChartså‡½æ•°
      function initCharts() {
        try {
            let charts = {
                healthScore: null,
                stats: null,
                trend: null,
                alert: null
            };

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–å¥åº·è¯„åˆ†å›¾è¡¨
            const healthScoreContainer = document.getElementById('healthScoreChart');
            if (healthScoreContainer) {
                charts.healthScore = echarts.init(healthScoreContainer);
                
                // ä»URLè·å–customerIdå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                
                // è·å–æ—¥æœŸèŒƒå›´
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 7);
                
                const startDate = formatDate(yesterday);
                const endDate = formatDate(today);
                
                // è°ƒç”¨æ¥å£è·å–å¥åº·è¯„åˆ†æ•°æ®
                fetch(`/health_data/score?orgId=${customerId}&startDate=${startDate}&endDate=${endDate}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data && result.data.healthScores) {
                            const factors = result.data.healthScores.factors;
                            
                            // æ›´æ–°æ€»åˆ†æ˜¾ç¤º - ç®€åŒ–ç‰ˆæœ¬
                            const totalScoreElement = document.querySelector('.total-score');
                            if (totalScoreElement) {
                                const score = result.data.summary.overallScore;
                                const color = score >= 90 ? '#00ff66' : score >= 80 ? '#00ccff' : score >= 70 ? '#ffdd00' : score >= 60 ? '#ff8800' : '#ff3333';
                                const icon = score >= 90 ? 'ğŸ’š' : score >= 80 ? 'ğŸ’™' : score >= 70 ? 'ğŸ’›' : score >= 60 ? 'ğŸ§¡' : 'â¤ï¸';
                                totalScoreElement.style.color = color;
                                totalScoreElement.style.textShadow = `0 0 10px ${color}`;
                                totalScoreElement.innerHTML = `${score} <span style="font-size:12px;opacity:0.8;">${icon}</span>`;
                            }
                            
                            const healthScoreOption = {
                                backgroundColor: 'transparent',
                                tooltip: {
                                    trigger: 'item',
                                    backgroundColor: 'rgba(6,28,58,0.95)',
                                    borderColor: 'rgba(0,228,255,0.5)',
                                    borderWidth: 1,
                                    textStyle: {
                                        color: '#fff',
                                        fontSize: 14
                                    },
                                    formatter: function(params) {
                                        const indicators = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'æ­¥æ•°', 'å¡è·¯é‡Œ', 'æ”¶ç¼©å‹', 'èˆ’å¼ å‹', 'å‹åŠ›'];
                                        const index = params.dataIndex;
                                        const value = params.value[index];
                                        const name = indicators[index];
                                        return `<div style="padding:8px;">
                                            <div style="color:#00e4ff;font-weight:bold;margin-bottom:4px;">${name}</div>
                                            <div>å½“å‰å¾—åˆ†ï¼š<span style="color:#00ff9d;font-weight:bold;">${value}</span> åˆ†</div>
                                            <div style="margin-top:4px;font-size:12px;color:#7ecfff;">
                                                ${value >= 80 ? 'ä¼˜ç§€' : value >= 60 ? 'è‰¯å¥½' : value >= 40 ? 'ä¸€èˆ¬' : 'éœ€è¦å…³æ³¨'}
                                            </div>
                                        </div>`;
                                    }
                                },
                                radar: {
                                    radius: '70%',
                                    center: ['50%', '52%'],
                                    startAngle: 90,
                                    splitNumber: 4,
                                    indicator: [
                                        { 
                                            name: 'å¿ƒç‡\n' + (factors.heartRate?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.heartRate?.score >= 80 ? '#00ff9d' : factors.heartRate?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'è¡€æ°§\n' + (factors.bloodOxygen?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.bloodOxygen?.score >= 80 ? '#00ff9d' : factors.bloodOxygen?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'ä½“æ¸©\n' + (factors.temperature?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.temperature?.score >= 80 ? '#00ff9d' : factors.temperature?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'æ­¥æ•°\n' + (factors.step?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.step?.score >= 80 ? '#00ff9d' : factors.step?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'å¡è·¯é‡Œ\n' + (factors.calorie?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.calorie?.score >= 80 ? '#00ff9d' : factors.calorie?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'æ”¶ç¼©å‹\n' + (factors.pressureHigh?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.pressureHigh?.score >= 80 ? '#00ff9d' : factors.pressureHigh?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'èˆ’å¼ å‹\n' + (factors.pressureLow?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.pressureLow?.score >= 80 ? '#00ff9d' : factors.pressureLow?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        },
                                        { 
                                            name: 'å‹åŠ›\n' + (factors.stress?.score || 0) + 'åˆ†', 
                                            max: 100,
                                            color: factors.stress?.score >= 80 ? '#00ff9d' : factors.stress?.score >= 60 ? '#00e4ff' : '#ff6b6b'
                                        }
                                    ],
                                    name: {
                                        textStyle: {
                                            color: '#00e4ff',
                                            fontSize: 11,
                                            fontWeight: 'bold',
                                            lineHeight: 16
                                        }
                                    },
                                    splitArea: {
                                        show: true,
                                        areaStyle: {
                                            color: [
                                                'rgba(255,107,107,0.1)',
                                                'rgba(255,187,0,0.1)', 
                                                'rgba(0,228,255,0.1)',
                                                'rgba(0,255,157,0.15)'
                                            ]
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.6)',
                                            width: 2
                                        }
                                    },
                                    splitLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.4)',
                                            width: 1,
                                            type: 'dashed'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'å¥åº·æŒ‡æ ‡',
                                    type: 'radar',
                                    emphasis: {
                                        areaStyle: {
                                            color: 'rgba(0,255,157,0.6)'
                                        }
                                    },
                                    data: [{
                                        value: [
                                            factors.heartRate?.score || 0,
                                            factors.bloodOxygen?.score || 0,
                                            factors.temperature?.score || 0,
                                            factors.step?.score || 0,
                                            factors.calorie?.score || 0,
                                            factors.pressureHigh?.score || 0,
                                            factors.pressureLow?.score || 0,
                                            factors.stress?.score || 0
                                        ],
                                        name: 'å½“å‰å¥åº·çŠ¶æ€',
                                        symbol: 'circle',
                                        symbolSize: 8,
                                        lineStyle: {
                                            color: '#00e4ff',
                                            width: 3,
                                            shadowColor: 'rgba(0,228,255,0.5)',
                                            shadowBlur: 10
                                        },
                                        itemStyle: {
                                            color: '#00e4ff',
                                            borderColor: '#fff',
                                            borderWidth: 2,
                                            shadowColor: 'rgba(0,228,255,0.8)',
                                            shadowBlur: 8
                                        },
                                        areaStyle: {
                                            color: new echarts.graphic.RadialGradient(0.5, 0.5, 0.8, [
                                                { offset: 0, color: 'rgba(0,228,255,0.6)' },
                                                { offset: 0.5, color: 'rgba(0,228,255,0.3)' },
                                                { offset: 1, color: 'rgba(0,228,255,0.1)' }
                                            ]),
                                            shadowColor: 'rgba(0,228,255,0.3)',
                                            shadowBlur: 15
                                        }
                                    }],
                                    animationDuration: 2000,
                                    animationEasing: 'cubicOut'
                                }],
                                graphic: [{
                                    type: 'text',
                                    left: 'center',
                                    top: 'center',
                                    style: {
                                        text: `æ€»åˆ†\n${result.data.summary.overallScore}`,
                                        textAlign: 'center',
                                        fill: '#00e4ff',
                                        fontSize: 20,
                                        fontWeight: 'bold',
                                        shadowColor: 'rgba(0,228,255,0.5)',
                                        shadowBlur: 10
                                    }
                                }]
                            };
                            charts.healthScore.setOption(healthScoreOption);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0åˆ† - ç®€åŒ–ç‰ˆæœ¬
                            const totalScoreElement = document.querySelector('.total-score');
                            if (totalScoreElement) {
                                totalScoreElement.style.color = '#666666';
                                totalScoreElement.style.textShadow = '0 0 5px #666666';
                                totalScoreElement.innerHTML = '0 <span style="font-size:12px;opacity:0.8;">âšª</span>';
                            }
                            
                            const healthScoreOption = {
                                tooltip: {
                                    trigger: 'axis',
                                    formatter: function(params) {
                                        return params[0].name + '<br/>' +
                                               params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                    }
                                },
                                radar: {
                                    radius: '65%',
                                    center: ['50%', '55%'],
                                    indicator: [
                                        { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                        { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                        { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                        { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                        { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                        { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                        { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                        { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                    ],
                                    name: {
                                        textStyle: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            padding: [3, 5]
                                        },
                                        rich: {
                                            value: {
                                                color: '#00e4ff',
                                                fontSize: 12,
                                                fontWeight: 'normal'
                                            }
                                        }
                                    },
                                    splitArea: {
                                        show: true,
                                        areaStyle: {
                                            color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                        }
                                    },
                                    axisLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.5)'
                                        }
                                    },
                                    splitLine: {
                                        lineStyle: {
                                            color: 'rgba(0,228,255,0.3)'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'å¥åº·æŒ‡æ ‡',
                                    type: 'radar',
                                    data: [{
                                        value: [0, 0, 0, 0, 0, 0, 0, 0],
                                        name: 'å½“å‰çŠ¶æ€',
                                        itemStyle: {
                                            color: '#00e4ff'
                                        },
                                        areaStyle: {
                                            color: 'rgba(0,228,255,0.4)'
                                        }
                                    }]
                                }]
                            };
                            charts.healthScore.setOption(healthScoreOption);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching health data:', error);
                        // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤º0åˆ† - ç®€åŒ–ç‰ˆæœ¬
                        const totalScoreElement = document.querySelector('.total-score');
                        if (totalScoreElement) {
                            totalScoreElement.style.color = '#ff6666';
                            totalScoreElement.style.textShadow = '0 0 5px #ff6666';
                            totalScoreElement.innerHTML = 'é”™è¯¯ <span style="font-size:12px;opacity:0.8;">âš ï¸</span>';
                        }
                        // è®¾ç½®é»˜è®¤çš„0åˆ†å›¾è¡¨
                        const healthScoreOption = {
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    return params[0].name + '<br/>' +
                                           params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                }
                            },
                            radar: {
                                radius: '65%',
                                center: ['50%', '55%'],
                                indicator: [
                                    { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                    { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                    { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                    { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                    { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                    { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                    { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                    { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                ],
                                name: {
                                    textStyle: {
                                        color: '#00e4ff',
                                        fontSize: 12,
                                        padding: [3, 5]
                                    },
                                    rich: {
                                        value: {
                                            color: '#00e4ff',
                                            fontSize: 12,
                                            fontWeight: 'normal'
                                        }
                                    }
                                },
                                splitArea: {
                                    show: true,
                                    areaStyle: {
                                        color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                    }
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: 'rgba(0,228,255,0.5)'
                                    }
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: 'rgba(0,228,255,0.3)'
                                    }
                                }
                            },
                            series: [{
                                name: 'å¥åº·æŒ‡æ ‡',
                                type: 'radar',
                                data: [{
                                    value: [0, 0, 0, 0, 0, 0, 0, 0],
                                    name: 'å½“å‰çŠ¶æ€',
                                    itemStyle: {
                                        color: '#00e4ff'
                                    },
                                    areaStyle: {
                                        color: 'rgba(0,228,255,0.4)'
                                    }
                                }]
                            }]
                        };
                        charts.healthScore.setOption(healthScoreOption);
                    });
            }

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€å›¾è¡¨ - æ°´å¹³æ¡å½¢å›¾è®¾è®¡
            const statsContainer = document.getElementById('statsChart');
            if (statsContainer) {
                charts.stats = echarts.init(statsContainer);
                const statsOption = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0,30,60,0.95)',
                        borderColor: 'rgba(0,255,255,0.5)',
                        textStyle: { color: '#fff', fontSize: 12 },
                        axisPointer: {
                            type: 'shadow',
                            shadowStyle: { color: 'rgba(0,228,255,0.1)' }
                        }
                    },
                    grid: {
                        top: '8%',
                        left: '20%',
                        right: '15%',
                        bottom: '8%',
                        containLabel: false
                    },
                    xAxis: {
                        type: 'value',
                        max: 50,
                        axisLabel: {
                            color: '#99ddff',
                            fontSize: 10
                        },
                        axisLine: {
                            lineStyle: { color: 'rgba(0,255,255,0.3)' }
                        },
                        splitLine: {
                            lineStyle: { color: 'rgba(0,255,255,0.1)' }
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: ['ä½©æˆ´ä¸­', 'å……ç”µä¸­', 'ç¦»çº¿', 'åœ¨çº¿'],
                        axisLabel: {
                            color: '#ffffff',
                            fontSize: 11,
                            fontWeight: 500
                        },
                        axisLine: {
                            lineStyle: { color: 'rgba(0,255,255,0.3)' }
                        },
                        axisTick: { show: false }
                    },
                    series: [{
                        type: 'bar',
                        data: [
                            { value: 18, itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [{ offset: 0, color: '#00ff9d' }, { offset: 1, color: '#00cc7a' }]) }},
                            { value: 12, itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [{ offset: 0, color: '#ffbb00' }, { offset: 1, color: '#ff9500' }]) }},
                            { value: 6, itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [{ offset: 0, color: '#ff6666' }, { offset: 1, color: '#ff4444' }]) }},
                            { value: 32, itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [{ offset: 0, color: '#00e4ff' }, { offset: 1, color: '#0099cc' }]) }}
                        ],
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'right',
                            color: '#ffffff',
                            fontSize: 11,
                            fontWeight: 600,
                            formatter: '{c} å°'
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0,228,255,0.5)'
                            }
                        }
                    }]
                };
                charts.stats.setOption(statsOption);
            }

           

            // æ£€æŸ¥å¹¶åˆå§‹åŒ–è¶‹åŠ¿åˆ†æå›¾è¡¨
            

            // å‘Šè­¦å›¾è¡¨åˆå§‹åŒ–ç§»è‡³ç‹¬ç«‹çš„initAlertChartå‡½æ•°ï¼Œé¿å…åœ¨è¿™é‡Œé‡å¤åˆå§‹åŒ–
            // charts.alert = null; // å°†åœ¨initAlertChartä¸­åˆå§‹åŒ–

            // æ·»åŠ çª—å£resizeäº‹ä»¶ç›‘å¬
            window.addEventListener('resize', () => {
                Object.values(charts).forEach(chart => {
                    if (chart) {
                        chart.resize();
                    }
                });
            });

            // è¿”å›å›¾è¡¨å®ä¾‹å¯¹è±¡ï¼Œä»¥ä¾¿å…¶ä»–åœ°æ–¹å¯èƒ½éœ€è¦ä½¿ç”¨
            return charts;

        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // ä¿®æ”¹åˆå§‹åŒ–è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            initHubInteractions(); // åˆå§‹åŒ–HUBäº¤äº’
            globalCharts = initCharts(); // å­˜å‚¨å›¾è¡¨å®ä¾‹
            refreshData(); // åˆå§‹åŠ è½½æ•°æ®
            // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®
            setInterval(refreshData, 60000);
        }, 100);
    });

    // æ•°æ®æ˜ å°„å’ŒéªŒè¯å·¥å…·å‡½æ•°
    function extractRealData(apiData) {
        console.log('ğŸ” æå–çœŸå®APIæ•°æ®:', apiData);
        
        const deviceInfo = apiData.device_info || {};
        const alertInfo = apiData.alert_info || {};
        const userInfo = apiData.user_info || {};
        const healthInfo = apiData.health_data || {};
        const messageInfo = apiData.message_info || {};
        
        // è®¾å¤‡ç»Ÿè®¡æ•°æ®
        const deviceStats = {
            total: deviceInfo.totalDevices || 0,
            online: deviceInfo.deviceStatusCount?.ACTIVE || 0,
            offline: deviceInfo.deviceStatusCount?.INACTIVE || 0,
            charging: deviceInfo.deviceChargingCount?.CHARGING || 0,
            worn: deviceInfo.deviceWearableCount?.WORN || 0
        };
        
        // å‘Šè­¦ç»Ÿè®¡æ•°æ®
        const alertStats = {
            total: alertInfo.alerts?.length || 0,
            critical: alertInfo.severityCount?.critical || 0,
            high: alertInfo.severityCount?.high || 0,
            medium: alertInfo.severityCount?.medium || 0,
            low: alertInfo.severityCount?.low || 0,
            typeCount: alertInfo.alertTypeCount || {},
            statusCount: alertInfo.alertStatusCount || {}
        };
        
        // ç”¨æˆ·ç»Ÿè®¡æ•°æ®
        const userStats = {
            total: userInfo.totalUsers || deviceStats.total,
            online: userInfo.onlineUsers || deviceStats.online,
            departments: userInfo.departmentCount || 0
        };
        
        // å¥åº·ç»Ÿè®¡æ•°æ®
        const healthStats = {
            total: healthInfo.deviceCount || 0,
            dataCount: healthInfo.healthData?.length || 0
        };
        
        // æ¶ˆæ¯ç»Ÿè®¡æ•°æ®
        const messageStats = {
            total: messageInfo.messages?.length || 0,
            pending: messageInfo.messages?.filter(m => m.message_status === 'pending' || m.message_status === '1')?.length || 0
        };
        
        console.log('ğŸ“Š æå–çš„ç»Ÿè®¡æ•°æ®:', {
            deviceStats,
            alertStats,
            userStats,
            healthStats,
            messageStats
        });
        
        return {
            deviceStats,
            alertStats,
            userStats,
            healthStats,
            messageStats,
            raw: {
                device_info: deviceInfo,
                alert_info: alertInfo,
                user_info: userInfo,
                health_data: healthInfo,
                message_info: messageInfo
            }
        };
    }

    // åˆå§‹åŒ–æ€»ä½“è¿è¡Œæƒ…å†µå›¾è¡¨ - ä½¿ç”¨æå–çš„çœŸå®æ•°æ®
    function initOverallChart(data) {
        const overallContainer = document.getElementById('overallChart');
        if (!overallContainer) return;
        
        const overallChart = echarts.init(overallContainer);
        const stats = extractRealData(data);
        
        // è®¡ç®—è¿è¡ŒçŠ¶æ€åˆ†å¸ƒ
        const healthyOnline = Math.max(0, stats.deviceStats.online - stats.alertStats.total);
        const alertDevice = stats.alertStats.total;
        const offlineDevice = stats.deviceStats.offline || (stats.deviceStats.total - stats.deviceStats.online);
        
        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'item',
                backgroundColor: 'rgba(0,30,60,0.95)',
                borderColor: 'rgba(0,255,255,0.5)',
                textStyle: { color: '#fff', fontSize: 12 },
                formatter: '{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'horizontal',
                bottom: '8%',
                left: 'center',
                textStyle: { color: '#00e4ff', fontSize: 10 },
                itemWidth: 8,
                itemHeight: 8
            },
            series: [{
                name: 'è¿è¡ŒçŠ¶æ€',
                type: 'pie',
                radius: ['35%', '65%'],
                center: ['50%', '45%'],
                avoidLabelOverlap: false,
                label: {
                    show: true,
                    position: 'outside',
                    fontSize: 11,
                    color: '#fff',
                    formatter: '{c}'
                },
                emphasis: {
                    label: { show: true, fontSize: 12, fontWeight: 'bold' }
                },
                data: [
                    { value: healthyOnline, name: 'å¥åº·åœ¨çº¿', itemStyle: { color: '#00ff66' }},
                    { value: alertDevice, name: 'å‘Šè­¦çŠ¶æ€', itemStyle: { color: '#ff6b6b' }},
                    { value: offlineDevice, name: 'ç¦»çº¿è®¾å¤‡', itemStyle: { color: '#888888' }}
                ].filter(item => item.value > 0)
            }]
        };
        overallChart.setOption(option);
        
        if (!window.globalCharts) window.globalCharts = {};
        window.globalCharts.overall = overallChart;
    }

    // ä¿®æ”¹æ¶ˆæ¯åˆ—è¡¨åˆå§‹åŒ– - ç‚«é…·æ»šåŠ¨æ•ˆæœ
    function initMessageList(messageInfo) {
        const messageList = document.getElementById('messageList');
        const messageCount = document.getElementById('messageCount');
        
        if (!messageList || !messageCount) return;
    
        // ç›´æ¥æ˜¾ç¤ºæ¨¡æ‹Ÿæ¶ˆæ¯æ•°æ®ï¼Œç¡®ä¿å†…å®¹å¯è§
        const displayMessages = [
            { department_name: 'ç³»ç»Ÿ', user_name: 'è¿ç»´ä¸­å¿ƒ', message: 'æ‰€æœ‰è®¾å¤‡è¿è¡Œæ­£å¸¸', priority: 'low', received_time: new Date().toLocaleString() },
            { department_name: 'å¥åº·', user_name: 'ç›‘æ§ç³»ç»Ÿ', message: 'å¿ƒç‡ç›‘æµ‹æ­£å¸¸ï¼Œè¡€æ°§é¥±å’Œåº¦è‰¯å¥½', priority: 'low', received_time: new Date().toLocaleString() },
            { department_name: 'å®‰å…¨', user_name: 'å‘Šè­¦ä¸­å¿ƒ', message: 'æœªå‘ç°å¼‚å¸¸å‘Šè­¦ä¿¡æ¯', priority: 'low', received_time: new Date().toLocaleString() },
            { department_name: 'è®¾å¤‡', user_name: 'ç®¡ç†ç³»ç»Ÿ', message: 'è®¾å¤‡è¿æ¥çŠ¶æ€ç¨³å®š', priority: 'low', received_time: new Date().toLocaleString() },
            { department_name: 'æ•°æ®', user_name: 'åˆ†æå¼•æ“', message: 'æ•°æ®é‡‡é›†å’Œåˆ†ææ­£å¸¸', priority: 'low', received_time: new Date().toLocaleString() }
        ];
        
        // æ›´æ–°æ¶ˆæ¯è®¡æ•° - æ˜¾ç¤ºå®é™…è¦å±•ç¤ºçš„æ¶ˆæ¯æ•°é‡
        messageCount.textContent = displayMessages.length;
    
        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
        messageList.innerHTML = '';
        messageList.className = 'message-scroll';
    
        // åˆ›å»ºæ»šåŠ¨å®¹å™¨
        const scrollContainer = document.createElement('div');
        scrollContainer.className = 'message-content-scroll';
    
        // æ·»åŠ æ‰€æœ‰æ¶ˆæ¯ï¼ˆé‡å¤ä¸¤éå®ç°æ— ç¼æ»šåŠ¨ï¼‰
        const createMessageSet = () => {
            return displayMessages.map(message => {
                const priority = message.priority || (Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low');
                const priorityText = priority === 'high' ? 'ç´§æ€¥' : priority === 'medium' ? 'æ™®é€š' : 'æ­£å¸¸';
                return `
                    <div class="message-item-scroll">
                        <div class="message-header-scroll">
                            <span class="message-user">${message.department_name || 'ç³»ç»Ÿ'}-${message.user_name || 'ç³»ç»Ÿ'}</span>
                            <div>
                                <span class="message-priority priority-${priority}">${priorityText}</span>
                                <span class="message-time">${message.received_time || new Date().toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="message-text">${message.message || 'æ— æ¶ˆæ¯å†…å®¹'}</div>
                    </div>
                `;
            }).join('');
        };
        
        // åˆ›å»ºä¸¤ç»„ç›¸åŒçš„æ¶ˆæ¯å®ç°æ— ç¼å¾ªç¯
        scrollContainer.innerHTML = createMessageSet() + createMessageSet();
        messageList.appendChild(scrollContainer);
        
        // é¼ æ ‡æ‚¬åœæš‚åœæ»šåŠ¨
        messageList.addEventListener('mouseenter', () => {
            scrollContainer.style.animationPlayState = 'paused';
        });
        
        messageList.addEventListener('mouseleave', () => {
            scrollContainer.style.animationPlayState = 'running';
        });
    }
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=7de0c6b90cb13571ce931ca75a66c6e7"></script> 
    <script src="https://webapi.amap.com/loca?v=2.0.0&key=7de0c6b90cb13571ce931ca75a66c6e7"></script>
    <script>
      // Declare infoWindow globally
      // let infoWindow; // ç§»é™¤
      let geoLevelF,geoLevelE,geo,map,loca,breathGreen,breathRed,breathYellow;//å˜é‡åˆå¹¶

      async function getFirstCoordinates(map, deptId, userId) {
        try {
          console.log('getFirstCoordinates.deptId',deptId);
          console.log('getFirstCoordinates.userId',userId);
          const response = await fetch(`./generateAlertJson?customerId=${deptId}&userId=${userId}`);
          console.log('getFirstCoordinates.response',response);
          const result = await response.json();
          if (result.features && result.features.length > 0) {
            const coordinates = result.features[0].geometry.coordinates;
            map.setCenter(coordinates);
            console.log('getFirstCoordinates.coordinates',coordinates);
            return coordinates;
          } else {
            const response1 = await fetch(`./generateHealthJson?customerId=${deptId}&userId=${userId}`);
            const result1 = await response1.json();
            if (result1.features && result1.features.length > 0) {
              const coordinates = result1.features[0].geometry.coordinates;
              map.setCenter(coordinates);
              console.log('getFirstCoordinates.coordinates',coordinates);
              return coordinates;
            } else {
              return [114.01508952, 22.54036796, 0];
            }
          }
        } catch (error) {
            console.error('Error accessing coordinates:', error);
            return [114.01508952, 22.54036796, 0]; // é»˜è®¤åæ ‡
        }
      }

      async function updateGeoJSONSources(deptId, userId) {
        try {
            console.log('Updating GeoJSON sources...', { deptId, userId });
    
            // æ„å»ºURLå‚æ•°
            const params = new URLSearchParams({
                customerId: deptId || '1',
                userId: userId || '-1'
            }).toString();
    
            // è·å–æ•°æ®
            console.log('updateGeoJSONSources.params',`./generateHealthJson?${params}`);
            const [criticalData, highData, healthData] = await Promise.all([
                fetch(`./generateAlertJson?${params}&severityLevel=critical`).then(res => res.json()),
                fetch(`./generateAlertJson?${params}&severityLevel=high`).then(res => res.json()),
                fetch(`./generateHealthJson?${params}`).then(res => res.json())
            ]);
    
            // åˆ›å»ºæ–°çš„æ•°æ®æº
            const newGeoLevelF = new Loca.GeoJSONSource({
                data: criticalData
            });
    
            const newGeoLevelE = new Loca.GeoJSONSource({
                data: highData
            });
    
            const newGeo = new Loca.GeoJSONSource({
                data: healthData
            });
    
            // æ›´æ–°å›¾å±‚æ•°æ®æº
            breathRed.setSource(newGeoLevelF);
            breathYellow.setSource(newGeoLevelE);
            breathGreen.setSource(newGeo);
    
            // æ›´æ–°åœ°å›¾ä¸­å¿ƒç‚¹
            if (healthData.features && healthData.features.length > 0) {
                const coordinates = healthData.features[0].geometry.coordinates;
                console.log('updateGeoJSONSources.coordinates',coordinates);
                map.setCenter(coordinates);
            }
    
            // é‡æ–°å¯åŠ¨åŠ¨ç”»
            loca.animate.start();
    
            console.log('GeoJSON sources updated successfully');
    
        } catch (error) {
            console.error('Error updating GeoJSON sources:', error);
        }
    }


      function initializeMap(deptId, userId) {
        //console.log(AMap); // å¦‚æœæ‰“å° `undefined`ï¼Œè¯´æ˜ AMap æ²¡æœ‰æ­£ç¡®åŠ è½½
        //console.log(Loca); // å¦‚æœæ‰“å° `undefined`ï¼Œè¯´æ˜ Loca æ²¡æœ‰æ­£ç¡®åŠ è½½
        //console.log('initializeMap.deptId',deptId);
        //console.log('initializeMap.userId',userId);
        //console.log('initializeMap.severityLevel',`./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=critical`);

        geoLevelF = new Loca.GeoJSONSource({
          url: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=critical`
        });
    
    
        // é»„è‰²å‘Šè­¦ç‚¹
        geoLevelE = new Loca.GeoJSONSource({
            url: `./generateAlertJson?customerId=${deptId}&userId=${userId}&severityLevel=high`
        });

        // ç»¿è‰²å¥åº·ç‚¹
        geo = new Loca.GeoJSONSource({
            url: `./generateHealthJson?customerId=${deptId}&userId=${userId}`
        });

        console.log('geo',geo);
      
      
        let current_coordinates = {
          
          'longitude': 114.01508952,
          'latitude': 22.58036796,
          'altitude': 0
        }
    
        //console.log('current_coordinates',current_coordinates);
  
          map = window.map = new AMap.Map('map-container', {
              zoom: 17,
              center: [current_coordinates['longitude'],current_coordinates['latitude']],
              pitch: 45,
              showLabel: false,
              mapStyle: 'amap://styles/blue',
              viewMode: '3D',
          });

        //const api_coordinates = getFirstCoordinates(map,deptId,userId);
          

          loca = new Loca.Container({
            map,
          });
        
          breathGreen = new Loca.ScatterLayer({
            loca,
            zIndex: 113,
            opacity: 1,
            visible: true,
            zooms: [2, 22],
          });
  
        breathGreen.setSource(geo);
        //console.log("BreathGreen GeoJSON data:", breathGreen);
        breathGreen.setStyle({
            unit: 'meter',
            color: 'rgb(39, 207, 14)',
            size: [10, 10],
            borderWidth: 0,
            exture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_green.png',
            //texture: 'http://localhost:5001/static/images/avarta.png',
            duration: 500,
            animate: true,
        });
        
        // æ·»åŠ åˆ°åœ°å›¾ä¸­
        loca.add(breathGreen);
      
        // åˆ›å»ºçº¢è‰²å‘¼å¸ç‚¹å›¾å±‚
        breathRed = new Loca.ScatterLayer({
            loca,
            zIndex: 113,
            opacity: 1,
            visible: true,
            zooms: [2, 22],
        });
        //console.log('Health data:',geoLevelF);
        
        breathRed.setSource(geoLevelF);
        //console.log("BreathRed GeoJSON data:", breathRed);
        breathRed.setStyle({
            unit: 'meter',
            size: [60, 60],
            borderWidth: 0,
            texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_red.png',
            duration: 500,
            animate: true,
        });
        
        // æ·»åŠ åˆ°åœ°å›¾ä¸­
        loca.add(breathRed);
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¼¹å‡ºä¿¡æ¯æ¡†
        map.on('click',e=>{const p=e.pixel.toArray();let f=breathRed.queryFeature(p)||breathYellow.queryFeature(p)||breathGreen.queryFeature(p);if(f&&f.coordinates){showCustomMapInfo(f)}else{removeCustomMapInfo()}});//ä¼˜å…ˆçº§ä¿®æ­£
         
         
          
          breathYellow = new Loca.ScatterLayer({
              loca,
              zIndex: 112,
              opacity: 1,
              visible: true,
              zooms: [2, 22],
          });
          breathYellow.setSource(geoLevelE);
          //console.log("BreathYellow GeoJSON data:", breathYellow);
          breathYellow.setStyle({
              unit: 'meter',
              size: [50, 50],
              borderWidth: 0,
              texture: 'https://a.amap.com/Loca/static/loca-v2/demos/images/breath_yellow.png',
              duration: 1000,
              animate: true,
          });
          loca.add(breathYellow);
      
          
          

          
          //console.log("GeoJSON data for BreathRed:", geoLevelF);
     
          //console.log("Map center:", map.getCenter());
      
      
          // å¯åŠ¨æ¸²æŸ“åŠ¨ç”»
          loca.animate.start();
      
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºä¿¡æ¯æ¡†
          // var infoWindow = new AMap.InfoWindow({
          //     offset: new AMap.Pixel(0, -30),
          // });
      
      
      
          // var dat = new Loca.Dat();
          // dat.addLayer(breathGreen, 'ç»¿è‰²');
          // dat.addLayer(breathRed, 'çº¢è‰²');
          // dat.addLayer(breathYellow, 'é»„è‰²');

  
    // Function to fetch weather data
  
  
   
  
  }
  
  initializeMap('{{ customerId }}','-1');


  
  async function reverseGeocode(lng, lat) {
    try {
        const response = await fetch(`https://restapi.amap.com/v3/geocode/regeo?key=d45f28e481665db5b1145a5aa989e68a&location=${lng},${lat}`);
        const data = await response.json();
        
        if (data.status === '1') {
            const address = data.regeocode.formatted_address;
            console.log('Address:', address);
            return address;
        } else {
            console.error('Failed to reverse geocode:', data.info);
            return null;
        }
    } catch (error) {
        console.error('Error during reverse geocoding:', error);
        return null;
    }
  }


  function handleAlert(alertId) {
    fetch(`./dealAlert?alertId=${alertId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Alert processed:', data);
                showCustomAlert(data.message, () => {
                    location.reload();
                });
            } else {
                console.error('Failed to process alert:', data.message);
                showCustomAlert('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', null);
            }
        })
        .catch(error => {
            console.error('Error processing alert:', error);
            showCustomAlert('å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•', null);
        });
}

// æ·»åŠ è‡ªå®šä¹‰å¼¹å‡ºæ¡†å‡½æ•°
function showCustomAlert(message, callback) {
    // åˆ›å»ºé®ç½©å±‚
    const overlay = document.createElement('div');
    overlay.className = 'custom-alert-overlay';
    document.body.appendChild(overlay);

    // åˆ›å»ºå¼¹å‡ºæ¡†
    const alertBox = document.createElement('div');
    alertBox.className = 'custom-alert';
    alertBox.innerHTML = `
        <div class="custom-alert-content">${message}</div>
        <button class="custom-alert-button">ç¡®å®š</button>
    `;
    document.body.appendChild(alertBox);

    // æ·»åŠ ç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const confirmButton = alertBox.querySelector('.custom-alert-button');
    confirmButton.onclick = () => {
        document.body.removeChild(overlay);
        document.body.removeChild(alertBox);
        if (callback) callback();
    };
}

  
  function mapAlertStatus(alertStatus) {
    switch (alertStatus) {
        case 'responded':
            return 'å·²å¤„ç†';
        case 'pending':
            return 'æœªå¤„ç†';
        case 'closed':
            return 'å·²å…³é—­';
        default:
            return 'æœªçŸ¥';
    }
}

// æ·»åŠ åœ¨å…¶ä»– JavaScript ä»£ç ä¹‹å‰
function toggleFilter() {
    const filterPanel = document.querySelector('.filter-panel');
    const filterContainer = document.querySelector('.filter-container');
    const toggleButton = document.querySelector('.filter-toggle i');

    console.log('toggleFilter', toggleButton);
    
    if (filterPanel.classList.contains('collapsed')) {
        // å±•å¼€é¢æ¿
        filterPanel.classList.remove('collapsed');
        toggleButton.classList.remove('fa-search');
        toggleButton.classList.add('fa-times');
        filterContainer.style.display = 'flex';
    } else {
        // æ”¶èµ·é¢æ¿
        filterPanel.classList.add('collapsed');
        toggleButton.classList.remove('fa-times');
        toggleButton.classList.add('fa-search');
        filterContainer.style.display = 'none';
    }
}

// æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­ç­›é€‰é¢æ¿çš„åŠŸèƒ½
document.addEventListener('click', function(event) {
    const filterPanel = document.querySelector('.filter-panel');
    const filterToggle = document.querySelector('.filter-toggle');
    
    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç­›é€‰é¢æ¿å†…çš„å…ƒç´ ä¸”é¢æ¿æ˜¯å±•å¼€çš„
    if (!filterPanel.contains(event.target) && 
        !filterToggle.contains(event.target) && 
        !filterPanel.classList.contains('collapsed')) {
        toggleFilter();
    }
});

// é˜»æ­¢ç­›é€‰é¢æ¿å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
document.querySelector('.filter-panel').addEventListener('click', function(event) {
    event.stopPropagation();
});

// åˆå§‹åŒ–äººå‘˜ç®¡ç†é¢æ¿
function initPersonnelManagementPanel(data) {
    // æ›´æ–°æ€»è§ˆæ•°æ®
    document.getElementById('totalUsers').innerText = data.user_info.totalUsers;
    document.getElementById('totalBindDevices').innerText = data.user_info.totalDevices;

    // åˆå§‹åŒ–éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨
    initDepartmentDistribution(data);
}

// ä¿®æ”¹åˆå§‹åŒ–éƒ¨é—¨åˆ†å¸ƒå›¾è¡¨å‡½æ•°
function initDepartmentDistribution(data) {
    const departmentChart = echarts.init(document.getElementById('departmentDistribution'));
    
    // å¤„ç†éƒ¨é—¨æ•°æ®
    const departmentData = Object.entries(data.user_info.departmentCount)
        .map(([name, value]) => ({
            name,
            value
        }))
        .sort((a, b) => b.value - a.value);

    const option = {
        tooltip: {
            trigger: 'item',
            formatter: function(params) {
                return `${params.name}<br/>äººæ•°: ${params.value}äºº<br/>å æ¯”: ${params.percent}%`;
            },
            backgroundColor: 'rgba(0,21,41,0.9)',
            borderColor: 'rgba(0,228,255,0.2)',
            textStyle: {
                color: '#fff'
            }
        },
        legend: {
            type: 'scroll',
            orient: 'horizontal',
            top: 0,
            left: 'center',
            width: '90%',
            height: 30,
            itemWidth: 15,
            itemHeight: 10,
            itemGap: 20,
            textStyle: {
                color: '#fff',
                fontSize: 12,
                lineHeight: 30,
                rich: {
                    name: {
                        color: '#fff',
                        padding: [0, 5, 0, 0]
                    },
                    value: {
                        color: '#00e4ff'
                    }
                }
            },
            formatter: function(name) {
                const item = departmentData.find(d => d.name === name);
                return `{name|${name}} {value|${item.value}äºº}`;
            },
            pageTextStyle: {
                color: '#fff'
            },
            pageIconColor: '#00e4ff',
            pageIconInactiveColor: 'rgba(0, 240, 255, 0.3)',
            pageIconSize: 12,
            pageButtonItemGap: 5,
            pageButtonGap: 10,
            pageButtonPosition: 'end',
            animation: true,
            animationDurationUpdate: 1000
        },
        series: [{
            type: 'pie',
            radius: ['30%', '70%'],
            center: ['50%', '60%'],
            avoidLabelOverlap: true,
            itemStyle: {
                borderColor: '#fff',
                borderWidth: 1
            },
            label: {
                show: false
            },
            labelLine: {
                show: false
            },
            data: departmentData,
            color: ['#00e4ff', '#00a8ff', '#0080ff', '#48cae4', '#90e0ef']
        }]
    };

    departmentChart.setOption(option);
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
        departmentChart.resize();
    });

    // è‡ªåŠ¨æ»šåŠ¨å›¾ä¾‹
    let currentIndex = 0;
    const scrollLegend = () => {
        if (departmentData.length <= 5) return; // å¦‚æœå›¾ä¾‹é¡¹è¾ƒå°‘ï¼Œä¸éœ€è¦æ»šåŠ¨
        
        currentIndex = (currentIndex + 1) % departmentData.length;
        departmentChart.setOption({
            legend: {
                scrollDataIndex: currentIndex
            }
        });
    };

    // æ¯3ç§’æ»šåŠ¨ä¸€æ¬¡
    const scrollInterval = setInterval(scrollLegend, 3000);

    // é¼ æ ‡æ‚¬åœæ—¶æš‚åœæ»šåŠ¨
    const container = document.querySelector('.personnel-management');
    if (container) {
        container.addEventListener('mouseenter', () => {
            clearInterval(scrollInterval);
        });

        container.addEventListener('mouseleave', () => {
            clearInterval(scrollInterval); // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            setInterval(scrollLegend, 3000); // é‡æ–°å¼€å§‹æ»šåŠ¨
        });
    }

    // é˜»æ­¢å›¾ä¾‹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
    const chartContainer = document.querySelector('.personnel-management .chart-container');
    if (chartContainer) {
        chartContainer.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    }
}
function getPastDateStr(daysAgo) {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    return d.toISOString().slice(0,10);
  }
  
  function loadBaselineTrendChart(orgId) {
    const colorMap = {
      'å¿ƒç‡': '#ff6b6b',
      'è¡€æ°§': '#00ff9d',
      'ä½“æ¸©': '#ffbb00',
      'å‹åŠ›': '#ff4757',
      'ç¡çœ ': '#00a8ff',
    };
    const iconMap = {
      'å¿ƒç‡': 'ğŸ’“',
      'è¡€æ°§': 'ğŸ’¨',
      'ä½“æ¸©': 'ğŸŒ¡ï¸',
      'å‹åŠ›': 'âš¡',
      'ç¡çœ ': 'ğŸ˜´',
    };
    const endDate = getPastDateStr(0), startDate = getPastDateStr(6);
    fetch(`/health_data/chart/baseline?orgId=${orgId}&startDate=${startDate}&endDate=${endDate}`)
      .then(r=>r.json())
      .then(result=>{
        const {dates, metrics} = result;
        const legendNames = metrics.map(m=>m.name);
        const series = metrics.map((m,index)=>({
          name: m.name,
          type: 'line',
          data: m.values,
          smooth: true,
          symbol: 'circle',
          symbolSize: 10,
          showSymbol: true,
          emphasis: {
            focus: 'series',
            symbolSize: 15,
            lineStyle: { width: 4 }
          },
          lineStyle: { 
            width: 3, 
            color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
              { offset: 0, color: colorMap[m.name] || '#fff' },
              { offset: 1, color: (colorMap[m.name] || '#fff') + '66' }
            ]),
            shadowColor: colorMap[m.name] || '#fff',
            shadowBlur: 8
          },
          itemStyle: { 
            color: colorMap[m.name] || '#fff',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: colorMap[m.name] || '#fff',
            shadowBlur: 6
          },
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: (colorMap[m.name] || '#fff') + '33' },
              { offset: 1, color: (colorMap[m.name] || '#fff') + '00' }
            ])
          },
          connectNulls: true,
          animationDelay: function(idx) {
            return idx * 100;
          }
        }));
        
        const option = {
          backgroundColor: 'transparent',
          title: {
            text: 'å¥åº·è¶‹åŠ¿æ™ºèƒ½åˆ†æ',
            subtext: '7å¤©å¥åº·æŒ‡æ ‡å˜åŒ–è¶‹åŠ¿',
            textStyle: {
              color: '#00e4ff',
              fontSize: 16,
              fontWeight: 'bold'
            },
            subtextStyle: {
              color: '#7ecfff',
              fontSize: 12
            },
            left: 'center',
            top: 5
          },
          tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(6,28,58,0.95)',
            borderColor: 'rgba(0,228,255,0.5)',
            borderWidth: 1,
            textStyle: { color: '#fff', fontSize: 13 },
            extraCssText: 'box-shadow:0 0 15px rgba(0,228,255,0.3);border-radius:8px;padding:12px;',
            formatter: params => {
              let t = `<div style='color:#00e4ff;font-weight:bold;margin-bottom:8px;font-size:14px;'>${params[0].axisValue}</div>`;
              params.forEach(p=>{
                const icon = iconMap[p.seriesName] || 'ğŸ“Š';
                const trend = p.dataIndex > 0 ? 
                  (p.data > params.find(pp => pp.seriesName === p.seriesName && pp.dataIndex === p.dataIndex - 1)?.data ? 'ğŸ“ˆ' : 'ğŸ“‰') : '';
                t += `<div style="display:flex;align-items:center;margin-bottom:4px;padding:2px 0;">
                  <span style="font-size:16px;margin-right:6px;">${icon}</span>
                  <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${p.color};margin-right:8px;"></span>
                  <span style="color:#fff;font-weight:500;">${p.seriesName}</span>
                  <span style="flex:1;text-align:right;">
                    <span style="color:#00e4ff;font-weight:bold;">${p.data==null?'-':p.data}</span>
                    <span style="margin-left:4px;">${trend}</span>
                  </span>
                </div>`;
              });
              return t;
            }
          },
          legend: {
            data: legendNames.map(name => ({
              name: name,
              textStyle: { color: '#7ecfff', fontSize: 12, fontWeight: 500 }
            })),
            top: 35,
            left: 'center',
            icon: 'circle',
            itemWidth: 12,
            itemHeight: 12,
            itemGap: 20,
            formatter: function(name) {
              const icon = iconMap[name] || 'ğŸ“Š';
              return `${icon} ${name}`;
            }
          },
          grid: { 
            left: '4%', 
            right: '4%', 
            bottom: '8%', 
            top: '20%',
            containLabel: true 
          },
          xAxis: {
            type: 'category',
            data: dates,
            boundaryGap: false,
            axisLabel: { 
              color: '#7ecfff', 
              fontSize: 12,
              rotate: dates.length > 10 ? 45 : 0
            },
            axisLine: { 
              lineStyle: { 
                color: 'rgba(0,228,255,0.3)',
                width: 2
              } 
            },
            axisTick: {
              lineStyle: {
                color: 'rgba(0,228,255,0.3)'
              }
            },
            splitLine: { show: false }
          },
          yAxis: {
            type: 'value',
            axisLabel: { 
              color: '#7ecfff', 
              fontSize: 12,
              formatter: function(value) {
                return value.toFixed(1);
              }
            },
            axisLine: { 
              lineStyle: { 
                color: 'rgba(0,228,255,0.2)' 
              } 
            },
            splitLine: { 
              lineStyle: { 
                color: 'rgba(0,228,255,0.1)', 
                type: 'dashed' 
              } 
            }
          },
          dataZoom: [
            {
              type: 'inside',
              start: 0,
              end: 100
            }
          ],
          series,
          animationDuration: 2000,
          animationEasing: 'cubicOut'
        };
        
        const trendChart = echarts.init(document.getElementById('trendChart'));
        trendChart.setOption(option);
        
        // æ·»åŠ è‡ªåŠ¨é«˜äº®æ•ˆæœ
        let currentSeriesIndex = 0;
        const highlightTimer = setInterval(() => {
          trendChart.dispatchAction({ type: 'downplay' });
          trendChart.dispatchAction({
            type: 'highlight',
            seriesIndex: currentSeriesIndex
          });
          currentSeriesIndex = (currentSeriesIndex + 1) % series.length;
        }, 3000);
        
        // é¼ æ ‡æ‚¬åœæ—¶åœæ­¢è‡ªåŠ¨é«˜äº®
        document.getElementById('trendChart').addEventListener('mouseenter', () => clearInterval(highlightTimer));
      })
      .catch(error => {
        console.error('è¶‹åŠ¿æ•°æ®åŠ è½½å¤±è´¥:', error);
        // æ˜¾ç¤ºé»˜è®¤çš„ç©ºç™½å›¾è¡¨
        const defaultOption = {
          backgroundColor: 'transparent',
          title: {
            text: 'å¥åº·è¶‹åŠ¿æ™ºèƒ½åˆ†æ',
            subtext: 'æš‚æ— æ•°æ®',
            textStyle: { color: '#00e4ff', fontSize: 16 },
            subtextStyle: { color: '#7ecfff', fontSize: 12 },
            left: 'center'
          },
          graphic: {
            type: 'text',
            left: 'center',
            top: 'center',
            style: {
              text: 'ğŸ“Š\næš‚æ— è¶‹åŠ¿æ•°æ®',
              textAlign: 'center',
              fill: '#7ecfff',
              fontSize: 16
            }
          }
        };
        echarts.init(document.getElementById('trendChart')).setOption(defaultOption);
      });
  }

// æ·»åŠ æ•°æ®æµåŠ¨æ•ˆæœ
function createDataFlowEffect() {
    const container = document.querySelector('.hub-main');
    if (!container) return;
    
    // åˆ›å»ºæ•°æ®æµç²’å­
    for (let i = 0; i < 3; i++) {
        setTimeout(() => {
            const particle = document.createElement('div');
            particle.className = 'data-flow-particle';
            particle.style.cssText = `
                position: absolute;
                width: 4px;
                height: 4px;
                background: rgba(0,228,255,0.8);
                border-radius: 50%;
                box-shadow: 0 0 10px rgba(0,228,255,0.6);
                z-index: 10;
                pointer-events: none;
                animation: dataStreamFlow 6s linear infinite;
                left: ${Math.random() * 100}%;
                top: ${Math.random() * 100}%;
            `;
            container.appendChild(particle);
            
            // 3ç§’åç§»é™¤ç²’å­
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 6000);
        }, i * 2000);
    }
}

// æ·»åŠ å®æ—¶æ•°æ®æ›´æ–°åŠ¨ç”»
function animateValueUpdate(element, newValue, duration = 1000) {
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const startTime = performance.now();
    
    function updateValue(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const currentValue = Math.round(startValue + (newValue - startValue) * easeOutQuart);
        
        element.textContent = currentValue;
        element.style.textShadow = `0 0 ${15 + Math.sin(progress * Math.PI) * 10}px rgba(0,228,255,${0.4 + Math.sin(progress * Math.PI) * 0.4})`;
        
        if (progress < 1) {
            requestAnimationFrame(updateValue);
        }
    }
    
    requestAnimationFrame(updateValue);
}

// æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
function addLoadingIndicator() {
    removeLoadingIndicator(); // å…ˆç§»é™¤å­˜åœ¨çš„æŒ‡ç¤ºå™¨
    
    const indicator = document.createElement('div');
    indicator.id = 'loadingIndicator';
    indicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        background: rgba(6,28,58,0.95);
        border: 2px solid rgba(0,228,255,0.5);
        border-radius: 12px;
        padding: 20px 30px;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 30px rgba(0,228,255,0.3);
        animation: loadingPulse 2s ease-in-out infinite;
    `;
    
    indicator.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px; color: #00e4ff;">
            <div style="width: 20px; height: 20px; border: 2px solid rgba(0,228,255,0.3); border-top: 2px solid #00e4ff; border-radius: 50%; animation: loadingRotate 1s linear infinite;"></div>
            <span style="font-size: 14px; font-weight: 500;">æ­£åœ¨æ›´æ–°æ•°æ®...</span>
        </div>
    `;
    
    document.body.appendChild(indicator);
}

// ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
function removeLoadingIndicator() {
    const indicator = document.getElementById('loadingIndicator');
    if (indicator) {
        indicator.style.opacity = '0';
        indicator.style.transform = 'translate(-50%, -50%) scale(0.8)';
        indicator.style.transition = 'all 0.3s ease';
        setTimeout(() => {
            if (indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }, 300);
    }
}

// ä¿®æ”¹æ•°æ®åˆ·æ–°å‡½æ•°
function refreshData() {
    // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
    addLoadingIndicator();
    
    // ä» URL è·å– customerId å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    console.log('urlParams', urlParams.get('customerId'));
    const customerId = urlParams.get('customerId') || '1';
    loadBaselineTrendChart(customerId);
    
    // åˆ›å»ºæ•°æ®æµåŠ¨æ•ˆæœ
    createDataFlowEffect();

    fetch(`/get_total_info?customer_id=${customerId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const data = result.data;
                console.log('Refreshing data:', data);

                lastTotalInfo = data;
                updateMapData(lastTotalInfo);

                // åˆ·æ–°æ‰€æœ‰å›¾è¡¨
                if (globalCharts) {
                    // æ›´æ–°å¥åº·è¯„åˆ†å›¾è¡¨
                    if (globalCharts.healthScore) {
                        // è·å–æ—¥æœŸèŒƒå›´
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 7);
                        
                        const startDate = formatDate(yesterday);
                        const endDate = formatDate(today);
                        
                        fetch(`/health_data/score?orgId=${customerId}&startDate=${startDate}&endDate=${endDate}`)
                            .then(response => response.json())
                            .then(result => {
                                if (result.success && result.data && result.data.healthScores) {
                                    const factors = result.data.healthScores.factors;
                                    console.log('factors',factors);
                                    
                                    // æ›´æ–°æ€»åˆ†æ˜¾ç¤º - çŠ¶æ€æ é€‚é…ç‰ˆæœ¬
                                    const totalScoreElement = document.querySelector('.total-score');
                                    if (totalScoreElement) {
                                        const score = result.data.summary.overallScore || 0;
                                        const level = score >= 90 ? 'ä¼˜ç§€' : score >= 80 ? 'è‰¯å¥½' : score >= 70 ? 'ä¸€èˆ¬' : score >= 60 ? 'åä½' : 'éœ€æ”¹å–„';
                                        const color = score >= 90 ? '#00ff66' : score >= 80 ? '#00ccff' : score >= 70 ? '#ffdd00' : score >= 60 ? '#ff8800' : '#ff3333';
                                        const icon = score >= 90 ? 'ğŸ’š' : score >= 80 ? 'ğŸ’™' : score >= 70 ? 'ğŸ’›' : score >= 60 ? 'ğŸ§¡' : 'â¤ï¸';
                                        
                                        // çŠ¶æ€æ ä¸­ä½¿ç”¨ç®€æ´ç‰ˆæœ¬
                                        totalScoreElement.style.color = color;
                                        totalScoreElement.style.textShadow = `0 0 10px ${color}`;
                                        totalScoreElement.innerHTML = `${score} <span style="font-size:12px;opacity:0.8;">${icon}</span>`;
                                    }
                                    
                                    const healthScoreOption = {
                                        tooltip: {
                                            trigger: 'axis',
                                            formatter: function(params) {
                                                return params[0].name + '<br/>' +
                                                       params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                            }
                                        },
                                        radar: {
                                            radius: '68%',
                                            center: ['50%', '55%'],
                                            indicator: [
                                                { name: `ğŸ’“ å¿ƒç‡\n${factors.heartRate?.score || 0}åˆ†`, max: 100 },
                                                { name: `ğŸ’¨ è¡€æ°§\n${factors.bloodOxygen?.score || 0}åˆ†`, max: 100 },
                                                { name: `ğŸŒ¡ï¸ ä½“æ¸©\n${factors.temperature?.score || 0}åˆ†`, max: 100 },
                                                { name: `ğŸ‘Ÿ æ­¥æ•°\n${factors.step?.score || 0}åˆ†`, max: 100 },
                                                { name: `ğŸ”¥ å¡è·¯é‡Œ\n${factors.calorie?.score || 0}åˆ†`, max: 100 },
                                                { name: `ğŸ©¸ æ”¶ç¼©å‹\n${factors.pressureHigh?.score || 0}åˆ†`, max: 100 },
                                                { name: `ğŸ’™ èˆ’å¼ å‹\n${factors.pressureLow?.score || 0}åˆ†`, max: 100 },
                                                { name: `âš¡ å‹åŠ›\n${factors.stress?.score || 0}åˆ†`, max: 100 }
                                            ],
                                            name: {
                                                textStyle: {
                                                    color: '#ffffff',
                                                    fontSize: 11,
                                                    fontWeight: '600',
                                                    padding: [8, 10],
                                                    textShadowColor: 'rgba(0,0,0,0.8)',
                                                    textShadowBlur: 3,
                                                    backgroundColor: 'rgba(0,30,60,0.8)',
                                                    borderColor: 'rgba(0,255,255,0.3)',
                                                    borderWidth: 1,
                                                    borderRadius: 8
                                                },
                                                rich: {
                                                    value: {
                                                        color: '#00ffff',
                                                        fontSize: 11,
                                                        fontWeight: 'bold'
                                                    }
                                                }
                                            },
                                            splitArea: {
                                                show: true,
                                                areaStyle: {
                                                    color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                                }
                                            },
                                            axisLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.5)'
                                                }
                                            },
                                            splitLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.3)'
                                                }
                                            }
                                        },
                                        series: [{
                                            name: 'å¥åº·æŒ‡æ ‡',
                                            type: 'radar',
                                            data: [{
                                                value: [
                                                    factors.heartRate?.score || 0,
                                                    factors.bloodOxygen?.score || 0,
                                                    factors.temperature?.score || 0,
                                                    factors.step?.score || 0,
                                                    factors.calorie?.score || 0,
                                                    factors.pressureHigh?.score || 0,
                                                    factors.pressureLow?.score || 0,
                                                    factors.stress?.score || 0
                                                ],
                                                name: 'å½“å‰çŠ¶æ€',
                                                itemStyle: {
                                                    color: '#00e4ff'
                                                },
                                                areaStyle: {
                                                    color: 'rgba(0,228,255,0.4)'
                                                }
                                            }]
                                        }]
                                    };
                                    globalCharts.healthScore.setOption(healthScoreOption);
                                } else {
                                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤º0åˆ† - çŠ¶æ€æ é€‚é…ç‰ˆæœ¬
                                    const totalScoreElement = document.querySelector('.total-score');
                                    if (totalScoreElement) {
                                        totalScoreElement.style.color = '#666666';
                                        totalScoreElement.style.textShadow = '0 0 5px #666666';
                                        totalScoreElement.innerHTML = '0 <span style="font-size:12px;opacity:0.8;">âšª</span>';
                                    }
                                    
                                    const healthScoreOption = {
                                        tooltip: {
                                            trigger: 'axis',
                                            formatter: function(params) {
                                                return params[0].name + '<br/>' +
                                                       params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                            }
                                        },
                                        radar: {
                                            radius: '65%',
                                            center: ['50%', '55%'],
                                            indicator: [
                                                { name: 'å¿ƒç‡ 0åˆ†', max: 100 },
                                                { name: 'è¡€æ°§ 0åˆ†', max: 100 },
                                                { name: 'ä½“æ¸© 0åˆ†', max: 100 },
                                                { name: 'æ­¥æ•° 0åˆ†', max: 100 },
                                                { name: 'å¡è·¯é‡Œ 0åˆ†', max: 100 },
                                                { name: 'æ”¶ç¼©å‹ 0åˆ†', max: 100 },
                                                { name: 'èˆ’å¼ å‹ 0åˆ†', max: 100 },
                                                { name: 'å‹åŠ› 0åˆ†', max: 100 }
                                            ],
                                            name: {
                                                textStyle: {
                                                    color: '#00e4ff',
                                                    fontSize: 12,
                                                    padding: [3, 5]
                                                },
                                                rich: {
                                                    value: {
                                                        color: '#00e4ff',
                                                        fontSize: 12,
                                                        fontWeight: 'normal'
                                                    }
                                                }
                                            },
                                            splitArea: {
                                                show: true,
                                                areaStyle: {
                                                    color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                                }
                                            },
                                            axisLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.5)'
                                                }
                                            },
                                            splitLine: {
                                                lineStyle: {
                                                    color: 'rgba(0,228,255,0.3)'
                                                }
                                            }
                                        },
                                        series: [{
                                            name: 'å¥åº·æŒ‡æ ‡',
                                            type: 'radar',
                                            data: [{
                                                value: [0, 0, 0, 0, 0, 0, 0, 0],
                                                name: 'å½“å‰çŠ¶æ€',
                                                itemStyle: {
                                                    color: '#00e4ff'
                                                },
                                                areaStyle: {
                                                    color: 'rgba(0,228,255,0.4)'
                                                }
                                            }]
                                        }]
                                    };
                                    globalCharts.healthScore.setOption(healthScoreOption);
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching health data:', error);
                                // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿæ˜¾ç¤º0åˆ† - çŠ¶æ€æ é€‚é…ç‰ˆæœ¬
                                const totalScoreElement = document.querySelector('.total-score');
                                if (totalScoreElement) {
                                    totalScoreElement.style.color = '#ff6666';
                                    totalScoreElement.style.textShadow = '0 0 5px #ff6666';
                                    totalScoreElement.innerHTML = 'é”™è¯¯ <span style="font-size:12px;opacity:0.8;">âš ï¸</span>';
                                }
                                // è®¾ç½®é»˜è®¤çš„0åˆ†å›¾è¡¨
                                const healthScoreOption = {
                                    tooltip: {
                                        trigger: 'axis',
                                        formatter: function(params) {
                                            return params[0].name + '<br/>' +
                                                   params[0].marker + params[0].seriesName + 'ï¼š' + params[0].value;
                                        }
                                    },
                                    radar: {
                                        radius: '68%',
                                        center: ['50%', '55%'],
                                        indicator: [
                                            { name: 'ğŸ’“ å¿ƒç‡\n0åˆ†', max: 100 },
                                            { name: 'ğŸ’¨ è¡€æ°§\n0åˆ†', max: 100 },
                                            { name: 'ğŸŒ¡ï¸ ä½“æ¸©\n0åˆ†', max: 100 },
                                            { name: 'ğŸ‘Ÿ æ­¥æ•°\n0åˆ†', max: 100 },
                                            { name: 'ğŸ”¥ å¡è·¯é‡Œ\n0åˆ†', max: 100 },
                                            { name: 'ğŸ©¸ æ”¶ç¼©å‹\n0åˆ†', max: 100 },
                                            { name: 'ğŸ’™ èˆ’å¼ å‹\n0åˆ†', max: 100 },
                                            { name: 'âš¡ å‹åŠ›\n0åˆ†', max: 100 }
                                        ],
                                        name: {
                                            textStyle: {
                                                color: '#ffffff',
                                                fontSize: 11,
                                                fontWeight: '600',
                                                padding: [8, 10],
                                                textShadowColor: 'rgba(0,0,0,0.8)',
                                                textShadowBlur: 3,
                                                backgroundColor: 'rgba(0,30,60,0.8)',
                                                borderColor: 'rgba(102,102,102,0.3)',
                                                borderWidth: 1,
                                                borderRadius: 8
                                            },
                                            rich: {
                                                value: {
                                                    color: '#666666',
                                                    fontSize: 11,
                                                    fontWeight: 'bold'
                                                }
                                            }
                                        },
                                        splitArea: {
                                            show: true,
                                            areaStyle: {
                                                color: ['rgba(0,228,255,0.1)', 'rgba(0,228,255,0.2)']
                                            }
                                        },
                                        axisLine: {
                                            lineStyle: {
                                                color: 'rgba(0,228,255,0.5)'
                                            }
                                        },
                                        splitLine: {
                                            lineStyle: {
                                                color: 'rgba(0,228,255,0.3)'
                                            }
                                        }
                                    },
                                    series: [{
                                        name: 'å¥åº·æŒ‡æ ‡',
                                        type: 'radar',
                                        data: [{
                                            value: [0, 0, 0, 0, 0, 0, 0, 0],
                                            name: 'å½“å‰çŠ¶æ€',
                                            itemStyle: {
                                                color: '#00e4ff'
                                            },
                                            areaStyle: {
                                                color: 'rgba(0,228,255,0.4)'
                                            }
                                        }]
                                    }]
                                };
                                globalCharts.healthScore.setOption(healthScoreOption);
                            });
                    }
                }

                // ä½¿ç”¨åŠ¨ç”»æ›´æ–°çŠ¶æ€æ æ•°å€¼ - ä½¿ç”¨æå–çš„çœŸå®æ•°æ®
                const realStats = extractRealData(data);
                
                animateValueUpdate(document.getElementById('onlineUsers'), realStats.deviceStats.online);
                animateValueUpdate(document.getElementById('totalUsers'), realStats.userStats.total);
                animateValueUpdate(document.getElementById('alertUsers'), realStats.alertStats.total);
                animateValueUpdate(document.getElementById('alertCount'), realStats.alertStats.total);
                animateValueUpdate(document.getElementById('deviceCount'), realStats.deviceStats.total);
                animateValueUpdate(document.getElementById('totalWatchDevices'), realStats.deviceStats.total);
                animateValueUpdate(document.getElementById('criticalAlerts'), realStats.alertStats.critical);

                // æ›´æ–°äººå‘˜ç®¡ç†é¢æ¿
                initPersonnelManagementPanel(data);

                // æ›´æ–°æ€»ä½“è¿è¡Œæƒ…å†µå›¾è¡¨
                initOverallChart(data);

                // æ›´æ–°å‘Šè­¦ä¿¡æ¯å›¾è¡¨
                setTimeout(() => {
                    console.log('ğŸ”„ å‡†å¤‡åˆå§‹åŒ–å‘Šè­¦å›¾è¡¨...');
                    initAlertChart(data);
                }, 100);

                // æ›´æ–°è®¾å¤‡ç®¡ç†å›¾è¡¨
                initDeviceChart(data);

                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                initMessageList(data.message_info);

                // ä¸ºå„ä¸ªé¢æ¿æ·»åŠ ç‚¹å‡»äº‹ä»¶
                setupPanelClickEvents(customerId);
                
                // æ›´æ–°åœ°å›¾è®¾å¤‡ç‚¹
                updateMapDevices(data);
                
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                removeLoadingIndicator();
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            removeLoadingIndicator();
            showCustomAlert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        });
}

// å°†é¢æ¿ç‚¹å‡»äº‹ä»¶è®¾ç½®æŠ½å–ä¸ºå•ç‹¬çš„å‡½æ•°
function setupPanelClickEvents(customerId) {
    // ç­‰å¾…DOMå…ƒç´ å®Œå…¨åŠ è½½
    setTimeout(() => {
        // 1. å‘Šè­¦ä¿¡æ¯é¢æ¿ - ä½¿ç”¨hub-blç±»é€‰æ‹©å™¨
        const alertPanel = document.querySelector('.hub-bl');
        if (alertPanel) {
            alertPanel.style.cursor = 'pointer';
            alertPanel.onclick = function(e) {
                e.stopPropagation();
                addClickEffect(this);
                createModalWindow(`/alert_view.html?customerId=${customerId}`);
            };
        }

        // 2. è¶‹åŠ¿åˆ†æé¢æ¿ - ä½¿ç”¨hub-brç±»é€‰æ‹©å™¨
        const trendPanel = document.querySelector('.hub-br');
        if (trendPanel) {
            trendPanel.style.cursor = 'pointer';
            trendPanel.onclick = function(e) {
                e.stopPropagation();
                addClickEffect(this);
                createModalWindow(`/health_main?customerId=${customerId}`);
            };
        }

        // 3. æ¶ˆæ¯ä¿¡æ¯é¢æ¿ - ä½¿ç”¨hub-bottom-leftç±»é€‰æ‹©å™¨
        const messagePanel = document.querySelector('.hub-bottom-left');
        if (messagePanel) {
            messagePanel.style.cursor = 'pointer';
            messagePanel.onclick = function(e) {
                e.stopPropagation();
                addClickEffect(this);
                createModalWindow(`/message_view.html?customerId=${customerId}`);
            };
        }

        // 4. è®¾å¤‡çŠ¶æ€é¢æ¿ - ä½¿ç”¨hub-bottom-rightç±»é€‰æ‹©å™¨
        const devicePanel = document.querySelector('.hub-bottom-right');
        if (devicePanel) {
            devicePanel.style.cursor = 'pointer';
            devicePanel.onclick = function(e) {
                e.stopPropagation();
                addClickEffect(this);
                createModalWindow(`/device_view.html?customerId=${customerId}`);
            };
        }

        // 5. æ€»ä½“è¿è¡Œæƒ…å†µé¢æ¿ - ä½¿ç”¨hub-trç±»é€‰æ‹©å™¨
        const overallPanel = document.querySelector('.hub-tr');
        if (overallPanel) {
            overallPanel.style.cursor = 'pointer';
            overallPanel.onclick = function(e) {
                e.stopPropagation();
                addClickEffect(this);
                createModalWindow(`/device_view.html?customerId=${customerId}`);
            };
        }

        // 6. å¥åº·è¯„åˆ†é¢æ¿ - ä½¿ç”¨hub-tlç±»é€‰æ‹©å™¨
        const scorePanel = document.querySelector('.hub-tl');
        if (scorePanel) {
            scorePanel.style.cursor = 'pointer';
            scorePanel.onclick = function(e) {
                e.stopPropagation();
                addClickEffect(this);
                createModalWindow(`/user_health_data_analysis.html?customerId=${customerId}`);
            };
        }
    }, 500);
}

// æ·»åŠ ç‚¹å‡»æ•ˆæœ
function addClickEffect(element) {
    element.style.transform = 'scale(0.95)';
    element.style.transition = 'transform 0.1s ease';
    setTimeout(() => {
        element.style.transform = '';
        element.style.transition = 'all 0.6s cubic-bezier(0.4,0,0.2,1)';
    }, 100);
}

// ä¿®æ”¹åˆå§‹åŒ–è°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        initHubInteractions(); // åˆå§‹åŒ–HUBäº¤äº’
        globalCharts = initCharts(); // å­˜å‚¨å›¾è¡¨å®ä¾‹
        refreshData(); // åˆå§‹åŠ è½½æ•°æ®
        initMapDevices(); // åˆå§‹åŒ–åœ°å›¾è®¾å¤‡ç‚¹
        
        // å®šæœŸåˆ›å»ºæ•°æ®æµåŠ¨æ•ˆæœ
        setInterval(createDataFlowEffect, 10000);
        
        // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®
        setInterval(refreshData, 60000);
        
        // æ·»åŠ çª—å£ç„¦ç‚¹äº‹ä»¶ï¼Œå½“é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ®
        window.addEventListener('focus', () => {
            console.log('é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œåˆ·æ–°æ•°æ®');
            refreshData();
        });

        // å¼ºåˆ¶åˆ·æ–°å‘Šè­¦å›¾è¡¨
        setTimeout(() => {
            console.log('ğŸ”§ å¼ºåˆ¶åˆ·æ–°å‘Šè­¦å›¾è¡¨...');
            const alertContainer = document.getElementById('alertList');
            if (alertContainer && !alertContainer.hasChildNodes()) {
                console.log('ğŸš¨ æ£€æµ‹åˆ°å‘Šè­¦å®¹å™¨ä¸ºç©ºï¼Œå¼ºåˆ¶é‡æ–°åˆå§‹åŒ–...');
                initAlertChart({
                    alert_info: {
                        alertTypeCount: {},
                        severityCount: { critical: 0, high: 0, medium: 0 },
                        totalAlerts: 0
                    }
                });
            }
        }, 2000);
    }, 100);
});

// æ·»åŠ è°ƒè¯•ç”¨çš„å¼ºåˆ¶åˆå§‹åŒ–æœºåˆ¶
window.addEventListener('load', () => {
    setTimeout(() => {
        console.log('ğŸ”§ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å‘Šè­¦å›¾è¡¨çŠ¶æ€...');
        
        // æ£€æŸ¥å‘Šè­¦å®¹å™¨
        const alertContainer = document.getElementById('alertList');
        if (alertContainer) {
            console.log('ğŸ“‹ å‘Šè­¦å®¹å™¨çŠ¶æ€:', {
                hasChildren: alertContainer.hasChildNodes(),
                innerHTML: alertContainer.innerHTML.length,
                style: alertContainer.style.cssText
            });
            
            // å¦‚æœå®¹å™¨ä¸ºç©ºæˆ–æ˜¾ç¤ºçš„æ˜¯æ—§çš„æ¡å½¢å›¾ï¼Œå¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
            if (!alertContainer.hasChildNodes() || alertContainer.innerHTML.includes('yAxis')) {
                console.log('ğŸš¨ æ£€æµ‹åˆ°éœ€è¦é‡æ–°åˆå§‹åŒ–å‘Šè­¦å›¾è¡¨');
                initAlertChart({
                    alert_info: {
                        alertTypeCount: {
                            'heart_rate_alert': 2,
                            'blood_oxygen_alert': 1,
                            'temperature_alert': 0
                        },
                        severityCount: { 
                            critical: 1, 
                            high: 2, 
                            medium: 0 
                        }
                    }
                });
            }
        }
        
        // ä¸´æ—¶æ·»åŠ ä¸€ä¸ªè°ƒè¯•æŒ‰é’®
        if (!document.getElementById('debugAlertBtn')) {
            const debugBtn = document.createElement('button');
            debugBtn.id = 'debugAlertBtn';
            debugBtn.textContent = 'ğŸ”„ é‡æ–°åˆå§‹åŒ–å‘Šè­¦å›¾è¡¨';
            debugBtn.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 9999;
                background: rgba(0,228,255,0.8);
                color: #fff;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            `;
            debugBtn.onclick = () => {
                console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘å‘Šè­¦å›¾è¡¨é‡æ–°åˆå§‹åŒ–...');
                initAlertChart({
                    alert_info: {
                        alertTypeCount: {
                            'heart_rate_alert': Math.floor(Math.random() * 10),
                            'blood_oxygen_alert': Math.floor(Math.random() * 8),
                            'temperature_alert': Math.floor(Math.random() * 5),
                            'step_alert': Math.floor(Math.random() * 3)
                        },
                        severityCount: { 
                            critical: Math.floor(Math.random() * 5), 
                            high: Math.floor(Math.random() * 8), 
                            medium: Math.floor(Math.random() * 12) 
                        }
                    }
                });
            };
            document.body.appendChild(debugBtn);
            
            // 30ç§’åè‡ªåŠ¨ç§»é™¤è°ƒè¯•æŒ‰é’®
            setTimeout(() => {
                if (document.getElementById('debugAlertBtn')) {
                    document.getElementById('debugAlertBtn').remove();
                }
            }, 30000);
        }
    }, 3000);
});

// æ·»åŠ é€šç”¨çš„åˆ›å»ºæ¨¡æ€çª—å£å‡½æ•°
function createModalWindow(url) {
    const modalContainer = document.createElement('div');
    modalContainer.className = 'modal-container';
    modalContainer.innerHTML = `
        <div class="modal-content">
            <button class="modal-close">âœ–</button>
            <div class="modal-header">
                <div class="filter-controls">
                    <div class="select-group">
                        <select id="modalDeptSelect" class="modal-select">
                            <option value="">é€‰æ‹©éƒ¨é—¨</option>
                        </select>
                        <select id="modalUserSelect" class="modal-select">
                            <option value="">é€‰æ‹©ç”¨æˆ·</option>
                        </select>
                    </div>
                    <div class="date-picker" style="display: none;">
                        <!-- é¢„ç•™æ—¶é—´é€‰æ‹©å™¨ä½ç½® -->
                    </div>
                </div>
            </div>
            <iframe src="${url}" class="user-view-iframe"></iframe>
        </div>
    `;
    
    document.body.appendChild(modalContainer);
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .modal-header {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .select-group {
            display: flex;
            gap: 10px;
        }
        
        .modal-select {
            background: rgba(0, 21, 41, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            padding: 5px 10px;
            font-size: 14px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-select:hover {
            border-color: rgba(0, 228, 255, 0.6);
        }
        
        .modal-select option {
            background: rgba(0, 21, 41, 0.9);
            color: #fff;
        }
        
        .user-view-iframe {
            margin-top: 10px;
        }
    `;
    document.head.appendChild(style);
    
    // å­˜å‚¨éƒ¨é—¨æ•°æ®çš„æ˜ å°„å…³ç³»
    const departmentMap = new Map();
    
    // è·å–éƒ¨é—¨æ•°æ®å¹¶å¡«å……é€‰æ‹©æ¡†
    fetch(`/get_departments?orgId={{ customerId }}`)
        .then(response => response.json())
        .then(response => {
            if (response.success && response.data) {
                const deptSelect = document.getElementById('modalDeptSelect');
                
                // é€’å½’æ·»åŠ éƒ¨é—¨é€‰é¡¹å¹¶ä¿å­˜æ˜ å°„å…³ç³»
                function addDepartmentOptions(departments, level = 0) {
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        const indent = 'ã€€'.repeat(level);
                        option.textContent = indent + dept.name;
                        deptSelect.appendChild(option);
                        
                        // ä¿å­˜éƒ¨é—¨IDå’Œåç§°çš„æ˜ å°„
                        departmentMap.set(dept.id, dept.name);
                        
                        if (dept.children && dept.children.length > 0) {
                            addDepartmentOptions(dept.children, level + 1);
                        }
                    });
                }
                
                addDepartmentOptions(response.data);
            }
        })
        .catch(error => console.error('Error fetching departments:', error));
    
    // éƒ¨é—¨é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    const deptSelect = document.getElementById('modalDeptSelect');
    const userSelect = document.getElementById('modalUserSelect');
    
    deptSelect.addEventListener('change', function() {
        const selectedDeptId = this.value;
        const selectedDeptName = selectedDeptId ? departmentMap.get(selectedDeptId) : '';
        userSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';
        
        if (selectedDeptId) {
            fetch(`/fetch_users?orgId=${selectedDeptId}`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        data.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.user_name;
                            // å°†ç”¨æˆ·åå­˜å‚¨åœ¨dataå±æ€§ä¸­
                            option.dataset.userName = user.user_name;
                            userSelect.appendChild(option);
                        });
                        // æ·»åŠ "å…¨éƒ¨ç”¨æˆ·"é€‰é¡¹
                        const allOption = document.createElement('option');
                        allOption.value = 'all';
                        allOption.textContent = 'å…¨éƒ¨ç”¨æˆ·';
                        userSelect.appendChild(allOption);
                    }
                })
                .catch(error => console.error('Error fetching users:', error));
        }
        
        // æ›´æ–° iframe URLï¼ŒåŒ…å«éƒ¨é—¨ä¿¡æ¯
        updateIframeUrl(selectedDeptId, selectedDeptName);
    });
    
    // ç”¨æˆ·é€‰æ‹©å˜åŒ–æ—¶è§¦å‘äº‹ä»¶
    userSelect.addEventListener('change', function() {
        const selectedDeptId = deptSelect.value;
        const selectedDeptName = selectedDeptId ? departmentMap.get(selectedDeptId) : '';
        const selectedUserId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const selectedUserName = selectedOption.dataset.userName || '';
        
        // æ›´æ–° iframe URLï¼ŒåŒ…å«éƒ¨é—¨å’Œç”¨æˆ·ä¿¡æ¯
        updateIframeUrl(selectedDeptId, selectedDeptName, selectedUserId, selectedUserName);
    });
    
    // æ›´æ–° iframe URL çš„è¾…åŠ©å‡½æ•°
    function updateIframeUrl(deptId, deptName, userId, userName) {
        const iframe = modalContainer.querySelector('iframe');
        let newUrl = new URL(iframe.src);
        
        // ä¿æŒåŸæœ‰çš„ customerId å‚æ•°
        const customerId = newUrl.searchParams.get('customerId');
        
        // é‡ç½® URL å‚æ•°
        newUrl.search = '';
        
        // é‡æ–°æ·»åŠ æ‰€æœ‰å¿…è¦çš„å‚æ•°
        if (customerId) {
            newUrl.searchParams.set('customerId', customerId);
        }
        if (deptId) {
            newUrl.searchParams.set('deptId', deptId);
            newUrl.searchParams.set('deptName', encodeURIComponent(deptName));
        }
        if (userId && userId !== 'all') {
            newUrl.searchParams.set('userId', userId);
            newUrl.searchParams.set('userName', encodeURIComponent(userName));
        }
        
        // æ›´æ–° iframe çš„ src
        iframe.src = newUrl.toString();
        
        // å¦‚æœé¡µé¢æœ‰åˆ·æ–°æ•°æ®çš„å‡½æ•°ï¼Œå°è¯•è°ƒç”¨å®ƒ
        try {
            iframe.contentWindow.fetchData && iframe.contentWindow.fetchData();
        } catch (e) {
            console.log('No fetchData function found in iframe or cross-origin restrictions apply');
        }
    }
    
    // æ·»åŠ å…³é—­äº‹ä»¶
    const closeBtn = modalContainer.querySelector('.modal-close');
    closeBtn.onclick = () => {
        modalContainer.remove();
        style.remove();
    };
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­
    modalContainer.onclick = (e) => {
        if (e.target === modalContainer) {
            modalContainer.remove();
            style.remove();
        }
    };
}

// æ·»åŠ é¢æ¿æ ·å¼
const panelStyle = document.createElement('style');
panelStyle.textContent = `
    .panel {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .panel:hover {
        border-color: rgba(0, 228, 255, 0.4);
        box-shadow: 0 0 15px rgba(0, 228, 255, 0.2);
    }

    .modal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        position: relative;
        width: 90%;
        height: 90%;
        background: rgba(0, 21, 41, 0.95);
        border: 1px solid rgba(0, 228, 255, 0.3);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 228, 255, 0.2);
        animation: slideIn 0.3s ease;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #00e4ff;
        font-size: 20px;
        cursor: pointer;
        z-index: 1;
        padding: 5px 10px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        transform: scale(1.1);
        color: #ff4444;
    }

    .user-view-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 4px;
        background: rgba(1, 19, 38, 0.8);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(panelStyle);

// åˆå§‹åŒ–å‘Šè­¦ä¿¡æ¯å›¾è¡¨ - ä¸“ä¸šå†³ç­–çº§åˆ«è®¾è®¡
function initAlertChart(data) {
    console.log('ğŸš¨ åˆå§‹åŒ–æ™ºèƒ½å‘Šè­¦æ€åŠ¿åˆ†æç³»ç»Ÿ...', data);
    const alertContainer = document.getElementById('alertList');
    if (!alertContainer) {
        console.error('âŒ å‘Šè­¦å®¹å™¨ä¸å­˜åœ¨: alertList');
        return;
    }

    // å¼ºåˆ¶æ¸…ç©ºå®¹å™¨å†…å®¹
    alertContainer.innerHTML = '';
    
    // ç¡®ä¿å®¹å™¨æœ‰è¶³å¤Ÿçš„å°ºå¯¸å’Œæ ·å¼
    alertContainer.style.width = '100%';
    alertContainer.style.height = '100%';
    alertContainer.style.minHeight = '300px';
    alertContainer.style.position = 'relative';
    alertContainer.style.background = 'transparent';
    
    // é”€æ¯æ‰€æœ‰å·²å­˜åœ¨çš„EChartså®ä¾‹
    if (window.globalCharts && window.globalCharts.alert) {
        window.globalCharts.alert.dispose();
        delete window.globalCharts.alert;
    }
    if (alertContainer._echarts_instance_) {
        alertContainer._echarts_instance_.dispose();
    }
    
    // æ¸…é™¤DOMä¸Šçš„EChartsæ ‡è®°
    alertContainer.removeAttribute('_echarts_instance_');
    
    // ç­‰å¾…DOMæ¸…ç†å®Œæˆï¼Œç„¶åé‡æ–°åˆå§‹åŒ–
    setTimeout(() => {
        const alertChart = echarts.init(alertContainer, null, {
            renderer: 'canvas',
            useDirtyRect: false
        });
        console.log('ğŸ“Š EChartså®ä¾‹åˆ›å»ºæˆåŠŸ:', alertChart);
        
        // ç¡®ä¿æ•°æ®å­˜åœ¨
        if (!data || !data.alert_info) {
            console.warn('âš ï¸ å‘Šè­¦æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
            data = {
                alert_info: {
                    alertTypeCount: {},
                    severityCount: { critical: 0, high: 0, medium: 0 }
                }
            };
        }
        
        // ä½¿ç”¨æ ‡å‡†åŒ–æ•°æ®æå–å‘Šè­¦ä¿¡æ¯
    const stats = extractRealData(data);
    const alertInfo = stats.raw.alert_info;
    console.log('ğŸ“‹ å‘Šè­¦æ•°æ®:', alertInfo);
    
    const alertTypes = Object.keys(stats.alertStats.typeCount).map(k => translateAlertType(k));
    const alertValues = Object.values(stats.alertStats.typeCount);
    const totalAlerts = stats.alertStats.total;
    
    console.log('ğŸ“Š å¤„ç†åçš„å‘Šè­¦æ•°æ®:', {
        alertTypes,
        alertValues,
        totalAlerts
    });

    // è®¡ç®—é£é™©æŒ‡æ•°(0-100)
    const criticalCount = stats.alertStats.critical;
    const highCount = stats.alertStats.high;
    const mediumCount = stats.alertStats.medium;
    const riskScore = Math.min(100, (criticalCount * 10 + highCount * 5 + mediumCount * 2));
    
    console.log('ğŸ¯ é£é™©è¯„ä¼°:', {
        criticalCount,
        highCount,
        mediumCount,
        riskScore
    });
    
    // åŠ¨æ€æ„å»ºå‘Šè­¦ç±»å‹æ•°æ®ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
    let typeData = alertTypes.map((type, index) => ({
        name: type,
        value: alertValues[index] || 0,
        emoji: getAlertTypeEmoji(Object.keys(stats.alertStats.typeCount)[index]),
        color: getAlertTypeColor(Object.keys(stats.alertStats.typeCount)[index])
    })).sort((a, b) => b.value - a.value).slice(0, 6); // åªæ˜¾ç¤ºå‰6ç§ç±»å‹
    
    // å¦‚æœæ²¡æœ‰å‘Šè­¦æ•°æ®ï¼Œæ˜¾ç¤ºç³»ç»ŸçŠ¶æ€ä¿¡æ¯
    if (typeData.length === 0 || totalAlerts === 0) {
        typeData = [
            { name: 'ç³»ç»Ÿæ­£å¸¸', value: 80, emoji: 'âœ…', color: '#00ff66' },
            { name: 'ç›‘æ§è¿è¡Œ', value: 15, emoji: 'ğŸ‘ï¸', color: '#00ccff' },
            { name: 'å¾…ä¼˜åŒ–', value: 5, emoji: 'ğŸ”§', color: '#ffbb00' }
        ];
        console.log('ğŸ“¢ æ— å‘Šè­¦ä¿¡æ¯ï¼Œæ˜¾ç¤ºç³»ç»ŸçŠ¶æ€');
    }
    
    console.log('ğŸ·ï¸ æœ€ç»ˆå‘Šè­¦ç±»å‹æ•°æ®:', typeData);

    const alertOption = {
        backgroundColor: 'transparent',
        title: {
            text: totalAlerts > 0 ? 'ğŸš¨ å‘Šè­¦ä¿¡æ¯åˆ†æ' : 'âœ… æ— å‘Šè­¦ä¿¡æ¯',
            subtext: totalAlerts > 0 ? `ä¸¥é‡: ${criticalCount} | é«˜çº§: ${highCount} | ä¸­çº§: ${mediumCount}` : 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸',
            textStyle: {
                color: totalAlerts > 0 ? '#00ffff' : '#00ff88', // æ›´äº®çš„é’è‰²å’Œç»¿è‰²
                fontSize: 16,
                fontWeight: 'bold',
                textShadowColor: 'rgba(0,0,0,0.8)',
                textShadowBlur: 3,
                textShadowOffsetX: 1,
                textShadowOffsetY: 1
            },
            subtextStyle: {
                color: totalAlerts > 0 ? getRiskColor(riskScore) : '#88ffcc',
                fontSize: 12,
                fontWeight: '600',
                textShadowColor: 'rgba(0,0,0,0.6)',
                textShadowBlur: 2
            },
            left: 'center',
            top: 5
        },
        tooltip: {
            trigger: 'item',
            backgroundColor: 'rgba(0,20,40,0.95)',
            borderColor: 'rgba(0,255,255,0.8)',
            borderWidth: 3,
            textStyle: {
                color: '#ffffff',
                fontSize: 14,
                fontWeight: '500'
            },
            extraCssText: 'border-radius:15px;box-shadow:0 0 30px rgba(0,255,255,0.6);backdrop-filter:blur(5px);',
            formatter: function(params) {
                const percent = totalAlerts > 0 ? ((params.value / totalAlerts) * 100).toFixed(1) : '0.0';
                const urgency = params.value > 15 ? 'ğŸ”¥ ç´§æ€¥å¤„ç†' : params.value > 8 ? 'âš ï¸ ä¼˜å…ˆå¤„ç†' : params.value > 3 ? 'ğŸ“‹ å¸¸è§„å¤„ç†' : 'âœ… æ­£å¸¸èŒƒå›´';
                return `<div style="padding:15px;min-width:240px;background:linear-gradient(135deg,rgba(0,30,60,0.9),rgba(0,50,100,0.8));">
                    <div style="display:flex;align-items:center;margin-bottom:10px;border-bottom:1px solid rgba(0,255,255,0.3);padding-bottom:8px;">
                        <span style="font-size:22px;margin-right:10px;filter:drop-shadow(0 0 6px ${params.color});">${typeData.find(d => d.name === params.name)?.emoji || 'ğŸ“Š'}</span>
                        <span style="color:#ffffff;font-weight:bold;font-size:16px;text-shadow:0 0 8px ${params.color};">${params.name}</span>
                    </div>
                    <div style="display:grid;grid-template-columns:auto 1fr;gap:10px 18px;margin-bottom:8px;">
                        <span style="color:#99ddff;font-weight:600;">å‘Šè­¦æ•°é‡ï¼š</span><span style="color:#00ff99;font-weight:bold;text-shadow:0 0 6px #00ff99;">${params.value} æ¡</span>
                        <span style="color:#99ddff;font-weight:600;">å æ¯”ï¼š</span><span style="color:#00ccff;font-weight:bold;text-shadow:0 0 6px #00ccff;">${percent}%</span>
                        <span style="color:#99ddff;font-weight:600;">å¤„ç†å»ºè®®ï¼š</span><span style="color:#ffffff;font-weight:600;">${urgency}</span>
                    </div>
                    <div style="height:4px;background:linear-gradient(90deg,${params.color}44,${params.color},${params.color}44);border-radius:3px;margin-top:10px;box-shadow:0 0 10px ${params.color}66;"></div>
                </div>`;
            }
        },
        legend: {
            orient: 'horizontal',
            bottom: 2,
            left: 'center',
            itemWidth: 10,
            itemHeight: 10,
            itemGap: 18,
            textStyle: {
                color: '#bbeeee',
                fontSize: 11,
                fontWeight: '600',
                textShadowColor: 'rgba(0,0,0,0.8)',
                textShadowBlur: 2
            },
            formatter: function(name) {
                const item = typeData.find(d => d.name === name);
                const emoji = item?.emoji || 'ğŸ“Š';
                return `${emoji} ${name} (${item?.value || 0})`;
            }
        },
        series: [
            // ä¸»è¦ç¯å½¢å›¾
            {
                name: 'å‘Šè­¦ç±»å‹åˆ†å¸ƒ',
                type: 'pie',
                radius: ['40%', '68%'],
                center: ['50%', '48%'],
                avoidLabelOverlap: true,
                emphasis: {
                    scale: true,
                    scaleSize: 8,
                    itemStyle: {
                        shadowBlur: 20,
                        shadowColor: 'rgba(0,228,255,0.8)'
                    }
                },
                label: {
                    show: true,
                    position: 'outside',
                    distanceToLabelLine: 5,
                    formatter: function(params) {
                        if (params.value === 0) return '';
                        const emoji = typeData.find(d => d.name === params.name)?.emoji || 'ğŸ“Š';
                        return `{emoji|${emoji}}\n{value|${params.value}}`;
                    },
                    rich: {
                        emoji: {
                            fontSize: 18,
                            lineHeight: 22,
                            textShadowColor: 'rgba(0,0,0,0.8)',
                            textShadowBlur: 3
                        },
                        value: {
                            color: '#00ffff',
                            fontSize: 13,
                            fontWeight: 'bold',
                            lineHeight: 18,
                            textShadowColor: 'rgba(0,0,0,0.8)',
                            textShadowBlur: 2,
                            shadowOffsetX: 1,
                            shadowOffsetY: 1
                        }
                    }
                },
                labelLine: {
                    show: true,
                    length: 10,
                    length2: 6,
                    lineStyle: {
                        color: 'rgba(0,255,255,0.8)',
                        width: 2,
                        shadowColor: 'rgba(0,255,255,0.5)',
                        shadowBlur: 4
                    }
                },
                data: typeData.map(item => ({
                    name: item.name,
                    value: item.value,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                            { offset: 0, color: item.color + 'FF' },
                            { offset: 0.5, color: item.color + 'DD' },
                            { offset: 1, color: item.color + '99' }
                        ]),
                        borderColor: 'rgba(255,255,255,0.9)',
                        borderWidth: 3,
                        shadowColor: item.color,
                        shadowBlur: 15,
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                })),
                animationType: 'scale',
                animationEasing: 'elasticOut',
                animationDelay: function(idx) {
                    return idx * 150;
                }
            },
            // å†…éƒ¨é£é™©æŒ‡æ•°ä»ªè¡¨ç›˜
            {
                name: 'é£é™©æŒ‡æ•°',
                type: 'gauge',
                radius: '35%',
                center: ['50%', '48%'],
                min: 0,
                max: 100,
                splitNumber: 5,
                axisLine: {
                    lineStyle: {
                        width: 10,
                        color: [
                            [0.2, '#00ff66'],
                            [0.4, '#44ff44'], 
                            [0.6, '#ffdd00'],
                            [0.8, '#ff8800'],
                            [1, '#ff3333']
                        ],
                        shadowColor: 'rgba(255,255,255,0.3)',
                        shadowBlur: 8
                    }
                },
                axisTick: {
                    distance: -10,
                    length: 6,
                    lineStyle: {
                        color: 'rgba(255,255,255,0.8)',
                        width: 2
                    }
                },
                axisLabel: {
                    distance: -25,
                    color: '#ccffff',
                    fontSize: 9,
                    fontWeight: '600',
                    textShadowColor: 'rgba(0,0,0,0.8)',
                    textShadowBlur: 2
                },
                pointer: {
                    length: '80%',
                    width: 4,
                    itemStyle: {
                        color: '#00ffff',
                        shadowColor: 'rgba(0,255,255,0.9)',
                        shadowBlur: 12,
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                },
                detail: {
                    valueAnimation: true,
                    fontSize: 14,
                    color: '#ffffff',
                    fontWeight: 'bold',
                    offsetCenter: [0, '65%'],
                    formatter: function(value) {
                        return `{value|${Math.round(value)}}\n{unit|é£é™©å€¼}`;
                    },
                    rich: {
                        value: {
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: '#ffffff',
                            textShadowColor: 'rgba(0,255,255,0.8)',
                            textShadowBlur: 4
                        },
                        unit: {
                            fontSize: 10,
                            color: '#aaffff',
                            padding: [3, 0, 0, 0],
                            textShadowColor: 'rgba(0,0,0,0.6)',
                            textShadowBlur: 2
                        }
                    }
                },
                data: [{
                    value: totalAlerts > 0 ? riskScore : 0,
                    name: totalAlerts > 0 ? 'å½“å‰é£é™©' : 'å®‰å…¨çŠ¶æ€'
                }],
                animationDuration: 2000,
                animationEasing: 'cubicOut'
            }
        ],
        graphic: [
            // é£é™©ç­‰çº§æ ‡è¯†
            {
                type: 'text',
                left: 'center',
                top: '78%',
                style: {
                    text: totalAlerts > 0 ? `${getRiskLevelEmoji(riskScore)} ${getRiskLevel(riskScore)}` : 'ğŸŸ¢ å®‰å…¨è¿è¡Œ',
                    textAlign: 'center',
                    fill: totalAlerts > 0 ? '#ffffff' : '#00ff88',
                    fontSize: 12,
                    fontWeight: 'bold',
                    shadowColor: 'rgba(0,0,0,0.8)',
                    shadowBlur: 3,
                    shadowOffsetX: 1,
                    shadowOffsetY: 1
                }
            }
        ]
    };

    // è¾…åŠ©å‡½æ•°
    function getAlertTypeEmoji(type) {
        const emojiMap = {
            heart_rate: 'ğŸ’“', blood_pressure: 'ğŸ©¸', stress: 'âš¡', 
            blood_oxygen: 'ğŸ’¨', temperature: 'ğŸŒ¡ï¸', one_key_alarm: 'ğŸ†˜',
            fall_down: 'â¬‡ï¸', sleep: 'ğŸ˜´'
        };
        return emojiMap[type] || 'ğŸš¨';
    }

    function getRiskLevel(score) {
        if (score >= 80) return 'æé«˜é£é™©';
        if (score >= 60) return 'é«˜é£é™©';
        if (score >= 30) return 'ä¸­ç­‰é£é™©';
        if (score >= 10) return 'ä½é£é™©';
        return 'å®‰å…¨çŠ¶æ€';
    }

    function getRiskColor(score) {
        if (score >= 80) return '#ff4757';
        if (score >= 60) return '#ff8c00';
        if (score >= 30) return '#ffbb00';
        if (score >= 10) return '#00e4ff';
        return '#00ff9d';
    }

    function getRiskLevelEmoji(score) {
        if (score >= 80) return 'ğŸ”´';
        if (score >= 60) return 'ğŸŸ ';
        if (score >= 30) return 'ğŸŸ¡';
        if (score >= 10) return 'ğŸ”µ';
        return 'ğŸŸ¢';
    }

    alertChart.setOption(alertOption);
    console.log('âœ… æ™ºèƒ½å‘Šè­¦æ€åŠ¿åˆ†æç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
    console.log('ğŸ¨ å›¾è¡¨é…ç½®:', alertOption);

    // æ·»åŠ æ™ºèƒ½è‡ªåŠ¨è½®æ’­æ•ˆæœ
    let currentIndex = 0;
    let currentGaugeValue = 0;
    const highlightTimer = setInterval(() => {
        alertChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
        alertChart.dispatchAction({
            type: 'highlight',
            seriesIndex: 0,
            dataIndex: currentIndex
        });
        currentIndex = (currentIndex + 1) % Math.max(typeData.length, 1);
    }, 3500);

    // é£é™©æŒ‡æ•°åŠ¨æ€å˜åŒ–æ•ˆæœ
    const gaugeTimer = setInterval(() => {
        const fluctuation = (Math.random() - 0.5) * 5; // Â±2.5çš„æ³¢åŠ¨
        const newValue = Math.max(0, Math.min(100, riskScore + fluctuation));
        alertChart.setOption({
            series: [{}, {
                data: [{
                    value: newValue,
                    name: 'å½“å‰é£é™©'
                }]
            }]
        });
    }, 8000);

    // é¼ æ ‡äº¤äº’æ§åˆ¶
    alertContainer.addEventListener('mouseenter', () => {
        clearInterval(highlightTimer);
        clearInterval(gaugeTimer);
    });

    alertContainer.addEventListener('mouseleave', () => {
        // é‡æ–°å¼€å§‹è½®æ’­ï¼ˆé¿å…é‡å¤å®šæ—¶å™¨ï¼‰
        setTimeout(() => {
            if (!alertContainer.matches(':hover')) {
                const newHighlightTimer = setInterval(() => {
                    alertChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
                    alertChart.dispatchAction({
                        type: 'highlight',
                        seriesIndex: 0,
                        dataIndex: currentIndex
                    });
                    currentIndex = (currentIndex + 1) % Math.max(typeData.length, 1);
                }, 3500);
            }
        }, 1000);
    });

    // è‡ªé€‚åº”å¤§å°
    window.addEventListener('resize', function() {
        alertChart.resize();
    });

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
    alertChart.on('click', function(params) {
        if (params.seriesType === 'pie') {
            showAlertTypeDetail(params.name, params.value, params.data);
        }
    });

    // å‘Šè­¦ç±»å‹è¯¦æƒ…å¼¹çª—
    function showAlertTypeDetail(typeName, count, data) {
        const typeEmoji = typeData.find(d => d.name === typeName)?.emoji || 'ğŸ“Š';
        const typeColor = typeData.find(d => d.name === typeName)?.color || '#00e4ff';
        
        const detailModal = document.createElement('div');
        detailModal.className = 'alert-type-detail-modal';
        detailModal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); z-index: 10000; display: flex;
            align-items: center; justify-content: center; animation: fadeIn 0.3s ease;
        `;
        
        detailModal.innerHTML = `
            <div style="background: linear-gradient(135deg, rgba(0,21,41,0.98), rgba(6,28,58,0.95));
                        border: 2px solid ${typeColor}; border-radius: 16px;
                        padding: 24px 32px; min-width: 400px; max-width: 500px;
                        box-shadow: 0 0 30px ${typeColor}44; position: relative;">
                <button style="position: absolute; top: 12px; right: 16px; background: transparent;
                               border: none; color: ${typeColor}; font-size: 24px; cursor: pointer;
                               padding: 4px 8px; border-radius: 4px; transition: all 0.3s ease;"
                        onmouseover="this.style.background='${typeColor}22'"
                        onmouseout="this.style.background='transparent'"
                        onclick="this.parentElement.parentElement.remove()">Ã—</button>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 8px;">${typeEmoji}</div>
                    <h3 style="color: ${typeColor}; margin: 0; font-size: 20px; font-weight: bold;">${typeName}</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px 20px; margin-bottom: 20px;">
                    <span style="color: #7ecfff;">å½“å‰æ•°é‡ï¼š</span>
                    <span style="color: #00ff9d; font-weight: bold; font-size: 18px;">${count} æ¡</span>
                    
                    <span style="color: #7ecfff;">é£é™©ç­‰çº§ï¼š</span>
                    <span style="color: ${count > 15 ? '#ff4757' : count > 8 ? '#ffbb00' : '#00ff9d'}; font-weight: bold;">
                        ${count > 15 ? 'ğŸ”´ é«˜é£é™©' : count > 8 ? 'ğŸŸ¡ ä¸­é£é™©' : 'ğŸŸ¢ ä½é£é™©'}
                    </span>
                    
                    <span style="color: #7ecfff;">å¤„ç†å»ºè®®ï¼š</span>
                    <span style="color: #fff; font-weight: 500;">
                        ${count > 15 ? 'ç«‹å³å®‰æ’ä¸“äººå¤„ç†' : count > 8 ? 'ä¼˜å…ˆçº§å¤„ç†' : count > 3 ? 'å¸¸è§„ç›‘æ§' : 'æ­£å¸¸èŒƒå›´'}
                    </span>
                    
                    <span style="color: #7ecfff;">é¢„è®¡å¤„ç†æ—¶é—´ï¼š</span>
                    <span style="color: #00e4ff; font-weight: 500;">
                        ${count > 15 ? '< 30åˆ†é’Ÿ' : count > 8 ? '< 2å°æ—¶' : count > 3 ? '< 1å¤©' : 'æ— éœ€å¤„ç†'}
                    </span>
                </div>
                
                <div style="height: 4px; background: linear-gradient(90deg, transparent, ${typeColor}, transparent);
                            border-radius: 2px; margin: 16px 0;"></div>
                
                <div style="text-align: center;">
                    <button style="background: linear-gradient(135deg, ${typeColor}, ${typeColor}CC);
                                   color: #fff; border: none; padding: 12px 24px; border-radius: 8px;
                                   font-weight: bold; cursor: pointer; font-size: 14px;
                                   box-shadow: 0 4px 15px ${typeColor}44; transition: all 0.3s ease;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px ${typeColor}66'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px ${typeColor}44'"
                            onclick="window.open('/alert_view.html?customerId=${new URLSearchParams(window.location.search).get('customerId') || '1'}&type=${typeName}', '_blank')">
                        ğŸ“‹ æŸ¥çœ‹è¯¦ç»†å‘Šè­¦åˆ—è¡¨
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(detailModal);
        
        // ç‚¹å‡»é®ç½©å…³é—­
        detailModal.addEventListener('click', function(e) {
            if (e.target === detailModal) {
                detailModal.remove();
            }
        });
    }

        // å°†å›¾è¡¨å®ä¾‹å­˜å‚¨åˆ°å…¨å±€å¯¹è±¡ä¸­
        if (!window.globalCharts) {
            window.globalCharts = {};
        }
        window.globalCharts.alert = alertChart;

        return alertChart;
    }, 50); // ç»“æŸsetTimeout
    
    // å¦‚æœæ˜¯åŒæ­¥è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªå ä½ç¬¦
    return null;
}

// ä¿®æ”¹è®¾å¤‡ç®¡ç†å›¾è¡¨åˆå§‹åŒ–å‡½æ•° - ä½¿ç”¨æ ‡å‡†åŒ–æ•°æ®
function initDeviceChart(data) {
    const statsContainer = document.getElementById('statsChart');
    if (!statsContainer) return;

    const statsChart = echarts.init(statsContainer);
    const stats = extractRealData(data);
    
    // ä½¿ç”¨æå–çš„çœŸå®è®¾å¤‡æ•°æ®
    const totalDevices = stats.deviceStats.total;
    const onlineDevices = stats.deviceStats.online;
    const offlineDevices = stats.deviceStats.offline || (totalDevices - onlineDevices);
    const chargingDevices = stats.deviceStats.charging;
    const wornDevices = stats.deviceStats.worn;

    const statusData = [
        { name: 'åœ¨çº¿è®¾å¤‡', value: onlineDevices, icon: 'ğŸ“±', color: '#00ff9d' },
        { name: 'ç¦»çº¿è®¾å¤‡', value: offlineDevices, icon: 'ğŸ“´', color: '#ff6b6b' },
        { name: 'å……ç”µä¸­', value: chargingDevices, icon: 'ğŸ”‹', color: '#ffbb00' },
        { name: 'å·²ä½©æˆ´', value: wornDevices, icon: 'âŒš', color: '#00e4ff' }
    ];

    const statsOption = {
        backgroundColor: 'transparent',
        title: {
            text: 'æ™ºèƒ½è®¾å¤‡è¿è¡ŒçŠ¶æ€',
            subtext: `è®¾å¤‡æ€»æ•° ${totalDevices} å° | åœ¨çº¿ç‡ ${((onlineDevices/totalDevices)*100).toFixed(1)}%`,
            textStyle: {
                color: '#ffffff',
                fontSize: 15,
                fontWeight: 'bold',
                textShadowColor: 'rgba(0,0,0,0.8)',
                textShadowBlur: 3
            },
            subtextStyle: {
                color: onlineDevices/totalDevices > 0.8 ? '#00ff66' : '#ffbb00',
                fontSize: 11,
                fontWeight: '600'
            },
            left: 'center',
            top: 5
        },
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,20,40,0.95)',
            borderColor: 'rgba(0,255,255,0.8)',
            borderWidth: 2,
            textStyle: {
                color: '#ffffff',
                fontSize: 14,
                fontWeight: '500'
            },
            formatter: function(params) {
                const param = params[0];
                const percent = ((param.value / totalDevices) * 100).toFixed(1);
                const status = param.value > totalDevices * 0.8 ? 'âœ… ä¼˜ç§€' : 
                              param.value > totalDevices * 0.6 ? 'ğŸŸ¢ è‰¯å¥½' : 
                              param.value > totalDevices * 0.3 ? 'ğŸŸ¡ ä¸€èˆ¬' : 'ğŸ”´ éœ€è¦å…³æ³¨';
                const alertLevel = param.name === 'ç¦»çº¿è®¾å¤‡' && param.value > 0 ? 'âš ï¸ éœ€è¦å¤„ç†' : '';
                const deviceData = statusData.find(d => d.name === param.name);
                
                return `<div style="padding:15px;min-width:220px;background:linear-gradient(135deg,rgba(0,30,60,0.9),rgba(0,50,100,0.8));">
                    <div style="display:flex;align-items:center;margin-bottom:10px;border-bottom:1px solid rgba(0,255,255,0.3);padding-bottom:8px;">
                        <span style="font-size:20px;margin-right:10px;">${deviceData?.icon}</span>
                        <span style="color:#ffffff;font-weight:bold;font-size:16px;">${param.name}</span>
                    </div>
                    <div style="display:grid;grid-template-columns:auto 1fr;gap:10px 15px;margin-bottom:8px;">
                        <span style="color:#99ddff;">è®¾å¤‡æ•°é‡ï¼š</span><span style="color:#00ff99;font-weight:bold;">${param.value} å°</span>
                        <span style="color:#99ddff;">å æ¯”ï¼š</span><span style="color:#00ccff;font-weight:bold;">${percent}%</span>
                        <span style="color:#99ddff;">çŠ¶æ€è¯„ä¼°ï¼š</span><span style="font-weight:600;">${status}</span>
                        ${alertLevel ? `<span style="color:#99ddff;">å¤„ç†å»ºè®®ï¼š</span><span style="color:#ff6b6b;font-weight:bold;">${alertLevel}</span>` : ''}
                    </div>
                    <div style="text-align:center;margin-top:10px;padding:8px;background:rgba(0,40,80,0.6);border-radius:8px;">
                        <span style="color:#88ccff;font-size:12px;">ğŸ’¡ ç‚¹å‡»æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…åˆ—è¡¨</span>
                    </div>
                </div>`;
            }
        },
        grid: {
            left: '8%',
            right: '5%',
            top: '25%',
            bottom: '5%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            max: Math.max(...statusData.map(d => d.value)) * 1.2,
            axisLine: {
                show: false
            },
            axisTick: {
                show: false
            },
            axisLabel: {
                show: false
            },
            splitLine: {
                show: false
            }
        },
        yAxis: {
            type: 'category',
            data: statusData.map(item => item.name),
            axisLine: {
                show: false
            },
            axisTick: {
                show: false
            },
            axisLabel: {
                color: '#ffffff',
                fontSize: 11,
                fontWeight: '600',
                formatter: function(value) {
                    const item = statusData.find(d => d.name === value);
                    return `${item?.icon} ${value}`;
                }
            }
        },
        series: [
            {
                name: 'è®¾å¤‡çŠ¶æ€',
                type: 'bar',
                data: statusData.map(item => ({
                    name: item.name,
                    value: item.value,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: item.color + '66' },
                            { offset: 0.5, color: item.color + 'BB' },
                            { offset: 1, color: item.color }
                        ]),
                        borderColor: item.name === 'ç¦»çº¿è®¾å¤‡' && item.value > 0 ? '#ff3333' : item.color,
                        borderWidth: item.name === 'ç¦»çº¿è®¾å¤‡' && item.value > 0 ? 3 : 1,
                        borderRadius: [0, 8, 8, 0],
                        shadowColor: item.color,
                        shadowBlur: item.name === 'ç¦»çº¿è®¾å¤‡' && item.value > 0 ? 15 : 8,
                        shadowOffsetX: item.name === 'ç¦»çº¿è®¾å¤‡' && item.value > 0 ? 5 : 2,
                        shadowOffsetY: 2
                    }
                })),
                barWidth: '60%',
                label: {
                    show: true,
                    position: 'right',
                    color: '#ffffff',
                    fontSize: 12,
                    fontWeight: 'bold',
                    formatter: function(params) {
                        const percent = ((params.value / totalDevices) * 100).toFixed(1);
                        return `${params.value}å° (${percent}%)`;
                    },
                    backgroundColor: 'rgba(0,30,60,0.7)',
                    borderColor: 'rgba(0,255,255,0.4)',
                    borderWidth: 1,
                    borderRadius: 4,
                    padding: [4, 8],
                    textShadowColor: 'rgba(0,0,0,0.8)',
                    textShadowBlur: 2
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 20,
                        shadowColor: 'rgba(0,228,255,0.8)',
                        borderWidth: 3,
                        borderColor: '#00e4ff'
                    },
                    label: {
                        backgroundColor: 'rgba(0,60,120,0.9)',
                        borderColor: '#00e4ff',
                        borderWidth: 2
                    }
                },
                animationDuration: 1000,
                animationEasing: 'cubicOut',
                animationDelay: function(idx) {
                    return idx * 150;
                }
            }
        ],
        graphic: [
            {
                type: 'text',
                left: 'center',
                top: 'center',
                style: {
                    text: totalDevices.toString(),
                    textAlign: 'center',
                    fill: '#00e4ff',
                    fontSize: 28,
                    fontWeight: 'bold',
                    shadowColor: 'rgba(0,228,255,0.8)',
                    shadowBlur: 12
                }
            },
            {
                type: 'text',
                left: 'center',
                top: 'center',
                style: {
                    text: 'è®¾å¤‡æ€»æ•°',
                    textAlign: 'center',
                    fill: '#7ecfff',
                    fontSize: 12,
                    y: 22
                }
            },
            {
                type: 'text',
                left: 'center',
                top: 'center',
                style: {
                    text: `åœ¨çº¿ç‡ ${((onlineDevices/totalDevices)*100).toFixed(1)}%`,
                    textAlign: 'center',
                    fill: onlineDevices/totalDevices > 0.8 ? '#00ff9d' : '#ffbb00',
                    fontSize: 10,
                    y: 38
                }
            }
        ]
    };
    
    statsChart.setOption(statsOption);

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ”¯æŒæŸ¥çœ‹è®¾å¤‡è¯¦æƒ…
    statsChart.on('click', function(params) {
        if (params.componentType === 'series') {
            const deviceType = params.name;
            const deviceCount = params.value;
            
            // åˆ›å»ºè®¾å¤‡è¯¦æƒ…å¼¹çª—
            createDeviceDetailModal(deviceType, deviceCount, statusData.find(d => d.name === deviceType));
        }
    });

    // æ·»åŠ æ•°æ®è‡ªåŠ¨æ›´æ–°åŠ¨ç”»
    let currentIndex = 0;
    const rotateTimer = setInterval(() => {
        statsChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
        statsChart.dispatchAction({
            type: 'highlight',
            seriesIndex: 0,
            dataIndex: currentIndex
        });
        currentIndex = (currentIndex + 1) % statusData.length;
    }, 2500);

    // é¼ æ ‡æ‚¬åœæ—¶åœæ­¢è½®æ’­
    statsContainer.addEventListener('mouseenter', () => clearInterval(rotateTimer));
    
    // ä¸ºç¦»çº¿è®¾å¤‡æ·»åŠ æŒç»­è­¦æŠ¥åŠ¨ç”»
    if (offlineDevices > 0) {
        const deviceContainer = document.getElementById('statsChart');
        if (deviceContainer) {
            deviceContainer.style.animation = 'deviceOfflineAlert 2s ease-in-out infinite';
        }
    }

    return statsChart;
}

// åˆ›å»ºè®¾å¤‡è¯¦æƒ…å¼¹çª—
function createDeviceDetailModal(deviceType, deviceCount, deviceInfo) {
    const modal = document.createElement('div');
    modal.className = 'device-detail-modal';
    modal.innerHTML = `
        <div class="device-detail-content">
            <div class="device-detail-header">
                <h3>${deviceInfo?.icon} ${deviceType} è¯¦æƒ…</h3>
                <button class="device-detail-close">âœ–</button>
            </div>
            <div class="device-detail-body">
                <div class="device-summary">
                    <div class="summary-item">
                        <span class="summary-label">è®¾å¤‡æ•°é‡</span>
                        <span class="summary-value" style="color:${deviceInfo?.color}">${deviceCount} å°</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">çŠ¶æ€</span>
                        <span class="summary-status">${deviceType}</span>
                    </div>
                </div>
                <div class="device-list">
                    <h4>è®¾å¤‡åˆ—è¡¨</h4>
                    <div class="device-items">
                        ${generateDeviceList(deviceType, deviceCount)}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .device-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }
        .device-detail-content {
            background: linear-gradient(135deg, rgba(0,30,60,0.95), rgba(0,50,100,0.9));
            border: 2px solid rgba(0,255,255,0.5);
            border-radius: 15px;
            width: 500px;
            max-height: 600px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,255,255,0.3);
        }
        .device-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(0,255,255,0.3);
        }
        .device-detail-header h3 {
            color: #ffffff;
            margin: 0;
            font-size: 18px;
        }
        .device-detail-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
        }
        .device-detail-close:hover {
            color: #ff6b6b;
        }
        .device-detail-body {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        .device-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-item {
            background: rgba(0,40,80,0.6);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .summary-label {
            display: block;
            color: #99ddff;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .summary-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
        }
        .summary-status {
            display: block;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }
        .device-list h4 {
            color: #ffffff;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0,255,255,0.3);
            padding-bottom: 8px;
        }
        .device-items {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .device-item {
            background: rgba(0,20,40,0.7);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-item.online { border-left-color: #00ff66; }
        .device-item.offline { border-left-color: #ff6b6b; }
        .device-item.charging { border-left-color: #ffbb00; }
        .device-item.worn { border-left-color: #00ccff; }
        .device-name {
            color: #ffffff;
            font-weight: 600;
        }
        .device-status {
            color: #99ddff;
            font-size: 12px;
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(modal);
    
    // ç»‘å®šå…³é—­äº‹ä»¶
    modal.querySelector('.device-detail-close').onclick = () => {
        document.body.removeChild(modal);
        document.head.removeChild(style);
    };
    modal.onclick = (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
            document.head.removeChild(style);
        }
    };
}

// ç”Ÿæˆè®¾å¤‡åˆ—è¡¨
function generateDeviceList(deviceType, deviceCount) {
    if (deviceCount === 0) {
        return '<div style="text-align:center;color:#666;padding:20px;">æš‚æ— è®¾å¤‡</div>';
    }
    
    const deviceNames = [
        'æ™ºèƒ½æ‰‹ç¯001', 'æ™ºèƒ½æ‰‹ç¯002', 'æ™ºèƒ½æ‰‹ç¯003', 'æ™ºèƒ½æ‰‹ç¯004', 'æ™ºèƒ½æ‰‹ç¯005',
        'æ™ºèƒ½æ‰‹è¡¨001', 'æ™ºèƒ½æ‰‹è¡¨002', 'æ™ºèƒ½æ‰‹è¡¨003', 'å¥åº·æ‰‹ç¯001', 'å¥åº·æ‰‹ç¯002'
    ];
    
    let items = '';
    for (let i = 0; i < Math.min(deviceCount, 10); i++) {
        const name = deviceNames[i] || `è®¾å¤‡${String(i + 1).padStart(3, '0')}`;
        const statusClass = deviceType === 'åœ¨çº¿è®¾å¤‡' ? 'online' : 
                           deviceType === 'ç¦»çº¿è®¾å¤‡' ? 'offline' : 
                           deviceType === 'å……ç”µä¸­' ? 'charging' : 'worn';
        const statusText = deviceType === 'åœ¨çº¿è®¾å¤‡' ? 'åœ¨çº¿è¿è¡Œ' : 
                          deviceType === 'ç¦»çº¿è®¾å¤‡' ? 'ç¦»çº¿çŠ¶æ€' : 
                          deviceType === 'å……ç”µä¸­' ? 'æ­£åœ¨å……ç”µ' : 'å·²ä½©æˆ´';
        
        items += `
            <div class="device-item ${statusClass}">
                <span class="device-name">${name}</span>
                <span class="device-status">${statusText}</span>
            </div>
        `;
    }
    
    if (deviceCount > 10) {
        items += `<div style="text-align:center;color:#99ddff;padding:10px;">...è¿˜æœ‰ ${deviceCount - 10} å°è®¾å¤‡</div>`;
    }
    
    return items;
}

// ä¿®æ”¹è¶‹åŠ¿åˆ†æå›¾è¡¨ï¼Œå¢åŠ é¢„æµ‹æ•°æ®
function updateTrendChart(data) {
    const trendContainer = document.getElementById('trendChart');
    if (!trendContainer) return;

    const trendChart = echarts.init(trendContainer);
    
    const trendOption = {
        title: {
            text: 'å¥åº·æŒ‡æ ‡è¶‹åŠ¿åŠé¢„æµ‹',
            textStyle: {
                color: '#fff',
                fontSize: 16
            }
        },
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(0,21,41,0.9)',
            borderColor: 'rgba(0,228,255,0.2)',
            textStyle: { color: '#fff' }
        },
        legend: {
            data: ['å¿ƒç‡', 'è¡€å‹', 'å‹åŠ›æŒ‡æ•°', 'è·ç¦»', 'å¡è·¯é‡Œ', 'æ­¥æ•°', 'é¢„æµ‹å€¼'],
            textStyle: { color: '#fff' },
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', 'é¢„æµ‹'],
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
        },
        yAxis: {
            type: 'value',
            axisLabel: { color: '#fff' },
            splitLine: {
                lineStyle: {
                    color: 'rgba(255,255,255,0.1)',
                    type: 'dashed'
                }
            }
        },
        series: [
            {
                name: 'å¿ƒç‡',
                type: 'line',
                smooth: true,
                data: [75, 72, 78, 85, 80, 75, 77],
                itemStyle: { color: '#ff4444' }
            },
            {
                name: 'è¡€å‹',
                type: 'line',
                smooth: true,
                data: [120, 118, 122, 125, 121, 119, 120],
                itemStyle: { color: '#00e4ff' }
            },
            {
                name: 'å‹åŠ›æŒ‡æ•°',
                type: 'line',
                smooth: true,
                data: [45, 48, 52, 55, 50, 47, 49],
                itemStyle: { color: '#ffbb00' }
            },
            {
                name: 'è·ç¦»',
                type: 'line',
                smooth: true,
                data: [2.1, 2.3, 2.8, 3.2, 3.5, 3.8, 4.0],
                itemStyle: { color: '#00ff9d' }
            },
            {
                name: 'å¡è·¯é‡Œ',
                type: 'line',
                smooth: true,
                data: [150, 180, 220, 280, 320, 350, 380],
                itemStyle: { color: '#ff7777' }
            },
            {
                name: 'æ­¥æ•°',
                type: 'line',
                smooth: true,
                data: [2000, 2500, 3000, 3800, 4200, 4500, 4800],
                itemStyle: { color: '#7777ff' }
            }
        ]
    };

    // ä¸ºæ¯ä¸ªç³»åˆ—æ·»åŠ é¢„æµ‹åŒºåŸŸ
    trendOption.series.forEach(series => {
        const lastIndex = series.data.length - 1;
        series.markArea = {
            itemStyle: {
                color: 'rgba(0, 228, 255, 0.1)'
            },
            data: [[{
                xAxis: trendOption.xAxis.data[lastIndex - 1]
            }, {
                xAxis: trendOption.xAxis.data[lastIndex]
            }]]
        };
    });

    trendChart.setOption(trendOption);
    return trendChart;
}


  </script>


   
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    // è·å–éƒ¨é—¨æ•°æ®
    $.ajax({
        url: `/get_departments?orgId={{ customerId }}`,
        method: 'GET',
        success: function(response) {
            console.log('response', response);
            if (response.success && response.data) {
                updateDepartmentSelect(response.data);
            } else {
                console.error('Invalid response format:', response);
            }
        },
        error: function(error) {
            console.error('Failed to fetch departments:', error);
        }
    });

    // éƒ¨é—¨é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    $('#deptSelect').change(function() {
        const selectedDeptId = $(this).val();
        currentDept=selectedDeptId
        console.log('currentDept',currentDept);
        updateUsers(selectedDeptId);
    });

    // ç”¨æˆ·é€‰æ‹©å˜åŒ–æ—¶åˆ·æ–°åœ°å›¾
    $('#userSelect').change(function() {
        currentUser=$(this).val()
       //console.log('currentUser',currentUser);
        // è°ƒç”¨ initializeMap åˆ·æ–°æ•°æ®
        //initializeMap(selectedDeptId, selectedUserId);
        updateMapData(lastTotalInfo);
    });



    // æ›´æ–°éƒ¨é—¨é€‰æ‹©æ¡†
    function updateDepartmentSelect(departments) {
        const deptSelect = document.getElementById('deptSelect');
        if (!deptSelect) return;

        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        deptSelect.innerHTML = '<option value="">ğŸ¢ é€‰æ‹©éƒ¨é—¨</option>';

        // é€’å½’æ·»åŠ éƒ¨é—¨é€‰é¡¹
        function addDepartmentOptions(departments, level = 0) {
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                const indent = 'ã€€'.repeat(level);
                option.textContent = indent + 'ğŸ¢ ' + dept.name;
                deptSelect.appendChild(option);

                if (dept.children && dept.children.length > 0) {
                    addDepartmentOptions(dept.children, level + 1);
                }
            });
        }

        addDepartmentOptions(departments);
    }

    // æ›´æ–°ç”¨æˆ·é€‰æ‹©æ¡†
    async function updateUsers(deptId) {
        try {
            const userSelect = document.getElementById('userSelect');
            if (!userSelect) return;

            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            userSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';

            if (!deptId) return;

            const response = await fetch(`/fetch_users?orgId=${deptId}`);
            const data = await response.json();
            console.log('updateUsers.data', data);

            if (data) {
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    let displayText = user.user_name;
                    // å¦‚æœæœ‰èŒä½ä¿¡æ¯ï¼Œæ·»åŠ åˆ°æ˜¾ç¤ºæ–‡æœ¬ä¸­
                    if (user.position) {
                        displayText += ` (${user.position})`;
                    }
                    option.textContent = displayText;
                    userSelect.appendChild(option);
                });
                const option = document.createElement('option');
                option.value = 'all';
                option.textContent = 'å…¨éƒ¨ç”¨æˆ·';
                userSelect.appendChild(option);
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .filter-select {
            font-family: monospace;
            white-space: pre;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .filter-select option {
            font-family: monospace;
            white-space: pre;
            background: #1a1a1a;
            color: #fff;
        }

        .filter-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 21, 41, 0.9);
            backdrop-filter: blur(8px);
            padding: 15px;
            border-radius: 8px;
            width: 280px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.2);
        }

        .filter-header span {
            color: #00e4ff;
            font-size: 14px;
        }

        .filter-toggle {
            background: transparent;
            border: none;
            color: #00e4ff;
            cursor: pointer;
            padding: 5px;
            transition: all 0.3s ease;
        }

        .filter-toggle:hover {
            transform: scale(1.1);
        }
    `;
    document.head.appendChild(style);
  });
</script>

<div id="infoPanel" class="info-panel" style="display: none;">
  <div class="info-panel-header">
    <div class="info-panel-title">
      <i class="fas fa-info-circle"></i>
      <span>å®æ—¶ä¿¡æ¯</span>
    </div>
    <button class="info-panel-close" onclick="toggleInfoPanel()">Ã—</button>
  </div>
  <div class="info-panel-content" id="infoPanelContent">
    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let infoPanelVisible = false;
let lastTotalInfo = null;

// åˆ‡æ¢ä¿¡æ¯é¢æ¿æ˜¾ç¤ºçŠ¶æ€
function toggleInfoPanel() {
  const panel = document.getElementById('infoPanel');
  infoPanelVisible = !infoPanelVisible;
  panel.style.display = infoPanelVisible ? 'block' : 'none';
}

// æ·»åŠ é”®ç›˜å¿«æ·é”®åˆ‡æ¢ä¿¡æ¯é¢æ¿
document.addEventListener('keydown', (e) => {
  if (e.key === 'i' && e.ctrlKey) {
    toggleInfoPanel();
  }
});

function openInfoPanelWithAlertId(alertId) {
  infoPanelVisible = true;
  document.getElementById('infoPanel').style.display = 'block';
  updateInfoPanel(lastTotalInfo, alertId);
}
function showCustomMapInfo(f){
  removeCustomMapInfo();
  const d=f.properties,toStr=x=>x===undefined||x===null?'':String(x);
  const get=(...k)=>k.map(x=>d[x]).find(x=>x!==undefined&&x!==null&&x!=='')||'-';
  // åˆ¤æ–­æ˜¯å¦ä¸ºå‘Šè­¦ç‚¹ï¼šæœ‰alert_id/alertIdä¸”æœ‰alert_type/alertTypeï¼Œä¸”typeä¸æ˜¯health
  const isAlert=!!(get('alert_id','alertId')&&get('alert_type','alertType')&&d.type!=='health');
  console.log('showCustomMapInfo.d',d);
  console.log('showCustomMapInfo.isAlert',isAlert);
  const level=get('severity_level','severityLevel');
  const levelColor=level==='critical'?'#ff4d4f':level==='high'?'#ffbb00':'#ffe066';
  const avatarUrl=d.avatar||'/static/images/avatar-tech.svg';
  const div=document.createElement('div');
  div.className='custom-map-info';
  div.style.cssText='position:absolute;z-index:9999;min-width:360px;max-width:420px;background:rgba(10,24,48,0.98);border:1.5px solid #00e4ff;border-radius:16px;box-shadow:0 0 24px #00e4ff44;padding:22px 28px 18px 28px;color:#fff;top:120px;left:50%;transform:translateX(-50%);font-size:15px;font-family:Roboto,Arial,sans-serif;backdrop-filter:blur(6px);';
  // è·å–ä½ç½®ä¿¡æ¯
      const longitude = get('longitude');
      const latitude = get('latitude');
      if(longitude && latitude){
        reverseGeocode(longitude, latitude)
          .then(address => {
            const locationInfo = document.getElementById('locationInfo');
            if(locationInfo){
              locationInfo.textContent = address || 'æœªçŸ¥ä½ç½®';
            }
          })
          .catch(error => {
            console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
            const locationInfo = document.getElementById('locationInfo');
            if(locationInfo){
              locationInfo.textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
            }
          });
      }
  if(isAlert){
    
    // å‘Šè­¦ç‚¹å†…å®¹
    div.innerHTML=`
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
        <img src="${avatarUrl}" style="width:56px;height:56px;border-radius:50%;border:2px solid #00e4ff;box-shadow:0 0 8px #00e4ff44;object-fit:cover;background:#001529;">
        <div>
          <div style="font-size:18px;font-weight:700;letter-spacing:1px;">${get('dept_name','deptName')}</div>
          <div style="font-size:16px;color:#00e4ff;font-weight:500;margin-top:2px;">${get('user_name','userName')}</div>
        </div>
      </div>
    
      <div style="display:flex;gap:18px;flex-wrap:wrap;margin-bottom:8px;">
        <div><span style="color:#7ecfff;">å‘Šè­¦ç±»åˆ«ï¼š</span><span style="color:${getAlertTypeColor(get('alert_type','alertType','-'))};font-weight:700;">${translateAlertType(get('alert_type','alertType','-'))}</span></div>
        <div><span style="color:#7ecfff;">çº§åˆ«ï¼š</span><span style="color:${getAlertSeverityColor(level||'-')};font-weight:700;">${translateAlertSeverity(level||'-')}</span></div>
        <div><span style="color:#7ecfff;">çŠ¶æ€ï¼š</span><span style="color:${getAlertStatusColor(get('alert_status','status','-'))};font-weight:700;">${translateAlertStatus(get('alert_status','status','-'))}</span></div>
      </div>
      <div style="margin-bottom:12px;">
        <span style="color:#7ecfff;">å¥åº·ä¿¡æ¯ï¼š</span>
        <a href="javascript:void(0)" onclick="showHealthProfile('${get('health_id','healthId')}')" style="color:#00e4ff;text-decoration:underline;font-family:monospace;font-size:15px;">${get('health_id','healthId')}</a>
      </div>
    <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">ä½ç½®ä¿¡æ¯ï¼š</span><span id="locationInfo">æ­£åœ¨è·å–...</span>
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">å‘Šè­¦æ—¶é—´ï¼š</span>${get('alert_timestamp','timestamp','-')}
      </div>

      <div style="display:flex;gap:18px;align-items:center;">
        <button onclick="handleAlert('${get('alert_id','alertId')}')" style="padding:7px 22px;background:${levelColor};color:#001529;border:none;border-radius:6px;cursor:pointer;font-weight:700;box-shadow:0 2px 8px ${levelColor}44;transition:.2s;">ä¸€é”®å¤„ç†</button>
        <span style="flex:1"></span>
        <span style="color:#00e4ff;cursor:pointer;font-size:22px;font-weight:700;" onclick="removeCustomMapInfo()">Ã—</span>
      </div>
    `;
    document.body.appendChild(div);
    

  } else {
    // å¥åº·ç‚¹å†…å®¹
    div.innerHTML=`
      <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px;">
        <img src="${avatarUrl}" style="width:56px;height:56px;border-radius:50%;border:2px solid #00e4ff;box-shadow:0 0 8px #00e4ff44;object-fit:cover;background:#001529;">
        <div>
          <div style="font-size:18px;font-weight:700;letter-spacing:1px;">${get('dept_name','deptName')}</div>
          <div style="font-size:16px;color:#00e4ff;font-weight:500;margin-top:2px;">${get('user_name','userName')}</div>
        </div>
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">å¿ƒç‡ï¼š</span>${get('heartRate','heart_rate')}
        <span style="color:#7ecfff;margin-left:18px;">è¡€å‹ï¼š</span>${get('pressureHigh','pressure_high')}/${get('pressureLow','pressure_low')} mmHg
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">è¡€æ°§ï¼š</span>${get('bloodOxygen','blood_oxygen')}
        <span style="color:#7ecfff;margin-left:18px;">ä½“æ¸©ï¼š</span>${get('temperature','temp')} â„ƒ
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">æ­¥æ•°ï¼š</span>${get('step','steps')} æ­¥
        <span style="color:#7ecfff;margin-left:18px;">å¡è·¯é‡Œï¼š</span>${get('calorie','calories')} kcal
        <span style="color:#7ecfff;margin-left:18px;">è·ç¦»ï¼š</span>${get('distance','distance')} ç±³
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">å‹åŠ›ï¼š</span>${get('stress','pressure')}
        <span style="color:#7ecfff;margin-left:18px;">ç¡çœ ï¼š</span>${get('sleepData','scientificSleepData')}
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">ä½ç½®ä¿¡æ¯ï¼š</span><span id="locationInfo">æ­£åœ¨è·å–...</span>
      </div>
      <div style="margin-bottom:8px;">
        <span style="color:#7ecfff;">é‡‡é›†æ—¶é—´ï¼š</span>${get('timestamp')}
      </div>
      <div style="display:flex;gap:18px;align-items:center;">
        <span style="flex:1"></span>
        <span style="color:#00e4ff;cursor:pointer;font-size:22px;font-weight:700;" onclick="removeCustomMapInfo()">Ã—</span>
      </div>
    `;
    document.body.appendChild(div);
    
    // è·å–ä½ç½®ä¿¡æ¯
    const longitude = get('longitude');
    const latitude = get('latitude');
    if(longitude && latitude){
      reverseGeocode(longitude, latitude)
        .then(address => {
          const locationInfo = document.getElementById('locationInfo');
          if(locationInfo){
            locationInfo.textContent = address || 'æœªçŸ¥ä½ç½®';
          }
        })
        .catch(error => {
          console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
          const locationInfo = document.getElementById('locationInfo');
          if(locationInfo){
            locationInfo.textContent = 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
          }
        });
    }
  }
}
function showHealthProfile(healthId){
  fetch(`/fetchHealthDataById?id=${healthId}`).then(r=>r.json()).then(j=>{
    if(!j.success||!j.data)return showCustomAlert('æ— å¥åº·æ•°æ®');
    const d=j.data,g=(...k)=>k.map(x=>d[x]).find(x=>x!==undefined&&x!==null&&x!=='')||'-';
    let sleepStr=g('sleepData','scientificSleepData'),sleep='-';
    try{
      if(typeof sleepStr==='string'&&sleepStr.startsWith('{')){
        const o=JSON.parse(sleepStr),arr=o.data||[];
        if(arr.length){
          const s=arr[0],fmt=m=>m?`${Math.floor(m/60)}h${m%60}m`:'-';
          sleep=`æ€»:${fmt(s.total)} æ·±:${fmt(s.deep)} æµ…:${fmt(s.light)} é†’:${fmt(s.awake)}`;
        }
      }
    }catch(e){sleep='-';}
    const html=`
      <div style="font-size:20px;font-weight:700;color:#00e4ff;margin-bottom:12px;text-align:center;">å¥åº·æ•°æ®</div>
      <div style="display:grid;grid-template-columns:100px 1fr;row-gap:8px;column-gap:10px;">
        <span>å¿ƒç‡</span><span style="text-align:right;font-weight:600;color:#7ecfff;">${g('heartRate','heart_rate')||'-'} <span style="color:#888;font-weight:400;">bpm</span></span>
        <span>è¡€å‹</span><span style="text-align:right;">${(g('pressureHigh','pressure_high')||'-')+'/'+(g('pressureLow','pressure_low')||'-')} <span style="color:#888;font-weight:400;">mmHg</span></span>
        <span>è¡€æ°§</span><span style="text-align:right;">${g('bloodOxygen','blood_oxygen')||'-'} <span style="color:#888;font-weight:400;">%</span></span>
        <span>ä½“æ¸©</span><span style="text-align:right;">${g('temperature','temp')||'-'} <span style="color:#888;font-weight:400;">â„ƒ</span></span>
        <span>æ­¥æ•°</span><span style="text-align:right;">${g('step','steps')||'-'} <span style="color:#888;font-weight:400;">æ­¥</span></span>
        <span>è·ç¦»</span><span style="text-align:right;">${g('distance','distance')||'-'} <span style="color:#888;font-weight:400;">ç±³</span></span>
        <span>å¡è·¯é‡Œ</span><span style="text-align:right;">${g('calorie','calories')||'-'} <span style="color:#888;font-weight:400;">kcal</span></span>
        <span>å‹åŠ›</span><span style="text-align:right;">${g('stress','pressure')||'-'} <span style="color:#888;font-weight:400;">åˆ†</span></span>
        <span>ç¡çœ </span><span style="text-align:right;">${sleep}</span>
        <span>é‡‡é›†æ—¶é—´</span><span style="text-align:right;">${g('timestamp')||'-'}</span>
      </div>
    `;
    const m=document.createElement('div');
    m.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,21,41,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';
    m.innerHTML=`<div style="background:rgba(10,24,48,0.98);border-radius:14px;box-shadow:0 0 24px #00e4ff44;padding:32px 38px;min-width:320px;max-width:420px;color:#fff;position:relative;">
      <span style="position:absolute;right:18px;top:12px;cursor:pointer;font-size:22px;color:#00e4ff;" onclick="this.parentNode.parentNode.remove()">Ã—</span>
      ${html}
    </div>`;
    document.body.appendChild(m);
  }).catch(()=>showCustomAlert('è·å–å¥åº·æ•°æ®å¤±è´¥'));
}

function removeCustomMapInfo(){const old=document.querySelector('.custom-map-info');if(old)old.remove();}

function filterData(data){
    //console.log('filterData.data',currentDept,currentUser);

    //console.log('filterData.data.healthData',data.healthData);
  const toStr=x=>x===undefined||x===null?'':String(x);
  const dept=toStr(currentDept),user=toStr(currentUser);
  const alerts=(data.alert_info?.alerts||[]).filter(a=>
    (!dept||[a.dept_id,a.deptId].some(v=>toStr(v)===dept))&&
    (!user||[a.user_id,a.userId].some(v=>toStr(v)===user))&&
    (['pending','1'].includes(toStr(a.alert_status||a.status)))
  );
  const healths=(data.health_data?.healthData||[]).filter(h=>
    (!dept||[h.dept_id,h.deptId].some(v=>toStr(v)===dept))&&
    (!user||[h.user_id,h.userId].some(v=>toStr(v)===user))
  );
  //console.log('filterData.alerts',alerts);
  //console.log('filterData.healths',healths);
  return {alerts,healths};
}

window.updateMapData = function(data){
    //console.log('updateMapData.data',data);
  if(!data||!map||!loca)return;
  const {alerts,healths}=filterData(data);
  const f=[];
  // å¤„ç†å‘Šè­¦æ•°æ®
  alerts.forEach(a=>{
    if((a.longitude||a.longitude===0)&&(a.latitude||a.latitude===0)){
      f.push({
        type:'Feature',
        geometry:{type:'Point',coordinates:[+a.longitude,+a.latitude]},
        properties:{
          ...a,
          alert_id: a.alert_id,
          alert_type: a.alert_type,
          alert_status: a.alert_status,
          severity_level: a.severity_level,
          dept_name: a.dept_name,
          user_name: a.user_name,
          health_id: a.health_id,
          device_sn: a.device_sn,
          alert_timestamp: a.alert_timestamp,
          type: 'alert'
        }
      });
    }
  });
  // å¤„ç†å¥åº·æ•°æ®
  healths.forEach(h=>{
    if((h.longitude||h.longitude===0)&&(h.latitude||h.latitude===0)){
      f.push({
        type:'Feature',
        geometry:{type:'Point',coordinates:[+h.longitude,+h.latitude]},
        properties:{
          ...h,
          dept_name: h.deptName,
          user_name: h.userName,
          heart_rate: h.heartRate,
          blood_oxygen: h.bloodOxygen,
          temperature: h.temperature,
          pressure_high: h.pressureHigh,
          pressure_low: h.pressureLow,
          step: h.step,
          stress: h.stress,
          device_sn: h.deviceSn,
          timestamp: h.timestamp,
          avatar: h.avatar,
          sleepData: h.sleepData,
          timestamp: h.timestamp,
          type: 'health'
        }
      });
    }
  });
  
  const geoJSON={type:'FeatureCollection',features:f};
  const criticalAlerts={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.severity_level==='critical')};
  const highAlerts={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.severity_level==='high'||f.properties.severity_level==='medium')};
  const healthData={type:'FeatureCollection',features:geoJSON.features.filter(f=>f.properties.type==='health')};
  
  breathRed.setSource(new Loca.GeoJSONSource({data:criticalAlerts}));
  breathYellow.setSource(new Loca.GeoJSONSource({data:highAlerts}));
  breathGreen.setSource(new Loca.GeoJSONSource({data:healthData}));
  
  // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
  let center=null;
  const getCoord=f=>f&&f.geometry&&f.geometry.coordinates;
  const findFirst=(arr,cond)=>{for(let i=0;i<arr.length;i++)if(cond(arr[i]))return arr[i];return null;};
  const cAlert=findFirst(geoJSON.features,f=>f.properties.type==='alert'&&['critical','high','medium'].includes(f.properties.severity_level));
  const cHealth=findFirst(geoJSON.features,f=>f.properties.type==='health');
  if(cAlert)center=getCoord(cAlert);
  else if(cHealth)center=getCoord(cHealth);
  if(center&&center.length>=2)map.setCenter([center[0],center[1]]);
  else if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setCenter([pos.coords.longitude,pos.coords.latitude]);
    });
  }
}
</script>
  </body>
</html>

