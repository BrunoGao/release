version: '3.8'

# 扩展配置
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  ljwx-bigscreen-secure:
    image: crpi-yilnm6upy4pmbp67.cn-shenzhen.personal.cr.aliyuncs.com/ljwx/ljwx-bigscreen-secure:latest
    container_name: ljwx-bigscreen-secure
    restart: unless-stopped
    logging: *default-logging
    
    # 安全配置
    read_only: true  # 只读文件系统
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /app/logs:noexec,nosuid,size=500m
    
    # 权限控制
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    security_opt:
      - no-new-privileges:true
      - apparmor:unconfined  # 根据需要调整
    
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # 环境变量
    environment:
      # 数据库配置
      MYSQL_HOST: ${MYSQL_HOST:-mysql}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-123456}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-lj-06}
      
      # Redis配置
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-123456}
      
      # 应用配置
      IS_DOCKER: "true"
      APP_PORT: 8001
      
      # 微信配置
      WECHAT_APP_ID: ${WECHAT_APP_ID:-wx10dcc9f0235e1d77}
      WECHAT_APP_SECRET: ${WECHAT_APP_SECRET:-b7e9088f3f5fe18a9cfb990c641138b3}
      WECHAT_TEMPLATE_ID: ${WECHAT_TEMPLATE_ID:-oJpIEzSJW67s-W_tDTbnB5uS1biiglLH5jcaALofujk}
      WECHAT_USER_OPENID: ${WECHAT_USER_OPENID:-ofYhV6W_mDuDnm8lVbgVbgEMtvWc}
      WECHAT_ALERT_ENABLED: ${WECHAT_ALERT_ENABLED:-true}
      
      # License配置（可选）
      LICENSE_KEY: ${LICENSE_KEY:-}
      LICENSE_SERVER: ${LICENSE_SERVER:-}
    
    # 端口映射
    ports:
      - "8001:8001"
    
    # 卷挂载（只读配置）
    volumes:
      - ./config.secure.py:/app/config.py:ro
      - ./static:/app/static:ro
      - ./templates:/app/templates:ro
      # 日志使用tmpfs，不持久化敏感信息
    
    # 网络配置
    networks:
      - ljwx-secure-network
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # 依赖服务
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # MySQL服务（可选，如果使用外部数据库可删除）
  mysql:
    image: mysql:8.0
    container_name: ljwx-mysql-secure
    restart: unless-stopped
    logging: *default-logging
    
    # 安全配置
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    
    security_opt:
      - no-new-privileges:true
    
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD:-123456}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-lj-06}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    
    ports:
      - "3306:3306"
    
    volumes:
      - mysql_secure_data:/var/lib/mysql
      - ./mysql-secure.cnf:/etc/mysql/conf.d/secure.cnf:ro
    
    networks:
      - ljwx-secure-network
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis服务（可选，如果使用外部Redis可删除）
  redis:
    image: redis:7-alpine
    container_name: ljwx-redis-secure
    restart: unless-stopped
    logging: *default-logging
    
    # 安全配置
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    
    security_opt:
      - no-new-privileges:true
    
    command: redis-server --requirepass ${REDIS_PASSWORD:-123456} --appendonly yes
    
    ports:
      - "6379:6379"
    
    volumes:
      - redis_secure_data:/data
    
    networks:
      - ljwx-secure-network
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

# 网络配置
networks:
  ljwx-secure-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: ljwx-secure-br
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 卷配置
volumes:
  mysql_secure_data:
    driver: local
  redis_secure_data:
    driver: local 