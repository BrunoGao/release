# ===== ç¬¬ä¸€é˜¶æ®µï¼šæºç ç¼–è¯‘å’Œä¿æŠ¤é˜¶æ®µ =====
FROM python:3.9-slim AS builder
WORKDIR /app

# å®‰è£…æž„å»ºä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc g++ pkg-config libmariadb-dev \
    && pip install --no-cache-dir --upgrade pip

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…
COPY requirements-docker.txt .
RUN pip install --no-cache-dir --user -r requirements-docker.txt

# å¤åˆ¶æºä»£ç 
COPY . .

# åˆ›å»ºæºç ä¿æŠ¤è„šæœ¬
RUN cat > protect_source.py << 'EOF'
#!/usr/bin/env python3
import os
import py_compile
import shutil
import compileall
from pathlib import Path

def compile_to_bytecode():
    """å°†æ‰€æœ‰Pythonæ–‡ä»¶ç¼–è¯‘ä¸ºå­—èŠ‚ç """
    print("ðŸ”§ ç¼–è¯‘Pythonæºç ä¸ºå­—èŠ‚ç ...")
    
    # ç¼–è¯‘æ‰€æœ‰.pyæ–‡ä»¶ä¸º.pyc
    compileall.compile_dir('.', force=True, quiet=1)
    
    # æ‰‹åŠ¨ç¼–è¯‘å…³é”®æ–‡ä»¶ç¡®ä¿æˆåŠŸ
    key_files = [
        'run.py', 'config.py', 'wechat_config.py', 
        'metrics.py', 'alert_webhook.py'
    ]
    
    for file in key_files:
        if os.path.exists(file):
            try:
                py_compile.compile(file, doraise=True)
                print(f"âœ… ç¼–è¯‘æˆåŠŸ: {file}")
            except Exception as e:
                print(f"âŒ ç¼–è¯‘å¤±è´¥: {file} - {e}")
    
    # ç¼–è¯‘bigScreenç›®å½•
    if os.path.exists('bigScreen'):
        compileall.compile_dir('bigScreen', force=True, quiet=1)
        print("âœ… bigScreenç›®å½•ç¼–è¯‘å®Œæˆ")

def create_minimal_runner():
    """åˆ›å»ºæœ€å°åŒ–çš„å¯åŠ¨å™¨"""
    runner_code = '''#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import os

# è®¾ç½®çŽ¯å¢ƒå˜é‡
if 'IS_DOCKER' not in os.environ:
    os.environ['IS_DOCKER'] = 'true'

# å¯¼å…¥ç¼–è¯‘åŽçš„æ¨¡å—
try:
    import run
except ImportError as e:
    print(f"å¯åŠ¨å¤±è´¥: {e}")
    sys.exit(1)
'''
    
    with open('start_app.py', 'w') as f:
        f.write(runner_code)
    
    print("âœ… åˆ›å»ºå¯åŠ¨å™¨å®Œæˆ")

def cleanup_source_files():
    """æ¸…ç†æºä»£ç æ–‡ä»¶ï¼Œä¿ç•™å­—èŠ‚ç """
    print("ðŸ§¹ æ¸…ç†æºä»£ç æ–‡ä»¶...")
    
    # éœ€è¦ä¿ç•™çš„æ–‡ä»¶
    keep_files = {
        'start_app.py',  # å¯åŠ¨å™¨
        'requirements-docker.txt',
        '__init__.py'  # PythonåŒ…æ ‡è¯†
    }
    
    # éœ€è¦ä¿ç•™çš„ç›®å½•
    keep_dirs = {
        '__pycache__',  # å­—èŠ‚ç ç›®å½•
        'static',       # é™æ€èµ„æº
        'templates',    # æ¨¡æ¿æ–‡ä»¶
        'data'          # æ•°æ®ç›®å½•
    }
    
    removed_count = 0
    
    for root, dirs, files in os.walk('.', topdown=False):
        # è·³è¿‡éœ€è¦ä¿ç•™çš„ç›®å½•
        if any(keep_dir in root for keep_dir in keep_dirs):
            continue
            
        for file in files:
            filepath = os.path.join(root, file)
            
            # åˆ é™¤.pyæºæ–‡ä»¶ï¼ˆé™¤äº†ä¿ç•™åˆ—è¡¨ï¼‰
            if file.endswith('.py') and file not in keep_files:
                try:
                    os.remove(filepath)
                    removed_count += 1
                    print(f"åˆ é™¤: {filepath}")
                except Exception as e:
                    print(f"åˆ é™¤å¤±è´¥: {filepath} - {e}")
            
            # åˆ é™¤å…¶ä»–æ•æ„Ÿæ–‡ä»¶
            elif file.endswith(('.log', '.tmp', '.bak', '.orig')):
                try:
                    os.remove(filepath)
                    print(f"åˆ é™¤æ•æ„Ÿæ–‡ä»¶: {filepath}")
                except:
                    pass
    
    # åˆ é™¤æ•æ„Ÿç›®å½•
    sensitive_dirs = ['.git', 'logs', 'cache', 'venv', 'myenv']
    for dir_name in sensitive_dirs:
        if os.path.exists(dir_name):
            try:
                shutil.rmtree(dir_name)
                print(f"åˆ é™¤ç›®å½•: {dir_name}")
            except:
                pass
    
    print(f"âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† {removed_count} ä¸ªæºæ–‡ä»¶")

def verify_bytecode():
    """éªŒè¯å­—èŠ‚ç æ–‡ä»¶å­˜åœ¨"""
    print("ðŸ” éªŒè¯å­—èŠ‚ç æ–‡ä»¶...")
    
    pycache_dirs = []
    for root, dirs, files in os.walk('.'):
        if '__pycache__' in dirs:
            pycache_path = os.path.join(root, '__pycache__')
            pycache_dirs.append(pycache_path)
            pyc_files = [f for f in os.listdir(pycache_path) if f.endswith('.pyc')]
            print(f"ðŸ“ {pycache_path}: {len(pyc_files)} ä¸ª.pycæ–‡ä»¶")
    
    if pycache_dirs:
        print(f"âœ… å‘çŽ° {len(pycache_dirs)} ä¸ªå­—èŠ‚ç ç›®å½•")
    else:
        print("âš ï¸  æœªå‘çŽ°å­—èŠ‚ç ç›®å½•")

if __name__ == "__main__":
    compile_to_bytecode()
    create_minimal_runner()
    verify_bytecode()
    cleanup_source_files()
    print("ðŸŽ‰ æºç ä¿æŠ¤å®Œæˆï¼")
EOF

# æ‰§è¡Œæºç ä¿æŠ¤
RUN python protect_source.py

# ===== ç¬¬äºŒé˜¶æ®µï¼šå®‰å…¨è¿è¡Œé˜¶æ®µ =====
FROM python:3.9-slim AS runtime
WORKDIR /app

# åˆ›å»ºéžç‰¹æƒç”¨æˆ·
RUN groupadd -r ljwx && useradd -r -g ljwx -s /bin/false -d /app ljwx

# åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„åº“
RUN apt-get update && apt-get install -y --no-install-recommends \
    libmariadb3 tzdata curl \
    && ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ä»Žæž„å»ºé˜¶æ®µå¤åˆ¶PythonåŒ…
COPY --from=builder /root/.local /root/.local

# ä»Žæž„å»ºé˜¶æ®µå¤åˆ¶ä¿æŠ¤åŽçš„åº”ç”¨æ–‡ä»¶
COPY --from=builder /app /app

# è®¾ç½®Pythonè·¯å¾„
ENV PATH=/root/.local/bin:$PATH
ENV PYTHONPATH=/root/.local/lib/python3.9/site-packages:/app
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# è®¾ç½®åº”ç”¨çŽ¯å¢ƒå˜é‡
ENV IS_DOCKER=true
ENV APP_PORT=8001

# åˆ›å»ºå¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app/logs /app/data \
    && chown -R ljwx:ljwx /app \
    && chmod -R 755 /app \
    && chmod +x /app/start_app.py

# åˆ‡æ¢åˆ°éžç‰¹æƒç”¨æˆ·
USER ljwx

# æš´éœ²ç«¯å£
EXPOSE 8001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8001/ || exit 1

# å¯åŠ¨åº”ç”¨ï¼ˆä½¿ç”¨å­—èŠ‚ç ï¼‰
CMD ["python3", "start_app.py"] 