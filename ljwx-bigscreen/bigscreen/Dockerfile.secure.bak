# ===== ç¬¬ä¸€é˜¶æ®µï¼šæºç ç¼–è¯‘é˜¶æ®µ =====
FROM python:3.9-slim AS builder
WORKDIR /app

# å®‰è£…ç¼–è¯‘ä¾èµ–å’ŒNuitka
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc g++ pkg-config libmariadb-dev \
    ccache patchelf upx-ucl \
    && pip install --no-cache-dir --upgrade pip \
    && pip install nuitka ordered-set

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…
COPY requirements-docker.txt .
RUN pip install --no-cache-dir -r requirements-docker.txt

# å¤åˆ¶æºä»£ç 
COPY . .

# åˆ›å»ºç¼–è¯‘è„šæœ¬
RUN cat > compile_app.py << 'EOF'
#!/usr/bin/env python3
import os
import subprocess
import shutil

def compile_main():
    """ç¼–è¯‘ä¸»åº”ç”¨ä¸ºäºŒè¿›åˆ¶"""
    print("ğŸ”§ å¼€å§‹ç¼–è¯‘ä¸»åº”ç”¨...")
    
    # Nuitkaç¼–è¯‘å‚æ•°
    cmd = [
        "python", "-m", "nuitka",
        "--standalone",
        "--onefile", 
        "--assume-yes-for-downloads",
        "--enable-plugin=pylint-warnings",
        "--python-flag=no_site",
        "--python-flag=no_warnings",
        "--remove-output",
        "--output-filename=ljwx_bigscreen",
        "run.py"
    ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        print(f"âŒ ç¼–è¯‘å¤±è´¥: {result.stderr}")
        return False
    
    print("âœ… ä¸»åº”ç”¨ç¼–è¯‘æˆåŠŸ")
    return True

def compile_modules():
    """ç¼–è¯‘æ ¸å¿ƒæ¨¡å—ä¸º.soæ–‡ä»¶"""
    print("ğŸ”§ ç¼–è¯‘æ ¸å¿ƒæ¨¡å—...")
    
    # éœ€è¦ç¼–è¯‘çš„æ ¸å¿ƒæ¨¡å—
    modules = [
        "config.py",
        "wechat_config.py", 
        "metrics.py",
        "alert_webhook.py"
    ]
    
    for module in modules:
        if os.path.exists(module):
            print(f"ç¼–è¯‘ {module}...")
            # ä½¿ç”¨Cythonç¼–è¯‘ä¸º.so
            cmd = [
                "python", "-c",
                f"import py_compile; py_compile.compile('{module}', doraise=True)"
            ]
            subprocess.run(cmd)
    
    print("âœ… æ¨¡å—ç¼–è¯‘å®Œæˆ")

def cleanup_source():
    """æ¸…ç†æºä»£ç æ–‡ä»¶"""
    print("ğŸ§¹ æ¸…ç†æºä»£ç ...")
    
    # åˆ é™¤.pyæºæ–‡ä»¶ï¼ˆä¿ç•™ç¼–è¯‘ç»“æœï¼‰
    for root, dirs, files in os.walk("."):
        # è·³è¿‡è™šæ‹Ÿç¯å¢ƒå’Œç¼“å­˜ç›®å½•
        dirs[:] = [d for d in dirs if d not in ['venv', '__pycache__', '.git', 'myenv']]
        
        for file in files:
            filepath = os.path.join(root, file)
            # åˆ é™¤æºç æ–‡ä»¶ä½†ä¿ç•™å¿…è¦é…ç½®
            if file.endswith(('.py', '.pyx')) and not file.startswith('__'):
                if file not in ['__init__.py']:  # ä¿ç•™__init__.py
                    try:
                        os.remove(filepath)
                        print(f"åˆ é™¤æºæ–‡ä»¶: {filepath}")
                    except:
                        pass
    
    # æ¸…ç†å…¶ä»–æ•æ„Ÿæ–‡ä»¶
    sensitive_patterns = ['.git', '*.log', 'logs/', 'cache/', '__pycache__']
    for pattern in sensitive_patterns:
        try:
            if os.path.isdir(pattern):
                shutil.rmtree(pattern)
            elif os.path.isfile(pattern):
                os.remove(pattern)
        except:
            pass
    
    print("âœ… æºä»£ç æ¸…ç†å®Œæˆ")

if __name__ == "__main__":
    if compile_main():
        compile_modules()
        cleanup_source()
        print("ğŸ‰ ç¼–è¯‘æµç¨‹å®Œæˆï¼")
    else:
        exit(1)
EOF

# æ‰§è¡Œç¼–è¯‘
RUN python compile_app.py

# ===== ç¬¬äºŒé˜¶æ®µï¼šå®‰å…¨è¿è¡Œé˜¶æ®µ =====
FROM python:3.9-slim AS runtime
WORKDIR /app

# åˆ›å»ºéç‰¹æƒç”¨æˆ·
RUN groupadd -r ljwx && useradd -r -g ljwx -s /bin/false ljwx

# åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„åº“
RUN apt-get update && apt-get install -y --no-install-recommends \
    libmariadb3 tzdata \
    && ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/ljwx_bigscreen /app/ljwx_bigscreen
COPY --from=builder /app/static /app/static
COPY --from=builder /app/templates /app/templates

# å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶ï¼ˆéæºç ï¼‰
COPY --from=builder /app/*.json /app/ 2>/dev/null || true
COPY --from=builder /app/*.txt /app/ 2>/dev/null || true

# è®¾ç½®æƒé™
RUN chmod +x /app/ljwx_bigscreen \
    && chown -R ljwx:ljwx /app \
    && chmod -R 755 /app

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs && chown ljwx:ljwx /app/logs

# åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER ljwx

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV APP_PORT=8001
ENV IS_DOCKER=true

# æš´éœ²ç«¯å£
EXPOSE 8001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

# å¯åŠ¨ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
CMD ["./ljwx_bigscreen"] 