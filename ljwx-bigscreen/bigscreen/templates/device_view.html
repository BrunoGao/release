<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ‰‹è¡¨è®¾å¤‡åˆ†æç³»ç»Ÿ</title>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft YaHei', Arial, sans-serif; 
            background: transparent; 
            color: #fff; 
            padding: 20px;
        }
        
        .container { 
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* å¯æŠ˜å é¢æ¿æ ·å¼ */
        .collapsible-panel {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .panel-header {
            padding: 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 228, 255, 0.05);
            transition: background 0.3s ease;
        }

        .panel-header:hover {
            background: rgba(0, 228, 255, 0.1);
        }

        .panel-header h3 {
            color: #00e4ff;
            font-size: 20px;
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        .panel-toggle {
            color: #00e4ff;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .panel-toggle.expanded {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .panel-content.expanded {
            max-height: 1000px;
            padding: 20px;
        }
        
        /* è¿‡æ»¤å™¨æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            color: #00e4ff;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            background: rgba(1, 19, 38, 0.8);
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #00e4ff;
            box-shadow: 0 0 5px rgba(0, 228, 255, 0.5);
        }

        .filter-select option {
            background: rgba(1, 19, 38, 0.9);
            color: #fff;
            padding: 8px;
        }

        .send-btn {
            background: linear-gradient(45deg, #00e4ff, #00a8ff);
            color: #001529;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }

        .send-btn:hover {
            background: linear-gradient(45deg, #00a8ff, #00e4ff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 228, 255, 0.3);
        }

        /* è®¾å¤‡è¡¨æ ¼å®¹å™¨æ ·å¼ */
        .device-table-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            max-height: 500px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .device-table-container h2 {
            color: #00e4ff;
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        #deviceTable {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 8px;
        }

        /* è¡¨æ ¼åŸºç¡€æ ·å¼ */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            position: relative;
        }

        th {
            background: linear-gradient(180deg, rgba(0, 228, 255, 0.15) 0%, rgba(0, 228, 255, 0.05) 100%);
            color: #00e4ff;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(0, 228, 255, 0.2);
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        th:first-child { border-top-left-radius: 8px; }
        th:last-child { border-top-right-radius: 8px; }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 228, 255, 0.1);
            transition: all 0.3s ease;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tr:nth-child(even) {
            background: rgba(0, 228, 255, 0.03);
        }

        tr:hover td {
            background: rgba(0, 228, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 228, 255, 0.1);
        }

        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .status-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .status-active {
            background: linear-gradient(45deg, rgba(82, 196, 26, 0.2) 0%, rgba(82, 196, 26, 0.4) 100%);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
        }

        .status-inactive {
            background: linear-gradient(45deg, rgba(245, 34, 45, 0.2) 0%, rgba(245, 34, 45, 0.4) 100%);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
        }

        .status-charging {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.2) 0%, rgba(33, 150, 243, 0.4) 100%);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.3);
            animation: pulse 1.5s infinite;
        }

        .status-not-charging {
            background: linear-gradient(45deg, rgba(250, 140, 22, 0.2) 0%, rgba(250, 140, 22, 0.4) 100%);
            color: #fa8c16;
            border: 1px solid rgba(250, 140, 22, 0.3);
        }

        .status-worn {
            background: linear-gradient(45deg, rgba(82, 196, 26, 0.2) 0%, rgba(82, 196, 26, 0.4) 100%);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
        }

        .status-not-worn {
            background: linear-gradient(45deg, rgba(245, 34, 45, 0.2) 0%, rgba(245, 34, 45, 0.4) 100%);
            color: #f5222d;
            border: 1px solid rgba(245, 34, 45, 0.3);
        }

        /* ç”µæ± è¿›åº¦æ¡ */
        .battery-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .battery-visual {
            position: relative;
            width: 60px;
            height: 12px;
            border: 1px solid #666;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .battery-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }

        .battery-low .battery-bar { background: linear-gradient(90deg, #f5222d, #ff4d4f); }
        .battery-medium .battery-bar { background: linear-gradient(90deg, #fa8c16, #ffc53d); }
        .battery-high .battery-bar { background: linear-gradient(90deg, #52c41a, #73d13d); }

        .battery-text {
            font-size: 12px;
            font-weight: 600;
            min-width: 35px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* å›¾è¡¨ç½‘æ ¼å®¹å™¨ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-container {
            background: rgba(1, 19, 38, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 228, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            height: 350px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: rgba(0, 228, 255, 0.4);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }

        /* ç”µæ± åˆ†æå›¾è¡¨è·¨ä¸¤åˆ— */
        .chart-container.full-width {
            grid-column: span 2;
            height: 400px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #deviceTable::-webkit-scrollbar {
            width: 8px;
        }

        #deviceTable::-webkit-scrollbar-track {
            background: rgba(0, 228, 255, 0.1);
            border-radius: 4px;
        }

        #deviceTable::-webkit-scrollbar-thumb {
            background: rgba(0, 228, 255, 0.2);
            border-radius: 4px;
        }

        #deviceTable::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 228, 255, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container.full-width {
                grid-column: span 1;
            }
            
            .form-group {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¿‡æ»¤å™¨é¢æ¿ -->
        <div class="collapsible-panel">
            <div class="panel-header" onclick="togglePanel('filterPanel')">
                <h3>ğŸ” è®¾å¤‡ç­›é€‰</h3>
                <span class="panel-toggle" id="filterPanelToggle">â–¼</span>
            </div>
            <div class="panel-content" id="filterPanelContent">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group">
                        <label>è®¾å¤‡çŠ¶æ€ï¼š</label>
                        <select id="filterStatus" class="filter-select" onchange="updateDashboard()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="ACTIVE">åœ¨çº¿</option>
                            <option value="INACTIVE">ç¦»çº¿</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å……ç”µçŠ¶æ€ï¼š</label>
                        <select id="filterCharging" class="filter-select" onchange="updateDashboard()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="CHARGING">å……ç”µä¸­</option>
                            <option value="NOT_CHARGING">æœªå……ç”µ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ä½©æˆ´çŠ¶æ€ï¼š</label>
                        <select id="filterWearable" class="filter-select" onchange="updateDashboard()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="WORN">å·²ä½©æˆ´</option>
                            <option value="NOT_WORN">æœªä½©æˆ´</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ç”µæ± ç”µé‡ï¼š</label>
                        <select id="filterBattery" class="filter-select" onchange="updateDashboard()">
                            <option value="">å…¨éƒ¨èŒƒå›´</option>
                            <option value="low">ä½ç”µé‡ (0-20%)</option>
                            <option value="medium">ä¸­ç­‰ (21-70%)</option>
                            <option value="high">é«˜ç”µé‡ (71-100%)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 0; min-width: 120px; display: flex; align-items: end;">
                        <button id="resetFilter" class="send-btn" onclick="resetFilters()">é‡ç½®ç­›é€‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾å¤‡è¡¨æ ¼ -->
        <div class="device-table-container">
            <h2>è®¾å¤‡åˆ—è¡¨ <span id="deviceCount" style="font-size: 14px; color: #00e4ff; opacity: 0.8;"></span></h2>
            <div id="deviceTable"></div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨ -->
        <div class="charts-grid">
            <!-- ç¬¬ä¸€è¡Œ -->
            <div class="chart-container">
                <div id="departmentChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="statusChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œ -->
            <div class="chart-container">
                <div id="chargingChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="wearableChart" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- ç¬¬ä¸‰è¡Œ -->
            <div class="chart-container">
                <div id="batteryChart" style="width: 100%; height: 100%;"></div>
            </div>
            <div class="chart-container">
                <div id="systemVersionChart" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- ç”µæ± åˆ†æå›¾è¡¨ï¼ˆè·¨è¶Šæ‰€æœ‰åˆ—ï¼‰ -->
            <div class="chart-container full-width">
                <div id="batteryTrendChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        const chartInstances = new Map();
        let originalDeviceData = null;
        let currentFilteredData = null;

        // é¢æ¿åˆ‡æ¢åŠŸèƒ½
        function togglePanel(panelId) {
            const content = document.getElementById(panelId + 'Content');
            const toggle = document.getElementById(panelId + 'Toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = 'â–¼';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = 'â–²';
            }
        }

        // å…¨å±€æš´éœ²å‡½æ•°
        window.togglePanel = togglePanel;

        async function fetchDeviceInfo() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId') || '1';
                const deptId = urlParams.get('deptId') || '';
                const userId = urlParams.get('userId') || '';

                const orgId = deptId || customerId;
                let url = `/api/devices?orgId=${orgId}`;
                if (userId && userId !== 'all') url += `&userId=${userId}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    return result;
                }
                throw new Error('Failed to fetch device data');
            } catch (error) {
                console.error('Error fetching device data:', error);
                return null;
            }
        }

        function displayDeviceTable(devices) {
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ç¼–å·</th>
                            <th>æ‰€å±éƒ¨é—¨</th>
                            <th>ä½¿ç”¨äººå‘˜</th>
                            <th>è®¾å¤‡çŠ¶æ€</th>
                            <th>ç”µæ± ç”µé‡</th>
                            <th>å……ç”µçŠ¶æ€</th>
                            <th>ä½©æˆ´çŠ¶æ€</th>
                            <th>ç³»ç»Ÿç‰ˆæœ¬</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${devices.map(device => {
                            const battery = parseInt(device.battery_level) || 0;
                            let batteryClass = 'battery-medium';
                            if (battery <= 20) batteryClass = 'battery-low';
                            else if (battery >= 71) batteryClass = 'battery-high';

                            return `
                                <tr>
                                    <td title="${device.serial_number}">${device.serial_number}</td>
                                    <td title="${device.department_name}">${device.department_name}</td>
                                    <td title="${device.user_name}">${device.user_name}</td>
                                    <td>
                                        <span class="status-badge ${device.status === 'ACTIVE' ? 'status-active' : 'status-inactive'}">
                                            ${device.status === 'ACTIVE' ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="battery-container">
                                            <div class="battery-visual ${batteryClass}">
                                                <div class="battery-bar" style="width: ${battery}%;"></div>
                                            </div>
                                            <span class="battery-text">${battery}%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge ${device.charging_status === 'CHARGING' ? 'status-charging' : 'status-not-charging'}">
                                            ${device.charging_status === 'CHARGING' ? 'å……ç”µä¸­' : 'æœªå……ç”µ'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge ${device.wearable_status === 'WORN' ? 'status-worn' : 'status-not-worn'}">
                                            ${device.wearable_status === 'WORN' ? 'å·²ä½©æˆ´' : 'æœªä½©æˆ´'}
                                        </span>
                                    </td>
                                    <td title="${device.system_software_version}">${device.system_software_version}</td>
                                    <td title="${device.update_time}">${device.update_time}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('deviceTable').innerHTML = tableHtml;
            document.getElementById('deviceCount').textContent = `(å…± ${devices.length} å°è®¾å¤‡)`;
        }

        function updateCharts(data) {
            // éƒ¨é—¨åˆ†å¸ƒé¥¼å›¾
            updateDepartmentChart(data.departmentDeviceCount);
            // è®¾å¤‡çŠ¶æ€æŸ±çŠ¶å›¾
            updateStatusChart(data.deviceStatusCount);
            // å……ç”µçŠ¶æ€é¥¼å›¾
            updateChargingChart(data.deviceChargingCount);
            // ä½©æˆ´çŠ¶æ€é¥¼å›¾
            updateWearableChart(data.deviceWearableCount);
            // ç”µæ± åˆ†å¸ƒæŸ±çŠ¶å›¾
            updateBatteryChart(data.batteryDistribution);
            // ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒ
            updateSystemVersionChart(data.deviceSystemVersionCount);
            // ç”µæ± è¶‹åŠ¿åˆ†æ
            updateBatteryTrendChart(data.batteryAnalysis);
        }

        function updateDepartmentChart(data) {
            const chart = chartInstances.get('departmentChart');
            chart.setOption({
                title: { 
                    text: 'éƒ¨é—¨è®¾å¤‡åˆ†å¸ƒ', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    textStyle: { color: '#fff' }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '50%'],
                    data: Object.entries(data).map(([name, value]) => ({ name, value })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    label: {
                        formatter: '{b}: {c}å°'
                    }
                }]
            });
        }

        function updateStatusChart(data) {
            const chart = chartInstances.get('statusChart');
            chart.setOption({
                title: { 
                    text: 'è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'axis',
                    formatter: '{b}: {c}å°'
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '20%'
                },
                xAxis: { 
                    type: 'category', 
                    data: ['åœ¨çº¿', 'ç¦»çº¿'],
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } },
                    splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                },
                series: [{
                    type: 'bar',
                    data: [
                        {
                            value: data.ACTIVE || 0,
                            itemStyle: { 
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#52c41a'},
                                    {offset: 1, color: '#73d13d'}
                                ])
                            }
                        },
                        {
                            value: data.INACTIVE || 0,
                            itemStyle: { 
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#f5222d'},
                                    {offset: 1, color: '#ff4d4f'}
                                ])
                            }
                        }
                    ],
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å°',
                        color: '#fff'
                    },
                    barWidth: '50%'
                }]
            });
        }

        function updateChargingChart(data) {
            const chart = chartInstances.get('chargingChart');
            chart.setOption({
                title: { 
                    text: 'å……ç”µçŠ¶æ€åˆ†å¸ƒ', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: [
                        {
                            name: 'å……ç”µä¸­',
                            value: data.CHARGING || 0,
                            itemStyle: { color: '#2196f3' }
                        },
                        {
                            name: 'æœªå……ç”µ',
                            value: data.NOT_CHARGING || 0,
                            itemStyle: { color: '#fa8c16' }
                        }
                    ],
                    label: {
                        formatter: '{b}: {c}å°',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateWearableChart(data) {
            const chart = chartInstances.get('wearableChart');
            chart.setOption({
                title: { 
                    text: 'ä½©æˆ´çŠ¶æ€åˆ†å¸ƒ', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}å° ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        {
                            name: 'å·²ä½©æˆ´',
                            value: data.WORN || 0,
                            itemStyle: { color: '#52c41a' }
                        },
                        {
                            name: 'æœªä½©æˆ´',
                            value: data.NOT_WORN || 0,
                            itemStyle: { color: '#f5222d' }
                        }
                    ],
                    label: {
                        formatter: '{b}: {c}å°',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateBatteryChart(data) {
            const chart = chartInstances.get('batteryChart');
            chart.setOption({
                title: { 
                    text: 'ç”µæ± ç”µé‡åˆ†å¸ƒ', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'axis',
                    formatter: '{b}: {c}å°'
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '20%'
                },
                xAxis: { 
                    type: 'category', 
                    data: ['0-20%', '21-70%', '71-100%'],
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } },
                    splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                },
                series: [{
                    type: 'bar',
                    data: [
                        {
                            value: data['low'] || 0,
                            itemStyle: { color: '#f5222d' }
                        },
                        {
                            value: data['medium'] || 0,
                            itemStyle: { color: '#fa8c16' }
                        },
                        {
                            value: data['high'] || 0,
                            itemStyle: { color: '#52c41a' }
                        }
                    ],
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å°',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateSystemVersionChart(data) {
            const chart = chartInstances.get('systemVersionChart');
            const versions = Object.entries(data).map(([version, count]) => ({
                name: version.substring(0, 20) + (version.length > 20 ? '...' : ''),
                fullVersion: version,
                value: count
            }));

            chart.setOption({
                title: { 
                    text: 'ç³»ç»Ÿç‰ˆæœ¬åˆ†å¸ƒ', 
                    textStyle: { color: '#00e4ff', fontSize: 16 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `${data.data.fullVersion}<br/>æ•°é‡ï¼š${data.data.value}å°`;
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '25%',
                    top: '20%'
                },
                xAxis: {
                    type: 'category',
                    data: versions.map(v => v.name),
                    axisLabel: {
                        color: '#fff',
                        rotate: 45,
                        interval: 0
                    },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff' },
                    axisLine: { lineStyle: { color: '#00e4ff' } },
                    splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                },
                series: [{
                    type: 'bar',
                    data: versions.map((v, index) => ({
                        value: v.value,
                        fullVersion: v.fullVersion,
                        itemStyle: {
                            color: `hsl(${(index * 360 / versions.length)}, 70%, 60%)`
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}å°',
                        color: '#fff'
                    }
                }]
            });
        }

        function updateBatteryTrendChart(batteryAnalysis) {
            const chart = chartInstances.get('batteryTrendChart');
            
            if (!batteryAnalysis || Object.keys(batteryAnalysis).length === 0) {
                chart.setOption({
                    title: { 
                        text: 'ç”µæ± è¶‹åŠ¿åˆ†æ', 
                        textStyle: { color: '#00e4ff', fontSize: 18 },
                        left: 'center'
                    },
                    graphic: {
                        type: 'text',
                        left: 'center',
                        top: 'middle',
                        style: {
                            text: 'æš‚æ— ç”µæ± åˆ†ææ•°æ®',
                            fontSize: 16,
                            fill: '#fff'
                        }
                    }
                });
                return;
            }

            const devices = Object.keys(batteryAnalysis);
            const consumptionRates = devices.map(sn => batteryAnalysis[sn].consumption_rate || 0);
            const remainingHours = devices.map(sn => batteryAnalysis[sn].hours_remaining || 0);

            chart.setOption({
                title: { 
                    text: 'ç”µæ± æ¶ˆè€—ç‡ä¸å‰©ä½™æ—¶é—´åˆ†æ', 
                    textStyle: { color: '#00e4ff', fontSize: 18 },
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let html = `è®¾å¤‡: ${devices[params[0].dataIndex]}<br/>`;
                        params.forEach(param => {
                            html += `${param.seriesName}: ${param.value}${param.seriesName.includes('æ¶ˆè€—ç‡') ? '%/h' : 'h'}<br/>`;
                        });
                        return html;
                    }
                },
                legend: {
                    data: ['ç”µæ± æ¶ˆè€—ç‡(%/h)', 'å‰©ä½™æ—¶é—´(h)'],
                    textStyle: { color: '#fff' },
                    top: '8%'
                },
                grid: {
                    left: '8%',
                    right: '8%',
                    bottom: '15%',
                    top: '18%'
                },
                xAxis: {
                    type: 'category',
                    data: devices.map(sn => sn.substring(sn.length - 6)),
                    axisLabel: { 
                        color: '#fff',
                        rotate: 45
                    },
                    axisLine: { lineStyle: { color: '#00e4ff' } }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'æ¶ˆè€—ç‡(%/h)',
                        position: 'left',
                        axisLabel: { color: '#fff' },
                        axisLine: { lineStyle: { color: '#00e4ff' } },
                        splitLine: { lineStyle: { color: 'rgba(0, 228, 255, 0.2)' } }
                    },
                    {
                        type: 'value',
                        name: 'æ—¶é—´(h)',
                        position: 'right',
                        axisLabel: { color: '#fff' },
                        axisLine: { lineStyle: { color: '#fa8c16' } }
                    }
                ],
                series: [
                    {
                        name: 'ç”µæ± æ¶ˆè€—ç‡(%/h)',
                        type: 'bar',
                        yAxisIndex: 0,
                        data: consumptionRates,
                        itemStyle: { color: '#00e4ff' }
                    },
                    {
                        name: 'å‰©ä½™æ—¶é—´(h)',
                        type: 'line',
                        yAxisIndex: 1,
                        data: remainingHours,
                        itemStyle: { color: '#fa8c16' }
                    }
                ]
            });
        }

        function filterDevices(devices) {
            const statusFilter = document.getElementById('filterStatus')?.value;
            const chargingFilter = document.getElementById('filterCharging')?.value;
            const wearableFilter = document.getElementById('filterWearable')?.value;
            const batteryFilter = document.getElementById('filterBattery')?.value;

            return devices.filter(device => {
                const matchStatus = !statusFilter || device.status === statusFilter;
                const matchCharging = !chargingFilter || device.charging_status === chargingFilter;
                const matchWearable = !wearableFilter || device.wearable_status === wearableFilter;
                
                let matchBattery = true;
                if (batteryFilter) {
                    const battery = parseInt(device.battery_level) || 0;
                    switch(batteryFilter) {
                        case 'low':
                            matchBattery = battery <= 20;
                            break;
                        case 'medium':
                            matchBattery = battery > 20 && battery <= 70;
                            break;
                        case 'high':
                            matchBattery = battery > 70;
                            break;
                    }
                }
                
                return matchStatus && matchCharging && matchWearable && matchBattery;
            });
        }

        function aggregateData(devices) {
            const aggregated = {
                departmentDeviceCount: {},
                deviceStatusCount: {},
                deviceChargingCount: {},
                deviceWearableCount: {},
                deviceSystemVersionCount: {},
                batteryDistribution: { low: 0, medium: 0, high: 0 }
            };

            devices.forEach(device => {
                // éƒ¨é—¨ç»Ÿè®¡
                const dept = device.department_name || 'æœªçŸ¥éƒ¨é—¨';
                aggregated.departmentDeviceCount[dept] = (aggregated.departmentDeviceCount[dept] || 0) + 1;

                // çŠ¶æ€ç»Ÿè®¡
                aggregated.deviceStatusCount[device.status] = (aggregated.deviceStatusCount[device.status] || 0) + 1;
                aggregated.deviceChargingCount[device.charging_status] = (aggregated.deviceChargingCount[device.charging_status] || 0) + 1;
                aggregated.deviceWearableCount[device.wearable_status] = (aggregated.deviceWearableCount[device.wearable_status] || 0) + 1;

                // ç³»ç»Ÿç‰ˆæœ¬ç»Ÿè®¡
                const version = device.system_software_version || 'æœªçŸ¥ç‰ˆæœ¬';
                aggregated.deviceSystemVersionCount[version] = (aggregated.deviceSystemVersionCount[version] || 0) + 1;

                // ç”µæ± åˆ†å¸ƒ
                const battery = parseInt(device.battery_level) || 0;
                if (battery <= 20) aggregated.batteryDistribution.low++;
                else if (battery <= 70) aggregated.batteryDistribution.medium++;
                else aggregated.batteryDistribution.high++;
            });

            return aggregated;
        }

        function resetFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCharging').value = '';
            document.getElementById('filterWearable').value = '';
            document.getElementById('filterBattery').value = '';
            updateDashboard();
        }

        async function updateDashboard() {
            const data = await fetchDeviceInfo();
            if (data && data.devices) {
                originalDeviceData = data;
                const filtered = filterDevices(data.devices);
                currentFilteredData = filtered;
                
                displayDeviceTable(filtered);
                const aggregated = aggregateData(filtered);
                aggregated.batteryAnalysis = data.historyAnalysis?.battery_analysis || {};
                updateCharts(aggregated);
            }
        }

        function initCharts() {
            const chartIds = [
                'departmentChart', 'statusChart', 'chargingChart',
                'wearableChart', 'batteryChart', 'systemVersionChart', 'batteryTrendChart'
            ];
            
            chartIds.forEach(id => {
                chartInstances.set(id, echarts.init(document.getElementById(id)));
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function initDashboard() {
            initCharts();
            await updateDashboard();
            
            // è‡ªåŠ¨åˆ·æ–°
            setInterval(updateDashboard, 30000);

            // çª—å£è°ƒæ•´æ—¶é‡æ–°æ¸²æŸ“å›¾è¡¨
            window.addEventListener('resize', debounce(() => {
                chartInstances.forEach(chart => chart.resize());
            }, 250));
            
            // é»˜è®¤å±•å¼€è¿‡æ»¤å™¨é¢æ¿
            togglePanel('filterPanel');
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html> 