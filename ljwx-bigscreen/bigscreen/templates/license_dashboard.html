<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License ç®¡ç†ä»ªè¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem; 
        }
        .header { 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white; 
            padding: 2rem; 
            margin-bottom: 2rem;
            border-radius: 15px;
            text-align: center;
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 2rem; 
            margin-bottom: 2rem;
        }
        .card { 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px; 
            padding: 2rem; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card h3 { 
            color: #2c3e50; 
            margin-bottom: 1.5rem; 
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 8px; 
        }
        .status-valid { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        .metric-value { 
            font-size: 2.5rem; 
            font-weight: bold; 
            margin-bottom: 0.5rem;
        }
        .metric-label { 
            color: #7f8c8d; 
            font-size: 1rem; 
        }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background: #ecf0f1; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 1rem 0;
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3498db, #2980b9); 
            transition: width 0.5s ease; 
        }
        .device-list { 
            max-height: 200px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 1rem; 
            margin-top: 1rem;
        }
        .device-item { 
            padding: 0.5rem; 
            margin: 0.25rem 0; 
            background: white; 
            border-radius: 5px; 
            font-size: 0.9rem;
        }
        .alert { 
            padding: 1rem; 
            margin: 1rem 0; 
            border-radius: 8px; 
            border-left: 4px solid;
        }
        .alert-success { 
            background: #d4edda; 
            color: #155724; 
            border-color: #27ae60; 
        }
        .alert-warning { 
            background: #fff3cd; 
            color: #856404; 
            border-color: #f39c12; 
        }
        .alert-error { 
            background: #f8d7da; 
            color: #721c24; 
            border-color: #e74c3c; 
        }
        .chart-container { 
            height: 300px; 
            margin-top: 1rem; 
        }
        .refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .license-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .license-info-table th,
        .license-info-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .license-info-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” License ç®¡ç†ä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ç›‘æ§LicenseçŠ¶æ€ã€è®¾å¤‡ä½¿ç”¨é‡å’Œå¹¶å‘é™åˆ¶</p>
            <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>

        <div class="grid">
            <!-- LicenseçŠ¶æ€å¡ç‰‡ -->
            <div class="card">
                <h3>ğŸ“‹ License çŠ¶æ€</h3>
                <div id="license-status">
                    <div class="alert alert-warning">
                        <span class="status-indicator status-warning"></span>
                        æ­£åœ¨åŠ è½½LicenseçŠ¶æ€...
                    </div>
                </div>
            </div>

            <!-- è®¾å¤‡ä½¿ç”¨æƒ…å†µ -->
            <div class="card">
                <h3>ğŸ“± è®¾å¤‡ä½¿ç”¨æƒ…å†µ</h3>
                <div id="device-usage">
                    <div class="metric-value" id="device-count">--</div>
                    <div class="metric-label">å½“å‰åœ¨çº¿è®¾å¤‡æ•°</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="device-progress" style="width: 0%;"></div>
                    </div>
                    <div class="metric-label">
                        <span id="device-used">0</span> / <span id="device-max">0</span> 
                        (<span id="device-percentage">0%</span>)
                    </div>
                </div>
                <div class="device-list" id="device-list">
                    <div>æš‚æ— åœ¨çº¿è®¾å¤‡</div>
                </div>
            </div>

            <!-- å¹¶å‘ä½¿ç”¨æƒ…å†µ -->
            <div class="card">
                <h3>âš¡ å¹¶å‘ä½¿ç”¨æƒ…å†µ</h3>
                <div id="concurrent-usage">
                    <div class="metric-value" id="concurrent-count">--</div>
                    <div class="metric-label">å½“å‰å¹¶å‘è¯·æ±‚æ•°</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="concurrent-progress" style="width: 0%;"></div>
                    </div>
                    <div class="metric-label">
                        <span id="concurrent-used">0</span> / <span id="concurrent-max">0</span> 
                        (<span id="concurrent-percentage">0%</span>)
                    </div>
                </div>
            </div>

            <!-- Licenseè¯¦ç»†ä¿¡æ¯ -->
            <div class="card">
                <h3>â„¹ï¸ License è¯¦ç»†ä¿¡æ¯</h3>
                <table class="license-info-table" id="license-info-table">
                    <tbody>
                        <tr><td colspan="2">æ­£åœ¨åŠ è½½Licenseä¿¡æ¯...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨ -->
        <div class="card">
            <h3>ğŸ“Š ä½¿ç”¨è¶‹åŠ¿</h3>
            <div class="chart-container">
                <div id="usage-chart" style="height: 100%;"></div>
            </div>
        </div>

        <!-- è­¦å‘Šä¿¡æ¯ -->
        <div id="alerts-container">
            <!-- åŠ¨æ€åŠ è½½è­¦å‘Šä¿¡æ¯ -->
        </div>
    </div>

    <script>
        let usageChart = null;
        let refreshInterval = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadData();
            startAutoRefresh();
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            usageChart = echarts.init(document.getElementById('usage-chart'));
            
            // å“åº”å¼å¤„ç†
            window.addEventListener('resize', function() {
                usageChart.resize();
            });
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½Licenseæ•°æ®...');
                const response = await fetch('/api/license/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    updateUI(data.data);
                } else {
                    showAlert('åŠ è½½æ•°æ®å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showAlert('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°UI
        function updateUI(data) {
            console.log('æ›´æ–°UIæ•°æ®:', data);
            
            // æ›´æ–°LicenseçŠ¶æ€
            updateLicenseStatus(data.license_status);
            
            // æ›´æ–°è®¾å¤‡ä½¿ç”¨æƒ…å†µ
            updateDeviceUsage(data.license_status.device_limits);
            
            // æ›´æ–°å¹¶å‘ä½¿ç”¨æƒ…å†µ
            updateConcurrentUsage(data.license_status.concurrent_limits);
            
            // æ›´æ–°Licenseè¯¦ç»†ä¿¡æ¯
            updateLicenseInfo(data.license_status.license_info);
            
            // æ›´æ–°ä½¿ç”¨ç‡å›¾è¡¨
            updateUsageChart(data.usage_rates);
            
            // æ›´æ–°å¥åº·çŠ¶æ€å’Œè­¦å‘Š
            updateHealthStatus(data.health_status);
        }

        // æ›´æ–°LicenseçŠ¶æ€
        function updateLicenseStatus(licenseStatus) {
            const container = document.getElementById('license-status');
            const isValid = licenseStatus.license_valid;
            
            let statusClass = isValid ? 'alert-success' : 'alert-error';
            let statusIndicator = isValid ? 'status-valid' : 'status-error';
            let statusText = isValid ? 'Licenseæœ‰æ•ˆ' : 'Licenseæ— æ•ˆæˆ–å·²è¿‡æœŸ';
            
            container.innerHTML = `
                <div class="alert ${statusClass}">
                    <span class="status-indicator ${statusIndicator}"></span>
                    ${statusText}
                </div>
            `;
        }

        // æ›´æ–°è®¾å¤‡ä½¿ç”¨æƒ…å†µ
        function updateDeviceUsage(deviceLimits) {
            const maxDevices = deviceLimits.max_devices || 0;
            const currentDevices = deviceLimits.current_devices || 0;
            const percentage = maxDevices > 0 ? (currentDevices / maxDevices * 100) : 0;
            
            document.getElementById('device-count').textContent = currentDevices;
            document.getElementById('device-used').textContent = currentDevices;
            document.getElementById('device-max').textContent = maxDevices;
            document.getElementById('device-percentage').textContent = percentage.toFixed(1) + '%';
            document.getElementById('device-progress').style.width = percentage + '%';
            
            // æ›´æ–°è®¾å¤‡åˆ—è¡¨
            const deviceList = document.getElementById('device-list');
            const activeDevices = deviceLimits.active_devices || [];
            
            if (activeDevices.length > 0) {
                deviceList.innerHTML = activeDevices.map(device => 
                    `<div class="device-item">ğŸ“± ${device}</div>`
                ).join('');
            } else {
                deviceList.innerHTML = '<div>æš‚æ— åœ¨çº¿è®¾å¤‡</div>';
            }
        }

        // æ›´æ–°å¹¶å‘ä½¿ç”¨æƒ…å†µ
        function updateConcurrentUsage(concurrentLimits) {
            const maxConcurrent = concurrentLimits.max_concurrent || 0;
            const currentConcurrent = concurrentLimits.current_concurrent || 0;
            const percentage = maxConcurrent > 0 ? (currentConcurrent / maxConcurrent * 100) : 0;
            
            document.getElementById('concurrent-count').textContent = currentConcurrent;
            document.getElementById('concurrent-used').textContent = currentConcurrent;
            document.getElementById('concurrent-max').textContent = maxConcurrent;
            document.getElementById('concurrent-percentage').textContent = percentage.toFixed(1) + '%';
            document.getElementById('concurrent-progress').style.width = percentage + '%';
        }

        // æ›´æ–°Licenseè¯¦ç»†ä¿¡æ¯
        function updateLicenseInfo(licenseInfo) {
            const table = document.getElementById('license-info-table');
            
            if (!licenseInfo) {
                table.innerHTML = '<tbody><tr><td colspan="2">æ— Licenseä¿¡æ¯</td></tr></tbody>';
                return;
            }
            
            const rows = [
                ['è®¸å¯è¯ID', licenseInfo.licenseId || '--'],
                ['å®¢æˆ·åç§°', licenseInfo.customerName || '--'],
                ['è®¸å¯è¯ç±»å‹', licenseInfo.licenseType || '--'],
                ['æœ€å¤§è®¾å¤‡æ•°', licenseInfo.maxDevices || '--'],
                ['æœ€å¤§ç”¨æˆ·æ•°', licenseInfo.maxUsers || '--'],
                ['ç”Ÿæ•ˆæ—¥æœŸ', licenseInfo.startDate ? new Date(licenseInfo.startDate).toLocaleDateString() : '--'],
                ['è¿‡æœŸæ—¥æœŸ', licenseInfo.endDate ? new Date(licenseInfo.endDate).toLocaleDateString() : '--'],
                ['å‰©ä½™å¤©æ•°', licenseInfo.getRemainingDays ? licenseInfo.getRemainingDays() + 'å¤©' : '--'],
                ['åŠŸèƒ½åˆ—è¡¨', licenseInfo.features ? licenseInfo.features.join(', ') : '--']
            ];
            
            table.innerHTML = '<tbody>' + rows.map(([key, value]) => 
                `<tr><th>${key}</th><td>${value}</td></tr>`
            ).join('') + '</tbody>';
        }

        // æ›´æ–°ä½¿ç”¨ç‡å›¾è¡¨
        function updateUsageChart(usageRates) {
            const option = {
                title: {
                    text: 'Licenseä½¿ç”¨ç‡',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c}%'
                },
                series: [{
                    name: 'ä½¿ç”¨ç‡',
                    type: 'pie',
                    radius: '60%',
                    data: [
                        {
                            value: usageRates.device_usage_rate || 0,
                            name: 'è®¾å¤‡ä½¿ç”¨ç‡',
                            itemStyle: { color: '#3498db' }
                        },
                        {
                            value: usageRates.concurrent_usage_rate || 0,
                            name: 'å¹¶å‘ä½¿ç”¨ç‡',
                            itemStyle: { color: '#2ecc71' }
                        }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            usageChart.setOption(option);
        }

        // æ›´æ–°å¥åº·çŠ¶æ€å’Œè­¦å‘Š
        function updateHealthStatus(healthStatus) {
            const alertsContainer = document.getElementById('alerts-container');
            
            if (healthStatus.alerts && healthStatus.alerts.length > 0) {
                const alertsHtml = healthStatus.alerts.map(alert => {
                    const alertClass = alert.level === 'error' ? 'alert-error' : 
                                     alert.level === 'warning' ? 'alert-warning' : 'alert-success';
                    return `<div class="alert ${alertClass}">${alert.message}</div>`;
                }).join('');
                
                alertsContainer.innerHTML = alertsHtml;
            } else {
                alertsContainer.innerHTML = '';
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertClass = `alert-${type}`;
            const alertHtml = `<div class="alert ${alertClass}">${message}</div>`;
            
            const container = document.getElementById('alerts-container');
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                const alerts = container.querySelectorAll('.alert');
                if (alerts.length > 0) {
                    alerts[alerts.length - 1].remove();
                }
            }, 3000);
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            console.log('æ‰‹åŠ¨åˆ·æ–°æ•°æ®');
            loadData();
        }

        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
            refreshInterval = setInterval(loadData, 30000);
            console.log('è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”30ç§’');
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>