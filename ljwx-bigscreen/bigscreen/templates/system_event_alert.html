<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿäº‹ä»¶å‘Šè­¦ç®¡ç† - LJWXä¼ä¸šå¤§å±</title>
    <link href="/static/css/bootstrap-5.1.3.min.css" rel="stylesheet">
    <link href="/static/css/font-awesome-4.7.0.min.css" rel="stylesheet">
    <style>
        .alert-container {
            background: linear-gradient(135deg, #0a1828 0%, #1e3a5f 100%);
            min-height: 100vh;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .alert-header {
            background: rgba(0, 228, 255, 0.1);
            border-bottom: 2px solid #00e4ff;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .alert-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alert-card {
            background: linear-gradient(145deg, rgba(15, 30, 58, 0.8), rgba(25, 45, 78, 0.6));
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .alert-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 228, 255, 0.2);
            border-color: #00e4ff;
        }

        .alert-card h3 {
            color: #00e4ff;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 228, 255, 0.5);
        }

        .nav-tabs {
            border-bottom: 2px solid rgba(0, 228, 255, 0.3);
            background: rgba(10, 20, 35, 0.8);
            border-radius: 8px 8px 0 0;
        }

        .nav-tabs .nav-link {
            color: #a0c4ff;
            border: none;
            padding: 15px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: #00e4ff;
            background: rgba(0, 228, 255, 0.1);
        }

        .nav-tabs .nav-link.active {
            color: #00e4ff;
            background: rgba(0, 228, 255, 0.15);
            border-bottom: 3px solid #00e4ff;
        }

        .card {
            background: linear-gradient(145deg, rgba(15, 30, 58, 0.9), rgba(25, 45, 78, 0.7));
            border: 1px solid rgba(0, 228, 255, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(15px);
        }

        .card-header {
            background: rgba(0, 228, 255, 0.1);
            border-bottom: 1px solid rgba(0, 228, 255, 0.3);
            color: #00e4ff;
            font-weight: 600;
        }

        .table-dark {
            background: linear-gradient(145deg, #1a2332, #243447);
            color: #e8f4fd;
        }

        .table-hover tbody tr:hover {
            background: rgba(0, 228, 255, 0.1);
            color: #ffffff;
        }

        .btn-primary {
            background: linear-gradient(145deg, #0066cc, #0052a3);
            border: 1px solid #00e4ff;
            color: #ffffff;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #0052a3, #003d7a);
            box-shadow: 0 4px 15px rgba(0, 228, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            border: 1px solid #20c997;
        }

        .btn-warning {
            background: linear-gradient(145deg, #ffc107, #e0a800);
            border: 1px solid #ffca2c;
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #c82333);
            border: 1px solid #f5c6cb;
        }

        .config-panel {
            background: linear-gradient(145deg, rgba(20, 35, 55, 0.8), rgba(30, 50, 75, 0.6));
            border: 1px solid rgba(0, 228, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .config-panel h5 {
            color: #00e4ff;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-control, .form-select {
            background: rgba(25, 45, 78, 0.7);
            border: 1px solid rgba(0, 228, 255, 0.3);
            color: #ffffff;
        }

        .form-control:focus, .form-select:focus {
            background: rgba(25, 45, 78, 0.9);
            border-color: #00e4ff;
            box-shadow: 0 0 0 0.2rem rgba(0, 228, 255, 0.25);
            color: #ffffff;
        }

        .badge {
            font-size: 0.75rem;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .real-time-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stat-item {
            padding: 15px;
            background: rgba(0, 228, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 228, 255, 0.2);
        }

        .stat-item h4 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-item small {
            color: #a0c4ff;
            font-size: 0.85rem;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .alert-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="alert-container">
    <div class="container-fluid">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="alert-header text-center">
            <h1 class="display-4 mb-0">
                <i class="fa fa-shield"></i> ä¼ä¸šçº§ç³»ç»Ÿäº‹ä»¶å‘Šè­¦ä¸­å¿ƒ
            </h1>
            <p class="lead mt-2">å®æ—¶ç›‘æ§ â€¢ æ™ºèƒ½å‘Šè­¦ â€¢ ä¸“ä¸šç®¡ç†</p>
        </div>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="alert-stats" id="statsOverview">
            <div class="alert-card text-center p-4">
                <h3 id="totalEvents" class="mb-1">0</h3>
                <p class="mb-0">ä»Šæ—¥äº‹ä»¶æ€»æ•°</p>
            </div>
            <div class="alert-card text-center p-4">
                <h3 id="emergencyEvents" class="mb-1">0</h3>
                <p class="mb-0">ç´§æ€¥äº‹ä»¶</p>
            </div>
            <div class="alert-card text-center p-4">
                <h3 id="queuePending" class="mb-1">0</h3>
                <p class="mb-0">é˜Ÿåˆ—å¾…å¤„ç†</p>
            </div>
            <div class="alert-card text-center p-4">
                <h3 id="responseRate" class="mb-1">0%</h3>
                <p class="mb-0">å“åº”æˆåŠŸç‡</p>
            </div>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <ul class="nav nav-tabs" id="alertTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link" id="rules-tab" data-bs-toggle="tab" href="#rules" role="tab">
                    <i class="fa fa-cogs"></i> è§„åˆ™ç®¡ç†
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="queue-tab" data-bs-toggle="tab" href="#queue" role="tab">
                    <i class="fa fa-list-alt"></i> å¤„ç†é˜Ÿåˆ—
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="logs-tab" data-bs-toggle="tab" href="#logs" role="tab">
                    <i class="fa fa-file-text-o"></i> å¤„ç†æ—¥å¿—
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="wechat-tab" data-bs-toggle="tab" href="#wechat" role="tab">
                    <i class="fa fa-bell"></i> å‘Šè­¦é€šçŸ¥é…ç½®
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="test-tab" data-bs-toggle="tab" href="#test" role="tab">
                    <i class="fa fa-flask"></i> æµ‹è¯•ä¸­å¿ƒ
                </a>
            </li>
        </ul>

        <!-- æ ‡ç­¾å†…å®¹ -->
        <div class="tab-content" id="alertTabsContent">
            <!-- äº‹ä»¶è§„åˆ™ç®¡ç† -->
            <div class="tab-pane fade show active" id="rules" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ç³»ç»Ÿäº‹ä»¶è§„åˆ™é…ç½®</h5>
                        <button class="btn btn-primary btn-sm" onclick="addRule()">
                            <i class="fa fa-plus"></i> æ–°å¢è§„åˆ™
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="rulesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>è§„åˆ™ç±»å‹</th>
                                        <th>å®Œæ•´äº‹ä»¶ç±»å‹</th>
                                        <th>å‘Šè­¦çº§åˆ«</th>
                                        <th>é€šçŸ¥æ–¹å¼</th>
                                        <th>å‘Šè­¦æ¶ˆæ¯</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="rulesTableBody">
                                    <!-- åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤„ç†é˜Ÿåˆ—ç›‘æ§ -->
            <div class="tab-pane fade" id="queue" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span class="real-time-indicator">ğŸ”´</span> å®æ—¶å¤„ç†é˜Ÿåˆ—
                        </h5>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="restartProcessor()">
                                <i class="fa fa-refresh"></i> é‡å¯å¤„ç†å™¨
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="retryAllFailed()">
                                <i class="fa fa-redo"></i> é‡è¯•å¤±è´¥
                            </button>
                            <button class="btn btn-info btn-sm" onclick="refreshQueue()">
                                <i class="fa fa-sync"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="queueTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>äº‹ä»¶ç±»å‹</th>
                                        <th>è®¾å¤‡SN</th>
                                        <th>äº‹ä»¶å€¼</th>
                                        <th>å¤„ç†çŠ¶æ€</th>
                                        <th>é‡è¯•æ¬¡æ•°</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="queueTableBody">
                                    <!-- åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤„ç†æ—¥å¿—ç›‘æ§ -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fa fa-file-text-o"></i> ç³»ç»Ÿäº‹ä»¶å¤„ç†æ—¥å¿—
                        </h5>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="refreshLogs()">
                                <i class="fa fa-sync"></i> åˆ·æ–°æ—¥å¿—
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="exportLogs()">
                                <i class="fa fa-download"></i> å¯¼å‡ºæ—¥å¿—
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ—¥å¿—ç»Ÿè®¡é¢æ¿ -->
                    <div class="card-body border-bottom">
                        <div class="row" id="logStatsPanel">
                            <div class="col-md-3">
                                <div class="stat-item text-center">
                                    <h4 id="logTotalCount" class="text-primary">0</h4>
                                    <small>24å°æ—¶æ€»å¤„ç†</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item text-center">
                                    <h4 id="logSuccessCount" class="text-success">0</h4>
                                    <small>å¤„ç†æˆåŠŸ</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item text-center">
                                    <h4 id="logFailedCount" class="text-danger">0</h4>
                                    <small>å¤„ç†å¤±è´¥</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item text-center">
                                    <h4 id="logAvgDuration" class="text-info">0ms</h4>
                                    <small>å¹³å‡è€—æ—¶</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¿‡æ»¤å™¨ -->
                    <div class="card-body border-bottom">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" id="logDeviceFilter" placeholder="è®¾å¤‡SNç­›é€‰">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="logStatusFilter">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="processing">å¤„ç†ä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                    <option value="failed">å¤±è´¥</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" id="logEventTypeFilter" placeholder="äº‹ä»¶ç±»å‹ç­›é€‰">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary btn-sm" onclick="filterLogs()">
                                    <i class="fa fa-filter"></i> ç­›é€‰
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="clearLogFilters()">
                                    <i class="fa fa-times"></i> æ¸…é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ—¥å¿—è¡¨æ ¼ -->
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="logsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>è®¾å¤‡SN</th>
                                        <th>äº‹ä»¶ç±»å‹</th>
                                        <th>å¤„ç†çŠ¶æ€</th>
                                        <th>é€šçŸ¥æ–¹å¼</th>
                                        <th>æ¶ˆæ¯æ•°</th>
                                        <th>å¾®ä¿¡çŠ¶æ€</th>
                                        <th>è€—æ—¶</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <!-- åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- åˆ†é¡µ -->
                        <nav aria-label="æ—¥å¿—åˆ†é¡µ">
                            <ul class="pagination pagination-sm justify-content-center" id="logsPagination">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- å‘Šè­¦é€šçŸ¥é…ç½® -->
            <div class="tab-pane fade" id="wechat" role="tabpanel">
                <div class="d-flex justify-content-end mb-3 mt-3">
                    <button class="btn btn-warning btn-sm" onclick="cleanDuplicateConfigs()">
                        <i class="fa fa-trash"></i> æ¸…ç†é‡å¤é…ç½®
                    </button>
                </div>
                
                <!-- é€šç”¨å‘Šè­¦è®¾ç½® -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="config-panel">
                            <h5><i class="fa fa-bell"></i> é€šç”¨å‘Šè­¦è®¾ç½®</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">æ¶ˆæ¯æ¥æ”¶äººç±»å‹</label>
                                        <select class="form-select" id="messageReceiverType">
                                            <option value="manager">ç›´ç³»ä¸»ç®¡(é»˜è®¤)</option>
                                            <option value="all_managers">æ‰€æœ‰ä¸»ç®¡</option>
                                            <option value="custom">æŒ‡å®šç”¨æˆ·</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6" id="customReceiversDiv" style="display:none;">
                                    <div class="mb-3">
                                        <label class="form-label">æŒ‡å®šæ¥æ”¶äºº(ç”¨æˆ·IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”)</label>
                                        <input type="text" class="form-control" id="customReceivers" placeholder="å¦‚ï¼š1001,1002,1003">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="enableMessageAlert" checked>
                                        <label class="form-check-label">å¯ç”¨å¹³å°æ¶ˆæ¯é€šçŸ¥</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="enableWechatAlert">
                                        <label class="form-check-label">å¯ç”¨å¾®ä¿¡é€šçŸ¥</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="emergencyOnly">
                                        <label class="form-check-label">ä»…ç´§æ€¥äº‹ä»¶æ¨é€å¾®ä¿¡</label>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="saveGeneralAlertConfig()">
                                <i class="fa fa-save"></i> ä¿å­˜é€šç”¨è®¾ç½®
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- å¾®ä¿¡é€šçŸ¥é…ç½® -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-panel">
                            <h5><i class="fa fa-building"></i> ä¼ä¸šå¾®ä¿¡é…ç½®</h5>
                            <form id="enterpriseForm">
                                <div class="mb-3">
                                    <label class="form-label">ä¼ä¸šID (CorpID)</label>
                                    <input type="text" class="form-control" id="corpId" placeholder="wx...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">åº”ç”¨AgentID</label>
                                    <input type="text" class="form-control" id="agentId" placeholder="1000002">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">åº”ç”¨Secret</label>
                                    <input type="password" class="form-control" id="enterpriseSecret" placeholder="åº”ç”¨Secret">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="enterpriseEnabled">
                                    <label class="form-check-label">å¯ç”¨ä¼ä¸šå¾®ä¿¡å‘Šè­¦</label>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveWeChatConfig('enterprise')">
                                    <i class="fa fa-save"></i> ä¿å­˜é…ç½®
                                </button>
                                <button type="button" class="btn btn-success" onclick="testWeChatAlert('enterprise')">
                                    <i class="fa fa-test"></i> æµ‹è¯•å‘Šè­¦
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-panel">
                            <h5><i class="fa fa-wechat"></i> å¾®ä¿¡å…¬ä¼—å·é…ç½®</h5>
                            <form id="officialForm">
                                <div class="mb-3">
                                    <label class="form-label">AppID</label>
                                    <input type="text" class="form-control" id="appId" placeholder="wx...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">AppSecret</label>
                                    <input type="password" class="form-control" id="appSecret" placeholder="AppSecret">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ¨¡æ¿æ¶ˆæ¯ID</label>
                                    <input type="text" class="form-control" id="templateId" placeholder="æ¨¡æ¿ID">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="officialEnabled">
                                    <label class="form-check-label">å¯ç”¨å…¬ä¼—å·å‘Šè­¦</label>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveWeChatConfig('official')">
                                    <i class="fa fa-save"></i> ä¿å­˜é…ç½®
                                </button>
                                <button type="button" class="btn btn-success" onclick="testWeChatAlert('official')">
                                    <i class="fa fa-test"></i> æµ‹è¯•å‘Šè­¦
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•ä¸­å¿ƒ -->
            <div class="tab-pane fade" id="test" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fa fa-flask"></i> ç³»ç»Ÿäº‹ä»¶æ¨¡æ‹Ÿæµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ç´§æ€¥äº‹ä»¶æµ‹è¯•</h6>
                                <div class="btn-group-toggle mb-3">
                                    <button class="btn btn-danger" onclick="testEvent('SOS_EVENT')">SOSç´§æ€¥æ±‚åŠ©</button>
                                    <button class="btn btn-danger" onclick="testEvent('FALLDOWN_EVENT')">è·Œå€’æ£€æµ‹</button>
                                    <button class="btn btn-danger" onclick="testEvent('ONE_KEY_ALARM')">ä¸€é”®æŠ¥è­¦</button>
                                </div>
                                <h6>å¥åº·å‘Šè­¦æµ‹è¯•</h6>
                                <div class="btn-group-toggle mb-3">
                                    <button class="btn btn-warning" onclick="testEvent('HEARTRATE_HIGH_ALERT')">å¿ƒç‡è¿‡é«˜</button>
                                    <button class="btn btn-warning" onclick="testEvent('SPO2_LOW_ALERT')">è¡€æ°§è¿‡ä½</button>
                                    <button class="btn btn-warning" onclick="testEvent('TEMPERATURE_HIGH_ALERT')">ä½“æ¸©è¿‡é«˜</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>ç³»ç»Ÿäº‹ä»¶æµ‹è¯•</h6>
                                <div class="btn-group-toggle mb-3">
                                    <button class="btn btn-info" onclick="testEvent('WEAR_STATUS_CHANGED')">ä½©æˆ´çŠ¶æ€</button>
                                    <button class="btn btn-info" onclick="testEvent('BOOT_COMPLETED')">è®¾å¤‡å¯åŠ¨</button>
                                    <button class="btn btn-info" onclick="testEvent('CALL_STATE')">é€šè¯çŠ¶æ€</button>
                                </div>
                                <h6>è‡ªå®šä¹‰æµ‹è¯•</h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control mb-2" id="customEventType" placeholder="äº‹ä»¶ç±»å‹(å¦‚:SOS_EVENT)">
                                    <input type="text" class="form-control mb-2" id="customDeviceSn" placeholder="è®¾å¤‡SN" value="TEST_DEVICE_001">
                                    <input type="text" class="form-control mb-2" id="customEventValue" placeholder="äº‹ä»¶å€¼">
                                    <button class="btn btn-primary" onclick="testCustomEvent()">å‘é€è‡ªå®šä¹‰äº‹ä»¶</button>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>è¯´æ˜ï¼š</strong>æµ‹è¯•äº‹ä»¶å°†ç›´æ¥è§¦å‘å‘Šè­¦å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬å¾®ä¿¡æ¨é€å’Œæ¶ˆæ¯é€šçŸ¥ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®é…ç½®å¾®ä¿¡å‚æ•°ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="ruleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ruleModalTitle">ç¼–è¾‘è§„åˆ™</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ruleForm">
                        <input type="hidden" id="ruleId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è§„åˆ™ç±»å‹*</label>
                                    <input type="text" class="form-control" id="ruleType" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å‘Šè­¦çº§åˆ«*</label>
                                    <select class="form-select" id="severityLevel" required>
                                        <option value="critical">ä¸¥é‡(Critical)</option>
                                        <option value="high">é«˜(High)</option>
                                        <option value="medium">ä¸­(Medium)</option>
                                        <option value="low">ä½(Low)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å®Œæ•´äº‹ä»¶ç±»å‹*</label>
                            <input type="text" class="form-control" id="eventType" placeholder="å¦‚:com.tdtech.ohos.health.action.SOS_EVENT" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å‘Šè­¦æ¶ˆæ¯æ¨¡æ¿*</label>
                            <textarea class="form-control" id="alertMessage" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">é€šçŸ¥ç±»å‹*</label>
                                    <select class="form-select" id="notificationType" required>
                                        <option value="message">å¹³å°æ¶ˆæ¯</option>
                                        <option value="wechat">å¾®ä¿¡æ¨é€</option>
                                        <option value="both">åŒé‡é€šçŸ¥</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">é‡è¯•æ¬¡æ•°</label>
                                    <input type="number" class="form-control" id="retryCount" value="3" min="0" max="10">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isEmergency">
                            <label class="form-check-label">ç´§æ€¥äº‹ä»¶(ä¼˜å…ˆå¾®ä¿¡æ¨é€)</label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" checked>
                            <label class="form-check-label">å¯ç”¨è§„åˆ™</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveRule()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap-5.1.3.bundle.min.js"></script>
    <script>
        let currentTenantId=1; // å½“å‰ç§Ÿæˆ·ID

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded',function(){
            loadStats();loadRules();loadWeChatConfig();
            setInterval(()=>{loadStats();if(document.querySelector('#queue-tab').classList.contains('active'))loadQueue()},5000); // 5ç§’åˆ·æ–°ç»Ÿè®¡
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats(){
            try{
                const response=await fetch('/api/system-event/queue/stats');
                const data=await response.json();
                if(data.code===200){
                    document.getElementById('totalEvents').textContent=data.data.total_events||0;
                    document.getElementById('emergencyEvents').textContent=data.data.emergency_events||0;
                    document.getElementById('queuePending').textContent=data.data.pending_count||0;
                    document.getElementById('responseRate').textContent=(data.data.success_rate||0)+'%';
                }
            }catch(e){console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:',e)}
        }

        // åŠ è½½äº‹ä»¶è§„åˆ™
        async function loadRules(){
            try{
                const response=await fetch('/api/system-event/rules');
                const data=await response.json();
                if(data.code===200){
                    const tbody=document.getElementById('rulesTableBody');
                    tbody.innerHTML=data.data.map(rule=>`
                        <tr>
                            <td><span class="rule-badge ${rule.severity_level}">${rule.rule_type}</span></td>
                            <td class="text-muted small">${rule.event_type}</td>
                            <td><span class="rule-badge ${rule.severity_level}">${rule.severity_level}</span></td>
                            <td><span class="badge bg-${rule.notification_type==='wechat'?'success':rule.notification_type==='both'?'primary':'secondary'}">${rule.notification_type}</span></td>
                            <td class="text-truncate" style="max-width:200px" title="${rule.alert_message}">${rule.alert_message}</td>
                            <td><span class="badge bg-${rule.is_active?'success':'danger'}">${rule.is_active?'å¯ç”¨':'ç¦ç”¨'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editRule(${rule.id})">ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${rule.id})">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }catch(e){console.error('åŠ è½½è§„åˆ™å¤±è´¥:',e)}
        }

        // åŠ è½½å¤„ç†é˜Ÿåˆ—
        async function loadQueue(){
            try{
                const response=await fetch('/api/system-event/queue/stats?detail=true');
                const data=await response.json();
                if(data.code===200){
                    const tbody=document.getElementById('queueTableBody');
                    tbody.innerHTML=(data.data.queue_items||[]).map(item=>`
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.event_type}</td>
                            <td>${item.device_sn}</td>
                            <td class="text-truncate" style="max-width:150px">${item.event_value||'-'}</td>
                            <td><span class="queue-status ${item.processing_status}"></span>${item.processing_status}</td>
                            <td>${item.retry_count}/3</td>
                            <td>${item.create_time}</td>
                            <td>
                                ${item.processing_status==='failed'?`<button class="btn btn-sm btn-warning" onclick="retryQueueItem(${item.id})">é‡è¯•</button>`:''}
                            </td>
                        </tr>
                    `).join('');
                }
            }catch(e){console.error('åŠ è½½é˜Ÿåˆ—å¤±è´¥:',e)}
        }

        // åŠ è½½å¾®ä¿¡é…ç½®
        async function loadWeChatConfig(){
            try{
                const response=await fetch('/api/wechat-alarm/config');
                const data=await response.json();
                if(data.code===200){
                    data.data.forEach(config=>{
                        if(config.type==='enterprise'){
                            document.getElementById('corpId').value=config.corp_id||'';
                            document.getElementById('agentId').value=config.agent_id||'';
                            document.getElementById('enterpriseSecret').value=config.secret||'';
                            document.getElementById('enterpriseEnabled').checked=config.enabled;
                        }else if(config.type==='official'){
                            document.getElementById('appId').value=config.appid||'';
                            document.getElementById('appSecret').value=config.appsecret||'';
                            document.getElementById('templateId').value=config.template_id||'';
                            document.getElementById('officialEnabled').checked=config.enabled;
                        }
                    });
                }
            }catch(e){console.error('åŠ è½½å¾®ä¿¡é…ç½®å¤±è´¥:',e)}
        }

        // ä¿å­˜å¾®ä¿¡é…ç½®
        async function saveWeChatConfig(type){
            const formData=type==='enterprise'?{
                type,corp_id:document.getElementById('corpId').value,
                agent_id:document.getElementById('agentId').value,
                secret:document.getElementById('enterpriseSecret').value,
                enabled:document.getElementById('enterpriseEnabled').checked
            }:{
                type,appid:document.getElementById('appId').value,
                appsecret:document.getElementById('appSecret').value,
                template_id:document.getElementById('templateId').value,
                enabled:document.getElementById('officialEnabled').checked
            };
            try{
                const response=await fetch('/api/wechat-alarm/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)});
                const data=await response.json();
                showCustomAlert(data.message||'ä¿å­˜æˆåŠŸ', () => loadWeChatConfig());
            }catch(e){showCustomAlert('ä¿å­˜å¤±è´¥:'+e.message)}
        }

        // æµ‹è¯•å¾®ä¿¡å‘Šè­¦
        async function testWeChatAlert(type){
            try{
                const response=await fetch('/api/wechat-alarm/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,message:'ç³»ç»Ÿæµ‹è¯•å‘Šè­¦æ¶ˆæ¯'})});
                const data=await response.json();
                showCustomAlert(data.message||'æµ‹è¯•å®Œæˆ');
            }catch(e){showCustomAlert('æµ‹è¯•å¤±è´¥:'+e.message)}
        }

        // æµ‹è¯•äº‹ä»¶
        async function testEvent(eventType){
            // æ ¹æ®äº‹ä»¶ç±»å‹ç¡®å®šå®Œæ•´çš„äº‹ä»¶è·¯å¾„
            let fullEventType;
            if(eventType.includes('WEAR_STATUS')||eventType.includes('CALL_STATE')||eventType.includes('BOOT_COMPLETED')||eventType.includes('UI_SETTINGS')||eventType.includes('FUN_DOUBLE')||eventType.includes('ONE_KEY')){
                fullEventType=`com.tdtech.ohos.action.${eventType}`;
            }else{
                fullEventType=`com.tdtech.ohos.health.action.${eventType}`;
            }
            
            const testData={
                eventType:fullEventType,
                eventValue:'1',
                deviceSn:'TEST_DEVICE_001',
                heatlhData:JSON.stringify({
                    data:{
                        deviceSn:'TEST_DEVICE_001',
                        heart_rate:eventType==='SOS_EVENT'?150:75,
                        blood_oxygen:eventType.includes('SPO2')?85:98,
                        body_temperature:eventType.includes('TEMPERATURE')?'38.5':'36.5',
                        step:1000,
                        distance:'0.8',
                        calorie:'50.0',
                        latitude:'22.540368',
                        longitude:'114.015090',
                        stress:eventType==='SOS_EVENT'?90:20,
                        blood_pressure_systolic:120,
                        blood_pressure_diastolic:80,
                        upload_method:'test',
                        timestamp:new Date().toISOString().slice(0,19).replace('T',' ')
                    }
                })
            };
            try{
                const response=await fetch('/upload_common_event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(testData)});
                const data=await response.json();
                showCustomAlert(`äº‹ä»¶æµ‹è¯•: ${data.message||'å·²å‘é€'}`, () => setTimeout(loadStats,1000));
            }catch(e){showCustomAlert('æµ‹è¯•å¤±è´¥:'+e.message)}
        }

        // è‡ªå®šä¹‰äº‹ä»¶æµ‹è¯•
        function testCustomEvent(){
            const eventType=document.getElementById('customEventType').value;
            const deviceSn=document.getElementById('customDeviceSn').value;
            const eventValue=document.getElementById('customEventValue').value;
            if(!eventType||!deviceSn)return showCustomAlert('è¯·å¡«å†™äº‹ä»¶ç±»å‹å’Œè®¾å¤‡SN');
            
            const testData={
                eventType:eventType.includes('.')?eventType:`com.tdtech.ohos.health.action.${eventType}`,
                eventValue:eventValue||'1',
                deviceSn:deviceSn,
                heatlhData:JSON.stringify({
                    data:{
                        deviceSn:deviceSn,
                        heart_rate:80,
                        blood_oxygen:97,
                        body_temperature:'36.6',
                        step:500,
                        distance:'0.4',
                        calorie:'25.0',
                        latitude:'22.540368',
                        longitude:'114.015090',
                        upload_method:'custom_test',
                        timestamp:new Date().toISOString().slice(0,19).replace('T',' ')
                    }
                })
            };
            
            fetch('/upload_common_event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(testData)})
            .then(response=>response.json())
            .then(data=>showCustomAlert(`è‡ªå®šä¹‰äº‹ä»¶æµ‹è¯•: ${data.message||'å·²å‘é€'}`, () => setTimeout(loadStats,1000)))
            .catch(e=>showCustomAlert('æµ‹è¯•å¤±è´¥:'+e.message));
            
            setTimeout(loadStats,1000);
        }

        // æ–°å¢è§„åˆ™
        function addRule(){
            document.getElementById('ruleModalTitle').textContent='æ–°å¢äº‹ä»¶è§„åˆ™';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleId').value='';
            new bootstrap.Modal(document.getElementById('ruleModal')).show();
        }

        // ç¼–è¾‘è§„åˆ™
        async function editRule(id){
            try{
                const response=await fetch(`/api/system-event/rules/${id}`);
                const data=await response.json();
                if(data.code===200){
                    const rule=data.data;
                    document.getElementById('ruleModalTitle').textContent='ç¼–è¾‘äº‹ä»¶è§„åˆ™';
                    document.getElementById('ruleId').value=rule.id;
                    document.getElementById('ruleType').value=rule.rule_type;
                    document.getElementById('eventType').value=rule.event_type;
                    document.getElementById('severityLevel').value=rule.severity_level;
                    document.getElementById('alertMessage').value=rule.alert_message;
                    document.getElementById('notificationType').value=rule.notification_type;
                    document.getElementById('retryCount').value=rule.retry_count;
                    document.getElementById('isEmergency').checked=rule.is_emergency;
                    document.getElementById('isActive').checked=rule.is_active;
                    new bootstrap.Modal(document.getElementById('ruleModal')).show();
                }
            }catch(e){showCustomAlert('åŠ è½½è§„åˆ™å¤±è´¥:'+e.message)}
        }

        // ä¿å­˜è§„åˆ™
        async function saveRule(){
            const formData=new FormData(document.getElementById('ruleForm'));
            const data={
                rule_type:document.getElementById('ruleType').value,
                event_type:document.getElementById('eventType').value,
                severity_level:document.getElementById('severityLevel').value,
                alert_message:document.getElementById('alertMessage').value,
                notification_type:document.getElementById('notificationType').value,
                retry_count:parseInt(document.getElementById('retryCount').value),
                is_emergency:document.getElementById('isEmergency').checked,
                is_active:document.getElementById('isActive').checked
            };
            const id=document.getElementById('ruleId').value;
            try{
                const url=id?`/api/system-event/rules/${id}`:'/api/system-event/rules';
                const method=id?'PUT':'POST';
                const response=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                const result=await response.json();
                showCustomAlert(result.message||'ä¿å­˜æˆåŠŸ', () => {
                    bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
                    loadRules();
                });
            }catch(e){showCustomAlert('ä¿å­˜å¤±è´¥:'+e.message)}
        }

        // åˆ é™¤è§„åˆ™
        async function deleteRule(id){
            if(!confirm('ç¡®å®šåˆ é™¤æ­¤è§„åˆ™å—ï¼Ÿ'))return;
            try{
                const response=await fetch(`/api/system-event/rules/${id}`,{method:'DELETE'});
                const data=await response.json();
                showCustomAlert(data.message||'åˆ é™¤æˆåŠŸ', () => loadRules());
            }catch(e){showCustomAlert('åˆ é™¤å¤±è´¥:'+e.message)}
        }

        // é‡å¯å¤„ç†å™¨
        async function restartProcessor(){
            try{
                const response=await fetch('/api/system-event/processor/restart',{method:'POST'});
                const data=await response.json();
                showCustomAlert(data.message||'é‡å¯æˆåŠŸ', () => setTimeout(loadQueue,1000));
            }catch(e){showCustomAlert('é‡å¯å¤±è´¥:'+e.message)}
        }

        // æ¸…ç†é‡å¤é…ç½®
        async function cleanDuplicateConfigs(){
            if(!confirm('ç¡®å®šè¦æ¸…ç†é‡å¤çš„å¾®ä¿¡é…ç½®å—ï¼Ÿè¿™å°†ä¿ç•™æœ€æ–°çš„æœ‰æ•ˆé…ç½®ã€‚'))return;
            try{
                const response=await fetch('/api/wechat-alarm/config/clean',{method:'POST'});
                const data=await response.json();
                showCustomAlert(data.message||'æ¸…ç†æˆåŠŸ', () => loadWeChatConfig());
            }catch(e){showCustomAlert('æ¸…ç†å¤±è´¥:'+e.message)}
        }

        // åˆ·æ–°é˜Ÿåˆ—
        function refreshQueue(){loadQueue()}

        // é‡è¯•é˜Ÿåˆ—é¡¹
        async function retryQueueItem(id){
            try{
                showCustomAlert('æ­£åœ¨é‡è¯•ï¼Œè¯·ç¨å€™...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
                
                const response = await fetch(`/api/system-event/queue/retry/${id}`, {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if(!response.ok) throw new Error(`HTTP ${response.status}`);
                
                let data;
                const text = await response.text();
                if(text.trim()) {
                    try {
                        data = JSON.parse(text);
                    } catch(e) {
                        data = {success:true, message:'é‡è¯•å®Œæˆï¼Œä½†å“åº”æ ¼å¼å¼‚å¸¸'};
                    }
                } else {
                    data = {success:true, message:'é‡è¯•å®Œæˆ'};
                }
                
                showCustomAlert(data.message || 'é‡è¯•æˆåŠŸ', () => loadQueue());
            } catch(e) {
                if (e.name === 'AbortError') {
                    showCustomAlert('é‡è¯•æ“ä½œè¶…æ—¶ï¼Œä½†å¯èƒ½ä»åœ¨åå°å¤„ç†ä¸­', () => loadQueue());
                } else {
                    showCustomAlert('é‡è¯•å¤±è´¥: ' + e.message);
                }
            }
        }

        // é‡è¯•æ‰€æœ‰å¤±è´¥é˜Ÿåˆ—é¡¹
        async function retryAllFailed(){
            if(!confirm('ç¡®å®šè¦é‡è¯•æ‰€æœ‰å¤±è´¥çš„é˜Ÿåˆ—é¡¹å—ï¼Ÿæ­¤æ“ä½œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚')) return;
            
            try{
                showCustomAlert('æ­£åœ¨æ‰¹é‡é‡è¯•ï¼Œè¯·ç¨å€™...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶
                
                const response = await fetch('/api/system-event/queue/retry-all-failed', {
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if(!response.ok) throw new Error(`HTTP ${response.status}`);
                
                let data;
                const text = await response.text();
                if(text.trim()) {
                    try {
                        data = JSON.parse(text);
                    } catch(e) {
                        data = {success:true, message:'æ‰¹é‡é‡è¯•å®Œæˆï¼Œä½†å“åº”æ ¼å¼å¼‚å¸¸'};
                    }
                } else {
                    data = {success:true, message:'æ‰¹é‡é‡è¯•å®Œæˆ'};
                }
                
                showCustomAlert(data.message || 'æ‰¹é‡é‡è¯•æˆåŠŸ', () => loadQueue());
            } catch(e) {
                if (e.name === 'AbortError') {
                    showCustomAlert('æ‰¹é‡é‡è¯•æ“ä½œè¶…æ—¶ï¼Œä½†å¯èƒ½ä»åœ¨åå°å¤„ç†ä¸­', () => loadQueue());
                } else {
                    showCustomAlert('æ‰¹é‡é‡è¯•å¤±è´¥: ' + e.message);
                }
            }
        }

        // ä¼ä¸šçº§å‘Šè­¦å¼¹çª— - ç§‘æŠ€æ„Ÿé£æ ¼
        function showCustomAlert(msg, cb){
            const d=document.createElement('div'),b=document.createElement('button');
            d.style='position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;display:flex;align-items:center;justify-content:center;background:rgba(0,21,41,0.7);backdrop-filter:blur(8px);';
            d.innerHTML=`<div style="background:linear-gradient(145deg,rgba(10,24,48,0.98),rgba(15,30,58,0.95));border-radius:16px;box-shadow:0 0 32px #00e4ff44,inset 0 1px 0 rgba(255,255,255,0.1);padding:40px 48px;min-width:380px;max-width:520px;color:#fff;display:flex;flex-direction:column;align-items:center;border:1px solid rgba(0,228,255,0.3);"><div style="font-size:24px;margin-bottom:32px;text-align:center;line-height:1.4;color:#e8f4fd;">${msg}</div></div>`;
            b.textContent='ç¡®å®š';
            b.style='margin:12px auto 0 auto;padding:12px 36px;font-size:16px;color:#00e4ff;background:rgba(0,228,255,0.1);border:2px solid #00e4ff;border-radius:8px;cursor:pointer;transition:all 0.3s ease;font-weight:600;text-transform:uppercase;letter-spacing:1px;';
            b.onmouseover=()=>b.style.background='rgba(0,228,255,0.2)';
            b.onmouseout=()=>b.style.background='rgba(0,228,255,0.1)';
            b.onclick=()=>{d.style.opacity='0';setTimeout(()=>{d.remove();cb&&cb();},200);};
            d.querySelector('div').appendChild(b);
            document.body.appendChild(d);
            setTimeout(()=>d.style.opacity='1',50);
            d.style.opacity='0';d.style.transition='opacity 0.3s ease';
        }

        // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
        document.getElementById('queue-tab').addEventListener('shown.bs.tab',loadQueue);

        // ä¿å­˜é€šç”¨å‘Šè­¦é…ç½®
        async function saveGeneralAlertConfig(){
            const config = {
                messageReceiverType: document.getElementById('messageReceiverType').value,
                customReceivers: document.getElementById('customReceivers').value,
                enableMessageAlert: document.getElementById('enableMessageAlert').checked,
                enableWechatAlert: document.getElementById('enableWechatAlert').checked,
                emergencyOnly: document.getElementById('emergencyOnly').checked
            };
            
            try{
                const response = await fetch('/api/general-alert-config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                showCustomAlert(data.message || 'ä¿å­˜æˆåŠŸ');
            }catch(e){
                showCustomAlert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åŠ è½½é€šç”¨å‘Šè­¦é…ç½®
        async function loadGeneralAlertConfig(){
            try{
                const response = await fetch('/api/general-alert-config');
                const data = await response.json();
                if(data.code === 200 && data.data){
                    const config = data.data;
                    document.getElementById('messageReceiverType').value = config.messageReceiverType || 'manager';
                    document.getElementById('customReceivers').value = config.customReceivers || '';
                    document.getElementById('enableMessageAlert').checked = config.enableMessageAlert !== false;
                    document.getElementById('enableWechatAlert').checked = config.enableWechatAlert === true;
                    document.getElementById('emergencyOnly').checked = config.emergencyOnly === true;
                    
                    // æ§åˆ¶è‡ªå®šä¹‰æ¥æ”¶äººè¾“å…¥æ¡†æ˜¾ç¤º
                    toggleCustomReceivers();
                }
            }catch(e){
                console.log('åŠ è½½é€šç”¨é…ç½®å¤±è´¥:', e);
            }
        }

        // åˆ‡æ¢è‡ªå®šä¹‰æ¥æ”¶äººè¾“å…¥æ¡†æ˜¾ç¤º
        function toggleCustomReceivers(){
            const type = document.getElementById('messageReceiverType').value;
            const customDiv = document.getElementById('customReceiversDiv');
            customDiv.style.display = type === 'custom' ? 'block' : 'none';
        }

        // ç›‘å¬æ¥æ”¶äººç±»å‹å˜åŒ–
        document.getElementById('messageReceiverType').addEventListener('change', toggleCustomReceivers);
        
        // å¤„ç†æ—¥å¿—ç›¸å…³å‡½æ•°
        let currentLogPage = 1;
        let logFilters = {};
        
        // åŠ è½½å¤„ç†æ—¥å¿—
        async function loadLogs(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: 20,
                    ...logFilters
                });
                
                const response = await fetch(`/api/system-event/process-logs?${params}`);
                const data = await response.json();
                
                if (data.code === 200) {
                    renderLogsTable(data.data.logs);
                    renderLogsPagination(data.data);
                    currentLogPage = page;
                }
            } catch (e) {
                showCustomAlert('åŠ è½½æ—¥å¿—å¤±è´¥: ' + e.message);
            }
        }
        
        // åŠ è½½æ—¥å¿—ç»Ÿè®¡
        async function loadLogStats() {
            try {
                const response = await fetch('/api/system-event/process-logs/stats');
                const data = await response.json();
                
                if (data.code === 200) {
                    const stats = data.data.status_stats;
                    let totalCount = 0, successCount = 0, failedCount = 0, avgDuration = 0;
                    
                    stats.forEach(stat => {
                        totalCount += stat.count;
                        if (stat.status === 'completed') successCount = stat.count;
                        if (stat.status === 'failed') failedCount = stat.count;
                        if (stat.status === 'completed') avgDuration = stat.avg_duration;
                    });
                    
                    document.getElementById('logTotalCount').textContent = totalCount;
                    document.getElementById('logSuccessCount').textContent = successCount;
                    document.getElementById('logFailedCount').textContent = failedCount;
                    document.getElementById('logAvgDuration').textContent = Math.round(avgDuration) + 'ms';
                }
            } catch (e) {
                console.log('åŠ è½½æ—¥å¿—ç»Ÿè®¡å¤±è´¥:', e);
            }
        }
        
        // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
        function renderLogsTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.id}</td>
                    <td><code>${log.device_sn || 'N/A'}</code></td>
                    <td><span class="badge bg-info">${log.event_type}</span></td>
                    <td><span class="badge ${getStatusBadgeClass(log.process_status)}">${getStatusText(log.process_status)}</span></td>
                    <td>${log.notification_type || 'N/A'}</td>
                    <td>${log.message_count || 0}</td>
                    <td><span class="badge ${getWechatStatusClass(log.wechat_status)}">${log.wechat_status || 'N/A'}</span></td>
                    <td>${log.process_duration || 0}ms</td>
                    <td>${log.create_time}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewLogDetails(${log.id})" title="æŸ¥çœ‹è¯¦æƒ…">
                            <i class="fa fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // è·å–çŠ¶æ€å¾½ç« æ ·å¼
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'processing': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'completed': return 'å·²å®Œæˆ';
                case 'failed': return 'å¤±è´¥';
                case 'processing': return 'å¤„ç†ä¸­';
                default: return status;
            }
        }
        
        // è·å–å¾®ä¿¡çŠ¶æ€æ ·å¼
        function getWechatStatusClass(status) {
            switch(status) {
                case 'success': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'skipped': return 'bg-secondary';
                default: return 'bg-light text-dark';
            }
        }
        
        // æ¸²æŸ“åˆ†é¡µ
        function renderLogsPagination(data) {
            const pagination = document.getElementById('logsPagination');
            const { page, pages, total } = data;
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            html += `<li class="page-item ${page <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadLogs(${page - 1})">ä¸Šä¸€é¡µ</a>
            </li>`;
            
            // é¡µç 
            for (let i = Math.max(1, page - 2); i <= Math.min(pages, page + 2); i++) {
                html += `<li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadLogs(${i})">${i}</a>
                </li>`;
            }
            
            // ä¸‹ä¸€é¡µ
            html += `<li class="page-item ${page >= pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadLogs(${page + 1})">ä¸‹ä¸€é¡µ</a>
            </li>`;
            
            pagination.innerHTML = html;
        }
        
        // ç­›é€‰æ—¥å¿—
        function filterLogs() {
            logFilters = {
                device_sn: document.getElementById('logDeviceFilter').value,
                process_status: document.getElementById('logStatusFilter').value,
                event_type: document.getElementById('logEventTypeFilter').value
            };
            
            // ç§»é™¤ç©ºå€¼
            Object.keys(logFilters).forEach(key => {
                if (!logFilters[key]) delete logFilters[key];
            });
            
            loadLogs(1);
        }
        
        // æ¸…é™¤ç­›é€‰
        function clearLogFilters() {
            document.getElementById('logDeviceFilter').value = '';
            document.getElementById('logStatusFilter').value = '';
            document.getElementById('logEventTypeFilter').value = '';
            logFilters = {};
            loadLogs(1);
        }
        
        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            loadLogs(currentLogPage);
            loadLogStats();
        }
        
        // æŸ¥çœ‹æ—¥å¿—è¯¦æƒ…
        function viewLogDetails(logId) {
            showCustomAlert(`æ—¥å¿—è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­... (ID: ${logId})`);
        }
        
        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            showCustomAlert('æ—¥å¿—å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
        document.getElementById('logs-tab').addEventListener('shown.bs.tab', function() {
            loadLogs(1);
            loadLogStats();
        });
    </script>
</body>
</html> 