apiVersion: v1
kind: Service
metadata:
  name: ljwx-bigscreen-canary-service
  namespace: ljwx-system
  labels:
    app: ljwx-bigscreen-canary
    env: prod
    version: canary
spec:
  selector:
    app: ljwx-bigscreen-canary
    env: prod
    version: canary
  ports:
  - name: http
    port: 80
    targetPort: 5001
    protocol: TCP
  type: ClusterIP
---
# 使用Istio VirtualService实现流量分割(如果使用Istio)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ljwx-bigscreen-vs
  namespace: ljwx-system
spec:
  hosts:
  - ljwx-bigscreen-service
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: ljwx-bigscreen-canary-service
        port:
          number: 80
  - route:
    - destination:
        host: ljwx-bigscreen-service
        port:
          number: 80
      weight: 90  # 90%流量到稳定版本
    - destination:
        host: ljwx-bigscreen-canary-service
        port:
          number: 80
      weight: 10  # 10%流量到灰度版本
---
# 使用NGINX Ingress实现流量分割(如果使用NGINX Ingress)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ljwx-bigscreen-canary-ingress
  namespace: ljwx-system
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"  # 10%流量
    nginx.ingress.kubernetes.io/canary-by-header: "canary"
    nginx.ingress.kubernetes.io/canary-by-header-value: "true"
spec:
  ingressClassName: nginx
  rules:
  - host: bigscreen.ljwx.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ljwx-bigscreen-canary-service
            port:
              number: 80 