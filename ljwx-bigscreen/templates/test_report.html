<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ljwxæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š</title>
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            margin: 5px;
        }
        
        .status-success { background: #27ae60; color: white; }
        .status-warning { background: #f39c12; color: white; }
        .status-error { background: #e74c3c; color: white; }
        .status-info { background: #3498db; color: white; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        
        .test-results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .test-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid;
            transition: all 0.3s ease;
        }
        
        .test-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }
        
        .test-item.success { border-left-color: #27ae60; }
        .test-item.error { border-left-color: #e74c3c; }
        .test-item.warning { border-left-color: #f39c12; }
        
        .test-icon {
            font-size: 1.5em;
            margin-right: 15px;
            width: 30px;
        }
        
        .test-content {
            flex: 1;
        }
        
        .test-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .test-details {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .test-time {
            color: #95a5a6;
            font-size: 0.8em;
            margin-left: 15px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            margin: 5px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-line {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
        
        .footer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ§ª ljwxæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š</h1>
            <div class="subtitle">upload_common_event æ¥å£å®Œæ•´æ€§éªŒè¯</div>
            <div id="overall-status">
                <span class="status-badge status-info">å‡†å¤‡å°±ç»ª</span>
            </div>
            <div style="margin-top: 15px;">
                <small>æœ€åæ›´æ–°: <span id="last-update">--</span></small>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" style="color: #3498db;" id="total-tests">0</div>
                <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #27ae60;" id="passed-tests">0</div>
                <div class="stat-label">é€šè¿‡æµ‹è¯•</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #e74c3c;" id="failed-tests">0</div>
                <div class="stat-label">å¤±è´¥æµ‹è¯•</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: #f39c12;" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="chart-container">
            <div class="chart-title">æµ‹è¯•ç»“æœåˆ†å¸ƒ</div>
            <div style="display: flex; justify-content: space-around; align-items: center;">
                <div style="width: 300px; height: 300px;">
                    <canvas id="resultChart"></canvas>
                </div>
                <div style="width: 500px; height: 300px;">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="btn btn-success" onclick="runTest('upload_common_event')">ğŸš€ è¿è¡Œ upload_common_event æµ‹è¯•</button>
            <button class="btn btn-primary" onclick="runAllTests()">ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="btn btn-warning" onclick="refreshReport()">ğŸ”„ åˆ·æ–°æŠ¥å‘Š</button>
            <a href="/api/test/download_report" class="btn btn-primary">ğŸ“„ ä¸‹è½½æŠ¥å‘Š</a>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨æ‰§è¡Œæµ‹è¯•ï¼Œè¯·ç¨å€™...</div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-results">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“‹ æµ‹è¯•ç»“æœè¯¦æƒ…</h2>
            <div id="test-results-list">
                <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                    ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•
                </div>
            </div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="test-results">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“Š å®æ—¶æµ‹è¯•æ—¥å¿—</h2>
            <div class="log-container" id="log-container">
                <div class="log-line log-info">ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æµ‹è¯•æ‰§è¡Œ...</div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="footer">
            <p>ljwx è‡ªåŠ¨åŒ–æµ‹è¯•ç³»ç»Ÿ | ç”Ÿæˆæ—¶é—´: <span id="report-time">--</span></p>
            <p>æµ‹è¯•ç¯å¢ƒ: ljwx-bigscreen | æ•°æ®åº“: MySQL lj-06</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let resultChart, timelineChart;
        let testResults = [];
        let isTestRunning = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            updateTimestamp();
            loadTestHistory();
        });

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // ç»“æœé¥¼å›¾
            const resultCtx = document.getElementById('resultChart').getContext('2d');
            resultChart = new Chart(resultCtx, {
                type: 'doughnut',
                data: {
                    labels: ['é€šè¿‡', 'å¤±è´¥', 'è·³è¿‡'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#27ae60', '#e74c3c', '#95a5a6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // æ—¶é—´çº¿å›¾è¡¨
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æˆåŠŸç‡',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // è¿è¡Œç‰¹å®šæµ‹è¯•
        async function runTest(testName) {
            if (isTestRunning) {
                alert('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }

            isTestRunning = true;
            showLoading(true);
            addLog('å¼€å§‹æ‰§è¡Œ ' + testName + ' æµ‹è¯•...', 'info');

            try {
                const response = await axios.post('/api/test/run', {
                    test_name: testName
                });

                if (response.data.success) {
                    addLog('æµ‹è¯•æ‰§è¡Œå®Œæˆ', 'success');
                    await loadTestResults();
                } else {
                    addLog('æµ‹è¯•æ‰§è¡Œå¤±è´¥: ' + response.data.message, 'error');
                }
            } catch (error) {
                addLog('æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ' + error.message, 'error');
            } finally {
                isTestRunning = false;
                showLoading(false);
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            if (isTestRunning) {
                alert('æµ‹è¯•æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }

            isTestRunning = true;
            showLoading(true);
            addLog('å¼€å§‹æ‰§è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');

            try {
                const response = await axios.post('/api/test/run_all');

                if (response.data.success) {
                    addLog('æ‰€æœ‰æµ‹è¯•æ‰§è¡Œå®Œæˆ', 'success');
                    await loadTestResults();
                } else {
                    addLog('æµ‹è¯•æ‰§è¡Œå¤±è´¥: ' + response.data.message, 'error');
                }
            } catch (error) {
                addLog('æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ' + error.message, 'error');
            } finally {
                isTestRunning = false;
                showLoading(false);
            }
        }

        // åˆ·æ–°æŠ¥å‘Š
        async function refreshReport() {
            addLog('åˆ·æ–°æµ‹è¯•æŠ¥å‘Š...', 'info');
            await loadTestResults();
            addLog('æŠ¥å‘Šåˆ·æ–°å®Œæˆ', 'success');
        }

        // åŠ è½½æµ‹è¯•ç»“æœ
        async function loadTestResults() {
            try {
                const response = await axios.get('/api/test/results');
                if (response.data.success) {
                    updateTestResults(response.data.data);
                }
            } catch (error) {
                addLog('åŠ è½½æµ‹è¯•ç»“æœå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æµ‹è¯•å†å²
        async function loadTestHistory() {
            try {
                const response = await axios.get('/api/test/history');
                if (response.data.success) {
                    updateTimelineChart(response.data.data);
                }
            } catch (error) {
                console.log('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error.message);
            }
        }

        // æ›´æ–°æµ‹è¯•ç»“æœ
        function updateTestResults(data) {
            testResults = data.test_results || [];
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            const totalTests = testResults.length;
            const passedTests = testResults.filter(t => t.status === 'PASS').length;
            const failedTests = testResults.filter(t => t.status === 'FAIL').length;
            const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;

            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = passedTests;
            document.getElementById('failed-tests').textContent = failedTests;
            document.getElementById('success-rate').textContent = successRate + '%';

            // æ›´æ–°çŠ¶æ€å¾½ç« 
            const statusElement = document.getElementById('overall-status');
            if (successRate === 100 && totalTests > 0) {
                statusElement.innerHTML = '<span class="status-badge status-success">å…¨éƒ¨é€šè¿‡</span>';
            } else if (successRate >= 80) {
                statusElement.innerHTML = '<span class="status-badge status-warning">å¤§éƒ¨åˆ†é€šè¿‡</span>';
            } else if (totalTests > 0) {
                statusElement.innerHTML = '<span class="status-badge status-error">å­˜åœ¨å¤±è´¥</span>';
            } else {
                statusElement.innerHTML = '<span class="status-badge status-info">æš‚æ— æµ‹è¯•</span>';
            }

            // æ›´æ–°é¥¼å›¾
            resultChart.data.datasets[0].data = [passedTests, failedTests, 0];
            resultChart.update();

            // æ›´æ–°æµ‹è¯•ç»“æœåˆ—è¡¨
            updateTestResultsList();

            // æ›´æ–°æ—¶é—´æˆ³
            updateTimestamp();
        }

        // æ›´æ–°æµ‹è¯•ç»“æœåˆ—è¡¨
        function updateTestResultsList() {
            const container = document.getElementById('test-results-list');
            
            if (testResults.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 40px;">æš‚æ— æµ‹è¯•ç»“æœ</div>';
                return;
            }

            const html = testResults.map(test => {
                const statusClass = test.status === 'PASS' ? 'success' : 'error';
                const icon = test.status === 'PASS' ? 'âœ…' : 'âŒ';
                
                return `
                    <div class="test-item ${statusClass}">
                        <div class="test-icon">${icon}</div>
                        <div class="test-content">
                            <div class="test-name">${test.name}</div>
                            <div class="test-details">
                                äº‹ä»¶ç±»å‹: ${test.event_type} | 
                                å¥åº·æ•°æ®: ${test.health_data ? 'âœ…' : 'âŒ'} | 
                                å‘Šè­¦ç”Ÿæˆ: ${test.alert_generation ? 'âœ…' : 'âŒ'} | 
                                æ¶ˆæ¯ä¸‹å‘: ${test.message_delivery ? 'âœ…' : 'âŒ'} | 
                                å¾®ä¿¡é€šçŸ¥: ${test.wechat_notification ? 'âœ…' : 'âŒ'}
                            </div>
                        </div>
                        <div class="test-time">${test.execution_time || '--'}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // æ›´æ–°æ—¶é—´çº¿å›¾è¡¨
        function updateTimelineChart(historyData) {
            if (!historyData || historyData.length === 0) return;

            const labels = historyData.map(h => h.time);
            const data = historyData.map(h => h.success_rate);

            timelineChart.data.labels = labels;
            timelineChart.data.datasets[0].data = data;
            timelineChart.update();
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = `log-line log-${type}`;
            logLine.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(logLine);
            container.scrollTop = container.scrollHeight;

            // é™åˆ¶æ—¥å¿—è¡Œæ•°
            const logs = container.children;
            if (logs.length > 100) {
                container.removeChild(logs[0]);
            }
        }

        // æ›´æ–°æ—¶é—´æˆ³
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleString();
            document.getElementById('report-time').textContent = now.toLocaleString();
        }

        // å®šæœŸåˆ·æ–°
        setInterval(() => {
            if (!isTestRunning) {
                loadTestResults();
            }
        }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html> 