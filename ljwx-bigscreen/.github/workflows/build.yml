name: Build and Push Multi-Architecture Docker Images

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  REGISTRY: crpi-yilnm6upy4pmbp67.cn-shenzhen.personal.cr.aliyuncs.com
  NAMESPACE: ljwx
  IMAGE_NAME: ljwx-bigscreen
  VERSION: 1.3.2

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®QEMU (æ”¯æŒå¤šæ¶æ„æ¨¡æ‹Ÿ)
      uses: docker/setup-qemu-action@v3
      
    - name: è®¾ç½®Docker Buildx (æ”¯æŒå¤šæ¶æ„æ„å»º)
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: brunogao
        password: admin123
        
    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=${{ env.VERSION }}
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix={{branch}}-
        
    - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./bigscreen
        file: ./bigscreen/Dockerfile.multiarch
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ env.VERSION }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}
        
    - name: éªŒè¯å¤šæ¶æ„é•œåƒ
      run: |
        echo "âœ… å¤šæ¶æ„é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸ!"
        echo "ğŸ—ï¸  æ”¯æŒæ¶æ„: AMD64, ARM64"
        echo "ğŸ³ é•œåƒåœ°å€: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
        echo "ğŸ“¦ æ‹‰å–å‘½ä»¤: docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
        
        # éªŒè¯é•œåƒmanifest
        docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        
    - name: é•œåƒå®‰å…¨æ‰«æ (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
        format: 'table'
        exit-code: '0'  # ä¸å› å®‰å…¨é—®é¢˜ä¸­æ–­æ„å»º
        
    - name: å‘é€æ„å»ºé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸé€šçŸ¥"
          echo "å¤šæ¶æ„é•œåƒå·²æˆåŠŸæ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡"
          echo "é•œåƒæ”¯æŒ AMD64 å’Œ ARM64 æ¶æ„"
        else
          echo "âŒ æ„å»ºå¤±è´¥é€šçŸ¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
        fi