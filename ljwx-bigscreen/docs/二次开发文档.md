# LJWX-BigScreen äºŒæ¬¡å¼€å‘æ–‡æ¡£

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£é¢å‘éœ€è¦åœ¨LJWX-BigScreenå¹³å°åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘çš„æŠ€æœ¯äººå‘˜ï¼Œæä¾›è¯¦ç»†çš„å¼€å‘æŒ‡å—ã€ä»£ç ç»“æ„è¯´æ˜ã€æ‰©å±•æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

## 1. å¼€å‘ç¯å¢ƒå‡†å¤‡

### 1.1 ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinux / macOS / Windows 10+
- **Pythonç‰ˆæœ¬**ï¼š3.9+
- **Node.jsç‰ˆæœ¬**ï¼š16+ (å¦‚éœ€å‰ç«¯å¼€å‘)
- **æ•°æ®åº“**ï¼šMySQL 8.0+
- **ç¼“å­˜**ï¼šRedis 7.0+
- **å®¹å™¨åŒ–**ï¼šDocker 24.0+

### 1.2 ç¯å¢ƒé…ç½®

#### 1.2.1 åŸºç¡€ç¯å¢ƒå®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/ljwx-bigscreen.git
cd ljwx-bigscreen

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Linux/macOS
# æˆ– venv\Scripts\activate  # Windows

# 3. å®‰è£…ä¾èµ–
cd bigscreen
pip install -r requirements.txt
pip install -r requirements-dev.txt  # å¼€å‘ä¾èµ–

# 4. ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env
```

#### 1.2.2 æ•°æ®åº“åˆå§‹åŒ–

```bash
# å¯åŠ¨æ•°æ®åº“æœåŠ¡
docker-compose up -d ljwx-mysql ljwx-redis

# æ•°æ®åº“è¿ç§»
python manage.py db upgrade

# åˆå§‹åŒ–åŸºç¡€æ•°æ®
python manage.py init_data
```

#### 1.2.3 å¼€å‘å·¥å…·é…ç½®

```bash
# å®‰è£…ä»£ç è´¨é‡å·¥å…·
pip install black isort flake8 pytest

# Git hooksé…ç½®
pre-commit install

# IDEé…ç½®æ–‡ä»¶ï¼ˆVSCodeï¼‰
mkdir .vscode
cat > .vscode/settings.json << EOF
{
    "python.defaultInterpreter": "./venv/bin/python",
    "python.linting.enabled": true,
    "python.linting.flake8Enabled": true,
    "python.formatting.provider": "black",
    "python.sortImports.args": ["--profile", "black"]
}
EOF
```

### 1.3 é¡¹ç›®ç»“æ„è¯¦è§£

```
ljwx-bigscreen/
â”œâ”€â”€ bigscreen/                    # ä¸»åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ bigScreen/               # æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py         # Flaskåº”ç”¨åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ models.py           # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ routes.py           # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ utils.py            # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ health_daping_analyzer.py  # å¥åº·æ•°æ®åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ redis_helper.py     # Redisæ“ä½œå°è£…
â”‚   â”‚   â””â”€â”€ templates/          # å‰ç«¯æ¨¡æ¿
â”‚   â”‚       â”œâ”€â”€ bigscreen_main.html    # ä¸»ç•Œé¢æ¨¡æ¿
â”‚   â”‚       â””â”€â”€ components/     # ç»„ä»¶æ¨¡æ¿
â”‚   â”œâ”€â”€ static/                 # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ js/                # JavaScriptæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ css/               # æ ·å¼æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ libs/              # ç¬¬ä¸‰æ–¹åº“
â”‚   â”œâ”€â”€ migrations/            # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”‚   â”œâ”€â”€ tests/                 # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ config.py             # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ requirements.txt      # ç”Ÿäº§ä¾èµ–
â”‚   â””â”€â”€ requirements-dev.txt  # å¼€å‘ä¾èµ–
â”œâ”€â”€ scripts/                  # è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ docs/                    # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ .github/                 # GitHub Actions
â”œâ”€â”€ docker-compose.yml       # å¼€å‘ç¯å¢ƒå®¹å™¨ç¼–æ’
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜
```

## 2. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 2.1 æ•°æ®æ¨¡å‹å±‚ (models.py)

#### 2.1.1 ç”¨æˆ·ç®¡ç†æ¨¡å‹

```python
from sqlalchemy import Column, Integer, String, DateTime, Text, Boolean
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class UserInfo(Base):
    """ç”¨æˆ·ä¿¡æ¯æ¨¡å‹"""
    __tablename__ = 't_user_info'
    
    id = Column(Integer, primary_key=True)
    user_name = Column(String(100), nullable=False)
    phone = Column(String(20), unique=True)
    email = Column(String(100))
    org_id = Column(Integer, index=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    def to_dict(self):
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'user_name': self.user_name,
            'phone': self.phone,
            'email': self.email,
            'org_id': self.org_id,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
    
    @classmethod
    def create_user(cls, user_data):
        """åˆ›å»ºç”¨æˆ·çš„ç±»æ–¹æ³•"""
        user = cls(**user_data)
        db.session.add(user)
        db.session.commit()
        return user
```

#### 2.1.2 è®¾å¤‡ç®¡ç†æ¨¡å‹

```python
class DeviceInfo(Base):
    """è®¾å¤‡ä¿¡æ¯æ¨¡å‹"""
    __tablename__ = 't_device_info'
    
    id = Column(Integer, primary_key=True)
    device_sn = Column(String(50), unique=True, nullable=False)
    device_name = Column(String(100))
    device_type = Column(String(50))
    user_id = Column(Integer, index=True)
    status = Column(String(20), default='ACTIVE')
    battery_level = Column(Integer)
    last_heartbeat = Column(DateTime)
    
    @property
    def is_online(self):
        """åˆ¤æ–­è®¾å¤‡æ˜¯å¦åœ¨çº¿"""
        if not self.last_heartbeat:
            return False
        return (datetime.utcnow() - self.last_heartbeat).seconds < 300  # 5åˆ†é’Ÿå†…æœ‰å¿ƒè·³
    
    def update_heartbeat(self):
        """æ›´æ–°å¿ƒè·³æ—¶é—´"""
        self.last_heartbeat = datetime.utcnow()
        db.session.commit()
```

#### 2.1.3 å¥åº·æ•°æ®æ¨¡å‹

```python
class UserHealthData(Base):
    """ç”¨æˆ·å¥åº·æ•°æ®æ¨¡å‹"""
    __tablename__ = 't_user_health_data'
    
    id = Column(Integer, primary_key=True)
    device_sn = Column(String(50), nullable=False)
    user_id = Column(Integer, index=True)
    timestamp = Column(DateTime, nullable=False)
    heart_rate = Column(Integer)
    blood_oxygen = Column(Float)
    temperature = Column(Float)
    step = Column(Integer)
    distance = Column(Float)
    calorie = Column(Integer)
    sleep_data = Column(Text)  # JSONæ ¼å¼å­˜å‚¨ç¡çœ è¯¦ç»†æ•°æ®
    
    @property
    def sleep_info(self):
        """è§£æç¡çœ æ•°æ®"""
        if self.sleep_data:
            try:
                return json.loads(self.sleep_data)
            except:
                return {}
        return {}
    
    def calculate_health_score(self):
        """è®¡ç®—å¥åº·è¯„åˆ†"""
        from .health_daping_analyzer import HealthIndicatorAnalyzer
        
        analyzer = HealthIndicatorAnalyzer()
        metrics = {
            'heart_rate': self.heart_rate or 0,
            'blood_oxygen': self.blood_oxygen or 0,
            'temperature': self.temperature or 0,
            'step': self.step or 0,
            'distance': self.distance or 0,
            'calorie': self.calorie or 0
        }
        
        return analyzer.calculate_health_score(metrics)
```

### 2.2 ä¸šåŠ¡é€»è¾‘å±‚

#### 2.2.1 å¥åº·æ•°æ®åˆ†ææœåŠ¡

```python
from .health_daping_analyzer import HealthIndicatorAnalyzer

class HealthAnalysisService:
    """å¥åº·æ•°æ®åˆ†ææœåŠ¡"""
    
    def __init__(self, customer_id=None):
        self.customer_id = customer_id
        self.analyzer = HealthIndicatorAnalyzer(
            customer_id=customer_id,
            db_session=db.session
        )
    
    def analyze_user_health(self, user_id, days=7):
        """åˆ†æç”¨æˆ·å¥åº·æ•°æ®"""
        # æŸ¥è¯¢ç”¨æˆ·å¥åº·æ•°æ®
        end_date = datetime.utcnow()
        start_date = end_date - timedelta(days=days)
        
        health_data = UserHealthData.query.filter(
            UserHealthData.user_id == user_id,
            UserHealthData.timestamp.between(start_date, end_date)
        ).order_by(UserHealthData.timestamp.desc()).all()
        
        if not health_data:
            return {'error': 'æ— å¥åº·æ•°æ®'}
        
        # è½¬æ¢ä¸ºåˆ†æå™¨éœ€è¦çš„æ ¼å¼
        data_list = []
        for record in health_data:
            data_dict = {
                'timestamp': record.timestamp.strftime('%Y-%m-%d %H:%M:%S'),
                'heart_rate': record.heart_rate,
                'blood_oxygen': record.blood_oxygen,
                'temperature': record.temperature,
                'step': record.step,
                'distance': record.distance,
                'calorie': record.calorie
            }
            data_list.append(data_dict)
        
        # æ‰§è¡Œåˆ†æ
        return self.analyzer.calculate_health_scores_legacy(data_list)
    
    def get_health_trends(self, user_id, days=30):
        """è·å–å¥åº·è¶‹åŠ¿åˆ†æ"""
        # å®ç°è¶‹åŠ¿åˆ†æé€»è¾‘
        pass
```

#### 2.2.2 å‘Šè­¦ç®¡ç†æœåŠ¡

```python
class AlertService:
    """å‘Šè­¦ç®¡ç†æœåŠ¡"""
    
    @staticmethod
    def create_alert(alert_data):
        """åˆ›å»ºå‘Šè­¦"""
        alert = AlertInfo(
            alert_type=alert_data['alert_type'],
            device_sn=alert_data['device_sn'],
            user_id=alert_data.get('user_id'),
            alert_level=alert_data.get('alert_level', 'medium'),
            alert_title=alert_data['alert_title'],
            alert_content=alert_data['alert_content'],
            alert_data=json.dumps(alert_data.get('alert_data', {}))
        )
        
        db.session.add(alert)
        db.session.commit()
        
        # å‘é€é€šçŸ¥
        AlertService.send_notification(alert)
        
        return alert
    
    @staticmethod
    def send_notification(alert):
        """å‘é€å‘Šè­¦é€šçŸ¥"""
        from .notification_service import NotificationService
        
        notification_service = NotificationService()
        
        # æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ¸ é“
        if alert.alert_level == 'critical':
            # ä¸¥é‡å‘Šè­¦ï¼šä¼ä¸šå¾®ä¿¡ + ç³»ç»Ÿæ¶ˆæ¯
            notification_service.send_wechat_alert(alert)
            notification_service.send_system_message(alert)
        elif alert.alert_level == 'high':
            # é«˜çº§å‘Šè­¦ï¼šç³»ç»Ÿæ¶ˆæ¯
            notification_service.send_system_message(alert)
        else:
            # ä¸€èˆ¬å‘Šè­¦ï¼šä»…è®°å½•
            pass
```

### 2.3 APIæ¥å£å±‚

#### 2.3.1 RESTful APIè®¾è®¡è§„èŒƒ

```python
from flask import Blueprint, jsonify, request
from functools import wraps

# åˆ›å»ºè“å›¾
api_bp = Blueprint('api', __name__, url_prefix='/api')

# ç»Ÿä¸€å“åº”æ ¼å¼è£…é¥°å™¨
def api_response(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            result = func(*args, **kwargs)
            if isinstance(result, dict) and 'error' in result:
                return jsonify({
                    'success': False,
                    'code': 400,
                    'message': result['error'],
                    'data': None
                }), 400
            
            return jsonify({
                'success': True,
                'code': 200,
                'message': 'success',
                'data': result
            })
        except Exception as e:
            return jsonify({
                'success': False,
                'code': 500,
                'message': str(e),
                'data': None
            }), 500
    return wrapper

# åˆ†é¡µæŸ¥è¯¢è£…é¥°å™¨
def paginate(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        page = request.args.get('page', 1, type=int)
        size = request.args.get('size', 20, type=int)
        size = min(size, 100)  # é™åˆ¶æœ€å¤§é¡µé¢å¤§å°
        
        # å°†åˆ†é¡µå‚æ•°ä¼ é€’ç»™å‡½æ•°
        kwargs.update({'page': page, 'size': size})
        return func(*args, **kwargs)
    return wrapper

# APIç¤ºä¾‹
@api_bp.route('/users', methods=['GET'])
@api_response
@paginate
def get_users(page=1, size=20):
    """è·å–ç”¨æˆ·åˆ—è¡¨"""
    users = UserInfo.query.paginate(
        page=page, 
        per_page=size, 
        error_out=False
    )
    
    return {
        'items': [user.to_dict() for user in users.items],
        'total': users.total,
        'page': page,
        'size': size,
        'pages': users.pages
    }

@api_bp.route('/users', methods=['POST'])
@api_response
def create_user():
    """åˆ›å»ºç”¨æˆ·"""
    data = request.get_json()
    
    # æ•°æ®éªŒè¯
    if not data.get('user_name'):
        return {'error': 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º'}
    
    if not data.get('phone'):
        return {'error': 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º'}
    
    # æ£€æŸ¥æ‰‹æœºå·é‡å¤
    existing_user = UserInfo.query.filter_by(phone=data['phone']).first()
    if existing_user:
        return {'error': 'æ‰‹æœºå·å·²å­˜åœ¨'}
    
    # åˆ›å»ºç”¨æˆ·
    user = UserInfo.create_user(data)
    return user.to_dict()
```

## 3. å‰ç«¯å¼€å‘æŒ‡å—

### 3.1 EChartså›¾è¡¨ç»„ä»¶

#### 3.1.1 é›·è¾¾å›¾ç»„ä»¶å°è£…

```javascript
/**
 * å¥åº·é›·è¾¾å›¾ç»„ä»¶
 */
class HealthRadarChart {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        this.chart = echarts.init(this.container);
        this.options = {
            backgroundColor: 'transparent',
            ...options
        };
        this.defaultConfig = this.getDefaultConfig();
    }
    
    getDefaultConfig() {
        return {
            backgroundColor: 'transparent',
            radar: {
                indicator: [
                    { name: 'å¿ƒç‡', max: 100 },
                    { name: 'è¡€æ°§', max: 100 },
                    { name: 'ä½“æ¸©', max: 100 },
                    { name: 'æ­¥æ•°', max: 100 },
                    { name: 'å‹åŠ›', max: 100 },
                    { name: 'æ”¶ç¼©å‹', max: 100 },
                    { name: 'ç¡çœ ', max: 100 }  // ç¡®ä¿åŒ…å«ç¡çœ æŒ‡æ ‡
                ],
                shape: 'circle',
                splitNumber: 5,
                axisName: {
                    color: '#00e4ff',
                    fontSize: 12
                },
                splitLine: {
                    lineStyle: {
                        color: 'rgba(0, 228, 255, 0.3)'
                    }
                },
                splitArea: {
                    show: false
                },
                axisLine: {
                    lineStyle: {
                        color: 'rgba(0, 228, 255, 0.5)'
                    }
                }
            },
            series: [{
                type: 'radar',
                data: []
            }]
        };
    }
    
    updateData(healthData) {
        const radarData = this.calculateRadarDataFromMetrics(healthData);
        const config = { ...this.defaultConfig };
        config.series[0].data = [radarData];
        
        this.chart.setOption(config);
    }
    
    calculateRadarDataFromMetrics(metrics) {
        // 9ç»´å¥åº·æŒ‡æ ‡è¯„åˆ†
        const mainMetrics = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'æ­¥æ•°', 'å‹åŠ›', 'æ”¶ç¼©å‹', 'ç¡çœ '];
        const values = [];
        
        for (const metricName of mainMetrics) {
            let score = 0;
            const metric = metrics.find(m => m.name === metricName);
            
            if (metric && metric.value !== undefined) {
                const avg = metric.value;
                
                // å„æŒ‡æ ‡è¯„åˆ†é€»è¾‘
                switch (metricName) {
                    case 'å¿ƒç‡':
                        score = (avg >= 60 && avg <= 100) ? 
                            Math.max(85, 100 - Math.abs(avg - 80) * 0.5) : 
                            Math.max(30, 70 - Math.abs(avg - 80) * 0.8);
                        break;
                    case 'è¡€æ°§':
                        score = avg >= 95 ? 95 : Math.max(40, avg * 0.9);
                        break;
                    case 'ä½“æ¸©':
                        score = (avg >= 36.3 && avg <= 37.2) ? 90 : 
                            Math.max(40, 90 - Math.abs(avg - 36.8) * 20);
                        break;
                    case 'æ­¥æ•°':
                        score = avg >= 8000 ? Math.min(95, 60 + (avg / 1000) * 3) : 
                            Math.max(30, (avg / 8000) * 60);
                        break;
                    case 'å‹åŠ›':
                        score = avg <= 30 ? 90 : Math.max(30, 90 - avg * 0.8);
                        break;
                    case 'æ”¶ç¼©å‹':
                        score = (avg >= 90 && avg <= 140) ? 85 : 
                            Math.max(30, 85 - Math.abs(avg - 115) * 0.5);
                        break;
                    case 'ç¡çœ ':
                        score = avg >= 7 ? 85 : (avg >= 6 ? 70 : 55);
                        break;
                    default:
                        score = 75;
                }
            } else {
                score = 50; // é»˜è®¤åˆ†æ•°
            }
            
            values.push(Math.round(score));
        }
        
        return {
            value: values,
            name: 'å¥åº·è¯„åˆ†',
            lineStyle: {
                color: '#00e4ff',
                width: 2
            },
            areaStyle: {
                color: 'rgba(0, 228, 255, 0.1)'
            }
        };
    }
    
    resize() {
        this.chart.resize();
    }
    
    dispose() {
        this.chart.dispose();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const healthRadar = new HealthRadarChart('healthRadarContainer');

// æ›´æ–°æ•°æ®
fetch('/api/health/radar-data')
    .then(response => response.json())
    .then(data => {
        healthRadar.updateData(data);
    });
```

#### 3.1.2 å®æ—¶æ•°æ®æ›´æ–°ç»„ä»¶

```javascript
/**
 * å®æ—¶æ•°æ®ç®¡ç†å™¨
 */
class RealtimeDataManager {
    constructor(options = {}) {
        this.socket = null;
        this.reconnectInterval = options.reconnectInterval || 5000;
        this.maxReconnectAttempts = options.maxReconnectAttempts || 5;
        this.reconnectAttempts = 0;
        this.subscriptions = new Map();
        this.messageQueue = [];
        this.isConnected = false;
    }
    
    connect(url = null) {
        try {
            const socketUrl = url || `ws://${window.location.host}/ws`;
            this.socket = new WebSocket(socketUrl);
            
            this.socket.onopen = (event) => {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                this.isConnected = true;
                this.reconnectAttempts = 0;
                
                // å‘é€è®¤è¯ä¿¡æ¯
                this.authenticate();
                
                // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
                this.processMessageQueue();
            };
            
            this.socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                } catch (e) {
                    console.error('æ¶ˆæ¯è§£æé”™è¯¯:', e);
                }
            };
            
            this.socket.onclose = (event) => {
                console.log('WebSocketè¿æ¥å…³é—­:', event.code);
                this.isConnected = false;
                
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    setTimeout(() => {
                        this.reconnectAttempts++;
                        console.log(`å°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                        this.connect();
                    }, this.reconnectInterval);
                }
            };
            
            this.socket.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
            };
            
        } catch (e) {
            console.error('WebSocketè¿æ¥å¤±è´¥:', e);
        }
    }
    
    authenticate() {
        const authMessage = {
            type: 'auth',
            token: localStorage.getItem('access_token'),
            userId: localStorage.getItem('user_id'),
            subscriptions: Array.from(this.subscriptions.keys())
        };
        
        this.send(authMessage);
    }
    
    subscribe(channel, callback) {
        this.subscriptions.set(channel, callback);
        
        if (this.isConnected) {
            this.send({
                type: 'subscribe',
                channel: channel
            });
        }
    }
    
    unsubscribe(channel) {
        this.subscriptions.delete(channel);
        
        if (this.isConnected) {
            this.send({
                type: 'unsubscribe',
                channel: channel
            });
        }
    }
    
    handleMessage(message) {
        const { type, channel, data } = message;
        
        switch (type) {
            case 'health_data_update':
                this.handleHealthDataUpdate(data);
                break;
            case 'critical_alert':
                this.handleCriticalAlert(data);
                break;
            case 'device_status_change':
                this.handleDeviceStatusChange(data);
                break;
            default:
                // å¤„ç†è®¢é˜…é¢‘é“æ¶ˆæ¯
                if (channel && this.subscriptions.has(channel)) {
                    const callback = this.subscriptions.get(channel);
                    callback(data);
                }
        }
    }
    
    handleHealthDataUpdate(data) {
        // æ›´æ–°å¥åº·æ•°æ®æ˜¾ç¤º
        if (window.globalCharts) {
            window.globalCharts.updateHealthData(data);
        }
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
        window.dispatchEvent(new CustomEvent('healthDataUpdate', {
            detail: data
        }));
    }
    
    handleCriticalAlert(alert) {
        // æ˜¾ç¤ºä¸¥é‡å‘Šè­¦å¼¹çª—
        this.showCriticalAlertModal(alert);
    }
    
    showCriticalAlertModal(alert) {
        const modal = document.createElement('div');
        modal.className = 'critical-alert-modal';
        modal.style.display = 'flex';
        
        modal.innerHTML = `
            <div class="critical-alert-content">
                <div class="critical-alert-header">
                    <span class="critical-alert-icon">ğŸš¨</span>
                    <span class="critical-alert-title">ä¸¥é‡å‘Šè­¦</span>
                </div>
                <div class="critical-alert-body">
                    <div class="alert-detail-row">
                        <span class="alert-detail-label">å‘Šè­¦ç±»å‹:</span>
                        <span class="alert-detail-value">${alert.alert_type}</span>
                    </div>
                    <div class="alert-detail-row">
                        <span class="alert-detail-label">ç”¨æˆ·:</span>
                        <span class="alert-detail-value">${alert.user_name}</span>
                    </div>
                    <div class="alert-detail-row">
                        <span class="alert-detail-label">è®¾å¤‡:</span>
                        <span class="alert-detail-value">${alert.device_sn}</span>
                    </div>
                    <div class="alert-detail-row">
                        <span class="alert-detail-label">æ—¶é—´:</span>
                        <span class="alert-detail-value">${alert.timestamp}</span>
                    </div>
                </div>
                <div class="critical-alert-actions">
                    <button class="alert-action-btn btn-acknowledge" onclick="this.acknowledgeAlert('${alert.id}')">ç¡®è®¤</button>
                    <button class="alert-action-btn btn-dismiss" onclick="this.dismissAlert()">å¿½ç•¥</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // è‡ªåŠ¨å…³é—­
        setTimeout(() => {
            if (modal.parentNode) {
                modal.remove();
            }
        }, 30000);
    }
    
    send(message) {
        if (this.isConnected && this.socket) {
            this.socket.send(JSON.stringify(message));
        } else {
            // æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—
            this.messageQueue.push(message);
        }
    }
    
    processMessageQueue() {
        while (this.messageQueue.length > 0) {
            const message = this.messageQueue.shift();
            this.send(message);
        }
    }
    
    disconnect() {
        if (this.socket) {
            this.socket.close();
            this.socket = null;
        }
        this.isConnected = false;
    }
}

// å…¨å±€å®æ—¶æ•°æ®ç®¡ç†å™¨å®ä¾‹
window.realtimeManager = new RealtimeDataManager();

// é¡µé¢åŠ è½½æ—¶è¿æ¥
document.addEventListener('DOMContentLoaded', () => {
    window.realtimeManager.connect();
    
    // è®¢é˜…å¥åº·æ•°æ®æ›´æ–°
    window.realtimeManager.subscribe('health_updates', (data) => {
        console.log('æ”¶åˆ°å¥åº·æ•°æ®æ›´æ–°:', data);
    });
    
    // è®¢é˜…è®¾å¤‡çŠ¶æ€å˜æ›´
    window.realtimeManager.subscribe('device_status', (data) => {
        console.log('æ”¶åˆ°è®¾å¤‡çŠ¶æ€å˜æ›´:', data);
    });
});
```

## 4. æ‰©å±•å¼€å‘æŒ‡å—

### 4.1 æ·»åŠ æ–°çš„å¥åº·æŒ‡æ ‡

#### 4.1.1 æ•°æ®æ¨¡å‹æ‰©å±•

```python
# 1. ä¿®æ”¹UserHealthDataæ¨¡å‹ï¼Œæ·»åŠ æ–°å­—æ®µ
class UserHealthData(Base):
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢å¥åº·æŒ‡æ ‡
    blood_pressure_systolic = Column(Integer)    # æ”¶ç¼©å‹
    blood_pressure_diastolic = Column(Integer)   # èˆ’å¼ å‹
    glucose_level = Column(Float)                # è¡€ç³–æ°´å¹³
    weight = Column(Float)                       # ä½“é‡
    bmi = Column(Float)                         # BMIæŒ‡æ•°

# 2. åˆ›å»ºæ•°æ®åº“è¿ç§»
# flask db migrate -m "add_new_health_metrics"
# flask db upgrade
```

#### 4.1.2 åˆ†æå™¨é…ç½®æ›´æ–°

```python
# åœ¨health_daping_analyzer.pyä¸­æ·»åŠ æ–°æŒ‡æ ‡é…ç½®
def _load_metrics_config(self) -> Dict:
    default_metrics = {
        # ... ç°æœ‰æŒ‡æ ‡ ...
        
        'blood_pressure_systolic': {
            'name': 'æ”¶ç¼©å‹',
            'unit': 'mmHg',
            'normal_range': (90, 140),
            'weight': 1.4,
            'importance': 'high'
        },
        'blood_pressure_diastolic': {
            'name': 'èˆ’å¼ å‹',
            'unit': 'mmHg',
            'normal_range': (60, 90),
            'weight': 1.4,
            'importance': 'high'
        },
        'glucose_level': {
            'name': 'è¡€ç³–',
            'unit': 'mmol/L',
            'normal_range': (3.9, 7.8),
            'weight': 1.6,
            'importance': 'high'
        },
        'weight': {
            'name': 'ä½“é‡',
            'unit': 'kg',
            'normal_range': (45, 90),  # æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´
            'weight': 0.8,
            'importance': 'medium'
        },
        'bmi': {
            'name': 'BMIæŒ‡æ•°',
            'unit': '',
            'normal_range': (18.5, 24.9),
            'weight': 1.2,
            'importance': 'high'
        }
    }
    # ... å…¶ä»–é€»è¾‘ ...
```

#### 4.1.3 å‰ç«¯é›·è¾¾å›¾æ›´æ–°

```javascript
// æ›´æ–°é›·è¾¾å›¾æŒ‡æ ‡
const healthRadarConfig = {
    radar: {
        indicator: [
            { name: 'å¿ƒç‡', max: 100 },
            { name: 'è¡€æ°§', max: 100 },
            { name: 'ä½“æ¸©', max: 100 },
            { name: 'æ­¥æ•°', max: 100 },
            { name: 'å‹åŠ›', max: 100 },
            { name: 'æ”¶ç¼©å‹', max: 100 },
            { name: 'èˆ’å¼ å‹', max: 100 },  // æ–°å¢
            { name: 'è¡€ç³–', max: 100 },    // æ–°å¢
            { name: 'ç¡çœ ', max: 100 }
        ]
        // ... å…¶ä»–é…ç½®
    }
};

// æ›´æ–°è¯„åˆ†è®¡ç®—é€»è¾‘
function calculateRadarDataFromMetrics(metrics) {
    const mainMetrics = ['å¿ƒç‡', 'è¡€æ°§', 'ä½“æ¸©', 'æ­¥æ•°', 'å‹åŠ›', 'æ”¶ç¼©å‹', 'èˆ’å¼ å‹', 'è¡€ç³–', 'ç¡çœ '];
    const values = [];
    
    for (const metricName of mainMetrics) {
        let score = 0;
        const metric = metrics.find(m => m.name === metricName);
        
        if (metric && metric.value !== undefined) {
            const avg = metric.value;
            
            switch (metricName) {
                // ... ç°æœ‰æŒ‡æ ‡é€»è¾‘ ...
                
                case 'èˆ’å¼ å‹':
                    score = (avg >= 60 && avg <= 90) ? 
                        Math.max(85, 100 - Math.abs(avg - 75) * 0.6) : 
                        Math.max(30, 85 - Math.abs(avg - 75) * 0.8);
                    break;
                case 'è¡€ç³–':
                    score = (avg >= 3.9 && avg <= 7.8) ? 90 : 
                        Math.max(30, 90 - Math.abs(avg - 5.85) * 8);
                    break;
                // ... å…¶ä»–æ–°æŒ‡æ ‡
            }
        }
        
        values.push(Math.round(score));
    }
    
    return {
        value: values,
        name: 'å¥åº·è¯„åˆ†'
        // ... å…¶ä»–é…ç½®
    };
}
```

### 4.2 æ·»åŠ æ–°çš„å‘Šè­¦ç±»å‹

#### 4.2.1 å‘Šè­¦è§„åˆ™å®šä¹‰

```python
# åˆ›å»ºæ–°çš„å‘Šè­¦è§„åˆ™ç±»
class BloodPressureAlertRule:
    """è¡€å‹å¼‚å¸¸å‘Šè­¦è§„åˆ™"""
    
    def __init__(self):
        self.rule_name = "è¡€å‹å¼‚å¸¸å‘Šè­¦"
        self.rule_type = "blood_pressure"
        self.priority = "high"
    
    def evaluate(self, health_data):
        """è¯„ä¼°æ˜¯å¦è§¦å‘å‘Šè­¦"""
        systolic = health_data.get('blood_pressure_systolic')
        diastolic = health_data.get('blood_pressure_diastolic')
        
        if not systolic or not diastolic:
            return None
        
        # é«˜è¡€å‹åˆ¤æ–­
        if systolic >= 180 or diastolic >= 110:
            return {
                'alert_type': 'blood_pressure_critical',
                'alert_level': 'critical',
                'alert_title': 'ä¸¥é‡é«˜è¡€å‹',
                'alert_content': f'æ£€æµ‹åˆ°ä¸¥é‡é«˜è¡€å‹ï¼š{systolic}/{diastolic} mmHg',
                'suggestions': [
                    'ç«‹å³å°±åŒ»',
                    'é¿å…å‰§çƒˆè¿åŠ¨',
                    'ä¿æŒæƒ…ç»ªç¨³å®š'
                ]
            }
        elif systolic >= 140 or diastolic >= 90:
            return {
                'alert_type': 'blood_pressure_high',
                'alert_level': 'high',
                'alert_title': 'é«˜è¡€å‹',
                'alert_content': f'æ£€æµ‹åˆ°é«˜è¡€å‹ï¼š{systolic}/{diastolic} mmHg',
                'suggestions': [
                    'æ³¨æ„ä¼‘æ¯',
                    'æ§åˆ¶ç›åˆ†æ‘„å…¥',
                    'å®šæœŸç›‘æµ‹'
                ]
            }
        
        # ä½è¡€å‹åˆ¤æ–­
        elif systolic <= 90 or diastolic <= 60:
            return {
                'alert_type': 'blood_pressure_low',
                'alert_level': 'medium',
                'alert_title': 'ä½è¡€å‹',
                'alert_content': f'æ£€æµ‹åˆ°ä½è¡€å‹ï¼š{systolic}/{diastolic} mmHg',
                'suggestions': [
                    'é€‚å½“è¡¥å……è¥å…»',
                    'é¿å…çªç„¶ç«™ç«‹',
                    'æ³¨æ„ä¿æš–'
                ]
            }
        
        return None

# æ³¨å†Œå‘Šè­¦è§„åˆ™
from .alert_service import AlertRuleRegistry

AlertRuleRegistry.register('blood_pressure', BloodPressureAlertRule())
```

#### 4.2.2 å‘Šè­¦å¤„ç†æµç¨‹

```python
class AlertProcessor:
    """å‘Šè­¦å¤„ç†å™¨"""
    
    def __init__(self):
        self.rules = AlertRuleRegistry.get_all_rules()
        self.notification_service = NotificationService()
    
    def process_health_data(self, health_data):
        """å¤„ç†å¥åº·æ•°æ®å¹¶æ£€æŸ¥å‘Šè­¦"""
        alerts = []
        
        for rule_name, rule in self.rules.items():
            try:
                alert_result = rule.evaluate(health_data)
                if alert_result:
                    # åˆ›å»ºå‘Šè­¦è®°å½•
                    alert = AlertService.create_alert({
                        **alert_result,
                        'device_sn': health_data.get('device_sn'),
                        'user_id': health_data.get('user_id'),
                        'alert_data': health_data
                    })
                    alerts.append(alert)
                    
                    # å‘é€é€šçŸ¥
                    self._send_notification(alert, rule)
                    
            except Exception as e:
                logging.error(f"å‘Šè­¦è§„åˆ™ {rule_name} å¤„ç†å¤±è´¥: {e}")
        
        return alerts
    
    def _send_notification(self, alert, rule):
        """å‘é€å‘Šè­¦é€šçŸ¥"""
        if alert.alert_level == 'critical':
            # ä¸¥é‡å‘Šè­¦ï¼šå¤šæ¸ é“é€šçŸ¥
            self.notification_service.send_critical_alert(alert)
        elif alert.alert_level == 'high':
            # é«˜çº§å‘Šè­¦ï¼šä¼ä¸šå¾®ä¿¡é€šçŸ¥
            self.notification_service.send_wechat_alert(alert)
        else:
            # ä¸€èˆ¬å‘Šè­¦ï¼šç³»ç»Ÿå†…é€šçŸ¥
            self.notification_service.send_system_message(alert)
```

### 4.3 è‡ªå®šä¹‰æ•°æ®å¯è§†åŒ–ç»„ä»¶

#### 4.3.1 åˆ›å»ºè‡ªå®šä¹‰å›¾è¡¨ç»„ä»¶

```javascript
/**
 * è¡€å‹è¶‹åŠ¿å›¾ç»„ä»¶
 */
class BloodPressureTrendChart {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        this.chart = echarts.init(this.container);
        this.options = {
            title: 'è¡€å‹è¶‹åŠ¿',
            timeRange: 7, // é»˜è®¤7å¤©
            ...options
        };
        
        this.initChart();
    }
    
    initChart() {
        const option = {
            title: {
                text: this.options.title,
                textStyle: {
                    color: '#00e4ff',
                    fontSize: 16
                }
            },
            tooltip: {
                trigger: 'axis',
                formatter: (params) => {
                    let result = `${params[0].axisValue}<br/>`;
                    params.forEach(param => {
                        result += `${param.seriesName}: ${param.value} mmHg<br/>`;
                    });
                    return result;
                }
            },
            legend: {
                data: ['æ”¶ç¼©å‹', 'èˆ’å¼ å‹'],
                textStyle: {
                    color: '#fff'
                }
            },
            xAxis: {
                type: 'category',
                data: [],
                axisLine: {
                    lineStyle: {
                        color: '#00e4ff'
                    }
                },
                axisLabel: {
                    color: '#fff'
                }
            },
            yAxis: {
                type: 'value',
                name: 'mmHg',
                axisLine: {
                    lineStyle: {
                        color: '#00e4ff'
                    }
                },
                axisLabel: {
                    color: '#fff'
                },
                splitLine: {
                    lineStyle: {
                        color: 'rgba(0, 228, 255, 0.2)'
                    }
                }
            },
            series: [
                {
                    name: 'æ”¶ç¼©å‹',
                    type: 'line',
                    data: [],
                    smooth: true,
                    lineStyle: {
                        color: '#ff6b6b',
                        width: 2
                    },
                    itemStyle: {
                        color: '#ff6b6b'
                    },
                    markLine: {
                        data: [
                            {
                                name: 'é«˜è¡€å‹çº¿',
                                yAxis: 140,
                                lineStyle: {
                                    color: '#ff4757',
                                    type: 'dashed'
                                }
                            }
                        ]
                    }
                },
                {
                    name: 'èˆ’å¼ å‹',
                    type: 'line',
                    data: [],
                    smooth: true,
                    lineStyle: {
                        color: '#1e90ff',
                        width: 2
                    },
                    itemStyle: {
                        color: '#1e90ff'
                    },
                    markLine: {
                        data: [
                            {
                                name: 'é«˜è¡€å‹çº¿',
                                yAxis: 90,
                                lineStyle: {
                                    color: '#ff4757',
                                    type: 'dashed'
                                }
                            }
                        ]
                    }
                }
            ]
        };
        
        this.chart.setOption(option);
    }
    
    updateData(bloodPressureData) {
        const timestamps = [];
        const systolicData = [];
        const diastolicData = [];
        
        bloodPressureData.forEach(item => {
            timestamps.push(this.formatDate(item.timestamp));
            systolicData.push(item.systolic);
            diastolicData.push(item.diastolic);
        });
        
        this.chart.setOption({
            xAxis: {
                data: timestamps
            },
            series: [
                {
                    data: systolicData
                },
                {
                    data: diastolicData
                }
            ]
        });
    }
    
    formatDate(timestamp) {
        const date = new Date(timestamp);
        return `${date.getMonth() + 1}/${date.getDate()}`;
    }
    
    resize() {
        this.chart.resize();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const bpChart = new BloodPressureTrendChart('bloodPressureChart');

// è·å–æ•°æ®å¹¶æ›´æ–°å›¾è¡¨
fetch('/api/health/blood-pressure-trend?userId=123&days=7')
    .then(response => response.json())
    .then(data => {
        bpChart.updateData(data.data);
    });
```

## 5. æµ‹è¯•æŒ‡å—

### 5.1 å•å…ƒæµ‹è¯•

#### 5.1.1 å¥åº·åˆ†æå™¨æµ‹è¯•

```python
# tests/test_health_analyzer.py
import unittest
from unittest.mock import Mock, patch
from bigScreen.health_daping_analyzer import HealthIndicatorAnalyzer

class TestHealthIndicatorAnalyzer(unittest.TestCase):
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.analyzer = HealthIndicatorAnalyzer()
    
    def test_calculate_health_score_normal_data(self):
        """æµ‹è¯•æ­£å¸¸å¥åº·æ•°æ®è¯„åˆ†"""
        user_metrics = {
            'heart_rate': 75,
            'blood_oxygen': 98,
            'temperature': 36.8,
            'step': 8000,
            'sleep': 7.5
        }
        
        result = self.analyzer.calculate_health_score(user_metrics)
        
        self.assertIsInstance(result, dict)
        self.assertIn('overall_score', result)
        self.assertGreater(result['overall_score'], 80)  # æ­£å¸¸æ•°æ®åº”è¯¥æœ‰è¾ƒé«˜åˆ†æ•°
        self.assertEqual(result['health_level'], 'è‰¯å¥½')
    
    def test_calculate_health_score_abnormal_data(self):
        """æµ‹è¯•å¼‚å¸¸å¥åº·æ•°æ®è¯„åˆ†"""
        user_metrics = {
            'heart_rate': 120,  # å¼‚å¸¸é«˜å¿ƒç‡
            'blood_oxygen': 88,  # å¼‚å¸¸ä½è¡€æ°§
            'temperature': 38.5,  # å‘çƒ§
            'step': 1000,  # è¿åŠ¨ä¸è¶³
            'sleep': 4  # ç¡çœ ä¸è¶³
        }
        
        result = self.analyzer.calculate_health_score(user_metrics)
        
        self.assertIsInstance(result, dict)
        self.assertIn('overall_score', result)
        self.assertLess(result['overall_score'], 60)  # å¼‚å¸¸æ•°æ®åº”è¯¥æœ‰è¾ƒä½åˆ†æ•°
        self.assertIn(result['health_level'], ['æ³¨æ„', 'é£é™©'])
    
    def test_get_metric_weight(self):
        """æµ‹è¯•æŒ‡æ ‡æƒé‡è·å–"""
        heart_rate_weight = self.analyzer.get_metric_weight('heart_rate')
        self.assertEqual(heart_rate_weight, 1.5)
        
        invalid_weight = self.analyzer.get_metric_weight('invalid_metric')
        self.assertEqual(invalid_weight, 1.0)  # é»˜è®¤æƒé‡
    
    def test_supported_metrics(self):
        """æµ‹è¯•æ”¯æŒçš„æŒ‡æ ‡åˆ—è¡¨"""
        metrics = self.analyzer.get_supported_metrics()
        
        self.assertIsInstance(metrics, list)
        self.assertIn('heart_rate', metrics)
        self.assertIn('blood_oxygen', metrics)
        self.assertIn('sleep', metrics)
    
    @patch('bigScreen.health_daping_analyzer.db.session')
    def test_database_config_loading(self, mock_db_session):
        """æµ‹è¯•æ•°æ®åº“é…ç½®åŠ è½½"""
        # æ¨¡æ‹Ÿæ•°æ®åº“é…ç½®
        mock_config = Mock()
        mock_config.data_type = 'heart_rate'
        mock_config.weight = 2.0
        mock_config.warning_high = 100
        mock_config.warning_low = 60
        
        mock_db_session.query.return_value.filter.return_value.all.return_value = [mock_config]
        
        # åˆ›å»ºå¸¦æ•°æ®åº“é…ç½®çš„åˆ†æå™¨
        analyzer_db = HealthIndicatorAnalyzer(
            customer_id='test_customer',
            db_session=mock_db_session
        )
        
        # éªŒè¯é…ç½®åŠ è½½
        heart_rate_config = analyzer_db.get_metric_config('heart_rate')
        self.assertIsNotNone(heart_rate_config)
        self.assertEqual(heart_rate_config['weight'], 2.0)

if __name__ == '__main__':
    unittest.main()
```

#### 5.1.2 APIæ¥å£æµ‹è¯•

```python
# tests/test_api.py
import unittest
import json
from bigScreen import app
from bigScreen.models import UserInfo, db

class TestAPI(unittest.TestCase):
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        app.config['TESTING'] = True
        app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        self.app = app.test_client()
        self.ctx = app.app_context()
        self.ctx.push()
        
        db.create_all()
    
    def tearDown(self):
        """æµ‹è¯•åæ¸…ç†"""
        db.session.remove()
        db.drop_all()
        self.ctx.pop()
    
    def test_get_users_empty(self):
        """æµ‹è¯•è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç©ºæ•°æ®ï¼‰"""
        response = self.app.get('/api/users')
        
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        
        self.assertTrue(data['success'])
        self.assertEqual(len(data['data']['items']), 0)
        self.assertEqual(data['data']['total'], 0)
    
    def test_create_user_success(self):
        """æµ‹è¯•åˆ›å»ºç”¨æˆ·æˆåŠŸ"""
        user_data = {
            'user_name': 'æµ‹è¯•ç”¨æˆ·',
            'phone': '13800138000',
            'email': 'test@example.com'
        }
        
        response = self.app.post('/api/users',
                                data=json.dumps(user_data),
                                content_type='application/json')
        
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        
        self.assertTrue(data['success'])
        self.assertEqual(data['data']['user_name'], 'æµ‹è¯•ç”¨æˆ·')
        self.assertEqual(data['data']['phone'], '13800138000')
    
    def test_create_user_duplicate_phone(self):
        """æµ‹è¯•åˆ›å»ºç”¨æˆ·ï¼ˆé‡å¤æ‰‹æœºå·ï¼‰"""
        # å…ˆåˆ›å»ºä¸€ä¸ªç”¨æˆ·
        user1 = UserInfo(user_name='ç”¨æˆ·1', phone='13800138000')
        db.session.add(user1)
        db.session.commit()
        
        # å°è¯•åˆ›å»ºé‡å¤æ‰‹æœºå·ç”¨æˆ·
        user_data = {
            'user_name': 'ç”¨æˆ·2',
            'phone': '13800138000',
            'email': 'test2@example.com'
        }
        
        response = self.app.post('/api/users',
                                data=json.dumps(user_data),
                                content_type='application/json')
        
        self.assertEqual(response.status_code, 400)
        data = json.loads(response.data)
        
        self.assertFalse(data['success'])
        self.assertIn('æ‰‹æœºå·å·²å­˜åœ¨', data['message'])
    
    def test_get_health_stats(self):
        """æµ‹è¯•è·å–å¥åº·ç»Ÿè®¡æ•°æ®"""
        response = self.app.get('/api/health/stats?dimension=day&userId=1')
        
        self.assertEqual(response.status_code, 200)
        data = json.loads(response.data)
        
        # éªŒè¯å“åº”ç»“æ„
        self.assertIn('success', data)
        self.assertIn('data', data)

if __name__ == '__main__':
    unittest.main()
```

### 5.2 é›†æˆæµ‹è¯•

#### 5.2.1 ç«¯åˆ°ç«¯æµ‹è¯•

```python
# tests/test_integration.py
import unittest
import time
import json
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

class TestBigScreenIntegration(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        """æµ‹è¯•ç±»åˆå§‹åŒ–"""
        # å¯åŠ¨Chromeæµè§ˆå™¨
        chrome_options = webdriver.ChromeOptions()
        chrome_options.add_argument('--headless')  # æ— å¤´æ¨¡å¼
        chrome_options.add_argument('--no-sandbox')
        chrome_options.add_argument('--disable-dev-shm-usage')
        
        cls.driver = webdriver.Chrome(options=chrome_options)
        cls.driver.implicitly_wait(10)
        cls.wait = WebDriverWait(cls.driver, 10)
    
    @classmethod
    def tearDownClass(cls):
        """æµ‹è¯•ç±»æ¸…ç†"""
        cls.driver.quit()
    
    def test_main_page_load(self):
        """æµ‹è¯•ä¸»é¡µé¢åŠ è½½"""
        # è®¿é—®ä¸»é¡µ
        self.driver.get('http://localhost:5001/main?customerId=1939964806110937090')
        
        # ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        self.wait.until(EC.presence_of_element_located((By.CLASS_NAME, 'container')))
        
        # éªŒè¯å…³é”®å…ƒç´ å­˜åœ¨
        title = self.driver.find_element(By.TAG_NAME, 'h1')
        self.assertIn('æ™ºèƒ½å¥åº·æ•°æ®åˆ†æå¹³å°', title.text)
        
        # éªŒè¯å·¦ä¾§é¢æ¿
        stats_panel = self.driver.find_element(By.CLASS_NAME, 'stats-grid')
        self.assertIsNotNone(stats_panel)
        
        # éªŒè¯å³ä¾§é¢æ¿
        health_panel = self.driver.find_element(By.CLASS_NAME, 'health-analysis')
        self.assertIsNotNone(health_panel)
    
    def test_real_time_data_update(self):
        """æµ‹è¯•å®æ—¶æ•°æ®æ›´æ–°"""
        # è®¿é—®ä¸»é¡µ
        self.driver.get('http://localhost:5001/main?customerId=1939964806110937090')
        
        # ç­‰å¾…é¡µé¢å’ŒWebSocketè¿æ¥å»ºç«‹
        time.sleep(5)
        
        # è·å–åˆå§‹å¥åº·æ•°æ®è®¡æ•°
        health_count_element = self.wait.until(
            EC.presence_of_element_located((By.ID, 'healthDataCount'))
        )
        initial_count = health_count_element.text
        
        # æ¨¡æ‹Ÿå‘é€å¥åº·æ•°æ®ï¼ˆéœ€è¦é…åˆåç«¯APIï¼‰
        # è¿™é‡Œå¯ä»¥é€šè¿‡è°ƒç”¨APIæ¥è§¦å‘æ•°æ®æ›´æ–°
        
        # ç­‰å¾…æ•°æ®æ›´æ–°
        time.sleep(3)
        
        # éªŒè¯æ•°æ®æ˜¯å¦æ›´æ–°ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºæ£€æŸ¥å…ƒç´ ä»ç„¶å­˜åœ¨ï¼‰
        updated_count_element = self.driver.find_element(By.ID, 'healthDataCount')
        self.assertIsNotNone(updated_count_element)
    
    def test_filter_functionality(self):
        """æµ‹è¯•ç­›é€‰åŠŸèƒ½"""
        # è®¿é—®ä¸»é¡µ
        self.driver.get('http://localhost:5001/main?customerId=1939964806110937090')
        
        # ç­‰å¾…é¡µé¢åŠ è½½
        self.wait.until(EC.presence_of_element_located((By.ID, 'filterPanel')))
        
        # ç‚¹å‡»ç­›é€‰æŒ‰é’®
        filter_toggle = self.driver.find_element(By.ID, 'filterToggle')
        filter_toggle.click()
        
        # ç­‰å¾…ç­›é€‰é¢æ¿å±•å¼€
        time.sleep(1)
        
        # éªŒè¯ç­›é€‰é¢æ¿å·²å±•å¼€
        filter_panel = self.driver.find_element(By.ID, 'filterPanel')
        self.assertIn('expanded', filter_panel.get_attribute('class'))
        
        # æµ‹è¯•æœç´¢åŠŸèƒ½
        search_input = self.driver.find_element(By.ID, 'searchInput')
        search_input.send_keys('test')
        
        # éªŒè¯æœç´¢è¾“å…¥
        self.assertEqual(search_input.get_attribute('value'), 'test')

if __name__ == '__main__':
    # è¿è¡Œé›†æˆæµ‹è¯•å‰éœ€è¦ç¡®ä¿æœåŠ¡å·²å¯åŠ¨
    unittest.main()
```

### 5.3 æ€§èƒ½æµ‹è¯•

#### 5.3.1 APIæ€§èƒ½æµ‹è¯•

```python
# tests/test_performance.py
import unittest
import time
import concurrent.futures
import requests
from statistics import mean, median

class TestAPIPerformance(unittest.TestCase):
    
    def setUp(self):
        self.base_url = 'http://localhost:5001'
        self.test_endpoints = [
            '/api/users',
            '/api/health/stats',
            '/api/devices',
            '/api/alerts'
        ]
    
    def test_api_response_time(self):
        """æµ‹è¯•APIå“åº”æ—¶é—´"""
        for endpoint in self.test_endpoints:
            with self.subTest(endpoint=endpoint):
                response_times = []
                
                # è¿ç»­è¯·æ±‚10æ¬¡
                for _ in range(10):
                    start_time = time.time()
                    response = requests.get(f'{self.base_url}{endpoint}')
                    end_time = time.time()
                    
                    self.assertEqual(response.status_code, 200)
                    response_times.append((end_time - start_time) * 1000)  # è½¬æ¢ä¸ºæ¯«ç§’
                
                avg_time = mean(response_times)
                median_time = median(response_times)
                max_time = max(response_times)
                
                print(f'\n{endpoint} æ€§èƒ½ç»Ÿè®¡:')
                print(f'  å¹³å‡å“åº”æ—¶é—´: {avg_time:.2f}ms')
                print(f'  ä¸­ä½æ•°å“åº”æ—¶é—´: {median_time:.2f}ms')
                print(f'  æœ€å¤§å“åº”æ—¶é—´: {max_time:.2f}ms')
                
                # æ–­è¨€å“åº”æ—¶é—´åˆç†ï¼ˆæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é˜ˆå€¼ï¼‰
                self.assertLess(avg_time, 500, f'{endpoint} å¹³å‡å“åº”æ—¶é—´è¿‡é•¿')
                self.assertLess(max_time, 2000, f'{endpoint} æœ€å¤§å“åº”æ—¶é—´è¿‡é•¿')
    
    def test_concurrent_requests(self):
        """æµ‹è¯•å¹¶å‘è¯·æ±‚å¤„ç†èƒ½åŠ›"""
        endpoint = '/api/health/stats'
        concurrent_users = 50
        requests_per_user = 5
        
        def make_request():
            response_times = []
            for _ in range(requests_per_user):
                start_time = time.time()
                response = requests.get(f'{self.base_url}{endpoint}')
                end_time = time.time()
                
                response_times.append({
                    'status_code': response.status_code,
                    'response_time': (end_time - start_time) * 1000
                })
            return response_times
        
        # ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œå¹¶å‘è¯·æ±‚
        start_time = time.time()
        with concurrent.futures.ThreadPoolExecutor(max_workers=concurrent_users) as executor:
            futures = [executor.submit(make_request) for _ in range(concurrent_users)]
            results = [future.result() for future in concurrent.futures.as_completed(futures)]
        end_time = time.time()
        
        # ç»Ÿè®¡ç»“æœ
        all_response_times = []
        success_count = 0
        error_count = 0
        
        for user_results in results:
            for result in user_results:
                all_response_times.append(result['response_time'])
                if result['status_code'] == 200:
                    success_count += 1
                else:
                    error_count += 1
        
        total_requests = concurrent_users * requests_per_user
        total_time = end_time - start_time
        requests_per_second = total_requests / total_time
        
        print(f'\nå¹¶å‘æ€§èƒ½æµ‹è¯•ç»“æœ:')
        print(f'  æ€»è¯·æ±‚æ•°: {total_requests}')
        print(f'  æˆåŠŸè¯·æ±‚: {success_count}')
        print(f'  å¤±è´¥è¯·æ±‚: {error_count}')
        print(f'  æ€»è€—æ—¶: {total_time:.2f}s')
        print(f'  QPS: {requests_per_second:.2f}')
        print(f'  å¹³å‡å“åº”æ—¶é—´: {mean(all_response_times):.2f}ms')
        print(f'  95%åˆ†ä½å“åº”æ—¶é—´: {sorted(all_response_times)[int(len(all_response_times) * 0.95)]:.2f}ms')
        
        # æ–­è¨€æ€§èƒ½æŒ‡æ ‡
        self.assertGreater(requests_per_second, 20, 'QPSè¿‡ä½')
        self.assertLess(error_count / total_requests, 0.01, 'é”™è¯¯ç‡è¿‡é«˜')  # é”™è¯¯ç‡å°äº1%

if __name__ == '__main__':
    unittest.main()
```

## 6. éƒ¨ç½²æŒ‡å—

### 6.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²

```bash
# 1. ä½¿ç”¨Docker Composeå¿«é€Ÿå¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.dev.yml up -d

# 2. æˆ–è€…æ‰‹åŠ¨å¯åŠ¨å„æœåŠ¡
# å¯åŠ¨MySQL
docker run -d --name ljwx-mysql \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -e MYSQL_DATABASE=ljwx \
  -p 3306:3306 \
  mysql:8.0

# å¯åŠ¨Redis
docker run -d --name ljwx-redis \
  -p 6379:6379 \
  redis:7-alpine redis-server --requirepass 123456

# 3. åˆå§‹åŒ–æ•°æ®åº“
python manage.py db init
python manage.py db migrate
python manage.py db upgrade

# 4. å¯åŠ¨åº”ç”¨
python run.py
```

### 6.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 6.2.1 ä½¿ç”¨Dockeréƒ¨ç½²

```bash
# 1. æ„å»ºç”Ÿäº§é•œåƒ
docker build -f Dockerfile.multiarch -t ljwx-bigscreen:latest .

# 2. ä½¿ç”¨ç”Ÿäº§é…ç½®å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d

# 3. é…ç½®Nginxåå‘ä»£ç†
cat > nginx/bigscreen.conf << EOF
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    location /ws {
        proxy_pass http://127.0.0.1:5001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
    }
}
EOF
```

#### 6.2.2 ä½¿ç”¨Kuberneteséƒ¨ç½²

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ljwx-bigscreen
  namespace: ljwx-system
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ljwx-bigscreen
  template:
    metadata:
      labels:
        app: ljwx-bigscreen
    spec:
      containers:
      - name: ljwx-bigscreen
        image: your-registry.com/ljwx/ljwx-bigscreen:latest
        ports:
        - containerPort: 5001
        env:
        - name: MYSQL_HOST
          value: "ljwx-mysql-service"
        - name: REDIS_HOST
          value: "ljwx-redis-service"
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ljwx-secrets
              key: mysql-password
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 5001
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /api/health
            port: 5001
          initialDelaySeconds: 5
          periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: ljwx-bigscreen-service
  namespace: ljwx-system
spec:
  selector:
    app: ljwx-bigscreen
  ports:
  - port: 80
    targetPort: 5001
  type: ClusterIP
```

## 7. æœ€ä½³å®è·µ

### 7.1 ä»£ç è§„èŒƒ

#### 7.1.1 Pythonä»£ç è§„èŒƒ

```python
# 1. éµå¾ªPEP 8ä»£ç é£æ ¼
# 2. ä½¿ç”¨ç±»å‹æ³¨è§£
from typing import List, Dict, Optional, Union

def process_health_data(
    data: List[Dict[str, Union[int, float, str]]], 
    user_id: int,
    start_date: Optional[str] = None
) -> Dict[str, any]:
    """
    å¤„ç†å¥åº·æ•°æ®
    
    Args:
        data: å¥åº·æ•°æ®åˆ—è¡¨
        user_id: ç”¨æˆ·ID
        start_date: å¼€å§‹æ—¥æœŸï¼Œæ ¼å¼ä¸ºYYYY-MM-DD
        
    Returns:
        å¤„ç†ç»“æœå­—å…¸
        
    Raises:
        ValueError: å½“æ•°æ®æ ¼å¼ä¸æ­£ç¡®æ—¶
    """
    pass

# 3. ä½¿ç”¨æ–‡æ¡£å­—ç¬¦ä¸²
class HealthAnalyzer:
    """
    å¥åº·æ•°æ®åˆ†æå™¨
    
    è¯¥ç±»æä¾›å¥åº·æ•°æ®çš„åˆ†æå’Œè¯„åˆ†åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§å¥åº·æŒ‡æ ‡çš„è®¡ç®—ã€‚
    
    Attributes:
        metrics: æ”¯æŒçš„å¥åº·æŒ‡æ ‡é…ç½®
        customer_id: å®¢æˆ·IDï¼Œç”¨äºä¸ªæ€§åŒ–é…ç½®
    """
    
    def __init__(self, customer_id: str = None):
        """åˆå§‹åŒ–å¥åº·åˆ†æå™¨"""
        pass

# 4. å¼‚å¸¸å¤„ç†
try:
    result = process_dangerous_operation()
except SpecificException as e:
    logger.error(f"å¤„ç†å¤±è´¥: {e}")
    raise
except Exception as e:
    logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
    return default_result()
finally:
    cleanup_resources()

# 5. æ—¥å¿—è®°å½•
import logging

logger = logging.getLogger(__name__)

def process_data(data):
    logger.info(f"å¼€å§‹å¤„ç†æ•°æ®ï¼Œè®°å½•æ•°ï¼š{len(data)}")
    try:
        # å¤„ç†é€»è¾‘
        result = do_processing(data)
        logger.info(f"æ•°æ®å¤„ç†å®Œæˆï¼Œç»“æœè®°å½•æ•°ï¼š{len(result)}")
        return result
    except Exception as e:
        logger.error(f"æ•°æ®å¤„ç†å¤±è´¥ï¼š{e}", exc_info=True)
        raise
```

#### 7.1.2 JavaScriptä»£ç è§„èŒƒ

```javascript
// 1. ä½¿ç”¨ES6+è¯­æ³•
class ChartManager {
    constructor(containerId, options = {}) {
        this.containerId = containerId;
        this.options = { ...this.getDefaultOptions(), ...options };
        this.chart = null;
        this.isInitialized = false;
    }
    
    // 2. ä½¿ç”¨ç®­å¤´å‡½æ•°ä¿æŒä¸Šä¸‹æ–‡
    updateData = (data) => {
        if (!this.isInitialized) {
            this.initChart();
        }
        
        this.chart.setOption({
            series: [{
                data: this.processData(data)
            }]
        });
    }
    
    // 3. å¼‚æ­¥æ“ä½œä½¿ç”¨async/await
    async fetchData(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('è·å–æ•°æ®å¤±è´¥:', error);
            throw error;
        }
    }
    
    // 4. ä½¿ç”¨è§£æ„èµ‹å€¼
    processHealthData({ heart_rate, blood_oxygen, temperature, ...rest }) {
        return {
            heartRate: heart_rate || 0,
            bloodOxygen: blood_oxygen || 0,
            temperature: temperature || 0,
            ...rest
        };
    }
}

// 5. ä½¿ç”¨æ¨¡å—åŒ–
export { ChartManager };
export default ChartManager;
```

### 7.2 æ€§èƒ½ä¼˜åŒ–

#### 7.2.1 æ•°æ®åº“ä¼˜åŒ–

```python
# 1. ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
class UserHealthData(Base):
    __tablename__ = 't_user_health_data'
    
    # å¤åˆç´¢å¼•
    __table_args__ = (
        Index('idx_user_timestamp', 'user_id', 'timestamp'),
        Index('idx_device_timestamp', 'device_sn', 'timestamp'),
    )

# 2. æ‰¹é‡æ“ä½œ
def batch_insert_health_data(data_list: List[Dict]) -> int:
    """æ‰¹é‡æ’å…¥å¥åº·æ•°æ®"""
    if not data_list:
        return 0
    
    # ä½¿ç”¨SQLAlchemyçš„bulk_insert_mappings
    db.session.bulk_insert_mappings(UserHealthData, data_list)
    db.session.commit()
    
    return len(data_list)

# 3. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
def get_health_data_paginated(
    user_id: int, 
    page: int = 1, 
    size: int = 20,
    use_cursor: bool = False
) -> Dict:
    """åˆ†é¡µè·å–å¥åº·æ•°æ®ï¼ˆæ”¯æŒæ¸¸æ ‡åˆ†é¡µï¼‰"""
    
    if use_cursor and page > 1:
        # ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µé¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜
        cursor_id = request.args.get('cursor_id')
        query = UserHealthData.query.filter(
            UserHealthData.user_id == user_id,
            UserHealthData.id > cursor_id
        ).order_by(UserHealthData.id).limit(size)
    else:
        # æ™®é€šåˆ†é¡µ
        query = UserHealthData.query.filter_by(user_id=user_id)
        query = query.order_by(UserHealthData.timestamp.desc())
        query = query.paginate(page=page, per_page=size, error_out=False)
    
    return format_pagination_result(query)

# 4. æŸ¥è¯¢ä¼˜åŒ–
def get_user_latest_health_data_optimized(org_id: int) -> List[Dict]:
    """ä¼˜åŒ–çš„ç”¨æˆ·æœ€æ–°å¥åº·æ•°æ®æŸ¥è¯¢"""
    
    # å­æŸ¥è¯¢è·å–æ¯ä¸ªç”¨æˆ·çš„æœ€æ–°æ—¶é—´æˆ³
    subquery = db.session.query(
        UserHealthData.user_id,
        func.max(UserHealthData.timestamp).label('max_timestamp')
    ).join(UserInfo).filter(
        UserInfo.org_id == org_id
    ).group_by(UserHealthData.user_id).subquery()
    
    # ä¸»æŸ¥è¯¢å…³è”è·å–å®Œæ•´æ•°æ®
    result = db.session.query(UserHealthData).join(
        subquery,
        and_(
            UserHealthData.user_id == subquery.c.user_id,
            UserHealthData.timestamp == subquery.c.max_timestamp
        )
    ).all()
    
    return [data.to_dict() for data in result]
```

#### 7.2.2 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```javascript
// 1. é˜²æŠ–å’ŒèŠ‚æµ
class PerformanceUtils {
    // é˜²æŠ–å‡½æ•°
    static debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // èŠ‚æµå‡½æ•°
    static throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }
}

// 2. è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§æ•°æ®åˆ—è¡¨ï¼‰
class VirtualScrollList {
    constructor(container, itemHeight, data) {
        this.container = container;
        this.itemHeight = itemHeight;
        this.data = data;
        this.visibleCount = Math.ceil(container.clientHeight / itemHeight) + 1;
        this.startIndex = 0;
        
        this.init();
    }
    
    init() {
        // åˆ›å»ºè™šæ‹Ÿå®¹å™¨
        this.scrollContainer = document.createElement('div');
        this.scrollContainer.style.height = this.data.length * this.itemHeight + 'px';
        this.scrollContainer.style.position = 'relative';
        
        // åˆ›å»ºå¯è§å†…å®¹å®¹å™¨
        this.visibleContainer = document.createElement('div');
        this.visibleContainer.style.position = 'absolute';
        this.visibleContainer.style.top = '0';
        this.visibleContainer.style.width = '100%';
        
        this.scrollContainer.appendChild(this.visibleContainer);
        this.container.appendChild(this.scrollContainer);
        
        // ç»‘å®šæ»šåŠ¨äº‹ä»¶
        this.container.addEventListener('scroll', 
            PerformanceUtils.throttle(() => this.handleScroll(), 16)
        );
        
        this.renderVisibleItems();
    }
    
    handleScroll() {
        const scrollTop = this.container.scrollTop;
        const newStartIndex = Math.floor(scrollTop / this.itemHeight);
        
        if (newStartIndex !== this.startIndex) {
            this.startIndex = newStartIndex;
            this.renderVisibleItems();
        }
    }
    
    renderVisibleItems() {
        const endIndex = Math.min(
            this.startIndex + this.visibleCount,
            this.data.length
        );
        
        // æ¸…ç©ºå®¹å™¨
        this.visibleContainer.innerHTML = '';
        
        // æ¸²æŸ“å¯è§é¡¹
        for (let i = this.startIndex; i < endIndex; i++) {
            const item = this.createItem(this.data[i], i);
            item.style.position = 'absolute';
            item.style.top = i * this.itemHeight + 'px';
            item.style.height = this.itemHeight + 'px';
            this.visibleContainer.appendChild(item);
        }
    }
    
    createItem(data, index) {
        const item = document.createElement('div');
        item.textContent = `Item ${index}: ${data.name}`;
        return item;
    }
}

// 3. å›¾è¡¨ä¼˜åŒ–
class OptimizedChart {
    constructor(containerId) {
        this.chart = echarts.init(document.getElementById(containerId));
        this.updateQueue = [];
        this.isUpdating = false;
        
        // æ‰¹é‡æ›´æ–°
        this.batchUpdate = PerformanceUtils.debounce(() => {
            this.processBatchUpdate();
        }, 100);
    }
    
    updateData(data) {
        this.updateQueue.push(data);
        this.batchUpdate();
    }
    
    processBatchUpdate() {
        if (this.isUpdating || this.updateQueue.length === 0) {
            return;
        }
        
        this.isUpdating = true;
        
        // åˆå¹¶æ‰€æœ‰å¾…æ›´æ–°æ•°æ®
        const mergedData = this.mergeUpdateData(this.updateQueue);
        this.updateQueue = [];
        
        // ä½¿ç”¨requestAnimationFrameç¡®ä¿åœ¨åˆé€‚æ—¶æœºæ›´æ–°
        requestAnimationFrame(() => {
            this.chart.setOption(mergedData, false, true); // ä¸åˆå¹¶ã€é™é»˜æ›´æ–°
            this.isUpdating = false;
        });
    }
    
    mergeUpdateData(dataList) {
        // å®ç°æ•°æ®åˆå¹¶é€»è¾‘
        return dataList[dataList.length - 1]; // ç®€åŒ–ï¼šä½¿ç”¨æœ€æ–°æ•°æ®
    }
}
```

### 7.3 å®‰å…¨æœ€ä½³å®è·µ

#### 7.3.1 APIå®‰å…¨

```python
from functools import wraps
from flask import request, jsonify
from werkzeug.security import check_password_hash
import jwt
import time

# 1. APIè®¤è¯è£…é¥°å™¨
def require_auth(f):
    @wraps(f)
    def wrapper(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'error': 'Missing authorization token'}), 401
        
        try:
            if token.startswith('Bearer '):
                token = token[7:]
            
            payload = jwt.decode(token, app.config['SECRET_KEY'], algorithms=['HS256'])
            current_user = UserInfo.query.get(payload['user_id'])
            if not current_user:
                return jsonify({'error': 'Invalid token'}), 401
                
            request.current_user = current_user
            
        except jwt.ExpiredSignatureError:
            return jsonify({'error': 'Token expired'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'error': 'Invalid token'}), 401
        
        return f(*args, **kwargs)
    return wrapper

# 2. æƒé™éªŒè¯è£…é¥°å™¨
def require_permission(permission):
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            if not hasattr(request, 'current_user'):
                return jsonify({'error': 'Authentication required'}), 401
            
            if not request.current_user.has_permission(permission):
                return jsonify({'error': 'Insufficient permissions'}), 403
            
            return f(*args, **kwargs)
        return wrapper
    return decorator

# 3. é€Ÿç‡é™åˆ¶
from collections import defaultdict, deque

class RateLimiter:
    def __init__(self):
        self.requests = defaultdict(deque)
    
    def is_allowed(self, key, limit=100, window=3600):
        now = time.time()
        # æ¸…ç†è¿‡æœŸè¯·æ±‚
        while self.requests[key] and self.requests[key][0] < now - window:
            self.requests[key].popleft()
        
        if len(self.requests[key]) >= limit:
            return False
        
        self.requests[key].append(now)
        return True

rate_limiter = RateLimiter()

def rate_limit(limit=100, window=3600):
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            client_ip = request.remote_addr
            if not rate_limiter.is_allowed(client_ip, limit, window):
                return jsonify({'error': 'Rate limit exceeded'}), 429
            return f(*args, **kwargs)
        return wrapper
    return decorator

# 4. è¾“å…¥éªŒè¯
from marshmallow import Schema, fields, ValidationError

class UserCreateSchema(Schema):
    user_name = fields.Str(required=True, validate=Length(min=1, max=100))
    phone = fields.Str(required=True, validate=Regexp(r'^\d{11}$'))
    email = fields.Email(required=False)
    org_id = fields.Int(required=False)

def validate_input(schema_class):
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            schema = schema_class()
            try:
                data = schema.load(request.get_json() or {})
                request.validated_data = data
            except ValidationError as err:
                return jsonify({'error': 'Validation failed', 'details': err.messages}), 400
            return f(*args, **kwargs)
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@app.route('/api/users', methods=['POST'])
@rate_limit(limit=10, window=60)  # æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡è¯·æ±‚
@require_auth
@require_permission('create_user')
@validate_input(UserCreateSchema)
def create_user():
    data = request.validated_data
    # å®‰å…¨çš„ç”¨æˆ·åˆ›å»ºé€»è¾‘
    user = UserInfo.create_user(data)
    return jsonify(user.to_dict())
```

## 8. æ•…éšœæ’æŸ¥

### 8.1 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 8.1.1 æ€§èƒ½é—®é¢˜

**é—®é¢˜ï¼šé¡µé¢åŠ è½½ç¼“æ…¢**

```bash
# 1. æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
# å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
mysql> SET GLOBAL slow_query_log = 'ON';
mysql> SET GLOBAL long_query_time = 1;

# 2. æ£€æŸ¥Redisè¿æ¥
redis-cli ping

# 3. æ£€æŸ¥åº”ç”¨è¿›ç¨‹çŠ¶æ€
ps aux | grep python
top -p <pid>

# 4. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
ping <database_host>
telnet <redis_host> 6379
```

**è§£å†³æ–¹æ¡ˆï¼š**

```python
# 1. æ·»åŠ æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—
import logging
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)

# 2. ä¼˜åŒ–æŸ¥è¯¢
# æ·»åŠ ç¼ºå¤±ç´¢å¼•
ALTER TABLE t_user_health_data ADD INDEX idx_user_timestamp (user_id, timestamp);

# 3. å¯ç”¨æŸ¥è¯¢ç¼“å­˜
app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {
    'pool_pre_ping': True,
    'pool_recycle': 300,
    'echo': False  # ç”Ÿäº§ç¯å¢ƒå…³é—­
}
```

#### 8.1.2 å†…å­˜æ³„æ¼

**é—®é¢˜æ£€æµ‹ï¼š**

```python
# memory_monitor.py
import psutil
import time
import logging

def monitor_memory():
    process = psutil.Process()
    
    while True:
        memory_info = process.memory_info()
        memory_percent = process.memory_percent()
        
        logging.info(f"Memory usage: {memory_info.rss / 1024 / 1024:.2f} MB ({memory_percent:.2f}%)")
        
        if memory_percent > 80:  # å†…å­˜ä½¿ç”¨è¶…è¿‡80%
            logging.warning("High memory usage detected!")
            
            # è·å–å†…å­˜ä½¿ç”¨è¯¦æƒ…
            for child in process.children(recursive=True):
                child_memory = child.memory_info()
                logging.info(f"Child process {child.pid}: {child_memory.rss / 1024 / 1024:.2f} MB")
        
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

# å¯åŠ¨ç›‘æ§
monitor_memory()
```

**è§£å†³æ–¹æ¡ˆï¼š**

```python
# 1. åŠæ—¶å…³é—­æ•°æ®åº“è¿æ¥
from contextlib import contextmanager

@contextmanager
def get_db_session():
    session = db.session
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()

# ä½¿ç”¨ç¤ºä¾‹
def get_user_data(user_id):
    with get_db_session() as session:
        return session.query(UserInfo).filter_by(id=user_id).first()

# 2. å®šæœŸæ¸…ç†ç¼“å­˜
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

@scheduler.job(trigger='interval', hours=6)
def cleanup_cache():
    # æ¸…ç†è¿‡æœŸçš„Redisé”®
    redis.execute_command('EVAL', '''
        local keys = redis.call('keys', KEYS[1])
        local deleted = 0
        for i=1,#keys do
            if redis.call('ttl', keys[i]) == -1 then
                redis.call('del', keys[i])
                deleted = deleted + 1
            end
        end
        return deleted
    ''', 1, 'temp:*')

scheduler.start()
```

### 8.2 è°ƒè¯•å·¥å…·

#### 8.2.1 æ—¥å¿—åˆ†æè„šæœ¬

```python
#!/usr/bin/env python3
# log_analyzer.py
import re
import sys
from collections import defaultdict, Counter
from datetime import datetime

class LogAnalyzer:
    def __init__(self, log_file):
        self.log_file = log_file
        self.error_patterns = [
            r'ERROR.*',
            r'CRITICAL.*',
            r'Exception.*',
            r'Traceback.*'
        ]
        self.performance_pattern = r'(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}).*å“åº”æ—¶é—´: ([\d.]+)ms'
    
    def analyze_errors(self):
        error_counts = Counter()
        error_details = defaultdict(list)
        
        with open(self.log_file, 'r') as f:
            for line_no, line in enumerate(f, 1):
                for pattern in self.error_patterns:
                    if re.search(pattern, line):
                        error_type = re.search(pattern, line).group(0)
                        error_counts[error_type] += 1
                        error_details[error_type].append((line_no, line.strip()))
        
        print("=== é”™è¯¯ç»Ÿè®¡ ===")
        for error, count in error_counts.most_common():
            print(f"{error}: {count} æ¬¡")
            # æ˜¾ç¤ºå‰3ä¸ªé”™è¯¯è¯¦æƒ…
            for i, (line_no, detail) in enumerate(error_details[error][:3]):
                print(f"  L{line_no}: {detail}")
            if len(error_details[error]) > 3:
                print(f"  ... è¿˜æœ‰ {len(error_details[error]) - 3} ä¸ª")
            print()
    
    def analyze_performance(self):
        response_times = []
        slow_requests = []
        
        with open(self.log_file, 'r') as f:
            for line_no, line in enumerate(f, 1):
                match = re.search(self.performance_pattern, line)
                if match:
                    timestamp = match.group(1)
                    response_time = float(match.group(2))
                    response_times.append(response_time)
                    
                    if response_time > 1000:  # è¶…è¿‡1ç§’çš„æ…¢è¯·æ±‚
                        slow_requests.append((timestamp, response_time, line.strip()))
        
        if response_times:
            print("=== æ€§èƒ½ç»Ÿè®¡ ===")
            print(f"æ€»è¯·æ±‚æ•°: {len(response_times)}")
            print(f"å¹³å‡å“åº”æ—¶é—´: {sum(response_times) / len(response_times):.2f}ms")
            print(f"æœ€å¤§å“åº”æ—¶é—´: {max(response_times):.2f}ms")
            print(f"æœ€å°å“åº”æ—¶é—´: {min(response_times):.2f}ms")
            
            # ç™¾åˆ†ä½æ•°
            sorted_times = sorted(response_times)
            p95_index = int(len(sorted_times) * 0.95)
            p99_index = int(len(sorted_times) * 0.99)
            print(f"95%åˆ†ä½å“åº”æ—¶é—´: {sorted_times[p95_index]:.2f}ms")
            print(f"99%åˆ†ä½å“åº”æ—¶é—´: {sorted_times[p99_index]:.2f}ms")
            
            print(f"\næ…¢è¯·æ±‚æ•°é‡: {len(slow_requests)}")
            for timestamp, response_time, detail in slow_requests[:5]:
                print(f"  {timestamp}: {response_time:.2f}ms - {detail}")
    
    def generate_report(self):
        print("LJWX-BigScreen æ—¥å¿—åˆ†ææŠ¥å‘Š")
        print("=" * 50)
        print(f"åˆ†ææ–‡ä»¶: {self.log_file}")
        print(f"åˆ†ææ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
        
        self.analyze_errors()
        self.analyze_performance()

if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Usage: python log_analyzer.py <log_file>")
        sys.exit(1)
    
    analyzer = LogAnalyzer(sys.argv[1])
    analyzer.generate_report()
```

#### 8.2.2 æ•°æ®åº“æ€§èƒ½ç›‘æ§

```python
# db_monitor.py
import time
import pymysql
from datetime import datetime

class DatabaseMonitor:
    def __init__(self, host, user, password, database):
        self.connection_config = {
            'host': host,
            'user': user,
            'password': password,
            'database': database,
            'charset': 'utf8mb4'
        }
    
    def get_connection(self):
        return pymysql.connect(**self.connection_config)
    
    def check_slow_queries(self):
        """æ£€æŸ¥æ…¢æŸ¥è¯¢"""
        connection = self.get_connection()
        cursor = connection.cursor()
        
        # è·å–æ…¢æŸ¥è¯¢è®¾ç½®
        cursor.execute("SHOW VARIABLES LIKE 'slow_query_log'")
        slow_log_status = cursor.fetchone()[1]
        
        cursor.execute("SHOW VARIABLES LIKE 'long_query_time'")
        long_query_time = cursor.fetchone()[1]
        
        print(f"æ…¢æŸ¥è¯¢æ—¥å¿—çŠ¶æ€: {slow_log_status}")
        print(f"æ…¢æŸ¥è¯¢é˜ˆå€¼: {long_query_time}ç§’")
        
        # è·å–æ…¢æŸ¥è¯¢ç»Ÿè®¡
        cursor.execute("SHOW GLOBAL STATUS LIKE 'Slow_queries'")
        slow_queries = cursor.fetchone()[1]
        print(f"æ…¢æŸ¥è¯¢æ•°é‡: {slow_queries}")
        
        connection.close()
    
    def check_connection_status(self):
        """æ£€æŸ¥è¿æ¥çŠ¶æ€"""
        connection = self.get_connection()
        cursor = connection.cursor()
        
        queries = [
            ("å½“å‰è¿æ¥æ•°", "SHOW STATUS LIKE 'Threads_connected'"),
            ("æœ€å¤§è¿æ¥æ•°", "SHOW VARIABLES LIKE 'max_connections'"),
            ("è¿è¡Œä¸­çš„çº¿ç¨‹", "SHOW STATUS LIKE 'Threads_running'"),
            ("å†å²æœ€å¤§è¿æ¥æ•°", "SHOW STATUS LIKE 'Max_used_connections'")
        ]
        
        print("\n=== è¿æ¥çŠ¶æ€ ===")
        for name, query in queries:
            cursor.execute(query)
            result = cursor.fetchone()[1]
            print(f"{name}: {result}")
        
        connection.close()
    
    def check_table_status(self, table_name='t_user_health_data'):
        """æ£€æŸ¥è¡¨çŠ¶æ€"""
        connection = self.get_connection()
        cursor = connection.cursor()
        
        cursor.execute(f"SHOW TABLE STATUS LIKE '{table_name}'")
        result = cursor.fetchone()
        
        if result:
            print(f"\n=== è¡¨ {table_name} çŠ¶æ€ ===")
            print(f"è¡Œæ•°: {result[4]}")
            print(f"æ•°æ®å¤§å°: {result[6] / 1024 / 1024:.2f} MB")
            print(f"ç´¢å¼•å¤§å°: {result[8] / 1024 / 1024:.2f} MB")
            print(f"å¹³å‡è¡Œé•¿åº¦: {result[5]} bytes")
        
        # æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
        cursor.execute(f"SHOW INDEX FROM {table_name}")
        indexes = cursor.fetchall()
        
        print(f"\nè¡¨ {table_name} ç´¢å¼•:")
        for index in indexes:
            print(f"  {index[2]}: {index[4]} (å”¯ä¸€æ€§: {index[1]})")
        
        connection.close()
    
    def monitor_continuously(self, interval=300):
        """æŒç»­ç›‘æ§ï¼ˆæ¯5åˆ†é’Ÿä¸€æ¬¡ï¼‰"""
        print(f"å¼€å§‹æŒç»­ç›‘æ§ï¼Œé—´éš”: {interval}ç§’")
        
        while True:
            try:
                print(f"\n{'='*20} {datetime.now()} {'='*20}")
                self.check_slow_queries()
                self.check_connection_status()
                self.check_table_status()
                
                time.sleep(interval)
                
            except KeyboardInterrupt:
                print("\nç›‘æ§å·²åœæ­¢")
                break
            except Exception as e:
                print(f"ç›‘æ§é”™è¯¯: {e}")
                time.sleep(60)  # å‡ºé”™æ—¶ç­‰å¾…1åˆ†é’Ÿå†é‡è¯•

if __name__ == '__main__':
    monitor = DatabaseMonitor(
        host='localhost',
        user='root', 
        password='123456',
        database='ljwx'
    )
    
    # å•æ¬¡æ£€æŸ¥
    monitor.check_slow_queries()
    monitor.check_connection_status()
    monitor.check_table_status()
    
    # æŒç»­ç›‘æ§ï¼ˆå¯é€‰ï¼‰
    # monitor.monitor_continuously()
```

## 9. æ€»ç»“

æœ¬äºŒæ¬¡å¼€å‘æ–‡æ¡£æä¾›äº†LJWX-BigScreenå¹³å°çš„å…¨é¢å¼€å‘æŒ‡å—ï¼Œæ¶µç›–äº†ä»ç¯å¢ƒæ­å»ºåˆ°ç”Ÿäº§éƒ¨ç½²çš„å®Œæ•´æµç¨‹ã€‚å¼€å‘è€…å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚å‚è€ƒç›¸åº”ç« èŠ‚è¿›è¡Œå¼€å‘ã€‚

### å…³é”®è¦ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šç³»ç»Ÿé‡‡ç”¨è‰¯å¥½çš„æ¨¡å—åŒ–æ¶æ„ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæä¾›äº†å¤šå±‚æ¬¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å’Œç›‘æ§æ–¹æ¡ˆ
3. **å®‰å…¨æœºåˆ¶**ï¼šå®ç°äº†å®Œæ•´çš„è®¤è¯ã€æˆæƒå’Œæ•°æ®ä¿æŠ¤æœºåˆ¶
4. **æµ‹è¯•è¦†ç›–**ï¼šåŒ…å«å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•çš„å®Œæ•´æµ‹è¯•ä½“ç³»
5. **è¿ç»´å‹å¥½**ï¼šæä¾›äº†è¯¦ç»†çš„éƒ¨ç½²æŒ‡å—å’Œæ•…éšœæ’æŸ¥å·¥å…·

### åç»­å‘å±•

- **å¾®æœåŠ¡åŒ–**ï¼šå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€æ­¥æ‹†åˆ†ä¸ºå¾®æœåŠ¡æ¶æ„
- **AIå¢å¼º**ï¼šé›†æˆæ›´å¤šæœºå™¨å­¦ä¹ ç®—æ³•æå‡å¥åº·åˆ†æèƒ½åŠ›
- **ç§»åŠ¨ç«¯æ”¯æŒ**ï¼šå¼€å‘ç§»åŠ¨ç«¯åº”ç”¨æ‰©å±•ä½¿ç”¨åœºæ™¯
- **å›½é™…åŒ–**ï¼šæ”¯æŒå¤šè¯­è¨€å’Œå¤šåœ°åŒºéƒ¨ç½²

å¼€å‘è¿‡ç¨‹ä¸­å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯å›¢é˜Ÿè·å–æ”¯æŒã€‚