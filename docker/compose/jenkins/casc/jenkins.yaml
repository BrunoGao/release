jenkins:
  systemMessage: |
    ğŸš€ Jenkins CI/CD å¿«é€Ÿè‡ªåŠ¨åŒ–éƒ¨ç½²
    ğŸ“… éƒ¨ç½²æ—¶é—´: 2024-08-24
    ğŸ”§ é€‚é…ç°æœ‰ç¯å¢ƒ: Registry(localhost:35001), Gitea(192.168.1.6:3000)
    
  numExecutors: 4
  mode: NORMAL
  quietPeriod: 5
  
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "admin"
          password: "admin123"
          
  authorizationStrategy:
    globalMatrix:
      permissions:
        - "Overall/Administer:admin"
        - "Overall/Read:authenticated"
        - "Job/Build:authenticated"
        - "Job/Read:authenticated"
        - "Job/Configure:authenticated"
        - "Job/Create:authenticated"
        - "Job/Delete:authenticated"
        
  globalNodeProperties:
    - envVars:
        env:
          - key: "DOCKER_REGISTRY"
            value: "localhost:35001"
          - key: "GITEA_URL" 
            value: "http://192.168.1.6:3000"
          - key: "BUILD_PLATFORMS"
            value: "linux/amd64,linux/arm64"

tool:
  git:
    installations:
      - name: "Default"
        home: "/usr/bin/git"
  
  jdk:
    installations:
      - name: "JDK-17"
        home: "/opt/java/openjdk"

credentials:
  system:
    domainCredentials:
      - credentials:
          - string:
              scope: GLOBAL
              id: "gitea-api-token"
              description: "Gitea API Token - è¯·åœ¨Giteaä¸­ç”Ÿæˆåæ›´æ–°"
              secret: "changeme-please-update-with-real-token"
              
          - usernamePassword:
              scope: GLOBAL
              id: "docker-registry-auth"
              description: "Docker Registry è®¤è¯"
              username: "admin"
              password: "admin123"

unclassified:
  location:
    url: "http://localhost:8081/"
    adminAddress: "admin@example.com"
    
  csrf:
    defaultCrumbIssuer:
      excludeClientIPFromCrumb: false

jobs:
  - script: >
      pipelineJob('hello-world-demo') {
        displayName('Hello World æ¼”ç¤º')
        description('éªŒè¯ Jenkins è‡ªåŠ¨åŒ–é…ç½®')
        
        definition {
          cps {
            script('''
              pipeline {
                  agent any
                  
                  stages {
                      stage('Hello Jenkins') {
                          steps {
                              echo "ğŸ‰ Jenkins è‡ªåŠ¨åŒ–é…ç½®æˆåŠŸï¼"
                              echo "ğŸ“ Docker Registry: localhost:35001"
                              echo "ğŸ“ Gitea URL: http://192.168.1.6:3000"
                              echo "ğŸ”¨ æ”¯æŒå¹³å°: linux/amd64,linux/arm64"
                              
                              script {
                                  def dockerVersion = sh(
                                      script: 'docker --version',
                                      returnStdout: true
                                  ).trim()
                                  echo "ğŸ³ Docker ç‰ˆæœ¬: ${dockerVersion}"
                              }
                          }
                      }
                      
                      stage('ç¯å¢ƒæ£€æŸ¥') {
                          steps {
                              echo "ğŸ” æ£€æŸ¥æœåŠ¡è¿æ¥..."
                              
                              script {
                                  // æ£€æŸ¥ Registry è¿æ¥
                                  def registryCheck = sh(
                                      script: 'curl -s -o /dev/null -w "%{http_code}" http://localhost:35001/v2/ || echo "failed"',
                                      returnStdout: true
                                  ).trim()
                                  
                                  if (registryCheck == "200") {
                                      echo "âœ… Registry è¿æ¥æ­£å¸¸"
                                  } else {
                                      echo "âš ï¸ Registry è¿æ¥çŠ¶æ€: ${registryCheck}"
                                  }
                                  
                                  // æ£€æŸ¥ Gitea è¿æ¥
                                  def giteaCheck = sh(
                                      script: 'curl -s -o /dev/null -w "%{http_code}" http://192.168.1.6:3000/api/v1/version || echo "failed"',
                                      returnStdout: true
                                  ).trim()
                                  
                                  if (giteaCheck == "200") {
                                      echo "âœ… Gitea è¿æ¥æ­£å¸¸"
                                  } else {
                                      echo "âš ï¸ Gitea è¿æ¥çŠ¶æ€: ${giteaCheck}"
                                  }
                              }
                          }
                      }
                  }
                  
                  post {
                      always {
                          echo "ğŸŠ Jenkins å¿«é€Ÿéƒ¨ç½²éªŒè¯å®Œæˆï¼"
                      }
                      success {
                          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œç¯å¢ƒå°±ç»ªï¼"
                      }
                  }
              }
            ''')
            sandbox()
          }
        }
      }
