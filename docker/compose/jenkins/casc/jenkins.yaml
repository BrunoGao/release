# Jenkinsæœ€ä½³å®è·µå®Œæ•´é…ç½®
jenkins:
  systemMessage: |
    ğŸš€ Jenkins CI/CDæœåŠ¡å™¨ - å®Œå…¨è‡ªåŠ¨åŒ–é…ç½®
    ğŸ“… é…ç½®æ—¶é—´: $(date)
    ğŸ”§ è‡ªåŠ¨é…ç½®: å·¥å…·ã€æ’ä»¶ã€äº‘ã€å‡­æ®
    ğŸ“š ç®¡ç†æ–‡æ¡£: docs/jenkins-persistence-guide.md
    
  numExecutors: 6
  mode: NORMAL
  scmCheckoutRetryCount: 3
  quietPeriod: 5
  
  # ===== å®‰å…¨é…ç½® =====
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "${JENKINS_ADMIN_ID:-admin}"
          password: "${JENKINS_ADMIN_PASSWORD:-admin123}"
          
  authorizationStrategy:
    globalMatrix:
      permissions:
        - "Overall/Administer:admin"
        - "Overall/Read:authenticated"
        - "Overall/SystemRead:authenticated"
        - "Job/Build:authenticated"
        - "Job/Read:authenticated"
        - "Job/Workspace:authenticated"
        - "Job/Configure:authenticated"
        - "Job/Create:authenticated"
        - "Job/Delete:authenticated"
        - "Job/Move:authenticated"
        - "View/Read:authenticated"
        - "View/Create:authenticated"
        - "View/Configure:authenticated"
        
  # ===== å…¨å±€å±æ€§ =====
  globalNodeProperties:
    - envVars:
        env:
          - key: "DOCKER_REGISTRY"
            value: "${DOCKER_REGISTRY:-localhost:5001}"
          - key: "GITEA_URL"
            value: "${GITEA_URL:-http://gitea:3000}"
          - key: "KUBERNETES_MASTER_URL"
            value: "${KUBERNETES_MASTER_URL:-https://kubernetes.docker.internal:6443}"
          - key: "CI_ENVIRONMENT"
            value: "development"
          - key: "BUILD_PLATFORMS"
            value: "linux/amd64,linux/arm64"
            
  # ===== æ„å»ºä¿ç•™ç­–ç•¥ =====
  buildDiscarders:
    - buildDiscarder:
        strategy:
          logRotator:
            daysToKeepStr: "30"
            numToKeepStr: "100"
            artifactDaysToKeepStr: "7"
            artifactNumToKeepStr: "20"

# ===== å·¥å…·é…ç½® =====
tool:
  # Gité…ç½®
  git:
    installations:
      - name: "Default"
        home: "/usr/bin/git"
      - name: "Git-2.40"
        home: "/usr/bin/git"
        
  # JDKé…ç½®
  jdk:
    installations:
      - name: "JDK-21"
        home: "/opt/java/openjdk"
      - name: "JDK-17"
        properties:
          - installSource:
              installers:
                - jdkInstaller:
                    id: "jdk-17.0.8+101"
      - name: "JDK-11"
        properties:
          - installSource:
              installers:
                - jdkInstaller:
                    id: "jdk-11.0.20+101"
        
  # Mavené…ç½®
  maven:
    installations:
      - name: "Maven-3.9"
        properties:
          - installSource:
              installers:
                - maven:
                    id: "3.9.6"
      - name: "Maven-3.8"
        properties:
          - installSource:
              installers:
                - maven:
                    id: "3.8.8"
        
  # Gradleé…ç½®
  gradle:
    installations:
      - name: "Gradle-8"
        properties:
          - installSource:
              installers:
                - gradleInstaller:
                    id: "8.5"
      - name: "Gradle-7"
        properties:
          - installSource:
              installers:
                - gradleInstaller:
                    id: "7.6.4"
                    
  # Node.jsé…ç½®
  nodejs:
    installations:
      - name: "NodeJS-20"
        properties:
          - installSource:
              installers:
                - nodeJSInstaller:
                    id: "20.10.0"
                    npmPackagesRefreshHours: 72
      - name: "NodeJS-18"
        properties:
          - installSource:
              installers:
                - nodeJSInstaller:
                    id: "18.19.0"
                    npmPackagesRefreshHours: 72
                    
  # Dockeré…ç½®
  dockerTool:
    installations:
      - name: "Docker"
        home: "/usr/local/bin/docker"
      - name: "Docker-Latest"
        properties:
          - installSource:
              installers:
                - dockerInstaller:
                    version: "latest"
                    
  # Pythoné…ç½®
  python:
    installations:
      - name: "Python-3.11"
        properties:
          - installSource:
              installers:
                - command:
                    command: "/usr/bin/python3"
      - name: "Python-3.9"
        properties:
          - installSource:
              installers:
                - command:
                    command: "/usr/bin/python3.9"

# ===== å‡­æ®é…ç½® =====
credentials:
  system:
    domainCredentials:
      - credentials:
          # Giteaé›†æˆå‡­æ®
          - string:
              scope: GLOBAL
              id: "gitea-api-token"
              description: "Gitea APIè®¿é—®ä»¤ç‰Œ"
              secret: "${GITEA_TOKEN:-changeme-gitea-token}"
              
          # Docker Registryå‡­æ®
          - usernamePassword:
              scope: GLOBAL
              id: "docker-registry-auth"
              description: "Docker Registryè®¤è¯"
              username: "${REGISTRY_USERNAME:-admin}"
              password: "${REGISTRY_PASSWORD:-admin123}"
              
          # Docker Hubå‡­æ®
          - usernamePassword:
              scope: GLOBAL
              id: "dockerhub-auth"
              description: "Docker Hubè®¤è¯"
              username: "${DOCKERHUB_USERNAME:-your-username}"
              password: "${DOCKERHUB_PASSWORD:-your-password}"
              
          # SSHå¯†é’¥
          - basicSSHUserPrivateKey:
              scope: GLOBAL
              id: "ssh-key-git"
              description: "Git SSHè®¿é—®å¯†é’¥"
              username: "git"
              privateKeySource:
                directEntry:
                  privateKey: |
                    -----BEGIN OPENSSH PRIVATE KEY-----
                    # è¿™é‡Œåº”è¯¥æ”¾ç½®å®é™…çš„SSHç§é’¥å†…å®¹
                    # ç”Ÿæˆæ–¹æ³•: ssh-keygen -t ed25519 -C "jenkins@example.com"
                    -----END OPENSSH PRIVATE KEY-----
                    
          # Kubernetesé…ç½®
          - string:
              scope: GLOBAL
              id: "k8s-config"
              description: "Kubernetesé…ç½®æ–‡ä»¶"
              secret: "${K8S_CONFIG:-changeme-k8s-config}"
              
          # äº‘å¹³å°å‡­æ®æ¨¡æ¿
          - string:
              scope: GLOBAL
              id: "aws-access-key"
              description: "AWSè®¿é—®å¯†é’¥"
              secret: "${AWS_ACCESS_KEY:-changeme-aws-key}"
              
          - string:
              scope: GLOBAL
              id: "azure-service-principal"
              description: "AzureæœåŠ¡ä¸»ä½“"
              secret: "${AZURE_SP:-changeme-azure-sp}"

# ===== ç³»ç»Ÿé…ç½® =====
unclassified:
  # ç«™ç‚¹é…ç½®
  location:
    url: "http://localhost:38080/"
    adminAddress: "admin@example.com"
    
  # Giteaé›†æˆ
  gitea:
    servers:
      - displayName: "æœ¬åœ°GiteaæœåŠ¡å™¨"
        serverUrl: "${GITEA_URL:-http://gitea:33000}"
        credentialsId: "gitea-api-token"
        manageHooks: true
        
  # GitHubé›†æˆ
  github:
    apiRateLimitChecker: ThrottleOnOver
    
  # å…¨å±€åº“é…ç½®
  globalLibraries:
    libraries:
      - name: "jenkins-shared-library"
        defaultVersion: "main"
        allowVersionOverride: true
        includeInChangesets: false
        retriever:
          modernSCM:
            scm:
              git:
                remote: "${GITEA_URL:-http://gitea:33000}/infrastructure/jenkins-shared-library.git"
                credentialsId: "gitea-api-token"
                
  # é‚®ä»¶é…ç½®
  email-ext:
    mailAccount:
      smtpHost: "${SMTP_HOST:-localhost}"
      smtpPort: "${SMTP_PORT:-25}"
      useSsl: false
      useTls: false
      charset: "UTF-8"
      
  # Slacké€šçŸ¥
  slack:
    teamDomain: "${SLACK_TEAM:-your-team}"
    token: "${SLACK_TOKEN:-changeme-slack-token}"
    botUser: true
    
  # é’‰é’‰é€šçŸ¥
  dingTalk:
    robots:
      - name: "Jenkinsé€šçŸ¥æœºå™¨äºº"
        webhook: "${DINGTALK_WEBHOOK:-changeme-webhook}"
        
  # ç£ç›˜ä½¿ç”¨ç›‘æ§
  diskUsage:
    enabled: true
    countWorkspace: true
    checkWorkspaceOnSlave: true
    calculationThreads: 2
    
  # å·¥ä½œç©ºé—´æ¸…ç†
  workspaceCleanupPlugin:
    # è‡ªåŠ¨æ¸…ç†è®¾ç½®
    deleteDirectories: true
    cleanWhenAborted: true
    cleanWhenFailure: false
    cleanWhenNotBuilt: true
    cleanWhenSuccess: false
    cleanWhenUnstable: false
    
  # æ€§èƒ½ç›‘æ§
  monitoring:
    enabled: true
    
  # æ„å»ºå†å²æ¸…ç†
  buildDiscarders:
    configuredBuildDiscarders:
      - "jobBuildDiscarder"
      
  # å®‰å…¨è®¾ç½®
  csrf:
    defaultCrumbIssuer:
      excludeClientIPFromCrumb: false
      
  # APIé™æµ
  apiTokenProperty:
    tokenGenerationOnCreationEnabled: true

# ===== äº‘é…ç½® =====
clouds:
  # Dockeräº‘é…ç½®
  - docker:
      name: "docker-cloud"
      dockerApi:
        dockerHost:
          uri: "unix:///var/run/docker.sock"
        connectTimeout: 60
        readTimeout: 60
      templates:
        - labelString: "docker-agent"
          dockerTemplateBase:
            image: "jenkins/agent:latest"
            mounts:
              - "type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock"
          remoteFs: "/home/jenkins/agent"
          connector:
            ssh:
              sshKeyStrategy:
                injectSSHKey:
                  user: "jenkins"
          instanceCapStr: "10"
          retentionStrategy:
            idleMinutes: 10
            
  # Kubernetesäº‘é…ç½®
  - kubernetes:
      name: "kubernetes-cloud"
      serverUrl: "${KUBERNETES_MASTER_URL:-https://kubernetes.docker.internal:6443}"
      namespace: "jenkins"
      credentialsId: "k8s-config"
      jenkinsUrl: "http://jenkins:8080"
      jenkinsTunnel: "jenkins:50000"
      containerCapStr: "100"
      maxRequestsPerHostStr: "32"
      retentionTimeoutStr: "300"
      connectTimeoutStr: "10"
      readTimeoutStr: "20"
      templates:
        - name: "k8s-agent"
          label: "k8s-agent"
          nodeUsageMode: NORMAL
          containers:
            - name: "jnlp"
              image: "jenkins/inbound-agent:latest"
              workingDir: "/home/jenkins/agent"
              resourceRequestMemory: "512Mi"
              resourceLimitMemory: "1Gi"
              resourceRequestCpu: "200m"
              resourceLimitCpu: "500m"
          volumes:
            - hostPathVolume:
                hostPath: "/var/run/docker.sock"
                mountPath: "/var/run/docker.sock"

# ===== é¢„åˆ›å»ºä½œä¸š =====
jobs:
  # å¤šå¹³å°æ„å»ºæ¼”ç¤º
  - script: >
      multibranchPipelineJob('demo-multiplatform-build') {
        displayName('å¤šå¹³å°æ„å»ºæ¼”ç¤º')
        description('å±•ç¤ºDockerå¤šå¹³å°é•œåƒæ„å»ºçš„å®Œæ•´æµç¨‹')
        
        branchSources {
          git {
            id('demo-repo')
            remote('${GITEA_URL}/demo/multiplatform-app.git')
            credentialsId('gitea-api-token')
          }
        }
        
        configure { node ->
          node / sources / data / 'jenkins.branch.BranchSource' << {
            source(class: 'jenkins.plugins.git.GitSCMSource') {
              id('demo-repo')
              remote('${GITEA_URL}/demo/multiplatform-app.git')
              credentialsId('gitea-api-token')
              traits {
                'jenkins.plugins.git.traits.BranchDiscoveryTrait'()
                'jenkins.plugins.git.traits.TagDiscoveryTrait'()
              }
            }
          }
        }
        
        factory {
          workflowBranchProjectFactory {
            scriptPath('Jenkinsfile')
          }
        }
        
        triggers {
          periodicFolderTrigger {
            interval('1h')
          }
        }
      }
      
  # ç³»ç»Ÿç›‘æ§ä½œä¸š
  - script: >
      pipelineJob('system-monitoring') {
        displayName('ç³»ç»Ÿå¥åº·ç›‘æ§')
        description('ç›‘æ§Jenkinsç³»ç»ŸçŠ¶æ€ã€ç£ç›˜ä½¿ç”¨ã€æ’ä»¶çŠ¶æ€ç­‰')
        
        properties {
          buildDiscarder {
            strategy {
              logRotator {
                daysToKeepStr('7')
                numToKeepStr('50')
              }
            }
          }
        }
        
        triggers {
          cron('H/15 * * * *')  # æ¯15åˆ†é’Ÿæ‰§è¡Œ
        }
        
        definition {
          cps {
            script('''
              pipeline {
                  agent any
                  
                  stages {
                      stage('ç³»ç»Ÿæ£€æŸ¥') {
                          parallel {
                              stage('ç£ç›˜ä½¿ç”¨') {
                                  steps {
                                      script {
                                          def diskUsage = sh(
                                              script: "df -h /var/jenkins_home | awk 'NR==2{print \$5}' | sed 's/%//'",
                                              returnStdout: true
                                          ).trim()
                                          
                                          echo "ç£ç›˜ä½¿ç”¨ç‡: ${diskUsage}%"
                                          
                                          if (diskUsage.toInteger() > 85) {
                                              error("ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${diskUsage}%")
                                          }
                                      }
                                  }
                              }
                              
                              stage('æœåŠ¡è¿é€šæ€§') {
                                  steps {
                                      script {
                                          def services = [
                                              'Registry': 'http://localhost:5001/v2/',
                                              'Gitea': '${GITEA_URL:-http://localhost:33000}/api/v1/version'
                                          ]
                                          
                                          services.each { name, url ->
                                              def status = sh(
                                                  script: "curl -s -o /dev/null -w '%{http_code}' ${url}",
                                                  returnStdout: true
                                              ).trim()
                                              
                                              if (status == '200') {
                                                  echo "âœ… ${name} æœåŠ¡æ­£å¸¸"
                                              } else {
                                                  echo "âŒ ${name} æœåŠ¡å¼‚å¸¸ (${status})"
                                              }
                                          }
                                      }
                                  }
                              }
                              
                              stage('æ’ä»¶çŠ¶æ€') {
                                  steps {
                                      script {
                                          def pluginCount = Jenkins.instance.getPluginManager().getPlugins().size()
                                          echo "å·²å®‰è£…æ’ä»¶æ•°é‡: ${pluginCount}"
                                          
                                          def failedPlugins = Jenkins.instance.getPluginManager().getPlugins().findAll { 
                                              !it.isActive() 
                                          }
                                          
                                          if (failedPlugins.size() > 0) {
                                              echo "âš ï¸ å¤±æ•ˆæ’ä»¶: ${failedPlugins.collect { it.getShortName() }.join(', ')}"
                                          } else {
                                              echo "âœ… æ‰€æœ‰æ’ä»¶æ­£å¸¸"
                                          }
                                      }
                                  }
                              }
                          }
                      }
                      
                      stage('æ€§èƒ½æŒ‡æ ‡') {
                          steps {
                              script {
                                  def runtime = Runtime.getRuntime()
                                  def maxMemory = runtime.maxMemory() / 1024 / 1024
                                  def totalMemory = runtime.totalMemory() / 1024 / 1024
                                  def freeMemory = runtime.freeMemory() / 1024 / 1024
                                  def usedMemory = totalMemory - freeMemory
                                  
                                  echo "JVMå†…å­˜ä½¿ç”¨: ${usedMemory}MB / ${maxMemory}MB (${(usedMemory/maxMemory*100).round(2)}%)"
                                  
                                  def queueSize = Jenkins.instance.getQueue().getItems().length
                                  echo "æ„å»ºé˜Ÿåˆ—: ${queueSize} ä¸ªä»»åŠ¡"
                                  
                                  def executors = Jenkins.instance.getComputers().collect { 
                                      it.getExecutors().size() 
                                  }.sum()
                                  echo "å¯ç”¨æ‰§è¡Œå™¨: ${executors} ä¸ª"
                              }
                          }
                      }
                  }
                  
                  post {
                      failure {
                          script {
                              // å‘é€å‘Šè­¦é€šçŸ¥
                              emailext (
                                  subject: "âŒ Jenkinsç³»ç»Ÿç›‘æ§å‘Šè­¦",
                                  body: "Jenkinsç³»ç»Ÿç›‘æ§æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚\\n\\næ„å»ºè¯¦æƒ…: ${env.BUILD_URL}",
                                  to: "admin@example.com"
                              )
                          }
                      }
                  }
              }
            ''')
            sandbox()
          }
        }
      }
      
  # Dockeré•œåƒæ„å»ºæµæ°´çº¿æ¨¡æ¿
  - script: >
      pipelineJob('docker-image-template') {
        displayName('Dockeré•œåƒæ„å»ºæ¨¡æ¿')
        description('å¯å¤ç”¨çš„Dockerå¤šå¹³å°é•œåƒæ„å»ºæµæ°´çº¿æ¨¡æ¿')
        
        parameters {
          stringParam('GIT_REPO', '${GITEA_URL:-http://gitea:33000}/your-project.git', 'Gitä»“åº“åœ°å€')
          stringParam('IMAGE_NAME', 'your-app', 'é•œåƒåç§°')
          stringParam('IMAGE_TAG', 'latest', 'é•œåƒæ ‡ç­¾')
          stringParam('PLATFORMS', 'linux/amd64,linux/arm64', 'æ„å»ºå¹³å°')
          booleanParam('PUSH_IMAGE', true, 'æ˜¯å¦æ¨é€é•œåƒ')
        }
        
        definition {
          cps {
            script('''
              @Library('jenkins-shared-library') _
              
              pipeline {
                  agent any
                  
                  environment {
                      REGISTRY = '${DOCKER_REGISTRY}'
                      DOCKER_BUILDKIT = '1'
                  }
                  
                  stages {
                      stage('æ£€å‡ºä»£ç ') {
                          steps {
                              git branch: 'main', 
                                  url: params.GIT_REPO,
                                  credentialsId: 'gitea-api-token'
                          }
                      }
                      
                      stage('æ„å»ºå¤šå¹³å°é•œåƒ') {
                          steps {
                              script {
                                  def fullImageName = "${env.REGISTRY}/${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                                  
                                  buildMultiPlatformImage {
                                      imageName = fullImageName
                                      platforms = params.PLATFORMS
                                      dockerfile = 'Dockerfile'
                                      buildContext = '.'
                                      pushImage = params.PUSH_IMAGE
                                      registryCredentialsId = 'docker-registry-auth'
                                  }
                              }
                          }
                      }
                      
                      stage('é•œåƒæ‰«æ') {
                          when {
                              expression { params.PUSH_IMAGE }
                          }
                          steps {
                              script {
                                  def imageName = "${env.REGISTRY}/${params.IMAGE_NAME}:${params.IMAGE_TAG}"
                                  echo "æ‰«æé•œåƒ: ${imageName}"
                                  // è¿™é‡Œå¯ä»¥é›†æˆå®‰å…¨æ‰«æå·¥å…·
                              }
                          }
                      }
                  }
                  
                  post {
                      success {
                          echo "âœ… å¤šå¹³å°é•œåƒæ„å»ºæˆåŠŸ"
                      }
                      failure {
                          echo "âŒ é•œåƒæ„å»ºå¤±è´¥"
                      }
                      cleanup {
                          cleanWs()
                      }
                  }
              }
            ''')
            sandbox()
          }
        }
      } 