# 灵境万象健康数据分析算法设计方案

## 1. 概述

本文档详细描述了灵境万象(LJWX)健康监控系统中的核心算法设计，包括健康趋势分析、健康预测和健康画像三大核心功能的技术实现方案。

### 1.1 系统版本信息
- **版本**: v2.0.1
- **创建日期**: 2025年9月
- **更新日期**: 2025年9月
- **适用范围**: LJWX BigScreen个人健康监控大屏

### 1.2 核心算法模块
1. **健康数据趋势分析算法** - 基于时间序列分析的健康指标趋势识别
2. **健康状态预测算法** - 使用线性回归的健康状态预测模型
3. **健康画像生成算法** - 综合评分与个性化建议生成系统

---

## 2. 健康数据趋势分析算法

### 2.1 算法概述

健康数据趋势分析算法(`calculate_health_trends`)是一个综合性的时间序列分析系统，用于识别用户健康指标的变化趋势、异常检测和统计分析。

### 2.2 数据预处理模块

#### 2.2.1 数据清洗算法
```python
def clean_data(values):
    """
    四分位数异常值检测算法
    - 移除None值和零值
    - 使用IQR方法检测异常值
    - 过滤离群点数据
    """
    # 1. 基础数据过滤
    clean_values = [v for v in values if v is not None and v > 0]
    
    # 2. 四分位数计算
    q1 = clean_values[len(clean_values)//4]
    q3 = clean_values[3*len(clean_values)//4]
    iqr = q3 - q1
    
    # 3. 异常值边界计算
    lower_bound = q1 - 1.5 * iqr
    upper_bound = q3 + 1.5 * iqr
    
    # 4. 异常值过滤
    return [v for v in clean_values if lower_bound <= v <= upper_bound]
```

**关键特性**:
- **鲁棒性**: 使用四分位数方法，对极值不敏感
- **自适应**: 根据数据分布自动调整异常值阈值
- **效率**: O(n)时间复杂度

### 2.3 时间序列格式化

#### 2.3.1 ECharts兼容格式转换
```python
def format_time_series(timestamps, values, default_value=0):
    """
    将原始数据转换为ECharts时间序列格式
    格式: [[timestamp, value], [timestamp, value], ...]
    """
    series_data = []
    for i, timestamp in enumerate(timestamps):
        if i < len(values) and values[i] is not None:
            series_data.append([timestamp, values[i]])
        else:
            series_data.append([timestamp, default_value])
    return series_data
```

**输出数据结构**:
```json
{
    "heartRate": [["2025-09-07T10:00:00", 75], ["2025-09-07T10:30:00", 78]],
    "bloodOxygen": [["2025-09-07T10:00:00", 98], ["2025-09-07T10:30:00", 97]],
    "temperature": [["2025-09-07T10:00:00", 36.5], ["2025-09-07T10:30:00", 36.6]]
}
```

### 2.4 趋势分析算法

#### 2.4.1 统计指标计算
```python
def calculate_stats(values):
    """
    计算健康指标的统计信息和趋势
    """
    # 基础统计量
    avg = sum(values) / len(values)
    min_val = min(values)
    max_val = max(values)
    
    # 趋势分析 - 分段比较法
    if len(values) >= 4:
        mid_point = len(values) // 2
        first_half_avg = sum(values[:mid_point]) / mid_point
        second_half_avg = sum(values[mid_point:]) / (len(values) - mid_point)
        change_percent = ((second_half_avg - first_half_avg) / first_half_avg) * 100
        
        # 趋势分类
        if change_percent > 5:
            trend = 'rising'    # 上升趋势
        elif change_percent < -5:
            trend = 'falling'   # 下降趋势
        else:
            trend = 'stable'    # 稳定趋势
    
    return {
        'avg': round(avg, 2),
        'min': min_val,
        'max': max_val,
        'trend': trend,
        'change': round(change_percent, 2)
    }
```

**趋势判定标准**:
- **上升趋势**: 后半段均值比前半段高5%以上
- **下降趋势**: 后半段均值比前半段低5%以上  
- **稳定趋势**: 变化幅度在±5%以内

### 2.5 健康状态评估算法

#### 2.5.1 综合评分系统
```python
def assess_health_status(stats):
    """
    基于医学标准的健康状态评估算法
    总分100分，各指标权重分配:
    - 心率: 15分
    - 血氧: 20分  
    - 体温: 10分
    - 血压: 15分
    - 运动: 10分
    """
    score = 100
    warnings = []
    
    # 心率评估 (60-100 bpm正常)
    hr_avg = stats['heartRate']['avg']
    if hr_avg > 100 or hr_avg < 60:
        score -= 15
        warnings.append(f"心率异常: 平均{hr_avg}bpm")
    
    # 血氧评估 (>95%正常)
    spo2_avg = stats['bloodOxygen']['avg']
    if spo2_avg < 95:
        score -= 20
        warnings.append(f"血氧偏低: 平均{spo2_avg}%")
    
    # 体温评估 (36.0-37.5°C正常)
    temp_avg = stats['temperature']['avg']
    if temp_avg > 37.5 or temp_avg < 36.0:
        score -= 10
        warnings.append(f"体温异常: 平均{temp_avg}°C")
    
    return {
        'overallScore': max(0, score),
        'status': get_health_level(score),
        'warnings': warnings
    }
```

**健康等级分类**:
- **优秀** (90-100分): excellent
- **良好** (75-89分): good  
- **一般** (60-74分): fair
- **需关注** (<60分): poor

---

## 3. 健康状态预测算法

### 3.1 线性回归预测模型

#### 3.1.1 预测算法实现
```python
def predict_trends(values, periods=5):
    """
    使用简单线性回归预测未来健康指标趋势
    
    参数:
    - values: 历史数据点列表
    - periods: 预测未来的时间点数量
    
    返回:
    - predictions: 预测值列表
    """
    if len(values) < 3:
        return []  # 数据不足，无法预测
    
    # 准备回归数据
    n = len(values)
    x_vals = list(range(n))  # 时间序列 [0, 1, 2, ...]
    y_vals = values          # 健康指标值
    
    # 计算回归系数
    x_mean = sum(x_vals) / n
    y_mean = sum(y_vals) / n
    
    # 最小二乘法计算斜率和截距
    numerator = sum((x_vals[i] - x_mean) * (y_vals[i] - y_mean) for i in range(n))
    denominator = sum((x_vals[i] - x_mean) ** 2 for i in range(n))
    
    if denominator == 0:
        slope = 0  # 避免除零错误
    else:
        slope = numerator / denominator
        
    intercept = y_mean - slope * x_mean
    
    # 生成预测值
    predictions = []
    for i in range(periods):
        pred_x = n + i  # 未来时间点
        pred_y = slope * pred_x + intercept
        predictions.append(round(pred_y, 2))
        
    return predictions
```

### 3.2 预测准确性评估

#### 3.2.1 置信度计算
预测置信度基于以下因素:
- **数据点数量**: 数据点越多，置信度越高
- **数据稳定性**: 波动越小，置信度越高  
- **趋势一致性**: 趋势越明显，置信度越高

```python
def calculate_confidence(values, predictions):
    """
    计算预测置信度
    """
    if len(values) < 5:
        return 'low'
    elif len(values) < 20:
        return 'medium'  
    else:
        return 'high'
```

### 3.3 预测应用场景

1. **短期预测** (1-5个时间点): 用于实时健康监控
2. **中期预测** (5-20个时间点): 用于健康趋势分析
3. **长期预测** (20+时间点): 用于健康风险评估

---

## 4. 健康画像生成算法

### 4.1 综合评分算法

#### 4.1.1 权重分配策略
```python
def calculate_health_score(heart_rates, blood_oxygen, temperatures, steps):
    """
    综合健康评分算法
    
    权重分配:
    - 心率: 30% (最重要的生命体征)
    - 血氧: 25% (呼吸系统健康指标)  
    - 体温: 20% (基础代谢指标)
    - 运动: 25% (生活方式指标)
    """
    score = 0
    factors = []
    
    # 心率评分 (30分满分)
    if heart_rates:
        avg_hr = sum(heart_rates) / len(heart_rates)
        if 60 <= avg_hr <= 100:      # 正常范围
            hr_score = 30
        elif 50 <= avg_hr < 60 or 100 < avg_hr <= 110:  # 轻微异常
            hr_score = 25
        else:                         # 明显异常
            hr_score = 15
        score += hr_score
        factors.append(f'心率: {avg_hr:.1f}bpm')
    
    # 血氧评分 (25分满分)
    if blood_oxygen:
        avg_spo2 = sum(blood_oxygen) / len(blood_oxygen)
        if avg_spo2 >= 95:           # 正常
            spo2_score = 25
        elif avg_spo2 >= 90:         # 轻度缺氧
            spo2_score = 20
        else:                        # 重度缺氧
            spo2_score = 10
        score += spo2_score
        factors.append(f'血氧: {avg_spo2:.1f}%')
    
    return {
        'overall': min(100, score),
        'category': get_score_category(score),
        'factors': factors
    }
```

### 4.2 个性化建议生成算法

#### 4.2.1 规则引擎实现
```python
def generate_health_advice(heart_rates, blood_oxygen, temperatures, steps):
    """
    基于规则引擎的个性化健康建议生成
    """
    advice = []
    
    # 心率相关建议
    if heart_rates:
        avg_hr = sum(heart_rates) / len(heart_rates)
        if avg_hr > 100:
            advice.append('您的平均心率偏高，建议减少剧烈运动，保持放松心态')
        elif avg_hr < 60:
            advice.append('您的心率偏低，建议适当增加有氧运动')
        else:
            advice.append('您的心率正常，请继续保持良好的运动习惯')
    
    # 血氧相关建议
    if blood_oxygen:
        avg_spo2 = sum(blood_oxygen) / len(blood_oxygen)
        if avg_spo2 < 95:
            advice.append('血氧饱和度偏低，建议多做深呼吸练习，必要时咨询医生')
        else:
            advice.append('血氧水平良好，请保持规律的呼吸练习')
    
    # 运动相关建议
    if steps:
        avg_steps = sum(steps) / len(steps)
        if avg_steps < 5000:
            advice.append('日常活动量不足，建议每天至少步行8000步')
        elif avg_steps > 15000:
            advice.append('运动量很充足，注意适度休息避免过度疲劳')
        else:
            advice.append('运动量适中，请继续保持')
    
    # 通用健康建议
    advice.extend([
        '保持规律作息，确保充足睡眠',
        '注意饮食均衡，多吃蔬菜水果',  
        '定期监测健康数据，及时发现异常'
    ])
    
    return advice[:5]  # 最多返回5条建议
```

### 4.3 健康画像数据结构

#### 4.3.1 标准输出格式
```json
{
    "healthScore": {
        "overall": 82,
        "category": "良好",
        "factors": [
            "心率: 75.3bpm",
            "血氧: 97.8%", 
            "体温: 36.5°C",
            "日均步数: 7820步"
        ]
    },
    "healthPrediction": {
        "trend": "心率呈稳定趋势",
        "confidence": "high",
        "details": "基于30天数据分析，共156个数据点"
    },
    "healthAdvice": [
        "您的心率正常，请继续保持良好的运动习惯",
        "血氧水平良好，请保持规律的呼吸练习",
        "运动量适中，请继续保持",
        "保持规律作息，确保充足睡眠",
        "注意饮食均衡，多吃蔬菜水果"
    ]
}
```

---

## 5. 接口设计规范

### 5.1 健康趋势分析接口

#### 5.1.1 接口定义
```
GET /api/health/trends/analysis
```

**请求参数**:
- `deviceSn` (string, required): 设备序列号
- `timeRange` (string, optional): 时间范围 [1h, 6h, 24h, 7d, 30d]

**响应格式**:
```json
{
    "success": true,
    "data": {
        "deviceSn": "CRFTQ23409001890",
        "timeRange": "24h", 
        "dataPoints": 48,
        "chartData": {
            "heartRate": [["2025-09-07T10:00:00", 75]],
            "bloodOxygen": [["2025-09-07T10:00:00", 98]],
            "temperature": [["2025-09-07T10:00:00", 36.5]]
        },
        "statistics": {
            "heartRate": {
                "avg": 75.2,
                "min": 68,
                "max": 85,
                "trend": "stable",
                "change": 1.2
            }
        },
        "healthAssessment": {
            "overallScore": 85,
            "status": "good",
            "warnings": []
        },
        "predictions": {
            "heartRate": [75, 76, 74, 75, 77]
        }
    }
}
```

### 5.2 综合健康分析接口

#### 5.2.1 接口定义
```
GET /api/health/analysis/comprehensive
```

**请求参数**:
- `deviceSn` (string, required): 设备序列号  
- `days` (integer, optional): 分析天数，默认30天

**响应格式**:
```json
{
    "success": true,
    "data": {
        "deviceSn": "CRFTQ23409001890",
        "analysisDate": "2025-09-07T10:30:00Z",
        "dataPoints": 156,
        "analysisPeriod": "30天",
        "healthScore": {
            "overall": 82,
            "category": "良好"
        },
        "healthPrediction": {
            "trend": "心率保持稳定",
            "confidence": "high"
        },
        "healthAdvice": [
            "您的心率正常，请继续保持良好的运动习惯"
        ]
    }
}
```

---

## 6. 性能优化策略

### 6.1 数据缓存策略

#### 6.1.1 Redis缓存设计
```python
# 缓存键设计
CACHE_KEY_PATTERN = "health:analysis:{deviceSn}:{timeRange}:{date}"

# 缓存过期时间
CACHE_TTL = {
    '1h': 300,    # 5分钟
    '6h': 900,    # 15分钟  
    '24h': 1800,  # 30分钟
    '7d': 3600,   # 1小时
    '30d': 7200   # 2小时
}
```

### 6.2 数据库查询优化

#### 6.2.1 索引优化策略
```sql
-- 健康数据查询优化索引
CREATE INDEX idx_health_device_time ON t_user_health_data (device_sn, timestamp DESC);
CREATE INDEX idx_health_user_time ON t_user_health_data (user_id, timestamp DESC);
CREATE INDEX idx_health_org_time ON t_user_health_data (org_id, timestamp DESC);
```

### 6.3 算法性能指标

#### 6.3.1 性能基准
- **数据处理速度**: >1000条记录/秒
- **趋势分析延迟**: <500ms
- **预测计算时间**: <200ms  
- **内存占用**: <100MB (1000用户并发)
- **缓存命中率**: >90%

---

## 7. 质量保证与测试

### 7.1 算法准确性验证

#### 7.1.1 回归测试用例
```python
def test_trend_calculation_accuracy():
    """测试趋势计算准确性"""
    # 上升趋势数据
    rising_data = [70, 72, 74, 76, 78, 80, 82, 84]
    result = calculate_stats(rising_data)
    assert result['trend'] == 'rising'
    assert result['change'] > 5
    
    # 稳定趋势数据  
    stable_data = [75, 74, 76, 75, 74, 76, 75, 74]
    result = calculate_stats(stable_data)
    assert result['trend'] == 'stable'
    assert -5 <= result['change'] <= 5
```

### 7.2 异常处理机制

#### 7.2.1 容错设计
```python
def safe_calculate_trends(health_data, timeRange):
    """
    安全的趋势计算，包含完整的异常处理
    """
    try:
        return analyze_health_trends_comprehensive(health_data, timeRange)
    except ZeroDivisionError:
        logger.warning("除零错误，返回默认趋势数据")
        return generate_fallback_trends_data(timeRange)
    except ValueError as e:
        logger.error(f"数值错误: {e}")
        return generate_fallback_trends_data(timeRange)
    except Exception as e:
        logger.error(f"未知错误: {e}")
        return generate_fallback_trends_data(timeRange)
```

---

## 8. 部署与运维

### 8.1 监控指标

#### 8.1.1 关键监控点
```python
# 算法性能监控
MONITORING_METRICS = {
    'algorithm_execution_time': {
        'trends_analysis': 'histogram',
        'health_prediction': 'histogram', 
        'health_scoring': 'histogram'
    },
    'algorithm_accuracy': {
        'prediction_accuracy': 'gauge',
        'trend_detection_rate': 'gauge'
    },
    'system_health': {
        'memory_usage': 'gauge',
        'cpu_utilization': 'gauge',
        'cache_hit_rate': 'gauge'
    }
}
```

### 8.2 日志记录规范

#### 8.2.1 结构化日志
```python
import structlog

health_logger = structlog.get_logger("health_algorithm")

def log_algorithm_execution(algorithm_name, execution_time, data_points):
    """记录算法执行日志"""
    health_logger.info(
        "algorithm_executed",
        algorithm=algorithm_name,
        execution_time_ms=execution_time,
        data_points=data_points,
        timestamp=datetime.now().isoformat()
    )
```

---

## 9. 未来优化方向

### 9.1 机器学习增强

#### 9.1.1 深度学习模型集成
- **LSTM网络**: 用于长期健康趋势预测
- **CNN网络**: 用于健康数据模式识别  
- **Transformer**: 用于多模态健康数据融合

### 9.2 个性化算法优化

#### 9.2.1 用户画像学习
```python
class PersonalizedHealthModel:
    """个性化健康模型"""
    
    def __init__(self, user_profile):
        self.age = user_profile.get('age')
        self.gender = user_profile.get('gender')
        self.medical_history = user_profile.get('medical_history')
    
    def calculate_personalized_score(self, health_data):
        """基于个人特征计算个性化健康评分"""
        base_score = calculate_health_score(health_data)
        
        # 年龄调整
        age_factor = self.get_age_adjustment_factor()
        adjusted_score = base_score * age_factor
        
        return adjusted_score
```

### 9.3 实时预警系统

#### 9.3.1 异常检测算法
```python
def real_time_anomaly_detection(current_value, historical_data):
    """
    实时异常检测算法
    使用统计方法识别健康数据异常
    """
    mean = sum(historical_data) / len(historical_data)
    std_dev = calculate_std_deviation(historical_data)
    
    # 3σ原则检测异常
    threshold = 3 * std_dev
    
    if abs(current_value - mean) > threshold:
        return {
            'is_anomaly': True,
            'severity': 'high' if abs(current_value - mean) > 4 * std_dev else 'medium',
            'deviation': abs(current_value - mean)
        }
    
    return {'is_anomaly': False}
```

---

## 10. 总结

本文档详细描述了灵境万象健康监控系统的核心算法设计，包括：

1. **健康趋势分析**: 基于时间序列分析和统计学方法的趋势识别系统
2. **健康状态预测**: 使用线性回归的预测模型，支持短中长期预测
3. **健康画像生成**: 综合评分与个性化建议的智能生成系统

### 10.1 技术优势

- **科学性**: 基于医学标准和统计学原理
- **准确性**: 多层异常检测和数据清洗  
- **实用性**: 面向实际应用场景设计
- **可扩展性**: 模块化设计，支持算法升级
- **高性能**: 优化的数据处理和缓存策略

### 10.2 应用价值

- **个人健康监控**: 提供科学的健康状态评估
- **预防医学**: 早期健康风险识别和预警
- **生活方式指导**: 个性化的健康改善建议  
- **企业健康管理**: 员工群体健康状况分析

通过这套完整的算法体系，灵境万象健康监控系统能够为用户提供专业、准确、个性化的健康分析服务，助力用户实现主动健康管理。

---

**文档版权**: © 2025 灵境万象科技有限公司  
**技术支持**: LJWX技术团队  
**更新周期**: 季度更新