# ä¸Šä¼ æ¥å£ç”¨æˆ·ä¿¡æ¯ä¼ é€’ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆä¼˜åŒ–äº†ljwx-watchä¸ljwx-bigscreenä¹‹é—´çš„æ•°æ®ä¼ é€’æœºåˆ¶ï¼Œé€šè¿‡ç›´æ¥ä¼ é€’ç”¨æˆ·ä¿¡æ¯å‚æ•°(userId, orgId, customerId)æ¥æé«˜ç³»ç»Ÿæ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚

**å®æ–½æ—¶é—´**: 2025å¹´1æœˆ
**å½±å“èŒƒå›´**: ljwx-watch, ljwx-bigscreen, fetchConfigæ¨¡å—
**ä¼˜åŒ–ç›®æ ‡**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæå‡å“åº”é€Ÿåº¦ï¼Œä¿è¯æ•°æ®å‡†ç¡®æ€§

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–

### **ä¼˜åŒ–å‰**: é—´æ¥æŸ¥è¯¢æ–¹å¼
```
ljwx-watch â†’ bigscreenæ¥å£ â†’ deviceSnæŸ¥è¯¢ â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ å­˜å‚¨
                â†‘              â†‘
          å¿½ç•¥ä¼ é€’çš„å‚æ•°    å¢åŠ æŸ¥è¯¢å»¶è¿Ÿ (200-500ms)
```

### **ä¼˜åŒ–å**: æ™ºèƒ½æ··åˆæ–¹å¼  
```
ljwx-watch â†’ bigscreenæ¥å£ â†’ ç›´æ¥ä½¿ç”¨å‚æ•° â†’ é«˜æ•ˆå­˜å‚¨
    â†“              â†‘              
ä¼ é€’å®Œæ•´å‚æ•°    æ™ºèƒ½å›é€€æœºåˆ¶    

å¦‚æœå‚æ•°ç¼ºå¤±:
ljwx-watch â†’ bigscreenæ¥å£ â†’ deviceSnæŸ¥è¯¢ â†’ è¡¥å……å‚æ•° â†’ å­˜å‚¨
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### **1. ljwx-watch ç«¯å¢å¼º**

#### **é…ç½®è·å–ä¼˜åŒ–**
- **æ–‡ä»¶**: `ljwx-bigscreen/bigscreen/bigScreen/fetchConfig.py`
- **å‡½æ•°**: `fetch_customer_id_by_deviceSn()`

**Before**:
```python
def fetch_customer_id_by_deviceSn(deviceSn):
    # åªè¿”å›å­—ç¬¦ä¸²æ ¼å¼çš„customer_id
    return '0'
```

**After**:
```python
def fetch_customer_id_by_deviceSn(deviceSn):
    # è¿”å›å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯å­—å…¸
    return {
        'customer_id': customer_id,
        'org_id': org_id,
        'user_id': user_id
    }
```

#### **æ‰‹è¡¨ç«¯é…ç½®è§£æ**
- **æ–‡ä»¶**: `ljwx-watch/entry/src/main/java/com/ljwx/watch/slice/MainAbilitySlice.java`
- **æ–¹æ³•**: `processConfig()`

**å¢å¼ºå†…å®¹**:
```java
// æ–°å¢å­—æ®µè§£æ
if (configJson.has("customer_id")) {
    String customerId = configJson.getString("customer_id");
    dataManager.setCustomerId(customerId);
}
if (configJson.has("org_id")) {
    String orgId = configJson.optString("org_id", null);
    dataManager.setOrgId(orgId);
}
if (configJson.has("user_id")) {
    String userId = configJson.optString("user_id", null);
    dataManager.setUserId(userId);
}
```

#### **æ•°æ®ä¸Šä¼ å¢å¼º**
- **æ–‡ä»¶**: `ljwx-watch/entry/src/main/java/com/ljwx/watch/utils/Utils.java`
- **æ–¹æ³•**: `getHealthInfo()`, `getHealthInfoForCommonEvent()`, `getDeviceInfo()`

**å¢å¼ºå†…å®¹**:
```java
// åœ¨æ‰€æœ‰ä¸Šä¼ æ•°æ®ä¸­æ·»åŠ å®¢æˆ·ä¿¡æ¯
if (dataManager.getCustomerId() != null) {
    healthInfoJson.put("customer_id", dataManager.getCustomerId());
}
if (dataManager.getOrgId() != null) {
    healthInfoJson.put("org_id", dataManager.getOrgId());
}
if (dataManager.getUserId() != null) {
    healthInfoJson.put("user_id", dataManager.getUserId());
}
```

### **2. ljwx-bigscreen æ¥å£ä¼˜åŒ–**

#### **å¥åº·æ•°æ®ä¸Šä¼ æ¥å£**
- **æ–‡ä»¶**: `ljwx-bigscreen/bigscreen/bigScreen/user_health_data.py`
- **å‡½æ•°**: `process_single_health_data()`, `save_health_data()`

**æ ¸å¿ƒä¼˜åŒ–**:
```python
# ä¼˜å…ˆä½¿ç”¨ç›´æ¥ä¼ é€’çš„å‚æ•°
customerId = data.get("customer_id")
orgId = data.get("org_id") 
userId = data.get("user_id")

# æ™ºèƒ½å›é€€æœºåˆ¶
if not customerId or not orgId or not userId:
    device_info = fetch_customer_id_by_deviceSn(deviceSn)
    customerId = customerId or device_info.get('customer_id')
    orgId = orgId or device_info.get('org_id') 
    userId = userId or device_info.get('user_id')

# ç›´æ¥å­˜å‚¨åˆ°æ•°æ®åº“
health_data = UserHealthData(
    # ... å…¶ä»–å­—æ®µ
    customer_id=customerId,
    org_id=orgId,
    user_id=userId
)
```

#### **è®¾å¤‡ä¿¡æ¯ä¸Šä¼ æ¥å£**
- **æ–‡ä»¶**: `ljwx-bigscreen/bigscreen/bigScreen/device.py`
- **å‡½æ•°**: `process_single_device()`, `save_device_info()`

**åŒæ ·çš„æ™ºèƒ½å›é€€æœºåˆ¶**:
```python
# æå–å®¢æˆ·ä¿¡æ¯å¹¶è¡¥å……ç¼ºå¤±å‚æ•°
customerId = data.get("customer_id")
orgId = data.get("org_id") 
userId = data.get("user_id")

# ä¿å­˜åˆ°è®¾å¤‡ä¿¡æ¯è¡¨
d.customer_id = customerId
d.org_id = orgId  
d.user_id = userId
```

#### **é€šç”¨äº‹ä»¶ä¸Šä¼ æ¥å£**
- **æ–‡ä»¶**: `ljwx-bigscreen/bigscreen/bigScreen/alert.py`
- **å‡½æ•°**: `upload_common_event()`

**å‘Šè­¦è®°å½•ä¼˜åŒ–**:
```python
# ç›´æ¥ä½¿ç”¨ä¼ é€’çš„å‚æ•°åˆ›å»ºå‘Šè­¦
alert = AlertInfo(
    # ... å…¶ä»–å­—æ®µ
    customer_id=customerId,
    org_id=orgId,
    user_id=userId,
    alert_timestamp=alert_timestamp
)
```

---

## ğŸ“Š æ•°æ®åº“è¡¨å­—æ®µéªŒè¯

### **æ”¯æŒçš„è¡¨å’Œå­—æ®µ**

| è¡¨å | customer_id | org_id | user_id | çŠ¶æ€ |
|------|------------|--------|---------|------|
| `t_user_health_data` | âœ… | âœ… | âœ… | å·²æ”¯æŒ |
| `t_device_info` | âœ… | âœ… | âœ… | å·²æ”¯æŒ |
| `t_alert_info` | âœ… | âœ… | âœ… | å·²æ”¯æŒ |
| `t_device_info_history` | ğŸ”„ | ğŸ”„ | ğŸ”„ | å¾…å®Œå–„ |

**æ³¨æ„**: å†å²è¡¨å­—æ®µå¾…åç»­æ‰©å±•æ”¯æŒ

---

## ğŸš€ æ€§èƒ½æ•ˆæœè¯„ä¼°

### **å“åº”æ—¶é—´ä¼˜åŒ–**
- **å¥åº·æ•°æ®ä¸Šä¼ **: å‡å°‘ 200-500ms æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
- **è®¾å¤‡ä¿¡æ¯ä¸Šä¼ **: å‡å°‘ 150-300ms ç”¨æˆ·å…³è”æŸ¥è¯¢æ—¶é—´  
- **å‘Šè­¦äº‹ä»¶å¤„ç†**: å‡å°‘ 100-200ms ç»„ç»‡ä¿¡æ¯æŸ¥è¯¢æ—¶é—´

### **æ•°æ®åº“å‹åŠ›å‡å°‘**
- **æŸ¥è¯¢æ¬¡æ•°**: æ¯æ¬¡ä¸Šä¼ å‡å°‘1-2æ¬¡æ•°æ®åº“æŸ¥è¯¢
- **å¹¶å‘èƒ½åŠ›**: æå‡ç³»ç»Ÿé«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- **èµ„æºåˆ©ç”¨**: å‡å°‘æ•°æ®åº“è¿æ¥æ± å‹åŠ›

### **æ•°æ®ä¸€è‡´æ€§æå‡**
- **å‡†ç¡®æ€§**: ä½¿ç”¨é…ç½®æ—¶è·å–çš„å‡†ç¡®ç”¨æˆ·ä¿¡æ¯
- **å®æ—¶æ€§**: é¿å…æ•°æ®åº“å…³è”å…³ç³»å˜æ›´å»¶è¿Ÿ
- **å®Œæ•´æ€§**: ç¡®ä¿æ‰€æœ‰è®°å½•åŒ…å«æ­£ç¡®çš„ç”¨æˆ·ç»„ç»‡ä¿¡æ¯

---

## ğŸ”„ å…¼å®¹æ€§ä¿è¯

### **å‘åå…¼å®¹ç­–ç•¥**

1. **æ™ºèƒ½å›é€€æœºåˆ¶**
   - æ–°ç‰ˆæœ¬æ‰‹è¡¨: ç›´æ¥ä½¿ç”¨ä¼ é€’çš„å‚æ•° (é«˜æ€§èƒ½)
   - æ—§ç‰ˆæœ¬æ‰‹è¡¨: è‡ªåŠ¨å›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢ (ä¿è¯å…¼å®¹)

2. **æ¸è¿›å¼ä¼˜åŒ–**
   - ä¸éœ€è¦åŒæ—¶å‡çº§æ‰€æœ‰ç»„ä»¶
   - æ‰‹è¡¨å‡çº§åè‡ªåŠ¨è·å¾—æ€§èƒ½æå‡
   - æ—§æ‰‹è¡¨ç»§ç»­æ­£å¸¸å·¥ä½œ

3. **æ•°æ®å®Œæ•´æ€§**
   - æ— è®ºä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ç¡®ä¿æ•°æ®å®Œæ•´å­˜å‚¨
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

---

## ğŸ“ å®æ–½æ£€æŸ¥æ¸…å•

### **å¼€å‘é˜¶æ®µ** âœ…
- [x] fetchConfig.py è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯å­—å…¸
- [x] ljwx-watch è§£æå’Œå­˜å‚¨ç”¨æˆ·ä¿¡æ¯  
- [x] ä¸‰ä¸ªä¸Šä¼ æ¥å£å¢å¼ºç”¨æˆ·ä¿¡æ¯å¤„ç†
- [x] DataManager æ·»åŠ ç”¨æˆ·ä¿¡æ¯å­—æ®µæ”¯æŒ
- [x] æ™ºèƒ½å›é€€æœºåˆ¶å®ç°

### **æµ‹è¯•é˜¶æ®µ** ğŸ”„
- [ ] æ–°ç‰ˆæœ¬æ‰‹è¡¨é…ç½®è·å–æµ‹è¯•
- [ ] ä¸‰ä¸ªä¸Šä¼ æ¥å£å‚æ•°ä¼ é€’éªŒè¯
- [ ] æ•°æ®åº“å­˜å‚¨å­—æ®µå®Œæ•´æ€§æ£€æŸ¥
- [ ] æ—§ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### **éƒ¨ç½²é˜¶æ®µ** ğŸ”„  
- [ ] æµ‹è¯•ç¯å¢ƒéªŒè¯
- [ ] ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ
- [ ] ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°å˜åŒ–
- [ ] æ¥å£å“åº”æ—¶é—´ç›‘æ§

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### **å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)**

1. **å“åº”æ—¶é—´æŒ‡æ ‡**
   - `upload_health_data` æ¥å£å¹³å‡å“åº”æ—¶é—´
   - `upload_device_info` æ¥å£å¹³å‡å“åº”æ—¶é—´
   - `upload_common_event` æ¥å£å¹³å‡å“åº”æ—¶é—´

2. **æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡**  
   - `fetch_customer_id_by_deviceSn` è°ƒç”¨æ¬¡æ•°
   - `get_device_user_org_info` è°ƒç”¨æ¬¡æ•°
   - æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡

3. **æ•°æ®å®Œæ•´æ€§æŒ‡æ ‡**
   - å­˜å‚¨è®°å½•çš„ `customer_id` éç©ºç‡
   - å­˜å‚¨è®°å½•çš„ `org_id` éç©ºç‡  
   - å­˜å‚¨è®°å½•çš„ `user_id` éç©ºç‡

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### **çŸ­æœŸè®¡åˆ’ (1ä¸ªæœˆå†…)**
1. å®Œå–„ `t_device_info_history` è¡¨çš„ç”¨æˆ·ä¿¡æ¯å­—æ®µæ”¯æŒ
2. æ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½ç›‘æ§å’ŒæŠ¥è­¦æœºåˆ¶
3. ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### **ä¸­æœŸè®¡åˆ’ (3ä¸ªæœˆå†…)**  
1. å®æ–½ç¼“å­˜æœºåˆ¶è¿›ä¸€æ­¥å‡å°‘æ•°æ®åº“æŸ¥è¯¢
2. è€ƒè™‘æ‰¹é‡ä¸Šä¼ æ¥å£çš„ç”¨æˆ·ä¿¡æ¯å¤„ç†ä¼˜åŒ–
3. å»ºç«‹è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•å’Œç›‘æ§ä½“ç³»

### **é•¿æœŸè®¡åˆ’ (6ä¸ªæœˆå†…)**
1. è€ƒè™‘å¾®æœåŠ¡æ¶æ„ä¸‹çš„ç”¨æˆ·ä¿¡æ¯åŒæ­¥æœºåˆ¶
2. å®æ–½æ›´æ™ºèƒ½çš„æ•°æ®è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
3. å»ºç«‹å®Œæ•´çš„æ•°æ®è¡€ç¼˜å’Œè¿½æº¯ä½“ç³»

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-26  
**ç»´æŠ¤å›¢é˜Ÿ**: å¥åº·ç³»ç»Ÿå¼€å‘ç»„

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»:
- åˆ›å»º GitHub Issue
- æŠ€æœ¯è®¨è®ºç¾¤
- ä»£ç å®¡æŸ¥æµç¨‹

---

*æ­¤ä¼˜åŒ–æ–¹æ¡ˆæ˜¯ljwxå¥åº·ç®¡ç†ç³»ç»ŸæŒç»­ä¼˜åŒ–çš„é‡è¦é‡Œç¨‹ç¢‘ï¼Œæ ‡å¿—ç€ç³»ç»Ÿä»ä¼ ç»Ÿçš„é—´æ¥æŸ¥è¯¢æ¨¡å¼å‡çº§åˆ°æ™ºèƒ½åŒ–çš„ç›´æ¥ä¼ é€’æ¨¡å¼ï¼Œä¸ºç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œé«˜å¯é æ€§å¥ å®šäº†åšå®åŸºç¡€ã€‚*