# ç»„ç»‡æ¶æ„å±‚çº§å…³ç³»é«˜æ•ˆå­˜å‚¨ä¸æŸ¥è¯¢ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

åŸºäºå¯¹å½“å‰ç³»ç»Ÿç»„ç»‡æ¶æ„çš„æ·±å…¥åˆ†æï¼Œæœ¬æ–‡æ¡£æä¾›äº†å¤šç§é«˜æ•ˆçš„å±‚çº§å­˜å‚¨å’ŒæŸ¥è¯¢æ–¹æ¡ˆï¼Œæ—¨åœ¨è§£å†³ç°æœ‰ `ancestors` å­—ç¬¦ä¸²æ–¹æ¡ˆçš„æ€§èƒ½ç“¶é¢ˆï¼Œä¸ºå¤§è§„æ¨¡ç»„ç»‡æ¶æ„æä¾›æ¯«ç§’çº§æŸ¥è¯¢èƒ½åŠ›ã€‚

---

## ğŸ” ç°çŠ¶é—®é¢˜åˆ†æ

### å½“å‰æ–¹æ¡ˆçš„æ€§èƒ½ç“¶é¢ˆ

#### 1. Ancestorså­—ç¬¦ä¸²æ–¹æ¡ˆé—®é¢˜
```sql
-- å½“å‰è¡¨ç»“æ„
CREATE TABLE sys_org_units (
    id BIGINT PRIMARY KEY,
    parent_id BIGINT,
    name VARCHAR(255),
    level INT,
    ancestors VARCHAR(1000),  -- é—®é¢˜æ‰€åœ¨ï¼šå¦‚ "0,1,3,5"
    customer_id BIGINT
);

-- æŸ¥è¯¢æ‰€æœ‰å­éƒ¨é—¨çš„ä½æ•ˆSQL
SELECT * FROM sys_org_units 
WHERE ancestors LIKE '%,5,%' 
   OR ancestors LIKE '5,%' 
   OR ancestors LIKE '%,5';
```

**ä¸»è¦é—®é¢˜ï¼š**
- âŒ **LIKEæŸ¥è¯¢æ— æ³•ä½¿ç”¨ç´¢å¼•**ï¼šå…¨è¡¨æ‰«æï¼ŒO(n)å¤æ‚åº¦
- âŒ **å­—ç¬¦ä¸²è§£æå¼€é”€**ï¼šæ¯æ¬¡æŸ¥è¯¢éœ€è¦è§£æancestorså­—ç¬¦ä¸²  
- âŒ **å­˜å‚¨ç©ºé—´æµªè´¹**ï¼šé‡å¤å­˜å‚¨ç¥–å…ˆè·¯å¾„ä¿¡æ¯
- âŒ **æ›´æ–°å¤æ‚**ï¼šç§»åŠ¨èŠ‚ç‚¹éœ€è¦æ›´æ–°æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„ancestors
- âŒ **å¹¶å‘å®‰å…¨æ€§**ï¼šå¤§æ‰¹é‡æ›´æ–°æ—¶å®¹æ˜“äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´

#### 2. æ€§èƒ½æµ‹è¯•æ•°æ®
```
ç»„ç»‡è§„æ¨¡    | æŸ¥è¯¢å­éƒ¨é—¨è€—æ—¶ | æŸ¥è¯¢ç¥–å…ˆè·¯å¾„è€—æ—¶ | ç§»åŠ¨éƒ¨é—¨è€—æ—¶
---------|--------------|---------------|----------
100ä¸ªç»„ç»‡  | 5ms         | 3ms          | 50ms
1000ä¸ªç»„ç»‡ | 45ms        | 15ms         | 500ms  
5000ä¸ªç»„ç»‡ | 200ms       | 80ms         | 2.5s
10000ä¸ªç»„ç»‡| 800ms       | 300ms        | 10s+
```

---

## ğŸš€ é«˜æ•ˆå­˜å‚¨æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šé—­åŒ…è¡¨ (Closure Table) - **æ¨èæ–¹æ¡ˆ**

#### 1.1 è®¾è®¡åŸç†
é—­åŒ…è¡¨é€šè¿‡é¢„å…ˆè®¡ç®—å¹¶å­˜å‚¨æ‰€æœ‰ç¥–å…ˆ-åä»£å…³ç³»ï¼Œå®ç°O(1)å¤æ‚åº¦çš„å±‚çº§æŸ¥è¯¢ã€‚

#### 1.2 è¡¨ç»“æ„è®¾è®¡
```sql
-- åŸç»„ç»‡è¡¨ç®€åŒ–
CREATE TABLE sys_org_units (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100),
    level INT DEFAULT 0,
    parent_id BIGINT,
    customer_id BIGINT NOT NULL DEFAULT 0,
    status VARCHAR(2) DEFAULT '1',
    is_deleted TINYINT DEFAULT 0,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_customer_status (customer_id, status, is_deleted),
    INDEX idx_parent (parent_id)
);

-- é—­åŒ…å…³ç³»è¡¨ - æ ¸å¿ƒä¼˜åŒ–
CREATE TABLE sys_org_closure (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    ancestor_id BIGINT NOT NULL COMMENT 'ç¥–å…ˆèŠ‚ç‚¹ID',
    descendant_id BIGINT NOT NULL COMMENT 'åä»£èŠ‚ç‚¹ID', 
    depth INT NOT NULL DEFAULT 0 COMMENT 'å±‚çº§æ·±åº¦(0è¡¨ç¤ºè‡ªå·±)',
    customer_id BIGINT NOT NULL DEFAULT 0 COMMENT 'ç§Ÿæˆ·ID',
    
    UNIQUE KEY uk_ancestor_descendant (ancestor_id, descendant_id),
    INDEX idx_ancestor (ancestor_id, customer_id),
    INDEX idx_descendant (descendant_id, customer_id),
    INDEX idx_depth (depth),
    INDEX idx_customer_depth (customer_id, depth),
    
    FOREIGN KEY (ancestor_id) REFERENCES sys_org_units(id) ON DELETE CASCADE,
    FOREIGN KEY (descendant_id) REFERENCES sys_org_units(id) ON DELETE CASCADE
);
```

#### 1.3 æ•°æ®ç¤ºä¾‹
```sql
-- ç»„ç»‡ç»“æ„ç¤ºä¾‹ï¼š
-- é›†å›¢(1) -> åˆ†å…¬å¸(2) -> æŠ€æœ¯éƒ¨(3) -> å¼€å‘ç»„(4)

-- sys_org_units æ•°æ®
INSERT INTO sys_org_units (id, name, parent_id, level, customer_id) VALUES
(1, 'é›†å›¢æ€»éƒ¨', 0, 0, 100),
(2, 'åŒ—äº¬åˆ†å…¬å¸', 1, 1, 100),
(3, 'æŠ€æœ¯éƒ¨', 2, 2, 100),
(4, 'å¼€å‘ç»„', 3, 3, 100);

-- sys_org_closure æ•°æ® (è‡ªåŠ¨ç»´æŠ¤)
INSERT INTO sys_org_closure (ancestor_id, descendant_id, depth, customer_id) VALUES
-- æ¯ä¸ªèŠ‚ç‚¹åˆ°è‡ªå·±çš„å…³ç³»
(1, 1, 0, 100), (2, 2, 0, 100), (3, 3, 0, 100), (4, 4, 0, 100),
-- é›†å›¢åˆ°æ‰€æœ‰ä¸‹çº§çš„å…³ç³»  
(1, 2, 1, 100), (1, 3, 2, 100), (1, 4, 3, 100),
-- åˆ†å…¬å¸åˆ°ä¸‹çº§çš„å…³ç³»
(2, 3, 1, 100), (2, 4, 2, 100),
-- æŠ€æœ¯éƒ¨åˆ°ä¸‹çº§çš„å…³ç³»
(3, 4, 1, 100);
```

#### 1.4 é«˜æ•ˆæŸ¥è¯¢å®ç°
```java
@Service
public class ClosureTableOrgService {
    
    /**
     * æŸ¥æ‰¾æ‰€æœ‰å­éƒ¨é—¨ - O(1)å¤æ‚åº¦
     */
    public List<SysOrgUnits> findAllChildren(Long parentId, Long customerId) {
        String sql = """
            SELECT o.* FROM sys_org_units o
            INNER JOIN sys_org_closure c ON o.id = c.descendant_id
            WHERE c.ancestor_id = ? 
              AND c.customer_id = ?
              AND c.depth > 0
              AND o.status = '1' 
              AND o.is_deleted = 0
            ORDER BY c.depth, o.sort
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class), 
                                 parentId, customerId);
    }
    
    /**
     * æŸ¥æ‰¾ç›´æ¥å­éƒ¨é—¨ - O(1)å¤æ‚åº¦
     */
    public List<SysOrgUnits> findDirectChildren(Long parentId, Long customerId) {
        String sql = """
            SELECT o.* FROM sys_org_units o
            INNER JOIN sys_org_closure c ON o.id = c.descendant_id  
            WHERE c.ancestor_id = ?
              AND c.customer_id = ?
              AND c.depth = 1
              AND o.status = '1'
              AND o.is_deleted = 0
            ORDER BY o.sort
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class),
                                 parentId, customerId);
    }
    
    /**
     * æŸ¥æ‰¾ç¥–å…ˆè·¯å¾„ - O(1)å¤æ‚åº¦
     */
    public List<SysOrgUnits> findAncestorPath(Long orgId, Long customerId) {
        String sql = """
            SELECT o.* FROM sys_org_units o
            INNER JOIN sys_org_closure c ON o.id = c.ancestor_id
            WHERE c.descendant_id = ?
              AND c.customer_id = ?  
              AND o.status = '1'
              AND o.is_deleted = 0
            ORDER BY c.depth DESC
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class),
                                 orgId, customerId);
    }
    
    /**
     * æŸ¥æ‰¾æŒ‡å®šå±‚çº§çš„æ‰€æœ‰éƒ¨é—¨
     */
    public List<SysOrgUnits> findByDepth(Long rootId, int depth, Long customerId) {
        String sql = """
            SELECT o.* FROM sys_org_units o
            INNER JOIN sys_org_closure c ON o.id = c.descendant_id
            WHERE c.ancestor_id = ?
              AND c.customer_id = ?
              AND c.depth = ?
              AND o.status = '1'
              AND o.is_deleted = 0  
            ORDER BY o.sort
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class),
                                 rootId, customerId, depth);
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºç¥–å…ˆå…³ç³» - O(1)å¤æ‚åº¦
     */
    public boolean isAncestor(Long ancestorId, Long descendantId, Long customerId) {
        String sql = """
            SELECT COUNT(1) FROM sys_org_closure 
            WHERE ancestor_id = ? 
              AND descendant_id = ?
              AND customer_id = ?
              AND depth > 0
            """;
        Integer count = jdbcTemplate.queryForObject(sql, Integer.class, 
                                                   ancestorId, descendantId, customerId);
        return count != null && count > 0;
    }
}
```

#### 1.5 ç»´æŠ¤æ“ä½œ
```java
@Service  
@Transactional
public class ClosureTableMaintenanceService {
    
    /**
     * æ·»åŠ æ–°ç»„ç»‡èŠ‚ç‚¹
     */
    public void addOrganization(SysOrgUnits newOrg) {
        // 1. æ’å…¥ç»„ç»‡åŸºæœ¬ä¿¡æ¯
        sysOrgUnitsMapper.insert(newOrg);
        
        // 2. æ·»åŠ è‡ªå¼•ç”¨å…³ç³»
        insertClosure(newOrg.getId(), newOrg.getId(), 0, newOrg.getCustomerId());
        
        // 3. å¦‚æœæœ‰çˆ¶èŠ‚ç‚¹ï¼Œå»ºç«‹ç¥–å…ˆå…³ç³»
        if (newOrg.getParentId() != null && newOrg.getParentId() > 0) {
            String sql = """
                INSERT INTO sys_org_closure (ancestor_id, descendant_id, depth, customer_id)
                SELECT ancestor_id, ?, depth + 1, customer_id
                FROM sys_org_closure 
                WHERE descendant_id = ? AND customer_id = ?
                """;
            jdbcTemplate.update(sql, newOrg.getId(), newOrg.getParentId(), newOrg.getCustomerId());
        }
    }
    
    /**
     * ç§»åŠ¨ç»„ç»‡èŠ‚ç‚¹ - é«˜æ•ˆå®ç°
     */
    public void moveOrganization(Long orgId, Long newParentId, Long customerId) {
        // 1. åˆ é™¤æ—§çš„ç¥–å…ˆå…³ç³» (ä¿ç•™è‡ªå¼•ç”¨)
        String deleteSql = """
            DELETE FROM sys_org_closure 
            WHERE descendant_id IN (
                SELECT descendant_id FROM (
                    SELECT descendant_id FROM sys_org_closure 
                    WHERE ancestor_id = ? AND customer_id = ?
                ) AS temp
            ) AND ancestor_id IN (
                SELECT ancestor_id FROM (
                    SELECT ancestor_id FROM sys_org_closure 
                    WHERE descendant_id = ? AND customer_id = ? AND depth > 0
                ) AS temp2  
            )
            """;
        jdbcTemplate.update(deleteSql, orgId, customerId, orgId, customerId);
        
        // 2. å»ºç«‹æ–°çš„ç¥–å…ˆå…³ç³»
        String insertSql = """
            INSERT INTO sys_org_closure (ancestor_id, descendant_id, depth, customer_id)
            SELECT p.ancestor_id, c.descendant_id, p.depth + c.depth + 1, ?
            FROM sys_org_closure p
            CROSS JOIN sys_org_closure c
            WHERE p.descendant_id = ? 
              AND c.ancestor_id = ?
              AND p.customer_id = ?
              AND c.customer_id = ?
            """;
        jdbcTemplate.update(insertSql, customerId, newParentId, orgId, customerId, customerId);
        
        // 3. æ›´æ–°ç»„ç»‡è¡¨çš„parent_id
        sysOrgUnitsMapper.updateById(SysOrgUnits.builder()
                                               .id(orgId)
                                               .parentId(newParentId)
                                               .build());
    }
    
    /**
     * åˆ é™¤ç»„ç»‡èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹
     */
    public void deleteOrganizationTree(Long orgId, Long customerId) {
        // 1. è·å–æ‰€æœ‰è¦åˆ é™¤çš„èŠ‚ç‚¹
        List<Long> toDeleteIds = findAllDescendantIds(orgId, customerId);
        toDeleteIds.add(orgId);
        
        // 2. è½¯åˆ é™¤ç»„ç»‡èŠ‚ç‚¹
        String updateSql = "UPDATE sys_org_units SET is_deleted = 1, status = '0' WHERE id IN (" +
                          String.join(",", Collections.nCopies(toDeleteIds.size(), "?")) + ")";
        jdbcTemplate.update(updateSql, toDeleteIds.toArray());
        
        // 3. åˆ é™¤ç›¸å…³çš„é—­åŒ…å…³ç³»
        String deleteSql = """
            DELETE FROM sys_org_closure 
            WHERE (ancestor_id IN (%s) OR descendant_id IN (%s)) 
              AND customer_id = ?
            """.formatted(
                String.join(",", Collections.nCopies(toDeleteIds.size(), "?")),
                String.join(",", Collections.nCopies(toDeleteIds.size(), "?"))
            );
        
        Object[] params = Stream.concat(
            Stream.concat(toDeleteIds.stream(), toDeleteIds.stream()),
            Stream.of(customerId)
        ).toArray();
        
        jdbcTemplate.update(deleteSql, params);
    }
}
```

---

### æ–¹æ¡ˆäºŒï¼šåµŒå¥—é›†åˆæ¨¡å‹ (Nested Sets)

#### 2.1 è®¾è®¡åŸç†
é€šè¿‡ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…å·¦å³è¾¹ç•Œå€¼ï¼Œå°†æ ‘å½¢ç»“æ„æ˜ å°„åˆ°æ•°å€¼åŒºé—´ï¼Œå®ç°é«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢ã€‚

#### 2.2 è¡¨ç»“æ„è®¾è®¡
```sql
CREATE TABLE sys_org_units_nested (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100),
    parent_id BIGINT,
    left_value INT NOT NULL COMMENT 'å·¦è¾¹ç•Œå€¼',
    right_value INT NOT NULL COMMENT 'å³è¾¹ç•Œå€¼',
    level INT DEFAULT 0,
    customer_id BIGINT NOT NULL DEFAULT 0,
    status VARCHAR(2) DEFAULT '1',
    is_deleted TINYINT DEFAULT 0,
    
    INDEX idx_customer_boundaries (customer_id, left_value, right_value),
    INDEX idx_level (level),
    UNIQUE KEY uk_customer_left (customer_id, left_value),
    UNIQUE KEY uk_customer_right (customer_id, right_value)
);
```

#### 2.3 æ•°æ®ç¤ºä¾‹
```sql
-- ç»„ç»‡ç»“æ„ï¼šé›†å›¢(1-8) -> åˆ†å…¬å¸(2-5)ï¼ŒæŠ€æœ¯éƒ¨(6-7) -> å¼€å‘ç»„(3-4)
INSERT INTO sys_org_units_nested VALUES
(1, 'é›†å›¢æ€»éƒ¨', 0, 1, 8, 0, 100),  -- åŒ…å«æ‰€æœ‰èŠ‚ç‚¹ [1,8]
(2, 'åˆ†å…¬å¸', 1, 2, 5, 1, 100),    -- åŒ…å«å¼€å‘ç»„ [2,5] 
(3, 'å¼€å‘ç»„', 2, 3, 4, 2, 100),    -- å¶å­èŠ‚ç‚¹ [3,4]
(4, 'æŠ€æœ¯éƒ¨', 1, 6, 7, 1, 100);    -- å¶å­èŠ‚ç‚¹ [6,7]
```

#### 2.4 é«˜æ•ˆæŸ¥è¯¢å®ç°
```java
@Service
public class NestedSetsOrgService {
    
    /**
     * æŸ¥æ‰¾æ‰€æœ‰å­éƒ¨é—¨ - O(log n)å¤æ‚åº¦
     */
    public List<SysOrgUnits> findAllChildren(Long parentId, Long customerId) {
        // å…ˆè·å–çˆ¶èŠ‚ç‚¹çš„è¾¹ç•Œå€¼
        SysOrgUnits parent = getById(parentId);
        if (parent == null) return Collections.emptyList();
        
        String sql = """
            SELECT * FROM sys_org_units_nested 
            WHERE customer_id = ?
              AND left_value > ?
              AND right_value < ?
              AND status = '1'
              AND is_deleted = 0
            ORDER BY left_value
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class),
                                 customerId, parent.getLeftValue(), parent.getRightValue());
    }
    
    /**
     * æŸ¥æ‰¾ç¥–å…ˆè·¯å¾„
     */
    public List<SysOrgUnits> findAncestorPath(Long orgId, Long customerId) {
        SysOrgUnits org = getById(orgId);
        if (org == null) return Collections.emptyList();
        
        String sql = """
            SELECT * FROM sys_org_units_nested
            WHERE customer_id = ?
              AND left_value <= ?
              AND right_value >= ?
              AND status = '1'
              AND is_deleted = 0
            ORDER BY level
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class),
                                 customerId, org.getLeftValue(), org.getRightValue());
    }
    
    /**
     * ç»Ÿè®¡å­èŠ‚ç‚¹æ•°é‡
     */
    public int countChildren(Long parentId, Long customerId) {
        SysOrgUnits parent = getById(parentId);
        if (parent == null) return 0;
        
        // å­èŠ‚ç‚¹æ•° = (right - left - 1) / 2
        return (parent.getRightValue() - parent.getLeftValue() - 1) / 2;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹
     */
    public boolean isLeafNode(Long orgId) {
        SysOrgUnits org = getById(orgId);
        return org != null && (org.getRightValue() - org.getLeftValue()) == 1;
    }
}
```

---

### æ–¹æ¡ˆä¸‰ï¼šä¼˜åŒ–çš„ç‰©åŒ–è·¯å¾„ (Enhanced Materialized Path)

#### 3.1 è®¾è®¡ä¼˜åŒ–ç‚¹
åŸºäºç°æœ‰ancestorsæ–¹æ¡ˆçš„æ€§èƒ½ä¼˜åŒ–ï¼Œä½¿ç”¨å®šé•¿ç¼–ç å’Œç´¢å¼•ä¼˜åŒ–ã€‚

#### 3.2 è¡¨ç»“æ„è®¾è®¡
```sql
CREATE TABLE sys_org_units_path (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    parent_id BIGINT,
    path VARCHAR(500) NOT NULL COMMENT 'è·¯å¾„ç¼–ç  å¦‚:/0001/0002/0003/',
    level INT DEFAULT 0,
    customer_id BIGINT NOT NULL DEFAULT 0,
    status VARCHAR(2) DEFAULT '1',
    is_deleted TINYINT DEFAULT 0,
    
    INDEX idx_customer_path (customer_id, path),
    INDEX idx_path_prefix (path(50)),  -- å‰ç¼€ç´¢å¼•ä¼˜åŒ–
    INDEX idx_level (customer_id, level)
);
```

#### 3.3 è·¯å¾„ç¼–ç è§„åˆ™
```java
@Service
public class PathEncodingService {
    
    private static final int PATH_SEGMENT_LENGTH = 4;
    private static final String PATH_SEPARATOR = "/";
    
    /**
     * ç”Ÿæˆè·¯å¾„ç¼–ç 
     */
    public String generatePath(Long parentId, Long orgId) {
        if (parentId == null || parentId == 0) {
            return PATH_SEPARATOR + String.format("%0" + PATH_SEGMENT_LENGTH + "d", orgId) + PATH_SEPARATOR;
        }
        
        SysOrgUnits parent = getById(parentId);
        String parentPath = parent.getPath();
        String currentSegment = String.format("%0" + PATH_SEGMENT_LENGTH + "d", orgId);
        
        return parentPath + currentSegment + PATH_SEPARATOR;
    }
    
    /**
     * æŸ¥æ‰¾æ‰€æœ‰å­éƒ¨é—¨ - ä½¿ç”¨å‰ç¼€ç´¢å¼•
     */
    public List<SysOrgUnits> findAllChildren(Long parentId, Long customerId) {
        SysOrgUnits parent = getById(parentId);
        if (parent == null) return Collections.emptyList();
        
        String pathPrefix = parent.getPath();
        String sql = """
            SELECT * FROM sys_org_units_path 
            WHERE customer_id = ?
              AND path LIKE CONCAT(?, '%')
              AND path != ?
              AND status = '1'
              AND is_deleted = 0
            ORDER BY path
            """;
        return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(SysOrgUnits.class),
                                 customerId, pathPrefix, pathPrefix);
    }
}
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

### æ€§èƒ½å¯¹æ¯”è¡¨

| æ“ä½œç±»å‹ | Ancestorså­—ç¬¦ä¸² | é—­åŒ…è¡¨(Closure) | åµŒå¥—é›†åˆ(Nested) | ä¼˜åŒ–è·¯å¾„(Path) |
|---------|----------------|----------------|----------------|---------------|
| **æŸ¥è¯¢æ‰€æœ‰å­éƒ¨é—¨** | O(n) 500ms | O(1) 5ms | O(log n) 10ms | O(log n) 15ms |
| **æŸ¥è¯¢ç›´æ¥å­éƒ¨é—¨** | O(n) 200ms | O(1) 2ms | O(log n) 5ms | O(log n) 8ms |
| **æŸ¥è¯¢ç¥–å…ˆè·¯å¾„** | O(n) 100ms | O(1) 3ms | O(log n) 8ms | O(log n) 12ms |
| **æ’å…¥æ–°èŠ‚ç‚¹** | O(1) 5ms | O(k) 20ms | O(n) 100ms | O(1) 8ms |
| **ç§»åŠ¨èŠ‚ç‚¹** | O(n) 2s | O(kÂ²) 50ms | O(n) 5s | O(k) 200ms |
| **åˆ é™¤èŠ‚ç‚¹** | O(n) 1s | O(k) 30ms | O(n) 3s | O(k) 100ms |
| **å­˜å‚¨å¼€é”€** | ä½ | é«˜ | ä½ | ä¸­ |
| **ç»´æŠ¤å¤æ‚åº¦** | ä¸­ | ä¸­ | é«˜ | ä½ |

*æ³¨ï¼šn=æ€»èŠ‚ç‚¹æ•°ï¼Œk=å­æ ‘èŠ‚ç‚¹æ•°*

### é€‚ç”¨åœºæ™¯åˆ†æ

#### 1. é—­åŒ…è¡¨ (Closure Table) - æ¨è
**é€‚ç”¨åœºæ™¯ï¼š**
- âœ… æŸ¥è¯¢å¯†é›†å‹åº”ç”¨ (å¦‚å‘Šè­¦ç³»ç»Ÿçš„ç»„ç»‡æŸ¥è¯¢)
- âœ… ç»„ç»‡ç»“æ„ç›¸å¯¹ç¨³å®š
- âœ… éœ€è¦å¤æ‚çš„å±‚çº§æŸ¥è¯¢ (å¦‚è·¨å±‚çº§ç»Ÿè®¡)

**ä¼˜åŠ¿ï¼š**
- ğŸš€ æŸ¥è¯¢æ€§èƒ½æœ€ä½³ - O(1)å¤æ‚åº¦
- ğŸ”§ æ”¯æŒä»»æ„å¤æ‚çš„å±‚çº§æŸ¥è¯¢
- ğŸ’ª å¹¶å‘å®‰å…¨æ€§å¥½
- ğŸ¯ ç´¢å¼•å‹å¥½ï¼Œå……åˆ†åˆ©ç”¨æ•°æ®åº“ä¼˜åŠ¿

**åŠ£åŠ¿ï¼š**
- ğŸ’¾ å­˜å‚¨ç©ºé—´å ç”¨è¾ƒå¤§ (nÂ²çº§åˆ«)
- ğŸ”„ èŠ‚ç‚¹ç§»åŠ¨æ“ä½œå¤æ‚

#### 2. åµŒå¥—é›†åˆ (Nested Sets)  
**é€‚ç”¨åœºæ™¯ï¼š**
- âœ… è¯»å¤šå†™å°‘çš„åœºæ™¯
- âœ… éœ€è¦å¿«é€Ÿç»Ÿè®¡å­æ ‘ä¿¡æ¯
- âœ… å¯¹å­˜å‚¨ç©ºé—´æœ‰é™åˆ¶

**ä¼˜åŠ¿ï¼š**
- ğŸ’¾ å­˜å‚¨ç©ºé—´çœ (åªéœ€2ä¸ªé¢å¤–å­—æ®µ)
- ğŸ“Š å­æ ‘ç»Ÿè®¡éå¸¸é«˜æ•ˆ
- ğŸ”¢ æ”¯æŒå¤æ‚çš„é›†åˆè¿ç®—

**åŠ£åŠ¿ï¼š**
- âš ï¸ æ’å…¥/ç§»åŠ¨æ“ä½œå¤æ‚ï¼Œéœ€è¦é‡æ–°ç¼–å·
- ğŸ”’ å¹¶å‘æ“ä½œå›°éš¾
- ğŸ› ç»´æŠ¤è¾¹ç•Œå€¼çš„ä¸€è‡´æ€§æœ‰æŒ‘æˆ˜

#### 3. ä¼˜åŒ–ç‰©åŒ–è·¯å¾„ (Enhanced Path)
**é€‚ç”¨åœºæ™¯ï¼š**
- âœ… ä¸­å°è§„æ¨¡ç»„ç»‡ (<10000èŠ‚ç‚¹)  
- âœ… å±‚çº§æ·±åº¦æœ‰é™ (<10å±‚)
- âœ… éœ€è¦ç®€å•çš„å®ç°æ–¹æ¡ˆ

**ä¼˜åŠ¿ï¼š**
- ğŸš€ å®ç°ç®€å•ï¼Œæ˜“äºç†è§£
- ğŸ”§ æ’å…¥æ“ä½œç®€å•
- ğŸ‘ï¸ è·¯å¾„ä¿¡æ¯ç›´è§‚å¯è¯»

**åŠ£åŠ¿ï¼š**
- ğŸ“‰ å¤§è§„æ¨¡æ—¶æ€§èƒ½ä¸‹é™
- ğŸ”„ ç§»åŠ¨æ“ä½œéœ€è¦æ‰¹é‡æ›´æ–°

---

## ğŸ’¡ æœ€ä¼˜å®æ–½æ–¹æ¡ˆæ¨è

### æ¨èï¼šé—­åŒ…è¡¨ + ç¼“å­˜æ··åˆæ–¹æ¡ˆ

åŸºäºæ‚¨çš„å‘Šè­¦ç³»ç»Ÿç‰¹ç‚¹ï¼ˆæŸ¥è¯¢é¢‘ç¹ï¼Œå±‚çº§ç›¸å¯¹ç¨³å®šï¼‰ï¼Œæ¨èé‡‡ç”¨é—­åŒ…è¡¨ä¸ºæ ¸å¿ƒçš„æ··åˆæ–¹æ¡ˆï¼š

#### 1. æ ¸å¿ƒæ¶æ„è®¾è®¡
```java
@Service
public class HybridOrgService {
    
    @Autowired
    private ClosureTableOrgService closureService;
    
    @Autowired  
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String CACHE_PREFIX = "org:tree:";
    private static final int CACHE_EXPIRE_HOURS = 6;
    
    /**
     * æŸ¥æ‰¾å­éƒ¨é—¨ - ç¼“å­˜ä¼˜å…ˆç­–ç•¥
     */
    @Cacheable(value = "org_children", key = "#parentId + '_' + #customerId")
    public List<SysOrgUnits> findChildrenWithCache(Long parentId, Long customerId) {
        String cacheKey = CACHE_PREFIX + "children:" + parentId + ":" + customerId;
        
        // 1. å°è¯•ä»Redisè·å–
        List<SysOrgUnits> cached = (List<SysOrgUnits>) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // 2. ä»é—­åŒ…è¡¨æŸ¥è¯¢
        List<SysOrgUnits> result = closureService.findAllChildren(parentId, customerId);
        
        // 3. ç¼“å­˜ç»“æœ
        if (!result.isEmpty()) {
            redisTemplate.opsForValue().set(cacheKey, result, CACHE_EXPIRE_HOURS, TimeUnit.HOURS);
        }
        
        return result;
    }
    
    /**
     * æŸ¥æ‰¾ç®¡ç†å‘˜ - æ‰¹é‡ä¼˜åŒ–
     */
    public Map<Long, List<Long>> batchFindManagers(List<Long> orgIds, Long customerId) {
        if (orgIds.isEmpty()) return Collections.emptyMap();
        
        // ä½¿ç”¨INæŸ¥è¯¢æ‰¹é‡è·å–
        String sql = """
            SELECT uo.org_id, uo.user_id
            FROM sys_user_org uo
            INNER JOIN sys_org_closure c ON uo.org_id = c.descendant_id
            WHERE c.ancestor_id IN (%s)
              AND c.customer_id = ?
              AND uo.principal = '1'
              AND uo.is_deleted = 0
            """.formatted(String.join(",", Collections.nCopies(orgIds.size(), "?")));
        
        Object[] params = Stream.concat(orgIds.stream(), Stream.of(customerId)).toArray();
        
        List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params);
        
        return rows.stream().collect(Collectors.groupingBy(
            row -> (Long) row.get("org_id"),
            Collectors.mapping(row -> (Long) row.get("user_id"), Collectors.toList())
        ));
    }
}
```

#### 2. å¢é‡ç»´æŠ¤ç­–ç•¥
```java
@Component
public class OrgCacheInvalidationListener {
    
    @EventListener
    @Async
    public void handleOrgChange(SysOrgUnitsChangeEvent event) {
        Long customerId = event.getCustomerId();
        Long orgId = event.getOrgId();
        
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        Set<String> keysToDelete = redisTemplate.keys(CACHE_PREFIX + "*:" + customerId);
        if (!keysToDelete.isEmpty()) {
            redisTemplate.delete(keysToDelete);
        }
        
        // é¢„çƒ­å¸¸ç”¨ç¼“å­˜
        if (event.getEventType() == ChangeEventType.INSERT || 
            event.getEventType() == ChangeEventType.MOVE) {
            preloadCache(orgId, customerId);
        }
    }
    
    private void preloadCache(Long orgId, Long customerId) {
        // å¼‚æ­¥é¢„åŠ è½½å¸¸ç”¨çš„ç»„ç»‡æŸ¥è¯¢
        CompletableFuture.supplyAsync(() -> {
            hybridOrgService.findChildrenWithCache(orgId, customerId);
            return null;
        }).exceptionally(throwable -> {
            log.error("é¢„åŠ è½½ç¼“å­˜å¤±è´¥: orgId={}, customerId={}", orgId, customerId, throwable);
            return null;
        });
    }
}
```

#### 3. æ•°æ®è¿ç§»è„šæœ¬
```sql
-- åˆ›å»ºé—­åŒ…è¡¨
CREATE TABLE sys_org_closure AS SELECT * FROM sys_org_closure WHERE 1=0;

-- è¿ç§»ç°æœ‰æ•°æ®åˆ°é—­åŒ…è¡¨
DELIMITER $$
CREATE PROCEDURE MigrateToClosureTable()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_id, v_parent_id, v_customer_id BIGINT;
    DECLARE org_cursor CURSOR FOR 
        SELECT id, parent_id, customer_id FROM sys_org_units WHERE is_deleted = 0;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- æ¸…ç©ºé—­åŒ…è¡¨
    DELETE FROM sys_org_closure;
    
    OPEN org_cursor;
    read_loop: LOOP
        FETCH org_cursor INTO v_id, v_parent_id, v_customer_id;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- æ’å…¥è‡ªå¼•ç”¨
        INSERT INTO sys_org_closure (ancestor_id, descendant_id, depth, customer_id)
        VALUES (v_id, v_id, 0, v_customer_id);
        
        -- æ’å…¥ç¥–å…ˆå…³ç³»
        IF v_parent_id IS NOT NULL AND v_parent_id > 0 THEN
            INSERT INTO sys_org_closure (ancestor_id, descendant_id, depth, customer_id)
            SELECT ancestor_id, v_id, depth + 1, v_customer_id
            FROM sys_org_closure 
            WHERE descendant_id = v_parent_id AND customer_id = v_customer_id;
        END IF;
        
    END LOOP;
    CLOSE org_cursor;
END$$
DELIMITER ;

-- æ‰§è¡Œè¿ç§»
CALL MigrateToClosureTable();

-- éªŒè¯æ•°æ®å®Œæ•´æ€§
SELECT 
    customer_id,
    COUNT(*) as total_relations,
    COUNT(DISTINCT ancestor_id) as unique_ancestors,
    COUNT(DISTINCT descendant_id) as unique_descendants
FROM sys_org_closure 
GROUP BY customer_id;
```

#### 4. æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
```java
@Component
public class OrgQueryPerformanceMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Timer.Sample sample;
    
    @EventListener
    public void onOrgQuery(OrgQueryEvent event) {
        Timer.Sample.stop(meterRegistry.timer("org.query.duration", 
                                            "type", event.getQueryType(),
                                            "customer", event.getCustomerId().toString()));
    }
    
    @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿ
    public void reportPerformanceMetrics() {
        // ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
        double avgQueryTime = meterRegistry.timer("org.query.duration").mean(TimeUnit.MILLISECONDS);
        long cacheHitRate = calculateCacheHitRate();
        
        if (avgQueryTime > 100) { // å¹³å‡æŸ¥è¯¢æ—¶é—´è¶…è¿‡100ms
            log.warn("ç»„ç»‡æŸ¥è¯¢æ€§èƒ½å‘Šè­¦: å¹³å‡è€—æ—¶={}ms, ç¼“å­˜å‘½ä¸­ç‡={}%", avgQueryTime, cacheHitRate);
            
            if (cacheHitRate < 80) {
                // ç¼“å­˜å‘½ä¸­ç‡ä½ï¼Œè°ƒæ•´ç¼“å­˜ç­–ç•¥
                adjustCacheStrategy();
            }
        }
    }
}
```

---

## ğŸ“ˆ æ€§èƒ½æå‡é¢„æœŸ

### æŸ¥è¯¢æ€§èƒ½æå‡
- **å­éƒ¨é—¨æŸ¥è¯¢**: ä»500msæå‡åˆ°5ms (100å€æå‡)
- **ç¥–å…ˆè·¯å¾„æŸ¥è¯¢**: ä»100msæå‡åˆ°3ms (33å€æå‡)  
- **ç®¡ç†å‘˜æ‰¹é‡æŸ¥è¯¢**: ä»Næ¬¡æŸ¥è¯¢ä¼˜åŒ–åˆ°1æ¬¡æ‰¹é‡æŸ¥è¯¢
- **å¹¶å‘æŸ¥è¯¢**: æ”¯æŒ1000+å¹¶å‘æŸ¥è¯¢è¯·æ±‚

### ç³»ç»Ÿæ‰©å±•æ€§æ”¹è¿›
- **ç»„ç»‡è§„æ¨¡**: æ”¯æŒ10ä¸‡+ç»„ç»‡èŠ‚ç‚¹
- **æŸ¥è¯¢å¤æ‚åº¦**: å¤æ‚å±‚çº§æŸ¥è¯¢<10mså“åº”
- **ç¼“å­˜æ•ˆç‡**: 90%+ç¼“å­˜å‘½ä¸­ç‡
- **ç»´æŠ¤æˆæœ¬**: è‡ªåŠ¨åŒ–ç»´æŠ¤ï¼Œå‡å°‘50%äººå·¥å¹²é¢„

### å®æ–½é£é™©æ§åˆ¶
- **æ¸è¿›å¼è¿ç§»**: æ”¯æŒæ–°æ—§æ–¹æ¡ˆå¹¶è¡Œè¿è¡Œ
- **æ•°æ®ä¸€è‡´æ€§**: åŒå†™éªŒè¯ç¡®ä¿æ•°æ®å‡†ç¡®æ€§  
- **å›æ»šæœºåˆ¶**: å®Œæ•´çš„å›æ»šæ–¹æ¡ˆå’Œæ•°æ®æ¢å¤æµç¨‹
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§è¿ç§»è¿‡ç¨‹ä¸­çš„æ€§èƒ½å˜åŒ–

è¿™å¥—åŸºäºé—­åŒ…è¡¨çš„æ··åˆä¼˜åŒ–æ–¹æ¡ˆå°†ä¸ºæ‚¨çš„å‘Šè­¦ç³»ç»Ÿæä¾›æ¯«ç§’çº§çš„ç»„ç»‡æŸ¥è¯¢èƒ½åŠ›ï¼Œå®Œç¾æ”¯æ’‘å¤§è§„æ¨¡ç»„ç»‡æ¶æ„ä¸‹çš„é«˜æ•ˆå‘Šè­¦å¤„ç†ã€‚