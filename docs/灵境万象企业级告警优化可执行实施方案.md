# 灵境万象企业级告警优化可执行实施方案

## 项目概述

基于现有LJWX健康管理系统，实施统一告警机制优化，实现手表端(HarmonyOS) → 手机端(Flutter/Android) → 后台(Spring Boot) → 大屏(Flask/BigScreen)的全链路告警处理升级。

### 核心目标
- **统一告警来源**: 整合upload_common_event与alert.generate_alert
- **强化规则引擎**: 支持DSL规则配置与智能匹配
- **完善生命周期**: 实现升级、审计、SLA监控
- **大屏联动**: 强化critical告警大屏弹窗机制
- **性能优化**: 实现3,000 ev/s处理能力，P95响应<200ms

### 预期效果
- 告警分发延迟: 200ms → 5ms (97.5%提升)
- 并发处理能力: 100/秒 → 1000/秒 (1000%提升)  
- 误报率: 15-20% → <8% (60%改善)
- 平均响应时间: 30分钟 → <15分钟 (50%提升)

## 架构设计

### 统一事件模型
```json
{
  "source": "watch|server",
  "customerId": "租户ID",
  "orgId": "组织ID", 
  "userId": "用户ID",
  "deviceId": "设备ID",
  "eventType": "HEALTH_METRIC|SYSTEM|FALL|CUSTOM",
  "metric": "heartRate|spo2|temperature|bloodPressureSys|bloodPressureDia|custom",
  "value": 102,
  "unit": "bpm|%|℃|mmHg",
  "raw": {"原始字段保留"},
  "occurAt": "2025-08-31T07:30:00Z"
}
```

### 规则DSL示例
```json
{
  "when": "metric == 'heartRate' && value > 120 for 3m within 5m",
  "level": "major",
  "notify": ["wechat", "email"],
  "throttle": {"suppress": "10m"}, 
  "dedup": {"groupBy": ["userId","metric"], "window": "5m"},
  "autoRecover": {"when": "value < 100 for 5m"},
  "escalation": {"after": "15m", "toLevel": "critical", "extraNotify": ["message","screen_popup"]}
}
```

### 告警状态机
```
NEW → NOTIFIED → ACKED → RESOLVED
 │         │        │       
 │         │        └─ ESCALATED (升级)
 │         └─ ERROR (通知失败)
 └─ AWAITING_REVIEW (人工审核)
```

## 实施阶段

### Phase 1: 数据库结构升级 (1-2天)

#### 1.1 创建迁移脚本
- **文件**: `ljwx-boot/db/migration/V2025_08_31__alerts_optimization.sql`
- **内容**: 包含t_alert_rules、t_alert_info、t_alert_action_log的结构升级

#### 1.2 表结构升级要点

**t_alert_rules 增强**:
```sql
ALTER TABLE t_alert_rules
  ADD COLUMN rule_type VARCHAR(32) NOT NULL DEFAULT 'metric',
  ADD COLUMN metric VARCHAR(64) NULL,
  ADD COLUMN event_type VARCHAR(64) NULL,
  ADD COLUMN dsl JSON NOT NULL,
  ADD COLUMN level VARCHAR(16) NOT NULL DEFAULT 'minor',
  ADD COLUMN notify JSON NOT NULL,
  ADD COLUMN is_enabled TINYINT(1) NOT NULL DEFAULT 1;
```

**t_alert_info 增强**:
```sql
ALTER TABLE t_alert_info
  ADD COLUMN source VARCHAR(16) NOT NULL DEFAULT 'server',
  ADD COLUMN customer_id BIGINT NOT NULL,
  ADD COLUMN org_id BIGINT NULL,
  ADD COLUMN user_id BIGINT NULL,
  ADD COLUMN device_id BIGINT NULL,
  ADD COLUMN level VARCHAR(16) NOT NULL DEFAULT 'minor',
  ADD COLUMN status VARCHAR(24) NOT NULL DEFAULT 'NEW',
  ADD COLUMN dedup_key VARCHAR(128) NULL,
  ADD COLUMN throttle_until DATETIME NULL;
```

#### 1.3 历史数据迁移
- 补充customer_id/org_id/user_id/device_id映射
- 状态字段标准化迁移
- 建立必要索引优化查询性能

### Phase 2: 标准事件入口 (2-3天)

#### 2.1 统一事件接入控制器
- **文件**: `ljwx-boot/ljwx-boot-modules/src/main/java/com/ljwx/modules/alerts/controller/EventsIngestController.java`
- **功能**: 
  - 事件标准化与校验
  - 幂等性处理(eventId去重)
  - Redis Stream/Kafka入队

#### 2.2 事件标准化服务
- **文件**: `ljwx-boot/ljwx-boot-modules/src/main/java/com/ljwx/modules/alerts/service/EventNormalizer.java`
- **功能**:
  - 手表端/服务端事件统一映射
  - 数据验证与清洗
  - 格式标准化处理

### Phase 3: 规则引擎 (3-4天)

#### 3.1 规则引擎核心
- **模块**: `ljwx-boot/ljwx-boot-modules/src/main/java/com/ljwx/modules/alerts/rule/`
- **组件**:
  - RuleEngine.java: DSL解析与执行
  - DeduplicationService.java: 去重逻辑
  - ThrottleService.java: 抑制机制
  - EscalationService.java: 升级策略

#### 3.2 规则匹配策略
- 匹配优先级: custom > metric-specific > global fallback
- 未匹配规则进入人工审核队列
- 支持规则动态开启/关闭

### Phase 4: 生命周期管理 (2-3天)

#### 4.1 SLA调度器
- **文件**: `ljwx-boot/ljwx-boot-modules/src/main/java/com/ljwx/modules/alerts/scheduler/AlertSlaScheduler.java`
- **功能**:
  - ACK超时检测与升级
  - 自恢复条件监控
  - 失败通知补偿

#### 4.2 审计日志完善
- 所有告警操作记录到t_alert_action_log
- 包含操作者、渠道、响应码、错误信息
- 支持告警生命周期完整回溯

### Phase 5: 通知适配器 (3-4天)

#### 5.1 通知通道统一
- **模块**: `ljwx-boot/ljwx-boot-modules/src/main/java/com/ljwx/modules/alerts/notifier/`
- **适配器**:
  - WeChatNotifier.java
  - MessageNotifier.java  
  - EmailNotifier.java
  - WebhookNotifier.java
  - ScreenPopupNotifier.java

#### 5.2 重试与失败处理
- 指数退避重试机制
- 失败原因详细记录
- 通知成功率监控

### Phase 6: 接口与缓存优化 (2-3天)

#### 6.1 查询接口升级
```
GET /api/alerts/mine - 个人告警列表
GET /api/alerts/search - 高级搜索过滤
GET /api/alerts/critical/recent - 大屏告警数据
GET /api/alerts/{id} - 告警详情
POST /api/alerts/{id}/ack - 确认告警
POST /api/alerts/{id}/assign - 指派告警
```

#### 6.2 缓存策略
- Redis缓存键设计:
  - `alert_summary:{customerId}`: 未处理告警统计
  - `alert_user_timeline:{userId:YYYYMM}`: 用户告警时间线
  - `alert_detail:{alertId}`: 告警详情缓存
- 游标分页替代offset深分页
- 缓存失效策略优化

### Phase 7: 大屏联动升级 (2-3天)

#### 7.1 WebSocket告警频道
- **频道**: `/ws/alerts`
- **消息格式**:
```json
{
  "alertId": "告警ID",
  "level": "critical",
  "title": "心率持续过高",
  "userName": "用户姓名",
  "location": {"lon": 113.9, "lat": 22.5},
  "occurAt": "发生时间",
  "actions": ["确认","指派","查看轨迹"],
  "style": "bigscreen_main.html:popup:critical"
}
```

#### 7.2 弹窗组件优化
- **文件**: `ljwx-bigscreen/bigscreen/templates/components/alert_popup.html`
- 支持四级告警样式: info/minor/major/critical
- 集成确认、指派、轨迹查看功能

### Phase 8: 管理界面改造 (2-3天)

#### 8.1 告警管理页面升级
- **文件**: `ljwx-admin/src/views/alerts/alert_view.html`
- **新增功能**:
  - 待审核队列视图
  - 告警时间线展示
  - 批量操作支持
  - 高级过滤搜索

#### 8.2 规则配置界面
- 可视化规则DSL配置
- 规则测试与验证
- 规则启用/禁用管理

### Phase 9: 监控与自告警 (1-2天)

#### 9.1 Prometheus指标暴露
```
alerts_created_total{level}
alerts_notify_success_total{channel}  
alerts_escalated_total
alerts_ack_latency_seconds_bucket
alerts_open_gauge{level}
```

#### 9.2 平台自告警
- 通知失败率 > 阈值触发自告警
- 队列积压深度监控
- 系统性能指标告警

### Phase 10: 测试与验收 (2-3天)

#### 10.1 单元测试
- 规则DSL解析测试
- 去重抑制机制测试
- 升级策略测试
- 自恢复逻辑测试

#### 10.2 集成测试
- 端到端告警流程测试
- 多通道通知测试
- 大屏联动测试

#### 10.3 性能测试
- 3,000 ev/s压力测试
- P95响应时间验证
- 并发处理能力测试
- 缓存命中率测试

## 技术实施细节

### 配置管理
- **告警规则配置**: 存储在t_alert_rules表，支持动态更新
- **通知渠道配置**: 租户级别独立配置
- **SLA参数**: 可配置化升级时间阈值

### 安全与权限
- **租户隔离**: customerId强制过滤
- **细粒度权限**: ALERT_READ, ALERT_ACK, ALERT_ASSIGN, ALERT_RULE_ADMIN, ALERT_AUDIT
- **操作审计**: 所有管理操作记录到审计日志

### 容量规划
- **存储预估**: 基于告警量与历史数据制定分区策略
- **队列长度**: 按峰值处理能力配置缓冲区
- **缓存容量**: 按活跃用户数与热点数据评估

## 风险控制

### 技术风险
- **误报漏报**: 规则灰度发布，开启dry-run模式
- **性能影响**: 分阶段发布，实时监控系统指标
- **数据一致性**: 以t_alert_info.status为单一事实源

### 业务风险  
- **通知成本**: 短信通道限流，优先使用免费通道
- **用户体验**: 保持向后兼容，渐进式功能升级
- **运维复杂度**: 提供完整运维文档与故障排查指南

## 质量保证

### 代码质量
- 单元测试覆盖率 > 85%
- 代码审查机制
- 静态代码分析
- 性能基准测试

### 运维保障
- 完整的回滚方案
- 灰度发布策略  
- 监控告警机制
- 故障应急预案

## 项目时间线

### 总计: 18-24天

| 阶段 | 任务 | 时间 | 负责模块 |
|-----|------|------|----------|
| Phase 1 | 数据库结构升级 | 1-2天 | ljwx-boot |
| Phase 2 | 标准事件入口 | 2-3天 | ljwx-boot |
| Phase 3 | 规则引擎 | 3-4天 | ljwx-boot |
| Phase 4 | 生命周期管理 | 2-3天 | ljwx-boot |
| Phase 5 | 通知适配器 | 3-4天 | ljwx-boot |
| Phase 6 | 接口缓存优化 | 2-3天 | ljwx-boot |
| Phase 7 | 大屏联动升级 | 2-3天 | ljwx-bigscreen |
| Phase 8 | 管理界面改造 | 2-3天 | ljwx-admin |
| Phase 9 | 监控集成 | 1-2天 | 全模块 |
| Phase 10 | 测试验收 | 2-3天 | 全模块 |

## 交付物清单

### 代码交付物
1. **ljwx-boot模块**
   - 事件接入控制器
   - 规则引擎服务  
   - 生命周期调度器
   - 通知适配器
   - 缓存优化接口

2. **ljwx-bigscreen模块**
   - WebSocket告警频道
   - 弹窗组件升级
   - 实时告警处理

3. **ljwx-admin模块**
   - 告警管理界面
   - 规则配置界面
   - 审计日志查看

### 文档交付物
1. API接口文档
2. DSL规则配置指南
3. 运维部署文档
4. 故障排查手册
5. 性能测试报告

### 配置交付物
1. 默认告警规则配置
2. 通知渠道配置模板
3. 监控指标配置
4. Docker部署配置

## 验收标准

### 功能验收
- [ ] 统一事件入口正常工作
- [ ] 规则引擎DSL解析正确
- [ ] 告警生命周期完整
- [ ] 通知多通道发送成功
- [ ] 大屏实时弹窗正常
- [ ] 管理界面功能完整

### 性能验收
- [ ] 3,000 ev/s处理能力
- [ ] P95响应时间 < 200ms
- [ ] Critical告警 < 2s到达大屏
- [ ] 系统资源占用合理

### 质量验收
- [ ] 单元测试覆盖率 > 85%
- [ ] 集成测试通过
- [ ] 压力测试通过
- [ ] 安全测试通过

---

*文档版本: v1.0*  
*创建时间: 2025-08-31*  
*更新时间: 2025-08-31*