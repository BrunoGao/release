# 健康基线评分画像智能生成系统设计方案

## 1. 项目概述

### 1.1 背景分析
基于对系统现有数据结构的深入分析，我们发现：
- **健康数据表** (`t_user_health_data`): 包含心率、血压、血氧、压力、体温、步数、睡眠等多维健康指标
- **健康配置表** (`t_health_data_config`): 定义了各项指标的权重、阈值和监控频率  
- **职位权重表** (`sys_position`): 不同职位对应不同的健康风险系数
- **告警系统** (`t_alert_info`): 记录异常健康事件和严重程度

### 1.2 目标设定
构建一个科学、智能的健康管理系统，实现：
1. **动态健康基线生成**: 基于个体历史数据和群体统计特征
2. **多维度健康评分**: 综合生理指标、职位风险、告警频次
3. **个性化健康建议**: 基于AI算法的精准健康指导
4. **综合健康画像**: 构建用户全方位健康档案

## 2. 系统架构设计

### 2.1 核心模块架构
```
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   数据采集层         │    │   智能分析层         │    │   应用服务层         │
│                     │    │                     │    │                     │
│ • 设备数据采集       │ ──▶│ • 基线算法引擎       │ ──▶│ • 健康评分API       │
│ • 历史数据整理       │    │ • 评分计算引擎       │    │ • 健康建议API       │
│ • 配置参数管理       │    │ • 画像生成引擎       │    │ • 健康档案API       │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
         │                           │                           │
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   数据存储层         │    │   机器学习层         │    │   展示交互层         │
│                     │    │                     │    │                     │
│ • MySQL数据库       │    │ • 异常检测模型       │    │ • 健康仪表盘        │
│ • Redis缓存         │    │ • 风险预测模型       │    │ • 移动端应用        │
│ • 时序数据库        │    │ • 个性化推荐        │    │ • 报表系统          │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
```

### 2.2 数据流架构
```
设备数据 → 数据清洗 → 基线计算 → 评分生成 → 画像构建 → 智能建议 → 用户呈现
    │         │         │         │         │         │         │
    ▼         ▼         ▼         ▼         ▼         ▼         ▼
 原始采集   质量控制   统计分析   权重计算   特征提取   AI推理    个性化展示
```

## 3. 健康基线生成算法

### 3.1 多层次基线体系

#### 3.1.1 个人基线 (Personal Baseline)
```sql
-- 个人历史基线计算
WITH personal_stats AS (
    SELECT 
        user_id, device_sn, customer_id,
        ROUND(AVG(heart_rate), 2) AS avg_heart_rate,
        ROUND(STDDEV(heart_rate), 2) AS std_heart_rate,
        MIN(heart_rate) AS min_heart_rate,
        MAX(heart_rate) AS max_heart_rate,
        COUNT(*) AS sample_count
    FROM t_user_health_data 
    WHERE user_id = ? 
      AND timestamp >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
      AND heart_rate IS NOT NULL
      AND is_deleted = 0
    GROUP BY user_id, device_sn, customer_id
)
INSERT INTO t_health_baseline (
    device_sn, user_id, customer_id, feature_name, baseline_date,
    mean_value, std_value, min_value, max_value, sample_count,
    baseline_time, is_current
) SELECT 
    device_sn, user_id, customer_id, 'heart_rate', CURDATE(),
    avg_heart_rate, std_heart_rate, min_heart_rate, max_heart_rate, sample_count,
    CURDATE(), 1
FROM personal_stats;
```

#### 3.1.2 群体基线 (Population Baseline)
基于年龄段、性别、职位等群体特征建立参考基线：
```sql
-- 年龄段群体基线
WITH age_group_baseline AS (
    SELECT 
        CASE 
            WHEN YEAR(CURDATE()) - YEAR(u.birthday) < 30 THEN 'young'
            WHEN YEAR(CURDATE()) - YEAR(u.birthday) < 50 THEN 'middle'
            ELSE 'senior'
        END AS age_group,
        u.customer_id,
        ROUND(AVG(h.heart_rate), 2) AS group_avg_heart_rate,
        ROUND(STDDEV(h.heart_rate), 2) AS group_std_heart_rate
    FROM t_user_health_data h
    JOIN sys_user u ON h.user_id = u.id
    WHERE h.timestamp >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
      AND h.heart_rate IS NOT NULL
      AND h.is_deleted = 0
      AND u.is_deleted = 0
    GROUP BY age_group, u.customer_id
)
-- 存储群体基线供个性化对比使用
```

#### 3.1.3 职位风险基线 (Position Risk Baseline)
```sql
-- 结合职位风险等级调整基线
WITH position_adjusted_baseline AS (
    SELECT 
        hb.*,
        sp.risk_level,
        sp.weight AS position_weight,
        CASE 
            WHEN sp.risk_level = 'high' THEN hb.mean_value * 0.85
            WHEN sp.risk_level = 'medium' THEN hb.mean_value * 0.90
            ELSE hb.mean_value
        END AS adjusted_mean_value
    FROM t_health_baseline hb
    JOIN sys_user u ON hb.user_id = u.id
    JOIN sys_user_position up ON u.id = up.user_id
    JOIN sys_position sp ON up.position_id = sp.id
    WHERE hb.is_current = 1
      AND u.is_deleted = 0
      AND sp.is_deleted = 0
)
-- 更新调整后的基线
```

### 3.2 时序基线演化

#### 3.2.1 滑动窗口基线更新
- **短期基线**: 7天窗口，捕捉短期健康状态变化
- **中期基线**: 30天窗口，建立个人健康标准
- **长期基线**: 90天窗口，评估健康趋势变化

#### 3.2.2 季节性调整
```python
def seasonal_baseline_adjustment(baseline_data, current_month):
    """
    根据季节调整健康基线
    """
    seasonal_factors = {
        'heart_rate': {
            'winter': 1.02,  # 冬季心率略高
            'spring': 1.00,
            'summer': 0.98,  # 夏季心率略低  
            'autumn': 1.01
        },
        'blood_pressure': {
            'winter': 1.05,  # 冬季血压偏高
            'spring': 1.00,
            'summer': 0.96,
            'autumn': 1.02
        }
    }
    
    season = get_season(current_month)
    adjusted_baseline = {}
    
    for metric, value in baseline_data.items():
        if metric in seasonal_factors:
            factor = seasonal_factors[metric][season]
            adjusted_baseline[metric] = value * factor
        else:
            adjusted_baseline[metric] = value
            
    return adjusted_baseline
```

## 4. 健康评分计算系统

### 4.1 多维度评分模型

#### 4.1.1 生理指标评分 (Physiological Score)
```python
def calculate_physiological_score(health_data, baseline, config):
    """
    基于Z-Score标准化的生理指标评分
    """
    total_score = 0
    weighted_sum = 0
    
    for metric in ['heart_rate', 'blood_oxygen', 'pressure_high', 'pressure_low', 
                   'temperature', 'stress']:
        if metric in health_data and metric in baseline:
            # Z-Score标准化
            z_score = (health_data[metric] - baseline[metric]['mean']) / baseline[metric]['std']
            
            # 转换为健康评分 (0-100)
            if metric in ['heart_rate', 'blood_oxygen']:
                # 正向指标：越接近正常范围越好
                metric_score = 100 - min(abs(z_score) * 15, 50)
            else:
                # 控制指标：偏离基线越多扣分越多
                metric_score = 100 - min(abs(z_score) * 20, 60)
            
            # 获取指标权重
            weight = config.get(metric, {}).get('weight', 0.15)
            total_score += metric_score * weight
            weighted_sum += weight
    
    return total_score / weighted_sum if weighted_sum > 0 else 0
```

#### 4.1.2 行为指标评分 (Behavioral Score)
```python
def calculate_behavioral_score(health_data, targets):
    """
    运动睡眠行为评分
    """
    behavioral_scores = {}
    
    # 运动评分
    daily_steps = health_data.get('step', 0)
    step_target = targets.get('step', 8000)
    step_score = min(daily_steps / step_target * 100, 100)
    
    # 睡眠评分
    daily_sleep = health_data.get('sleep', 0)  # 小时
    if 7 <= daily_sleep <= 9:
        sleep_score = 100
    elif 6 <= daily_sleep < 7 or 9 < daily_sleep <= 10:
        sleep_score = 85
    else:
        sleep_score = max(70 - abs(daily_sleep - 8) * 10, 40)
    
    # 活跃度评分
    daily_distance = health_data.get('distance', 0)
    daily_calories = health_data.get('calorie', 0)
    activity_score = min((daily_distance * 0.3 + daily_calories * 0.01) * 2, 100)
    
    return {
        'step_score': step_score,
        'sleep_score': sleep_score, 
        'activity_score': activity_score,
        'weighted_average': step_score * 0.4 + sleep_score * 0.4 + activity_score * 0.2
    }
```

#### 4.1.3 风险因子评分 (Risk Factor Score)
```python
def calculate_risk_factor_score(user_id, position_weight, alert_history):
    """
    基于告警历史和职位风险的风险因子评分
    """
    base_score = 100
    
    # 职位风险调整
    position_penalty = (1 - position_weight) * 10
    
    # 告警历史惩罚
    alert_penalty = 0
    for alert in alert_history:
        if alert['level'] == 'critical':
            alert_penalty += 15
        elif alert['level'] == 'major':
            alert_penalty += 10
        elif alert['level'] == 'minor':
            alert_penalty += 5
    
    # 频率衰减：近期告警权重更大
    days_penalty = {}
    for alert in alert_history:
        days_ago = (datetime.now() - alert['occur_at']).days
        decay_factor = math.exp(-days_ago / 30)  # 30天衰减期
        days_penalty[alert['id']] = alert_penalty * decay_factor
    
    total_penalty = sum(days_penalty.values()) + position_penalty
    final_score = max(base_score - total_penalty, 20)
    
    return final_score
```

### 4.2 综合健康评分算法

```python
def calculate_comprehensive_health_score(user_id, date_range=30):
    """
    综合健康评分计算主函数
    """
    # 1. 获取用户健康数据
    health_data = get_user_health_data(user_id, date_range)
    
    # 2. 获取个人健康基线
    baseline = get_user_baseline(user_id)
    
    # 3. 获取配置权重
    config = get_health_config(user_id)
    
    # 4. 获取职位风险权重
    position_weight = get_user_position_weight(user_id)
    
    # 5. 获取告警历史
    alert_history = get_user_alerts(user_id, date_range)
    
    # 6. 计算各维度得分
    physiological_score = calculate_physiological_score(health_data, baseline, config)
    behavioral_score = calculate_behavioral_score(health_data, config)
    risk_factor_score = calculate_risk_factor_score(user_id, position_weight, alert_history)
    
    # 7. 加权综合评分
    final_score = (
        physiological_score * 0.5 +    # 生理指标权重50%
        behavioral_score * 0.3 +       # 行为指标权重30%
        risk_factor_score * 0.2        # 风险因子权重20%
    )
    
    # 8. 生成评分详情
    score_detail = {
        'total_score': round(final_score, 2),
        'physiological_score': round(physiological_score, 2),
        'behavioral_score': round(behavioral_score, 2), 
        'risk_factor_score': round(risk_factor_score, 2),
        'score_date': datetime.now().date(),
        'score_level': get_score_level(final_score)
    }
    
    return score_detail

def get_score_level(score):
    """健康等级评定"""
    if score >= 90:
        return 'excellent'
    elif score >= 80:
        return 'good'
    elif score >= 70:
        return 'fair'
    elif score >= 60:
        return 'poor'
    else:
        return 'critical'
```

## 5. 智能健康建议系统

### 5.1 AI驱动的个性化建议

#### 5.1.1 基于决策树的建议生成
```python
def generate_health_recommendations(user_profile, health_score_detail):
    """
    基于决策树和专家规则的健康建议生成
    """
    recommendations = []
    
    # 生理指标建议
    if health_score_detail['physiological_score'] < 70:
        physiological_recommendations = analyze_physiological_issues(user_profile)
        recommendations.extend(physiological_recommendations)
    
    # 行为习惯建议  
    if health_score_detail['behavioral_score'] < 75:
        behavioral_recommendations = analyze_behavioral_issues(user_profile)
        recommendations.extend(behavioral_recommendations)
        
    # 风险预警建议
    if health_score_detail['risk_factor_score'] < 80:
        risk_recommendations = analyze_risk_factors(user_profile)
        recommendations.extend(risk_recommendations)
    
    # 个性化优先级排序
    prioritized_recommendations = prioritize_recommendations(recommendations, user_profile)
    
    return prioritized_recommendations

def analyze_physiological_issues(user_profile):
    """生理指标异常分析和建议"""
    recommendations = []
    
    # 心率异常建议
    if user_profile['avg_heart_rate'] > user_profile['heart_rate_upper_bound']:
        recommendations.append({
            'category': 'physiological',
            'type': 'heart_rate_high',
            'priority': 'high',
            'title': '心率偏高警示',
            'description': '您的平均心率超出正常范围，建议减少剧烈运动，保持充足休息。',
            'actions': [
                '避免过度劳累和精神紧张',
                '保持规律作息，充足睡眠',
                '如持续异常，建议及时就医检查'
            ],
            'timeline': '立即执行'
        })
    
    # 血氧异常建议
    if user_profile['avg_blood_oxygen'] < 95:
        recommendations.append({
            'category': 'physiological',
            'type': 'oxygen_low', 
            'priority': 'high',
            'title': '血氧饱和度偏低',
            'description': '血氧饱和度低于正常值，建议增加有氧运动，改善呼吸系统功能。',
            'actions': [
                '每日进行30分钟有氧运动',
                '保持室内空气流通',
                '戒烟限酒，避免呼吸道刺激'
            ],
            'timeline': '2-4周改善计划'
        })
    
    return recommendations
```

#### 5.1.2 机器学习预测模型
```python
import joblib
from sklearn.ensemble import RandomForestRegressor

class HealthRiskPredictor:
    def __init__(self):
        self.model = self.load_or_train_model()
    
    def predict_health_risk(self, user_features):
        """
        预测用户未来健康风险
        """
        # 特征工程
        processed_features = self.preprocess_features(user_features)
        
        # 风险预测
        risk_probability = self.model.predict_proba(processed_features.reshape(1, -1))
        
        # 风险等级判定
        risk_level = self.classify_risk_level(risk_probability[0][1])
        
        # 生成预测报告
        prediction_report = {
            'risk_probability': risk_probability[0][1],
            'risk_level': risk_level,
            'key_risk_factors': self.identify_risk_factors(processed_features),
            'recommended_actions': self.get_preventive_actions(risk_level)
        }
        
        return prediction_report
    
    def preprocess_features(self, user_features):
        """特征预处理"""
        features = np.array([
            user_features['age'],
            user_features['avg_heart_rate'],
            user_features['avg_blood_pressure_high'],
            user_features['avg_blood_oxygen'],
            user_features['daily_steps'],
            user_features['sleep_hours'],
            user_features['stress_level'],
            user_features['position_risk_weight'],
            user_features['recent_alerts_count'],
            user_features['bmi']
        ])
        return features
```

### 5.2 动态建议更新机制

```python
def update_recommendations_based_on_progress(user_id, recommendation_id):
    """
    根据用户执行情况动态调整建议
    """
    # 获取用户执行反馈
    execution_feedback = get_recommendation_feedback(user_id, recommendation_id)
    
    # 获取最新健康数据
    latest_health_data = get_latest_health_data(user_id)
    
    # 评估建议效果
    effectiveness = evaluate_recommendation_effectiveness(
        execution_feedback, 
        latest_health_data
    )
    
    # 基于效果调整后续建议
    if effectiveness['improvement_rate'] > 0.1:
        # 建议有效，继续当前方案
        updated_recommendations = enhance_current_recommendations(user_id)
    else:
        # 建议效果不佳，调整策略
        updated_recommendations = alternative_recommendations(user_id)
    
    return updated_recommendations
```

## 6. 综合健康画像构建

### 6.1 多维度用户画像模型

#### 6.1.1 基础信息维度
```python
class UserHealthProfile:
    def __init__(self, user_id):
        self.user_id = user_id
        self.basic_info = self.get_basic_info()
        self.health_metrics = self.get_health_metrics()
        self.behavioral_patterns = self.get_behavioral_patterns()
        self.risk_assessment = self.get_risk_assessment()
        self.health_trends = self.get_health_trends()
    
    def get_basic_info(self):
        """获取用户基础信息"""
        return {
            'age': self.calculate_age(),
            'gender': self.get_gender(),
            'occupation': self.get_occupation(),
            'position_risk_level': self.get_position_risk(),
            'organization': self.get_organization(),
            'device_info': self.get_device_info()
        }
    
    def get_health_metrics(self):
        """获取健康指标画像"""
        recent_data = self.get_recent_health_data(30)
        
        return {
            'cardiovascular': {
                'avg_heart_rate': np.mean(recent_data['heart_rate']),
                'heart_rate_variability': np.std(recent_data['heart_rate']),
                'avg_blood_pressure': {
                    'systolic': np.mean(recent_data['pressure_high']),
                    'diastolic': np.mean(recent_data['pressure_low'])
                },
                'cardiovascular_risk_score': self.calculate_cardiovascular_risk()
            },
            'respiratory': {
                'avg_blood_oxygen': np.mean(recent_data['blood_oxygen']),
                'oxygen_stability': np.std(recent_data['blood_oxygen']),
                'respiratory_health_score': self.calculate_respiratory_score()
            },
            'metabolic': {
                'avg_temperature': np.mean(recent_data['temperature']),
                'temperature_regulation': np.std(recent_data['temperature']),
                'metabolic_stability_score': self.calculate_metabolic_score()
            },
            'psychological': {
                'avg_stress_level': np.mean(recent_data['stress']),
                'stress_variability': np.std(recent_data['stress']),
                'psychological_wellness_score': self.calculate_psychological_score()
            }
        }
```

#### 6.1.2 行为模式维度
```python
def get_behavioral_patterns(self):
    """分析用户行为模式"""
    activity_data = self.get_activity_data(90)  # 90天数据
    
    return {
        'activity_patterns': {
            'daily_step_average': np.mean(activity_data['daily_steps']),
            'activity_consistency': self.calculate_activity_consistency(activity_data),
            'peak_activity_hours': self.identify_peak_activity_hours(activity_data),
            'weekend_vs_weekday': self.compare_weekend_weekday_activity(activity_data)
        },
        'sleep_patterns': {
            'avg_sleep_duration': np.mean(activity_data['sleep_hours']),
            'sleep_consistency': np.std(activity_data['sleep_hours']),
            'sleep_quality_score': self.calculate_sleep_quality_score(activity_data),
            'sleep_schedule_regularity': self.analyze_sleep_schedule(activity_data)
        },
        'health_engagement': {
            'device_usage_frequency': self.calculate_device_usage(),
            'health_goal_completion_rate': self.get_goal_completion_rate(),
            'recommendation_follow_rate': self.get_recommendation_compliance()
        }
    }
```

#### 6.1.3 健康趋势维度
```python
def get_health_trends(self):
    """分析健康趋势变化"""
    historical_data = self.get_historical_health_data(180)  # 6个月数据
    
    trends = {}
    for metric in ['heart_rate', 'blood_oxygen', 'pressure_high', 'pressure_low', 'stress']:
        metric_data = historical_data[metric]
        
        # 线性趋势分析
        trend_slope = self.calculate_trend_slope(metric_data)
        
        # 季节性分析
        seasonal_pattern = self.analyze_seasonal_pattern(metric_data)
        
        # 异常点检测
        anomalies = self.detect_anomalies(metric_data)
        
        trends[metric] = {
            'trend_direction': 'improving' if trend_slope < 0 else 'deteriorating' if trend_slope > 0 else 'stable',
            'trend_strength': abs(trend_slope),
            'seasonal_variation': seasonal_pattern,
            'anomaly_frequency': len(anomalies) / len(metric_data),
            'stability_score': self.calculate_stability_score(metric_data)
        }
    
    return trends
```

### 6.2 健康档案生成

#### 6.2.1 个人健康档案结构
```python
def generate_comprehensive_health_profile(user_id):
    """生成综合健康档案"""
    profile = UserHealthProfile(user_id)
    
    health_profile = {
        'profile_id': f"HP_{user_id}_{datetime.now().strftime('%Y%m%d')}",
        'generation_date': datetime.now(),
        'user_basic_info': profile.basic_info,
        
        # 当前健康状态
        'current_health_status': {
            'overall_health_score': profile.calculate_overall_score(),
            'health_level': profile.determine_health_level(),
            'key_health_indicators': profile.get_key_indicators(),
            'immediate_concerns': profile.identify_immediate_concerns()
        },
        
        # 健康指标分析
        'health_metrics_analysis': profile.health_metrics,
        
        # 行为模式分析
        'behavioral_analysis': profile.behavioral_patterns,
        
        # 风险评估
        'risk_assessment': {
            'current_risk_level': profile.assess_current_risk(),
            'future_risk_prediction': profile.predict_future_risk(),
            'risk_factors': profile.identify_risk_factors(),
            'protective_factors': profile.identify_protective_factors()
        },
        
        # 健康趋势
        'health_trends': profile.health_trends,
        
        # 个性化建议
        'personalized_recommendations': generate_health_recommendations(profile),
        
        # 目标设定
        'health_goals': generate_personalized_goals(profile),
        
        # 监测计划
        'monitoring_plan': create_monitoring_plan(profile)
    }
    
    return health_profile
```

#### 6.2.2 健康画像可视化
```python
def create_health_portrait_visualization(health_profile):
    """创建健康画像可视化数据"""
    
    # 雷达图数据：多维度健康指标
    radar_data = {
        'dimensions': ['心血管', '呼吸系统', '代谢功能', '心理健康', '运动能力', '睡眠质量'],
        'values': [
            health_profile['health_metrics_analysis']['cardiovascular']['cardiovascular_risk_score'],
            health_profile['health_metrics_analysis']['respiratory']['respiratory_health_score'],
            health_profile['health_metrics_analysis']['metabolic']['metabolic_stability_score'],
            health_profile['health_metrics_analysis']['psychological']['psychological_wellness_score'],
            health_profile['behavioral_analysis']['activity_patterns']['activity_consistency'],
            health_profile['behavioral_analysis']['sleep_patterns']['sleep_quality_score']
        ]
    }
    
    # 趋势图数据：健康指标变化
    trend_data = {}
    for metric, trend_info in health_profile['health_trends'].items():
        trend_data[metric] = {
            'direction': trend_info['trend_direction'],
            'strength': trend_info['trend_strength'],
            'stability': trend_info['stability_score']
        }
    
    # 风险热力图数据
    risk_heatmap = {
        'risk_factors': health_profile['risk_assessment']['risk_factors'],
        'risk_levels': [factor['severity'] for factor in health_profile['risk_assessment']['risk_factors']],
        'risk_categories': [factor['category'] for factor in health_profile['risk_assessment']['risk_factors']]
    }
    
    return {
        'radar_chart': radar_data,
        'trend_charts': trend_data, 
        'risk_heatmap': risk_heatmap,
        'summary_metrics': extract_summary_metrics(health_profile)
    }
```

## 7. 数据库设计优化

### 7.1 新增表结构设计

#### 7.1.1 健康画像主表
```sql
CREATE TABLE t_user_health_profile (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    customer_id BIGINT NOT NULL,
    profile_date DATE NOT NULL,
    
    -- 综合评分
    overall_health_score DECIMAL(5,2) DEFAULT 0.00,
    health_level VARCHAR(20) DEFAULT 'fair',
    
    -- 各维度评分
    physiological_score DECIMAL(5,2) DEFAULT 0.00,
    behavioral_score DECIMAL(5,2) DEFAULT 0.00,
    risk_factor_score DECIMAL(5,2) DEFAULT 0.00,
    
    -- 健康指标分析
    cardiovascular_score DECIMAL(5,2) DEFAULT 0.00,
    respiratory_score DECIMAL(5,2) DEFAULT 0.00,
    metabolic_score DECIMAL(5,2) DEFAULT 0.00,
    psychological_score DECIMAL(5,2) DEFAULT 0.00,
    
    -- 行为模式分析
    activity_consistency_score DECIMAL(5,2) DEFAULT 0.00,
    sleep_quality_score DECIMAL(5,2) DEFAULT 0.00,
    health_engagement_score DECIMAL(5,2) DEFAULT 0.00,
    
    -- 风险评估
    current_risk_level VARCHAR(20) DEFAULT 'medium',
    predicted_risk_score DECIMAL(5,2) DEFAULT 0.00,
    
    -- JSON扩展字段
    detailed_analysis JSON COMMENT '详细分析数据',
    trend_analysis JSON COMMENT '趋势分析数据',
    recommendations JSON COMMENT '个性化建议',
    
    -- 审计字段
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT(1) DEFAULT 0,
    version INT DEFAULT 1,
    
    UNIQUE KEY idx_user_profile_date (user_id, profile_date, is_deleted),
    KEY idx_customer_date (customer_id, profile_date),
    KEY idx_health_level (health_level, profile_date),
    KEY idx_risk_level (current_risk_level, profile_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户健康画像主表';
```

#### 7.1.2 健康建议执行跟踪表  
```sql
CREATE TABLE t_health_recommendation_track (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    customer_id BIGINT NOT NULL,
    recommendation_id VARCHAR(64) NOT NULL,
    recommendation_type VARCHAR(50) NOT NULL,
    
    -- 建议内容
    title VARCHAR(200) NOT NULL,
    description TEXT,
    recommended_actions JSON,
    
    -- 执行状态
    status VARCHAR(20) DEFAULT 'pending',
    start_date DATE,
    target_completion_date DATE,
    actual_completion_date DATE,
    
    -- 效果评估
    effectiveness_score DECIMAL(5,2),
    user_feedback TEXT,
    health_improvement_metrics JSON,
    
    -- 审计字段
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT(1) DEFAULT 0,
    
    KEY idx_user_status (user_id, status, is_deleted),
    KEY idx_customer_type (customer_id, recommendation_type),
    KEY idx_completion_date (target_completion_date, status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='健康建议执行跟踪表';
```

#### 7.1.3 健康基线优化表
```sql
-- 扩展现有健康基线表
ALTER TABLE t_health_baseline ADD COLUMN baseline_type VARCHAR(20) DEFAULT 'personal' COMMENT '基线类型：personal|population|position';
ALTER TABLE t_health_baseline ADD COLUMN age_group VARCHAR(20) COMMENT '年龄组';
ALTER TABLE t_health_baseline ADD COLUMN gender VARCHAR(10) COMMENT '性别';
ALTER TABLE t_health_baseline ADD COLUMN position_risk_level VARCHAR(20) COMMENT '职位风险等级';
ALTER TABLE t_health_baseline ADD COLUMN seasonal_factor DECIMAL(5,4) DEFAULT 1.0000 COMMENT '季节调整因子';
ALTER TABLE t_health_baseline ADD COLUMN confidence_level DECIMAL(5,4) DEFAULT 0.95 COMMENT '置信水平';

-- 添加优化索引
CREATE INDEX idx_baseline_type_date ON t_health_baseline (baseline_type, baseline_date, is_current);
CREATE INDEX idx_baseline_user_feature ON t_health_baseline (user_id, feature_name, baseline_date);
```

### 7.2 性能优化策略

#### 7.2.1 分表策略
```sql
-- 按月分表的健康数据表
CREATE TABLE t_user_health_data_202501 LIKE t_user_health_data;
CREATE TABLE t_user_health_data_202502 LIKE t_user_health_data;
-- ... 后续月份

-- 分表路由函数
DELIMITER $$
CREATE FUNCTION get_health_data_table_name(input_date DATE) 
RETURNS VARCHAR(50)
READS SQL DATA
DETERMINISTIC
BEGIN
    RETURN CONCAT('t_user_health_data_', DATE_FORMAT(input_date, '%Y%m'));
END $$
DELIMITER ;
```

#### 7.2.2 缓存策略
```python
import redis
import json

class HealthDataCache:
    def __init__(self):
        self.redis_client = redis.Redis(host='localhost', port=6379, db=1)
        self.cache_ttl = 3600  # 1小时缓存
    
    def get_user_health_summary(self, user_id):
        """获取用户健康摘要缓存"""
        cache_key = f"health_summary:{user_id}"
        cached_data = self.redis_client.get(cache_key)
        
        if cached_data:
            return json.loads(cached_data)
        
        # 从数据库获取并缓存
        health_summary = self.calculate_health_summary_from_db(user_id)
        self.redis_client.setex(
            cache_key, 
            self.cache_ttl, 
            json.dumps(health_summary, default=str)
        )
        
        return health_summary
    
    def invalidate_user_cache(self, user_id):
        """当有新数据时清除用户相关缓存"""
        patterns = [
            f"health_summary:{user_id}",
            f"health_baseline:{user_id}:*",
            f"health_score:{user_id}:*"
        ]
        
        for pattern in patterns:
            keys = self.redis_client.keys(pattern)
            if keys:
                self.redis_client.delete(*keys)
```

## 8. 系统实施计划

### 8.1 实施阶段规划

#### 第一阶段：基础数据优化 (2-3周)
1. **数据库结构优化**
   - 新增健康画像相关表
   - 优化现有表结构和索引
   - 实施分表策略

2. **基线算法实现**
   - 个人基线计算算法
   - 群体基线统计算法
   - 季节性调整机制

#### 第二阶段：评分系统开发 (3-4周)  
1. **多维度评分引擎**
   - 生理指标评分算法
   - 行为模式评分算法
   - 风险因子评分算法

2. **智能建议系统**
   - 决策树建议生成
   - 个性化推荐算法
   - 建议效果跟踪

#### 第三阶段：画像系统构建 (4-5周)
1. **健康画像生成**
   - 多维度用户画像模型
   - 健康档案综合分析
   - 可视化展示组件

2. **机器学习模型**
   - 健康风险预测模型
   - 异常检测算法
   - 模型持续优化

#### 第四阶段：系统集成测试 (2-3周)
1. **性能优化**
   - 缓存机制优化
   - 数据库查询优化
   - 系统负载测试

2. **功能测试**
   - 算法准确性验证
   - 用户体验测试
   - 系统稳定性测试

### 8.2 关键技术指标

#### 8.2.1 性能指标
- **基线计算延迟**: < 5秒
- **健康评分生成**: < 3秒  
- **画像生成时间**: < 10秒
- **系统并发能力**: 500+ requests/s
- **数据准确率**: > 95%

#### 8.2.2 业务指标
- **基线覆盖率**: > 90% 用户
- **建议采纳率**: > 60%
- **健康改善率**: > 40%
- **用户满意度**: > 85%
- **系统可用性**: > 99.9%

## 9. 风险控制与质量保证

### 9.1 数据质量控制
```python
class HealthDataQualityController:
    def __init__(self):
        self.validation_rules = self.load_validation_rules()
    
    def validate_health_data(self, health_data):
        """健康数据质量验证"""
        validation_results = {
            'is_valid': True,
            'errors': [],
            'warnings': []
        }
        
        # 数据范围验证
        if health_data.get('heart_rate'):
            if not (30 <= health_data['heart_rate'] <= 200):
                validation_results['errors'].append('心率数据超出合理范围')
                validation_results['is_valid'] = False
        
        # 数据一致性验证
        if health_data.get('pressure_high') and health_data.get('pressure_low'):
            if health_data['pressure_high'] <= health_data['pressure_low']:
                validation_results['errors'].append('血压数据不一致')
                validation_results['is_valid'] = False
        
        # 时间序列合理性验证
        if self.detect_temporal_anomalies(health_data):
            validation_results['warnings'].append('检测到时间序列异常')
        
        return validation_results
```

### 9.2 算法可解释性
```python
def explain_health_score(score_detail, user_profile):
    """健康评分可解释性分析"""
    explanations = {
        'score_breakdown': {
            'physiological_contribution': f"生理指标贡献 {score_detail['physiological_score'] * 0.5:.1f} 分",
            'behavioral_contribution': f"行为习惯贡献 {score_detail['behavioral_score'] * 0.3:.1f} 分",
            'risk_factor_impact': f"风险因子影响 -{(100-score_detail['risk_factor_score']) * 0.2:.1f} 分"
        },
        'key_influencing_factors': analyze_key_factors(score_detail, user_profile),
        'improvement_suggestions': generate_improvement_path(score_detail),
        'comparison_with_peers': compare_with_similar_users(user_profile)
    }
    
    return explanations
```

## 10. 总结与展望

### 10.1 方案核心价值
1. **科学性**: 基于循证医学和统计学原理的健康评估体系
2. **个性化**: 考虑个体差异、职业特点、历史数据的定制化方案
3. **智能化**: 利用AI算法持续优化评估精度和建议效果
4. **实用性**: 提供可执行、可跟踪的健康改善方案
5. **可扩展性**: 模块化设计支持功能持续扩展和优化

### 10.2 预期效果
- **健康管理精准度提升**: 从通用化向个性化转变，预计精准度提升40%
- **用户健康改善率**: 通过科学的基线和评分体系，预期用户健康指标改善率达到60%
- **系统运行效率**: 优化后的算法和缓存机制，系统响应时间缩短80%
- **用户体验提升**: 可视化的健康画像和个性化建议，用户满意度预期提升50%

### 10.3 未来发展方向
1. **深度学习集成**: 引入更先进的神经网络模型进行健康预测
2. **多模态数据融合**: 整合图像、语音、穿戴设备等多元数据源  
3. **实时健康监测**: 构建7×24小时实时健康状态监测体系
4. **群体健康分析**: 扩展到组织级、区域级健康状况分析
5. **健康干预闭环**: 从被动监测向主动健康干预转变

---

**文档版本**: v1.0  
**创建日期**: 2025-08-31  
**负责人**: 健康管理系统开发团队  
**审核状态**: 待审核

*本方案为灵境万象健康管理系统的核心技术方案，包含完整的设计思路、实现算法、数据库设计和实施计划。方案充分考虑了系统的科学性、实用性和可扩展性，为构建智能化的健康管理平台奠定了坚实的技术基础。*