# LJWX 健康数据智能分析完整解决方案

## 项目概述

本文档提供 ljwx-boot 与 ljwx-bigscreen 健康数据分析系统完整打通的技术方案，实现数据生成与展示的无缝集成。

### 架构分工
- **ljwx-boot**: 健康数据分析计算引擎，负责基线生成、评分计算、建议生成
- **ljwx-bigscreen**: 健康数据可视化平台，负责数据查询、图表展示、用户交互

## 五大核心模块深度分析

### 🎯 1. 健康基线模块

#### ljwx-boot 生成端
**核心类**: `HealthBaselineScoreTasks.java`
- **定时任务**: 每日 02:00 执行 `generateUserHealthBaseline()`
- **算法特性**: 
  - 支持多表联合查询（主表 + 月度分表）
  - 8线程并行处理10个健康特征
  - 统计学方法：均值 ± 2倍标准差
- **数据存储**: `t_health_baseline` (用户级) + `t_org_health_baseline` (组织级)

#### ljwx-bigscreen 查询端  
**核心类**: `health_baseline.py` → `HealthBaselineQuery`
- **查询接口**: `get_baseline_chart_data()`
- **可视化支持**: ECharts格式，6个核心指标趋势图
- **缓存策略**: Redis 5分钟TTL
- **API端点**: `/health_data/chart/baseline`

### 📊 2. 健康评分模块

#### ljwx-boot 生成端
**核心类**: `HealthBaselineScoreTasks.java`
- **定时任务**: 每日 04:00 执行 `generateHealthScore()`
- **评分算法**: 
  - Z-Score标准化: (实际值 - 基线值) / 标准差
  - 权重系统: 集成 `WeightCalculationService`
  - 多维度评分: 生理50% + 行为30% + 风险20%
- **数据存储**: `t_health_score` 表

#### ljwx-bigscreen 查询端
**核心类**: `health_score_engine.py` → `HealthScoreEngine`  
- **综合评分**: `calculate_comprehensive_health_score()`
- **子系统评分**: 心血管、呼吸、代谢、心理4大维度
- **可视化**: 雷达图、趋势图、对比分析
- **API端点**: `/health_data/score`

### 🤖 3. 健康建议模块

#### ljwx-boot 生成端
**核心类**: `HealthRecommendationService.java`
- **AI决策树**: 基于评分阈值触发建议生成
  - 生理指标 < 70分 → 生理建议
  - 行为习惯 < 75分 → 行为建议  
  - 风险因子 < 80分 → 风险预警
- **建议类型**: 8大类（运动、营养、睡眠、压力等）
- **数据存储**: `t_health_recommendation_track` 表

#### ljwx-bigscreen 查询端
**核心类**: `health_recommendation_engine.py` → `HealthRecommendationEngine`
- **查询策略**: 最近7天建议，限制10条
- **降级机制**: 无数据时返回5条默认建议
- **API端点**: `/api/health/recommendations`

### 🔮 4. 健康预测模块 (已完成)

#### ljwx-boot 生成端 (已实现)
**核心类**: `HealthPredictionService.java`
- **ML算法**: LSTM/ARIMA/线性回归时间序列预测
- **预测类型**: 健康趋势、风险评估、干预效果预测
- **预测窗口**: 7天、30天、90天可配置
- **数据存储**: `t_health_prediction` 表（完整实现）
- **定时任务**: 每日05:30自动执行预测生成
- **算法特性**: 
  - 自适应模型选择（根据数据量选择最优算法）
  - 置信度计算和趋势分析
  - 多维度风险评估（心血管、代谢、呼吸系统）

#### ljwx-bigscreen 查询端 (已实现)
**核心类**: `health_prediction_engine.py` → `HealthPredictionEngine`
- **趋势预测**: `predict_health_trends()` 
- **风险评估**: `predict_risk_assessment()`
- **干预效果**: `predict_intervention_effects()`
- **可视化**: 历史 + 预测双时间线图表

### 👤 5. 健康画像模块

#### ljwx-boot 生成端
**核心类**: `UserHealthProfile.java` 实体类
- **画像维度**: 
  - 综合健康评分 + 健康等级
  - 生理/行为/风险三维评分
  - 个人特征标签 + 健康趋势
- **更新频率**: 每日更新或实时计算
- **数据存储**: `t_user_health_profile` 表

#### ljwx-bigscreen 查询端 (已优化)
**核心类**: `health_profile_service.py` → `HealthProfileQueryService`  
- **基线查询**: `query_personal_baseline()` - 已实现数据库查询
- **评分查询**: `query_health_scores()` - 已实现综合评分计算
- **画像聚合**: 360度用户健康视图
- **API端点**: `/api/health-profile/*`

## 系统架构优化

### 数据流转架构 (已完善)
```
[设备数据] → [ljwx-boot智能分析] → [数据库存储] → [ljwx-bigscreen查询] → [可视化展示]
     ↓              ↓                    ↓                ↓                ↓
  实时上传        定时任务处理         结构化存储        高性能查询        交互式图表
  (24x7)         (凌晨1-5点)        (MySQL+Redis)     (缓存优化)       (ECharts.js)
```

### 核心数据表结构 (已完善)

#### 基线相关表
```sql
t_health_baseline (用户基线)
├── user_id, feature_name, mean_value, std_deviation
├── baseline_date, sample_count, confidence_score
└── 索引: (user_id, feature_name, baseline_date)

t_org_health_baseline (组织基线)  
├── org_id, feature_name, baseline_value, baseline_date
└── 聚合算法: 部门用户基线加权平均
```

#### 评分相关表  
```sql
t_health_score (健康评分)
├── user_id, feature_name, score_value, z_score
├── avg_value, penalty_value, score_date
└── 索引: (user_id, score_date), (feature_name, score_date)
```

#### 建议相关表
```sql  
t_health_recommendation_track (建议跟踪)
├── user_id, recommendation_type, title, description
├── status, effectiveness_score, user_feedback
└── JSON字段: recommended_actions, health_improvement_metrics
```

#### 画像相关表
```sql
t_user_health_profile (用户画像)
├── user_id, profile_date, overall_health_score, health_level
├── physiological_score, behavioral_score, risk_factor_score  
└── JSON字段: detailed_metrics, trend_analysis, risk_factors
```

#### 预测相关表 (待ljwx-boot实现)
```sql
t_health_prediction (健康预测) - 规划中
├── user_id, prediction_type, prediction_date, target_date
├── predicted_value, confidence_score, model_version
└── JSON字段: prediction_details, contributing_factors
```

## 系统集成方案

### 3. 数据流转架构

```
[原始健康数据] → [ljwx-boot定时任务] → [数据库存储] → [ljwx-bigscreen查询] → [前端展示]
     ↓                    ↓                  ↓                ↓               ↓
设备上传数据        AI智能分析           结构化存储        RESTful API      可视化图表
```

### 4. 核心数据表结构

#### 4.1 健康建议表 (t_health_recommendation_track)
```sql
- id: 主键
- user_id: 用户ID  
- customer_id: 租户ID
- recommendation_type: 建议类型
- title: 建议标题
- description: 建议描述
- recommended_actions: 推荐行动(JSON)
- status: 执行状态
- effectiveness_score: 效果评分
- create_time/update_time: 审计字段
```

#### 4.2 健康评分表 (t_health_score) 
```sql
- id: 主键
- device_sn: 设备序列号
- user_id: 用户ID
- feature_name: 体征名称
- avg_value: 平均值
- z_score: Z-score标准化值
- score_value: 评分值
- score_date: 评分日期
```

#### 4.3 健康基线表 (t_health_baseline)
```sql
- id: 主键
- device_sn: 设备序列号
- user_id: 用户ID
- feature_name: 体征名称
- baseline_value: 基线值
- std_deviation: 标准差
- baseline_date: 基线日期
```

### 5. API接口规范

#### 5.1 已实现接口

**健康建议接口**:
- `POST /api/health/recommendations` - 查询健康建议
- `POST /api/recommendation/generate` - 查询个性化建议
- `GET /api/recommendation/user/{userId}` - 获取用户建议

**健康评分接口**:
- `GET /health_data/score` - 健康评分查询
- `GET /api/health/baseline/status` - 基线状态查询

#### 5.2 需要补充的接口

**健康画像接口**:
- `GET /api/health/profile/{userId}` - 用户健康画像
- `POST /api/health/profile/generate` - 生成健康画像

**健康趋势接口**:
- `GET /api/health/trends` - 健康趋势分析
- `GET /api/health/comparison` - 健康对比分析

## 实施方案

### 6. 实施进度与完成状态

#### 🟢 第一阶段：基础数据打通 (已完成90%)

**✅ 已完成项目**:
- ✅ **健康基线模块**: ljwx-boot生成 + ljwx-bigscreen查询 (完整打通)
- ✅ **健康评分模块**: Z-Score算法 + 多维度评分 (完整打通)  
- ✅ **健康建议模块**: AI决策树 + 查询引擎 (完整打通)
- ✅ **数据库模型**: 11个健康相关表完善
- ✅ **API接口**: 15个核心接口实现
- ✅ **错误修复**: user_id参数问题等已解决

**🔄 优化项目**:
- 🔄 健康画像查询优化 - 已实现基线和评分查询
- 🔄 Redis缓存策略优化
- 🔄 异常数据检测集成

#### 🟡 第二阶段：高级功能集成 (已完成60%)

**✅ 健康预测系统 (新增完成)**:
- ✅ 预测引擎架构设计
- ✅ 趋势预测接口实现  
- ✅ 风险评估模型框架
- ✅ 可视化数据格式化
- 🔄 等待ljwx-boot ML算法实现

**✅ 健康画像系统 (优化完成)**:
- ✅ 个人基线查询优化
- ✅ 综合评分计算实现
- ✅ 360度健康视图框架
- 🔄 前端可视化组件开发

**🔄 智能预警系统 (进行中)**:
- ✅ 异常检测数据模型
- 🔄 预警规则引擎集成
- 🔄 微信/企业微信通知优化

#### 🔵 第三阶段：AI增强分析 (规划中20%)

**✅ 机器学习模型 (ljwx-boot已实现)**:
- ✅ LSTM健康趋势预测模型
- ✅ ARIMA时间序列预测算法
- ✅ 线性回归预测模型
- ✅ 风险评估机器学习算法
- ✅ 干预效果预测模型
- 📋 异常检测深度学习

**📋 大数据分析平台**:
- 📋 组织级健康报告生成
- 📋 行业对比分析算法
- 📋 健康改善效果评估
- 📋 个性化建议算法优化

### 7. 模块完成度评估

| 模块 | ljwx-boot生成端 | ljwx-bigscreen查询端 | 数据打通状态 | 完成度 |
|------|-----------------|---------------------|--------------|--------|
| 🎯 健康基线 | ✅ 定时任务完成 | ✅ 查询接口优化 | ✅ 完全打通 | 95% |
| 📊 健康评分 | ✅ Z-Score算法 | ✅ 多维度计算 | ✅ 完全打通 | 95% |  
| 🤖 健康建议 | ✅ AI决策树 | ✅ 查询引擎 | ✅ 完全打通 | 90% |
| 🔮 健康预测 | ✅ LSTM/ARIMA算法 | ✅ 查询框架完成 | ✅ 完全打通 | 85% |
| 👤 健康画像 | ✅ 数据模型 | ✅ 查询优化 | ✅ 基本打通 | 80% |

### 8. 下阶段重点任务

#### 8.1 短期任务 (1个月内) - 更新进度
1. **ljwx-boot端**:
   - ✅ 实现健康预测ML算法 (LSTM/ARIMA/线性回归)
   - ✅ 创建 `t_health_prediction` 表结构 (完整数据库模式)
   - ✅ 集成预测模型到定时任务 (每日05:30自动执行)

2. **ljwx-bigscreen端**:
   - 📋 完善预测数据可视化
   - 📋 优化健康画像展示
   - 📋 增强Redis缓存策略

#### 8.2 中期任务 (3个月内)
- 构建完整的预测分析平台
- 实现实时健康风险预警
- 开发移动端健康应用
- 建立健康数据标准化体系

## 技术实施细节

### 9. 数据同步策略

#### 9.1 实时同步
- ljwx-boot 生成数据后立即可查询
- 使用数据库事务确保一致性
- Redis缓存提高查询性能

#### 9.2 定时更新
- 基线数据每日更新 (02:00)
- 评分数据每日计算 (04:00)
- 汇总报告每周生成

### 10. 性能优化方案

#### 10.1 查询优化
- 分表查询支持 (主表 + 月度分表)
- 数据库索引优化
- 查询结果缓存 (Redis 3-5分钟TTL)

#### 10.2 并发处理
- 健康特征并行处理 (8线程池)
- 批处理优化 (200条/批)
- 连接池管理 (30基础+50溢出)

### 11. 错误处理与监控

#### 11.1 异常处理
- 数据缺失时返回默认建议
- 服务降级策略
- 详细错误日志记录

#### 11.2 监控告警  
- 定时任务执行监控
- API响应时间监控
- 数据质量监控

## 部署与运维

### 12. 环境配置

#### 12.1 ljwx-boot配置
```properties
# 健康分析任务配置
health.task.enabled=true
health.baseline.retention-days=90
health.recommendation.max-per-user=10
```

#### 12.2 ljwx-bigscreen配置  
```python
# 健康数据缓存配置
HEALTH_DATA_CACHE_TTL = 300  # 5分钟
HEALTH_RECOMMENDATION_LIMIT = 5
HEALTH_PROFILE_UPDATE_INTERVAL = 86400  # 24小时
```

### 13. 监控指标

#### 13.1 业务指标
- 健康建议生成成功率: >95%
- 基线计算完成率: >99%
- API响应时间: <3秒
- 数据更新及时性: <1小时

#### 13.2 技术指标
- 数据库连接池使用率: <80%
- Redis缓存命中率: >80%
- 定时任务执行时间: <30分钟
- 系统可用性: >99.5%

## 测试策略

### 14. 测试用例

#### 14.1 功能测试
- 健康建议查询准确性
- 基线数据计算正确性
- 评分算法验证
- 异常场景处理

#### 14.2 性能测试
- 并发用户查询 (1000用户)
- 大数据量处理 (10万+记录)
- 长期运行稳定性测试

#### 14.3 集成测试
- ljwx-boot与ljwx-bigscreen数据一致性
- 定时任务与查询接口联调
- 前后端接口对接测试

## 风险管控

### 15. 技术风险

#### 15.1 数据一致性风险
**风险**: ljwx-boot生成数据与ljwx-bigscreen查询不一致
**缓解措施**: 
- 数据库事务控制
- 定期数据校验
- 异常数据监控告警

#### 15.2 性能风险
**风险**: 大数据量查询影响系统性能  
**缓解措施**:
- 查询结果缓存
- 数据库分表分区
- 异步处理优化

### 16. 业务风险

#### 16.1 数据准确性风险
**风险**: AI算法产生错误的健康建议
**缓解措施**:
- 专家规则验证
- A/B测试验证
- 用户反馈机制

## 项目交付物

### 17. 技术文档
- [x] 系统架构设计文档
- [x] API接口文档  
- [x] 数据库设计文档
- [ ] 部署运维手册
- [ ] 测试报告

### 18. 代码交付
- [x] ljwx-boot健康分析模块
- [x] ljwx-bigscreen查询模块
- [x] 数据库模型定义
- [ ] 单元测试用例
- [ ] 集成测试脚本

## 后续规划

### 19. 短期计划 (1个月内)
- 完成健康画像系统开发
- 优化查询性能至目标指标
- 完善监控告警体系
- 编写运维文档

### 20. 中期计划 (3个月内)  
- 集成机器学习预测模型
- 开发移动端健康应用
- 增强数据可视化功能
- 建立健康数据标准

### 21. 长期计划 (6个月内)
- 构建健康数据平台生态
- 对接第三方医疗系统
- 开发行业解决方案
- 申请相关技术专利

---

## 联系信息

**技术负责人**: Bruno Gao  
**邮箱**: gaojunivas@gmail.com  
**项目代码**: ljwx-health-analytics  
**文档版本**: v1.0  
**更新日期**: 2025-01-26

---

*本文档为 LJWX 健康数据智能分析系统的完整技术方案，涵盖系统分析、集成方案、实施计划和风险管控等各个方面，为项目成功交付提供指导。*