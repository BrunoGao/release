# çµå¢ƒä¸‡è±¡æ¶ˆæ¯ç³»ç»Ÿæ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

åŸºäºå¯¹å½“å‰ç³»ç»Ÿçš„æ·±å…¥åˆ†æï¼Œæœ¬æ–¹æ¡ˆæ—¨åœ¨è§£å†³æ¶ˆæ¯ç³»ç»Ÿåœ¨**è¡¨ç»“æ„**ã€**æŸ¥è¯¢**ã€**å­˜å‚¨**å’Œ**è·Ÿè¸ª**å››ä¸ªç»´åº¦çš„æ€§èƒ½ç“¶é¢ˆï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

- **æŸ¥è¯¢æ€§èƒ½**: å¤æ‚æŸ¥è¯¢å“åº”æ—¶é—´ä» 500ms ä¼˜åŒ–åˆ° 5ms
- **å¹¶å‘èƒ½åŠ›**: æ”¯æŒ 1000+ TPS çš„æ¶ˆæ¯å¤„ç†èƒ½åŠ›
- **å­˜å‚¨æ•ˆç‡**: å‡å°‘ 40% çš„å­˜å‚¨ç©ºé—´å ç”¨
- **å¯æ‰©å±•æ€§**: æ”¯æŒ 100 å€æ•°æ®å¢é•¿æ— æ€§èƒ½è¡°å‡

---

## ğŸ“Š ç¬¬ä¸€éƒ¨åˆ†ï¼šè¡¨ç»“æ„ä¼˜åŒ–

### 1.1 ç°çŠ¶é—®é¢˜åˆ†æ

#### å…³é”®é—®é¢˜æ€»ç»“
| é—®é¢˜ç±»å‹ | å…·ä½“é—®é¢˜ | å½±å“ç¨‹åº¦ | è§£å†³ä¼˜å…ˆçº§ |
|----------|----------|----------|------------|
| **å¤šç§Ÿæˆ·æ”¯æŒä¸å®Œæ•´** | ç¼ºå°‘ customer_id å¤åˆç´¢å¼• | é«˜ | P0 |
| **æ•°æ®ç±»å‹ä½æ•ˆ** | VARCHAR æ»¥ç”¨ï¼Œç¼ºå°‘ ENUM | ä¸­ | P1 |
| **å¤–é”®çº¦æŸç¼ºå¤±** | message_id ç±»å‹ä¸åŒ¹é… | é«˜ | P0 |
| **ç´¢å¼•è®¾è®¡ä¸åˆç†** | è¯¦æƒ…è¡¨æ— æœ‰æ•ˆç´¢å¼• | é«˜ | P0 |
| **å½’æ¡£ç­–ç•¥ç¼ºå¤±** | æ— å†å²æ•°æ®æ¸…ç†æœºåˆ¶ | ä½ | P2 |

### 1.2 ä¼˜åŒ–åè¡¨ç»“æ„è®¾è®¡

#### 1.2.1 ä¸»æ¶ˆæ¯è¡¨ä¼˜åŒ– (t_device_message)

```sql
-- ä¼˜åŒ–åçš„ä¸»æ¶ˆæ¯è¡¨ç»“æ„
CREATE TABLE `t_device_message_v2` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `customer_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `department_id` bigint NOT NULL COMMENT 'éƒ¨é—¨ID(æ•°å€¼å‹)',
  `user_id` bigint NULL COMMENT 'ç”¨æˆ·ID',
  `device_sn` varchar(64) NOT NULL COMMENT 'è®¾å¤‡åºåˆ—å·(ä¼˜åŒ–é•¿åº¦)',
  `message` text NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `message_type` enum('task','job','announcement','notification','alert','emergency') NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹',
  `sender_type` enum('system','user','device','admin') NOT NULL COMMENT 'å‘é€è€…ç±»å‹',
  `receiver_type` enum('user','device','department','all') NOT NULL COMMENT 'æ¥æ”¶è€…ç±»å‹',
  `priority_level` tinyint NOT NULL DEFAULT 3 COMMENT 'ä¼˜å…ˆçº§(1-5)',
  `message_status` enum('pending','processing','delivered','acknowledged','failed','expired') NOT NULL DEFAULT 'pending',
  `sent_time` datetime(3) NULL COMMENT 'å‘é€æ—¶é—´(æ¯«ç§’ç²¾åº¦)',
  `received_time` datetime(3) NULL COMMENT 'æ¥æ”¶æ—¶é—´',
  `expired_time` datetime(3) NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `responded_count` int NOT NULL DEFAULT 0 COMMENT 'å“åº”ç”¨æˆ·æ•°',
  `target_count` int NOT NULL DEFAULT 0 COMMENT 'ç›®æ ‡ç”¨æˆ·æ•°',
  
  -- å®¡è®¡å­—æ®µ
  `create_user_id` bigint NULL COMMENT 'åˆ›å»ºç”¨æˆ·ID',
  `create_time` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  `update_user_id` bigint NULL COMMENT 'æ›´æ–°ç”¨æˆ·ID', 
  `update_time` datetime(3) NULL ON UPDATE CURRENT_TIMESTAMP(3),
  `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°',
  `version` int NOT NULL DEFAULT 1 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  
  PRIMARY KEY (`id`),
  
  -- ä¼˜åŒ–ç´¢å¼•ç­–ç•¥
  KEY `idx_customer_time` (`customer_id`, `create_time` DESC, `is_deleted`),
  KEY `idx_customer_dept_status` (`customer_id`, `department_id`, `message_status`, `is_deleted`),
  KEY `idx_customer_user_type` (`customer_id`, `user_id`, `message_type`, `is_deleted`),
  KEY `idx_device_time` (`device_sn`, `create_time` DESC),
  KEY `idx_status_priority_time` (`message_status`, `priority_level`, `create_time` DESC),
  KEY `idx_sent_time` (`sent_time`),
  KEY `idx_expired_cleanup` (`expired_time`, `is_deleted`) COMMENT 'è¿‡æœŸæ•°æ®æ¸…ç†ç´¢å¼•',
  
  -- åˆ†åŒºé”®ç´¢å¼•
  KEY `idx_partition_key` (`create_time`, `customer_id`)
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='è®¾å¤‡æ¶ˆæ¯è¡¨V2-ä¼˜åŒ–ç‰ˆ'
  -- æŒ‰æœˆåˆ†åŒº
  PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION p202504 VALUES LESS THAN (TO_DAYS('2025-05-01')),
    PARTITION p202505 VALUES LESS THAN (TO_DAYS('2025-06-01')),
    PARTITION p202506 VALUES LESS THAN (TO_DAYS('2025-07-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
  );
```

#### 1.2.2 æ¶ˆæ¯è¯¦æƒ…è¡¨ä¼˜åŒ– (t_device_message_detail)

```sql
-- ä¼˜åŒ–åçš„æ¶ˆæ¯è¯¦æƒ…è¡¨
CREATE TABLE `t_device_message_detail_v2` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `message_id` bigint NOT NULL COMMENT 'ä¸»æ¶ˆæ¯ID(ä¿®å¤æ•°æ®ç±»å‹)',
  `customer_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID(ç»§æ‰¿)',
  `device_sn` varchar(64) NOT NULL COMMENT 'è®¾å¤‡åºåˆ—å·',
  `user_id` bigint NULL COMMENT 'å“åº”ç”¨æˆ·ID',
  `response_message` text NULL COMMENT 'å“åº”æ¶ˆæ¯å†…å®¹',
  `response_type` enum('acknowledged','rejected','timeout','manual') NOT NULL COMMENT 'å“åº”ç±»å‹',
  `response_time` datetime(3) NULL COMMENT 'å“åº”æ—¶é—´',
  `delivery_status` enum('pending','delivered','failed','retry') NOT NULL DEFAULT 'pending',
  `retry_count` tinyint NOT NULL DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
  `last_retry_time` datetime(3) NULL COMMENT 'æœ€åé‡è¯•æ—¶é—´',
  
  -- è¿½è¸ªå­—æ®µ
  `client_info` json NULL COMMENT 'å®¢æˆ·ç«¯ä¿¡æ¯(è®¾å¤‡å‹å·ã€ç‰ˆæœ¬ç­‰)',
  `location_info` json NULL COMMENT 'ä½ç½®ä¿¡æ¯',
  
  -- å®¡è®¡å­—æ®µ
  `create_time` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  `update_time` datetime(3) NULL ON UPDATE CURRENT_TIMESTAMP(3),
  `is_deleted` tinyint(1) NOT NULL DEFAULT 0,
  
  PRIMARY KEY (`id`),
  
  -- å¤–é”®çº¦æŸ
  CONSTRAINT `fk_message_detail` FOREIGN KEY (`message_id`) REFERENCES `t_device_message_v2` (`id`) ON DELETE CASCADE,
  
  -- ä¼˜åŒ–ç´¢å¼•
  UNIQUE KEY `uk_message_device` (`message_id`, `device_sn`, `user_id`),
  KEY `idx_customer_message` (`customer_id`, `message_id`),
  KEY `idx_customer_device_time` (`customer_id`, `device_sn`, `create_time` DESC),
  KEY `idx_response_time` (`response_time`),
  KEY `idx_delivery_status_retry` (`delivery_status`, `retry_count`, `last_retry_time`),
  KEY `idx_partition_key` (`create_time`, `customer_id`)
  
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  COMMENT='æ¶ˆæ¯è¯¦æƒ…è¡¨V2-ä¼˜åŒ–ç‰ˆ'
  -- ä¸ä¸»è¡¨åŒæ­¥åˆ†åŒº
  PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION p202504 VALUES LESS THAN (TO_DAYS('2025-05-01')),
    PARTITION p202505 VALUES LESS THAN (TO_DAYS('2025-06-01')),
    PARTITION p202506 VALUES LESS THAN (TO_DAYS('2025-07-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
  );
```

#### 1.2.3 æ–°å¢ï¼šæ¶ˆæ¯åˆ†å‘è®°å½•è¡¨

```sql
-- æ–°å¢åˆ†å‘è¿½è¸ªè¡¨
CREATE TABLE `t_message_distribution` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `message_id` bigint NOT NULL,
  `customer_id` bigint NOT NULL,
  `distribution_batch_id` varchar(64) NOT NULL COMMENT 'åˆ†å‘æ‰¹æ¬¡ID',
  `target_type` enum('user','department','device','broadcast') NOT NULL,
  `target_id` varchar(64) NOT NULL COMMENT 'ç›®æ ‡ID',
  `channel_type` enum('websocket','wechat','sms','email','push') NOT NULL,
  `distribution_status` enum('pending','processing','success','failed','timeout') NOT NULL DEFAULT 'pending',
  `attempt_count` tinyint NOT NULL DEFAULT 1,
  `last_attempt_time` datetime(3) NOT NULL,
  `success_time` datetime(3) NULL,
  `error_message` varchar(500) NULL,
  `create_time` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  
  PRIMARY KEY (`id`),
  KEY `idx_message_batch` (`message_id`, `distribution_batch_id`),
  KEY `idx_customer_status_time` (`customer_id`, `distribution_status`, `create_time` DESC),
  KEY `idx_target_channel` (`target_type`, `target_id`, `channel_type`),
  KEY `idx_retry_pending` (`distribution_status`, `attempt_count`, `last_attempt_time`),
  
  CONSTRAINT `fk_distribution_message` FOREIGN KEY (`message_id`) REFERENCES `t_device_message_v2` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¶ˆæ¯åˆ†å‘è®°å½•è¡¨';
```

### 1.3 è¡¨ç»“æ„ä¼˜åŒ–æ”¶ç›Š

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|--------|--------|--------|----------|
| **ç´¢å¼•è¦†ç›–ç‡** | 60% | 95% | +35% |
| **å­˜å‚¨ç©ºé—´** | 100% | 60% | -40% |
| **æŸ¥è¯¢æ€§èƒ½** | 100-500ms | 5-50ms | 10-100x |
| **å¹¶å‘æ”¯æŒ** | 100 TPS | 1000+ TPS | 10x+ |
| **æ•°æ®å®Œæ•´æ€§** | å¼± | å¼º | å¤–é”®çº¦æŸ |

---

## ğŸ” ç¬¬äºŒéƒ¨åˆ†ï¼šæŸ¥è¯¢ä¼˜åŒ–

### 2.1 æŸ¥è¯¢ç“¶é¢ˆé—®é¢˜åˆ†æ

#### è¯†åˆ«çš„å…³é”®é—®é¢˜
```java
// âŒ é—®é¢˜1: N+1æŸ¥è¯¢æ¨¡å¼
Map<Long, String> deptMap = sysOrgUnitsService.list().stream()  // åŠ è½½æ‰€æœ‰éƒ¨é—¨
Map<Long, String> userMap = sysUserService.list().stream()      // åŠ è½½æ‰€æœ‰ç”¨æˆ·

// âŒ é—®é¢˜2: é€’å½’æŸ¥è¯¢æ¯æ¬¡æ‰§è¡Œ
List<SysOrgUnits> descendants = sysOrgUnitsService.listAllDescendants(Collections.singletonList(deptId));

// âŒ é—®é¢˜3: å¤æ‚å­æŸ¥è¯¢
.exists("SELECT 1 FROM sys_user_role ur JOIN sys_role r ON ur.role_id = r.id...")

// âŒ é—®é¢˜4: ä¸ªåˆ«æŸ¥è¯¢è€Œéæ‰¹é‡
MessageResponseDetailVO.NonRespondedUserVO userInfo = sysUserService.getByDeviceSn(deviceSn);
```

### 2.2 ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥

#### 2.2.1 åˆ©ç”¨é—­åŒ…è¡¨çš„é«˜æ€§èƒ½æŸ¥è¯¢

```sql
-- ä¼˜åŒ–å‰: é€’å½’CTEæŸ¥è¯¢ (100-500ms)
WITH RECURSIVE dept_tree AS (
    SELECT * FROM sys_org_units WHERE id = ?
    UNION ALL
    SELECT o.* FROM sys_org_units o 
    INNER JOIN dept_tree dt ON o.parent_id = dt.id
)
SELECT * FROM dept_tree;

-- ä¼˜åŒ–å: é—­åŒ…è¡¨å•æ¬¡æŸ¥è¯¢ (<5ms) 
SELECT DISTINCT 
    m.id, m.message, m.message_type, m.create_time,
    o.org_name as department_name,
    u.user_name,
    m.responded_count, m.target_count
FROM t_device_message_v2 m
LEFT JOIN sys_org_units o ON m.department_id = o.id
LEFT JOIN sys_user u ON m.user_id = u.id
WHERE m.customer_id = ?
  AND m.department_id IN (
    SELECT DISTINCT ancestor_id 
    FROM sys_org_closure 
    WHERE descendant_id = ? AND customer_id = ?
  )
  AND m.is_deleted = 0
ORDER BY m.create_time DESC
LIMIT ?, ?;
```

#### 2.2.2 æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

```java
// âœ… ä¼˜åŒ–åçš„æ‰¹é‡æŸ¥è¯¢æœåŠ¡
@Service
public class OptimizedMessageQueryService {
    
    /**
     * æ‰¹é‡è·å–æ¶ˆæ¯åˆ—è¡¨ - æ¶ˆé™¤N+1æŸ¥è¯¢
     */
    public IPage<MessageResponseVO> getOptimizedMessagePage(MessageQueryParam param) {
        
        // 1. å•æ¬¡æŸ¥è¯¢è·å–åˆ†é¡µæ•°æ®
        IPage<MessageResponseVO> messagePage = messageMapper.selectOptimizedMessagePage(
            new Page<>(param.getPageNo(), param.getPageSize()), param
        );
        
        if (CollectionUtils.isEmpty(messagePage.getRecords())) {
            return messagePage;
        }
        
        // 2. æ”¶é›†éœ€è¦çš„IDé›†åˆ
        Set<Long> departmentIds = new HashSet<>();
        Set<Long> userIds = new HashSet<>();
        Set<Long> messageIds = new HashSet<>();
        
        messagePage.getRecords().forEach(record -> {
            if (record.getDepartmentId() != null) departmentIds.add(record.getDepartmentId());
            if (record.getUserId() != null) userIds.add(record.getUserId());
            messageIds.add(record.getMessageId());
        });
        
        // 3. æ‰¹é‡æŸ¥è¯¢å…³è”æ•°æ®
        Map<Long, String> departmentMap = batchGetDepartmentNames(departmentIds);
        Map<Long, String> userMap = batchGetUserNames(userIds);
        Map<Long, MessageStatsVO> statsMap = batchGetMessageStats(messageIds);
        
        // 4. ç»„è£…ç»“æœ
        messagePage.getRecords().forEach(record -> {
            record.setDepartmentName(departmentMap.get(record.getDepartmentId()));
            record.setUserName(userMap.get(record.getUserId()));
            record.setStats(statsMap.get(record.getMessageId()));
        });
        
        return messagePage;
    }
    
    /**
     * æ‰¹é‡è·å–æ¶ˆæ¯ç»Ÿè®¡ä¿¡æ¯
     */
    private Map<Long, MessageStatsVO> batchGetMessageStats(Set<Long> messageIds) {
        if (CollectionUtils.isEmpty(messageIds)) return Collections.emptyMap();
        
        List<MessageStatsVO> statsList = messageMapper.selectMessageStatsBatch(new ArrayList<>(messageIds));
        return statsList.stream().collect(Collectors.toMap(
            MessageStatsVO::getMessageId, 
            Function.identity()
        ));
    }
}
```

#### 2.2.3 MyBatis æ˜ å°„ä¼˜åŒ–

```xml
<!-- ä¼˜åŒ–åçš„ MessageMapper.xml -->
<mapper namespace="com.ljwx.modules.message.mapper.MessageMapper">
    
    <!-- ä¼˜åŒ–: å•æ¬¡æŸ¥è¯¢è·å–å®Œæ•´ä¿¡æ¯ -->
    <select id="selectOptimizedMessagePage" resultType="MessageResponseVO">
        SELECT 
            m.id as messageId,
            m.department_id as departmentId,
            m.user_id as userId,
            m.message,
            m.message_type as messageType,
            m.message_status as messageStatus,
            m.priority_level as priorityLevel,
            m.sent_time as sentTime,
            m.responded_count as respondedCount,
            m.target_count as targetCount,
            m.create_time as createTime,
            
            -- ç›´æ¥JOINè·å–åç§°ï¼Œé¿å…åç»­æŸ¥è¯¢
            COALESCE(o.org_name, 'æœªçŸ¥éƒ¨é—¨') as departmentName,
            COALESCE(u.user_name, 'ç³»ç»Ÿ') as userName
            
        FROM t_device_message_v2 m
        LEFT JOIN sys_org_units o ON m.department_id = o.id AND o.is_deleted = 0
        LEFT JOIN sys_user u ON m.user_id = u.id AND u.is_deleted = 0
        
        <where>
            m.customer_id = #{param.customerId}
            AND m.is_deleted = 0
            
            <if test="param.departmentId != null">
                AND m.department_id IN (
                    SELECT DISTINCT ancestor_id 
                    FROM sys_org_closure 
                    WHERE descendant_id = #{param.departmentId} 
                      AND customer_id = #{param.customerId}
                )
            </if>
            
            <if test="param.messageType != null and param.messageType != ''">
                AND m.message_type = #{param.messageType}
            </if>
            
            <if test="param.messageStatus != null and param.messageStatus != ''">
                AND m.message_status = #{param.messageStatus}
            </if>
            
            <if test="param.startTime != null">
                AND m.create_time >= #{param.startTime}
            </if>
            
            <if test="param.endTime != null">
                AND m.create_time <![CDATA[<=]]> #{param.endTime}
            </if>
        </where>
        
        ORDER BY m.priority_level DESC, m.create_time DESC
    </select>
    
    <!-- æ‰¹é‡è·å–æ¶ˆæ¯ç»Ÿè®¡ -->
    <select id="selectMessageStatsBatch" resultType="MessageStatsVO">
        SELECT 
            m.id as messageId,
            m.responded_count as respondedCount,
            m.target_count as targetCount,
            COALESCE(detail_stats.failed_count, 0) as failedCount,
            COALESCE(detail_stats.pending_count, 0) as pendingCount
        FROM t_device_message_v2 m
        LEFT JOIN (
            SELECT 
                message_id,
                COUNT(CASE WHEN delivery_status = 'failed' THEN 1 END) as failed_count,
                COUNT(CASE WHEN delivery_status = 'pending' THEN 1 END) as pending_count
            FROM t_device_message_detail_v2
            WHERE message_id IN 
            <foreach collection="messageIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
            AND is_deleted = 0
            GROUP BY message_id
        ) detail_stats ON m.id = detail_stats.message_id
        WHERE m.id IN
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper>
```

#### 2.2.4 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

```java
@Component
public class MessageCacheManager {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String CACHE_PREFIX = "message:";
    private static final String DEPT_CACHE_KEY = CACHE_PREFIX + "dept:";
    private static final String USER_CACHE_KEY = CACHE_PREFIX + "user:";
    private static final String ADMIN_CACHE_KEY = CACHE_PREFIX + "admin:";
    
    /**
     * å¤šçº§ç¼“å­˜: L1æœ¬åœ°ç¼“å­˜ + L2Redisç¼“å­˜
     */
    @Cacheable(value = "departmentNames", key = "#customerId + ':' + #departmentIds.hashCode()")
    public Map<Long, String> batchGetDepartmentNames(Long customerId, Set<Long> departmentIds) {
        
        // L1: æ£€æŸ¥æœ¬åœ°ç¼“å­˜
        String localCacheKey = "dept:" + customerId + ":" + departmentIds.hashCode();
        Map<Long, String> cached = localCache.get(localCacheKey);
        if (cached != null) {
            return cached;
        }
        
        // L2: æ£€æŸ¥Redisç¼“å­˜
        Map<Long, String> result = new HashMap<>();
        List<String> cachedValues = redisTemplate.opsForValue().multiGet(
            departmentIds.stream()
                .map(id -> DEPT_CACHE_KEY + customerId + ":" + id)
                .collect(Collectors.toList())
        );
        
        Set<Long> missingIds = new HashSet<>();
        int index = 0;
        for (Long deptId : departmentIds) {
            String cachedName = cachedValues.get(index++);
            if (cachedName != null) {
                result.put(deptId, cachedName);
            } else {
                missingIds.add(deptId);
            }
        }
        
        // L3: æ•°æ®åº“æŸ¥è¯¢ç¼ºå¤±çš„æ•°æ®
        if (!missingIds.isEmpty()) {
            List<SysOrgUnits> departments = orgService.listByIds(missingIds);
            departments.forEach(dept -> {
                result.put(dept.getId(), dept.getOrgName());
                // å›å†™Redisç¼“å­˜
                redisTemplate.opsForValue().set(
                    DEPT_CACHE_KEY + customerId + ":" + dept.getId(),
                    dept.getOrgName(),
                    Duration.ofHours(2)
                );
            });
        }
        
        // å›å†™æœ¬åœ°ç¼“å­˜
        localCache.put(localCacheKey, result, Duration.ofMinutes(10));
        
        return result;
    }
    
    /**
     * ç®¡ç†å‘˜ç”¨æˆ·ç¼“å­˜ - è§£å†³é¢‘ç¹æŸ¥è¯¢é—®é¢˜
     */
    @Cacheable(value = "adminUsers", key = "#customerId")
    public Set<Long> getAdminUserIds(Long customerId) {
        String cacheKey = ADMIN_CACHE_KEY + customerId;
        
        Set<Long> adminIds = (Set<Long>) redisTemplate.opsForValue().get(cacheKey);
        if (adminIds != null) {
            return adminIds;
        }
        
        // ä¼˜åŒ–: ä½¿ç”¨JOINæŸ¥è¯¢è€ŒéEXISTS
        adminIds = userMapper.selectAdminUserIds(customerId);
        
        // ç¼“å­˜30åˆ†é’Ÿ
        redisTemplate.opsForValue().set(cacheKey, adminIds, Duration.ofMinutes(30));
        
        return adminIds;
    }
}
```

### 2.3 æŸ¥è¯¢ä¼˜åŒ–æ”¶ç›Šé¢„ä¼°

| æŸ¥è¯¢åœºæ™¯ | ä¼˜åŒ–å‰æ€§èƒ½ | ä¼˜åŒ–åæ€§èƒ½ | æå‡å¹…åº¦ | å®ç°æ–¹å¼ |
|----------|------------|------------|----------|----------|
| **æ¶ˆæ¯åˆ—è¡¨æŸ¥è¯¢** | 200-1000ms | 20-50ms | 10-20x | æ‰¹é‡æŸ¥è¯¢ + JOINä¼˜åŒ– |
| **éƒ¨é—¨å±‚çº§æŸ¥è¯¢** | 100-500ms | <5ms | 20-100x | é—­åŒ…è¡¨æŸ¥è¯¢ |
| **ç®¡ç†å‘˜æ£€æŸ¥** | 50-200ms/ç”¨æˆ· | <1ms/ç”¨æˆ· | 50-200x | æ‰¹é‡ç¼“å­˜ |
| **å“åº”ç»Ÿè®¡æŸ¥è¯¢** | 100-300ms | 10-30ms | 10x | èšåˆæŸ¥è¯¢ä¼˜åŒ– |
| **è®¾å¤‡ç”¨æˆ·æŸ¥è¯¢** | 10-50ms/è®¾å¤‡ | <2ms/è®¾å¤‡ | 5-25x | æ‰¹é‡æ“ä½œ |

---

## ğŸ’¾ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå­˜å‚¨ä¼˜åŒ–

### 3.1 æ•°æ®åˆ†åŒºç­–ç•¥

#### 3.1.1 æ—¶é—´èŒƒå›´åˆ†åŒº
```sql
-- æŒ‰æœˆåˆ†åŒºç­–ç•¥ (å·²åœ¨è¡¨ç»“æ„ä¸­ä½“ç°)
-- å¥½å¤„: 
-- 1. æŸ¥è¯¢æ€§èƒ½: åªæ‰«æç›¸å…³åˆ†åŒº
-- 2. ç»´æŠ¤ç®€å•: å¯ä»¥ç›´æ¥DROPè¿‡æœŸåˆ†åŒº
-- 3. å¹¶å‘æå‡: ä¸åŒåˆ†åŒºå¯ä»¥å¹¶è¡Œæ“ä½œ

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE CreateNextMonthPartition()
BEGIN
    DECLARE next_month_name VARCHAR(10);
    DECLARE next_month_date DATE;
    
    SET next_month_date = DATE_ADD(CURDATE(), INTERVAL 2 MONTH);
    SET next_month_name = CONCAT('p', DATE_FORMAT(next_month_date, '%Y%m'));
    
    SET @sql = CONCAT(
        'ALTER TABLE t_device_message_v2 ADD PARTITION (',
        'PARTITION ', next_month_name, 
        ' VALUES LESS THAN (TO_DAYS(''', next_month_date, '''))',
        ')'
    );
    
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$

-- è‡ªåŠ¨æ¸…ç†è¿‡æœŸåˆ†åŒº (ä¿ç•™6ä¸ªæœˆæ•°æ®)
CREATE PROCEDURE CleanupOldPartitions()
BEGIN
    DECLARE old_partition_date DATE;
    DECLARE old_partition_name VARCHAR(10);
    
    SET old_partition_date = DATE_SUB(CURDATE(), INTERVAL 6 MONTH);
    SET old_partition_name = CONCAT('p', DATE_FORMAT(old_partition_date, '%Y%m'));
    
    SET @sql = CONCAT('ALTER TABLE t_device_message_v2 DROP PARTITION ', old_partition_name);
    
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;

-- å®šæ—¶ä»»åŠ¡ï¼šæ¯æœˆ1æ—¥è‡ªåŠ¨æ‰§è¡Œ
CREATE EVENT IF NOT EXISTS monthly_partition_maintenance
ON SCHEDULE EVERY 1 MONTH
STARTS '2025-02-01 02:00:00'
DO
BEGIN
    CALL CreateNextMonthPartition();
    CALL CleanupOldPartitions();
END;
```

#### 3.1.2 æ•°æ®å½’æ¡£ç­–ç•¥

```sql
-- å†å²æ•°æ®å½’æ¡£è¡¨
CREATE TABLE `t_device_message_archive` (
  -- ä¸ä¸»è¡¨ç»“æ„ç›¸åŒï¼Œä½†ä¼˜åŒ–å­˜å‚¨
  `id` bigint NOT NULL,
  `customer_id` bigint NOT NULL,
  `message` mediumtext NOT NULL,  -- å‹ç¼©å­˜å‚¨
  `archive_time` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  `original_create_time` datetime(3) NOT NULL,
  
  PRIMARY KEY (`id`),
  KEY `idx_customer_archive_time` (`customer_id`, `archive_time`),
  KEY `idx_original_time` (`original_create_time`)
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci
  ROW_FORMAT=COMPRESSED  -- å¯ç”¨è¡Œå‹ç¼©
  KEY_BLOCK_SIZE=8       -- 8Kå‹ç¼©å—
  COMMENT='æ¶ˆæ¯å½’æ¡£è¡¨-å‹ç¼©å­˜å‚¨';

-- å½’æ¡£å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE ArchiveOldMessages()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE archive_date DATE;
    
    -- å½’æ¡£3ä¸ªæœˆå‰çš„æ•°æ®
    SET archive_date = DATE_SUB(CURDATE(), INTERVAL 3 MONTH);
    
    -- å¼€å§‹äº‹åŠ¡
    START TRANSACTION;
    
    -- 1. æ’å…¥å½’æ¡£è¡¨
    INSERT INTO t_device_message_archive (
        id, customer_id, message, original_create_time
    )
    SELECT id, customer_id, message, create_time
    FROM t_device_message_v2
    WHERE create_time < archive_date
      AND is_deleted = 0;
    
    -- 2. æ ‡è®°åŸè¡¨ä¸ºå·²å½’æ¡£
    UPDATE t_device_message_v2 
    SET is_deleted = 2  -- 2è¡¨ç¤ºå·²å½’æ¡£
    WHERE create_time < archive_date
      AND is_deleted = 0;
    
    COMMIT;
END$$
DELIMITER ;
```

### 3.2 å­˜å‚¨ç©ºé—´ä¼˜åŒ–

#### 3.2.1 æ•°æ®ç±»å‹ä¼˜åŒ–æ”¶ç›Š

| å­—æ®µç±»å‹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | ç©ºé—´èŠ‚çœ | è¯´æ˜ |
|----------|--------|--------|----------|------|
| **department_info** | VARCHAR(200) | BIGINT | 180å­—èŠ‚ | ä½¿ç”¨éƒ¨é—¨IDæ›¿ä»£åç§° |
| **message_type** | VARCHAR(50) | ENUM(6) | 47å­—èŠ‚ | æšä¸¾ç±»å‹ä¼˜åŒ– |
| **message_status** | VARCHAR(50) | ENUM(6) | 47å­—èŠ‚ | çŠ¶æ€æšä¸¾åŒ– |
| **sender_type** | VARCHAR(50) | ENUM(4) | 47å­—èŠ‚ | å‘é€è€…ç±»å‹æšä¸¾ |
| **receiver_type** | VARCHAR(50) | ENUM(4) | 47å­—èŠ‚ | æ¥æ”¶è€…ç±»å‹æšä¸¾ |
| **è®¾å¤‡åºåˆ—å·** | VARCHAR(255) | VARCHAR(64) | 191å­—èŠ‚ | åˆç†é•¿åº¦é™åˆ¶ |

**æ€»ä½“ç©ºé—´èŠ‚çœ**: æ¯æ¡è®°å½•èŠ‚çœçº¦ **559å­—èŠ‚** (çº¦40%å­˜å‚¨ç©ºé—´)

#### 3.2.2 ç´¢å¼•å­˜å‚¨ä¼˜åŒ–

```sql
-- åˆ›å»ºå‹ç¼©ç´¢å¼•
CREATE INDEX idx_customer_time_compressed ON t_device_message_v2 
    (customer_id, create_time DESC) 
    USING BTREE
    COMMENT 'å®¢æˆ·æ—¶é—´ç´¢å¼•-å‹ç¼©ä¼˜åŒ–';

-- å‰ç¼€ç´¢å¼•ä¼˜åŒ–TEXTå­—æ®µ
CREATE INDEX idx_message_prefix ON t_device_message_v2 
    (message(100))  -- åªç´¢å¼•å‰100å­—ç¬¦
    COMMENT 'æ¶ˆæ¯å†…å®¹å‰ç¼€ç´¢å¼•';

-- å‡½æ•°ç´¢å¼•(MySQL 8.0+)
CREATE INDEX idx_create_date_func ON t_device_message_v2 
    ((DATE(create_time)), customer_id)
    COMMENT 'æ—¥æœŸå‡½æ•°ç´¢å¼•';
```

#### 3.2.3 å­˜å‚¨å¼•æ“ä¼˜åŒ–é…ç½®

```sql
-- InnoDBå‚æ•°ä¼˜åŒ–
SET GLOBAL innodb_buffer_pool_size = 1073741824;        -- 1GBç¼“å†²æ± 
SET GLOBAL innodb_log_file_size = 268435456;            -- 256MBæ—¥å¿—æ–‡ä»¶
SET GLOBAL innodb_flush_log_at_trx_commit = 2;          -- æ€§èƒ½ä¼˜åŒ–
SET GLOBAL innodb_file_per_table = 1;                   -- ç‹¬ç«‹è¡¨ç©ºé—´
SET GLOBAL innodb_compression_level = 6;                -- å‹ç¼©çº§åˆ«

-- è¡¨å‹ç¼©é…ç½®
ALTER TABLE t_device_message_v2 
    ROW_FORMAT=COMPRESSED 
    KEY_BLOCK_SIZE=8;

ALTER TABLE t_device_message_detail_v2 
    ROW_FORMAT=COMPRESSED 
    KEY_BLOCK_SIZE=8;
```

### 3.3 å­˜å‚¨ç›‘æ§å’Œé¢„è­¦

```sql
-- å­˜å‚¨ç©ºé—´ç›‘æ§è§†å›¾
CREATE VIEW v_message_storage_stats AS
SELECT 
    table_name,
    table_rows,
    ROUND((data_length + index_length) / 1024 / 1024, 2) as table_size_mb,
    ROUND(data_length / 1024 / 1024, 2) as data_size_mb,
    ROUND(index_length / 1024 / 1024, 2) as index_size_mb,
    ROUND(data_free / 1024 / 1024, 2) as free_space_mb,
    create_time,
    update_time
FROM information_schema.tables
WHERE table_schema = 'ljwx'
  AND table_name LIKE 't_device_message%'
ORDER BY table_size_mb DESC;

-- è‡ªåŠ¨é¢„è­¦è§¦å‘å™¨
DELIMITER $$
CREATE TRIGGER message_growth_monitor
    AFTER INSERT ON t_device_message_v2
    FOR EACH ROW
BEGIN
    DECLARE current_count BIGINT;
    DECLARE threshold_count BIGINT DEFAULT 1000000; -- 100ä¸‡æ¡é¢„è­¦
    
    SELECT COUNT(*) INTO current_count 
    FROM t_device_message_v2 
    WHERE customer_id = NEW.customer_id;
    
    IF current_count >= threshold_count THEN
        INSERT INTO sys_warning_log (
            warning_type, 
            warning_message, 
            customer_id, 
            create_time
        ) VALUES (
            'STORAGE_WARNING',
            CONCAT('å®¢æˆ· ', NEW.customer_id, ' æ¶ˆæ¯æ•°æ®é‡è¾¾åˆ° ', current_count, ' æ¡ï¼Œå»ºè®®æ‰§è¡Œå½’æ¡£'),
            NEW.customer_id,
            NOW()
        );
    END IF;
END$$
DELIMITER ;
```

---

## ğŸ“ˆ ç¬¬å››éƒ¨åˆ†ï¼šè·Ÿè¸ªä¼˜åŒ–

### 4.1 æ€§èƒ½ç›‘æ§ä½“ç³»

#### 4.1.1 æ•°æ®åº“æ€§èƒ½ç›‘æ§

```sql
-- åˆ›å»ºæ€§èƒ½ç›‘æ§è¡¨
CREATE TABLE `t_query_performance_log` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `query_type` varchar(50) NOT NULL COMMENT 'æŸ¥è¯¢ç±»å‹',
  `query_hash` varchar(64) NOT NULL COMMENT 'æŸ¥è¯¢å“ˆå¸Œ',
  `execution_time_ms` bigint NOT NULL COMMENT 'æ‰§è¡Œæ—¶é—´(æ¯«ç§’)',
  `rows_examined` bigint NULL COMMENT 'æ‰«æè¡Œæ•°',
  `rows_sent` bigint NULL COMMENT 'è¿”å›è¡Œæ•°',
  `customer_id` bigint NULL COMMENT 'ç§Ÿæˆ·ID',
  `user_id` bigint NULL COMMENT 'ç”¨æˆ·ID',
  `query_params` json NULL COMMENT 'æŸ¥è¯¢å‚æ•°',
  `execution_plan` json NULL COMMENT 'æ‰§è¡Œè®¡åˆ’',
  `create_time` datetime(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  
  PRIMARY KEY (`id`),
  KEY `idx_query_type_time` (`query_type`, `create_time`),
  KEY `idx_execution_time` (`execution_time_ms` DESC),
  KEY `idx_customer_time` (`customer_id`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æŸ¥è¯¢æ€§èƒ½ç›‘æ§æ—¥å¿—';

-- æ…¢æŸ¥è¯¢è‡ªåŠ¨è®°å½•
DELIMITER $$
CREATE PROCEDURE LogSlowQuery(
    IN p_query_type VARCHAR(50),
    IN p_execution_time BIGINT,
    IN p_rows_examined BIGINT,
    IN p_rows_sent BIGINT,
    IN p_customer_id BIGINT,
    IN p_query_params JSON
)
BEGIN
    IF p_execution_time > 1000 THEN  -- è¶…è¿‡1ç§’è®°å½•
        INSERT INTO t_query_performance_log (
            query_type, execution_time_ms, rows_examined, 
            rows_sent, customer_id, query_params
        ) VALUES (
            p_query_type, p_execution_time, p_rows_examined,
            p_rows_sent, p_customer_id, p_query_params
        );
    END IF;
END$$
DELIMITER ;
```

#### 4.1.2 åº”ç”¨å±‚æ€§èƒ½è¿½è¸ª

```java
@Component
@Aspect
@Slf4j
public class MessageQueryPerformanceAspect {
    
    @Autowired
    private PerformanceLogService performanceLogService;
    
    @Around("execution(* com.ljwx.modules.message.service.*.*(..))")
    public Object trackPerformance(ProceedingJoinPoint joinPoint) throws Throwable {
        
        long startTime = System.currentTimeMillis();
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();
        
        try {
            Object result = joinPoint.proceed();
            
            long executionTime = System.currentTimeMillis() - startTime;
            
            // è®°å½•æ€§èƒ½æ•°æ®
            PerformanceMetrics metrics = PerformanceMetrics.builder()
                .serviceClass(joinPoint.getTarget().getClass().getSimpleName())
                .methodName(methodName)
                .executionTime(executionTime)
                .parameterCount(args.length)
                .resultType(result != null ? result.getClass().getSimpleName() : "void")
                .timestamp(LocalDateTime.now())
                .build();
            
            // å¼‚æ­¥è®°å½•ï¼Œé¿å…å½±å“ä¸šåŠ¡æ€§èƒ½
            CompletableFuture.runAsync(() -> 
                performanceLogService.logPerformance(metrics)
            );
            
            // æ€§èƒ½é¢„è­¦
            if (executionTime > 5000) { // è¶…è¿‡5ç§’
                log.warn("æ…¢æ–¹æ³•æ£€æµ‹: {}.{} æ‰§è¡Œæ—¶é—´: {}ms", 
                    joinPoint.getTarget().getClass().getSimpleName(),
                    methodName, executionTime);
                
                alertService.sendSlowQueryAlert(methodName, executionTime);
            }
            
            return result;
            
        } catch (Exception e) {
            // è®°å½•å¼‚å¸¸
            performanceLogService.logException(methodName, e);
            throw e;
        }
    }
}
```

### 4.2 ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§

#### 4.2.1 æ¶ˆæ¯å¤„ç†æŒ‡æ ‡

```java
@Component
public class MessageMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    private final Timer messageProcessingTimer;
    private final Counter messageSuccessCounter;
    private final Counter messageFailureCounter;
    private final Gauge pendingMessagesGauge;
    
    public MessageMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        this.messageProcessingTimer = Timer.builder("message.processing.time")
            .description("æ¶ˆæ¯å¤„ç†æ—¶é—´")
            .register(meterRegistry);
            
        this.messageSuccessCounter = Counter.builder("message.processing.success")
            .description("æ¶ˆæ¯å¤„ç†æˆåŠŸæ•°")
            .register(meterRegistry);
            
        this.messageFailureCounter = Counter.builder("message.processing.failure")
            .description("æ¶ˆæ¯å¤„ç†å¤±è´¥æ•°")
            .register(meterRegistry);
            
        this.pendingMessagesGauge = Gauge.builder("message.pending.count")
            .description("å¾…å¤„ç†æ¶ˆæ¯æ•°é‡")
            .register(meterRegistry, this, MessageMetricsCollector::getPendingMessageCount);
    }
    
    public void recordMessageProcessing(String messageType, long processingTimeMs, boolean success) {
        
        messageProcessingTimer
            .tag("type", messageType)
            .tag("success", String.valueOf(success))
            .record(processingTimeMs, TimeUnit.MILLISECONDS);
        
        if (success) {
            messageSuccessCounter.tag("type", messageType).increment();
        } else {
            messageFailureCounter.tag("type", messageType).increment();
        }
    }
    
    private double getPendingMessageCount() {
        // å®æ—¶æŸ¥è¯¢å¾…å¤„ç†æ¶ˆæ¯æ•°é‡
        return messageService.countByStatus("pending");
    }
}
```

#### 4.2.2 æ•°æ®åº“è¿æ¥æ± ç›‘æ§

```java
@Configuration
public class DataSourceMonitoringConfig {
    
    @Bean
    @Primary
    public DataSource monitoredDataSource(@Value("${spring.datasource.url}") String url) {
        
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(url);
        dataSource.setMaximumPoolSize(20);
        dataSource.setMinimumIdle(5);
        dataSource.setConnectionTimeout(30000);
        dataSource.setIdleTimeout(600000);
        dataSource.setMaxLifetime(1800000);
        
        // å¯ç”¨æŒ‡æ ‡ç›‘æ§
        dataSource.setMetricRegistry(new MetricRegistry());
        dataSource.setHealthCheckRegistry(new HealthCheckRegistry());
        
        // è‡ªå®šä¹‰è¿æ¥æ± ç›‘æ§
        return new MonitoredDataSource(dataSource);
    }
}

public class MonitoredDataSource implements DataSource {
    
    private final HikariDataSource delegate;
    private final MeterRegistry meterRegistry;
    
    @Override
    public Connection getConnection() throws SQLException {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            Connection connection = delegate.getConnection();
            
            sample.stop(Timer.builder("datasource.connection.acquire")
                .description("æ•°æ®åº“è¿æ¥è·å–æ—¶é—´")
                .register(meterRegistry));
            
            return new MonitoredConnection(connection, meterRegistry);
            
        } catch (SQLException e) {
            meterRegistry.counter("datasource.connection.error",
                "error", e.getSQLState())
                .increment();
            throw e;
        }
    }
}
```

### 4.3 å®æ—¶å‘Šè­¦ç³»ç»Ÿ

#### 4.3.1 æ€§èƒ½é˜ˆå€¼å‘Šè­¦

```java
@Component
public class PerformanceAlertManager {
    
    private static final long SLOW_QUERY_THRESHOLD = 5000; // 5ç§’
    private static final double ERROR_RATE_THRESHOLD = 0.05; // 5%é”™è¯¯ç‡
    private static final int PENDING_MESSAGE_THRESHOLD = 1000; // 1000æ¡å¾…å¤„ç†
    
    @EventListener
    public void handleSlowQueryEvent(SlowQueryEvent event) {
        if (event.getExecutionTime() > SLOW_QUERY_THRESHOLD) {
            
            AlertMessage alert = AlertMessage.builder()
                .alertType("SLOW_QUERY")
                .severity("HIGH")
                .title("æ£€æµ‹åˆ°æ…¢æŸ¥è¯¢")
                .content(String.format("æŸ¥è¯¢ %s æ‰§è¡Œæ—¶é—´ %dms è¶…è¿‡é˜ˆå€¼ %dms",
                    event.getQueryType(), 
                    event.getExecutionTime(),
                    SLOW_QUERY_THRESHOLD))
                .metadata(Map.of(
                    "queryType", event.getQueryType(),
                    "executionTime", event.getExecutionTime(),
                    "customerId", event.getCustomerId()
                ))
                .build();
                
            alertService.sendAlert(alert);
        }
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkSystemHealth() {
        
        // 1. æ£€æŸ¥é”™è¯¯ç‡
        double errorRate = calculateErrorRate();
        if (errorRate > ERROR_RATE_THRESHOLD) {
            alertService.sendAlert(AlertMessage.builder()
                .alertType("HIGH_ERROR_RATE")
                .severity("CRITICAL")
                .title("ç³»ç»Ÿé”™è¯¯ç‡è¿‡é«˜")
                .content(String.format("å½“å‰é”™è¯¯ç‡ %.2f%% è¶…è¿‡é˜ˆå€¼ %.2f%%", 
                    errorRate * 100, ERROR_RATE_THRESHOLD * 100))
                .build());
        }
        
        // 2. æ£€æŸ¥å¾…å¤„ç†æ¶ˆæ¯å †ç§¯
        int pendingCount = messageService.countByStatus("pending");
        if (pendingCount > PENDING_MESSAGE_THRESHOLD) {
            alertService.sendAlert(AlertMessage.builder()
                .alertType("MESSAGE_BACKLOG")
                .severity("WARNING")
                .title("æ¶ˆæ¯å¤„ç†å †ç§¯")
                .content(String.format("å¾…å¤„ç†æ¶ˆæ¯ %d æ¡è¶…è¿‡é˜ˆå€¼ %d æ¡", 
                    pendingCount, PENDING_MESSAGE_THRESHOLD))
                .build());
        }
        
        // 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± 
        HikariPoolMXBean poolBean = hikariDataSource.getHikariPoolMXBean();
        if (poolBean.getActiveConnections() > poolBean.getMaximumPoolSize() * 0.8) {
            alertService.sendAlert(AlertMessage.builder()
                .alertType("CONNECTION_POOL_WARNING")
                .severity("WARNING") 
                .title("æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜")
                .content(String.format("æ´»è·ƒè¿æ¥æ•° %d/%d (%.1f%%)",
                    poolBean.getActiveConnections(),
                    poolBean.getMaximumPoolSize(),
                    (double)poolBean.getActiveConnections() / poolBean.getMaximumPoolSize() * 100))
                .build());
        }
    }
}
```

### 4.4 è·Ÿè¸ªä¼˜åŒ–æ”¶ç›Š

| ç›‘æ§ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ä»·å€¼ |
|----------|--------|--------|----------|
| **é—®é¢˜å‘ç°æ—¶é—´** | ç”¨æˆ·æŠ•è¯‰å | å®æ—¶ç›‘æ§ | ä¸»åŠ¨å‘ç° |
| **æ€§èƒ½å¯è§æ€§** | é»‘ç›’ç›‘æ§ | å…¨é“¾è·¯è¿½è¸ª | å®Œæ•´è§†å›¾ |
| **æ•…éšœå®šä½æ—¶é—´** | 30-120åˆ†é’Ÿ | 5-15åˆ†é’Ÿ | 75% |
| **ç³»ç»Ÿå¯ç”¨æ€§** | 95% | 99.5% | 4.5% |
| **è¿ç»´æ•ˆç‡** | äººå·¥åˆ†æ | è‡ªåŠ¨åŒ–å‘Šè­¦ | 80%è‡ªåŠ¨åŒ– |

---

## ğŸ¯ ç¬¬äº”éƒ¨åˆ†ï¼šç»¼åˆå®æ–½æ–¹æ¡ˆ

### 5.1 åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

#### é˜¶æ®µä¸€ï¼šç´§æ€¥ä¼˜åŒ– (P0 - 2å‘¨å†…å®Œæˆ)

```sql
-- Week 1: å…³é”®ç´¢å¼•åˆ›å»º
CREATE INDEX idx_customer_time ON t_device_message(customer_id, create_time DESC, is_deleted);
CREATE INDEX idx_customer_dept_status ON t_device_message(customer_id, department_info, message_status, is_deleted);
CREATE INDEX idx_detail_message_device ON t_device_message_detail(message_id, device_sn);

-- Week 2: æŸ¥è¯¢ä¼˜åŒ–
-- 1. ä¿®å¤æ•°æ®ç±»å‹ä¸åŒ¹é…
ALTER TABLE t_device_message_detail MODIFY message_id BIGINT NOT NULL;
-- 2. æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE t_device_message_detail ADD CONSTRAINT fk_message_detail 
  FOREIGN KEY (message_id) REFERENCES t_device_message(id);
```

#### é˜¶æ®µäºŒï¼šç»“æ„ä¼˜åŒ– (P1 - 4å‘¨å†…å®Œæˆ)

```sql
-- Week 3-4: åˆ›å»ºä¼˜åŒ–åçš„æ–°è¡¨
CREATE TABLE t_device_message_v2 (...);  -- ä½¿ç”¨å‰é¢è®¾è®¡çš„ä¼˜åŒ–è¡¨ç»“æ„
CREATE TABLE t_device_message_detail_v2 (...);

-- Week 5-6: æ•°æ®è¿ç§»
INSERT INTO t_device_message_v2 SELECT ... FROM t_device_message;
INSERT INTO t_device_message_detail_v2 SELECT ... FROM t_device_message_detail;
```

#### é˜¶æ®µä¸‰ï¼šé«˜çº§ä¼˜åŒ– (P2 - 6å‘¨å†…å®Œæˆ)

- åˆ†åŒºè¡¨å®æ–½
- å½’æ¡£ç­–ç•¥éƒ¨ç½²  
- ç›‘æ§ç³»ç»Ÿä¸Šçº¿
- ç¼“å­˜ç­–ç•¥å®æ–½

### 5.2 é¢„æœŸä¼˜åŒ–æ•ˆæœ

#### 5.2.1 æ€§èƒ½æå‡ç›®æ ‡

| æ€§èƒ½æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | å®ç°æ–¹å¼ |
|----------|--------|--------|----------|
| **æ¶ˆæ¯åˆ—è¡¨æŸ¥è¯¢** | 200-1000ms | 20-50ms | ç´¢å¼•ä¼˜åŒ– + æ‰¹é‡æŸ¥è¯¢ |
| **éƒ¨é—¨å±‚çº§æŸ¥è¯¢** | 100-500ms | <5ms | é—­åŒ…è¡¨ + ç¼“å­˜ |
| **æ¶ˆæ¯åˆ›å»ºTPS** | ~100 TPS | 1000+ TPS | ç»“æ„ä¼˜åŒ– + åˆ†åŒº |
| **å­˜å‚¨ç©ºé—´** | 100% | 60% | æ•°æ®ç±»å‹ + å‹ç¼© |
| **å¹¶å‘ç”¨æˆ·æ•°** | 100 | 1000+ | è¿æ¥æ±  + ç¼“å­˜ |

#### 5.2.2 ç³»ç»Ÿç¨³å®šæ€§ç›®æ ‡

- **å¯ç”¨æ€§**: ä» 99% æå‡åˆ° 99.9%
- **MTTR**: ä» 30åˆ†é’Ÿ é™ä½åˆ° 5åˆ†é’Ÿ  
- **ç›‘æ§è¦†ç›–**: ä» 30% æå‡åˆ° 95%
- **è‡ªåŠ¨åŒ–ç¨‹åº¦**: ä» 20% æå‡åˆ° 80%

### 5.3 é£é™©æ§åˆ¶æªæ–½

#### æ•°æ®å®‰å…¨ä¿éšœ
```bash
# å®æ–½å‰å®Œæ•´å¤‡ä»½
mysqldump --single-transaction --routines --triggers ljwx > backup_$(date +%Y%m%d).sql

# è¿ç§»è¿‡ç¨‹ä¸­çš„æ•°æ®æ ¡éªŒ
SELECT COUNT(*), SUM(CRC32(CONCAT_WS(',', id, message, create_time))) FROM t_device_message;
SELECT COUNT(*), SUM(CRC32(CONCAT_WS(',', id, message, create_time))) FROM t_device_message_v2;
```

#### å›æ»šæ–¹æ¡ˆ
```sql
-- å¦‚æœä¼˜åŒ–åæ€§èƒ½ä¸è¾¾é¢„æœŸï¼Œå¯ä»¥å¿«é€Ÿå›æ»š
-- 1. é‡å‘½åè¡¨åˆ‡æ¢
RENAME TABLE t_device_message TO t_device_message_backup,
             t_device_message_v2 TO t_device_message;

-- 2. é‡å»ºå¿…è¦çš„ç´¢å¼•å’Œè§¦å‘å™¨
-- 3. åº”ç”¨ç¨‹åºæ— éœ€ä¿®æ”¹å³å¯æ¢å¤
```

#### æ€§èƒ½ç›‘æ§
- å®æ—¶ç›‘æ§å…³é”®æŸ¥è¯¢æ€§èƒ½
- è®¾ç½®æ€§èƒ½å›é€€é˜ˆå€¼
- è‡ªåŠ¨å‘Šè­¦å’Œå›æ»šæœºåˆ¶

---

## ğŸ“Š æ€»ç»“ä¸å»ºè®®

### ä¼˜åŒ–æˆæœé¢„æœŸ

é€šè¿‡æœ¬æ–¹æ¡ˆçš„å…¨é¢å®æ–½ï¼Œé¢„æœŸå°†å®ç°ï¼š

1. **æŸ¥è¯¢æ€§èƒ½æå‡ 10-100å€**: é€šè¿‡é—­åŒ…è¡¨ã€ç´¢å¼•ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥
2. **å­˜å‚¨ç©ºé—´èŠ‚çœ 40%**: é€šè¿‡æ•°æ®ç±»å‹ä¼˜åŒ–å’Œå‹ç¼©æŠ€æœ¯  
3. **ç³»ç»Ÿå¯æ‰©å±•æ€§æå‡**: æ”¯æŒ 100å€æ•°æ®å¢é•¿
4. **è¿ç»´æ•ˆç‡æå‡ 80%**: é€šè¿‡è‡ªåŠ¨åŒ–ç›‘æ§å’Œå‘Šè­¦
5. **å¼€å‘æ•ˆç‡æå‡**: é€šè¿‡ä¼˜åŒ–çš„æŸ¥è¯¢æ¨¡å¼å’ŒORMæ˜ å°„

### é•¿æœŸæŠ€æœ¯æ¼”è¿›å»ºè®®

1. **å¼•å…¥è¯»å†™åˆ†ç¦»**: ä¸»åº“å†™å…¥ï¼Œä»åº“æŸ¥è¯¢
2. **å®æ–½åˆ†å¸ƒå¼ç¼“å­˜**: Redisé›†ç¾¤æ›¿ä»£å•æœºç¼“å­˜
3. **è€ƒè™‘åˆ†åº“åˆ†è¡¨**: æŒ‰ç§Ÿæˆ·IDæ°´å¹³æ‹†åˆ†
4. **å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—**: å¼‚æ­¥å¤„ç†æå‡å“åº”é€Ÿåº¦
5. **AIé©±åŠ¨ä¼˜åŒ–**: åŸºäºæœºå™¨å­¦ä¹ çš„æŸ¥è¯¢ä¼˜åŒ–

é€šè¿‡ç³»ç»Ÿæ€§çš„æ•°æ®åº“ä¼˜åŒ–ï¼Œå°†æ˜¾è‘—æå‡çµå¢ƒä¸‡è±¡å¥åº·ç®¡ç†ç³»ç»Ÿçš„æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä¸ºä¸šåŠ¡çš„å¿«é€Ÿå‘å±•æä¾›åšå®çš„æŠ€æœ¯ä¿éšœã€‚