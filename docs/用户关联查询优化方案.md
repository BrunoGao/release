# çµå¢ƒä¸‡è±¡å¥åº·ç®¡ç†ç³»ç»Ÿ - ç”¨æˆ·å…³è”æŸ¥è¯¢æ•ˆç‡ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€ä¼˜åŒ–èƒŒæ™¯

### 1.1 ç°çŠ¶åˆ†æ
- **æ ¸å¿ƒå¤§è¡¨**: `t_user_health_data` é¢„æœŸç™¾ä¸‡çº§è®°å½•ï¼Œæ˜¯ç³»ç»ŸæŸ¥è¯¢æ€§èƒ½çš„å…³é”®ç“¶é¢ˆ
- **å¤æ‚å…³è”**: ç”¨æˆ·æ•°æ®æ¶‰åŠ 7+ å¼ è¡¨çš„å¤šå±‚çº§å…³è”æŸ¥è¯¢
- **å·²æœ‰ä¼˜åŒ–**: ç»„ç»‡æ¶æ„é—­åŒ…è¡¨ä¼˜åŒ–å·²å®Œæˆï¼ŒæŸ¥è¯¢æ€§èƒ½æå‡100å€

### 1.2 å…³è”å…³ç³»å›¾
```
sys_user (ç”¨æˆ·åŸºè¡¨)
â”œâ”€â”€ sys_user_org (ç”¨æˆ·ç»„ç»‡å…³ç³») â†’ sys_org_closure (é—­åŒ…è¡¨) âœ… å·²ä¼˜åŒ–
â”œâ”€â”€ sys_user_position (ç”¨æˆ·å²—ä½å…³ç³»)
â”œâ”€â”€ t_device_user (è®¾å¤‡ç”¨æˆ·ç»‘å®š) â†’ t_device_info (è®¾å¤‡ä¿¡æ¯)
â”œâ”€â”€ t_user_health_data (å¥åº·æ•°æ®) â­ æ ¸å¿ƒå¤§è¡¨
â”œâ”€â”€ t_device_message (è®¾å¤‡æ¶ˆæ¯)
â”œâ”€â”€ t_alert_info (å‘Šè­¦ä¿¡æ¯)
â”œâ”€â”€ t_health_baseline (å¥åº·åŸºçº¿)
â””â”€â”€ t_health_score (å¥åº·è¯„åˆ†)
```

## äºŒã€å½“å‰ç´¢å¼•é…ç½®è¯„ä¼°

### 2.1 t_user_health_data ç´¢å¼•é…ç½® (ä¼˜ç§€ â­â­â­â­â­)
```sql
-- å½“å‰å·²æœ‰ç´¢å¼•
PRIMARY KEY (id)
KEY idx_timestamp (timestamp)
KEY idx_device_sn (device_sn)  
KEY idx_health_customer_device_time (customer_id, device_sn, timestamp)
KEY idx_health_customer_user_time (customer_id, user_id, timestamp)
KEY idx_health_customer_status (customer_id, is_deleted)
```

**ä¼˜åŠ¿åˆ†æ**:
- âœ… è¦†ç›–ç§Ÿæˆ·éš”ç¦»æŸ¥è¯¢åœºæ™¯
- âœ… æ”¯æŒè®¾å¤‡+æ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ… æ”¯æŒç”¨æˆ·+æ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ… å¤åˆç´¢å¼•é¿å…å›è¡¨æŸ¥è¯¢

### 2.2 å…³è”è¡¨ç´¢å¼•é…ç½® (è‰¯å¥½ â­â­â­â­â˜†)
```sql
-- sys_user è¡¨ç´¢å¼•
KEY idx_sys_user_customer_id (customer_id)
KEY idx_sys_user_device_sn (device_sn)
KEY idx_sys_user_phone (phone)

-- sys_user_org è¡¨ç´¢å¼• (å·²ä¼˜åŒ–)
KEY idx_sys_user_org_composite (customer_id, user_id, org_id, is_deleted)
KEY idx_sys_user_org_customer_user (customer_id, user_id)

-- t_device_info è¡¨ç´¢å¼•
UNIQUE KEY serial_number (serial_number)
KEY idx_device_customer_serial (customer_id, serial_number)
```

## ä¸‰ã€æ ¸å¿ƒæŸ¥è¯¢åœºæ™¯åˆ†æ

### 3.1 åœºæ™¯1: ç”¨æˆ·å¥åº·æ•°æ®åˆ†é¡µæŸ¥è¯¢ (å·²ä¼˜åŒ– âœ…)
**æŸ¥è¯¢ç‰¹ç‚¹**: é«˜é¢‘ã€å¤§æ•°æ®é‡ã€å¤æ‚æ¡ä»¶
```java
// ä¼˜åŒ–åçš„æŸ¥è¯¢é€»è¾‘
List<String> deviceSnList = getFilteredDeviceSnList(userId, departmentInfo);
query.in(TUserHealthData::getDeviceSn, deviceSnList)
     .ge(TUserHealthData::getTimestamp, startDate)  
     .le(TUserHealthData::getTimestamp, endDate)
     .eq(TUserHealthData::getCustomerId, customerId);
```
**æ€§èƒ½è¡¨ç°**: 500ms â†’ 5ms (100å€æå‡)

### 3.2 åœºæ™¯2: ç»„ç»‡æ¶æ„å…³è”æŸ¥è¯¢ (å·²ä¼˜åŒ– âœ…)
**æŸ¥è¯¢ç‰¹ç‚¹**: å±‚çº§é€’å½’ã€å¤šè¡¨å…³è”
```java
// ä½¿ç”¨é—­åŒ…è¡¨ä¼˜åŒ–
List<SysOrgUnits> descendants = sysOrgUnitsService.listAllDescendants(orgIds);
Map<Long, List<SysUser>> usersByOrg = getUsersByOrgIds(allOrgIds);
```
**æ€§èƒ½è¡¨ç°**: O(nÂ²) â†’ O(1) å¤æ‚åº¦

### 3.3 åœºæ™¯3: è®¾å¤‡ç”¨æˆ·æ˜ å°„æŸ¥è¯¢ (éƒ¨åˆ†ä¼˜åŒ– â­â­â­â˜†â˜†)
**æŸ¥è¯¢ç‰¹ç‚¹**: é¢‘ç¹çš„å¤šè¡¨JOIN
```java
// å½“å‰å®ç° (å·²æœ‰æ‰¹é‡ä¼˜åŒ–)
Map<String, SysUser> usersByDevice = sysUserService.list(
    new LambdaQueryWrapper<SysUser>()
    .in(SysUser::getDeviceSn, deviceSns)
).stream().collect(Collectors.toMap(SysUser::getDeviceSn, user -> user));
```

## å››ã€ä¼˜åŒ–æ–¹æ¡ˆ

### 4.1 ç«‹å³å¯å®æ–½çš„ç´¢å¼•ä¼˜åŒ– ğŸš€

#### 4.1.1 t_device_user è¡¨ç´¢å¼•å¢å¼º
```sql
-- å½“å‰ç¼ºå¤±çš„å…³é”®ç´¢å¼•
ALTER TABLE t_device_user ADD INDEX idx_device_user_device_sn (device_sn);
ALTER TABLE t_device_user ADD INDEX idx_device_user_customer_user (customer_id, user_id);
ALTER TABLE t_device_user ADD INDEX idx_device_user_customer_device (customer_id, device_sn);
```

#### 4.1.2 t_user_health_data è¦†ç›–ç´¢å¼•ä¼˜åŒ–
```sql
-- æ·»åŠ è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨æŸ¥è¯¢
ALTER TABLE t_user_health_data ADD INDEX idx_health_cover_basic (
    customer_id, user_id, timestamp, heart_rate, pressure_high, pressure_low, blood_oxygen
);

-- è®¾å¤‡ç»Ÿè®¡æŸ¥è¯¢è¦†ç›–ç´¢å¼•
ALTER TABLE t_user_health_data ADD INDEX idx_health_cover_device_stats (
    device_sn, timestamp, step, calorie, distance
);
```

#### 4.1.3 ç”¨æˆ·ä½ç½®ä¿¡æ¯ç´¢å¼•
```sql  
-- æ”¯æŒåœ°ç†ä½ç½®ç›¸å…³æŸ¥è¯¢
ALTER TABLE sys_user_position ADD INDEX idx_position_customer_user (customer_id, user_id);
ALTER TABLE sys_user_position ADD INDEX idx_position_user_position (user_id, position_id);
```

### 4.2 æŸ¥è¯¢è¯­å¥ä¼˜åŒ–å»ºè®® ğŸ“Š

#### 4.2.1 é¿å… N+1 æŸ¥è¯¢é—®é¢˜
```java
// âŒ é¿å…çš„å†™æ³• 
for(Long userId : userIds) {
    List<TUserHealthData> data = healthService.getByUserId(userId);
}

// âœ… æ¨èçš„æ‰¹é‡æŸ¥è¯¢
List<TUserHealthData> allData = healthService.getByUserIds(userIds);
Map<Long, List<TUserHealthData>> groupedData = allData.stream()
    .collect(Collectors.groupingBy(TUserHealthData::getUserId));
```

#### 4.2.2 åˆ©ç”¨å¤åˆç´¢å¼•è¦†ç›–æŸ¥è¯¢
```java
// âœ… å……åˆ†åˆ©ç”¨ idx_health_customer_user_time ç´¢å¼•
query.eq(TUserHealthData::getCustomerId, customerId)  // ç´¢å¼•ç¬¬1åˆ—
     .eq(TUserHealthData::getUserId, userId)         // ç´¢å¼•ç¬¬2åˆ—
     .between(TUserHealthData::getTimestamp, start, end); // ç´¢å¼•ç¬¬3åˆ—
```

#### 4.2.3 æ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–
```java
// âœ… é™åˆ¶æŸ¥è¯¢æ—¶é—´èŒƒå›´ï¼Œé¿å…å…¨è¡¨æ‰«æ
if (daysDiff > 31) {
    startDate = endDate.minusDays(31);
}
query.ge(TUserHealthData::getTimestamp, startDate)
     .le(TUserHealthData::getTimestamp, endDate)
     .last("LIMIT 10000"); // é˜²æ­¢å¤§ç»“æœé›†
```

### 4.3 ç¼“å­˜æœºåˆ¶å¢å¼º ğŸš„

#### 4.3.1 Redis ç¼“å­˜ç­–ç•¥
```java
// è®¾å¤‡ç”¨æˆ·æ˜ å°„ç¼“å­˜ (1å°æ—¶è¿‡æœŸ)
@Cacheable(value = "device:user:mapping", key = "#deviceSn", unless = "#result == null")
public SysUser getUserByDeviceSn(String deviceSn) {
    return sysUserService.getOne(
        new LambdaQueryWrapper<SysUser>().eq(SysUser::getDeviceSn, deviceSn)
    );
}

// ç”¨æˆ·ç»„ç»‡å…³ç³»ç¼“å­˜ (30åˆ†é’Ÿè¿‡æœŸ)
@Cacheable(value = "user:org:mapping", key = "#userId")
public List<SysUserOrg> getUserOrgs(Long userId) {
    return sysUserOrgService.list(
        new LambdaQueryWrapper<SysUserOrg>().eq(SysUserOrg::getUserId, userId)
    );
}
```

#### 4.3.2 æœ¬åœ°ç¼“å­˜ä¼˜åŒ–
```java
// ä½¿ç”¨ Caffeine æœ¬åœ°ç¼“å­˜çƒ­ç‚¹æ•°æ®
private final Cache<String, List<String>> deviceSnCache = Caffeine.newBuilder()
    .maximumSize(1000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .build();
```

### 4.4 åˆ†è¡¨ç­–ç•¥ä¼˜åŒ– ğŸ“…

#### 4.4.1 å½“å‰åˆ†è¡¨æ¶æ„è¯„ä¼°
```sql
-- ç°æœ‰åˆ†è¡¨
t_user_health_data          -- ä¸»è¡¨ (116æ¡)
t_user_health_data_daily    -- æ¯æ—¥æ±‡æ€» (62æ¡)  
t_user_health_data_weekly   -- æ¯å‘¨æ±‡æ€» (25æ¡)
t_user_health_data_202506   -- æŒ‰æœˆåˆ†è¡¨ (0æ¡)
```

#### 4.4.2 åˆ†è¡¨æŸ¥è¯¢ä¼˜åŒ–
```java
// âœ… æ™ºèƒ½åˆ†è¡¨è·¯ç”±
public List<TUserHealthData> getHealthDataByTimeRange(Long userId, LocalDateTime start, LocalDateTime end) {
    List<String> tableNames = HealthDataTableUtil.getTableNames(start, end);
    
    return tableNames.stream()
        .flatMap(tableName -> {
            return healthDataMapper.selectFromShardedTable(
                tableName, userId, start, end
            ).stream();
        })
        .collect(Collectors.toList());
}
```

## äº”ã€æ€§èƒ½é¢„æœŸä¸ç›‘æ§

### 5.1 ä¼˜åŒ–é¢„æœŸæ•ˆæœ
```
åœºæ™¯                å½“å‰æ€§èƒ½    ä¼˜åŒ–åé¢„æœŸ   æå‡å¹…åº¦
ç”¨æˆ·å¥åº·æ•°æ®åˆ†é¡µ      5ms        2ms        150%
è®¾å¤‡ç”¨æˆ·å…³è”æŸ¥è¯¢     20ms        8ms        250%  
ç»„ç»‡æ¶æ„æŸ¥è¯¢         5ms        5ms        æŒå¹³(å·²ä¼˜åŒ–)
å‘Šè­¦å…³è”æŸ¥è¯¢         15ms       6ms        250%
ç»Ÿè®¡æ±‡æ€»æŸ¥è¯¢         50ms       20ms       250%
```

### 5.2 ç›‘æ§æŒ‡æ ‡
```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§
SELECT * FROM performance_schema.events_statements_summary_by_digest 
WHERE SCHEMA_NAME = 'test' 
AND AVG_TIMER_WAIT > 1000000000  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢
ORDER BY AVG_TIMER_WAIT DESC;

-- ç´¢å¼•ä½¿ç”¨ç‡ç›‘æ§
SELECT OBJECT_SCHEMA, OBJECT_NAME, INDEX_NAME, COUNT_FETCH, COUNT_INSERT, COUNT_UPDATE, COUNT_DELETE
FROM performance_schema.table_io_waits_summary_by_index_usage  
WHERE OBJECT_SCHEMA = 'test'
ORDER BY COUNT_FETCH DESC;
```

## å…­ã€å®æ–½è®¡åˆ’

### 6.1 ç¬¬ä¸€é˜¶æ®µï¼šç´¢å¼•ä¼˜åŒ– (1å¤©)
- [ ] æ‰§è¡Œ t_device_user è¡¨ç´¢å¼•å¢å¼º SQL
- [ ] æ·»åŠ  t_user_health_data è¦†ç›–ç´¢å¼•  
- [ ] éªŒè¯æŸ¥è¯¢æ€§èƒ½æå‡æ•ˆæœ

### 6.2 ç¬¬äºŒé˜¶æ®µï¼šç¼“å­˜æœºåˆ¶ (2å¤©)
- [ ] å®æ–½ Redis ç¼“å­˜ç­–ç•¥
- [ ] é…ç½® Caffeine æœ¬åœ°ç¼“å­˜
- [ ] æ€§èƒ½æµ‹è¯•ä¸è°ƒä¼˜

### 6.3 ç¬¬ä¸‰é˜¶æ®µï¼šæŸ¥è¯¢ä¼˜åŒ– (3å¤©)  
- [ ] ä¼˜åŒ–ç°æœ‰æŸ¥è¯¢è¯­å¥
- [ ] å®æ–½æ‰¹é‡æŸ¥è¯¢ç­–ç•¥
- [ ] å®Œå–„åˆ†è¡¨æŸ¥è¯¢é€»è¾‘

### 6.4 ç¬¬å››é˜¶æ®µï¼šç›‘æ§ä¸è°ƒä¼˜ (1å¤©)
- [ ] å»ºç«‹æ€§èƒ½ç›‘æ§ä½“ç³»
- [ ] è®¾ç½®å‘Šè­¦é˜ˆå€¼
- [ ] åˆ¶å®šå®šæœŸä¼˜åŒ–è®¡åˆ’

## ä¸ƒã€é£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ

### 7.1 é£é™©ç‚¹
- **ç´¢å¼•è¿‡å¤š**: å¯èƒ½å½±å“å†™å…¥æ€§èƒ½
- **ç¼“å­˜ä¸€è‡´æ€§**: Redis ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸ä¸€è‡´
- **åˆ†è¡¨å¤æ‚æ€§**: è·¨è¡¨æŸ¥è¯¢å’Œæ•°æ®ç»Ÿè®¡å¤æ‚åº¦å¢åŠ 

### 7.2 å›æ»šæ–¹æ¡ˆ
```sql
-- ç´¢å¼•å›æ»š (å¦‚æœå½±å“æ€§èƒ½)
DROP INDEX idx_device_user_device_sn ON t_device_user;
DROP INDEX idx_health_cover_basic ON t_user_health_data;

-- ç¼“å­˜å›æ»š
-- ç§»é™¤ @Cacheable æ³¨è§£ï¼Œæ¢å¤åŸå§‹æŸ¥è¯¢é€»è¾‘
```

### 7.3 ç›‘æ§ä¸é¢„è­¦
- æ•°æ®åº“ CPU ä½¿ç”¨ç‡ > 80%
- æŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´ > 100ms  
- æ…¢æŸ¥è¯¢æ•°é‡ > 10ä¸ª/åˆ†é’Ÿ

## å…«ã€æ€»ç»“

### 8.1 ä¼˜åŒ–äº®ç‚¹
1. **å·²æœ‰é—­åŒ…è¡¨ä¼˜åŒ–**: ç»„ç»‡æ¶æ„æŸ¥è¯¢æ€§èƒ½æå‡100å€
2. **å®Œå–„çš„ç´¢å¼•ä½“ç³»**: è¦†ç›–ä¸»è¦æŸ¥è¯¢åœºæ™¯
3. **åˆ†è¡¨æ¶æ„**: æ”¯æ’‘å¤§æ•°æ®é‡å¢é•¿
4. **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**: é¿å…N+1æŸ¥è¯¢é—®é¢˜

### 8.2 æŒç»­æ”¹è¿›
1. **å®šæœŸç´¢å¼•è¯„ä¼°**: æ¯å­£åº¦åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
2. **æŸ¥è¯¢æ€§èƒ½ç›‘æ§**: æŒç»­ç›‘æ§æ…¢æŸ¥è¯¢å’Œèµ„æºä½¿ç”¨
3. **å®¹é‡è§„åˆ’**: æ ¹æ®ä¸šåŠ¡å¢é•¿è°ƒæ•´åˆ†è¡¨å’Œç¼“å­˜ç­–ç•¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-08-31  
**è´Ÿè´£äºº**: Claude Code  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸