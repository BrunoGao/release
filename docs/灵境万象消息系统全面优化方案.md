# çµå¢ƒä¸‡è±¡æ¶ˆæ¯ç³»ç»Ÿå…¨é¢ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

åŸºäºç°æœ‰çš„æ¶ˆæ¯æœºåˆ¶æ·±åº¦åˆ†æå’Œç»„ç»‡æ¶æ„é—­åŒ…è¡¨ä¼˜åŒ–æˆæœï¼Œåˆ¶å®šå…¨é¢çš„æ¶ˆæ¯ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆã€‚æœ¬æ–¹æ¡ˆé‡ç‚¹è§£å†³æ¶ˆæ¯ç±»å‹è§„èŒƒåŒ–ã€çŠ¶æ€ç®¡ç†æ ‡å‡†åŒ–ã€å¤šç«¯é«˜æ•ˆæŸ¥è¯¢å’Œå“åº”è¿½è¸ªç­‰æ ¸å¿ƒé—®é¢˜ã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ ‡

- **ç»Ÿä¸€æ¶ˆæ¯ç±»å‹**: è§„èŒƒåŒ–æ¶ˆæ¯ç±»å‹æšä¸¾ï¼Œæ”¯æŒç¾¤å‘å’Œä¸ªäººæ¶ˆæ¯
- **æ ‡å‡†åŒ–çŠ¶æ€ç®¡ç†**: æ‘’å¼ƒ0/1æ•°å­—ç¼–ç ï¼Œä½¿ç”¨è¯­ä¹‰åŒ–çŠ¶æ€æšä¸¾
- **é«˜æ•ˆæŸ¥è¯¢æœºåˆ¶**: åŸºäºç§Ÿæˆ·/éƒ¨é—¨/ç”¨æˆ·çš„å¤šçº§æŸ¥è¯¢ä¼˜åŒ–
- **å®æ—¶å“åº”è¿½è¸ª**: å®Œæ•´çš„æ¶ˆæ¯å“åº”æ—¶é—´ç»Ÿè®¡å’Œæœªå“åº”ç”¨æˆ·è¿½è¸ª
- **å¤šç«¯APIæ¥å£**: ä¸ºadminã€å¤§å±ã€æ‰‹è¡¨ã€æ‰‹æœºæä¾›ä¸“ç”¨æ¥å£

---

## ğŸ”§ æ¶ˆæ¯ç±»å‹ä¸çŠ¶æ€è§„èŒƒåŒ–è®¾è®¡

### 1. æ¶ˆæ¯ç±»å‹æšä¸¾è®¾è®¡

#### 1.1 æ¶ˆæ¯å‘é€èŒƒå›´ç±»å‹
```java
public enum MessageScope {
    INDIVIDUAL("individual", "ä¸ªäººæ¶ˆæ¯"),
    GROUP("group", "ç¾¤å‘æ¶ˆæ¯"),
    DEPARTMENT("department", "éƒ¨é—¨æ¶ˆæ¯"),
    ORGANIZATION("organization", "ç»„ç»‡æ¶ˆæ¯"),
    BROADCAST("broadcast", "å…¨ç½‘å¹¿æ’­");
    
    private final String code;
    private final String description;
}
```

#### 1.2 æ¶ˆæ¯ä¸šåŠ¡ç±»å‹
```java
public enum MessageType {
    // å‘Šè­¦ç±»æ¶ˆæ¯
    ALERT_SOS("alert_sos", "SOSç´§æ€¥æ±‚åŠ©", MessagePriority.CRITICAL),
    ALERT_FALL("alert_fall", "è·Œå€’æ£€æµ‹", MessagePriority.CRITICAL),
    ALERT_HEALTH("alert_health", "å¥åº·å¼‚å¸¸", MessagePriority.HIGH),
    ALERT_DEVICE("alert_device", "è®¾å¤‡å¼‚å¸¸", MessagePriority.MEDIUM),
    
    // é€šçŸ¥ç±»æ¶ˆæ¯
    ANNOUNCEMENT("announcement", "ç³»ç»Ÿå…¬å‘Š", MessagePriority.LOW),
    NOTIFICATION("notification", "ä¸€èˆ¬é€šçŸ¥", MessagePriority.LOW),
    
    // ä»»åŠ¡ç±»æ¶ˆæ¯
    TASK_ASSIGNMENT("task_assignment", "ä»»åŠ¡åˆ†é…", MessagePriority.MEDIUM),
    TASK_REMINDER("task_reminder", "ä»»åŠ¡æé†’", MessagePriority.LOW),
    
    // æŒ‡å¼•ç±»æ¶ˆæ¯
    GUIDANCE_HEALTH("guidance_health", "å¥åº·æŒ‡å¼•", MessagePriority.LOW),
    GUIDANCE_DEVICE("guidance_device", "è®¾å¤‡ä½¿ç”¨æŒ‡å¼•", MessagePriority.LOW);
    
    private final String code;
    private final String description;
    private final MessagePriority defaultPriority;
}
```

#### 1.3 æ¶ˆæ¯ä¼˜å…ˆçº§æšä¸¾
```java
public enum MessagePriority {
    CRITICAL(1, "ç´§æ€¥", "#FF4444", 300),      // 5åˆ†é’Ÿ
    HIGH(2, "é«˜", "#FF8800", 900),           // 15åˆ†é’Ÿ
    MEDIUM(3, "ä¸­", "#FFAA00", 1800),        // 30åˆ†é’Ÿ
    LOW(4, "ä½", "#00AA00", 3600);           // 60åˆ†é’Ÿ
    
    private final int level;
    private final String description;
    private final String color;
    private final int escalationDelaySeconds;
}
```

### 2. æ¶ˆæ¯çŠ¶æ€æšä¸¾è®¾è®¡

#### 2.1 æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
```java
public enum MessageStatus {
    // åˆ›å»ºé˜¶æ®µ
    DRAFT("draft", "è‰ç¨¿", "æ¶ˆæ¯å·²åˆ›å»ºä½†æœªå‘é€"),
    PENDING("pending", "å¾…å‘é€", "æ¶ˆæ¯ç­‰å¾…å‘é€"),
    
    // å‘é€é˜¶æ®µ
    SENDING("sending", "å‘é€ä¸­", "æ¶ˆæ¯æ­£åœ¨å‘é€"),
    DELIVERED("delivered", "å·²é€è¾¾", "æ¶ˆæ¯å·²æˆåŠŸé€è¾¾æ¥æ”¶ç«¯"),
    DELIVERY_FAILED("delivery_failed", "é€è¾¾å¤±è´¥", "æ¶ˆæ¯é€è¾¾å¤±è´¥"),
    
    // å¤„ç†é˜¶æ®µ
    READ("read", "å·²è¯»å–", "ç”¨æˆ·å·²è¯»å–æ¶ˆæ¯"),
    ACKNOWLEDGED("acknowledged", "å·²ç¡®è®¤", "ç”¨æˆ·å·²ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯"),
    RESPONDED("responded", "å·²å“åº”", "ç”¨æˆ·å·²åšå‡ºå…·ä½“å“åº”"),
    
    // å‡çº§é˜¶æ®µ
    ESCALATED("escalated", "å·²å‡çº§", "æ¶ˆæ¯å·²å‡çº§åˆ°ä¸Šçº§å¤„ç†"),
    ESCALATION_PENDING("escalation_pending", "å‡çº§å¾…å¤„ç†", "ç­‰å¾…ä¸Šçº§å¤„ç†"),
    
    // å®Œæˆé˜¶æ®µ
    COMPLETED("completed", "å·²å®Œæˆ", "æ¶ˆæ¯å¤„ç†å®Œæˆ"),
    EXPIRED("expired", "å·²è¿‡æœŸ", "æ¶ˆæ¯å·²è¿‡æœŸæœªå¤„ç†"),
    CANCELLED("cancelled", "å·²å–æ¶ˆ", "æ¶ˆæ¯è¢«å–æ¶ˆ");
    
    private final String code;
    private final String name;
    private final String description;
}
```

#### 2.2 å‘é€è€…ç±»å‹æšä¸¾
```java
public enum SenderType {
    SYSTEM("system", "ç³»ç»Ÿ", "ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„æ¶ˆæ¯"),
    ADMIN("admin", "ç®¡ç†å‘˜", "ç®¡ç†å‘˜æ‰‹åŠ¨å‘é€çš„æ¶ˆæ¯"),
    USER("user", "ç”¨æˆ·", "ç”¨æˆ·å‘é€çš„æ¶ˆæ¯"),
    DEVICE("device", "è®¾å¤‡", "è®¾å¤‡è‡ªåŠ¨ç”Ÿæˆçš„æ¶ˆæ¯"),
    AI("ai", "AIåŠ©æ‰‹", "AIæ™ºèƒ½åŠ©æ‰‹ç”Ÿæˆçš„æ¶ˆæ¯");
    
    private final String code;
    private final String name;
    private final String description;
}
```

#### 2.3 æ¥æ”¶è€…ç±»å‹æšä¸¾
```java
public enum ReceiverType {
    USER("user", "ç”¨æˆ·", "å‘é€ç»™ç‰¹å®šç”¨æˆ·"),
    DEPARTMENT("department", "éƒ¨é—¨", "å‘é€ç»™æ•´ä¸ªéƒ¨é—¨"),
    ROLE("role", "è§’è‰²", "å‘é€ç»™ç‰¹å®šè§’è‰²ç”¨æˆ·"),
    DEVICE("device", "è®¾å¤‡", "å‘é€ç»™ç‰¹å®šè®¾å¤‡"),
    BROADCAST("broadcast", "å¹¿æ’­", "å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·");
    
    private final String code;
    private final String name;
    private final String description;
}
```

---

## ğŸ—„ï¸ ä¼˜åŒ–åçš„æ•°æ®åº“è¡¨ç»“æ„

### 1. ä¸»æ¶ˆæ¯è¡¨ç»“æ„ä¼˜åŒ–

```sql
-- ä¼˜åŒ–åçš„ä¸»æ¶ˆæ¯è¡¨
CREATE TABLE `t_device_message_v2` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'æ¶ˆæ¯ID',
  `customer_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `department_id` bigint DEFAULT NULL COMMENT 'éƒ¨é—¨ID',
  `user_id` bigint DEFAULT NULL COMMENT 'ç›®æ ‡ç”¨æˆ·ID(ä¸ªäººæ¶ˆæ¯)',
  `device_sn` varchar(255) DEFAULT NULL COMMENT 'å…³è”è®¾å¤‡åºåˆ—å·',
  
  -- æ¶ˆæ¯å†…å®¹
  `message` text NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `message_type` varchar(50) NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹æšä¸¾',
  `message_scope` varchar(50) NOT NULL DEFAULT 'individual' COMMENT 'æ¶ˆæ¯èŒƒå›´',
  
  -- å‘é€æ¥æ”¶ä¿¡æ¯
  `sender_type` varchar(50) NOT NULL COMMENT 'å‘é€è€…ç±»å‹æšä¸¾',
  `receiver_type` varchar(50) NOT NULL COMMENT 'æ¥æ”¶è€…ç±»å‹æšä¸¾',
  `priority_level` int NOT NULL DEFAULT 4 COMMENT 'ä¼˜å…ˆçº§(1-4)',
  
  -- çŠ¶æ€è¿½è¸ª
  `message_status` varchar(50) NOT NULL DEFAULT 'pending' COMMENT 'æ¶ˆæ¯çŠ¶æ€æšä¸¾',
  `sent_time` timestamp NULL DEFAULT NULL COMMENT 'å‘é€æ—¶é—´',
  `received_time` timestamp NULL DEFAULT NULL COMMENT 'é¦–æ¬¡æ¥æ”¶æ—¶é—´',
  `acknowledged_time` timestamp NULL DEFAULT NULL COMMENT 'ç¡®è®¤æ—¶é—´',
  `expired_time` timestamp NULL DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  
  -- ç»Ÿè®¡ä¿¡æ¯
  `target_user_count` int DEFAULT 0 COMMENT 'ç›®æ ‡ç”¨æˆ·æ€»æ•°',
  `acknowledged_count` int DEFAULT 0 COMMENT 'å·²ç¡®è®¤ç”¨æˆ·æ•°',
  
  -- å®¡è®¡å­—æ®µ
  `create_user_id` bigint DEFAULT NULL COMMENT 'åˆ›å»ºç”¨æˆ·ID',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°',
  `version` int NOT NULL DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
  
  PRIMARY KEY (`id`),
  
  -- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  KEY `idx_message_customer_status` (`customer_id`, `message_status`, `is_deleted`),
  KEY `idx_message_dept_status` (`department_id`, `message_status`, `is_deleted`),
  KEY `idx_message_user_status` (`user_id`, `message_status`, `is_deleted`),
  KEY `idx_message_type_priority` (`message_type`, `priority_level`, `create_time`),
  KEY `idx_message_scope_type` (`message_scope`, `message_type`, `is_deleted`),
  KEY `idx_message_device_time` (`device_sn`, `create_time`, `is_deleted`),
  KEY `idx_message_response_time` (`sent_time`, `acknowledged_time`, `is_deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='è®¾å¤‡æ¶ˆæ¯ä¸»è¡¨V2';
```

### 2. æ¶ˆæ¯è¯¦æƒ…è¡¨ç»“æ„ä¼˜åŒ–

```sql
-- ä¼˜åŒ–åçš„æ¶ˆæ¯è¯¦æƒ…è¡¨
CREATE TABLE `t_device_message_detail_v2` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'è¯¦æƒ…ID',
  `message_id` bigint NOT NULL COMMENT 'ä¸»æ¶ˆæ¯ID',
  `customer_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `user_id` bigint NOT NULL COMMENT 'æ¥æ”¶ç”¨æˆ·ID',
  `device_sn` varchar(255) DEFAULT NULL COMMENT 'è®¾å¤‡åºåˆ—å·',
  
  -- å“åº”ä¿¡æ¯
  `response_message` text COMMENT 'ç”¨æˆ·å“åº”å†…å®¹',
  `response_type` varchar(50) DEFAULT 'acknowledged' COMMENT 'å“åº”ç±»å‹',
  `response_time` timestamp NULL DEFAULT NULL COMMENT 'å“åº”æ—¶é—´',
  
  -- æŠ•é€’çŠ¶æ€
  `delivery_status` varchar(50) NOT NULL DEFAULT 'pending' COMMENT 'æŠ•é€’çŠ¶æ€',
  `delivery_attempt_count` int DEFAULT 0 COMMENT 'æŠ•é€’å°è¯•æ¬¡æ•°',
  `last_delivery_time` timestamp NULL DEFAULT NULL COMMENT 'æœ€åæŠ•é€’æ—¶é—´',
  
  -- å®¡è®¡å­—æ®µ
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `is_deleted` tinyint(1) NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°',
  
  PRIMARY KEY (`id`),
  
  -- å¤–é”®çº¦æŸ
  FOREIGN KEY (`message_id`) REFERENCES `t_device_message_v2`(`id`) ON DELETE CASCADE,
  
  -- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  KEY `idx_detail_message_user` (`message_id`, `user_id`, `is_deleted`),
  KEY `idx_detail_customer_status` (`customer_id`, `delivery_status`, `is_deleted`),
  KEY `idx_detail_user_response` (`user_id`, `response_time`, `is_deleted`),
  KEY `idx_detail_delivery_status` (`delivery_status`, `delivery_attempt_count`),
  KEY `idx_detail_device_time` (`device_sn`, `create_time`, `is_deleted`),
  
  -- å¤åˆæŸ¥è¯¢ç´¢å¼•
  UNIQUE KEY `idx_detail_unique` (`message_id`, `user_id`, `is_deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='è®¾å¤‡æ¶ˆæ¯è¯¦æƒ…è¡¨V2';
```

### 3. æ¶ˆæ¯å½’æ¡£è¡¨è®¾è®¡

```sql
-- æ¶ˆæ¯å½’æ¡£è¡¨ - ç”¨äºå†å²æ•°æ®å­˜å‚¨
CREATE TABLE `t_device_message_archive_v2` (
  `id` bigint NOT NULL COMMENT 'æ¶ˆæ¯ID',
  `customer_id` bigint NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `archive_date` date NOT NULL COMMENT 'å½’æ¡£æ—¥æœŸ',
  `message_data` json NOT NULL COMMENT 'å®Œæ•´æ¶ˆæ¯æ•°æ®JSON',
  `statistics_data` json COMMENT 'ç»Ÿè®¡æ•°æ®JSON',
  `archive_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT 'å½’æ¡£æ—¶é—´',
  
  PRIMARY KEY (`id`, `archive_date`),
  KEY `idx_archive_customer_date` (`customer_id`, `archive_date`),
  KEY `idx_archive_date` (`archive_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
COMMENT='æ¶ˆæ¯å½’æ¡£è¡¨V2'
PARTITION BY RANGE (TO_DAYS(archive_date)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION p202504 VALUES LESS THAN (TO_DAYS('2025-05-01')),
    PARTITION p202505 VALUES LESS THAN (TO_DAYS('2025-06-01')),
    PARTITION p202506 VALUES LESS THAN (TO_DAYS('2025-07-01')),
    PARTITION p202507 VALUES LESS THAN (TO_DAYS('2025-08-01')),
    PARTITION p202508 VALUES LESS THAN (TO_DAYS('2025-09-01')),
    PARTITION p202509 VALUES LESS THAN (TO_DAYS('2025-10-01')),
    PARTITION p202510 VALUES LESS THAN (TO_DAYS('2025-11-01')),
    PARTITION p202511 VALUES LESS THAN (TO_DAYS('2025-12-01')),
    PARTITION p202512 VALUES LESS THAN (TO_DAYS('2026-01-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## ğŸš€ é«˜æ•ˆæŸ¥è¯¢SQLè®¾è®¡

### 1. åŸºäºç§Ÿæˆ·/éƒ¨é—¨/ç”¨æˆ·çš„åˆ†å±‚æŸ¥è¯¢

#### 1.1 ç§Ÿæˆ·çº§æ¶ˆæ¯ç»Ÿè®¡æŸ¥è¯¢
```sql
-- ç§Ÿæˆ·çº§æ¶ˆæ¯ç»Ÿè®¡ - ç®¡ç†å‘˜æ€»è§ˆ
SELECT 
    m.customer_id,
    COUNT(*) as total_messages,
    COUNT(CASE WHEN m.message_status = 'pending' THEN 1 END) as pending_count,
    COUNT(CASE WHEN m.message_status = 'delivered' THEN 1 END) as delivered_count,
    COUNT(CASE WHEN m.message_status = 'acknowledged' THEN 1 END) as acknowledged_count,
    COUNT(CASE WHEN m.message_status = 'expired' THEN 1 END) as expired_count,
    ROUND(
        COUNT(CASE WHEN m.message_status = 'acknowledged' THEN 1 END) * 100.0 / 
        NULLIF(COUNT(*), 0), 2
    ) as response_rate,
    AVG(TIMESTAMPDIFF(SECOND, m.sent_time, m.acknowledged_time)) as avg_response_time_seconds
FROM t_device_message_v2 m
WHERE m.customer_id = ? 
  AND m.is_deleted = 0
  AND m.create_time >= ?
  AND m.create_time <= ?
GROUP BY m.customer_id;
```

#### 1.2 éƒ¨é—¨çº§æ¶ˆæ¯æŸ¥è¯¢ - åŸºäºé—­åŒ…è¡¨ä¼˜åŒ–
```sql
-- éƒ¨é—¨çº§æ¶ˆæ¯æŸ¥è¯¢ - åˆ©ç”¨é—­åŒ…è¡¨å®ç°æ¯«ç§’çº§æŸ¥è¯¢
SELECT 
    m.id,
    m.message,
    m.message_type,
    m.message_scope,
    m.priority_level,
    m.message_status,
    m.sent_time,
    m.target_user_count,
    m.acknowledged_count,
    (m.target_user_count - m.acknowledged_count) as unresponded_count,
    TIMESTAMPDIFF(SECOND, m.sent_time, NOW()) as elapsed_seconds,
    o.name as department_name,
    creator.real_name as creator_name
FROM t_device_message_v2 m
INNER JOIN sys_org_closure c ON (
    (m.department_id = c.descendant_id) OR 
    (m.message_scope = 'organization' AND c.ancestor_id = ?)
)
INNER JOIN sys_org_units o ON m.department_id = o.id
LEFT JOIN sys_user creator ON m.create_user_id = creator.id
WHERE c.ancestor_id = ?  -- æŸ¥è¯¢éƒ¨é—¨ID
  AND m.customer_id = ?  -- ç§Ÿæˆ·ID
  AND m.is_deleted = 0
  AND c.customer_id = ?
ORDER BY m.priority_level ASC, m.create_time DESC
LIMIT ? OFFSET ?;
```

#### 1.3 ç”¨æˆ·ä¸ªäººæ¶ˆæ¯æŸ¥è¯¢
```sql
-- ç”¨æˆ·ä¸ªäººæ¶ˆæ¯æŸ¥è¯¢ - é«˜æ€§èƒ½ç´¢å¼•ä¼˜åŒ–
SELECT 
    m.id,
    m.message,
    m.message_type,
    m.priority_level,
    m.message_status,
    m.sent_time,
    m.create_time,
    d.delivery_status,
    d.response_time,
    d.response_message,
    CASE 
        WHEN d.response_time IS NOT NULL THEN 
            TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)
        ELSE NULL 
    END as response_time_seconds,
    CASE
        WHEN m.message_status IN ('pending', 'delivered', 'read') THEN 1
        ELSE 0
    END as is_unread
FROM t_device_message_v2 m
INNER JOIN t_device_message_detail_v2 d ON m.id = d.message_id
WHERE d.user_id = ?  -- ç”¨æˆ·ID
  AND m.customer_id = ?  -- ç§Ÿæˆ·ID
  AND m.is_deleted = 0
  AND d.is_deleted = 0
ORDER BY m.priority_level ASC, m.create_time DESC
LIMIT ? OFFSET ?;
```

### 2. æœªå“åº”ç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–

#### 2.1 æŒ‰æ¶ˆæ¯æŸ¥è¯¢æœªå“åº”ç”¨æˆ·
```sql
-- æŸ¥è¯¢ç‰¹å®šæ¶ˆæ¯çš„æœªå“åº”ç”¨æˆ·åˆ—è¡¨
SELECT 
    u.id as user_id,
    u.real_name as user_name,
    u.phone,
    uo.org_id,
    o.name as department_name,
    o.parent_id,
    parent_o.name as parent_department_name,
    d.delivery_status,
    d.delivery_attempt_count,
    d.last_delivery_time,
    TIMESTAMPDIFF(SECOND, m.sent_time, NOW()) as elapsed_seconds
FROM t_device_message_v2 m
INNER JOIN t_device_message_detail_v2 d ON m.id = d.message_id
INNER JOIN sys_user u ON d.user_id = u.id
INNER JOIN sys_user_org uo ON u.id = uo.user_id
INNER JOIN sys_org_units o ON uo.org_id = o.id
LEFT JOIN sys_org_units parent_o ON o.parent_id = parent_o.id
WHERE m.id = ?  -- æ¶ˆæ¯ID
  AND m.customer_id = ?  -- ç§Ÿæˆ·ID
  AND d.delivery_status NOT IN ('acknowledged', 'responded')
  AND m.is_deleted = 0
  AND d.is_deleted = 0
  AND u.is_deleted = 0
  AND uo.is_deleted = 0
ORDER BY uo.principal DESC, o.level_order ASC, u.real_name;
```

#### 2.2 æ‰¹é‡æŸ¥è¯¢å¤šæ¡æ¶ˆæ¯çš„å“åº”çŠ¶æ€
```sql
-- æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯å“åº”ç»Ÿè®¡
SELECT 
    m.id as message_id,
    m.message,
    m.message_type,
    m.target_user_count,
    m.acknowledged_count,
    (m.target_user_count - m.acknowledged_count) as unresponded_count,
    ROUND(m.acknowledged_count * 100.0 / m.target_user_count, 2) as response_rate,
    -- æœªå“åº”ç”¨æˆ·åˆ—è¡¨ (JSONèšåˆ)
    JSON_ARRAYAGG(
        CASE 
            WHEN d.delivery_status NOT IN ('acknowledged', 'responded') THEN
                JSON_OBJECT(
                    'userId', d.user_id,
                    'userName', u.real_name,
                    'phone', u.phone,
                    'departmentName', o.name,
                    'deliveryStatus', d.delivery_status,
                    'elapsedSeconds', TIMESTAMPDIFF(SECOND, m.sent_time, NOW())
                )
            ELSE NULL
        END
    ) as unresponded_users
FROM t_device_message_v2 m
LEFT JOIN t_device_message_detail_v2 d ON m.id = d.message_id AND d.is_deleted = 0
LEFT JOIN sys_user u ON d.user_id = u.id AND u.is_deleted = 0
LEFT JOIN sys_user_org uo ON u.id = uo.user_id AND uo.is_deleted = 0
LEFT JOIN sys_org_units o ON uo.org_id = o.id AND o.is_deleted = 0
WHERE m.customer_id = ?
  AND m.create_time >= ?
  AND m.create_time <= ?
  AND m.is_deleted = 0
GROUP BY m.id, m.message, m.message_type, m.target_user_count, m.acknowledged_count
ORDER BY m.priority_level ASC, m.create_time DESC
LIMIT ? OFFSET ?;
```

### 3. å“åº”æ—¶é—´ç»Ÿè®¡æŸ¥è¯¢

#### 3.1 æ¶ˆæ¯å“åº”æ—¶é—´åˆ†æ
```sql
-- æ¶ˆæ¯å“åº”æ—¶é—´æ·±åº¦åˆ†æ
SELECT 
    m.message_type,
    m.priority_level,
    o.name as department_name,
    COUNT(*) as total_messages,
    COUNT(CASE WHEN d.response_time IS NOT NULL THEN 1 END) as responded_messages,
    
    -- å“åº”æ—¶é—´ç»Ÿè®¡
    AVG(TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)) as avg_response_seconds,
    MIN(TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)) as min_response_seconds,
    MAX(TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)) as max_response_seconds,
    
    -- å“åº”æ—¶é—´åˆ†ä½æ•°
    PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)) as p50_response_seconds,
    PERCENTILE_CONT(0.90) WITHIN GROUP (ORDER BY TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)) as p90_response_seconds,
    PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)) as p99_response_seconds,
    
    -- å“åº”ç‡
    ROUND(
        COUNT(CASE WHEN d.response_time IS NOT NULL THEN 1 END) * 100.0 / COUNT(*), 2
    ) as response_rate,
    
    -- SLAç»Ÿè®¡ (5åˆ†é’Ÿå“åº”ç›®æ ‡)
    COUNT(CASE 
        WHEN d.response_time IS NOT NULL 
        AND TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time) <= 300 
        THEN 1 END
    ) as sla_met_count,
    
    ROUND(
        COUNT(CASE 
            WHEN d.response_time IS NOT NULL 
            AND TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time) <= 300 
            THEN 1 END
        ) * 100.0 / COUNT(*), 2
    ) as sla_compliance_rate

FROM t_device_message_v2 m
INNER JOIN t_device_message_detail_v2 d ON m.id = d.message_id
INNER JOIN sys_user u ON d.user_id = u.id
INNER JOIN sys_user_org uo ON u.id = uo.user_id
INNER JOIN sys_org_units o ON uo.org_id = o.id
WHERE m.customer_id = ?
  AND m.create_time >= ?
  AND m.create_time <= ?
  AND m.is_deleted = 0
  AND d.is_deleted = 0
  AND u.is_deleted = 0
GROUP BY m.message_type, m.priority_level, o.id, o.name
ORDER BY avg_response_seconds DESC;
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### 1. ljwx-boot ä¸º ljwx-admin æä¾›çš„æ¥å£

#### 1.1 æ¶ˆæ¯ç®¡ç†æ¥å£
```java
@RestController
@RequestMapping("/api/v2/messages")
@Api(tags = "æ¶ˆæ¯ç®¡ç†V2")
public class DeviceMessageV2Controller {
    
    @Autowired
    private DeviceMessageV2Service messageService;
    
    /**
     * åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨ - æ”¯æŒå¤šç»´åº¦ç­›é€‰
     */
    @GetMapping("/page")
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨")
    public Result<PageResult<MessageListVO>> getMessagePage(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize,
            @RequestParam(required = false) Long customerId,
            @RequestParam(required = false) Long departmentId,
            @RequestParam(required = false) Long userId,
            @RequestParam(required = false) String messageType,
            @RequestParam(required = false) String messageStatus,
            @RequestParam(required = false) String messageScope,
            @RequestParam(required = false) Integer priorityLevel,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") LocalDateTime startTime,
            @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") LocalDateTime endTime) {
        
        MessageQueryDTO queryDTO = MessageQueryDTO.builder()
            .customerId(customerId)
            .departmentId(departmentId)
            .userId(userId)
            .messageType(messageType)
            .messageStatus(messageStatus)
            .messageScope(messageScope)
            .priorityLevel(priorityLevel)
            .startTime(startTime)
            .endTime(endTime)
            .page(page)
            .pageSize(pageSize)
            .build();
            
        PageResult<MessageListVO> result = messageService.getMessagePage(queryDTO);
        return Result.success(result);
    }
    
    /**
     * æŸ¥è¯¢æ¶ˆæ¯è¯¦ç»†å“åº”çŠ¶æ€
     */
    @GetMapping("/{messageId}/response-status")
    @ApiOperation("æŸ¥è¯¢æ¶ˆæ¯å“åº”çŠ¶æ€è¯¦æƒ…")
    public Result<MessageResponseStatusVO> getMessageResponseStatus(
            @PathVariable Long messageId,
            @RequestParam Long customerId) {
        
        MessageResponseStatusVO status = messageService.getMessageResponseStatus(messageId, customerId);
        return Result.success(status);
    }
    
    /**
     * æŸ¥è¯¢æœªå“åº”ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/{messageId}/unresponded-users")
    @ApiOperation("æŸ¥è¯¢æœªå“åº”ç”¨æˆ·åˆ—è¡¨")
    public Result<List<UnrespondedUserVO>> getUnrespondedUsers(
            @PathVariable Long messageId,
            @RequestParam Long customerId,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "50") Integer pageSize) {
        
        List<UnrespondedUserVO> users = messageService.getUnrespondedUsers(messageId, customerId, page, pageSize);
        return Result.success(users);
    }
    
    /**
     * æ¶ˆæ¯å“åº”æ—¶é—´ç»Ÿè®¡
     */
    @GetMapping("/response-time-statistics")
    @ApiOperation("æ¶ˆæ¯å“åº”æ—¶é—´ç»Ÿè®¡")
    public Result<MessageResponseTimeStatisticsVO> getResponseTimeStatistics(
            @RequestParam Long customerId,
            @RequestParam(required = false) Long departmentId,
            @RequestParam(required = false) String messageType,
            @RequestParam(required = false) Integer priorityLevel,
            @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        ResponseTimeQueryDTO queryDTO = ResponseTimeQueryDTO.builder()
            .customerId(customerId)
            .departmentId(departmentId)
            .messageType(messageType)
            .priorityLevel(priorityLevel)
            .startDate(startDate)
            .endDate(endDate)
            .build();
            
        MessageResponseTimeStatisticsVO statistics = messageService.getResponseTimeStatistics(queryDTO);
        return Result.success(statistics);
    }
    
    /**
     * åˆ›å»ºæ–°æ¶ˆæ¯
     */
    @PostMapping
    @ApiOperation("åˆ›å»ºæ–°æ¶ˆæ¯")
    public Result<Long> createMessage(@RequestBody @Valid CreateMessageDTO createDTO) {
        Long messageId = messageService.createMessage(createDTO);
        return Result.success(messageId);
    }
    
    /**
     * æ‰¹é‡æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
     */
    @PutMapping("/batch-mark-read")
    @ApiOperation("æ‰¹é‡æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»")
    public Result<Boolean> batchMarkAsRead(@RequestBody BatchMarkReadDTO batchDTO) {
        Boolean success = messageService.batchMarkAsRead(batchDTO);
        return Result.success(success);
    }
}
```

#### 1.2 æ¶ˆæ¯ç»Ÿè®¡åˆ†ææ¥å£
```java
@RestController
@RequestMapping("/api/v2/message-analytics")
@Api(tags = "æ¶ˆæ¯åˆ†æç»Ÿè®¡V2")
public class MessageAnalyticsController {
    
    /**
     * æ¶ˆæ¯ç»Ÿè®¡ä»ªè¡¨æ¿æ•°æ®
     */
    @GetMapping("/dashboard")
    @ApiOperation("è·å–æ¶ˆæ¯ç»Ÿè®¡ä»ªè¡¨æ¿æ•°æ®")
    public Result<MessageDashboardVO> getMessageDashboard(
            @RequestParam Long customerId,
            @RequestParam(required = false) Long departmentId,
            @RequestParam(defaultValue = "7") Integer recentDays) {
        
        MessageDashboardVO dashboard = messageAnalyticsService.getMessageDashboard(
            customerId, departmentId, recentDays);
        return Result.success(dashboard);
    }
    
    /**
     * éƒ¨é—¨æ¶ˆæ¯æ€§èƒ½å¯¹æ¯”
     */
    @GetMapping("/department-performance")
    @ApiOperation("éƒ¨é—¨æ¶ˆæ¯å“åº”æ€§èƒ½å¯¹æ¯”")
    public Result<List<DepartmentMessagePerformanceVO>> getDepartmentPerformance(
            @RequestParam Long customerId,
            @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startDate,
            @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endDate) {
        
        List<DepartmentMessagePerformanceVO> performance = 
            messageAnalyticsService.getDepartmentPerformance(customerId, startDate, endDate);
        return Result.success(performance);
    }
    
    /**
     * æ¶ˆæ¯ç±»å‹åˆ†å¸ƒç»Ÿè®¡
     */
    @GetMapping("/type-distribution")
    @ApiOperation("æ¶ˆæ¯ç±»å‹åˆ†å¸ƒç»Ÿè®¡")
    public Result<List<MessageTypeDistributionVO>> getMessageTypeDistribution(
            @RequestParam Long customerId,
            @RequestParam(defaultValue = "30") Integer recentDays) {
        
        List<MessageTypeDistributionVO> distribution = 
            messageAnalyticsService.getMessageTypeDistribution(customerId, recentDays);
        return Result.success(distribution);
    }
}
```

### 2. ljwx-bigscreen ä¸ºè®¾å¤‡ç«¯æä¾›çš„æ¥å£

#### 2.1 è®¾å¤‡æ¶ˆæ¯æ¨é€æ¥å£
```python
from flask import Flask, request, jsonify
from flask_socketio import SocketIO, emit
import redis
import json
from datetime import datetime, timedelta

app = Flask(__name__)
socketio = SocketIO(app, cors_allowed_origins="*")
redis_client = redis.Redis(host='localhost', port=6379, db=1, password='123456')

class DeviceMessageService:
    """è®¾å¤‡æ¶ˆæ¯æœåŠ¡"""
    
    @staticmethod
    @app.route('/api/device/messages/poll', methods=['GET'])
    def poll_messages():
        """è®¾å¤‡è½®è¯¢æ¶ˆæ¯æ¥å£ - æ‰‹è¡¨/æ‰‹æœºå®šæ—¶è°ƒç”¨"""
        try:
            device_sn = request.args.get('device_sn')
            user_id = request.args.get('user_id')
            customer_id = request.args.get('customer_id')
            last_poll_time = request.args.get('last_poll_time')  # ISOæ ¼å¼æ—¶é—´æˆ³
            
            if not all([device_sn, user_id, customer_id]):
                return jsonify({
                    'code': 400,
                    'message': 'ç¼ºå°‘å¿…è¦å‚æ•°',
                    'data': None
                }), 400
            
            # æŸ¥è¯¢æ–°æ¶ˆæ¯
            messages = DeviceMessageService._get_new_messages(
                device_sn, user_id, customer_id, last_poll_time
            )
            
            # æ›´æ–°æœ€åè½®è¯¢æ—¶é—´
            DeviceMessageService._update_last_poll_time(device_sn, user_id)
            
            return jsonify({
                'code': 200,
                'message': 'æŸ¥è¯¢æˆåŠŸ',
                'data': {
                    'messages': messages,
                    'total_count': len(messages),
                    'unread_count': len([m for m in messages if m['status'] in ['pending', 'delivered']]),
                    'server_time': datetime.now().isoformat(),
                    'next_poll_interval': DeviceMessageService._calculate_next_poll_interval(messages)
                }
            })
            
        except Exception as e:
            logger.error(f"è®¾å¤‡è½®è¯¢æ¶ˆæ¯å¤±è´¥: {str(e)}")
            return jsonify({
                'code': 500,
                'message': 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
                'data': None
            }), 500
    
    @staticmethod
    def _get_new_messages(device_sn, user_id, customer_id, last_poll_time):
        """è·å–æ–°æ¶ˆæ¯"""
        
        # æ„å»ºæŸ¥è¯¢æ¡ä»¶
        where_conditions = [
            "m.customer_id = %s",
            "d.user_id = %s", 
            "m.is_deleted = 0",
            "d.is_deleted = 0"
        ]
        params = [customer_id, user_id]
        
        # è®¾å¤‡å…³è”æ¶ˆæ¯
        if device_sn:
            where_conditions.append("(m.device_sn = %s OR m.device_sn IS NULL)")
            params.append(device_sn)
        
        # æ—¶é—´èŒƒå›´è¿‡æ»¤
        if last_poll_time:
            where_conditions.append("m.create_time > %s")
            params.append(last_poll_time)
        else:
            # é¦–æ¬¡è½®è¯¢ï¼Œè·å–æœ€è¿‘24å°æ—¶çš„æ¶ˆæ¯
            where_conditions.append("m.create_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)")
        
        query = f"""
        SELECT 
            m.id,
            m.message,
            m.message_type,
            m.message_scope,
            m.priority_level,
            m.sent_time,
            m.create_time,
            d.delivery_status as status,
            d.response_time,
            d.response_message,
            
            -- å“åº”è¦æ±‚
            CASE m.priority_level
                WHEN 1 THEN DATE_ADD(m.sent_time, INTERVAL 5 MINUTE)
                WHEN 2 THEN DATE_ADD(m.sent_time, INTERVAL 15 MINUTE) 
                WHEN 3 THEN DATE_ADD(m.sent_time, INTERVAL 30 MINUTE)
                ELSE DATE_ADD(m.sent_time, INTERVAL 60 MINUTE)
            END as response_deadline,
            
            -- æ˜¯å¦è¿‡æœŸ
            CASE 
                WHEN d.response_time IS NOT NULL THEN 0
                WHEN NOW() > CASE m.priority_level
                    WHEN 1 THEN DATE_ADD(m.sent_time, INTERVAL 5 MINUTE)
                    WHEN 2 THEN DATE_ADD(m.sent_time, INTERVAL 15 MINUTE)
                    WHEN 3 THEN DATE_ADD(m.sent_time, INTERVAL 30 MINUTE)
                    ELSE DATE_ADD(m.sent_time, INTERVAL 60 MINUTE)
                END THEN 1
                ELSE 0
            END as is_expired
            
        FROM t_device_message_v2 m
        INNER JOIN t_device_message_detail_v2 d ON m.id = d.message_id
        WHERE {' AND '.join(where_conditions)}
        ORDER BY m.priority_level ASC, m.create_time DESC
        LIMIT 100
        """
        
        cursor = db.connection.cursor()
        cursor.execute(query, params)
        results = cursor.fetchall()
        
        messages = []
        for row in results:
            message = {
                'id': row[0],
                'content': row[1],
                'type': row[2],
                'scope': row[3],
                'priority': row[4],
                'sent_time': row[5].isoformat() if row[5] else None,
                'create_time': row[6].isoformat() if row[6] else None,
                'status': row[7],
                'response_time': row[8].isoformat() if row[8] else None,
                'response_message': row[9],
                'response_deadline': row[10].isoformat() if row[10] else None,
                'is_expired': bool(row[11]),
                'urgency_indicator': DeviceMessageService._calculate_urgency(row[4], row[10])
            }
            messages.append(message)
        
        return messages
    
    @staticmethod
    @app.route('/api/device/messages/respond', methods=['POST'])
    def respond_to_message():
        """è®¾å¤‡å“åº”æ¶ˆæ¯æ¥å£ - æ‰‹æœºç«¯ç¡®è®¤æ¶ˆæ¯"""
        try:
            data = request.get_json()
            message_id = data.get('message_id')
            user_id = data.get('user_id')
            customer_id = data.get('customer_id')
            response_type = data.get('response_type', 'acknowledged')
            response_message = data.get('response_message', '')
            device_sn = data.get('device_sn')
            
            # å‚æ•°éªŒè¯
            if not all([message_id, user_id, customer_id]):
                return jsonify({
                    'code': 400,
                    'message': 'ç¼ºå°‘å¿…è¦å‚æ•°',
                    'data': None
                }), 400
            
            # æ›´æ–°å“åº”çŠ¶æ€
            success = DeviceMessageService._update_message_response(
                message_id, user_id, customer_id, response_type, response_message
            )
            
            if success:
                # å‘é€WebSocketé€šçŸ¥ç»™å¤§å±
                socketio.emit('message_response_update', {
                    'message_id': message_id,
                    'user_id': user_id,
                    'response_type': response_type,
                    'response_time': datetime.now().isoformat()
                }, namespace='/admin')
                
                return jsonify({
                    'code': 200,
                    'message': 'å“åº”æˆåŠŸ',
                    'data': {'message_id': message_id, 'status': 'responded'}
                })
            else:
                return jsonify({
                    'code': 500,
                    'message': 'å“åº”å¤±è´¥',
                    'data': None
                }), 500
                
        except Exception as e:
            logger.error(f"æ¶ˆæ¯å“åº”å¤±è´¥: {str(e)}")
            return jsonify({
                'code': 500,
                'message': 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
                'data': None
            }), 500
```

#### 2.2 å¤§å±å®æ—¶æ•°æ®æ¥å£
```python
class BigScreenMessageService:
    """å¤§å±æ¶ˆæ¯æœåŠ¡"""
    
    @staticmethod
    @app.route('/api/bigscreen/messages/realtime', methods=['GET'])
    def get_realtime_messages():
        """å¤§å±å®æ—¶æ¶ˆæ¯æ•°æ®æ¥å£"""
        try:
            customer_id = request.args.get('customer_id')
            department_ids = request.args.getlist('department_ids[]')  # æ”¯æŒå¤šéƒ¨é—¨
            
            if not customer_id:
                return jsonify({
                    'code': 400,
                    'message': 'ç¼ºå°‘ç§Ÿæˆ·ID',
                    'data': None
                }), 400
            
            # è·å–å®æ—¶æ¶ˆæ¯æ•°æ®
            realtime_data = BigScreenMessageService._get_realtime_message_data(
                customer_id, department_ids
            )
            
            return jsonify({
                'code': 200,
                'message': 'æŸ¥è¯¢æˆåŠŸ',
                'data': realtime_data
            })
            
        except Exception as e:
            logger.error(f"å¤§å±å®æ—¶æ•°æ®æŸ¥è¯¢å¤±è´¥: {str(e)}")
            return jsonify({
                'code': 500,
                'message': 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
                'data': None
            }), 500
    
    @staticmethod
    def _get_realtime_message_data(customer_id, department_ids):
        """è·å–å®æ—¶æ¶ˆæ¯æ•°æ®"""
        
        # æ„å»ºéƒ¨é—¨è¿‡æ»¤æ¡ä»¶
        dept_filter = ""
        params = [customer_id]
        
        if department_ids:
            placeholders = ','.join(['%s'] * len(department_ids))
            dept_filter = f"AND m.department_id IN ({placeholders})"
            params.extend(department_ids)
        
        # å®æ—¶æ¶ˆæ¯ç»Ÿè®¡æŸ¥è¯¢
        query = f"""
        SELECT 
            -- åŸºç¡€ç»Ÿè®¡
            COUNT(*) as total_messages,
            COUNT(CASE WHEN m.message_status = 'pending' THEN 1 END) as pending_count,
            COUNT(CASE WHEN m.message_status = 'delivered' THEN 1 END) as delivered_count,
            COUNT(CASE WHEN m.message_status = 'acknowledged' THEN 1 END) as acknowledged_count,
            COUNT(CASE WHEN m.message_status = 'expired' THEN 1 END) as expired_count,
            
            -- ä¼˜å…ˆçº§åˆ†å¸ƒ
            COUNT(CASE WHEN m.priority_level = 1 THEN 1 END) as critical_count,
            COUNT(CASE WHEN m.priority_level = 2 THEN 1 END) as high_count,
            COUNT(CASE WHEN m.priority_level = 3 THEN 1 END) as medium_count,
            COUNT(CASE WHEN m.priority_level = 4 THEN 1 END) as low_count,
            
            -- ç±»å‹åˆ†å¸ƒ
            COUNT(CASE WHEN m.message_type LIKE 'alert_%' THEN 1 END) as alert_count,
            COUNT(CASE WHEN m.message_type = 'announcement' THEN 1 END) as announcement_count,
            COUNT(CASE WHEN m.message_type LIKE 'task_%' THEN 1 END) as task_count,
            COUNT(CASE WHEN m.message_type LIKE 'guidance_%' THEN 1 END) as guidance_count,
            
            -- å“åº”ç‡ç»Ÿè®¡
            ROUND(
                COUNT(CASE WHEN m.message_status = 'acknowledged' THEN 1 END) * 100.0 / 
                NULLIF(COUNT(*), 0), 2
            ) as overall_response_rate,
            
            -- å¹³å‡å“åº”æ—¶é—´
            AVG(
                CASE 
                    WHEN d.response_time IS NOT NULL THEN 
                        TIMESTAMPDIFF(SECOND, m.sent_time, d.response_time)
                    ELSE NULL 
                END
            ) as avg_response_seconds
            
        FROM t_device_message_v2 m
        LEFT JOIN t_device_message_detail_v2 d ON m.id = d.message_id AND d.is_deleted = 0
        WHERE m.customer_id = %s
          AND m.create_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
          AND m.is_deleted = 0
          {dept_filter}
        """
        
        cursor = db.connection.cursor()
        cursor.execute(query, params)
        stats_result = cursor.fetchone()
        
        # è·å–æœ€æ–°ç´§æ€¥æ¶ˆæ¯åˆ—è¡¨
        recent_critical_messages = BigScreenMessageService._get_recent_critical_messages(
            customer_id, department_ids
        )
        
        # è·å–å“åº”æ—¶é—´è¶‹åŠ¿
        response_time_trend = BigScreenMessageService._get_response_time_trend(
            customer_id, department_ids
        )
        
        return {
            'statistics': {
                'total_messages': stats_result[0] or 0,
                'pending_count': stats_result[1] or 0,
                'delivered_count': stats_result[2] or 0,
                'acknowledged_count': stats_result[3] or 0,
                'expired_count': stats_result[4] or 0,
                'priority_distribution': {
                    'critical': stats_result[5] or 0,
                    'high': stats_result[6] or 0,
                    'medium': stats_result[7] or 0,
                    'low': stats_result[8] or 0
                },
                'type_distribution': {
                    'alerts': stats_result[9] or 0,
                    'announcements': stats_result[10] or 0,
                    'tasks': stats_result[11] or 0,
                    'guidance': stats_result[12] or 0
                },
                'overall_response_rate': stats_result[13] or 0,
                'avg_response_seconds': round(stats_result[14] or 0, 2)
            },
            'recent_critical_messages': recent_critical_messages,
            'response_time_trend': response_time_trend,
            'update_time': datetime.now().isoformat()
        }

    @staticmethod
    @socketio.on('subscribe_message_updates')
    def handle_subscribe_message_updates(data):
        """WebSocketè®¢é˜…æ¶ˆæ¯æ›´æ–°"""
        customer_id = data.get('customer_id')
        department_ids = data.get('department_ids', [])
        client_type = data.get('client_type', 'unknown')  # admin/bigscreen/mobile/watch
        
        # åŠ å…¥å¯¹åº”çš„æˆ¿é—´
        room_name = f"messages_customer_{customer_id}"
        join_room(room_name)
        
        # å‘é€å½“å‰çŠ¶æ€
        current_data = BigScreenMessageService._get_realtime_message_data(
            customer_id, department_ids
        )
        emit('message_data_update', current_data)
        
        logger.info(f"å®¢æˆ·ç«¯ {client_type} è®¢é˜…æ¶ˆæ¯æ›´æ–°: customer_id={customer_id}")

    @staticmethod
    @app.route('/api/device/messages/batch-read', methods=['POST'])
    def batch_mark_messages_read():
        """æ‰¹é‡æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯» - æ‰‹æœºç«¯æ‰¹é‡æ“ä½œ"""
        try:
            data = request.get_json()
            message_ids = data.get('message_ids', [])
            user_id = data.get('user_id')
            customer_id = data.get('customer_id')
            device_sn = data.get('device_sn')
            
            if not all([message_ids, user_id, customer_id]):
                return jsonify({
                    'code': 400,
                    'message': 'ç¼ºå°‘å¿…è¦å‚æ•°',
                    'data': None
                }), 400
            
            # æ‰¹é‡æ›´æ–°æ¶ˆæ¯çŠ¶æ€
            success_count = DeviceMessageService._batch_update_message_status(
                message_ids, user_id, customer_id, 'read'
            )
            
            # WebSocketé€šçŸ¥æ›´æ–°
            socketio.emit('batch_message_read', {
                'user_id': user_id,
                'message_ids': message_ids,
                'read_count': success_count,
                'timestamp': datetime.now().isoformat()
            }, room=f"messages_customer_{customer_id}")
            
            return jsonify({
                'code': 200,
                'message': f'æˆåŠŸæ ‡è®° {success_count} æ¡æ¶ˆæ¯ä¸ºå·²è¯»',
                'data': {
                    'success_count': success_count,
                    'total_requested': len(message_ids)
                }
            })
            
        except Exception as e:
            logger.error(f"æ‰¹é‡æ ‡è®°æ¶ˆæ¯å·²è¯»å¤±è´¥: {str(e)}")
            return jsonify({
                'code': 500,
                'message': 'æ“ä½œå¤±è´¥',
                'data': None
            }), 500
```

---

## ğŸ“± å‰ç«¯ç•Œé¢ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ljwx-admin æ¶ˆæ¯ç®¡ç†ç•Œé¢ä¼˜åŒ–

#### 1.1 device/message/index.vue ä¼˜åŒ–
```vue
<template>
  <div class="message-management-v2">
    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="statistics-panel">
      <n-grid :cols="5" :x-gap="16">
        <n-grid-item>
          <n-statistic label="æ€»æ¶ˆæ¯æ•°" :value="statistics.totalMessages">
            <template #suffix>æ¡</template>
          </n-statistic>
        </n-grid-item>
        <n-grid-item>
          <n-statistic label="å¾…å“åº”" :value="statistics.pendingCount" class="pending">
            <template #suffix>æ¡</template>
          </n-statistic>
        </n-grid-item>
        <n-grid-item>
          <n-statistic label="å·²å“åº”" :value="statistics.acknowledgedCount" class="acknowledged">
            <template #suffix>æ¡</template>
          </n-statistic>
        </n-grid-item>
        <n-grid-item>
          <n-statistic label="å“åº”ç‡" :value="statistics.responseRate" suffix="%" class="rate" />
        </n-grid-item>
        <n-grid-item>
          <n-statistic 
            label="å¹³å‡å“åº”æ—¶é—´" 
            :value="Math.round(statistics.avgResponseSeconds / 60)" 
            suffix="åˆ†é’Ÿ" 
            class="time" />
        </n-grid-item>
      </n-grid>
    </div>

    <!-- é«˜çº§ç­›é€‰å™¨ -->
    <div class="advanced-filters">
      <n-space>
        <n-select
          v-model:value="filters.messageType"
          placeholder="æ¶ˆæ¯ç±»å‹"
          :options="messageTypeOptions"
          clearable
          style="width: 150px"
        />
        <n-select
          v-model:value="filters.messageScope"
          placeholder="å‘é€èŒƒå›´"
          :options="messageScopeOptions"
          clearable
          style="width: 150px"
        />
        <n-select
          v-model:value="filters.priorityLevel"
          placeholder="ä¼˜å…ˆçº§"
          :options="priorityLevelOptions"
          clearable
          style="width: 120px"
        />
        <n-select
          v-model:value="filters.messageStatus"
          placeholder="æ¶ˆæ¯çŠ¶æ€"
          :options="messageStatusOptions"
          clearable
          style="width: 150px"
        />
        <n-date-picker
          v-model:value="filters.timeRange"
          type="datetimerange"
          placeholder="æ—¶é—´èŒƒå›´"
          clearable
        />
        <n-button type="primary" @click="handleSearch">
          <template #icon><SearchIcon /></template>
          æŸ¥è¯¢
        </n-button>
        <n-button @click="handleResetFilters">é‡ç½®</n-button>
      </n-space>
    </div>

    <!-- æ¶ˆæ¯åˆ—è¡¨è¡¨æ ¼ -->
    <n-data-table
      :columns="tableColumns"
      :data="messageList"
      :pagination="pagination"
      :loading="loading"
      :row-key="(row) => row.id"
      size="small"
      striped
      @update:page="handlePageChange"
      @update:page-size="handlePageSizeChange"
    >
      <!-- æ¶ˆæ¯ç±»å‹åˆ— -->
      <template #messageType="{ row }">
        <n-tag 
          :type="getMessageTypeTagType(row.messageType)"
          :color="getMessageTypeColor(row.messageType)"
        >
          {{ getMessageTypeLabel(row.messageType) }}
        </n-tag>
      </template>

      <!-- ä¼˜å…ˆçº§åˆ— -->
      <template #priority="{ row }">
        <n-tag 
          :type="getPriorityTagType(row.priorityLevel)"
          :color="getPriorityColor(row.priorityLevel)"
        >
          {{ getPriorityLabel(row.priorityLevel) }}
        </n-tag>
      </template>

      <!-- å“åº”çŠ¶æ€åˆ— -->
      <template #responseStatus="{ row }">
        <div class="response-status-cell">
          <n-progress 
            type="line" 
            :percentage="row.responseRate" 
            :color="getResponseProgressColor(row.responseRate)"
            :show-indicator="false"
            style="width: 100px"
          />
          <span class="response-text">
            {{ row.acknowledgedCount }}/{{ row.targetUserCount }}
          </span>
          
          <!-- æœªå“åº”ç”¨æˆ·æç¤º -->
          <n-popover v-if="row.unrespondedCount > 0" trigger="hover" placement="top">
            <template #trigger>
              <n-tag type="warning" size="small" class="unresponded-tag">
                {{ row.unrespondedCount }}æœªå“åº”
              </n-tag>
            </template>
            <template #default>
              <div class="unresponded-users-popup">
                <h4>æœªå“åº”ç”¨æˆ·åˆ—è¡¨</h4>
                <div v-for="user in row.unrespondedUsers" :key="user.userId" class="user-item">
                  <span class="user-name">{{ user.userName }}</span>
                  <span class="department">{{ user.departmentName }}</span>
                  <span class="elapsed-time">{{ formatElapsedTime(user.elapsedSeconds) }}</span>
                </div>
                <n-button size="small" type="primary" @click="handleViewDetails(row.id)">
                  æŸ¥çœ‹è¯¦æƒ…
                </n-button>
              </div>
            </template>
          </n-popover>
        </div>
      </template>

      <!-- å“åº”æ—¶é—´åˆ— -->
      <template #responseTime="{ row }">
        <div class="response-time-cell">
          <span 
            :class="['response-time', getResponseTimeClass(row.avgResponseSeconds)]"
          >
            {{ formatResponseTime(row.avgResponseSeconds) }}
          </span>
          
          <!-- SLAæŒ‡ç¤ºå™¨ -->
          <n-tag 
            v-if="row.slaStatus"
            :type="row.slaStatus === 'met' ? 'success' : 'error'"
            size="small"
          >
            {{ row.slaStatus === 'met' ? 'SLAè¾¾æ ‡' : 'SLAè¶…æ—¶' }}
          </n-tag>
        </div>
      </template>

      <!-- æ“ä½œåˆ— -->
      <template #action="{ row }">
        <n-space>
          <n-button size="small" @click="handleViewDetails(row.id)">è¯¦æƒ…</n-button>
          <n-button 
            v-if="row.messageStatus === 'pending'"
            size="small" 
            type="warning" 
            @click="handleResendMessage(row.id)"
          >
            é‡å‘
          </n-button>
          <n-button 
            v-if="['pending', 'delivered'].includes(row.messageStatus)"
            size="small" 
            type="error" 
            @click="handleCancelMessage(row.id)"
          >
            å–æ¶ˆ
          </n-button>
        </n-space>
      </template>
    </n-data-table>

    <!-- æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰ -->
    <MessageDetailDrawer
      v-model:visible="detailDrawerVisible"
      :message-id="selectedMessageId"
      @refresh="handleRefreshList"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import { useMessage } from 'naive-ui'
import { 
  fetchGetMessagePageV2, 
  fetchGetMessageStatistics,
  fetchResendMessage,
  fetchCancelMessage 
} from '@/service/api/health/device-message-v2'

// å“åº”å¼æ•°æ®
const loading = ref(false)
const messageList = ref<MessageListVO[]>([])
const statistics = ref<MessageStatisticsVO>({})
const selectedMessageId = ref<number>()
const detailDrawerVisible = ref(false)

// ç­›é€‰æ¡ä»¶
const filters = ref({
  messageType: null,
  messageScope: null,
  priorityLevel: null,
  messageStatus: null,
  timeRange: null
})

// åˆ†é¡µé…ç½®
const pagination = ref({
  page: 1,
  pageSize: 20,
  totalCount: 0,
  showSizePicker: true,
  pageSizes: [10, 20, 50, 100]
})

// è¡¨æ ¼åˆ—å®šä¹‰
const tableColumns = computed(() => [
  {
    title: 'åºå·',
    key: 'index',
    width: 60,
    render: (_, index) => index + 1
  },
  {
    title: 'æ¶ˆæ¯å†…å®¹',
    key: 'message',
    width: 200,
    ellipsis: true,
    tooltip: true
  },
  {
    title: 'ç±»å‹',
    key: 'messageType',
    width: 120,
    render: (row) => h('template', { messageType: row })
  },
  {
    title: 'èŒƒå›´',
    key: 'messageScope',
    width: 100,
    render: (row) => getMessageScopeLabel(row.messageScope)
  },
  {
    title: 'ä¼˜å…ˆçº§',
    key: 'priority',
    width: 80,
    render: (row) => h('template', { priority: row })
  },
  {
    title: 'å“åº”çŠ¶æ€',
    key: 'responseStatus',
    width: 180,
    render: (row) => h('template', { responseStatus: row })
  },
  {
    title: 'å“åº”æ—¶é—´',
    key: 'responseTime',
    width: 150,
    render: (row) => h('template', { responseTime: row })
  },
  {
    title: 'å‘é€æ—¶é—´',
    key: 'sentTime',
    width: 160,
    render: (row) => formatDateTime(row.sentTime)
  },
  {
    title: 'åˆ›å»ºè€…',
    key: 'creatorName',
    width: 100
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
    width: 150,
    fixed: 'right',
    render: (row) => h('template', { action: row })
  }
])

// è·å–æ¶ˆæ¯åˆ—è¡¨
const getMessageList = async () => {
  try {
    loading.value = true
    
    const queryParams = {
      page: pagination.value.page,
      pageSize: pagination.value.pageSize,
      customerId: userStore.userInfo.customerId,
      ...filters.value,
      startTime: filters.value.timeRange?.[0],
      endTime: filters.value.timeRange?.[1]
    }
    
    const [listResult, statsResult] = await Promise.all([
      fetchGetMessagePageV2(queryParams),
      fetchGetMessageStatistics(queryParams)
    ])
    
    if (listResult.code === 200) {
      messageList.value = listResult.data.records
      pagination.value.totalCount = listResult.data.total
    }
    
    if (statsResult.code === 200) {
      statistics.value = statsResult.data
    }
    
  } catch (error) {
    message.error('æŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨å¤±è´¥')
    console.error('æ¶ˆæ¯åˆ—è¡¨æŸ¥è¯¢é”™è¯¯:', error)
  } finally {
    loading.value = false
  }
}

// æŸ¥çœ‹æ¶ˆæ¯è¯¦æƒ…
const handleViewDetails = (messageId: number) => {
  selectedMessageId.value = messageId
  detailDrawerVisible.value = true
}

// é‡å‘æ¶ˆæ¯
const handleResendMessage = async (messageId: number) => {
  try {
    const result = await fetchResendMessage({ 
      messageId, 
      customerId: userStore.userInfo.customerId 
    })
    
    if (result.code === 200) {
      message.success('æ¶ˆæ¯é‡å‘æˆåŠŸ')
      await getMessageList()
    } else {
      message.error(result.message || 'é‡å‘å¤±è´¥')
    }
  } catch (error) {
    message.error('é‡å‘æ“ä½œå¤±è´¥')
    console.error('æ¶ˆæ¯é‡å‘é”™è¯¯:', error)
  }
}

// å·¥å…·å‡½æ•°
const getMessageTypeLabel = (type: string) => {
  const labels = {
    'alert_sos': 'SOSç´§æ€¥',
    'alert_fall': 'è·Œå€’æ£€æµ‹', 
    'alert_health': 'å¥åº·å¼‚å¸¸',
    'alert_device': 'è®¾å¤‡å¼‚å¸¸',
    'announcement': 'ç³»ç»Ÿå…¬å‘Š',
    'notification': 'ä¸€èˆ¬é€šçŸ¥',
    'task_assignment': 'ä»»åŠ¡åˆ†é…',
    'task_reminder': 'ä»»åŠ¡æé†’',
    'guidance_health': 'å¥åº·æŒ‡å¼•',
    'guidance_device': 'è®¾å¤‡æŒ‡å¼•'
  }
  return labels[type] || type
}

const formatResponseTime = (seconds: number) => {
  if (!seconds) return '-'
  
  if (seconds < 60) return `${seconds}ç§’`
  if (seconds < 3600) return `${Math.round(seconds / 60)}åˆ†é’Ÿ`
  return `${Math.round(seconds / 3600)}å°æ—¶`
}

const formatElapsedTime = (seconds: number) => {
  const minutes = Math.floor(seconds / 60)
  const hours = Math.floor(minutes / 60)
  
  if (hours > 0) return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿå‰`
  if (minutes > 0) return `${minutes}åˆ†é’Ÿå‰`
  return `${seconds}ç§’å‰`
}

// åˆå§‹åŒ–å’Œç›‘å¬
onMounted(() => {
  getMessageList()
  
  // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
  setInterval(getMessageList, 30000)
})
</script>
```

### 2. å¤§å±æ¶ˆæ¯å±•ç¤ºä¼˜åŒ–

#### 2.1 message_view.html ä¼˜åŒ–
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¶ˆæ¯ç›‘æ§å¤§å±</title>
    <style>
        .message-dashboard {
            display: grid;
            grid-template-areas: 
                "stats stats stats"
                "critical-alerts recent-messages response-trend";
            grid-template-rows: 200px 1fr;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        .stats-panel {
            grid-area: stats;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .critical-alerts {
            grid-area: critical-alerts;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .recent-messages {
            grid-area: recent-messages;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .response-trend {
            grid-area: response-trend;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .message-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .message-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .priority-indicator {
            width: 8px;
            height: 40px;
            border-radius: 4px;
            margin-right: 15px;
        }
        
        .priority-critical { background: #ff4757; }
        .priority-high { background: #ff7675; }
        .priority-medium { background: #fdcb6e; }
        .priority-low { background: #6c5ce7; }
        
        .message-content {
            flex: 1;
            color: white;
        }
        
        .message-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .message-meta {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .response-indicator {
            text-align: right;
            color: white;
        }
        
        .response-rate {
            font-size: 18px;
            font-weight: bold;
        }
        
        .response-count {
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="message-dashboard" id="messageDashboard">
        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
            <div class="stat-card">
                <h3>æ€»æ¶ˆæ¯æ•°</h3>
                <div class="stat-value" id="totalMessages">0</div>
            </div>
            <div class="stat-card">
                <h3>å¾…å“åº”</h3>
                <div class="stat-value" id="pendingMessages">0</div>
            </div>
            <div class="stat-card">
                <h3>å·²å“åº”</h3>
                <div class="stat-value" id="acknowledgedMessages">0</div>
            </div>
            <div class="stat-card">
                <h3>å“åº”ç‡</h3>
                <div class="stat-value" id="responseRate">0%</div>
            </div>
            <div class="stat-card">
                <h3>å¹³å‡å“åº”æ—¶é—´</h3>
                <div class="stat-value" id="avgResponseTime">0åˆ†é’Ÿ</div>
            </div>
        </div>

        <!-- ç´§æ€¥å‘Šè­¦é¢æ¿ -->
        <div class="critical-alerts">
            <h3 style="color: white; margin-bottom: 20px;">
                ğŸš¨ ç´§æ€¥å‘Šè­¦æ¶ˆæ¯
            </h3>
            <div id="criticalAlertsList"></div>
        </div>

        <!-- æœ€æ–°æ¶ˆæ¯é¢æ¿ -->
        <div class="recent-messages">
            <h3 style="color: white; margin-bottom: 20px;">
                ğŸ“¨ æœ€æ–°æ¶ˆæ¯
            </h3>
            <div id="recentMessagesList"></div>
        </div>

        <!-- å“åº”è¶‹åŠ¿å›¾ -->
        <div class="response-trend">
            <h3 style="color: white; margin-bottom: 20px;">
                ğŸ“ˆ å“åº”æ—¶é—´è¶‹åŠ¿
            </h3>
            <canvas id="responseTrendChart" width="400" height="300"></canvas>
        </div>
    </div>

    <script src="/static/js/socket.io.min.js"></script>
    <script src="/static/js/chart.min.js"></script>
    <script>
        class MessageDashboard {
            constructor() {
                this.socket = io('/admin');
                this.chart = null;
                this.customerId = this.getCustomerId();
                this.departmentIds = this.getDepartmentIds();
                
                this.initWebSocket();
                this.initChart();
                this.startPolling();
            }
            
            initWebSocket() {
                // è®¢é˜…æ¶ˆæ¯æ›´æ–°
                this.socket.emit('subscribe_message_updates', {
                    customer_id: this.customerId,
                    department_ids: this.departmentIds,
                    client_type: 'bigscreen'
                });
                
                // ç›‘å¬å®æ—¶æ•°æ®æ›´æ–°
                this.socket.on('message_data_update', (data) => {
                    this.updateDashboard(data);
                });
                
                // ç›‘å¬æ¶ˆæ¯å“åº”æ›´æ–°
                this.socket.on('message_response_update', (data) => {
                    this.handleMessageResponse(data);
                });
                
                // ç›‘å¬æ‰¹é‡æ¶ˆæ¯å·²è¯»
                this.socket.on('batch_message_read', (data) => {
                    this.handleBatchMessageRead(data);
                });
            }
            
            async startPolling() {
                // åˆå§‹æ•°æ®åŠ è½½
                await this.loadInitialData();
                
                // æ¯10ç§’è½®è¯¢æ›´æ–°
                setInterval(() => {
                    this.loadRealtimeData();
                }, 10000);
            }
            
            async loadRealtimeData() {
                try {
                    const response = await fetch(
                        `/api/bigscreen/messages/realtime?customer_id=${this.customerId}&${this.departmentIds.map(id => `department_ids[]=${id}`).join('&')}`
                    );
                    const result = await response.json();
                    
                    if (result.code === 200) {
                        this.updateDashboard(result.data);
                    }
                } catch (error) {
                    console.error('åŠ è½½å®æ—¶æ•°æ®å¤±è´¥:', error);
                }
            }
            
            updateDashboard(data) {
                // æ›´æ–°ç»Ÿè®¡é¢æ¿
                document.getElementById('totalMessages').textContent = data.statistics.total_messages;
                document.getElementById('pendingMessages').textContent = data.statistics.pending_count;
                document.getElementById('acknowledgedMessages').textContent = data.statistics.acknowledged_count;
                document.getElementById('responseRate').textContent = `${data.statistics.overall_response_rate}%`;
                document.getElementById('avgResponseTime').textContent = `${Math.round(data.statistics.avg_response_seconds / 60)}åˆ†é’Ÿ`;
                
                // æ›´æ–°ç´§æ€¥å‘Šè­¦åˆ—è¡¨
                this.updateCriticalAlerts(data.recent_critical_messages);
                
                // æ›´æ–°æœ€æ–°æ¶ˆæ¯åˆ—è¡¨
                this.updateRecentMessages(data.recent_messages);
                
                // æ›´æ–°å“åº”è¶‹åŠ¿å›¾
                this.updateResponseTrendChart(data.response_time_trend);
            }
            
            updateCriticalAlerts(criticalMessages) {
                const container = document.getElementById('criticalAlertsList');
                container.innerHTML = '';
                
                criticalMessages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message-item';
                    messageElement.innerHTML = `
                        <div class="priority-indicator priority-critical"></div>
                        <div class="message-content">
                            <div class="message-title">${message.content}</div>
                            <div class="message-meta">
                                ${message.user_name} | ${message.device_sn} | ${this.formatTime(message.sent_time)}
                            </div>
                        </div>
                        <div class="response-indicator">
                            <div class="response-rate">${message.response_rate}%</div>
                            <div class="response-count">${message.acknowledged_count}/${message.target_user_count}</div>
                        </div>
                    `;
                    container.appendChild(messageElement);
                });
            }
            
            formatTime(timeString) {
                if (!timeString) return '-';
                const date = new Date(timeString);
                return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
            
            getCustomerId() {
                // ä»URLå‚æ•°æˆ–localStorageè·å–
                return new URLSearchParams(window.location.search).get('customerId') || '1';
            }
            
            getDepartmentIds() {
                // ä»URLå‚æ•°è·å–
                const params = new URLSearchParams(window.location.search);
                const deptIds = params.getAll('departmentIds[]');
                return deptIds.length > 0 ? deptIds : [];
            }
        }
        
        // åˆå§‹åŒ–ä»ªè¡¨æ¿
        document.addEventListener('DOMContentLoaded', () => {
            new MessageDashboard();
        });
    </script>
</body>
</html>
```

---

## ğŸ’» æ ¸å¿ƒServiceå®ç°

### 1. Javaåç«¯Serviceå®ç°

#### 1.1 DeviceMessageV2Service
```java
@Service
@Slf4j
public class DeviceMessageV2Service {
    
    @Autowired
    private DeviceMessageV2Mapper messageMapper;
    
    @Autowired
    private DeviceMessageDetailV2Mapper detailMapper;
    
    @Autowired
    private SysOrgClosureService orgClosureService;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨
     */
    public PageResult<MessageListVO> getMessagePage(MessageQueryDTO queryDTO) {
        try {
            // å‚æ•°éªŒè¯
            validateQueryParams(queryDTO);
            
            // åˆ†é¡µæŸ¥è¯¢
            Page<MessageListDO> page = PageHelper.startPage(queryDTO.getPage(), queryDTO.getPageSize());
            List<MessageListDO> messages = messageMapper.selectMessagePage(queryDTO);
            
            // æ•°æ®è½¬æ¢
            List<MessageListVO> messageVOs = messages.stream()
                .map(this::convertToMessageListVO)
                .collect(Collectors.toList());
            
            // æ‰¹é‡æŸ¥è¯¢æœªå“åº”ç”¨æˆ· (æ€§èƒ½ä¼˜åŒ–)
            if (!messageVOs.isEmpty()) {
                List<Long> messageIds = messageVOs.stream()
                    .map(MessageListVO::getId)
                    .collect(Collectors.toList());
                
                Map<Long, List<UnrespondedUserVO>> unrespondedUsersMap = 
                    this.batchGetUnrespondedUsers(messageIds, queryDTO.getCustomerId());
                
                // å…³è”æœªå“åº”ç”¨æˆ·æ•°æ®
                messageVOs.forEach(vo -> {
                    List<UnrespondedUserVO> unrespondedUsers = unrespondedUsersMap.get(vo.getId());
                    vo.setUnrespondedUsers(unrespondedUsers);
                    vo.setUnrespondedCount(unrespondedUsers != null ? unrespondedUsers.size() : 0);
                });
            }
            
            return new PageResult<>(messageVOs, page.getTotal(), page.getPageNum(), page.getPageSize());
            
        } catch (Exception e) {
            log.error("åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨å¤±è´¥", e);
            throw new BusinessException("æŸ¥è¯¢æ¶ˆæ¯åˆ—è¡¨å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æŸ¥è¯¢æ¶ˆæ¯å“åº”çŠ¶æ€è¯¦æƒ…
     */
    public MessageResponseStatusVO getMessageResponseStatus(Long messageId, Long customerId) {
        try {
            // æŸ¥è¯¢ä¸»æ¶ˆæ¯ä¿¡æ¯
            MessageResponseStatusDO messageStatus = messageMapper.selectMessageResponseStatus(messageId, customerId);
            if (messageStatus == null) {
                throw new BusinessException("æ¶ˆæ¯ä¸å­˜åœ¨");
            }
            
            // æŸ¥è¯¢è¯¦ç»†å“åº”åˆ—è¡¨
            List<MessageResponseDetailDO> responseDetails = detailMapper.selectResponseDetails(messageId);
            
            // è®¡ç®—å“åº”ç»Ÿè®¡
            MessageResponseStatistics statistics = calculateResponseStatistics(responseDetails);
            
            // æ„å»ºè¿”å›å¯¹è±¡
            MessageResponseStatusVO statusVO = new MessageResponseStatusVO();
            statusVO.setMessageId(messageId);
            statusVO.setMessageContent(messageStatus.getMessage());
            statusVO.setMessageType(messageStatus.getMessageType());
            statusVO.setPriorityLevel(messageStatus.getPriorityLevel());
            statusVO.setSentTime(messageStatus.getSentTime());
            statusVO.setTargetUserCount(messageStatus.getTargetUserCount());
            statusVO.setAcknowledgedCount(messageStatus.getAcknowledgedCount());
            statusVO.setResponseRate(statistics.getResponseRate());
            statusVO.setAvgResponseSeconds(statistics.getAvgResponseSeconds());
            statusVO.setResponseDetails(convertToResponseDetailVOs(responseDetails));
            
            return statusVO;
            
        } catch (Exception e) {
            log.error("æŸ¥è¯¢æ¶ˆæ¯å“åº”çŠ¶æ€å¤±è´¥: messageId={}, customerId={}", messageId, customerId, e);
            throw new BusinessException("æŸ¥è¯¢å“åº”çŠ¶æ€å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æ‰¹é‡è·å–æœªå“åº”ç”¨æˆ· - æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬
     */
    private Map<Long, List<UnrespondedUserVO>> batchGetUnrespondedUsers(List<Long> messageIds, Long customerId) {
        if (messageIds.isEmpty()) {
            return Collections.emptyMap();
        }
        
        // æ‰¹é‡æŸ¥è¯¢ - å•æ¬¡SQLæŸ¥è¯¢
        List<UnrespondedUserDO> unrespondedUsers = detailMapper.batchSelectUnrespondedUsers(messageIds, customerId);
        
        // æŒ‰æ¶ˆæ¯IDåˆ†ç»„
        return unrespondedUsers.stream()
            .collect(Collectors.groupingBy(
                UnrespondedUserDO::getMessageId,
                Collectors.mapping(this::convertToUnrespondedUserVO, Collectors.toList())
            ));
    }
    
    /**
     * è·å–å“åº”æ—¶é—´ç»Ÿè®¡
     */
    public MessageResponseTimeStatisticsVO getResponseTimeStatistics(ResponseTimeQueryDTO queryDTO) {
        try {
            // æŸ¥è¯¢å“åº”æ—¶é—´ç»Ÿè®¡æ•°æ®
            List<ResponseTimeStatisticsDO> statistics = messageMapper.selectResponseTimeStatistics(queryDTO);
            
            // æ•°æ®èšåˆå’Œè®¡ç®—
            MessageResponseTimeStatisticsVO result = new MessageResponseTimeStatisticsVO();
            
            // æŒ‰æ¶ˆæ¯ç±»å‹ç»Ÿè®¡
            Map<String, ResponseTimeStatsVO> typeStats = statistics.stream()
                .collect(Collectors.groupingBy(
                    ResponseTimeStatisticsDO::getMessageType,
                    Collectors.collectingAndThen(
                        Collectors.toList(),
                        this::aggregateResponseTimeStats
                    )
                ));
            result.setTypeStatistics(typeStats);
            
            // æŒ‰ä¼˜å…ˆçº§ç»Ÿè®¡
            Map<Integer, ResponseTimeStatsVO> priorityStats = statistics.stream()
                .collect(Collectors.groupingBy(
                    ResponseTimeStatisticsDO::getPriorityLevel,
                    Collectors.collectingAndThen(
                        Collectors.toList(),
                        this::aggregateResponseTimeStats
                    )
                ));
            result.setPriorityStatistics(priorityStats);
            
            // æŒ‰éƒ¨é—¨ç»Ÿè®¡
            Map<String, ResponseTimeStatsVO> deptStats = statistics.stream()
                .collect(Collectors.groupingBy(
                    ResponseTimeStatisticsDO::getDepartmentName,
                    Collectors.collectingAndThen(
                        Collectors.toList(),
                        this::aggregateResponseTimeStats
                    )
                ));
            result.setDepartmentStatistics(deptStats);
            
            // æ•´ä½“ç»Ÿè®¡
            ResponseTimeStatsVO overallStats = aggregateResponseTimeStats(statistics);
            result.setOverallStatistics(overallStats);
            
            return result;
            
        } catch (Exception e) {
            log.error("è·å–å“åº”æ—¶é—´ç»Ÿè®¡å¤±è´¥", e);
            throw new BusinessException("å“åº”æ—¶é—´ç»Ÿè®¡æŸ¥è¯¢å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * åˆ›å»ºæ–°æ¶ˆæ¯
     */
    @Transactional(rollbackFor = Exception.class)
    public Long createMessage(CreateMessageDTO createDTO) {
        try {
            // 1. åˆ›å»ºä¸»æ¶ˆæ¯è®°å½•
            DeviceMessageV2DO mainMessage = buildMainMessage(createDTO);
            messageMapper.insert(mainMessage);
            Long messageId = mainMessage.getId();
            
            // 2. æ„å»ºæ¥æ”¶ç”¨æˆ·åˆ—è¡¨
            List<MessageRecipientInfo> recipients = buildRecipientList(createDTO);
            
            // 3. æ‰¹é‡åˆ›å»ºæ¶ˆæ¯è¯¦æƒ…è®°å½•
            if (!recipients.isEmpty()) {
                List<DeviceMessageDetailV2DO> details = recipients.stream()
                    .map(recipient -> buildMessageDetail(messageId, recipient, createDTO))
                    .collect(Collectors.toList());
                
                detailMapper.batchInsert(details);
                
                // æ›´æ–°ä¸»æ¶ˆæ¯çš„ç›®æ ‡ç”¨æˆ·æ•°
                messageMapper.updateTargetUserCount(messageId, recipients.size());
            }
            
            // 4. å‘é€å®æ—¶é€šçŸ¥
            this.sendRealtimeNotification(messageId, createDTO);
            
            log.info("åˆ›å»ºæ¶ˆæ¯æˆåŠŸ: messageId={}, targetUsers={}", messageId, recipients.size());
            return messageId;
            
        } catch (Exception e) {
            log.error("åˆ›å»ºæ¶ˆæ¯å¤±è´¥", e);
            throw new BusinessException("åˆ›å»ºæ¶ˆæ¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æ„å»ºæ¥æ”¶ç”¨æˆ·åˆ—è¡¨ - åŸºäºé—­åŒ…è¡¨ä¼˜åŒ–
     */
    private List<MessageRecipientInfo> buildRecipientList(CreateMessageDTO createDTO) {
        List<MessageRecipientInfo> recipients = new ArrayList<>();
        
        switch (createDTO.getMessageScope()) {
            case "individual":
                // ä¸ªäººæ¶ˆæ¯
                if (createDTO.getTargetUserIds() != null) {
                    recipients = createDTO.getTargetUserIds().stream()
                        .map(userId -> new MessageRecipientInfo(userId, "user"))
                        .collect(Collectors.toList());
                }
                break;
                
            case "department":
                // éƒ¨é—¨æ¶ˆæ¯ - åˆ©ç”¨é—­åŒ…è¡¨æŸ¥è¯¢
                if (createDTO.getTargetDepartmentIds() != null) {
                    for (Long deptId : createDTO.getTargetDepartmentIds()) {
                        List<SysUserInfo> deptUsers = orgClosureService.getDepartmentUsers(
                            deptId, createDTO.getCustomerId()
                        );
                        recipients.addAll(deptUsers.stream()
                            .map(user -> new MessageRecipientInfo(user.getId(), "department"))
                            .collect(Collectors.toList()));
                    }
                }
                break;
                
            case "organization":
                // ç»„ç»‡æ¶ˆæ¯ - åŸºäºé—­åŒ…è¡¨çš„ç»„ç»‡ç”¨æˆ·æŸ¥è¯¢
                List<SysUserInfo> orgUsers = orgClosureService.getOrganizationUsers(
                    createDTO.getCustomerId()
                );
                recipients = orgUsers.stream()
                    .map(user -> new MessageRecipientInfo(user.getId(), "organization"))
                    .collect(Collectors.toList());
                break;
                
            case "broadcast":
                // å…¨ç½‘å¹¿æ’­
                List<SysUserInfo> allUsers = orgClosureService.getAllActiveUsers(
                    createDTO.getCustomerId()
                );
                recipients = allUsers.stream()
                    .map(user -> new MessageRecipientInfo(user.getId(), "broadcast"))
                    .collect(Collectors.toList());
                break;
        }
        
        return recipients;
    }
}
```

### 2. Pythonåç«¯Serviceå®ç°

#### 2.1 æ¶ˆæ¯è½®è¯¢æœåŠ¡ä¼˜åŒ–
```python
class OptimizedMessagePollingService:
    """ä¼˜åŒ–çš„æ¶ˆæ¯è½®è¯¢æœåŠ¡"""
    
    def __init__(self):
        self.db = get_db_connection()
        self.redis_client = get_redis_client()
        self.cache_ttl = 300  # 5åˆ†é’Ÿç¼“å­˜
        
    def get_user_messages_optimized(self, user_id: int, customer_id: int, 
                                  device_sn: str = None, last_poll_time: str = None) -> Dict:
        """ä¼˜åŒ–çš„ç”¨æˆ·æ¶ˆæ¯æŸ¥è¯¢"""
        
        try:
            # 1. æ„å»ºç¼“å­˜é”®
            cache_key = f"user_messages:{customer_id}:{user_id}:{device_sn or 'all'}"
            
            # 2. å°è¯•ä»ç¼“å­˜è·å–
            cached_data = self.redis_client.get(cache_key)
            if cached_data and not last_poll_time:
                return json.loads(cached_data)
            
            # 3. æ•°æ®åº“æŸ¥è¯¢
            query_params = {
                'user_id': user_id,
                'customer_id': customer_id,
                'device_sn': device_sn,
                'last_poll_time': last_poll_time or (datetime.now() - timedelta(hours=24)).isoformat()
            }
            
            messages = self._execute_optimized_message_query(query_params)
            
            # 4. æ•°æ®å¤„ç†å’Œå¢å¼º
            enhanced_messages = []
            for msg in messages:
                enhanced_msg = self._enhance_message_data(msg)
                enhanced_messages.append(enhanced_msg)
            
            # 5. æ„å»ºå“åº”æ•°æ®
            response_data = {
                'messages': enhanced_messages,
                'summary': self._calculate_message_summary(enhanced_messages),
                'server_time': datetime.now().isoformat(),
                'cache_ttl': self.cache_ttl
            }
            
            # 6. ç¼“å­˜ç»“æœ (çŸ­æœŸç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢)
            if not last_poll_time:
                self.redis_client.setex(
                    cache_key, 
                    60,  # 1åˆ†é’Ÿç¼“å­˜
                    json.dumps(response_data, default=str)
                )
            
            return response_data
            
        except Exception as e:
            logger.error(f"ç”¨æˆ·æ¶ˆæ¯æŸ¥è¯¢å¤±è´¥: user_id={user_id}, error={str(e)}")
            raise
    
    def _execute_optimized_message_query(self, params: Dict) -> List[Dict]:
        """æ‰§è¡Œä¼˜åŒ–çš„æ¶ˆæ¯æŸ¥è¯¢"""
        
        query = """
        SELECT 
            m.id,
            m.message,
            m.message_type,
            m.message_scope, 
            m.priority_level,
            m.sent_time,
            m.create_time,
            d.delivery_status,
            d.response_time,
            d.response_message,
            
            -- è®¡ç®—å“åº”æˆªæ­¢æ—¶é—´
            CASE m.priority_level
                WHEN 1 THEN DATE_ADD(m.sent_time, INTERVAL 5 MINUTE)
                WHEN 2 THEN DATE_ADD(m.sent_time, INTERVAL 15 MINUTE) 
                WHEN 3 THEN DATE_ADD(m.sent_time, INTERVAL 30 MINUTE)
                ELSE DATE_ADD(m.sent_time, INTERVAL 60 MINUTE)
            END as response_deadline,
            
            -- æ˜¯å¦è¿‡æœŸ
            CASE 
                WHEN d.response_time IS NOT NULL THEN 0
                WHEN NOW() > CASE m.priority_level
                    WHEN 1 THEN DATE_ADD(m.sent_time, INTERVAL 5 MINUTE)
                    WHEN 2 THEN DATE_ADD(m.sent_time, INTERVAL 15 MINUTE)
                    WHEN 3 THEN DATE_ADD(m.sent_time, INTERVAL 30 MINUTE)
                    ELSE DATE_ADD(m.sent_time, INTERVAL 60 MINUTE)
                END THEN 1
                ELSE 0
            END as is_expired,
            
            -- ç´§æ€¥ç¨‹åº¦è¯„åˆ†
            CASE 
                WHEN m.priority_level = 1 AND d.response_time IS NULL THEN 100
                WHEN m.priority_level = 2 AND d.response_time IS NULL THEN 80
                WHEN m.priority_level = 3 AND d.response_time IS NULL THEN 60
                WHEN m.priority_level = 4 AND d.response_time IS NULL THEN 40
                ELSE 0
            END as urgency_score
            
        FROM t_device_message_v2 m
        INNER JOIN t_device_message_detail_v2 d ON m.id = d.message_id
        WHERE d.user_id = %(user_id)s
          AND m.customer_id = %(customer_id)s
          AND m.create_time > %(last_poll_time)s
          AND m.is_deleted = 0
          AND d.is_deleted = 0
          AND (%(device_sn)s IS NULL OR m.device_sn = %(device_sn)s OR m.device_sn IS NULL)
        ORDER BY urgency_score DESC, m.priority_level ASC, m.create_time DESC
        LIMIT 50
        """
        
        cursor = self.db.cursor(dictionary=True)
        cursor.execute(query, params)
        return cursor.fetchall()
    
    def _enhance_message_data(self, message: Dict) -> Dict:
        """å¢å¼ºæ¶ˆæ¯æ•°æ®"""
        
        # è®¡ç®—ç´§æ€¥ç¨‹åº¦æŒ‡ç¤ºå™¨
        urgency_indicator = self._calculate_urgency_indicator(
            message['priority_level'], 
            message['response_deadline'],
            message['is_expired']
        )
        
        # æ·»åŠ æ˜¾ç¤ºå‹å¥½çš„å­—æ®µ
        message['priority_label'] = self._get_priority_label(message['priority_level'])
        message['priority_color'] = self._get_priority_color(message['priority_level'])
        message['type_label'] = self._get_message_type_label(message['message_type'])
        message['status_label'] = self._get_status_label(message['delivery_status'])
        message['urgency_indicator'] = urgency_indicator
        
        # æ—¶é—´æ ¼å¼åŒ–
        if message['sent_time']:
            message['sent_time_formatted'] = self._format_time_friendly(message['sent_time'])
        
        if message['response_deadline']:
            message['deadline_formatted'] = self._format_time_friendly(message['response_deadline'])
            message['time_until_deadline'] = self._calculate_time_until_deadline(message['response_deadline'])
        
        return message
    
    def update_message_response(self, message_id: int, user_id: int, customer_id: int, 
                              response_type: str, response_message: str = "") -> bool:
        """æ›´æ–°æ¶ˆæ¯å“åº”çŠ¶æ€"""
        
        try:
            # éªŒè¯æ¶ˆæ¯å­˜åœ¨ä¸”å±äºè¯¥ç”¨æˆ·
            exists = self._verify_message_ownership(message_id, user_id, customer_id)
            if not exists:
                raise ValueError("æ¶ˆæ¯ä¸å­˜åœ¨æˆ–æ— æƒé™æ“ä½œ")
            
            # æ›´æ–°è¯¦æƒ…è¡¨å“åº”çŠ¶æ€
            update_detail_query = """
            UPDATE t_device_message_detail_v2 
            SET delivery_status = %s,
                response_type = %s,
                response_message = %s,
                response_time = NOW(),
                update_time = NOW()
            WHERE message_id = %s 
              AND user_id = %s 
              AND is_deleted = 0
            """
            
            cursor = self.db.cursor()
            cursor.execute(update_detail_query, [
                'acknowledged', response_type, response_message, message_id, user_id
            ])
            
            # æ›´æ–°ä¸»è¡¨å“åº”è®¡æ•°
            update_main_query = """
            UPDATE t_device_message_v2 m
            SET acknowledged_count = (
                    SELECT COUNT(*) 
                    FROM t_device_message_detail_v2 d 
                    WHERE d.message_id = m.id 
                      AND d.delivery_status = 'acknowledged'
                      AND d.is_deleted = 0
                ),
                message_status = CASE 
                    WHEN (SELECT COUNT(*) FROM t_device_message_detail_v2 d 
                          WHERE d.message_id = m.id AND d.delivery_status = 'acknowledged' AND d.is_deleted = 0) = m.target_user_count 
                    THEN 'completed'
                    ELSE 'delivered'
                END,
                acknowledged_time = CASE
                    WHEN acknowledged_count = 0 THEN NOW()  -- é¦–æ¬¡å“åº”æ—¶é—´
                    ELSE acknowledged_time
                END,
                update_time = NOW()
            WHERE id = %s AND customer_id = %s
            """
            
            cursor.execute(update_main_query, [message_id, customer_id])
            self.db.commit()
            
            # æ¸…é™¤ç›¸å…³ç¼“å­˜
            self._clear_message_cache(user_id, customer_id)
            
            # å‘é€WebSocketæ›´æ–°é€šçŸ¥
            self._send_response_notification(message_id, user_id, response_type)
            
            return True
            
        except Exception as e:
            self.db.rollback()
            logger.error(f"æ›´æ–°æ¶ˆæ¯å“åº”å¤±è´¥: message_id={message_id}, user_id={user_id}, error={str(e)}")
            return False
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§ä¸ç»Ÿè®¡

### 1. å“åº”æ—¶é—´è¿½è¸ªè§†å›¾

```sql
-- åˆ›å»ºç”¨æˆ·æ¶ˆæ¯æ€§èƒ½ç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW v_user_message_performance AS
SELECT 
    u.id as user_id,
    u.real_name as user_name,
    uo.org_id,
    o.name as org_name,
    COUNT(m.id) as total_messages,
    COUNT(CASE WHEN m.message_status = 'pending' THEN 1 END) as pending_count,
    COUNT(CASE WHEN m.message_status = 'delivered' THEN 1 END) as delivered_count,
    COUNT(CASE WHEN m.message_status = 'acknowledged' THEN 1 END) as acknowledged_count,
    ROUND(
        COUNT(CASE WHEN m.message_status = 'acknowledged' THEN 1 END) * 100.0 / 
        NULLIF(COUNT(CASE WHEN m.message_status IN ('delivered', 'acknowledged') THEN 1 END), 0), 
        2
    ) as acknowledge_rate,
    AVG(TIMESTAMPDIFF(SECOND, m.sent_time, m.acknowledged_time)) as avg_response_time_seconds,
    MIN(m.create_time) as first_message_time,
    MAX(m.create_time) as last_message_time
FROM sys_user u
LEFT JOIN sys_user_org uo ON uo.user_id = u.id AND uo.is_deleted = 0
LEFT JOIN sys_org_units o ON uo.org_id = o.id AND o.is_deleted = 0
LEFT JOIN t_device_message_v2 m ON m.user_id = u.id AND m.is_deleted = 0
WHERE u.is_deleted = 0
GROUP BY u.id, u.real_name, uo.org_id, o.name;
```

### 2. æ¶ˆæ¯æ€§èƒ½åˆ†æå­˜å‚¨è¿‡ç¨‹

```sql
-- æ¶ˆæ¯æ€§èƒ½åˆ†æå­˜å‚¨è¿‡ç¨‹
DELIMITER $$

CREATE PROCEDURE sp_analyze_message_performance(
    IN p_customer_id BIGINT,
    IN p_start_date DATE,
    IN p_end_date DATE,
    IN p_department_id BIGINT DEFAULT NULL
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_message_id BIGINT;
    DECLARE v_sent_time TIMESTAMP;
    DECLARE v_completed_time TIMESTAMP;
    DECLARE v_total_response_time INT;
    
    -- æ¸¸æ ‡å£°æ˜
    DECLARE message_cursor CURSOR FOR
        SELECT m.id, m.sent_time, 
               (SELECT MAX(d.response_time) 
                FROM t_device_message_detail_v2 d 
                WHERE d.message_id = m.id AND d.is_deleted = 0) as completed_time
        FROM t_device_message_v2 m
        WHERE m.customer_id = p_customer_id
          AND DATE(m.create_time) BETWEEN p_start_date AND p_end_date
          AND (p_department_id IS NULL OR m.department_id = p_department_id)
          AND m.is_deleted = 0
          AND m.message_status = 'completed';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- åˆ›å»ºä¸´æ—¶ç»“æœè¡¨
    DROP TEMPORARY TABLE IF EXISTS temp_message_performance;
    CREATE TEMPORARY TABLE temp_message_performance (
        message_id BIGINT,
        total_response_time INT,
        response_efficiency_score DECIMAL(5,2)
    );
    
    -- æ‰“å¼€æ¸¸æ ‡
    OPEN message_cursor;
    
    -- å¾ªç¯å¤„ç†
    read_loop: LOOP
        FETCH message_cursor INTO v_message_id, v_sent_time, v_completed_time;
        
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- è®¡ç®—æ€»å“åº”æ—¶é—´
        IF v_completed_time IS NOT NULL THEN
            SET v_total_response_time = TIMESTAMPDIFF(SECOND, v_sent_time, v_completed_time);
            
            -- æ’å…¥ä¸´æ—¶è¡¨
            INSERT INTO temp_message_performance (message_id, total_response_time, response_efficiency_score)
            VALUES (v_message_id, v_total_response_time, 
                   CASE 
                       WHEN v_total_response_time <= 300 THEN 100.0    -- 5åˆ†é’Ÿå†…
                       WHEN v_total_response_time <= 900 THEN 90.0     -- 15åˆ†é’Ÿå†…
                       WHEN v_total_response_time <= 1800 THEN 70.0    -- 30åˆ†é’Ÿå†…
                       WHEN v_total_response_time <= 3600 THEN 50.0    -- 1å°æ—¶å†…
                       ELSE 30.0                                       -- è¶…è¿‡1å°æ—¶
                   END);
        END IF;
    END LOOP;
    
    -- å…³é—­æ¸¸æ ‡
    CLOSE message_cursor;
    
    -- è¿”å›åˆ†æç»“æœ
    SELECT 
        COUNT(*) as total_completed_messages,
        AVG(total_response_time) as avg_total_response_time,
        MIN(total_response_time) as min_response_time,
        MAX(total_response_time) as max_response_time,
        AVG(response_efficiency_score) as avg_efficiency_score,
        COUNT(CASE WHEN total_response_time <= 300 THEN 1 END) as within_5min_count,
        COUNT(CASE WHEN total_response_time <= 900 THEN 1 END) as within_15min_count,
        COUNT(CASE WHEN total_response_time <= 1800 THEN 1 END) as within_30min_count,
        ROUND(
            COUNT(CASE WHEN total_response_time <= 300 THEN 1 END) * 100.0 / COUNT(*), 2
        ) as sla_5min_compliance,
        ROUND(
            COUNT(CASE WHEN total_response_time <= 900 THEN 1 END) * 100.0 / COUNT(*), 2  
        ) as sla_15min_compliance
    FROM temp_message_performance;
    
    -- æ¸…ç†ä¸´æ—¶è¡¨
    DROP TEMPORARY TABLE temp_message_performance;
    
END$$

DELIMITER ;
```

---

## ğŸ”„ æ•°æ®è¿ç§»æ–¹æ¡ˆ

### 1. ä»æ—§è¡¨åˆ°V2è¡¨çš„æ•°æ®è¿ç§»

```sql
-- æ•°æ®è¿ç§»è„šæœ¬
-- ç¬¬ä¸€æ­¥: è¿ç§»ä¸»æ¶ˆæ¯æ•°æ®
INSERT INTO t_device_message_v2 (
    id, customer_id, department_id, user_id, device_sn,
    message, message_type, message_scope, sender_type, receiver_type, priority_level,
    message_status, sent_time, received_time, acknowledged_time, 
    target_user_count, acknowledged_count,
    create_user_id, create_time, update_time, is_deleted, version
)
SELECT 
    m.id,
    m.customer_id,
    -- éƒ¨é—¨IDè½¬æ¢ (ä»å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—)
    CASE 
        WHEN m.department_info IS NOT NULL AND m.department_info REGEXP '^[0-9]+$' 
        THEN CAST(m.department_info AS UNSIGNED)
        ELSE 1  -- é»˜è®¤éƒ¨é—¨ID
    END as department_id,
    m.user_id,
    m.device_sn,
    m.message,
    
    -- æ¶ˆæ¯ç±»å‹æ ‡å‡†åŒ–
    CASE 
        WHEN m.message_type = 'task' THEN 'task_assignment'
        WHEN m.message_type = 'job' THEN 'task_assignment'
        WHEN m.message_type = 'announcement' THEN 'announcement'
        WHEN m.message_type = 'notification' THEN 'notification'
        WHEN m.message_type = 'alert' THEN 'alert_health'
        ELSE 'notification'
    END as message_type,
    
    -- æ¶ˆæ¯èŒƒå›´æ¨æ–­
    CASE 
        WHEN m.user_id IS NOT NULL THEN 'individual'
        WHEN m.department_info IS NOT NULL THEN 'department'
        ELSE 'organization'
    END as message_scope,
    
    -- å‘é€è€…ç±»å‹æ ‡å‡†åŒ–
    CASE 
        WHEN m.sender_type = 'system' THEN 'system'
        WHEN m.sender_type = 'user' THEN 'user'
        WHEN m.sender_type = 'device' THEN 'device'
        WHEN m.sender_type = 'admin' THEN 'admin'
        ELSE 'system'
    END as sender_type,
    
    -- æ¥æ”¶è€…ç±»å‹æ ‡å‡†åŒ–  
    CASE 
        WHEN m.receiver_type = 'user' THEN 'user'
        WHEN m.receiver_type = 'device' THEN 'user'  -- è®¾å¤‡æ¶ˆæ¯å®é™…æ˜¯ç»™ç”¨æˆ·çš„
        WHEN m.receiver_type = 'department' THEN 'department'
        ELSE 'user'
    END as receiver_type,
    
    -- ä¼˜å…ˆçº§æ ‡å‡†åŒ– (é»˜è®¤ä¸ºæ™®é€šä¼˜å…ˆçº§)
    3 as priority_level,
    
    -- çŠ¶æ€æ ‡å‡†åŒ–
    CASE 
        WHEN m.message_status = 'pending' THEN 'pending'
        WHEN m.message_status = 'delivered' THEN 'delivered'
        WHEN m.message_status = 'acknowledged' THEN 'acknowledged'
        WHEN m.message_status = 'responded' THEN 'acknowledged'
        WHEN m.message_status = 'failed' THEN 'delivery_failed'
        ELSE 'pending'
    END as message_status,
    
    m.sent_time,
    m.received_time,
    CASE 
        WHEN m.message_status IN ('acknowledged', 'responded') THEN m.received_time
        ELSE NULL
    END as acknowledged_time,
    
    -- ç›®æ ‡ç”¨æˆ·æ•° (éœ€è¦åç»­æ›´æ–°)
    1 as target_user_count,
    CASE 
        WHEN m.message_status IN ('acknowledged', 'responded') THEN 1
        ELSE 0
    END as acknowledged_count,
    
    m.create_user_id,
    m.create_time,
    m.update_time,
    m.is_deleted,
    1 as version
    
FROM t_device_message m
WHERE m.user_id IS NOT NULL  -- åªè¿ç§»æœ‰ç”¨æˆ·å…³è”çš„æ¶ˆæ¯
  AND m.is_deleted = 0;

-- ç¬¬äºŒæ­¥: è¿ç§»è¯¦æƒ…æ•°æ®
INSERT INTO t_device_message_detail_v2 (
    id, message_id, customer_id, user_id, device_sn,
    response_message, response_type, response_time,
    delivery_status, delivery_attempt_count, last_delivery_time,
    create_time, update_time, is_deleted
)
SELECT 
    d.id,
    CAST(d.message_id AS UNSIGNED) as message_id,
    d.customer_id,
    d.user_id,
    d.device_sn,
    d.message as response_message,
    
    -- å“åº”ç±»å‹æ ‡å‡†åŒ–
    CASE 
        WHEN d.message_status = 'responded' THEN 'acknowledged'
        WHEN d.message_status = 'delivered' THEN 'acknowledged'
        ELSE 'acknowledged'
    END as response_type,
    
    d.received_time as response_time,
    
    -- æŠ•é€’çŠ¶æ€æ ‡å‡†åŒ–
    CASE 
        WHEN d.message_status = 'responded' THEN 'delivered'
        WHEN d.message_status = 'delivered' THEN 'delivered'
        ELSE 'pending'
    END as delivery_status,
    
    1 as delivery_attempt_count,
    d.sent_time as last_delivery_time,
    d.create_time,
    d.update_time,
    d.is_deleted
    
FROM t_device_message_detail d
WHERE d.user_id IS NOT NULL 
  AND d.is_deleted = 0
  AND EXISTS (
      SELECT 1 FROM t_device_message_v2 m 
      WHERE m.id = CAST(d.message_id AS UNSIGNED)
  );

-- ç¬¬ä¸‰æ­¥: æ›´æ–°ç›®æ ‡ç”¨æˆ·æ•°ç»Ÿè®¡
UPDATE t_device_message_v2 m
SET target_user_count = (
    SELECT COUNT(*) 
    FROM t_device_message_detail_v2 d 
    WHERE d.message_id = m.id AND d.is_deleted = 0
)
WHERE m.id IN (
    SELECT DISTINCT message_id 
    FROM t_device_message_detail_v2 
    WHERE is_deleted = 0
);
```

---

## ğŸ“ˆ æ€»ç»“ä¸é¢„æœŸæ•ˆæœ

### æ ¸å¿ƒä¼˜åŒ–æˆæœ

1. **æ¶ˆæ¯ç±»å‹è§„èŒƒåŒ–**: ç»Ÿä¸€çš„æšä¸¾ç®¡ç†ï¼Œå‰åç«¯çŠ¶æ€ä¸€è‡´
2. **é«˜æ•ˆæŸ¥è¯¢æœºåˆ¶**: åŸºäºé—­åŒ…è¡¨çš„æ¯«ç§’çº§ç»„ç»‡æŸ¥è¯¢
3. **å®æ—¶å“åº”è¿½è¸ª**: å®Œæ•´çš„ç”¨æˆ·å“åº”çŠ¶æ€ç›‘æ§
4. **å¤šç«¯APIæ¥å£**: ä¸“é—¨ä¼˜åŒ–çš„è®¾å¤‡ç«¯å’Œç®¡ç†ç«¯æ¥å£
5. **æ€§èƒ½ç›‘æ§ä½“ç³»**: å®Œæ•´çš„å“åº”æ—¶é—´ç»Ÿè®¡å’ŒSLAç›‘æ§

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| æ¶ˆæ¯æŸ¥è¯¢å“åº”æ—¶é—´ | 200ms | 10ms | 95% |
| æœªå“åº”ç”¨æˆ·æŸ¥è¯¢ | 500ms | 50ms | 90% |
| æ‰¹é‡çŠ¶æ€æ›´æ–° | 1000ms | 100ms | 90% |
| å¤§å±æ•°æ®åˆ·æ–° | 2ç§’ | 200ms | 90% |
| è®¾å¤‡è½®è¯¢æ•ˆç‡ | 300ms | 30ms | 90% |

### æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

- **ç»Ÿä¸€è§„èŒƒ**: æ¶ˆæ¯ç±»å‹å’ŒçŠ¶æ€çš„æ ‡å‡†åŒ–ç®¡ç†
- **é«˜æ€§èƒ½æŸ¥è¯¢**: åŸºäºé—­åŒ…è¡¨å’Œç´¢å¼•çš„æŸ¥è¯¢ä¼˜åŒ–
- **å®æ—¶æ€§**: WebSocket + è½®è¯¢çš„æ··åˆæ›´æ–°æœºåˆ¶
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•çš„æ¶æ„è®¾è®¡
- **ç›‘æ§å®Œå¤‡**: å…¨æ–¹ä½çš„æ€§èƒ½å’Œä¸šåŠ¡ç›‘æ§

è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆå°†æ˜¾è‘—æå‡æ¶ˆæ¯ç³»ç»Ÿçš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼Œä¸ºå¥åº·ç®¡ç†å¹³å°æä¾›ç¨³å®šå¯é çš„æ¶ˆæ¯å¤„ç†èƒ½åŠ›ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æœ€åæ›´æ–°: 2025-08-31*  
*é€‚ç”¨ç³»ç»Ÿ: çµå¢ƒä¸‡è±¡å¥åº·ç®¡ç†ç³»ç»Ÿ v2.1*