# 灵境万象健康管理系统 - 许可证系统用户操作手册

> **文档版本**: v1.0  
> **更新时间**: 2025-08-31  
> **适用版本**: 灵境万象健康管理系统 v2.1+

## 📋 目录

- [1. 许可证系统概述](#1-许可证系统概述)
- [2. 许可证文件管理](#2-许可证文件管理)
- [3. 许可证生成工具使用](#3-许可证生成工具使用)
- [4. 系统启动与验证](#4-系统启动与验证)
- [5. 许可证状态监控](#5-许可证状态监控)
- [6. 常见问题处理](#6-常见问题处理)
- [7. 故障排查指南](#7-故障排查指南)
- [8. 最佳实践建议](#8-最佳实践建议)

---

## 1. 许可证系统概述

### 1.1 什么是许可证系统

灵境万象健康管理系统采用**离线许可证验证机制**，确保系统在无外网环境下也能正常进行授权验证。许可证系统具有以下特点：

- ✅ **离线验证**: 无需联网，适用于内网环境
- 🔒 **硬件绑定**: 基于硬件指纹，防止非法复制
- 📊 **功能控制**: 精确控制系统功能和使用限制
- 🕐 **时效管理**: 支持有效期控制和自动过期检测
- 📈 **使用统计**: 实时监控许可证使用情况

### 1.2 许可证类型说明

| 许可证类型 | 描述 | 用户限制 | 设备限制 | 功能权限 |
|-----------|------|----------|----------|----------|
| **TRIAL** | 试用版 | 10 | 20 | 基础功能 |
| **STANDARD** | 标准版 | 100 | 500 | 标准功能包 |
| **ENTERPRISE** | 企业版 | 1000 | 5000 | 全部功能 |
| **CUSTOM** | 定制版 | 自定义 | 自定义 | 按需配置 |

### 1.3 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   许可证文件     │    │  许可证管理器    │    │  硬件指纹服务    │
│   ljwx.lic     │───▶│  LicenseManager │───▶│ HardwareService │
│   (Base64编码)  │    │  验证&监控      │    │  指纹生成&验证  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   许可证验证器   │    │   功能控制器     │    │   使用统计服务   │
│ LicenseValidator│    │ FeatureControl  │    │  UsageTracker   │
│   解析&签名验证  │    │   权限控制      │    │   使用量监控     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 2. 许可证文件管理

### 2.1 许可证文件位置

许可证文件必须放置在以下位置：

```
项目根目录/
├── ljwx-boot/
│   └── ljwx-boot-admin/
│       └── license/
│           └── ljwx.lic  ← 许可证文件位置
```

**重要提醒**：
- 文件名必须为 `ljwx.lic`
- 文件编码必须为 `UTF-8`
- 确保文件有读取权限

### 2.2 许可证文件格式

许可证文件采用 **Base64编码的JSON格式**：

```json
{
  "data": "{许可证JSON数据}",
  "signature": "数字签名",
  "algorithm": "SHA256withRSA",
  "timestamp": 1756651607309
}
```

### 2.3 许可证信息内容

完整的许可证信息包含：

```json
{
  "licenseId": "LJWX-DEV-1756651607286",
  "customerName": "灵境万象开发环境",
  "customerId": "ljwx-dev-001",
  "licenseType": "ENTERPRISE",
  "startDate": "2025-08-31T22:46:47.303238",
  "endDate": "2035-08-31T22:46:47.308955",
  "hardwareFingerprint": "96E2D4225BFDBAFA86A24D5608EBA3123CF714C58F82A2984256DEE6F7526CC2",
  "maxUsers": 1000,
  "maxDevices": 5000,
  "maxOrganizations": 100,
  "features": [
    "basic_health",
    "advanced_alert",
    "user_management",
    "device_management",
    "report_export",
    "api_access"
  ],
  "version": "1.0",
  "createTime": "2025-08-31T22:46:47.309051",
  "remarks": "Development License for LJWX Health Management System"
}
```

---

## 3. 许可证生成工具使用

### 3.1 工具文件位置

许可证生成工具位于：`license/LicenseGenerator.java`

### 3.2 生成新许可证的步骤

#### 步骤1: 获取硬件指纹

首先启动系统获取当前环境的硬件指纹：

```bash
cd ljwx-boot
MYSQL_DATABASE=test MYSQL_HOST=127.0.0.1 MYSQL_USER=root MYSQL_PASSWORD=123456 SPRING_PROFILES_ACTIVE=local mvn -pl ljwx-boot-admin spring-boot:run -DskipTests -q
```

在启动日志中查找类似信息：
```
生成硬件指纹: 96E2D4225BFDBAFA86A24D5608EBA3123CF714C58F82A2984256DEE6F7526CC2
```

#### 步骤2: 修改生成器配置

编辑 `license/LicenseGenerator.java`，修改硬件指纹：

```java
// 使用启动时检测到的实际硬件指纹
String fingerprint = "你的硬件指纹";
```

#### 步骤3: 编译并运行生成器

```bash
cd license
javac LicenseGenerator.java
java LicenseGenerator
```

#### 步骤4: 部署许可证文件

```bash
# 复制到正确位置
cp ljwx.lic ../ljwx-boot/ljwx-boot-admin/license/ljwx.lic
```

### 3.3 自定义许可证参数

可以修改 `LicenseGenerator.java` 中的以下参数：

```java
// 客户信息
licenseJson.append("\"customerName\":\"你的客户名称\",");
licenseJson.append("\"customerId\":\"custom-001\",");

// 许可证类型
licenseJson.append("\"licenseType\":\"ENTERPRISE\",");

// 有效期（可调整年数）
licenseJson.append("\"endDate\":\"").append(LocalDateTime.now().plusYears(5).format(DateTimeFormatter.ISO_LOCAL_DATE_TIME)).append("\",");

// 使用限制
licenseJson.append("\"maxUsers\":500,");
licenseJson.append("\"maxDevices\":2000,");
licenseJson.append("\"maxOrganizations\":50,");

// 功能权限
licenseJson.append("\"features\":[\"basic_health\",\"user_management\"],");
```

---

## 4. 系统启动与验证

### 4.1 启动系统

使用标准启动命令：

```bash
cd ljwx-boot
MYSQL_DATABASE=test MYSQL_HOST=127.0.0.1 MYSQL_USER=root MYSQL_PASSWORD=123456 SPRING_PROFILES_ACTIVE=local mvn -pl ljwx-boot-admin spring-boot:run -DskipTests
```

### 4.2 验证成功标志

启动日志中应显示：

```
🔐 初始化LJWX许可证系统...
📄 加载许可证文件: ./license/ljwx.lic
许可证解析成功: 客户=灵境万象开发环境, 类型=ENTERPRISE, 有效期=2025-08-31T22:46:47.303238~2035-08-31T22:46:47.308955
生成硬件指纹: 96E2D4225BFDBAFA86A24D5608EBA3123CF714C58F82A2984256DEE6F7526CC2
✅ 许可证验证成功 - 系统已授权使用
📋 许可证信息:
   - 客户: 灵境万象开发环境
   - 版本: ENTERPRISE
   - 有效期: 2025-08-31T22:46:47.303238 ~ 2035-08-31T22:46:47.308955
   - 最大用户数: 1000
   - 最大设备数: 5000
```

### 4.3 验证失败情况

如果验证失败，可能出现以下错误：

| 错误类型 | 错误信息 | 解决方案 |
|---------|----------|----------|
| 文件不存在 | `许可证文件不存在: ./license/ljwx.lic` | 检查文件路径和名称 |
| 硬件指纹不匹配 | `硬件指纹验证失败` | 重新生成匹配的许可证 |
| 许可证过期 | `许可证已过期` | 生成新的有效期许可证 |
| 格式错误 | `许可证格式无效` | 检查文件编码和格式 |

---

## 5. 许可证状态监控

### 5.1 实时状态检查

系统提供多种方式检查许可证状态：

#### API接口检查

```bash
# 获取许可证状态
curl http://localhost:9998/api/license/status

# 获取许可证详细信息
curl http://localhost:9998/api/license/info

# 获取硬件指纹信息
curl http://localhost:9998/api/license/hardware
```

#### 管理界面检查

访问系统管理界面：`http://localhost:9998/admin/license`

### 5.2 许可证监控指标

系统自动监控以下指标：

- **有效期状态**: 距离过期剩余天数
- **使用量统计**: 当前用户数、设备数、组织数
- **功能使用情况**: 各功能模块使用频次
- **硬件指纹状态**: 硬件环境变更检测

### 5.3 告警机制

系统会在以下情况发出告警：

- ⚠️ **即将过期**: 30天内过期提醒
- 🚨 **使用量超限**: 接近或超过许可限制
- ❌ **验证失败**: 硬件环境变更或文件损坏
- 🔄 **需要更新**: 许可证版本过低

---

## 6. 常见问题处理

### 6.1 Q: 如何更换服务器？

**A:** 更换服务器需要重新生成许可证：

1. 在新服务器上启动系统（会失败，但能获取硬件指纹）
2. 记录新的硬件指纹
3. 使用许可证生成工具生成新的许可证
4. 部署新许可证文件

### 6.2 Q: 许可证过期了怎么办？

**A:** 生成新的有效期许可证：

1. 修改 `LicenseGenerator.java` 中的有效期设置
2. 重新编译运行生成器
3. 替换旧的许可证文件
4. 重启系统

### 6.3 Q: 如何扩大用户或设备限制？

**A:** 修改许可证限制参数：

1. 在生成器中调整 `maxUsers`、`maxDevices` 参数
2. 重新生成许可证
3. 部署更新后的许可证文件

### 6.4 Q: 系统提示功能未授权怎么办？

**A:** 检查许可证功能权限：

1. 确认许可证类型是否支持该功能
2. 检查 `features` 数组是否包含相应功能
3. 必要时重新生成包含所需功能的许可证

### 6.5 Q: 硬件指纹经常变化怎么办？

**A:** 硬件指纹变化通常由以下原因造成：

- 虚拟化环境MAC地址变化
- 系统重装或硬件变更
- 网络配置变化

**解决方案**：
- 使用固定MAC地址的网卡
- 在虚拟化环境中固定MAC地址
- 定期更新许可证

---

## 7. 故障排查指南

### 7.1 启动失败排查流程

```
启动失败
    ↓
检查文件是否存在
    ↓ (存在)
检查文件权限和编码
    ↓ (正常)
查看具体错误信息
    ↓
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  硬件指纹不匹配  │  │   许可证过期    │  │   格式错误      │
│      ↓         │  │      ↓         │  │      ↓         │
│ 重新生成许可证   │  │ 更新有效期      │  │ 检查文件格式     │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### 7.2 日志分析

#### 许可证相关日志位置

```bash
# 查看详细启动日志
tail -f ljwx-boot/logs/spring.log

# 过滤许可证相关日志
grep -i "license" ljwx-boot/logs/spring.log
```

#### 常见日志信息解读

```bash
# 成功信息
"✅ 许可证验证成功" - 验证完全通过
"📄 加载许可证文件" - 文件加载成功
"🔍 启动许可证监控" - 监控服务启动

# 警告信息
"⚠️ 硬件指纹不匹配" - 需要重新生成许可证
"⚠️ 公钥不存在，跳过签名验证" - 开发模式，生产环境需要配置

# 错误信息
"🚨 许可证初始化失败" - 严重错误，需要检查配置
"❌ 许可证已过期" - 需要更新有效期
```

### 7.3 应急处理方案

#### 紧急情况下的临时处理

如果生产环境许可证突然失效：

1. **立即检查**：
   ```bash
   # 检查文件是否存在
   ls -la ljwx-boot/ljwx-boot-admin/license/ljwx.lic
   
   # 检查系统时间
   date
   
   # 检查磁盘空间
   df -h
   ```

2. **快速恢复**：
   ```bash
   # 从备份恢复许可证文件
   cp backup/ljwx.lic ljwx-boot/ljwx-boot-admin/license/
   
   # 重启服务
   ./restart.sh
   ```

3. **生成临时许可证**：
   如果没有备份，使用生成工具快速创建临时许可证

---

## 8. 最佳实践建议

### 8.1 部署前准备

- ✅ 在部署前测试许可证生成和验证流程
- ✅ 准备许可证文件的备份方案
- ✅ 记录硬件指纹信息，便于故障恢复
- ✅ 建立许可证状态监控机制

### 8.2 生产环境建议

- 🔒 **安全存储**: 将许可证文件备份到安全位置
- 📅 **定期检查**: 建立许可证到期提醒机制
- 🔧 **版本管理**: 保存许可证生成工具的版本记录
- 📊 **监控告警**: 集成许可证状态到监控系统

### 8.3 维护流程规范

1. **月度检查**：
   - 许可证剩余有效期
   - 当前使用量统计
   - 硬件环境稳定性

2. **季度维护**：
   - 备份许可证文件和生成工具
   - 测试许可证恢复流程
   - 更新操作文档

3. **年度更新**：
   - 评估许可证需求变化
   - 更新许可证有效期
   - 优化许可证管理流程

### 8.4 安全注意事项

- 🔐 **权限控制**: 限制许可证文件的访问权限
- 🔒 **传输加密**: 许可证文件传输时使用加密通道
- 📝 **操作记录**: 记录所有许可证相关操作
- 🚨 **异常监控**: 监控许可证文件的异常访问

---

## 📞 技术支持

如果在使用过程中遇到问题，请按以下方式寻求帮助：

1. **查阅文档**: 首先查看本操作手册和 `CLAUDE.md`
2. **检查日志**: 分析系统日志中的许可证相关信息
3. **社区支持**: 在GitHub Issues中提交问题
4. **技术支持**: 联系系统管理员或技术支持团队

---

**文档维护**：本文档随系统版本更新，请定期查看最新版本。

*最后更新时间：2025-08-31*  
*文档版本：v1.0*