# æŠ€æœ¯çº¦æŸç¡®è®¤æŠ¥å‘Š

## âœ… æ ¸å¿ƒæŠ€æœ¯çº¦æŸéªŒè¯

### 1. æ•°æ®æŸ¥è¯¢è§„èŒƒéªŒè¯

#### ç°æœ‰ç³»ç»Ÿåˆ†æ
- **UnifiedHealthDataQueryService** âœ… å·²ç¡®è®¤å­˜åœ¨
  - ä½ç½®: `/ljwx-boot-modules/src/main/java/com/ljwx/modules/health/service/UnifiedHealthDataQueryService.java`
  - æ ¸å¿ƒæ–¹æ³•: `queryHealthData(UnifiedHealthQueryDTO queryDTO)`
  - åŠŸèƒ½: ç»Ÿä¸€å¥åº·æ•°æ®æŸ¥è¯¢ï¼Œæ”¯æŒåˆ†è¡¨è·¯ç”±ã€æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ã€å¤šç§Ÿæˆ·æƒé™æ§åˆ¶

#### TUserHealthDataè¡¨ç»“æ„éªŒè¯ âœ…
```java
@TableName("t_user_health_data")
public class TUserHealthData extends BaseEntity {
    private Long userId;           // ç”¨æˆ·ID
    private Long orgId;            // ç»„ç»‡ID  
    private Long customerId;       // ç§Ÿæˆ·ID (å¤šç§Ÿæˆ·æ”¯æŒ)
    
    // === è½¨è¿¹ç›¸å…³å­—æ®µ (å·²å­˜åœ¨) ===
    private Double latitude;       // çº¬åº¦ âœ…
    private Double longitude;      // ç»åº¦ âœ…  
    private Double altitude;       // æµ·æ‹” âœ…
    private Double distance;       // è·ç¦» âœ…
    private LocalDateTime timestamp; // æ—¶é—´æˆ³ âœ…
    
    // === å¥åº·æ•°æ®å­—æ®µ ===
    private Integer heartRate;     // å¿ƒç‡
    private Integer pressureHigh;  // æ”¶ç¼©å‹
    private Integer pressureLow;   // èˆ’å¼ å‹
    private Integer bloodOxygen;   // è¡€æ°§
    private Double temperature;    // ä½“æ¸©
    private Integer step;          // æ­¥æ•°
    private Integer stress;        // å‹åŠ›
    private Double calorie;        // å¡è·¯é‡Œ
    
    // === è®¾å¤‡ä¿¡æ¯ ===
    private String deviceSn;       // è®¾å¤‡åºåˆ—å·
    private String uploadMethod;   // ä¸Šä¼ æ–¹å¼: wifiã€bluetoothã€common_event
}
```

**ç¡®è®¤ç»“æœ**: âœ… è¡¨ç»“æ„å®Œæ•´ï¼ŒåŒ…å«è½¨è¿¹æ‰€éœ€çš„æ‰€æœ‰æ ¸å¿ƒå­—æ®µ

### 2. å›´æ ç³»ç»ŸéªŒè¯

#### TGeofenceè¡¨ç»“æ„éªŒè¯ âœ…
```java
@TableName("t_geofence")
public class TGeofence extends BaseEntity {
    private String name;        // ç”µå­å›´æ åç§° âœ…
    private String area;        // å›´æ åŒºåŸŸ (GeoJSON/WKTæ ¼å¼) âœ…
    private String description; // å›´æ æè¿° âœ…
    private String status;      // å›´æ çŠ¶æ€ âœ…
}
```

**ç¡®è®¤ç»“æœ**: âœ… åŸºç¡€å›´æ è¡¨ç»“æ„å·²å­˜åœ¨ï¼Œéœ€è¦æ‰©å±•å‘Šè­¦å’Œç»‘å®šåŠŸèƒ½

### 3. æƒé™ç³»ç»ŸéªŒè¯

#### Sa-Tokenæƒé™ä½“ç³» âœ…
- ç°æœ‰æ§åˆ¶å™¨å·²ä½¿ç”¨ `@SaCheckPermission` æ³¨è§£
- å¤šç§Ÿæˆ·é€šè¿‡ `customerId` å­—æ®µå®ç°æ•°æ®éš”ç¦»
- ç”¨æˆ·æƒé™é€šè¿‡ `orgId` å’Œ `userId` è¿›è¡Œå±‚çº§æ§åˆ¶

## ğŸš¨ å…³é”®æŠ€æœ¯çº¦æŸ

### çº¦æŸ1: æ•°æ®æŸ¥è¯¢è§„èŒƒ (å¼ºåˆ¶)
```
âŒ ç¦æ­¢: ç›´æ¥æŸ¥è¯¢ t_user_health_data è¡¨
âœ… å¿…é¡»: é€šè¿‡ UnifiedHealthDataQueryService.queryHealthData() æ–¹æ³•

ç¤ºä¾‹æ­£ç¡®ç”¨æ³•:
UnifiedHealthQueryDTO queryDTO = new UnifiedHealthQueryDTO();
queryDTO.setUserId(userId);
queryDTO.setCustomerId(customerId);
Map<String, Object> result = unifiedHealthDataQueryService.queryHealthData(queryDTO);
List<Map<String, Object>> basicData = (List<Map<String, Object>>) result.get("basicData");
```

### çº¦æŸ2: å¤šç§Ÿæˆ·æ•°æ®éš”ç¦» (å¼ºåˆ¶)
```
æ‰€æœ‰æ–°å¢åŠŸèƒ½å¿…é¡»æ”¯æŒå¤šç§Ÿæˆ·:
- ä½¿ç”¨ customerId è¿›è¡Œç§Ÿæˆ·éš”ç¦»
- éµå¾ªç°æœ‰æƒé™æ§åˆ¶ä½“ç³»
- æ•°æ®æŸ¥è¯¢è‡ªåŠ¨åº”ç”¨ç§Ÿæˆ·è¿‡æ»¤
```

### çº¦æŸ3: æ€§èƒ½ä¼˜åŒ–å¤ç”¨ (å¼ºåˆ¶)
```
å¿…é¡»å¤ç”¨ç°æœ‰ä¼˜åŒ–æœºåˆ¶:
- åˆ†è¡¨è·¯ç”±ç­–ç•¥ (å·²å®ç°)
- æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ– (å·²å®ç°)  
- å­—æ®µé…ç½®ç¼“å­˜ (å·²å®ç°)
- ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ (å·²å®ç°)
```

## ğŸ“‹ ç°æœ‰ç³»ç»Ÿé›†æˆèƒ½åŠ›è¯„ä¼°

### å¯ç›´æ¥å¤ç”¨çš„ç»„ä»¶ âœ…
1. **æ•°æ®è®¿é—®å±‚**
   - UnifiedHealthDataQueryService (é«˜æ€§èƒ½æŸ¥è¯¢)
   - TGeofenceServiceImpl (åŸºç¡€å›´æ ç®¡ç†)
   - MyBatis Plus + HikariCP (æ•°æ®åº“è¿æ¥æ± )

2. **æƒé™å®‰å…¨å±‚**  
   - Sa-Token æƒé™æ¡†æ¶
   - å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
   - æ“ä½œå®¡è®¡æ—¥å¿—

3. **å‰ç«¯ç»„ä»¶**
   - TrackMapComponent (åŸºç¡€è½¨è¿¹æ˜¾ç¤º)
   - é«˜å¾·åœ°å›¾é›†æˆ
   - Element Plus UIç»„ä»¶

### éœ€è¦æ‰©å±•çš„éƒ¨åˆ† â—
1. **æ•°æ®åº“è¡¨ç»“æ„**
   - t_user_health_data éœ€å¢åŠ : speed, bearing, accuracy, geom å­—æ®µ
   - æ–°å¢ t_geofence_alert å‘Šè­¦è®°å½•è¡¨
   - æ–°å¢ t_user_online_status åœ¨çº¿çŠ¶æ€è¡¨

2. **åç«¯æœåŠ¡**
   - è½¨è¿¹å¤„ç†æœåŠ¡ (åŸºäºUnifiedHealthDataQueryService)
   - å›´æ è®¡ç®—å¼•æ“ (æ‰©å±•TGeofenceServiceImpl)
   - WebSocketå®æ—¶æ¨é€æœåŠ¡

3. **å‰ç«¯åŠŸèƒ½**
   - å®æ—¶ç›‘æ§ç•Œé¢ (æ‰©å±•TrackMapComponent)
   - å†å²å›æ”¾ç»„ä»¶ (æ–°å¢)
   - å›´æ ç®¡ç†å¢å¼º (æ‰©å±•ç°æœ‰)

## âœ… æŠ€æœ¯å¯è¡Œæ€§ç»“è®º

### é«˜åº¦å¯è¡Œæ€§ âœ…
1. **æ•°æ®åŸºç¡€å®Œå¤‡**: t_user_health_dataè¡¨å·²åŒ…å«è½¨è¿¹æ ¸å¿ƒå­—æ®µ
2. **æŸ¥è¯¢æœåŠ¡å®Œå–„**: UnifiedHealthDataQueryServiceæä¾›é«˜æ€§èƒ½æŸ¥è¯¢èƒ½åŠ›
3. **æƒé™ä½“ç³»æˆç†Ÿ**: Sa-Token + å¤šç§Ÿæˆ·æ¶æ„å·²éªŒè¯ç¨³å®š
4. **å‰ç«¯åŸºç¡€è‰¯å¥½**: åœ°å›¾ç»„ä»¶å’ŒUIæ¡†æ¶å·²å°±ç»ª

### é£é™©è¯„ä¼° âš ï¸
- **ä½é£é™©**: åŸºäºç°æœ‰ç»„ä»¶æ‰©å±•ï¼ŒæŠ€æœ¯è·¯å¾„æ¸…æ™°
- **å¯æ§å¤æ‚åº¦**: ä¸»è¦å·¥ä½œä¸ºä¸šåŠ¡é€»è¾‘å±‚å¼€å‘
- **æ€§èƒ½ä¿éšœ**: å¤ç”¨ç°æœ‰ä¼˜åŒ–æœºåˆ¶ï¼Œæ€§èƒ½æœ‰ä¿éšœ

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

1. **ç«‹å³å¼€å§‹**: æ•°æ®åº“è¡¨ç»“æ„æ‰©å±• (å‘ä¸‹å…¼å®¹)
2. **å¹¶è¡Œå¼€å‘**: åç«¯æœåŠ¡å¼€å‘ + å‰ç«¯ç»„ä»¶å¼€å‘
3. **æ¸è¿›é›†æˆ**: åˆ†æ¨¡å—æµ‹è¯•å’Œé›†æˆ
4. **å¹³æ»‘ä¸Šçº¿**: ç°åº¦å‘å¸ƒï¼Œæœ€å°åŒ–å½±å“

---

**ç»“è®º**: âœ… æŠ€æœ¯çº¦æŸç¡®è®¤å®Œæ¯•ï¼Œç³»ç»Ÿå…·å¤‡è‰¯å¥½çš„æ‰©å±•åŸºç¡€ï¼Œå¯ä»¥å®‰å…¨å®æ–½è½¨è¿¹ä¸å›´æ åŠŸèƒ½ã€‚