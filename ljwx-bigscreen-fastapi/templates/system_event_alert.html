<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿäº‹ä»¶å‘Šè­¦ç®¡ç† - LJWXä¼ä¸šå¤§å±</title>
    <link href="/static/css/bootstrap-5.1.3.min.css" rel="stylesheet">
    <link href="/static/css/font-awesome-4.7.0.min.css" rel="stylesheet">
    <style>
        .alert-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border-radius:15px;margin-bottom:20px} /* å‘Šè­¦å¡ç‰‡æ ·å¼ */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px} /* ç»Ÿè®¡ç½‘æ ¼ */
        .rule-badge{padding:5px 12px;border-radius:20px;font-size:12px;margin:2px} /* è§„åˆ™å¾½ç«  */
        .critical{background:#dc3545;color:#fff} /* ä¸¥é‡äº‹ä»¶æ ·å¼ */
        .high{background:#fd7e14;color:#fff} /* é«˜çº§äº‹ä»¶æ ·å¼ */
        .medium{background:#ffc107;color:#000} /* ä¸­çº§äº‹ä»¶æ ·å¼ */
        .low{background:#6c757d;color:#fff} /* ä½çº§äº‹ä»¶æ ·å¼ */
        .queue-status{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px} /* é˜Ÿåˆ—çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .pending{background:#ffc107} /* å¾…å¤„ç†çŠ¶æ€ */
        .processing{background:#17a2b8} /* å¤„ç†ä¸­çŠ¶æ€ */
        .completed{background:#28a745} /* å·²å®ŒæˆçŠ¶æ€ */
        .failed{background:#dc3545} /* å¤±è´¥çŠ¶æ€ */
        .config-panel{background:#f8f9fa;border-radius:10px;padding:20px;margin-bottom:20px} /* é…ç½®é¢æ¿æ ·å¼ */
        .btn-group-toggle .btn{margin:0 5px 5px 0} /* æŒ‰é’®ç»„æ ·å¼ */
        .table-responsive{max-height:400px;overflow-y:auto} /* è¡¨æ ¼æ»šåŠ¨ */
        .real-time-indicator{animation:pulse 2s infinite} /* å®æ—¶æŒ‡ç¤ºå™¨åŠ¨ç”» */
        @keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}} /* è„‰å†²åŠ¨ç”» */
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="row">
            <div class="col-12">
                <h2 class="text-primary mb-4"><i class="fa fa-shield"></i> ç³»ç»Ÿäº‹ä»¶å‘Šè­¦ç®¡ç†</h2>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="alert-card text-center p-4">
                <h3 id="totalEvents" class="mb-1">0</h3>
                <p class="mb-0">ä»Šæ—¥äº‹ä»¶æ€»æ•°</p>
            </div>
            <div class="alert-card text-center p-4">
                <h3 id="emergencyEvents" class="mb-1">0</h3>
                <p class="mb-0">ç´§æ€¥äº‹ä»¶</p>
            </div>
            <div class="alert-card text-center p-4">
                <h3 id="queuePending" class="mb-1">0</h3>
                <p class="mb-0">é˜Ÿåˆ—å¾…å¤„ç†</p>
            </div>
            <div class="alert-card text-center p-4">
                <h3 id="responseRate" class="mb-1">0%</h3>
                <p class="mb-0">å“åº”æˆåŠŸç‡</p>
            </div>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <ul class="nav nav-tabs" id="alertTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">
                    <i class="fa fa-cog"></i> äº‹ä»¶è§„åˆ™ç®¡ç†
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">
                    <i class="fa fa-list"></i> å¤„ç†é˜Ÿåˆ—ç›‘æ§
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="wechat-tab" data-bs-toggle="tab" data-bs-target="#wechat" type="button" role="tab">
                    <i class="fa fa-wechat"></i> å¾®ä¿¡é…ç½®
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button" role="tab">
                    <i class="fa fa-flask"></i> æµ‹è¯•ä¸­å¿ƒ
                </button>
            </li>
        </ul>

        <!-- æ ‡ç­¾å†…å®¹ -->
        <div class="tab-content" id="alertTabsContent">
            <!-- äº‹ä»¶è§„åˆ™ç®¡ç† -->
            <div class="tab-pane fade show active" id="rules" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ç³»ç»Ÿäº‹ä»¶è§„åˆ™é…ç½®</h5>
                        <button class="btn btn-primary btn-sm" onclick="addRule()">
                            <i class="fa fa-plus"></i> æ–°å¢è§„åˆ™
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="rulesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>è§„åˆ™ç±»å‹</th>
                                        <th>å®Œæ•´äº‹ä»¶ç±»å‹</th>
                                        <th>å‘Šè­¦çº§åˆ«</th>
                                        <th>é€šçŸ¥æ–¹å¼</th>
                                        <th>å‘Šè­¦æ¶ˆæ¯</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="rulesTableBody">
                                    <!-- åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤„ç†é˜Ÿåˆ—ç›‘æ§ -->
            <div class="tab-pane fade" id="queue" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span class="real-time-indicator">ğŸ”´</span> å®æ—¶å¤„ç†é˜Ÿåˆ—
                        </h5>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="restartProcessor()">
                                <i class="fa fa-refresh"></i> é‡å¯å¤„ç†å™¨
                            </button>
                            <button class="btn btn-info btn-sm" onclick="refreshQueue()">
                                <i class="fa fa-sync"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="queueTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>äº‹ä»¶ç±»å‹</th>
                                        <th>è®¾å¤‡SN</th>
                                        <th>äº‹ä»¶å€¼</th>
                                        <th>å¤„ç†çŠ¶æ€</th>
                                        <th>é‡è¯•æ¬¡æ•°</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="queueTableBody">
                                    <!-- åŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¾®ä¿¡é…ç½® -->
            <div class="tab-pane fade" id="wechat" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="config-panel">
                            <h5><i class="fa fa-building"></i> ä¼ä¸šå¾®ä¿¡é…ç½®</h5>
                            <form id="enterpriseForm">
                                <div class="mb-3">
                                    <label class="form-label">ä¼ä¸šID (CorpID)</label>
                                    <input type="text" class="form-control" id="corpId" placeholder="wx...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">åº”ç”¨AgentID</label>
                                    <input type="text" class="form-control" id="agentId" placeholder="1000002">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">åº”ç”¨Secret</label>
                                    <input type="password" class="form-control" id="enterpriseSecret" placeholder="åº”ç”¨Secret">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="enterpriseEnabled">
                                    <label class="form-check-label">å¯ç”¨ä¼ä¸šå¾®ä¿¡å‘Šè­¦</label>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveWeChatConfig('enterprise')">
                                    <i class="fa fa-save"></i> ä¿å­˜é…ç½®
                                </button>
                                <button type="button" class="btn btn-success" onclick="testWeChatAlert('enterprise')">
                                    <i class="fa fa-test"></i> æµ‹è¯•å‘Šè­¦
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-panel">
                            <h5><i class="fa fa-wechat"></i> å¾®ä¿¡å…¬ä¼—å·é…ç½®</h5>
                            <form id="officialForm">
                                <div class="mb-3">
                                    <label class="form-label">AppID</label>
                                    <input type="text" class="form-control" id="appId" placeholder="wx...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">AppSecret</label>
                                    <input type="password" class="form-control" id="appSecret" placeholder="AppSecret">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ¨¡æ¿æ¶ˆæ¯ID</label>
                                    <input type="text" class="form-control" id="templateId" placeholder="æ¨¡æ¿ID">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="officialEnabled">
                                    <label class="form-check-label">å¯ç”¨å…¬ä¼—å·å‘Šè­¦</label>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="saveWeChatConfig('official')">
                                    <i class="fa fa-save"></i> ä¿å­˜é…ç½®
                                </button>
                                <button type="button" class="btn btn-success" onclick="testWeChatAlert('official')">
                                    <i class="fa fa-test"></i> æµ‹è¯•å‘Šè­¦
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•ä¸­å¿ƒ -->
            <div class="tab-pane fade" id="test" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fa fa-flask"></i> ç³»ç»Ÿäº‹ä»¶æ¨¡æ‹Ÿæµ‹è¯•</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ç´§æ€¥äº‹ä»¶æµ‹è¯•</h6>
                                <div class="btn-group-toggle mb-3">
                                    <button class="btn btn-danger" onclick="testEvent('SOS_EVENT')">SOSç´§æ€¥æ±‚åŠ©</button>
                                    <button class="btn btn-danger" onclick="testEvent('FALLDOWN_EVENT')">è·Œå€’æ£€æµ‹</button>
                                    <button class="btn btn-danger" onclick="testEvent('ONE_KEY_ALARM')">ä¸€é”®æŠ¥è­¦</button>
                                </div>
                                <h6>å¥åº·å‘Šè­¦æµ‹è¯•</h6>
                                <div class="btn-group-toggle mb-3">
                                    <button class="btn btn-warning" onclick="testEvent('HEARTRATE_HIGH_ALERT')">å¿ƒç‡è¿‡é«˜</button>
                                    <button class="btn btn-warning" onclick="testEvent('SPO2_LOW_ALERT')">è¡€æ°§è¿‡ä½</button>
                                    <button class="btn btn-warning" onclick="testEvent('TEMPERATURE_HIGH_ALERT')">ä½“æ¸©è¿‡é«˜</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>ç³»ç»Ÿäº‹ä»¶æµ‹è¯•</h6>
                                <div class="btn-group-toggle mb-3">
                                    <button class="btn btn-info" onclick="testEvent('WEAR_STATUS_CHANGED')">ä½©æˆ´çŠ¶æ€</button>
                                    <button class="btn btn-info" onclick="testEvent('BOOT_COMPLETED')">è®¾å¤‡å¯åŠ¨</button>
                                    <button class="btn btn-info" onclick="testEvent('CALL_STATE')">é€šè¯çŠ¶æ€</button>
                                </div>
                                <h6>è‡ªå®šä¹‰æµ‹è¯•</h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control mb-2" id="customEventType" placeholder="äº‹ä»¶ç±»å‹(å¦‚:SOS_EVENT)">
                                    <input type="text" class="form-control mb-2" id="customDeviceSn" placeholder="è®¾å¤‡SN" value="TEST_DEVICE_001">
                                    <input type="text" class="form-control mb-2" id="customEventValue" placeholder="äº‹ä»¶å€¼">
                                    <button class="btn btn-primary" onclick="testCustomEvent()">å‘é€è‡ªå®šä¹‰äº‹ä»¶</button>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>è¯´æ˜ï¼š</strong>æµ‹è¯•äº‹ä»¶å°†ç›´æ¥è§¦å‘å‘Šè­¦å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬å¾®ä¿¡æ¨é€å’Œæ¶ˆæ¯é€šçŸ¥ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®é…ç½®å¾®ä¿¡å‚æ•°ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="ruleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ruleModalTitle">ç¼–è¾‘è§„åˆ™</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ruleForm">
                        <input type="hidden" id="ruleId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">è§„åˆ™ç±»å‹*</label>
                                    <input type="text" class="form-control" id="ruleType" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å‘Šè­¦çº§åˆ«*</label>
                                    <select class="form-select" id="severityLevel" required>
                                        <option value="critical">ä¸¥é‡(Critical)</option>
                                        <option value="high">é«˜(High)</option>
                                        <option value="medium">ä¸­(Medium)</option>
                                        <option value="low">ä½(Low)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å®Œæ•´äº‹ä»¶ç±»å‹*</label>
                            <input type="text" class="form-control" id="eventType" placeholder="å¦‚:com.tdtech.ohos.health.action.SOS_EVENT" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å‘Šè­¦æ¶ˆæ¯æ¨¡æ¿*</label>
                            <textarea class="form-control" id="alertMessage" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">é€šçŸ¥ç±»å‹*</label>
                                    <select class="form-select" id="notificationType" required>
                                        <option value="message">å¹³å°æ¶ˆæ¯</option>
                                        <option value="wechat">å¾®ä¿¡æ¨é€</option>
                                        <option value="both">åŒé‡é€šçŸ¥</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">é‡è¯•æ¬¡æ•°</label>
                                    <input type="number" class="form-control" id="retryCount" value="3" min="0" max="10">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isEmergency">
                            <label class="form-check-label">ç´§æ€¥äº‹ä»¶(ä¼˜å…ˆå¾®ä¿¡æ¨é€)</label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" checked>
                            <label class="form-check-label">å¯ç”¨è§„åˆ™</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveRule()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap-5.1.3.bundle.min.js"></script>
    <script>
        let currentTenantId=1; // å½“å‰ç§Ÿæˆ·ID

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded',function(){
            loadStats();loadRules();loadWeChatConfig();
            setInterval(()=>{loadStats();if(document.querySelector('#queue-tab').classList.contains('active'))loadQueue()},5000); // 5ç§’åˆ·æ–°ç»Ÿè®¡
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats(){
            try{
                const response=await fetch('/api/system-event/queue/stats');
                const data=await response.json();
                if(data.code===200){
                    document.getElementById('totalEvents').textContent=data.data.total_events||0;
                    document.getElementById('emergencyEvents').textContent=data.data.emergency_events||0;
                    document.getElementById('queuePending').textContent=data.data.pending_count||0;
                    document.getElementById('responseRate').textContent=(data.data.success_rate||0)+'%';
                }
            }catch(e){console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:',e)}
        }

        // åŠ è½½äº‹ä»¶è§„åˆ™
        async function loadRules(){
            try{
                const response=await fetch('/api/system-event/rules');
                const data=await response.json();
                if(data.code===200){
                    const tbody=document.getElementById('rulesTableBody');
                    tbody.innerHTML=data.data.map(rule=>`
                        <tr>
                            <td><span class="rule-badge ${rule.severity_level}">${rule.rule_type}</span></td>
                            <td class="text-muted small">${rule.event_type}</td>
                            <td><span class="rule-badge ${rule.severity_level}">${rule.severity_level}</span></td>
                            <td><span class="badge bg-${rule.notification_type==='wechat'?'success':rule.notification_type==='both'?'primary':'secondary'}">${rule.notification_type}</span></td>
                            <td class="text-truncate" style="max-width:200px" title="${rule.alert_message}">${rule.alert_message}</td>
                            <td><span class="badge bg-${rule.is_active?'success':'danger'}">${rule.is_active?'å¯ç”¨':'ç¦ç”¨'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editRule(${rule.id})">ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRule(${rule.id})">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }catch(e){console.error('åŠ è½½è§„åˆ™å¤±è´¥:',e)}
        }

        // åŠ è½½å¤„ç†é˜Ÿåˆ—
        async function loadQueue(){
            try{
                const response=await fetch('/api/system-event/queue/stats?detail=true');
                const data=await response.json();
                if(data.code===200){
                    const tbody=document.getElementById('queueTableBody');
                    tbody.innerHTML=(data.data.queue_items||[]).map(item=>`
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.event_type}</td>
                            <td>${item.device_sn}</td>
                            <td class="text-truncate" style="max-width:150px">${item.event_value||'-'}</td>
                            <td><span class="queue-status ${item.processing_status}"></span>${item.processing_status}</td>
                            <td>${item.retry_count}/3</td>
                            <td>${item.create_time}</td>
                            <td>
                                ${item.processing_status==='failed'?`<button class="btn btn-sm btn-warning" onclick="retryQueueItem(${item.id})">é‡è¯•</button>`:''}
                            </td>
                        </tr>
                    `).join('');
                }
            }catch(e){console.error('åŠ è½½é˜Ÿåˆ—å¤±è´¥:',e)}
        }

        // åŠ è½½å¾®ä¿¡é…ç½®
        async function loadWeChatConfig(){
            try{
                const response=await fetch('/api/wechat-alarm/config');
                const data=await response.json();
                if(data.code===200){
                    data.data.forEach(config=>{
                        if(config.type==='enterprise'){
                            document.getElementById('corpId').value=config.corp_id||'';
                            document.getElementById('agentId').value=config.agent_id||'';
                            document.getElementById('enterpriseSecret').value=config.secret||'';
                            document.getElementById('enterpriseEnabled').checked=config.enabled;
                        }else if(config.type==='official'){
                            document.getElementById('appId').value=config.appid||'';
                            document.getElementById('appSecret').value=config.appsecret||'';
                            document.getElementById('templateId').value=config.template_id||'';
                            document.getElementById('officialEnabled').checked=config.enabled;
                        }
                    });
                }
            }catch(e){console.error('åŠ è½½å¾®ä¿¡é…ç½®å¤±è´¥:',e)}
        }

        // ä¿å­˜å¾®ä¿¡é…ç½®
        async function saveWeChatConfig(type){
            const formData=type==='enterprise'?{
                type,corp_id:document.getElementById('corpId').value,
                agent_id:document.getElementById('agentId').value,
                secret:document.getElementById('enterpriseSecret').value,
                enabled:document.getElementById('enterpriseEnabled').checked
            }:{
                type,appid:document.getElementById('appId').value,
                appsecret:document.getElementById('appSecret').value,
                template_id:document.getElementById('templateId').value,
                enabled:document.getElementById('officialEnabled').checked
            };
            try{
                const response=await fetch('/api/wechat-alarm/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)});
                const data=await response.json();
                alert(data.message||'ä¿å­˜æˆåŠŸ');
            }catch(e){alert('ä¿å­˜å¤±è´¥:'+e.message)}
        }

        // æµ‹è¯•å¾®ä¿¡å‘Šè­¦
        async function testWeChatAlert(type){
            try{
                const response=await fetch('/api/wechat-alarm/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,message:'ç³»ç»Ÿæµ‹è¯•å‘Šè­¦æ¶ˆæ¯'})});
                const data=await response.json();
                alert(data.message||'æµ‹è¯•å®Œæˆ');
            }catch(e){alert('æµ‹è¯•å¤±è´¥:'+e.message)}
        }

        // æµ‹è¯•äº‹ä»¶
        async function testEvent(eventType){
            const testData={event_type:`com.tdtech.ohos.health.action.${eventType}`,device_sn:'TEST_DEVICE_001',event_value:'æµ‹è¯•å€¼',timestamp:Date.now()};
            try{
                const response=await fetch('/upload_common_event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(testData)});
                const data=await response.json();
                alert(`äº‹ä»¶æµ‹è¯•: ${data.message||'å·²å‘é€'}`);
                setTimeout(loadStats,1000);
            }catch(e){alert('æµ‹è¯•å¤±è´¥:'+e.message)}
        }

        // è‡ªå®šä¹‰äº‹ä»¶æµ‹è¯•
        function testCustomEvent(){
            const eventType=document.getElementById('customEventType').value;
            const deviceSn=document.getElementById('customDeviceSn').value;
            const eventValue=document.getElementById('customEventValue').value;
            if(!eventType||!deviceSn)return alert('è¯·å¡«å†™äº‹ä»¶ç±»å‹å’Œè®¾å¤‡SN');
            testEvent(eventType.replace('com.tdtech.ohos.health.action.','').replace('com.tdtech.ohos.action.',''));
        }

        // æ–°å¢è§„åˆ™
        function addRule(){
            document.getElementById('ruleModalTitle').textContent='æ–°å¢äº‹ä»¶è§„åˆ™';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleId').value='';
            new bootstrap.Modal(document.getElementById('ruleModal')).show();
        }

        // ç¼–è¾‘è§„åˆ™
        async function editRule(id){
            try{
                const response=await fetch(`/api/system-event/rules/${id}`);
                const data=await response.json();
                if(data.code===200){
                    const rule=data.data;
                    document.getElementById('ruleModalTitle').textContent='ç¼–è¾‘äº‹ä»¶è§„åˆ™';
                    document.getElementById('ruleId').value=rule.id;
                    document.getElementById('ruleType').value=rule.rule_type;
                    document.getElementById('eventType').value=rule.event_type;
                    document.getElementById('severityLevel').value=rule.severity_level;
                    document.getElementById('alertMessage').value=rule.alert_message;
                    document.getElementById('notificationType').value=rule.notification_type;
                    document.getElementById('retryCount').value=rule.retry_count;
                    document.getElementById('isEmergency').checked=rule.is_emergency;
                    document.getElementById('isActive').checked=rule.is_active;
                    new bootstrap.Modal(document.getElementById('ruleModal')).show();
                }
            }catch(e){alert('åŠ è½½è§„åˆ™å¤±è´¥:'+e.message)}
        }

        // ä¿å­˜è§„åˆ™
        async function saveRule(){
            const formData=new FormData(document.getElementById('ruleForm'));
            const data={
                rule_type:document.getElementById('ruleType').value,
                event_type:document.getElementById('eventType').value,
                severity_level:document.getElementById('severityLevel').value,
                alert_message:document.getElementById('alertMessage').value,
                notification_type:document.getElementById('notificationType').value,
                retry_count:parseInt(document.getElementById('retryCount').value),
                is_emergency:document.getElementById('isEmergency').checked,
                is_active:document.getElementById('isActive').checked
            };
            const id=document.getElementById('ruleId').value;
            try{
                const url=id?`/api/system-event/rules/${id}`:'/api/system-event/rules';
                const method=id?'PUT':'POST';
                const response=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                const result=await response.json();
                alert(result.message||'ä¿å­˜æˆåŠŸ');
                bootstrap.Modal.getInstance(document.getElementById('ruleModal')).hide();
                loadRules();
            }catch(e){alert('ä¿å­˜å¤±è´¥:'+e.message)}
        }

        // åˆ é™¤è§„åˆ™
        async function deleteRule(id){
            if(!confirm('ç¡®å®šåˆ é™¤æ­¤è§„åˆ™å—ï¼Ÿ'))return;
            try{
                const response=await fetch(`/api/system-event/rules/${id}`,{method:'DELETE'});
                const data=await response.json();
                alert(data.message||'åˆ é™¤æˆåŠŸ');
                loadRules();
            }catch(e){alert('åˆ é™¤å¤±è´¥:'+e.message)}
        }

        // é‡å¯å¤„ç†å™¨
        async function restartProcessor(){
            try{
                const response=await fetch('/api/system-event/processor/restart',{method:'POST'});
                const data=await response.json();
                alert(data.message||'é‡å¯æˆåŠŸ');
            }catch(e){alert('é‡å¯å¤±è´¥:'+e.message)}
        }

        // åˆ·æ–°é˜Ÿåˆ—
        function refreshQueue(){loadQueue()}

        // é‡è¯•é˜Ÿåˆ—é¡¹
        async function retryQueueItem(id){
            try{
                const response=await fetch(`/api/system-event/queue/${id}/retry`,{method:'POST'});
                const data=await response.json();
                alert(data.message||'é‡è¯•æˆåŠŸ');
                loadQueue();
            }catch(e){alert('é‡è¯•å¤±è´¥:'+e.message)}
        }

        // æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
        document.getElementById('queue-tab').addEventListener('shown.bs.tab',loadQueue);
    </script>
</body>
</html> 