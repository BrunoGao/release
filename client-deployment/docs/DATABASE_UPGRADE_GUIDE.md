# æ™ºèƒ½ç©¿æˆ´ç³»ç»Ÿæ•°æ®åº“å‡çº§æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†æ™ºèƒ½ç©¿æˆ´ç³»ç»Ÿå®¢æˆ·ç°åœºæ•°æ®åº“å‡çº§çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚è¯¥æ–¹æ¡ˆæ—¨åœ¨ä¸ºç°æœ‰å®¢æˆ·æä¾›å®‰å…¨ã€å¯é ã€å¯å›æ»šçš„æ•°æ®åº“å‡çº§ä½“éªŒã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”§ æ™ºèƒ½ç‰ˆæœ¬ç®¡ç†
- **è‡ªåŠ¨ç‰ˆæœ¬æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«ç°ç½‘æ•°æ®åº“ç‰ˆæœ¬
- **ç‰ˆæœ¬è®°å½•è¿½è¸ª**: å®Œæ•´çš„å‡çº§å†å²è®°å½•
- **è¿ç§»è„šæœ¬ç®¡ç†**: æŒ‰ç‰ˆæœ¬è‡ªåŠ¨åº”ç”¨è¿ç§»è„šæœ¬

### ğŸ›¡ï¸ å®‰å…¨ä¿éšœæœºåˆ¶
- **å®Œæ•´æ•°æ®å¤‡ä»½**: å‡çº§å‰è‡ªåŠ¨åˆ›å»ºå®Œæ•´å¤‡ä»½
- **åŸå­äº‹åŠ¡æ‰§è¡Œ**: ç¡®ä¿å‡çº§è¿‡ç¨‹çš„ä¸€è‡´æ€§
- **å¥åº·æ£€æŸ¥éªŒè¯**: å‡çº§å‰åå®Œæ•´çš„å¥åº·æ£€æŸ¥
- **ä¸€é”®å›æ»šåŠŸèƒ½**: å‡çº§å¤±è´¥è‡ªåŠ¨å›æ»š

### ğŸ“Š å¯è§‚æµ‹æ€§
- **è¯¦ç»†å‡çº§æ—¥å¿—**: å®Œæ•´çš„å‡çº§è¿‡ç¨‹è®°å½•
- **å‡çº§çŠ¶æ€æŠ¥å‘Š**: è‡ªåŠ¨ç”Ÿæˆå‡çº§æŠ¥å‘Š
- **æ€§èƒ½ç›‘æ§**: å‡çº§è¿‡ç¨‹æ€§èƒ½æŒ‡æ ‡

## ç›®å½•ç»“æ„

```
client-deployment/
â”œâ”€â”€ database-upgrade-manager.sh     # ä¸»å‡çº§ç®¡ç†è„šæœ¬
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ migrations/                 # è¿ç§»è„šæœ¬ç›®å½•
â”‚   â”‚   â”œâ”€â”€ 003_create_weight_cache_table.sql
â”‚   â”‚   â”œâ”€â”€ 004_optimize_health_baseline_for_userid.sql
â”‚   â”‚   â”œâ”€â”€ 005_create_message_v2_tables.sql
â”‚   â”‚   â””â”€â”€ 006_alert_auto_process_enhancement_fixed.sql
â”‚   â””â”€â”€ upgrade_1.0.0_to_1.1.0.sql  # ç‰ˆæœ¬ç‰¹å®šå‡çº§è„šæœ¬
â”œâ”€â”€ backup/
â”‚   â””â”€â”€ database-upgrade/           # å‡çº§å¤‡ä»½ç›®å½•
â””â”€â”€ logs/
    â””â”€â”€ database-upgrade/           # å‡çº§æ—¥å¿—ç›®å½•
```

## å¿«é€Ÿå¼€å§‹

### 1. æ£€æŸ¥å½“å‰æ•°æ®åº“ç‰ˆæœ¬

```bash
# æŸ¥çœ‹å½“å‰æ•°æ®åº“ç‰ˆæœ¬çŠ¶æ€
./database-upgrade-manager.sh status
```

### 2. æ‰§è¡Œæ•°æ®åº“å‡çº§

```bash
# ä»ç‰ˆæœ¬ 1.0.0 å‡çº§åˆ° 1.1.0
./database-upgrade-manager.sh upgrade 1.0.0 1.1.0
```

### 3. éªŒè¯å‡çº§ç»“æœ

å‡çº§å®Œæˆåï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆå‡çº§æŠ¥å‘Šå’Œæ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚

## è¯¦ç»†ä½¿ç”¨æŒ‡å—

### å‘½ä»¤è¡Œæ¥å£

```bash
# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
./database-upgrade-manager.sh help

# æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬å’ŒçŠ¶æ€
./database-upgrade-manager.sh status

# æ‰§è¡Œæ•°æ®åº“å‡çº§
./database-upgrade-manager.sh upgrade [æºç‰ˆæœ¬] [ç›®æ ‡ç‰ˆæœ¬]

# å›æ»šåˆ°å‡çº§å‰çŠ¶æ€
./database-upgrade-manager.sh rollback
```

### é…ç½®æ–‡ä»¶

è„šæœ¬é»˜è®¤è¯»å– `custom-config.env` é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®é…ç½®ï¼š

```bash
# MySQL é…ç½®
MYSQL_CONTAINER=ljwx-mysql
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=lj-06

# å¤‡ä»½é…ç½®
BACKUP_DIR=backup/database-upgrade
LOG_DIR=logs/database-upgrade
```

### å‡çº§å‰å‡†å¤‡

#### 1. ç¯å¢ƒæ£€æŸ¥

ç¡®ä¿ä»¥ä¸‹æ¡ä»¶æ»¡è¶³ï¼š

- [x] MySQL å®¹å™¨æ­£å¸¸è¿è¡Œ
- [x] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [x] ç£ç›˜ç©ºé—´å……è¶³ (å»ºè®®é¢„ç•™ > 15%)
- [x] å¤‡ä»½ç›®å½•å¯å†™
- [x] æ—¥å¿—ç›®å½•å¯å†™

#### 2. åœæ­¢åº”ç”¨æœåŠ¡ï¼ˆå¯é€‰ï¼‰

ä¸ºé¿å…å‡çº§è¿‡ç¨‹ä¸­çš„æ•°æ®å†²çªï¼Œå»ºè®®åœæ­¢åº”ç”¨æœåŠ¡ï¼š

```bash
docker stop ljwx-boot ljwx-admin ljwx-bigscreen
```

### å‡çº§æµç¨‹è¯¦è§£

#### æ­¥éª¤ 1: å¥åº·æ£€æŸ¥

```bash
[10:30:15] ğŸ” æ‰§è¡Œå‡çº§å‰å¥åº·æ£€æŸ¥...
[10:30:16] âœ… å¥åº·æ£€æŸ¥é€šè¿‡
```

- æ£€æŸ¥ MySQL å®¹å™¨çŠ¶æ€
- éªŒè¯æ•°æ®åº“è¿æ¥
- æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡
- è¯„ä¼°æ•°æ®åº“å¤§å°

#### æ­¥éª¤ 2: æ•°æ®å¤‡ä»½

```bash
[10:30:16] ğŸ“¦ åˆ›å»ºæ•°æ®åº“å¤‡ä»½...
[10:30:25] âœ… æ•°æ®å¤‡ä»½å®Œæˆ: pre_upgrade_20250911_103025.sql.gz (45MB)
```

- åˆ›å»ºå®Œæ•´çš„æ•°æ®åº“å¤‡ä»½
- å¤‡ä»½è¡¨ç»“æ„æ–‡ä»¶
- ä¿å­˜å¤‡ä»½è·¯å¾„ä¾›å›æ»šä½¿ç”¨

#### æ­¥éª¤ 3: æ‰§è¡Œè¿ç§»è„šæœ¬

```bash
[10:30:25] ğŸ“ æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬...
[10:30:26] æ‰§è¡Œè¿ç§»è„šæœ¬: 006_alert_auto_process_enhancement_fixed.sql
[10:30:27] âœ… 006_alert_auto_process_enhancement_fixed.sql æ‰§è¡ŒæˆåŠŸ
[10:30:27] æ‰§è¡Œè¿ç§»è„šæœ¬: upgrade_1.0.0_to_1.1.0.sql
[10:30:30] âœ… upgrade_1.0.0_to_1.1.0.sql æ‰§è¡ŒæˆåŠŸ
```

#### æ­¥éª¤ 4: æ•°æ®å®Œæ•´æ€§éªŒè¯

```bash
[10:30:30] ğŸ” éªŒè¯æ•°æ®åº“å®Œæ•´æ€§...
[10:30:31] æ•°æ®åº“åŒ…å« 45 ä¸ªè¡¨
[10:30:31] âœ… è¡¨ sys_user: 125 æ¡è®°å½•
[10:30:31] âœ… è¡¨ sys_dict: 89 æ¡è®°å½•
[10:30:31] âœ… è¡¨ t_alert_rules: 23 æ¡è®°å½•
```

#### æ­¥éª¤ 5: æ€§èƒ½ä¼˜åŒ–

```bash
[10:30:32] âš¡ æ‰§è¡Œæ•°æ®åº“æ€§èƒ½ä¼˜åŒ–...
[10:30:35] âœ… æ•°æ®åº“ä¼˜åŒ–å®Œæˆ
```

#### æ­¥éª¤ 6: ç”ŸæˆæŠ¥å‘Š

```bash
[10:30:35] ğŸ“‹ ç”Ÿæˆå‡çº§æŠ¥å‘Š...
[10:30:36] âœ… å‡çº§æŠ¥å‘Šå·²ç”Ÿæˆ: logs/database-upgrade/upgrade_report_20250911_103025.md
```

## ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

### ç‰ˆæœ¬è¡¨ç»“æ„

ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º `database_version` è¡¨è®°å½•å‡çº§å†å²ï¼š

```sql
CREATE TABLE database_version (
    id INT AUTO_INCREMENT PRIMARY KEY,
    version VARCHAR(20) NOT NULL,
    description TEXT,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    applied_by VARCHAR(100) DEFAULT 'system',
    migration_files TEXT COMMENT 'åº”ç”¨çš„è¿ç§»æ–‡ä»¶åˆ—è¡¨'
);
```

### ç‰ˆæœ¬æ£€æµ‹é€»è¾‘

1. **é¦–æ¬¡å®‰è£…**: è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬è¡¨ï¼Œè®¾ç½®åˆå§‹ç‰ˆæœ¬ä¸º `1.0.0`
2. **ç‰ˆæœ¬æ£€æµ‹**: ä»ç‰ˆæœ¬è¡¨è¯»å–å½“å‰ç‰ˆæœ¬
3. **ç‰ˆæœ¬éªŒè¯**: ç¡®ä¿æºç‰ˆæœ¬ä¸å½“å‰ç‰ˆæœ¬ä¸€è‡´

### è¿ç§»è„šæœ¬ç®¡ç†

#### è„šæœ¬å‘½åè§„èŒƒ

- **é€šç”¨è¿ç§»è„šæœ¬**: `database/migrations/XXX_description.sql`
- **ç‰ˆæœ¬ç‰¹å®šè„šæœ¬**: `database/upgrade_[æºç‰ˆæœ¬]_to_[ç›®æ ‡ç‰ˆæœ¬].sql`

#### è„šæœ¬æ‰§è¡Œé¡ºåº

1. æŒ‰æ–‡ä»¶åæ’åºæ‰§è¡Œ `migrations/` ç›®å½•ä¸­çš„è„šæœ¬
2. æ‰§è¡Œç‰ˆæœ¬ç‰¹å®šçš„å‡çº§è„šæœ¬
3. æ›´æ–°ç‰ˆæœ¬è®°å½•

## å¤‡ä»½ä¸æ¢å¤

### è‡ªåŠ¨å¤‡ä»½ç­–ç•¥

æ¯æ¬¡å‡çº§å‰è‡ªåŠ¨åˆ›å»ºï¼š

1. **å®Œæ•´æ•°æ®å¤‡ä»½**: `pre_upgrade_[æ—¶é—´æˆ³].sql.gz`
2. **è¡¨ç»“æ„å¤‡ä»½**: `structure_[æ—¶é—´æˆ³].sql`
3. **å¤‡ä»½è·¯å¾„è®°å½•**: `latest_backup.path`

### æ‰‹åŠ¨å¤‡ä»½

```bash
# ä½¿ç”¨ç°æœ‰çš„å¤‡ä»½è„šæœ¬
./auto-backup.sh

# æˆ–ä½¿ç”¨ MySQL åŸç”Ÿå¤‡ä»½
docker exec ljwx-mysql mysqldump -uroot -p123456 --single-transaction --routines --triggers --events lj-06 | gzip > manual_backup.sql.gz
```

### å›æ»šæ“ä½œ

#### è‡ªåŠ¨å›æ»š

å‡çº§å¤±è´¥æ—¶ä¼šè‡ªåŠ¨è§¦å‘å›æ»šï¼š

```bash
[10:35:15] ğŸ”„ å¼€å§‹æ•°æ®åº“å›æ»šæ“ä½œ...
[10:35:25] âœ… æ•°æ®åº“å›æ»šæˆåŠŸ
[10:35:30] âœ… å›æ»šæ“ä½œå®Œæˆ
```

#### æ‰‹åŠ¨å›æ»š

```bash
# å›æ»šåˆ°å‡çº§å‰çŠ¶æ€
./database-upgrade-manager.sh rollback
```

#### å›æ»šæµç¨‹

1. åœæ­¢åº”ç”¨æœåŠ¡
2. ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®åº“
3. é‡å¯åº”ç”¨æœåŠ¡
4. éªŒè¯å›æ»šç»“æœ

## æ”¯æŒçš„å‡çº§è·¯å¾„

### å½“å‰ç‰ˆæœ¬å‡çº§çŸ©é˜µ

| æºç‰ˆæœ¬ | ç›®æ ‡ç‰ˆæœ¬ | å‡çº§è„šæœ¬ | çŠ¶æ€ |
|--------|----------|----------|------|
| 1.0.0  | 1.1.0    | âœ… å¯ç”¨   | å·²æµ‹è¯• |
| 1.1.0  | 1.2.0    | ğŸš§ å¼€å‘ä¸­ | è®¡åˆ’ä¸­ |

### ç‰ˆæœ¬æ›´æ–°å†…å®¹

#### v1.1.0 æ›´æ–°å†…å®¹

**åŠŸèƒ½å¢å¼º**:
- âœ… å‘Šè­¦è‡ªåŠ¨å¤„ç†åŠŸèƒ½
- âœ… æƒé‡é…ç½®ç¼“å­˜ç³»ç»Ÿ
- âœ… æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

**æ•°æ®åº“å˜æ›´**:
- æ–°å¢ `t_weight_cache` è¡¨
- `t_alert_rules` è¡¨å¢åŠ è‡ªåŠ¨å¤„ç†å­—æ®µ
- `t_alert_info` è¡¨å¢åŠ å¤„ç†è·Ÿè¸ªå­—æ®µ
- æ–°å¢å¤šä¸ªæ€§èƒ½ä¼˜åŒ–ç´¢å¼•

**è¿ç§»è„šæœ¬**:
- `006_alert_auto_process_enhancement_fixed.sql`
- `upgrade_1.0.0_to_1.1.0.sql`

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å‡çº§å¤±è´¥ï¼šæƒé™ä¸è¶³

**é—®é¢˜**: 
```
[ERROR] æ•°æ®å¤‡ä»½å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å¤‡ä»½ç›®å½•æƒé™
chmod 755 backup/database-upgrade/
chown $(whoami):$(whoami) backup/database-upgrade/

# æ£€æŸ¥ MySQL å®¹å™¨çŠ¶æ€
docker ps | grep ljwx-mysql
```

#### 2. å‡çº§å¤±è´¥ï¼šç£ç›˜ç©ºé—´ä¸è¶³

**é—®é¢˜**:
```
[WARN] ç£ç›˜ä½¿ç”¨ç‡ 88%ï¼Œå»ºè®®æ¸…ç†ç©ºé—´
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…ç† Docker é•œåƒ
docker image prune -f

# æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶
find backup/ -name "*.sql.gz" -mtime +30 -delete

# æ¸…ç† Docker æ—¥å¿—
docker system prune -f
```

#### 3. è¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥

**é—®é¢˜**:
```
[ERROR] 006_alert_auto_process_enhancement_fixed.sql æ‰§è¡Œå¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ‰‹åŠ¨æ£€æŸ¥è„šæœ¬å†…å®¹
cat database/migrations/006_alert_auto_process_enhancement_fixed.sql

# æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬æµ‹è¯•
docker exec -i ljwx-mysql mysql -uroot -p123456 lj-06 < database/migrations/006_alert_auto_process_enhancement_fixed.sql

# æ£€æŸ¥è¡¨ç»“æ„
docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "DESCRIBE t_alert_rules;"
```

#### 4. å›æ»šå¤±è´¥

**é—®é¢˜**:
```
[ERROR] å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: backup/database-upgrade/pre_upgrade_xxx.sql.gz
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
ls -la backup/database-upgrade/

# ä½¿ç”¨æœ€æ–°å¯ç”¨å¤‡ä»½
ls -t backup/database-upgrade/*.sql.gz | head -1

# æ‰‹åŠ¨æŒ‡å®šå¤‡ä»½æ–‡ä»¶æ¢å¤
zcat backup/database-upgrade/[å¤‡ä»½æ–‡ä»¶] | docker exec -i ljwx-mysql mysql -uroot -p123456
```

### æ—¥å¿—åˆ†æ

#### å‡çº§æ—¥å¿—ä½ç½®

```bash
# æŸ¥çœ‹æœ€æ–°å‡çº§æ—¥å¿—
tail -f logs/database-upgrade/upgrade_*.log

# æŸ¥çœ‹å‡çº§æŠ¥å‘Š
cat logs/database-upgrade/upgrade_report_*.md
```

#### å…³é”®æ—¥å¿—æ¨¡å¼

```bash
# æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯
grep "ERROR" logs/database-upgrade/upgrade_*.log

# æŸ¥æ‰¾è­¦å‘Šä¿¡æ¯
grep "WARN" logs/database-upgrade/upgrade_*.log

# æŸ¥çœ‹æ‰§è¡Œæ—¶é—´
grep "æ‰§è¡Œæ—¶é—´" logs/database-upgrade/upgrade_*.log
```

## æ€§èƒ½è€ƒè™‘

### å‡çº§æ—¶é—´é¢„ä¼°

| æ•°æ®åº“å¤§å° | é¢„ä¼°å‡çº§æ—¶é—´ | å¤‡ä»½æ—¶é—´ | è¿ç§»æ—¶é—´ |
|-----------|-------------|----------|----------|
| < 100MB   | 1-2 åˆ†é’Ÿ    | 10-20ç§’  | 30-60ç§’  |
| 100MB-1GB | 3-8 åˆ†é’Ÿ    | 1-2åˆ†é’Ÿ  | 2-5åˆ†é’Ÿ  |
| 1GB-10GB  | 10-30 åˆ†é’Ÿ  | 3-8åˆ†é’Ÿ  | 5-15åˆ†é’Ÿ |
| > 10GB    | 30+ åˆ†é’Ÿ    | 10+åˆ†é’Ÿ  | 15+åˆ†é’Ÿ  |

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### å‡çº§å‰ä¼˜åŒ–

```bash
# æ¸…ç†æ— ç”¨æ•°æ®
docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "
DELETE FROM t_alert_info WHERE create_time < DATE_SUB(NOW(), INTERVAL 6 MONTH);
OPTIMIZE TABLE t_alert_info;
"

# é‡Šæ”¾ç£ç›˜ç©ºé—´
docker exec ljwx-mysql mysql -uroot -p123456 -e "PURGE BINARY LOGS BEFORE NOW();"
```

#### å‡çº§åä¼˜åŒ–

```bash
# åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "
ANALYZE TABLE t_alert_rules, t_alert_info, t_weight_cache;
"

# æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "
SHOW INDEX FROM t_alert_info;
"
```

## é›†æˆåˆ°ç°æœ‰éƒ¨ç½²æµç¨‹

### ä¿®æ”¹ deploy-client.sh

åœ¨ç°æœ‰éƒ¨ç½²è„šæœ¬ä¸­é›†æˆæ•°æ®åº“å‡çº§æ£€æŸ¥ï¼š

```bash
# åœ¨ deploy-client.sh ä¸­æ·»åŠ å‡çº§æ£€æŸ¥
if ! is_first_deployment; then
    echo "ğŸ”„ æ£€æµ‹åˆ°å‡çº§éƒ¨ç½²ï¼Œæ‰§è¡Œæ•°æ®åº“å‡çº§æ£€æŸ¥..."
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦æ•°æ®åº“å‡çº§
    CURRENT_DB_VERSION=$(./database-upgrade-manager.sh status | grep "å½“å‰æ•°æ®åº“ç‰ˆæœ¬" | cut -d: -f2 | xargs)
    TARGET_DB_VERSION="1.1.0"  # ä»é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¯»å–
    
    if [ "$CURRENT_DB_VERSION" != "$TARGET_DB_VERSION" ]; then
        echo "æ•°æ®åº“éœ€è¦ä» $CURRENT_DB_VERSION å‡çº§åˆ° $TARGET_DB_VERSION"
        
        if confirm "æ˜¯å¦æ‰§è¡Œæ•°æ®åº“å‡çº§ï¼Ÿ"; then
            ./database-upgrade-manager.sh upgrade "$CURRENT_DB_VERSION" "$TARGET_DB_VERSION"
        else
            echo "è·³è¿‡æ•°æ®åº“å‡çº§"
        fi
    else
        echo "æ•°æ®åº“ç‰ˆæœ¬å·²æ˜¯æœ€æ–°: $CURRENT_DB_VERSION"
    fi
fi
```

### è‡ªåŠ¨åŒ–å‡çº§æµç¨‹

åˆ›å»ºå‡çº§æ£€æŸ¥è„šæœ¬ `check-upgrade.sh`ï¼š

```bash
#!/bin/bash
# è‡ªåŠ¨æ£€æŸ¥å’Œæ‰§è¡Œå‡çº§

# è¯»å–é…ç½®ä¸­çš„ç›®æ ‡ç‰ˆæœ¬
TARGET_VERSION=$(grep "DB_VERSION=" custom-config.env | cut -d= -f2)
CURRENT_VERSION=$(./database-upgrade-manager.sh status | grep "å½“å‰æ•°æ®åº“ç‰ˆæœ¬" | cut -d: -f2 | xargs)

if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
    echo "æ£€æµ‹åˆ°æ•°æ®åº“ç‰ˆæœ¬å·®å¼‚ï¼Œå¯åŠ¨å‡çº§æµç¨‹..."
    ./database-upgrade-manager.sh upgrade "$CURRENT_VERSION" "$TARGET_VERSION"
else
    echo "æ•°æ®åº“ç‰ˆæœ¬å·²æ˜¯æœ€æ–°"
fi
```

## æœ€ä½³å®è·µ

### 1. å‡çº§å‰å‡†å¤‡æ¸…å•

- [ ] ç¡®è®¤æœåŠ¡è¿è¡ŒçŠ¶æ€æ­£å¸¸
- [ ] éªŒè¯æ•°æ®åº“è¿æ¥å’Œæƒé™
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´å……è¶³ (>20% å¯ç”¨ç©ºé—´)
- [ ] å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
- [ ] é€šçŸ¥ç›¸å…³äººå‘˜å‡çº§è®¡åˆ’
- [ ] å‡†å¤‡å›æ»šè®¡åˆ’

### 2. å‡çº§æ‰§è¡Œ

- [ ] é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
- [ ] åœæ­¢éå¿…è¦åº”ç”¨æœåŠ¡
- [ ] ç›‘æ§å‡çº§è¿‡ç¨‹æ—¥å¿—
- [ ] éªŒè¯å‡çº§ååŠŸèƒ½æ­£å¸¸
- [ ] æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡

### 3. å‡çº§åéªŒè¯

```bash
# åŠŸèƒ½éªŒè¯è„šæœ¬
#!/bin/bash
echo "å¼€å§‹å‡çº§åéªŒè¯..."

# 1. æ•°æ®åº“è¿æ¥æµ‹è¯•
if docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "SELECT 1;" &>/dev/null; then
    echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
else
    echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
    exit 1
fi

# 2. å…³é”®è¡¨æ£€æŸ¥
TABLES=("sys_user" "t_alert_rules" "t_alert_info" "t_weight_cache")
for table in "${TABLES[@]}"; do
    count=$(docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "SELECT COUNT(*) FROM $table;" -s -N 2>/dev/null)
    if [[ $count -ge 0 ]]; then
        echo "âœ… è¡¨ $table: $count æ¡è®°å½•"
    else
        echo "âŒ è¡¨ $table æ£€æŸ¥å¤±è´¥"
    fi
done

# 3. æ–°åŠŸèƒ½æµ‹è¯•
if docker exec ljwx-mysql mysql -uroot -p123456 lj-06 -e "DESCRIBE t_alert_rules auto_process_enabled;" &>/dev/null; then
    echo "âœ… è‡ªåŠ¨å¤„ç†åŠŸèƒ½å­—æ®µå­˜åœ¨"
else
    echo "âŒ è‡ªåŠ¨å¤„ç†åŠŸèƒ½å­—æ®µç¼ºå¤±"
fi

# 4. åº”ç”¨æœåŠ¡å¥åº·æ£€æŸ¥
sleep 10
curl -f http://localhost:9998/actuator/health &>/dev/null && echo "âœ… ljwx-boot æœåŠ¡æ­£å¸¸" || echo "âŒ ljwx-boot æœåŠ¡å¼‚å¸¸"
curl -f http://localhost:8001/health &>/dev/null && echo "âœ… ljwx-bigscreen æœåŠ¡æ­£å¸¸" || echo "âŒ ljwx-bigscreen æœåŠ¡å¼‚å¸¸"
curl -f http://localhost:8080/ &>/dev/null && echo "âœ… ljwx-admin æœåŠ¡æ­£å¸¸" || echo "âŒ ljwx-admin æœåŠ¡å¼‚å¸¸"

echo "éªŒè¯å®Œæˆï¼"
```

### 4. ç›‘æ§å’Œå‘Šè­¦

```bash
# è®¾ç½®å‡çº§ç›‘æ§è„šæœ¬
#!/bin/bash
# upgrade-monitor.sh

LOG_FILE="logs/database-upgrade/upgrade_$(date +%Y%m%d_*).log"

# ç›‘æ§å‡çº§è¿›åº¦
tail -f $LOG_FILE | while read line; do
    case "$line" in
        *"ERROR"*)
            # å‘é€å‘Šè­¦é€šçŸ¥
            echo "æ•°æ®åº“å‡çº§é‡åˆ°é”™è¯¯: $line" | mail -s "å‡çº§å‘Šè­¦" admin@company.com
            ;;
        *"âœ… æ•°æ®åº“å‡çº§æˆåŠŸ"*)
            # å‘é€æˆåŠŸé€šçŸ¥
            echo "æ•°æ®åº“å‡çº§æˆåŠŸå®Œæˆ" | mail -s "å‡çº§æˆåŠŸ" admin@company.com
            break
            ;;
    esac
done
```

## æŠ€æœ¯æ¶æ„

### è„šæœ¬æ¶æ„è®¾è®¡

```
database-upgrade-manager.sh
â”œâ”€â”€ é…ç½®ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ ç¯å¢ƒå˜é‡åŠ è½½
â”‚   â””â”€â”€ å‚æ•°éªŒè¯
â”œâ”€â”€ ç‰ˆæœ¬ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ ç‰ˆæœ¬æ£€æµ‹
â”‚   â”œâ”€â”€ ç‰ˆæœ¬è¡¨åˆ›å»º
â”‚   â””â”€â”€ ç‰ˆæœ¬è®°å½•æ›´æ–°
â”œâ”€â”€ å¤‡ä»½æ¢å¤æ¨¡å—
â”‚   â”œâ”€â”€ æ•°æ®å¤‡ä»½
â”‚   â”œâ”€â”€ ç»“æ„å¤‡ä»½
â”‚   â””â”€â”€ è‡ªåŠ¨å›æ»š
â”œâ”€â”€ è¿ç§»æ‰§è¡Œæ¨¡å—
â”‚   â”œâ”€â”€ è„šæœ¬æ‰«æ
â”‚   â”œâ”€â”€ äº‹åŠ¡æ‰§è¡Œ
â”‚   â””â”€â”€ é”™è¯¯å¤„ç†
â”œâ”€â”€ éªŒè¯æ¨¡å—
â”‚   â”œâ”€â”€ å¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ å®Œæ•´æ€§éªŒè¯
â”‚   â””â”€â”€ æ€§èƒ½æµ‹è¯•
â””â”€â”€ æŠ¥å‘Šæ¨¡å—
    â”œâ”€â”€ æ—¥å¿—è®°å½•
    â”œâ”€â”€ æŠ¥å‘Šç”Ÿæˆ
    â””â”€â”€ ç»Ÿè®¡åˆ†æ
```

### æ•°æ®æµå›¾

```
ç°ç½‘æ•°æ®åº“ --> ç‰ˆæœ¬æ£€æµ‹ --> å¥åº·æ£€æŸ¥ --> æ•°æ®å¤‡ä»½
                                             â†“
å‡çº§æŠ¥å‘Š <-- æ€§èƒ½ä¼˜åŒ– <-- å®Œæ•´æ€§éªŒè¯ <-- è¿ç§»æ‰§è¡Œ
    â†“                                        â†“
ç”¨æˆ·ç¡®è®¤                                   é”™è¯¯å¤„ç†
    â†“                                        â†“
å‡çº§å®Œæˆ <-- æœåŠ¡é‡å¯ <-- æ¸…ç†ä¸´æ—¶æ–‡ä»¶    è‡ªåŠ¨å›æ»š
```

## æ€»ç»“

æœ¬æ•°æ®åº“å‡çº§è§£å†³æ–¹æ¡ˆæä¾›äº†ï¼š

âœ… **å®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†**: è‡ªåŠ¨ç‰ˆæœ¬æ£€æµ‹å’Œå‡çº§è·¯å¾„ç®¡ç†  
âœ… **å¯é çš„å®‰å…¨ä¿éšœ**: å®Œæ•´å¤‡ä»½å’Œä¸€é”®å›æ»šæœºåˆ¶  
âœ… **è¯¦ç»†çš„å¯è§‚æµ‹æ€§**: å…¨ç¨‹æ—¥å¿—è®°å½•å’Œå‡çº§æŠ¥å‘Š  
âœ… **çµæ´»çš„æ‰©å±•æ€§**: æ”¯æŒè‡ªå®šä¹‰è¿ç§»è„šæœ¬å’Œé…ç½®  
âœ… **ä¾¿æ·çš„æ“ä½œä½“éªŒ**: ä¸€é”®å‘½ä»¤å®Œæˆå¤æ‚å‡çº§æµç¨‹  

é€šè¿‡è¿™å¥—è§£å†³æ–¹æ¡ˆï¼Œå®¢æˆ·å¯ä»¥å®‰å…¨ã€ä¾¿æ·åœ°å®Œæˆæ•°æ®åº“å‡çº§ï¼Œç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§å’Œæ•°æ®å®‰å…¨æ€§ã€‚

---

**æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-09-11