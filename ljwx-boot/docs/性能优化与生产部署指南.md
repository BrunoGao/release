# è¿åŠ¨è½¨è¿¹ç”µå­å›´æ ç³»ç»Ÿ - æ€§èƒ½ä¼˜åŒ–ä¸ç”Ÿäº§éƒ¨ç½²æŒ‡å—

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–
```sql
-- è½¨è¿¹æ•°æ®ç´¢å¼•ä¼˜åŒ–
ALTER TABLE t_track_point 
ADD INDEX idx_user_time (user_id, timestamp),
ADD INDEX idx_location (longitude, latitude),
ADD INDEX idx_device_time (device_sn, timestamp);

-- å›´æ å‘Šè­¦ç´¢å¼•ä¼˜åŒ–  
ALTER TABLE t_geofence_alert
ADD INDEX idx_status_time (alert_status, start_time),
ADD INDEX idx_fence_user (fence_id, user_id),
ADD INDEX idx_customer_time (customer_id, start_time);

-- å›´æ æ•°æ®ç´¢å¼•
ALTER TABLE t_geofence
ADD INDEX idx_customer_status (customer_id, is_active),
ADD INDEX idx_location_range (center_lng, center_lat, radius);
```

#### åˆ†åŒºè¡¨ç­–ç•¥
```sql
-- è½¨è¿¹æ•°æ®æŒ‰æœˆåˆ†åŒº
ALTER TABLE t_track_point 
PARTITION BY RANGE (YEAR(timestamp) * 100 + MONTH(timestamp)) (
    PARTITION p202409 VALUES LESS THAN (202410),
    PARTITION p202410 VALUES LESS THAN (202411),
    PARTITION p202411 VALUES LESS THAN (202412),
    PARTITION p202412 VALUES LESS THAN (202501),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);

-- å‘Šè­¦æ•°æ®æŒ‰æœˆåˆ†åŒº
ALTER TABLE t_geofence_alert 
PARTITION BY RANGE (YEAR(start_time) * 100 + MONTH(start_time)) (
    PARTITION p202409 VALUES LESS THAN (202410),
    PARTITION p202410 VALUES LESS THAN (202411),
    PARTITION p202411 VALUES LESS THAN (202412),
    PARTITION p202412 VALUES LESS THAN (202501),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 2. ç¼“å­˜ä¼˜åŒ–

#### Redis ç¼“å­˜ç­–ç•¥
```properties
# application-prod.yml ç¼“å­˜é…ç½®
spring:
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 1
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: -1ms
      timeout: 3000ms

# ç¼“å­˜ç­–ç•¥é…ç½®
cache:
  geofence:
    ttl: 3600  # å›´æ æ•°æ®ç¼“å­˜1å°æ—¶
  user:
    ttl: 1800  # ç”¨æˆ·æ•°æ®ç¼“å­˜30åˆ†é’Ÿ
  track:
    ttl: 300   # è½¨è¿¹æ•°æ®ç¼“å­˜5åˆ†é’Ÿ
```

#### ç¼“å­˜é¢„çƒ­è„šæœ¬
```java
@Component
public class ProductionCacheWarmup {
    
    @EventListener(ApplicationReadyEvent.class)
    public void warmupCache() {
        log.info("ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒç¼“å­˜é¢„çƒ­...");
        
        // 1. é¢„çƒ­æ´»è·ƒå›´æ æ•°æ®
        warmupActiveGeofences();
        
        // 2. é¢„çƒ­ç”¨æˆ·ä½ç½®æ•°æ®  
        warmupUserLocations();
        
        // 3. é¢„çƒ­å‘Šè­¦è§„åˆ™é…ç½®
        warmupAlertRules();
        
        log.info("âœ… ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
}
```

### 3. JVM è°ƒä¼˜

#### ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°
```bash
# ljwx-boot JVM ä¼˜åŒ–å‚æ•°
export JAVA_OPTS="-server \
    -Xms2g -Xmx4g \
    -XX:NewRatio=1 \
    -XX:SurvivorRatio=8 \
    -XX:+UseG1GC \
    -XX:MaxGCPauseMillis=200 \
    -XX:+UseCompressedOops \
    -XX:+UseCompressedClassPointers \
    -XX:+HeapDumpOnOutOfMemoryError \
    -XX:HeapDumpPath=/var/logs/ljwx/heapdump/ \
    -Xloggc:/var/logs/ljwx/gc.log \
    -XX:+PrintGCDetails \
    -XX:+PrintGCTimeStamps \
    -XX:+UseGCLogFileRotation \
    -XX:NumberOfGCLogFiles=3 \
    -XX:GCLogFileSize=100m"
```

### 4. è¿æ¥æ± ä¼˜åŒ–

#### æ•°æ®åº“è¿æ¥æ± 
```yaml
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      idle-timeout: 300000
      connection-timeout: 30000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
      connection-test-query: SELECT 1
```

#### HTTP è¿æ¥æ± 
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

## ç”Ÿäº§éƒ¨ç½²æ–¹æ¡ˆ

### 1. Docker å®¹å™¨åŒ–éƒ¨ç½²

#### Dockerfile (åç«¯)
```dockerfile
FROM eclipse-temurin:21-jre-alpine

LABEL maintainer="ljwx-team"
LABEL description="LJWX Boot Application"

# è®¾ç½®æ—¶åŒº
RUN apk add --no-cache tzdata
ENV TZ=Asia/Shanghai

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY ljwx-boot-admin/target/ljwx-boot-admin-1.0.6-SNAPSHOT.jar app.jar

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/logs/ljwx

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:9998/actuator/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 9998

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
```

#### docker-compose.yml (å®Œæ•´éƒ¨ç½²)
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: ljwx-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ljwx_prod
      TZ: Asia/Shanghai
    volumes:
      - mysql_data:/var/lib/mysql
      - ./deploy/mysql/init:/docker-entrypoint-initdb.d
      - ./deploy/mysql/conf:/etc/mysql/conf.d
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - ljwx-network

  redis:
    image: redis:7.0-alpine
    container_name: ljwx-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - ljwx-network

  ljwx-boot:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.backend
    container_name: ljwx-boot
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MYSQL_HOST: mysql
      MYSQL_DATABASE: ljwx_prod
      MYSQL_USERNAME: root
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JVM_OPTS: "-Xms1g -Xmx2g"
    volumes:
      - ./logs:/var/logs/ljwx
      - ./deploy/config:/app/config
    ports:
      - "9998:9998"
    depends_on:
      - mysql
      - redis
    restart: unless-stopped
    networks:
      - ljwx-network

  ljwx-admin:
    build:
      context: ./ljwx-admin
      dockerfile: ../deploy/docker/Dockerfile.frontend
    container_name: ljwx-admin
    environment:
      NGINX_HOST: localhost
      NGINX_PORT: 80
      API_BASE_URL: http://ljwx-boot:9998
    ports:
      - "80:80"
    depends_on:
      - ljwx-boot
    restart: unless-stopped
    networks:
      - ljwx-network

volumes:
  mysql_data:
  redis_data:

networks:
  ljwx-network:
    driver: bridge
```

### 2. Nginx åå‘ä»£ç†é…ç½®

```nginx
# /etc/nginx/sites-available/ljwx
upstream ljwx_backend {
    server 127.0.0.1:9998;
    keepalive 32;
}

server {
    listen 80;
    server_name ljwx.example.com;
    
    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ljwx.example.com;
    
    # SSLé…ç½®
    ssl_certificate /etc/ssl/ljwx.crt;
    ssl_certificate_key /etc/ssl/ljwx.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/ljwx-admin/dist;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://ljwx_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¿æ¥è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # WebSocketæ”¯æŒ (å¦‚æœéœ€è¦)
    location /ws/ {
        proxy_pass http://ljwx_backend/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/ljwx.access.log;
    error_log /var/log/nginx/ljwx.error.log;
}
```

### 3. ç›‘æ§é…ç½®

#### Prometheus ç›‘æ§
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'ljwx-boot'
    static_configs:
      - targets: ['localhost:9998']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']

  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['localhost:9104']

  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['localhost:9121']
```

#### Grafana ä»ªè¡¨ç›˜
```json
{
  "dashboard": {
    "title": "LJWX è¿åŠ¨è½¨è¿¹ç›‘æ§",
    "panels": [
      {
        "title": "API å“åº”æ—¶é—´",
        "type": "graph",
        "targets": [
          {
            "expr": "http_server_requests_seconds_sum{job=\"ljwx-boot\"} / http_server_requests_seconds_count{job=\"ljwx-boot\"}"
          }
        ]
      },
      {
        "title": "è½¨è¿¹æ•°æ®å¤„ç†é‡",
        "type": "singlestat",
        "targets": [
          {
            "expr": "track_points_processed_total{job=\"ljwx-boot\"}"
          }
        ]
      },
      {
        "title": "å›´æ å‘Šè­¦ç»Ÿè®¡",
        "type": "graph",
        "targets": [
          {
            "expr": "geofence_alerts_total{job=\"ljwx-boot\"}"
          }
        ]
      }
    ]
  }
}
```

### 4. è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

#### éƒ¨ç½²è„šæœ¬ (deploy.sh)
```bash
#!/bin/bash

set -e

echo "ğŸš€ å¼€å§‹ LJWX ç³»ç»Ÿéƒ¨ç½²..."

# ç¯å¢ƒå˜é‡æ£€æŸ¥
if [ -z "$DEPLOYMENT_ENV" ]; then
    echo "âŒ è¯·è®¾ç½® DEPLOYMENT_ENV ç¯å¢ƒå˜é‡ (dev/test/prod)"
    exit 1
fi

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p /var/logs/ljwx
mkdir -p /var/backups/ljwx
mkdir -p /var/data/ljwx

echo "ğŸ“¦ æ„å»ºåç«¯åº”ç”¨..."
cd ljwx-boot
mvn clean package -P$DEPLOYMENT_ENV -DskipTests

echo "ğŸ“¦ æ„å»ºå‰ç«¯åº”ç”¨..."
cd ../ljwx-admin
npm run build

echo "ğŸ”§ æ›´æ–°é…ç½®æ–‡ä»¶..."
envsubst < deploy/config/application-$DEPLOYMENT_ENV.yml.template > deploy/config/application-$DEPLOYMENT_ENV.yml

echo "ğŸ—ƒï¸ æ•°æ®åº“è¿ç§»..."
cd ../ljwx-boot
java -jar ljwx-boot-admin/target/ljwx-boot-admin-*.jar --spring.profiles.active=$DEPLOYMENT_ENV --flyway.migrate=true --spring.jpa.hibernate.ddl-auto=none

echo "ğŸ³ å¯åŠ¨ Docker å®¹å™¨..."
docker-compose -f deploy/docker-compose-$DEPLOYMENT_ENV.yml up -d

echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
for i in {1..30}; do
    if curl -f http://localhost:9998/actuator/health >/dev/null 2>&1; then
        echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
        break
    fi
    echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/30)"
    sleep 10
done

echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
docker-compose -f deploy/docker-compose-$DEPLOYMENT_ENV.yml ps

echo "âœ… LJWX ç³»ç»Ÿéƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ å‰ç«¯è®¿é—®åœ°å€: http://localhost"
echo "ğŸ“– APIæ–‡æ¡£åœ°å€: http://localhost:9998/doc.html"
echo "ğŸ“Š ç›‘æ§åœ°å€: http://localhost:9999/actuator/health"
```

## æ€§èƒ½åŸºå‡†æµ‹è¯•

### API æ€§èƒ½æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash

echo "ğŸ§ª å¼€å§‹ API æ€§èƒ½æµ‹è¯•..."

# è½¨è¿¹æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
echo "æµ‹è¯•è½¨è¿¹æŸ¥è¯¢ API..."
ab -n 1000 -c 10 -H "Authorization: Bearer $AUTH_TOKEN" \
   -p track_query.json -T "application/json" \
   http://localhost:9998/track/history

# å›´æ æŸ¥è¯¢æ€§èƒ½æµ‹è¯•  
echo "æµ‹è¯•å›´æ æŸ¥è¯¢ API..."
ab -n 1000 -c 10 -H "Authorization: Bearer $AUTH_TOKEN" \
   http://localhost:9998/t_geofence/page?pageNum=1&pageSize=20

# å‘Šè­¦å¤„ç†æ€§èƒ½æµ‹è¯•
echo "æµ‹è¯•å‘Šè­¦å¤„ç† API..."
ab -n 500 -c 5 -H "Authorization: Bearer $AUTH_TOKEN" \
   -p alert_process.json -T "application/json" \
   http://localhost:9998/geofence/alert/process

echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"
```

## è¿ç»´ç®¡ç†

### æ—¥å¿—ç®¡ç†
```yaml
# logback-spring.xml ç”Ÿäº§é…ç½®
logging:
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
  file:
    name: /var/logs/ljwx/application.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 10GB
  level:
    root: INFO
    com.ljwx: INFO
    org.springframework.web: WARN
    com.zaxxer.hikari: WARN
```

### å¥åº·æ£€æŸ¥ç«¯ç‚¹
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        if (!checkDatabaseConnection()) {
            return Health.down().withDetail("database", "è¿æ¥å¤±è´¥").build();
        }
        
        // æ£€æŸ¥Redisè¿æ¥
        if (!checkRedisConnection()) {
            return Health.down().withDetail("redis", "è¿æ¥å¤±è´¥").build();
        }
        
        // æ£€æŸ¥å…³é”®ä¸šåŠ¡æŒ‡æ ‡
        Map<String, Object> details = new HashMap<>();
        details.put("activeUsers", getActiveUserCount());
        details.put("alertsProcessed", getTodayAlertsCount());
        details.put("trackPointsToday", getTodayTrackPointsCount());
        
        return Health.up().withDetails(details).build();
    }
}
```

### å¤‡ä»½ç­–ç•¥
```bash
#!/bin/bash
# backup.sh - æ•°æ®å¤‡ä»½è„šæœ¬

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/ljwx/$DATE"

mkdir -p $BACKUP_DIR

echo "ğŸ—„ï¸ å¼€å§‹æ•°æ®å¤‡ä»½..."

# MySQL æ•°æ®åº“å¤‡ä»½
mysqldump -h localhost -u root -p$MYSQL_PASSWORD ljwx_prod | gzip > $BACKUP_DIR/ljwx_database_$DATE.sql.gz

# Redis æ•°æ®å¤‡ä»½  
redis-cli --rdb $BACKUP_DIR/ljwx_redis_$DATE.rdb

# é…ç½®æ–‡ä»¶å¤‡ä»½
tar -czf $BACKUP_DIR/ljwx_config_$DATE.tar.gz /app/config

# æ—¥å¿—å½’æ¡£å¤‡ä»½
tar -czf $BACKUP_DIR/ljwx_logs_$DATE.tar.gz /var/logs/ljwx

echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find /var/backups/ljwx -type d -mtime +7 -exec rm -rf {} \;
```

---

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ğŸ” éƒ¨ç½²å‰æ£€æŸ¥
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡
- [ ] Redis è¿æ¥æµ‹è¯•é€šè¿‡
- [ ] SSL è¯ä¹¦æœ‰æ•ˆ
- [ ] é˜²ç«å¢™è§„åˆ™é…ç½®
- [ ] ç›‘æ§ç³»ç»Ÿé…ç½®
- [ ] å¤‡ä»½ç­–ç•¥é…ç½®

### ğŸš€ éƒ¨ç½²åéªŒè¯
- [ ] æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸
- [ ] å‰ç«¯é¡µé¢å¯æ­£å¸¸è®¿é—®
- [ ] API æ¥å£å“åº”æ­£å¸¸
- [ ] åœ°å›¾åŠŸèƒ½æ­£å¸¸æ˜¾ç¤º
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸

### ğŸ“Š æ€§èƒ½éªŒè¯
- [ ] API å“åº”æ—¶é—´ < 500ms
- [ ] æ•°æ®åº“è¿æ¥æ± æ­£å¸¸
- [ ] å†…å­˜ä½¿ç”¨ç‡ < 70%
- [ ] CPU ä½¿ç”¨ç‡ < 60%
- [ ] ç£ç›˜ I/O æ­£å¸¸
- [ ] ç½‘ç»œå»¶è¿Ÿæ­£å¸¸

**ç”Ÿäº§éƒ¨ç½²å®Œæˆåï¼Œç³»ç»Ÿå…·å¤‡é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„ç”Ÿäº§ç¯å¢ƒè¿è¡Œèƒ½åŠ›ã€‚**