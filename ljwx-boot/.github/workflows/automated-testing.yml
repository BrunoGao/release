name: ljwx-boot è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æµ‹è¯•

env:
  MYSQL_ROOT_PASSWORD: 123456
  REDIS_PASSWORD: 123456

jobs:
  # å•å…ƒæµ‹è¯•å’ŒAPIæµ‹è¯•
  api-tests:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
      redis:
        image: redis:8.0-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ç¼“å­˜Mavenä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ç­‰å¾…MySQLå°±ç»ª
      run: |
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} --silent; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL..."
          sleep 2
        done

    - name: åˆå§‹åŒ–æµ‹è¯•æ•°æ®åº“
      run: |
        mysql -h 127.0.0.1 -u root -p${{ env.MYSQL_ROOT_PASSWORD }} -e "
          CREATE DATABASE IF NOT EXISTS test CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
          USE test;
          -- è¿™é‡Œå¯ä»¥å¯¼å…¥åŸºç¡€æµ‹è¯•æ•°æ®
        "

    - name: ç¼–è¯‘ljwx-booté¡¹ç›®
      run: |
        MYSQL_DATABASE=test MYSQL_HOST=127.0.0.1 MYSQL_USER=root MYSQL_PASSWORD=${{ env.MYSQL_ROOT_PASSWORD }} \
        mvn clean compile -DskipTests -q

    - name: å¯åŠ¨ljwx-bootæœåŠ¡
      run: |
        MYSQL_DATABASE=test MYSQL_HOST=127.0.0.1 MYSQL_USER=root MYSQL_PASSWORD=${{ env.MYSQL_ROOT_PASSWORD }} \
        SPRING_PROFILES_ACTIVE=ci \
        nohup mvn -pl ljwx-boot-admin spring-boot:run -DskipTests -q > ljwx-boot.log 2>&1 &
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        for i in {1..60}; do
          if curl -s http://localhost:8080/proxy-default/auth/health > /dev/null 2>&1; then
            echo "ljwx-boot service is ready"
            break
          fi
          echo "Waiting for ljwx-boot service..."
          sleep 5
        done

    - name: æ‰§è¡ŒAPIè‡ªåŠ¨åŒ–æµ‹è¯•
      run: |
        cd test-automation
        mvn test -Dtest.environment=ci -Dtest.base.url=http://localhost:8080

    - name: ä¸Šä¼ APIæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: api-test-reports
        path: test-automation/target/surefire-reports/

    - name: ä¸Šä¼ æœåŠ¡æ—¥å¿—
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: service-logs
        path: ljwx-boot.log

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    runs-on: ubuntu-latest
    needs: api-tests
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: å®‰è£…JMeter
      run: |
        wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.2.tgz
        tar -xzf apache-jmeter-5.6.2.tgz
        export PATH=$PATH:$PWD/apache-jmeter-5.6.2/bin

    - name: å¯åŠ¨ljwx-bootæœåŠ¡
      run: |
        MYSQL_DATABASE=test MYSQL_HOST=127.0.0.1 MYSQL_USER=root MYSQL_PASSWORD=${{ env.MYSQL_ROOT_PASSWORD }} \
        SPRING_PROFILES_ACTIVE=ci \
        nohup mvn -pl ljwx-boot-admin spring-boot:run -DskipTests -q > ljwx-boot.log 2>&1 &
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 60

    - name: æ‰§è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        cd test-automation
        ./run-performance-tests.sh

    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-test-reports
        path: test-automation/performance-reports/

  # E2Eæµ‹è¯•
  e2e-tests:
    runs-on: ubuntu-latest
    needs: api-tests
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: å¯åŠ¨æœåŠ¡
      run: |
        # å¯åŠ¨åŽç«¯æœåŠ¡
        SPRING_PROFILES_ACTIVE=ci \
        nohup mvn -pl ljwx-boot-admin spring-boot:run -DskipTests -q > ljwx-boot.log 2>&1 &
        
        # å¯åŠ¨å‰ç«¯æœåŠ¡
        cd ljwx-admin
        npm install
        nohup npm run dev > ljwx-admin.log 2>&1 &
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 90

    - name: å®‰è£…Playwright
      run: |
        cd test-automation/e2e-tests
        npm install
        npx playwright install --with-deps

    - name: æ‰§è¡ŒE2Eæµ‹è¯•
      run: |
        cd test-automation
        ./run-e2e-tests.sh

    - name: ä¸Šä¼ E2Eæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-reports
        path: test-automation/e2e-reports/

  # æµ‹è¯•ç»“æžœæ±‡æ€»
  test-summary:
    runs-on: ubuntu-latest
    needs: [api-tests, performance-tests, e2e-tests]
    if: always()
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
      uses: actions/download-artifact@v3
      
    - name: ç”Ÿæˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# ljwx-boot è‡ªåŠ¨åŒ–æµ‹è¯•æ±‡æ€»æŠ¥å‘Š" > test-summary.md
        echo "" >> test-summary.md
        echo "## æµ‹è¯•æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> test-summary.md
        echo "" >> test-summary.md
        
        echo "## æµ‹è¯•ç»“æžœç»Ÿè®¡" >> test-summary.md
        echo "- ðŸ”¹ APIæµ‹è¯•: ${{ needs.api-tests.result }}" >> test-summary.md
        echo "- ðŸ”¹ æ€§èƒ½æµ‹è¯•: ${{ needs.performance-tests.result }}" >> test-summary.md  
        echo "- ðŸ”¹ E2Eæµ‹è¯•: ${{ needs.e2e-tests.result }}" >> test-summary.md
        echo "" >> test-summary.md
        
        echo "## å…³é”®éªŒè¯é¡¹ç›®" >> test-summary.md
        echo "- âœ… ç»„ç»‡æž¶æž„é—­åŒ…è¡¨ä¼˜åŒ–æ•ˆæžœéªŒè¯" >> test-summary.md
        echo "- âœ… å¤šç§Ÿæˆ·æƒé™éš”ç¦»å®‰å…¨éªŒè¯" >> test-summary.md
        echo "- âœ… Adminå…¨å±€æ•°æ®è®¿é—®æƒé™éªŒè¯" >> test-summary.md
        echo "- âœ… ç³»ç»Ÿå¹¶å‘æ€§èƒ½å’Œç¨³å®šæ€§éªŒè¯" >> test-summary.md
        
    - name: è¯„è®ºPRæµ‹è¯•ç»“æžœ
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

    - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: test-summary-report
        path: test-summary.md